
目　录

从西蒙斯的神话开始 

前言 

策略篇 

第1章　量化投资概念 

1.1　什么是量化投资 

1.1.1　量化投资定义 

1.1.2　量化投资理解误区 

1.2　量化投资与传统投资比较 

1.2.1　传统投资策略的缺点 

1.2.2　量化投资策略的优势 

1.2.3　量化投资与传统投资策略的比较 

1.3　量化投资历史 

1.3.1　量化投资理论发展 

1.3.2　海外量化基金的发展 

1.3.3　量化投资在中国 

1.4　量化投资主要内容 

1.5　量化投资主要方法 

第2章　量化选股 

2.1　多因子 

2.1.1　基本概念 

2.1.2　策略模型 

2.1.3　实证案例：多因子选股模型 

2.2　风格轮动 

2.2.1　基本概念 

2.2.2　盈利预期生命周期模型 

2.2.3　策略模型 

2.2.4　实证案例：中信标普风格 

2.2.5　实证案例：大小盘风格 

2.3　行业轮动 

2.3.1　基本概念 

2.3.2　M2行业轮动策略 

2.3.3　市场情绪轮动策略 

2.4　资金流 

2.4.1　基本概念 

2.4.2　策略模型 

2.4.3　实证案例：资金流选股策略 

2.5　动量反转 

2.5.1　基本概念 

2.5.2　策略模型 

2.5.3　实证案例：动量选股策略和反转选股策略 

2.6　一致预期 

2.6.1　基本概念 

2.6.2　策略模型 

2.6.3　实证案例：一致预期模型案例 

2.7　趋势追踪 

2.7.1　基本概念 

2.7.2　策略模型 

2.7.3　实证案例：趋势追踪选股模型 

2.8　筹码选股 

2.8.1　基本概念 

2.8.2　策略模型 

2.8.3　实证案例：筹码选股模型 

2.9　业绩评价 

2.9.1　收益率指标 

2.9.2　风险度指标 

第3章　量化择时 

3.1　趋势追踪 

3.1.1　基本概念 

3.1.2　传统趋势指标 

3.1.3　自适应均线 

3.2　市场情绪 

3.2.1　基本概念 

3.2.2　情绪指数 

3.2.3　实证案例：情绪指标择时策略 

3.3　时变夏普率 

3.3.1　Tsharp值的估计模型 

3.3.2　基于Tsharp值的择时策略 

3.3.3　实证案例 

3.4　牛熊线 

3.4.1　基本概念 

3.4.2　策略模型 

3.4.3　实证案例：牛熊线择时模型 

3.5　Husrt指数 

3.5.1　基本概念 

3.5.2　策略模型 

3.5.3　实证案例 

3.6　支持向量机 

3.6.1　基本概念 

3.6.2　策略模型 

3.6.3　实证案例：SVM择时模型 

3.7　SWARCH模型 

3.7.1　基本概念 

3.7.2　策略模型 

3.7.3　实证案例：SWARCH模型 

3.8　异常指标 

3.8.1　市场噪声 

3.8.2　行业集中度 

3.8.3　兴登堡凶兆 

第4章　股指期货套利 

4.1　基本概念 

4.1.1　套利介绍 

4.1.2　套利策略 

4.2　期现套利 

4.2.1　定价模型 

4.2.2　现货指数复制 

4.2.3　正向套利案例 

4.2.4　结算日套利 

4.3　跨期套利 

4.3.1　跨期套利原理 

4.3.2　无套利区间 

4.3.3　跨期套利触发和终止 

4.3.4　实证案例：跨期套利策略 

4.3.5　主要套利机会 

4.4　冲击成本 

4.4.1　主要指标 

4.4.2　实证案例：冲击成本 

4.5　保证金管理 

4.5.1　VaR方法 

4.5.2　VaR计算方法 

4.5.3　实证案例 

第5章　商品期货套利 

5.1　基本概念 

5.1.1　套利的条件 

5.1.2　套利基本模式 

5.1.3　套利准备工作 

5.1.4　常见套利组合 

5.2　期现套利 

5.2.1　基本原理 

5.2.2　操作流程 

5.2.3　增值税风险 

5.3　跨期套利 

5.3.1　套利策略 

5.3.2　实证案例：PVC跨期套利策略 

5.4　跨市场套利 

5.4.1　套利策略 

5.4.2　实证案例：伦铜—沪铜跨市场套利 

5.5　跨品种套利 

5.5.1　套利策略 

5.5.2　实证案例 

5.6　非常状态处理 

第6章　统计套利 

6.1　基本概念 

6.1.1　统计套利定义 

6.1.2　配对交易 

6.2　配对交易策略 

6.2.1　协整策略 

6.2.2　主成分策略 

6.2.3　行业（股票）轮动套利策略 

6.2.4　配对策略改进 

6.3　股指套利 

6.3.1　行业指数套利 

6.3.2　国家指数套利 

6.3.3　洲域指数套利 

6.3.4　全球指数套利 

6.4　融券套利 

6.4.1　股票—融券套利 

6.4.2　可转债—融券套利 

6.4.3　股指期货—融券套利 

6.4.4　封闭式基金—融券套利 

6.5　外汇套利 

6.5.1　利差套利 

6.5.2　货币对套利 

第7章　期权套利 

7.1　基本概念 

7.1.1　期权介绍 

7.1.2　期权交易 

7.1.3　牛熊证 

7.2　股票/期权套利 

7.2.1　股票—股票期权套利 

7.2.2　股票—指数期权套利 

7.3　转换套利与反向转换套利 

7.3.1　转换套利 

7.3.2　反向转换套利 

7.4　跨式套利 

7.4.1　买入跨式套利 

7.4.2　卖出跨式套利 

7.5　宽跨式套利 

7.5.1　买入宽跨式套利 

7.5.2　卖出宽跨式套利 

7.6　蝶式套利 

7.6.1　买入蝶式套利 

7.6.2　卖出蝶式套利 

7.7　飞鹰式套利 

7.7.1　买入飞鹰式套利 

7.7.2　卖出飞鹰式套利 

第8章　算法交易 

8.1　基本概念 

8.1.1　算法交易定义 

8.1.2　算法交易分类 

8.1.3　算法交易设计 

8.2　被动交易算法 

8.2.1　冲击成本 

8.2.2　等待风险 

8.2.3　常用被动型交易策略 

8.3　VWAP算法 

8.3.1　标准VWAP算法 

8.3.2　改进型VWAP算法 

第9章　另类套利策略 

9.1　封闭式基金套利 

9.1.1　基本概念 

9.1.2　模型策略 

9.1.3　实证案例 

9.2　ETF套利 

9.2.1　基本概念 

9.2.2　无风险套利 

9.2.3　其他套利 

9.3　LOF套利 

9.3.1　基本概念 

9.3.2　模型策略 

9.3.3　实证案例：LOF套利 

9.4　高频交易 

9.4.1　流动性回扣交易 

9.4.2　猎物算法交易 

9.4.3　自动做市商策略 

9.4.4　高频交易的发展 

理论篇 

第10章　人工智能 

10.1　主要内容 

10.1.1　机器学习 

10.1.2　自动推理 

10.1.3　专家系统 

10.1.4　模式识别 

10.1.5　人工神经网络 

10.1.6　遗传算法 

10.2　人工智能在量化投资中的应用 

10.2.1　模式识别短线择时 

10.2.2　RBF神经网络股价预测 

10.2.3　基于遗传算法新股预测 

第11章　数据挖掘 

11.1　基本概念 

11.1.1　主要模型 

11.1.2　典型方法 

11.2　主要内容 

11.2.1　分类与预测 

11.2.2　关联规则 

11.2.3　聚类分析 

11.3　数据挖掘在量化投资中的应用 

11.3.1　基于SOM网络的股票聚类分析方法 

11.3.2　基于关联规则的板块轮动 

第12章　小波分析 

12.1　基本概念 

12.2　小波变换主要内容 

12.2.1　连续小波变换 

12.2.2　连续小波变换的离散化 

12.2.3　多分辨分析与Mallat算法 

12.3　小波分析在量化投资中的应用 

12.3.1　K线小波去噪 

12.3.2　金融时序数据预测 

第13章　支持向量机 

13.1　基本概念 

13.1.1　线性SVM 

13.1.2　非线性SVM 

13.1.3　SVM分类器参数选择 

13.1.4　SVM分类器从二类到多类的推广 

13.2　模糊支持向量机 

13.2.1　增加模糊后处理的SVM 

13.2.2　引入模糊因子的SVM训练算法 

13.3　SVM在量化投资中的应用 

13.3.1　复杂金融时序数据预测 

13.3.2　趋势拐点预测 

第14章　分形理论 

14.1　基本概念 

14.1.1　分形定义 

14.1.2　几种典型的分形 

14.1.3　分形理论的应用 

14.2　主要内容 

14.2.1　分形维数 

14.2.2　L系统 

14.2.3　IFS系统 

14.3　分形理论在量化投资中的应用 

14.3.1　大趋势预测 

14.3.2　汇率预测 

第15章　随机过程 

15.1　基本概念 

15.2　主要内容 

15.2.1　随机过程的分布函数 

15.2.2　随机过程的数字特征 

15.2.3　几种常见的随机过程 

15.2.4　平稳随机过程 

15.3　灰色马尔可夫链股市预测 

第16章　IT技术 

16.1数据仓库技术 

16.1.1　从数据库到数据仓库 

16.1.2　数据仓库中的数据组织 

16.1.3　数据仓库的关键技术 

16.2　编程语言 

16.2.1　GPU算法交易 

16.2.2　MATLAB语言 

16.2.3　C#语言 

第17章　主要数据与工具 

17.1　名策数据：多因子分析平台 

17.2　Multicharts：程序化交易平台 

17.3　交易开拓者：期货自动交易平台 

17.4　大连交易所套利指令 

17.5　MT5：外汇自动交易平台 

第18章　对冲交易系统：D-Alpha 

18.1　系统架构 

18.2　策略分析流程 

18.3　核心算法 

18.4　验证结果 

参考文献
量化投资

——策略与技术
（修订版）

丁　鹏

编著

電子工業出版社

Publishing House of Electronics Industry

北京·BEIJING
内容简介

本书是国内少有的有关量化投资策略的著作。首先，介绍了量化投资大师西蒙斯的传奇故事（连续20年，每年赚60％）。然后，用60多个案例介绍了量化投资的各个方面的内容，主要分为策略篇与理论篇两部分。策略篇主要包括：量化选股、量化择时、股指期货套利、商品期货套利、统计套利、期权套利、算法交易和资产配置等。理论篇主要包括：人工智能、数据挖掘、小波分析、支持向量机、分形理论、随机过程及IT技术等。最后介绍了作者开发的D-Alpha量化对冲交易系统，该系统全球市场验证显示具有长期稳健的收益率。

本书适合基金经理、产品经理、证券分析师、投资总监及有志于从事金融投资的各界人士阅读。

未经许可，不得以任何方式复制或抄袭本书之部分或全部内容。 

版权所有，侵权必究。 

图书在版编目（CIP）数据

量化投资：策略与技术／丁鹏编著．—修订本．—北京：电子工业出版社，2012.4

ISBN 978-7-121-16536-8

Ⅰ．①量…　Ⅱ．①丁…　Ⅲ．①投资学　Ⅳ．①F830.59

中国版本图书馆CIP数据核字（2012）第046417号

策划编辑：李　冰

责任编辑：董　英

特约编辑：赵树刚

印　　刷：北京市天竺颖华印刷厂

装　　订：三河市鑫金马印装有限公司

出版发行：电子工业出版社

　　　　　北京市海淀区万寿路173信箱　　邮编：100036

开　　本：787×980　　1/16

印　　张：35.75

字　　数：744千字

彩　　插：10

印　　次：2012年4月第1次印刷

印　　数：3500册

定　　价：99.00元

凡所购买电子工业出版社图书有缺损问题，请向购买书店调换。若书店售缺，请与本社发行部联系，联系及邮购电话：（010）88254888。

质量投诉请发邮件至zlts@phei.com.cn，盗版侵权举报请发邮件至dbqq@phei.com.cn。

服务热线：（010）88258888。
从西蒙斯的神话开始

比巴菲特还能赚钱的人

沃伦·巴菲特是投资界人尽皆知的股神，但可能很多投资者不知道詹姆斯·西蒙斯。这位创造了华尔街投资神话的传奇人物，他所管理的大奖章基金的平均年收益率比巴菲特的收益率要高得多，1989—2007年的平均年收益率高达35％（若考虑高达44％的收益提成，则实际基金的年收益率超过60％），而股神巴菲特在同期的平均年复合回报率也不过为20％。

经历了1998年俄罗斯债券危机和2001年高科技股泡沫危机，许多曾经闻名遐迩的对冲基金经理都走向衰落。罗伯逊关闭了老虎基金，梅利韦瑟的长期资本管理公司几乎破产，索罗斯的量子基金也大幅缩水。与之相比，西蒙斯的大奖章基金的平均年净回报率则高达35％。从1988年成立到1999年12月，大奖章基金总共获得了2478.6％的净回报率，是同时期中的第一名；第二名是索罗斯的量子基金，有1710.1％的回报；而同期的标准普尔指数仅是9.6％。即使2008年面对全球金融危机的重挫，大奖章的回报率居然高达80％。

在2008年底的统计中，西蒙斯勇夺2008年“对冲之王”宝座，大赚25亿美元（约195亿港元），著名对冲基金经理保尔森居次位，赚20亿美元。出乎意料的是，大炒家索罗斯未入三甲。

《美国海外投资基金目录》的作者本海姆指出，西蒙斯创造的回报率比布鲁斯·科夫勒、乔治·索罗斯、保罗·都铎·钟斯、路易士·培根、马克·金顿等传奇投资大师都要高出10个百分点，在对冲基金业内几乎无出其右。作为一个交易者，西蒙斯正在超越有效市场假说。有效市场假说认为市场价格波动是随机的，交易者不可能持续从市场中获利。而西蒙斯依靠他的交易模型，获得了如此惊人的成就，其最核心的就是量化投资模型。

数学天才

西蒙斯生于波士顿郊区牛顿镇，是一个制鞋厂老板的儿子，3岁就立志成为数学家。从牛顿高中毕业后，他进入麻省理工学院，从师于著名的数学家安布罗斯和辛格。1958年，他获得了学士学位，仅仅三年后，他就拿到了加州大学伯克利分校的博士学位，一年后他成为哈佛大学数学系的教授。

西蒙斯很早就与投资结下缘分，早在1961年，他和麻省理工学院的同学投资于哥伦比亚地砖和管线公司；在伯克利，他尝试做股票交易，但是交易结果并不太好。

1964年，他离开了大学校园，进入美国国防部下属的一个非营利组织——国防逻辑分析协会，并进行代码破解工作。没过多久，《时代周刊》上关于越南战争的残酷报道让他意识到他的工作实际上正在帮助美军在越南的军事行动，反战的他于是向《新闻周刊写信说应该结束战争。当他把反战想法告诉老板时，很自然地就被解雇了。

他又回到了学术界，成为纽约州立石溪大学的数学系主任，在那里做了8年的纯数学研究。1974年，他与陈省身联合发表了著名的论文《典型群和几何不变式》，创立了著名的陈西蒙斯理论，该几何理论对理论物理学具有重要意义，广泛应用于从超引力到黑洞。1976年，西蒙斯获得了每5年一次的全美数学科学维布伦奖金，这是美国数学世界里的最高荣耀。

在理论研究之余，他开始醉心于股票和期货交易。1978年，他离开石溪大学创立私人投资基金Limroy，该基金投资领域广泛，涉及从风险投资到外汇交易；最初主要采用基本面分析方法，例如，通过分析美联储货币政策和利率走向来判断市场价格走势。

十年后，西蒙斯决定成立一个纯粹量化投资的对冲基金。他关闭了Limroy，并在1988年3月成立了大奖章基金，最初主要涉及期货交易。1988年该基金盈利8.8％，1989年则开始亏损，西蒙斯不得不在1989年6月份停止交易。在接下来的6个月中，西蒙斯和普林斯顿大学的数学家勒费尔重新开发了交易策略，并从基本面分析转向量化分析。

大奖章基金

大奖章基金主要通过研究市场历史资料来发现统计相关性，以预测期货、货币、股票市场的短期运动，并通过数千次快速的日内短线交易来捕捉稍纵即逝的市场机会，交易量之大甚至有时能占到整个纳斯达克交易量的10％。当交易开始时，交易模型决定买卖品种和时机，20名交易员则遵守指令在短时间内大量地交易各种美国和海外的期货，包括商品期货、金融期货、股票和债券。但在某些特定情况下，比如市场处在极端波动的时候，交易会切换到手工状态。

经过几年眩目的增长，大奖章基金在1993年达到2.7亿美元，并开始停止接受新资金。1994年，西蒙斯的文艺复兴科技公司从12个雇员增加到36个，并交易40种金融产品。现在，公司有150个雇员，交易60种金融产品，基金规模则有50亿美元。在150名雇员中有三分之一是拥有自然科学博士学位的顶尖科学家，涵盖数学、理论物理学、量子物理学和统计学等领域。所有雇员中只有两位是华尔街老手，而且该公司既不从商学院中雇用职员，也不从华尔街雇用职员，这在美国投资公司中几乎是独一无二的。

无论是1998年俄罗斯债券危机，还是本世纪初的互联网泡沫，大奖章基金历经数次金融危机，始终屹立不倒，令有效市场假说都黯然失色。1989年到2009年间，他操盘的大奖章基金平均年回报率高达35％，较同期标普500指数年均回报率高20多个百分点，比金融大鳄索罗斯和股神巴菲特的操盘表现都高出10余个百分点。即便是在次贷危机爆发的2008年，该基金的回报率仍高达80％。从2002年底至2005年底，规模为50亿美元的大奖章基金已经为投资者支付了60多亿美元的回报。

这个回报率是在扣除了5％的资产管理费和44％的投资收益分成以后得出的，并且已经经过了审计。值得一提的是，西蒙斯收取的这两项费用应该是对冲基金界最高的，相当于平均收费标准的两倍以上。

2006年，西蒙斯被国际金融工程师协会评选为年度金融工程师。

模型先生

针对不同市场设计量化的投资管理模型，并以电脑运算为主导，在全球各种市场上进行短线交易是西蒙斯的成功秘诀。不过西蒙斯对交易细节一直守口如瓶，除了公司的200多名员工之外，没有人能够得到他们操作的任何线索。

对于数量分析型对冲基金而言，交易行为更多是基于电脑对价格走势的分析，而非人的主观判断。文艺复兴公司主要由3个部分组成，即电脑和系统专家、研究人员和交易人员。西蒙斯亲自设计了最初的数学模型，他同时雇用了超过70位拥有数学、物理学或统计学博士头衔的人。西蒙斯每周都要和研究团队见一次面，和他们共同探讨交易细节及如何使交易策略更加完善。

作为一位数学家，西蒙斯知道靠幸运成功只有二分之一的概率，要战胜市场必须以周密而准确的计算为基础。大奖章基金的数学模型主要通过对历史资料的统计，找出金融产品价格、宏观经济、市场指标、技术指标等各种指标间变化的数学关系，发现市场目前存在的微小获利机会，并通过杠杆比率进行快速而大规模的交易获利。

和流行的“买入并长期持有”的投资理念截然相反，西蒙斯认为市场的异常状态通常都是微小而且短暂的，“我们随时都在买入卖出和卖出买入，我们依靠活跃赚钱”西蒙斯说。

西蒙斯透露，公司对交易品种的选择有3个标准：即公开交易品种、流动性高，同时符合模型设置的某些要求。他表示：“我是模型先生，不想进行基本面分析。模型的最重要的优势是可以降低风险。而依靠个人判断选股，你可能一夜暴富，也可能在第二天又输得精光。”

西蒙斯的所作所为似乎正在超越有效市场假说：有效市场假说认为市场价格波动是随机的，交易者不可能持续从市场中获利。而西蒙斯则强调，“有些交易模式并非随机而是有迹可循、具有预测效果的。”如同巴菲特曾经指出“市场在多数情况下是有效的但不是绝对的”一样，西蒙斯也认为，虽然整体而言，市场是有效的，但仍存在短暂的或局部的市场无效性，可以提供交易机会。

在接受《纽约时报》采访时，西蒙斯提到了他曾经观察过的一个核子加速器试验，“当两个高速运行的原子剧烈碰撞后，会迸射出数量巨大的粒子。”他说，“科学家的工作就是分析碰撞所带来的变化。”

“我注视着电脑屏幕上粒子碰撞后形成的轨迹图，它们看似杂乱无章，实际上却存在着内在的规律，”西蒙斯说，“这让我自然而然地联想到了证券市场，那些很小的交易哪怕是只有100股的交易，都会对这个庞大的市场产生影响，而每天都会有成千上万这样的交易发生。”西蒙斯认为，自己所做的，就是分析当交易这只蝴蝶的翅膀轻颤之后，市场会做出怎样复杂的反应。

“这个课题对于世界而言也许并不重要，不过研究市场运转的动力非常有趣。这是一个非常严肃的问题。”西蒙斯笑起来的时候简直就像一个顽童，而他的故事，听起来更像是一位精通数学的书生，通过复杂的赔率和概率计算，最终打败了赌场的神话。这位前美国国防部代码破译员和数学家似乎相信，对于如何走在曲线前面，应该存在一个简单的公式，而发现这个公式则无异于拿到了通往财富之门的入场券。

黑箱作业

大奖章基金现在基本上是黑箱作业，它的工作人员发誓要保守秘密，采取的是自营交易的运作策略。对冲基金行业一直拥有黑箱作业式的投资模式，可以不必向投资者披露其交易细节。而在一流的对冲基金投资人之中，西蒙斯先生的那只箱子据说是最黑的。

就连优秀的数量型对冲基金经理也无法弄清西蒙斯的模型究竟动用了哪些指标，“我们信任他，相信他能够在股市的惊涛骇浪中游刃有余，因此也就不再去想电脑都会干些什么之类的问题”，一位大奖章基金的长期投资者说。当这位投资者开始描述西蒙斯的投资方法时，他坦承，自己完全是猜测的。

不过，每当有人暗示西蒙斯的基金缺乏透明度时，他总是会无可奈何地耸耸肩，“其实所有人都有一个黑箱，我们把他称为大脑。”西蒙斯指出，公司的投资方法其实并不神秘，很多时候都是可以通过特定的方式来解决的。当然，他不得不补充说，“对我们来说这其实不太神秘。”

在纽约，有一句名言是：“你必须非主流才能入流”，西蒙斯的经历似乎刚好是这句话的注解。在华尔街，他的所作所为总是让人感到好奇。

西蒙斯在越战期间违反了军纪，之后就投身于理财行业。西蒙斯的文艺复兴科技公司总部位于纽约长岛，那座木头和玻璃结构的一层建筑从外表看上去更像是一个普通的脑库，或者是数学研究所。和很多基金公司不同的是，文艺复兴公司的心脏地带并不是夜以继日不停交易的交易室，而是一间有100个座位的礼堂。每隔半个月，公司员工都会在那里听一场科学演讲。“有趣而且实用的统计学演讲，对你的思想一定会有所启发。”一位喜欢这种学习方式的员工说。

令人惊讶的还不止这些。西蒙斯一点也不喜欢华尔街的投资家们，事实上，如果你想去文艺复兴科技公司工作，华尔街经验反而是个瑕疵。在公司的200多名员工中，将近二分之一都是数学、物理学、统计学等领域顶尖的科学家，所有雇员中只有两位是金融学博士，而且公司从不雇用商学院毕业生，也不雇用华尔街人士，这在美国的投资公司中堪称绝无仅有。

“我们不雇用数理逻辑不好的学生”，曾经在哈佛大学任教的西蒙斯说：“好的数学家需要直觉，对很多事情的发展总是有很强的好奇心，这对于战胜市场非常重要。”文艺复兴科技公司拥有一流的科学家，其中包括贝尔实验室的著名科学家Peter Weinberger和弗吉尼亚大学教授Robert Lourie。他还从IBM公司招募了部分熟悉语音识别系统的员工。“交易员和语音识别的工作人员有相似之处，他们总是在猜测下一刻会发生什么。”

人员流动几乎是不存在的。每6个月，公司员工会根据业绩收到相应的现金红利。据说半年内的业绩基准是12％，很多时候这个指标可以轻松达到，不少员工还拥有公司的股权。西蒙斯很重视公司的气氛，据说他经常会和员工及其家属们分享周末，早在2000年，他们就曾一起飞去百慕大度假。与此同时，每一位员工都发誓要保守公司秘密。

近年来，西蒙斯接受最多的质疑都与美国长期资本管理公司（LTCM）有关。LTCM在20世纪90年代中期曾经辉煌一时，公司拥有两位诺贝尔经济学奖得主，他们利用电脑处理大量历史资料，通过精密计算得到两个不同金融工具间的正常历史价格差，然后结合市场信息分析它们之间的最新价格差。如果两者出现偏差，电脑立即发出指令大举入市；经过市场一段时间调节，放大的偏差会自动恢复到正常轨迹上，此时电脑指令平仓离场，获取偏差的差值。

LTCM始终遵循“市场中性”原则，即不从事任何单方面交易，仅以寻找市场或商品间效率落差而形成的套利空间为主，通过对冲机制规避风险，使市场风险最小。但由于其模型假设前提和计算结果都是在历史统计资料基础上得出的，一旦出现与计算结果相反的走势，则对冲就变成了一种高风险的交易策略。

而在极大的杠杆借贷下，这种风险被进一步放大。最辉煌时，LTCM利用从投资者筹得的22亿美元资本作为抵押，买入价值1250亿美元证券，然后再以证券作为抵押，进行总值12500亿美元的其他金融交易，杠杆比率高达568倍。短短4年中，LTCM曾经获得了285％的收益率，然而，在过度操纵之下，在仅两个月之内又输掉了45亿美元，走向了万劫不复之地。

“我们的方式和LTCM完全不同”，西蒙斯强调：“文艺复兴科技公司没有也不需要那么高的杠杆比例，公司在操作时从来没有任何先入为主的概念，而是只寻找那些可以复制的微小的获利瞬间，我们绝不以‘市场恢复正常’作为赌注投入资金，有一天市场终会正常的，但谁知道是哪一天。”

西蒙斯的拥护者们也多半对黑箱操作的风险不以为然，他们说：“长期资本公司只有两位诺贝尔奖金获得者充当门面，主要的还是华尔街人士，他们的赌性决定了终究会出错，”另一位著名的数量型基金管理人也表示：“难以相信在西蒙斯的方法中会没有一些安全措施。”他指出，西蒙斯的方法和LTCM最重要的区别是不涉及对冲，而多是进行短线方向性预测，依靠同时交易很多品种、在短期做出大量的交易来获利。具体到每一个交易的亏损，由于会在很短的时间内平仓，因此损失不会很大；而数千次交易之后，只要盈利交易多于亏损交易，总体交易结果就是盈利的。

通过西蒙斯的传奇故事，相信读者也都了解了量化投资的威力和魅力，那是不是很想进入这个行业，并创造自己的传奇呢?
前言

连续20年，每年赚60％，从来没有出现过亏损！

这是量化投资大师西蒙斯教授给出的战绩，这个成绩将巴菲特和索罗斯远远地抛在身后，这已经成为华尔街顶尖对冲基金经理眼中的神话，一个让人瞠乎绝尘的神话！

量化投资是最近十年来在国际投资界兴起的一个新方法，发展势头迅猛，和基本面分析、技术面分析并称为三大主流方法。基本面分析和技术面分析可以看做是传统的证券分析理论，而量化投资则是结合了现代数学理论和金融数据的一种全新的分析方式，是现代化的证券分析方法。

和传统的基本面分析和技术面分析比较起来，量化投资最大的特点就是定量化和精确化。

采用传统分析方法取得良好业绩的投资者首推巴菲特，连续40年，每年可以获得20％的复合稳定收益。而量化投资大师西蒙斯则连续20年为投资者获得超过35％的收益率，若包括业绩提成在内，则实际每年投资收益率超过60％，由此可见量化投资的巨大威力。

2008年笔者去欧洲访问研究，和德意志银行、雷曼兄弟以及一家欧洲很大的对冲基金的研究员交流，2010年去香港和摩根斯坦利、美林证券以及野村证券的投资经理交流。给我最大的感受就是：这些国际顶级的投行在量化投资模型研究的深入与扎实。‘一切用数据说话’，这是他们任何投资决策的基石。

不知道有一天中国的金融市场全面开放后，国内的投资者能否抵挡华尔街金融大鳄们的冲击。于是决定写一本有关量化投资的书。

当开始动笔写作本书时候，才发现这是一个极其艰难的工作。市面上没有任何一本谈论量化投资策略的书籍可供参考，故事书倒有几本，但关于策略的内容少之又少，而有关量化投资的研究报告也散落在网络的各个角落。经过3个多月的精心筛选，精选出60多个精华策略，形成了本书的主要内容。希望能起一个抛砖引玉的作用，让更多的投资者采用这种先进的分析方法，获取更高和更稳定的投资收益。

本书特色

第一，实战性。书中的案例绝大多数来自于实际的市场数据，只有很少一部分是纯理论的分析。尤其是策略篇中的内容大部分来自于专业投资机构的研究报告，具有极强的实战价值。

第二，基于中国市场。与量化投资最接近的书籍当属“金融工程”，但目前金融工程中绝大多数的案例都来自于国外市场，很多策略在国内市场还不具备投资条件。本书中的案例基本上都是对国内市场（股票、期货等）中的实际交易数据的分析，特别适合国内的投资者。

第三，理论性。量化投资离不开最新的数学和计算机理论的支持，本书用了将近一半的篇幅来阐述与量化投资有关的基础理论，并用了很多案例来说明这些理论的应用方法。避免了一般投资策略书籍重技术而忽视理论的缺点，从而使量化投资更加科学化。

本书主要内容

本书的内容分为：策略篇和理论篇。策略篇中阐述了各种量化投资的策略与方法，理论篇则详细介绍了支持量化投资的各种数学工具。

策略篇一共介绍了8个方面的投资策略，分别是量化选股、量化择时、股指期货套利、商品期货套利、统计套利、期权套利、算法交易及其他策略。

理论篇主要阐述了支持量化投资的各种数学和计算机工具，这部分的内容对读者的数学功底有比较高的要求，一共有7章，分别是人工智能、数据挖掘、小波分析、支持向量机、分形理论、随机过程和IT技术。

在第17章，我们介绍了一些主要的数据和工具，包括名策多因子模型、Multichart程序化交易平台、交易开拓者期货自动交易平台、大连交易所套利交易指令和MT5外汇自动交易平台。

在本书的最后，阐述了笔者开发的D-Alpha量化对冲交易系统，包括：系统构架、策略分析流程、核心算法以及验证结果，从全球市场的验证结果显示，D-Alpha系统具有稳健的收益率。

读者对象

本书适合于各种不同的投资者使用。对于专业量化投资者来说，书中的理论篇提供了基本的理论方法和算法，可以在此基础上开发出更高效，更精确的策略模型，提高自己的投资收益率和收益率的稳定性。

对于传统方法专业投资者来说，本书的策略篇中很多量化方法可以作为传统投资方法的补充和精化，在投资决策中数量模型的结果可以降低很多人为的误差和情绪影响，弥补传统投资决策的缺陷。

对于普通投资者来说，可能缺乏数据和模型方法的技巧，但是书中各种策略的思路和方法同样可以给他们以启迪和帮助，特别是在开阔思路，加强交易能力方面，量化投资是普通投资者的一件利器。

致谢

在本书的写作过程中，得到了业界同仁的大力协助。其中陈晨硕士校对了全书的第1～3章的内容，梁冠群博士校对了第4～9章的内容，翟淑星博士校对了第10～13章的内容，李心洁硕士校对了第14～17章的内容，戴蔡凌和陆运天协助做了封面设计，对他们的贡献表示诚挚的感谢。

曾经犹豫是否要出版此书，因为有业内的朋友告诫我：“你将策略模型说出去，自己赚不到钱了”，我不同意他的观点，因为策略模型是在不断深化中发展的。没有一个公司可以靠一个产品包打天下，我们做宽客的也不可能只靠一个模型吃一辈子。只有更多的人来研究量化投资，才能开发出更多更稳定的投资模型，才能促进中国整体对冲基金的发展。人类现代科技的基石就是“分享”，不是吗？

由于自己才疏学浅，此书只能起着抛砖引玉的作用，希望将来有更多更好的研究书籍问世，也希望中国能涌现自己的量化投资大师，给投资者带来持续稳定的收益。

经常有年轻的宽客问我“中国量化投资的未来有希望吗？”我的回答是“美国对冲基金2万亿美金，中国还不到100亿人民币。美国最聪明的人都在华尔街做对冲基金，你说中国的量化投资会不会有未来？”

相信自己，是成功的第一步！

今天是2011年九月十九，九九归一，真是好日子。自2001年底上海交大毕业留校做计算金融研究算起，到现在正好过去整整十年，好快啊，就以此书作为自己十年研究工作的一个总结吧。

窗外起风了，

天凉好个秋！
策略篇

本篇是策略篇，主要介绍量化投资领域的不同策略和实现算法。

投资策略总的来说分为两大类：判断趋势型和判断波动率型。

判断趋势型是一种高风险的投资方式，通过对大盘或者个股的趋势判断，进行相应的投资操作。如果判断是趋势向上则做多，如果判断趋势向下则做空，如果判断趋势盘整，则进行高抛低吸。这种方式的优点是收益率高，缺点是风险大。一旦判断错误则可能遭受重大损失。所以趋势型投资方法适合于风险承受度比较高的投资者，在承担大风险的情况下，也会有机会获得高额收益。本篇用两章的篇幅来介绍这种趋势型投资方法，分别是量化选股和量化择时。

判断波动率型投资方法，本质上是试图消除系统性风险，赚取稳健的收益。这种方法的主要投资方式是套利，即对一个或者N个品种，进行买入同时并卖出另外一个或N个品种的操作，这也叫做对冲交易。这种方法无论在大盘哪个方向波动，向上也好，向下也好，都可以获得一个比较稳定的收益。在牛市中，这种方法收益率不会超越基准，但是在熊市中，它可以避免大的损失，还能有一些不错的收益。股指期货套利是在股票和股指期货之间的对冲操作，商品期货是在不同的期货品种之间，统计套利是在有相关性的品种之间，期权套利则是在看涨看跌期权之间的对冲。本篇用4章的笔墨阐述了这4种波动率型的投资方法。

无论是哪种投资方式，最终都需要通过一笔笔的订单系统来实现。每一个投资者的订单对市场都是有影响的，买入的订单会推动价格上涨，卖出的订单会造成价格的下跌，这就是冲击成本的由来。冲击成本会降低投资者的收益率，因此需要采用某种算法来尽可能地减少对市场的影响，降低冲击成本。算法交易一章专门阐述了如何采用被动交易算法，在完成订单任务的情况下，尽可能减少对市场的冲击。

策略篇中的策略，采用了很多数学模型和计算机方法，处于篇幅的原因，在策略篇中并没有仔细讨论，而是将其留到理论篇中。读者如果在策略篇中对某些算法或模型不甚理解，则可以参阅后面的理论篇。

第1章　量化投资概念

◆摘要◆

本章主要阐述了与量化投资有关的一些基本概念，包括量化投资的定义、量化投资的优势、量化投资的历史、量化投资的主要策略、量化投资的主要理论基础等。

量化投资就是利用计算机技术并且采用一定的数学模型去践行投资理念，实现投资策略的过程。量化投资的优势在于：纪律性、系统性、及时性、准确性和分散化。量化投资的历史可以追溯到20世纪50年代，最近十年得到了飞速发展，量化投资基金的数量增加值也远远超过了传统投资基金。在国内量化投资基金则是从2009年刚刚起步，正处于朝阳阶段。

量化投资的主要内容包括：量化选股、量化择时、股指期货套利、商品期货套利、统计套利、期权套利、算法交易、ETF/LOF套利、高频交易等。

量化投资的基础理论知识包括：人工智能、数据挖掘、小波分析、支持向量机、分形理论和随机过程。量化投资需要的IT技术包括：数据库、数据仓库、面向对象编程等。

1.1　什么是量化投资

1.1.1　量化投资定义

什么是量化投资？简单来讲，量化投资就是利用计算机科技并采用一定的数学模型去实现投资理念、实现投资策略的过程。

传统的投资方法主要有基本面分析法和技术分析法这两种，与它们不同的是，量化投资主要依靠数据和模型来寻找投资标的和投资策略。

对于量化投资中模型与人的关系，有点类似于病人和医生的关系。在医生治病的方法中，中医与西医的诊疗方法不同，中医是望、闻、问、切，最后判断出结果，在很大程度上取决于中医的经验，定性程度大一些；西医就不同了，先要病人去拍片子、化验等，这些都要依托于医学仪器，最后得出结论，对症下药。

医生治疗病人的疾病，投资者治疗市场的疾病，市场的疾病是什么？就是错误定价和估值，没病或病得比较轻，市场是有效或弱有效的；病得越严重，市场越无效。投资者用资金投资于低估的证券，直到把它的价格抬升到合理的价格水平上。但是，定性投资和量化投资的具体做法有些差异，这些差异如同中医和西医的差异，定性投资更像中医，更多地依靠经验和感觉判断病在哪里；量化投资更像是西医，依靠模型判断，模型对于量化投资基金经理的作用就像CT机对于医生的作用。在每一天的投资运作之前，投资者会先用模型对整个市场进行一次全面的检查和扫描，然后根据检查和扫描结果做出投资决策。

与传统定性的投资方法不同，量化投资不是靠个人感觉来管理资产，而是将适当的投资思想、投资经验，甚至包括直觉反映在量化模型中，利用电脑帮助人脑处理大量信息，帮助人脑总结归纳市场的规律，建立可以重复使用并反复优化的投资策略（经验），并指导我们的投资决策过程。

因此，我们看到量化投资只是一种工具，可以用数量化工具去实现我们的投资理念。我们所关心的不仅仅是投资理念本身是不是成功，同时也要关心所采用的量化工具是不是成功，即是不是准确把握了投资理念本身并去准确地实现了投资理念。

1.1.2　量化投资理解误区

1．不是基本面分析的对立者

量化投资并不是基本面分析的对立者，海外量化投资的经验是量化投资模型很多是基于基本面因素，同时考虑市场因素、技术因素等。因此，量化投资也不是技术分析，而是基于对市场深入理解而形成的合乎逻辑的投资理念和投资方法。

量化投资是一种主动型投资策略，主动型投资的理论基础就是市场非有效的或弱有效的，基金经理可以通过对个股、行业及市场的驱动因素进行分析研究，建立最优的投资组合，试图战胜市场从而获取超额收益。与海外成熟市场相比，A股市场的发展历史较短，投资理念还不够成熟，相应地留给主动型投资发掘市场的潜力和空间也更大。量化主动投资策略以正确的投资理念为根本，通过各种因素的分析，以全市场的广度、多维度的深度视角扫描投资机会，在中国市场的应用将更显其优势。

不少投资者对量化基金还存在一种误区，认为这类基金依靠数量模型作为投资运作的基础，那么基金经理包括投资团队所发挥的作用就不大了。实际上在市场出现转折或者小概率事件的时候，计算机无法代替基金经理的判断，此外，在一个波动剧烈的非单边市场环境下，量化模型对新数据的反应也并不完全令人满意。因此在量化基金的运作中，仍需要经验丰富的基金经理和投资团队来把握一些更加宏观的和大的趋势，而计算机模型的作用是在市场正常的情况下，极大地减少基金经理的工作量，以及避免由于人的情绪带来的失误。

量化投资不仅可以结合定性思想即投资理念，而且也可以让量化投资模型与基金经理的个人判断相结合，这些都将基金投资变得更加完美，也能把基金经理和投资总监们从琐碎的日常信息分析中解放出来。基金经理完全可以花更多的心思考虑市场趋势的变化、市场拐点的状况、市场结构的变化、市场上的黑天鹅，以及向量化模型中添加更多更有用的新信息，更好地为投资决策服务。

2．主动而非被动投资

很多人认为，量化投资是依循预先设计好的模型被动执行投资运作，因此与指数化投资一样是属于被动投资。实际上完全相反，量化投资是一种主动投资。量化投资和指数化投资的理论基础完全不同。指数化等被动投资的理论基础是认为市场是完全有效的，任何企图战胜市场的努力都是徒劳的，既然这样，不如就被动地复制指数，以取得与市场一样的收益水平。

而量化投资的理论基础是市场是无效的，或者是弱有效的，因此投资人可以通过对于市场、行业基本面及个别公司的分析，主动建构一个可以取得战胜市场的超额收益的组合。因此，量化投资属于主动投资策略。

3．不是神秘主义

量化投资不是神秘主义，更不是一个战无不胜的秘笈。量化投资不是靠一个投资模型就能永远赚钱，而且也不是使用一个模型就能解决一切问题，更不是一个模型就能胜任任何市场状况。量化投资模型只是一种工具，量化投资的成功与否在于使用这种数量化工具的投资者是否真正掌握了量化投资的精髓。

我们需要建立很多的量化模型，如选股模型、行业配置模型、择时模型、交易模型、风险管理模型及资产配置模型、套利模型、对冲模型等。量化投资模型只是一种工具、一种方法、一种手段，能实现成熟而有效的投资理念，并不断根据投资理念的变化、市场状况的变化而进行修正、改善和优化。

同时，量化投资模型都必须经历不断地跟踪检验、优化、实证等过程。量化投资是一个不断改进的过程，最重要的就是投资者的投资思想，包括对投资的理解、理念、经验，所有模型都是建立在这些投资思想上的。

4．捕获大概率

量化投资策略从本质上讲是寻找较大概率获胜的机会。那么量化投资必然会观察市场的规律，试图寻找各个因素与未来股票收益之间的关系，并寻找较为成功，即大概率成功的规律。

要从大概率上获取较好的收益，量化投资模型需要着重考虑对资产未来收益看法的估计和辨别，而且主要包括对个股的看法、行业的看法等估计的准确性。对资产未来收益的看法既可以是绝对的收益水平，也可以是相对的收益水平（或称之为Alpha）。对于共同基金而言，对后者即Alpha的估计和预测可能需求更多，量化模型也主要是在寻找最佳的Alpha模型。

在确定投资品种后，量化投资策略需要考虑具体的交易策略和风险控制策略等方面。有较好的交易策略才能最大程度地降低交易成本（包括佣金、税费及冲击成本等），而通常交易成本对业绩的表现也有重要的影响。交易策略主要解决的问题是冲击成本的问题，假设一只基金买某只股票的成本是5％，而收益率却达不到这个水平，那么这个投资策略和方法就不可行——虽然对资产未来收益看法的预测模型很好。

量化投资需要综合考虑资产的鉴别（个股选择、行业配置、资产配置等）、交易（包括择时）和风控（包括对风险收益的平衡等）等方面因素，寻找到成功概率最大的投资组合，达到收益最大化。

1.2　量化投资与传统投资比较

1.2.1　传统投资策略的缺点

投资策略一般可分为主动型投资策略和被动型投资策略，被动型投资即一般所说的指数化投资，而主动型投资策略又可分为传统型投资策略和量化投资策略，如图1-1所示。

图1-1　投资策略分类

所有的主动型基金经理都试图战胜市场以期获得超过市场基准的超额收益。然而，传统的主动型基金经理的绩效一般都很难达到期望值，这也许印证了有效市场理论（EMH）的观点——市场是无法被超越的。但是，我们可以从另外一个角度去思考这个问题，传统主动型投资策略有时的失败也许并不是因为无法超越市场效率的限制，而是由于其本身内在的缺点所致。

（1）传统主动型投资策略受到人类思维可以处理的信息量的限制。人类思维在任何时候都只能考虑有限数目的变量，因此对任何一个基金管理者来说，对大量股票都进行深入分析是不现实的。例如，对于600只的股票样本，被一个传统主动型基金经理紧密跟踪的也许只包括200只，这样就会明显排除从其他股票获益的机会。

（2）传统主动型投资策略容易受到认知偏差的影响。任何人的认知偏差及根深蒂固的思维习惯都会导致决策的系统误差。例如，大多数人都只愿意记住自己成功的喜悦而不愿记住失败的教训，所以在处理问题时一般都会表现出过度自信。行为金融学的研究也表明，认知偏差会歪曲投资者的决策从而对其投资行为产生影响。

（3）传统主动型投资策略更强调收益率而不是风险控制，更加偏重个股挖掘而不是投资组合构造。由于对传统主动型基金的业绩衡量基准缺乏明确的定义，相应地，对其基金经理的投资资产配置也就缺乏严格的限制，这使得基金经理倾向于偏离潜在的业绩基准，在盲目追求高收益的同时，较少考虑相应的风险控制，这也是传统主动型投资策略未能取得期望优异绩效的原因之一。

1.2.2　量化投资策略的优势

量化投资和传统的定性投资本质上是相同的，二者都是基于市场非有效或是弱有效的理论基础，而基金经理可以通过对个股基本面、估值、成长性等方面的分析研究，建立战胜市场、产生超额收益的组合。不同的是，传统定性投资较依赖对上市公司的调研，并加以基金经理的个人经验及主观判断，而量化投资则是将定性思想与定量规律进行量化应用的过程。

量化投资策略有如下五大方面的优势，主要包括纪律性、系统性、及时性、准确性、分散化等。

（1）纪律性：严格执行量化投资模型所给出的投资建议，而不是随着投资者情绪的变化而随意更改。纪律性的好处很多，可以克服人性的弱点，如贪婪、恐惧、侥幸心理，也可以克服认知偏差，行为金融理论在这方面有许多论述。纪律化的另外一个好处是可以跟踪和修正。

量化投资作为一种定性思想的理性应用，客观地在组合中去体现这样的组合思想。一个好的投资方法应该是一个透明的盒子，而不是黑盒子。每一个决策都是有理有据的，无论是股票的选择、行业选择，还是大类资产的配置等，都是有数据支持、模型支持及实证检验的。

（2）系统性：量化投资的系统性特征主要包括多层次的量化模型、多角度的观察及海量数据的观察等。多层次模型主要包括大类资产配置模型、行业选择模型、精选个股模型等。多角度观察主要包括对宏观周期、市场结构、估值、成长、盈利质量、分析师盈利预测、市场情绪等多个角度的分析。

量化投资的系统性还有一方面就是数据多，即海量数据的处理。人脑处理信息的能力是有限的，当一个资本市场只有100只股票，这对定性投资基金经理是有优势的，他可以深刻分析这100家公司，这就是表现出定性基金经理深度研究的优势。但在一个很大的资本市场，比如有成千上万只股票的时候，强大的量化投资的信息处理能力能反映它的优势，能捕捉更多的投资机会，拓展更大的投资机会。

（3）及时性：及时快速地跟踪市场变化，不断发现能够提供超额收益的新的统计模型，寻找新的交易机会。

（4）准确性：准确客观评价交易机会，克服主观情绪偏差，妥善运用套利的思想。量化投资正是在找估值洼地，通过全面、系统性的扫描，捕捉错误定价、错误估值带来的机会。定性投资经理大部分时间在琢磨哪一个企业是伟大的企业，哪个股票是可以翻倍的股票；而量化投资经理大部分精力花在分析哪里是估值洼地，哪一个品种被低估了，买入低估的，卖出高估的。

（5）分散化：在控制风险的条件下，充当准确实现分散化投资目标的工具。分散化，也可以说量化投资是靠概率取胜。这表现为两个方面：一是量化投资不断地从历史中挖掘有望在未来重复的历史规律并且加以利用，这些历史规律都是有较大概率获胜的策略；二是依靠筛选出股票组合来取胜，而不是一只或几只股票取胜，从投资组合理念来看也是捕获大概率获胜的股票，而不是押宝到单个股票上。

1.2.3　量化投资与传统投资策略的比较

1．投资策略比较

如表1-1所示为各种投资策略差异，基于基本面选股的传统策略年追踪误差是所有策略中最高的。“与基准组合的差异”表明了运用不同投资策略的组合收益有别于基准收益的原因，即影响投资组合期望跟踪误差的关键因素。

表1-1　不同投资策略对比

数据来源：Vanguard Investment Counseling & Research，［蒋瑛琨　2008］

从表1-1中可以看出，基本面选股的年跟踪误差最高，量化选股其次。其中，我们对各种策略“与基准组合的差异”进行进一步分析。

（1）个股：投资组合中某只个股的配置比例可能有别于其在基准指数组合中的配置比例。例如，一个采用主动量化策略的基金经理可能将基金的5％配置于某只股票，但基准指数组合在该股上的配置比例为4％；而对一个专业化主动投资的基金经理，他的投资组合中可能根本就没有配置该股。

（2）行业：投资组合中某板块的配置比例可能有别于基准指数组合中该板块的配置比例。例如，某基金对高科技板块的配置比例为35％，而基准指数组合中该板块的配置比例仅为25％。

（3）规模／风格：不同的投资策略可能对股票的规模或者风格有不同侧重，这可能有别于基准指数组合。例如，某些基金经理可能更注重股票的市值规模（大、中、小市值），某些基金经理可能更注重股票的风格特性（价值、成长型），从而导致其对所偏好的风格特性的股票进行超配，这就产生了与基准指数组合的配置比例不一致的情形。

（4）择时：基金经理可能会综合分析上述3种因素，在不同的时期采用不同策略。例如，某基金经理可能根据不同板块在不同阶段的市场表现不同而采用板块轮动策略，超配（或低配）下阶段看好（或看淡）的板块。

2．不同投资策略的业绩对比

采用不同投资策略的基金投资业绩比较如图1-2所示。这里分别列出了3种类型的基金1年期、3年期、5年期和10年期的信息比率（Information Ratio），数据覆盖时间区间为1996年1月1日至2005年12月31日。

图1-2　量化投资与传统投资策略业绩比较（1996—2005年）

数据来源：Möbius, Vanguard Investment Counseling & Research，［蒋瑛琨　2008］

第一种类型表示以Russell 1000指数或者S&P 500指数为投资基准组合（Benchmark）的所有传统主动型投资基金（All Active Funds）；第二种类型表示偏重风险控制的传统主动型投资基金（Risk-controlled Traditional Active Funds）；第三种类型表示量化投资基金（Quantitative Active Funds）。

从图1-2中可以看出，在1996—2005年间，量化基金的信息比率最高，投资业绩优于其他两种类型的基金，相对于传统的主动型投资策略，量化投资基金能够取得更高、更稳定的超额收益。

1.3　量化投资历史

1.3.1　量化投资理论发展

量化投资和数理金融具有很大的共同性，很多量化投资的理论、方法和技术都来自于数理金融，数理金融学是近几十年来兴起的新学科，而其作为学科名称正式出现至今不过十几年的时间。下面我们就从数量金融的发展来回顾整个量化投资的历史。

1．20世纪50～60年代

Markowitz于1952年建立的均值——方差模型，第一次把数理工具引入金融研究，在Markowitz工作的基础上，Sharpe（1964）、Litner（1965）、Mossin（1966研究了资产价格的均衡结构，导出了资本资产定价模型（Capital Asset Pricing Model, CAPM），已成为度量证券风险的基本量化模型。随后，CAPM形成了度量金融投资领域投资绩效的理论基础。

20世纪60年代投资实务研究的另一具有重要影响的理论是Samuelson（1965）与Fama（1965）的有效市场假说（Efficient Market Hypothesis，EMH），这一假说主要包括理性投资者、有效市场和随机游走三方面。该假设成立就意味着，在功能齐全、信息畅通的资本市场中，任何用历史价格及其他信息来预测证券价格的行为都是徒劳。

2．20世纪70～80年代

20世纪70年代，随着金融创新的不断进行，衍生产品的定价成为理论研究的重点。1973年，Black和Scholes建立了期权定价模型，实现了金融理论的又一大突破。该模型迅速被运用于金融实践，使金融创新工具的品种和数量迅速增多，金融市场创新得到空前规模的发展。此后，Ross（1976）建立了套利定价理论（Arbitrage Pricing Theory, APT）。在投资实务中，多因素定价（选股）模型可以看做是APT理论最典型的代表。

3．20世纪80～90年代

20世纪80年代，现代金融创新进入鼎盛时期。在此期间诞生了所谓的80年代国际金融市场四大发明，即票据发行便利（NIFs）、互换交易、期权交易和远期利率协议。金融理论的一个新概念——“金融工程”也诞生了。金融工程作为一个新的学科从金融学独立出来。

20世纪80～90年代，对期权定价理论的进一步研究刺激了对倒向随机微分方程求解的发展，从而对期权定价理论的研究开启了新的动力。同时，对倒向随机微分方程的理论和数值计算的研究又会促使期权定价理论数学模型的新研究。

其次，20世纪90年代金融学家更加注重金融风险的管理。可以说，风险管理是20世纪90年代以来对金融机构管理的中心论题。在风险管理的诸多模型中，最著名的风险管理数学模型是VaR（即Value at Risk）模型，其中以JP.摩根的风险矩阵（RiskMetrics）为主要代表。目前，这种方法已被全球各主要银行、公司及金融监管机构所接受，并成为最重要的金融风险管理方法之一。

同时，在这一时期还形成了另一具有重要影响力的学术流派——行为金融学。有效市场理论在20世纪70年代在学术界达到其顶峰，是那个时期占统治地位的学术观点。但是，进入20世纪80年代以后，关于股票市场一系列经验研究发现了与有效市场理论不相符合的异常现象，如日历效应、股权溢价之谜、期权微笑、封闭式基金折溢价之谜、小盘股效应等。面对这一系列金融市场的异常现象，一些研究学者开始从传统金融理论的最基本假设入手，放松关于投资者是完全理性的严格假设，吸收心理学的研究成果，研究股票市场投资者行为、价格形成机制与价格表现特征，取得了一系列有影响的研究成果，形成了具有重要影响力的学术流派——行为金融学。

4．20世纪90年代末至今

20世纪末，非线性科学的研究方法和理论在金融理论及其实践上的运用，极大地丰富了金融科学量化手段和方法论的研究。无疑，这将开辟金融科学量化非线性的新范式的研究领域。

非线性科学的研究方法和理论，不仅在金融理论研究方面开辟了崭新的非线性范式的研究领域，而且在金融实践和金融经验上也取得累累硕果。其中最为著名的是桑塔费（Santa Fe）于1991年创立的预测公司，它是使用非线性技术最有名的投资公司之一。其名声远扬主要应归功于其创始人：Doyne Farmer博士和Norman Packard博士。他们在系统地阐述李雅普诺夫指数对于混沌分类的重要性方面和重构相空间的延迟方面都有着重要贡献，而且还使用一些不同的方法，如遗传算法、决策树、神经网络和其他非线性回归方法等建立模型。令人遗憾的是，根据专有合同他们的技术属于瑞士银行集团。因此，他们投资过程的细节和业绩记录都是专有财产。

总之，非线性科学的研究方法和理论，为人们进一步探索金融科学数量化的发展，提供了最有力的研究武器。目前研究表明，发展一种将人们所能看到的非线性结构并入到金融理论和金融经验的研究和应用的过程才刚刚起步，这里有许多工作需要人们去开创、丰富和发展。

1.3.2　海外量化基金的发展

1．海外量化基金发展

目前来说，对于量化基金并没有严格的定义。Bloomberg认为量化基金因使用量化投资方法而得名，量化基金通过数理统计分析，选择那些未来回报可能会超越基准的证券进行投资，以期获取超越指数基金的收益。对于一个完全的量化基金来说，其最终的买卖决策完全依赖于量化模型。

在我国证券市场，基本面研究占据市场的主流地位，然而随着证券市场的不断发展，证券数目的增加、衍生品出现及新业务的推出，基金要想战胜指数的难度也不断增加，量化投资将发挥越来越重要的作用。西方国家多年来资本市场的发展，涌现出了一大批优秀的量投资基金。根据Bloomberg的数据，截至2008年11月4日，1184只量化基金管理的总资产高达1848亿美金，相比1988年21只量化基金管理的80亿美元资产来说，年均增长速度高达到20％。

而同期非量化基金的年增长速度仅为8％。图1-3和图1-4分别是量化基金的数目和管理的总资产。

图1-3　1988—2008年期间成立的量化基金数目

数据来源：Reuters

图1-4　海外量化基金规模发展

数据来源：Reuters

量化基金在正常市场环境下已经被证明能带给投资者丰厚的收益，但在金融危机中，是否还能屹立不倒，或是帮助投资者将损失降低到最低程度？

早在1998年，长期资本管理公司的失败已经证明，量化策略和量模型并不能被完全信赖，即使是最严密的模型也有百密一疏的时候。毕竟模型苛刻的假设条件和适用条件与现实有一定差距。

量化投资策略在2007年以来的次贷风波中又一次向我们真实展现了其风险的一面，在遭遇金融危机时，是否能帮助投资者免遭损失？答案是否定的。但经过多次风暴洗礼，量化研究正在逐步成熟，在2007年风暴中，已经有一部分量化基金能够及时地改进模型以减少损失，加上量化策略与生俱来的特点，可以看到，量化投资仍有广阔的发展空间。

从量化策略的失败原因推测其未来的发展趋势，大致有3个方向，即模型数据多样化、参数市场化和定量定性相结合。

在正常市场下，量化策略模型能很好地运作，而一旦市场发生转折，量化模型却未必能及时捕捉市场信息。很多投资公司已开始在模型中加入更多与市场有关的变量，或是在市场发生变化时及时地调整模型，实践证明确实可以做到减少和挽回一部分损失，前提是这种修正是正确的。

量化策略建立在现代金融理论和统计、计算机等学科基础上，帮助投资管理人更好更快地选择时机与证券，减少无谓劳动力。然而诸多例子已证明，单一的量化策略不足以满足投资者需求。较为科学的方法是将量化策略和传统投资策略相结合，模型可发掘市场潜在获利机会，人的判断可以减少模型出错概率，定量与定性的结合或许是最佳选择。

2．案例：Columbine Capital Services

Columbine Capital Services成立于1976年，是为职业财富管理人和基金等大型机构投资者提供数量化研究和咨询服务的一家独立研究机构，研究范围覆盖超过6000家美国公司和近20000家非美国公司，2008年，在评级机构Investars.com对研究机构的业绩排名榜中，Columbine Capital Services已连续四年位居第一。

1）Columbine公司量化模型分类

Columbine公司量化模型的核心思想是：预测超额收益Alpha。该公司研发的Alpha预测量化模型可分为三大类。

（1）成分模型：成分模型用单因素或单一收益特征来分析股票，从某一方面为投资经理提供客观、最优的评估。成分模型有5个子模型成员，分别从不同的角度来预测Alpha。

（2）个股选择模型使用多因素和多重收益特征来预测未来Alpha，选出买入和卖出个股组合。个股选择模型有6个子成员，每个选股模型都有其独特风格。

（3）国际化模型是致力于某一国家或地区的Alpha预测模型，寻找单一市场上所没有的超额收益。Columbine公司拥有除美国以外的28个国家和地区的历史数据来建立某一国家和地区特有的模型版本，其余的市场则由新兴市场模型版本覆盖。

2）Columbine公司量化模型评级系统构建

（1）因子选取：公司的量化投资模型的构建是基于各种收益和风险因子的定义和选择，因子的选取标准如下：首先，每个因子必须具有经济意义；其次，每个因子必须具备显著的预测能力。

（2）模型评级：在定义各个收益和风险因子后，就可以根据不同的需要选择合适的因子来建立不同类型的多因素量化模型，进而对股票进行筛选、排序和分级。量化模型一般将股票池中的股票分为10个等级，分别标记为1～10，1表示最好，10表示最差，再根据模型分级的高低做出“买入”、“中性”或者“卖出”评级。

根据历史业绩，Columbine公司的量化投资模型近4年来的绩效表现相当好，基本都能保持选股的有效性。

1.3.3　量化投资在中国

正因为A股市场不是特别有效的市场，量化投资策略正好可以发挥其纪律性、系统性、及时性、准确性、分散化的优点而捕获国内市场的各种投资机会。

1．量化投资适合A股市场

相比定性投资，现阶段A股市场的特点更适合采用客观、公正而理性的量化投资风格。股票市场复杂度和有效性的增加已对传统定性投资基金经理的单兵作战能力提出了挑战。相对于海外成熟市场，A股市场的发展历史较短，有效性偏弱，市场上被错误定价的股票相对较多，留给量化投资策略去发掘市场的无效性、寻找超额收益的潜力和空间也就更大。事实上，尽管在国内发展历程较短，从国内已有的采用了量化投资方法并且已经运作了一段时间的基金来看，量化基金可以被证明是适应中国市场的。

2．百花齐放的量化基金产品

对于量化基金的产品设计，虽然量化基金一般都是采用多因素模型对股票进行分析和筛选，但不同的量化基金的侧重点是不一样的，也就是包括投资思路、观察角度、分析方法在内都是不同的。

在个股筛选和分析的角度、行业分析的角度、大类资产的配置等方面均有不同的思路，可以体现出各自不同的投资理念和各自的投资特色。

这里所指的量化基金产品包括但不限于量化共同基金产品、指数基金产品、指数增强型基金产品、行业指数基金产品、风格类指数基金产品、策略指数基金产品、ETF产品、收益分级型产品等。

从量化投资提供的工具和方法来看，可以给投资者提供的基金产品可以说是百花齐放，也可以做到有的放矢，满足投资者不同风险收益偏好的投资需求。

3．量化投资本土化前景

量化投资可以为投资者带来更多更丰富更有特色的各类基金产品，丰富机构的产品线。只有建立完善的产品线，才能满足不同投资者的需求，才能在不同的市场状况下获得发展，才能有强大的基金公司。机构可以从量化投资所带来的无限量基金产品线上获益良多。

量化投资不仅可以增加基金的产品线，而且量化投资策略本身也是对机构投资者传统投资的一个强有力的补充和增强。量化投资的好处是可以将各种适合不同经济环境、不同市场环境的投资理念明确地刻画出来，并可以加以建议。那些成功的投资理念通过量化的方式就可以方便地加入到投资决策中去。量化投资策略对提升机构投资者的投资决策能力无可限量。

总而言之，量化投资在中国前景无限。

1.4　量化投资主要内容

一个典型的投资流程如图1-5所示，从中可以看出，量化投资技术几乎覆盖了投资的全过程，包括量化选股、量化择时、股指期货套利、商品期货套利、统计套利、算法交易、资产配置、风险控制等。

图1-5　量化投资学科体系结构

1．量化选股

量化选股就是采用数量的方法判断某个公司是否值得买入的行为。根据某个方法，如果该公司满足了该方法的条件，则放入股票池；如果不满足，则从股票池中剔除。

量化选股的方法有很多种，总的来说，可以分为公司估值法、趋势法和资金法三大类。

公司估值方法是上市公司基本面分析的重要利器，在“基本面决定价值，价值决定价格”基本逻辑下，通过比较公司估值方法得出的公司理论股票价格与市场价格的差异，判断股票的市场价格是否被高估或者低估，从而寻找出价值被低估或价值被高估的股票，指导投资者具体投资行为，如买入、卖出或继续持有。

趋势法就是根据市场表现，强势、弱势、盘整等不同的形态，做出对应的投资行为的方法。可以追随趋势，也可以进行反转操作等。

资金法的本质思想是追随市场主力资金的方向，如果资金流入，应该伴随着价格上涨；如果资金流出，则股票应该伴随着价格下跌。也可以通过持仓筹码的分布来判断在未来一段时间股价的上涨和下跌情况。资金法本质上是一种跟风策略，追随主流热点，从而期望在短时间内获得超额收益。

2．量化择时

股市的可预测性问题与有效市场假说密切相关。如果有效市场理论或有效市场假说成立，股票价格充分反映了所有相关的信息，价格变化服从随机游走，股票价格的预测则毫无意义。从中国股票市场的特征来看，大多数研究报告的结论支持中国的股票市场尚未达到弱有效，也就是说，中国股票市场的股票价格时间序列并非序列无关，而是序列相关的，即历史数据对股票的价格形成起作用，因此，可以通过对历史信息的分析预测价格。

随着计算机技术、混沌、分形理论的发展，人们开始将股票的市场行为纳入非线性动力学研究范畴。众多的研究发现我国股市的指数收益中，存在经典线性相关之外的非线性相关，从而拒绝了随机游走的假设，指出股价的波动不是完全随机的，它貌似随机、杂乱，但在其复杂表面的背后，却隐藏着确定性的机制，因此存在可预测成分。当然，认为股价可预测，并不等于说可以100％的准确预见，而是指可以使用经济预测的方法，建立起能在一定误差要求之下的预测股价变动的预测模型。一批学者先后证实了证券市场的确存在着一些可利用的规律，其成功率之高和稳定性之久，远远超出了随机行走理论可以解释的范围。因此，最近20年，持证券市场缺乏效率观点人越来越多，证券市场预测的研究也再次成为人们关注的热点。

3．股指期货套利

股指期货套利是指利用股指期货市场存在的不合理价格，同时参与股指期货与股票现货市场交易，或者同时进行不同期限，不同（但相近）类别股票指数合约交易，以赚取差价的行为，股指期货套利主要分为期现套利和跨期套利两种。

我国沪深300股指期货已经推出，为券商、基金等机构投资者提供了金融创新的工具，使用这些工具，机构投资者可以按照金融工程的理论框架去探索新的盈利模式。股指期货套利交易就是一种值得研究的新型盈利模式，开展股指期货套利交易对于恢复扭曲的市场价格关系、抑制过度投机和增强市场流动性都有着重要的作用。

股指期货套利的研究主要包括现货构建、套利定价、保证金管理、冲击成本、成分股调整等内容。

4．商品期货套利

商品期货套利盈利的逻辑原理是基于以下几个方面的：相关商品在不同地点、不同时间对应都有一个合理的价格差价；由于价格的波动性，价格差价经常出现不合理；不合理必然要回到合理；不合理回到合理的这部分价格区间就是盈利区间。

正是基于以上几个方面，才产生套利机会，套利者所赚的钱就是从不合理到合理这部分空间，所以套利者所做的就是当价差出现扭曲甚至严重扭曲的时候及时捕捉到机会，稳定赚取这部分利润。

对相关合约之间的价差数据变化规律进行科学的统计分析是商品期货套利过程成功实施的重要前提，只有借助统计分析工具和图表，结合基本面和技术分析，才能预测出今后一段时间内相关合约价差数据变化的趋势，从而把握最佳的套利时机，因此，历史数据的统计分析对成功实施商品期货套利来说非常重要。

另外，考虑到套利交易中的资金成本运用问题，能够通过历史数据变化规律的分析帮助投资者在继续持有套利头寸和提前结束头寸之间做出恰当的选择也是非常必要的。

5．统计套利

有别于无风险套利，统计套利是利用证券价格的历史统计规律进行套利，是一种风险套利，其风险在于这种历史统计规律在未来一段时间内是否继续存在。

统计套利在方法上可以分为两类，一类是利用股票的收益率序列建模，目标是在组合的β值等于零的前提下实现Alpha收益，我们称之为β中性策略；另一类是利用股票的价格序列的协整关系建模，我们称之为协整策略。前者是基于日收益率对均衡关系的偏离，后者是基于累计收益率对均衡关系的偏离。基于日收益率建模的β中性策略，是一种超短线策略，只要日偏离在短期内不修复，则策略就会失效。并且，如果日偏离是缓慢修复的，这种策略很难搜索到合适的平仓时机。

很多分析也表明，β中性策略经常会发出错误的交易信号。而协整策略直接利用了原始变量——股价进行建模，当累计收益率偏离到一定程度时建仓，在偏离修复到一定程度或反向时平仓。

6．期权套利

期权套利交易是指同时买进卖出同一相关期货，但不同敲定价格或不同到期月份的看涨或看跌期权合约，希望在日后对冲交易部位或履约时获利的交易。期权套利的交易策略和方式多种多样，是多种相关期权交易的组合，具体包括水平套利、垂直套利、转换套利、反向转换套利、跨式套利、蝶式套利、飞鹰式套利等。

期权具有杠杆高、损失有限的特点，使得利用期权进行套利交易，比期货套利的效率更高，收益率更大。期权套利分析主要需要解决的问题有高低损益平衡点确定、套利空间计算、交易成本、市场容量等。

7．算法交易

算法交易又被称为自动交易、黑盒交易或者机器交易，它指的是通过使用计算机程序来发出交易指令。在交易中，程序可以决定的范围包括交易时间的选择、交易的价格，甚至可以包括最后需要成交的证券数量。

根据各个算法交易中算法的主动程度不同，可以把不同算法交易分为被动型算法交易、主动型算法交易、综合型算法交易三大类。

8．资产配置

资产配置是指资产类别选择，即投资组合中各类资产的适当配置及对这些混合资产进行实时管理。量化投资管理将传统投资组合理论与量化分析技术结合，极大地丰富了资产配置的内涵，形成了现代资产配置理论的基本框架。它突破了传统积极型投资和指数型投资的局限，将投资方法建立在对各种资产类股票公开数据的统计分析上，通过比较不同资产类的统计特征，建立数学模型，进而确定组合资产的配置目标和分配比例。

今天，全世界有超过万亿美元的资产全部或部分以量化分析为基础进行资产配置。资产配置一般包括两大类别、三大层次，两大类别分别为战略资产配置和战术资产配置，三大层次分别为全球资产配置、大类资产配置及行业风格配置。

1.5　量化投资主要方法

量化投资涉及很多数学和计算机方面的知识和技术，总的来说，主要有人工智能、数据挖掘、小波分析、支持向量机、分形理论和随机过程这几种。

1．人工智能

人工智能（Artificial Intelligence，AI）是研究使用计算机来模拟人的某些思维过程和智能行为（如学习、推理、思考、规划等）的学科，主要包括计算机实现智能的原理、制造类似于人脑智能的计算机，使计算机能实现更高层次的应用。人工智能将涉及计算机科学、心理学、哲学和语言学等学科，可以说几乎是自然科学和社会科学的所有学科，其范围已远远超出了计算机科学的范畴，人工智能与思维科学的关系是实践和理论的关系，人工智能是处于思维科学的技术应用层次，是它的一个应用分支。

从思维观点看，人工智能不仅限于逻辑思维，还要考虑形象思维、灵感思维才能促进人工智能的突破性发展，数学常被认为是多种学科的基础科学，因此人工智能学科也必须借用数学工具。数学不仅在标准逻辑、模糊数学等范围发挥作用，进入人工智能学科后也能促进其得到更快的发展。

金融投资是一项复杂的、综合了各种知识与技术的学科，对智能的要求非常高。所以人工智能的很多技术可以用于量化投资分析中，包括专家系统、机器学习、神经网络、遗传算法等。

2．数据挖掘

数据挖掘（Data Mining）是从大量的、不完全的、有噪声的、模糊的、随机的数据中提取隐含在其中的、人们事先不知道的，但又是潜在有用的信息和知识的过程。

与数据挖掘相近的同义词有数据融合、数据分析和决策支持等。在量化投资中，数据挖掘的主要技术包括关联分析、分类／预测、聚类分析等。

关联分析是研究两个或两个以上变量的取值之间存在某种规律性。例如，研究股票的某些因子发生变化后，对未来一段时间股价之间的关联关系。关联分为简单关联、时序关联和因果关联。关联分析的目的是找出数据库中隐藏的关联网。一般用支持度和可信度两个阈值来度量关联规则的相关性，还不断引入兴趣度、相关性等参数，使得所挖掘的规则更符合需求。

分类就是找出一个类别的概念描述，它代表了这类数据的整体信息，即该类的内涵描述，并用这种描述来构造模型，一般用规则或决策树模式表示。分类是利用训练数据集通过一定的算法而求得分类规则。分类可被用于规则描述和预测。

预测是利用历史数据找出变化规律，建立模型，并由此模型对未来数据的种类及特征进行预测。预测关心的是精度和不确定性，通常用预测方差来度量。

聚类就是利用数据的相似性判断出数据的聚合程度，使得同一个类别中的数据尽可能相似，不同类别的数据尽可能相异。

3．小波分析

小波（Wavelet）这一术语，顾名思义，小波就是小的波形。所谓“小”是指它具有衰减性；而称之为“波”则是指它的波动性，其振幅正负相间的震荡形式。与傅里叶变换相比，小波变换是时间（空间）频率的局部化分析，它通过伸缩平移运算对信号（函数）逐步进行多尺度细化，最终达到高频处时间细分，低频处频率细分，能自动适应时频信号分析的要求，从而可聚焦到信号的任意细节，解决了傅里叶变换的困难问题，成为继傅里叶变换以来在科学方法上的重大突破，因此也有人把小波变换称为数学显微镜。

小波分析在量化投资中的主要作用是进行波形处理。任何投资品种的走势都可以看做是一种波形，其中包含了很多噪音信号。利用小波分析，可以进行波形的去噪、重构、诊断、识别等，从而实现对未来走势的判断。

4．支持向量机

支持向量机（Support Vector Machine，SVM）方法是通过一个非线性映射，把样本空间映射到一个高维乃至无穷维的特征空间中（Hilbert空间），使得在原来的样本空间中非线性可分的问题转化为在特征空间中的线性可分的问题，简单地说，就是升维和线性化。升维就是把样本向高维空间做映射，一般情况下这会增加计算的复杂性，甚至会引起维数灾难，因而人们很少问津。但是作为分类、回归等问题来说，很可能在低维样本空间无法线性处理的样本集，在高维特征空间中却可以通过一个线性超平面实现线性划分（或回归）。

一般的升维都会带来计算的复杂化，SVM方法巧妙地解决了这个难题：应用核函数的展开定理，就不需要知道非线性映射的显式表达式；由于是在高维特征空间中建立线性学习机，所以与线性模型相比，不但几乎不增加计算的复杂性，而且在某种程度上避免了维数灾难。这一切要归功于核函数的展开和计算理论。

正因为有这个优势，使得SVM特别适合于进行有关分类和预测问题的处理，这就使得它在量化投资中有了很大的用武之地。

5．分形理论

被誉为大自然的几何学的分形理论（Fractal），是现代数学的一个新分支，但其本质却是一种新的世界观和方法论。它与动力系统的混沌理论交叉结合，相辅相成。它承认世界的局部可能在一定条件下，在某一方面（形态、结构、信息、功能、时间、能量等）表现出与整体的相似性，它承认空间维数的变化既可以是离散的也可以是连续的，因而极大地拓展了研究视野。

自相似原则和迭代生成原则是分形理论的重要原则。它表示分形在通常的几何变换下具有不变性，即标度无关性。分形形体中的自相似性可以是完全相同的，也可以是统计意义上的相似。迭代生成原则是指可以从局部的分形通过某种递归方法生成更大的整体图形。

分形理论既是非线性科学的前沿和重要分支，又是一门新兴的横断学科。作为一种方法论和认识论，其启示是多方面的：一是分形整体与局部形态的相似，启发人们通过认识部分来认识整体，从有限中认识无限；二是分形揭示了介于整体与部分、有序与无序、复杂与简单之间的新形态、新秩序；三是分形从一特定层面揭示了世界普遍联系和统一的图景。

由于这种特征，使得分形理论在量化投资中得到了广泛的应用，主要可以用于金融时序数列的分解与重构，并在此基础上进行数列的预测。

6．随机过程

随机过程（Stochastic Process）是一连串随机事件动态关系的定量描述。随机过程论与其他数学分支如位势论、微分方程、力学及复变函数论等有密切的联系，是在自然科学、工程科学及社会科学各领域中研究随机现象的重要工具。随机过程论目前已得到广泛的应用，在诸如天气预报、统计物理、天体物理、运筹决策、经济数学、安全科学、人口理论、可靠性及计算机科学等很多领域都要经常用到随机过程的理论来建立数学模型。

研究随机过程的方法多种多样，主要可以分为两大类：一类是概率方法，其中用到轨道性质、随机微分方程等；另一类是分析的方法，其中用到测度论、微分方程、半群理论、函数堆和希尔伯特空间等，实际研究中常常两种方法并用。另外组合方法和代数方法在某些特殊随机过程的研究中也有一定作用。研究的主要内容有：多指标随机过程、无穷质点与马尔科夫过程、概率与位势及各种特殊过程的专题讨论等。

其中，马尔科夫过程很适于金融时序数列的预测，是在量化投资中的典型应用。

第2章　量化选股

◆摘要◆

量化选股就是利用数量化的方法选择股票组合，期望该股票组合能够获得超越基准收益率的投资行为。量化选股策略总的来说可以分为两类：第一类是基本面选股，第二类是市场行为选股。

本章中基本面选股介绍了多因子模型、风格轮动模型和行业轮动模型。市场行为选股介绍了资金流模型、动量反转模型、一致预期模型、趋势追踪模型和筹码选股模型。

多因子模型是应用最广泛的一种选股模型，基本原理是采用一系列的因子作为选股标准，满足这些因子的股票则被买入，不满足的则卖出。多因子模型相对来说比较稳定，因为在不同市场条件下，总有一些因子会发挥作用。

风格轮动模型是利用市场的风格特征进行投资，比如有时候市场偏好小盘股，有时候偏好大盘股，如果是风格转换的初期介入，则可以获得较大的超额收益。

行业轮动与风格轮动类似，由于经济周期的原因，总有一些行业先启动，有的行业跟随。在经济周期过程中，依次对这些轮动的行业进行配置，则比买入持有策略有更好的效果。

资金流选股的基本思想是利用资金的流向来判断股票的涨跌，如果资金流入，则股票应该会上涨，如果资金流出，则股票应该下跌。所以将资金流入流出的情况编成指标，则可以利用该指标来判断在未来一段时间股票的涨跌情况了。

动量反转模型是指股票的强弱变化情况，过去一段时间强的股票，在未来一段时间继续保持强势，过去一段时间弱的股票，在未来一段时间继续弱势，这叫做动量效应。过去一段时间强的股票在未来一段时间会走弱，过去一段时间弱势的股票在未来一段时间会走强，这叫做反转效应。如果判定动量效应会持续，则应该买入强势股，如果判断会出现反转效应，则应该买入弱势股。

一致预期是指市场上的投资者可能会对某些信息产生一致的看法，比如大多数分析师看好某一个股票，可能这个股票在未来一段时间会上涨；如果大多数分析师看空某一个股票，可能这个股票在未来一段时间会下跌。一致预期策略就是利用大多数分析师的看法来进行股票的买入卖出操作。

趋势追踪是属于图形交易的一种，就是当股价出现上涨趋势的时候，则追涨买入；如果出现下跌趋势的时候，则杀跌卖出，本质上是一种追涨杀跌策略。判断趋势的指标有很多种，包括MA、EMA、MACD等，其中最简单也是最有效的是均线策略。

筹码选股是另外一种市场行为策略，基本思想是，如果主力资金要拉升一支股票，会慢慢收集筹码，如果主力资金要卖出一支股票，则会慢慢分派筹码，所以根据筹码的分布和变动情况，就可以预测股票的未来是上涨还是下跌。

有关量化选股业绩评价要从两个方面来考虑，一个是收益率，一个是风险指数，只是收益率高的策略并不能成为最好的策略，应该综合考虑收益率和风险情况才能判断一个选股策略的好坏。量化选股需要考虑的是在承担多大的风险情况下的收益率情况。

2.1　多因子

◆摘要◆

市场上的投资者，不管是价值投资者，还是投机者，或者短线交易者，都会根据某些因子来判断股票的涨跌。当有一群交易者同时采用某个因子的时候，就会造成该因子有效。例如，当很多投资者认为低PE的价值型的股票是好的投资标时，他们纷纷买入低PE的股票，会使得该股票出现上涨，或者超越大市。这样就使得低PE这个因子的有效性得到体现。

市场上有很多这样的因子，它们在不同的市场环境下，或多或少会起作用，从量化分析的角度来看，这些因子和收益率之间存在因果关系。本节的多因子模型就是要研究市场上有哪些因子对最终收益率的作用比较大，它们在不同市场阶段的表现如何。

2.1.1　基本概念

多因子模型是一类重要的选股模型，它的优点是能够综合很多信息最后得出一个选股结果。多因子模型的表现相对来说也比较稳定，因为在不同的市场情况下，总有一些因子会发挥作用。因此，在量化投资界，不同的投资者和研究者都开发了很多不同的多因子模型。各种多因子模型核心的区别一是在因子的选取上，二是在如何用多因子综合得到一个最终的判断。

一般而言，多因子选股模型有两种判断方法，一是打分法，二是回归法。

打分法就是根据各个因子的大小对股票进行打分，然后按照一定的权重加权得到一个总分，根据总分再对股票进行筛选。打分法根据加权方法的不同又可以分为静态加权和动态加权。打分法的优点是相对比较稳健，不容易受到极端值的影响。

回归法就是用过去的股票的收益率对多因子进行回归，得到一个回归方程，然后把最新的因子值代入回归方程得到一个对未来股票收益的预判，最后以此为依据进行选股。回归法的优点是能够比较及时地调整股票对各因子的敏感性，而且不同的股票对不同的因子的敏感性也可以不同。回归法的缺点是容易受到极端值的影响，在股票对因子敏感度变化较大的市场情况下效果也比较差。

2.1.2　策略模型

多因子选股模型的建立过程主要分为候选因子的选取、选股因子有效性的检验、有效但冗余因子的剔除、综合评分模型的建立和模型的评价及持续改进5个步骤。

1．候选因子的选取

候选因子可能是一些基本面指标，如PB、PE、EPS增长率等，也可能是一些技术面指标，如动量、换手率、波动等，或者是其他指标，如预期收益增长、分析师一致预期变化、宏观经济变量等。候选因子的选择主要依赖于经济逻辑和市场经验，但选择更多和更有效的因子无疑是增强模型信息捕获能力，提高收益的关键因素之一。

2．选股因子有效性的检验

一般检验方法主要采用排序的方法检验候选因子的选股有效性。具体而言，对于任意一个候选因子，在模型形成期的第一个月初开始计算市场中每只正常交易股票的该因子的大小，按从小到大的顺序对样本股票进行排序，并平均分为n个组合，一直持有到月末，在下月初再按同样的方法重新构建n个组合并持有到月末，每月如此，一直重复到模型形成期末。

组合构建完毕后，计算这n个组合的年化复合收益、相对于业绩基准的超出收益、在不同市场状况下的高收益组合跑赢基准和低收益组合跑输基准的概率等。为确定选股因子的有效性，建立如下数量标准：

（1）序数为1到n的组合年化复合收益应满足一定的排序关系，即组合因子的大小与收益应具有较大的相关关系，从统计的角度看，因子能较为显著地影响组合预期收益。假设序数为i的组合年化复合收益为xi
，那么xi
与i的相关性绝对值Abs（Corr（xi
，i））应满足如下关系：

Abs（Corr（xi
，i））≥MinCorr

其中，MinCorr为模型所设定的收益和序数最小相关性阈值。

（2）令序数为1和n的两个极端组合相对基准的超额收益分别为AR1
和ARn
，如果AR1
＞ARn
（该假设表示因子越小，收益越大），那么两者应满足如下条件：

AR1
＞MinARtop
＞0和ARn
＜MinARbottom
＜0

反之，如果AR1
＜ARn
（该假设表示因子越大，收益越小），那么与上面不等式类似，两者应满足：

ARn
＞MinARtop
＞0和AR1
＜MinARbottom
＜0

其中MinARtop
、MinARbottom
分别为两个极端组合的最小超出收益阈值，以上条件保证因子最大和最小的两个组合中，一个是明显跑赢市场的赢家组合，另一个是明显跑输市场的输家组合。

（3）无论在上涨、下跌还是整个模型形成期，序数为1和n的两个极端组合中，较高收益的组合应该能以较高的概率跑赢市场，而较低收益的组合则能以较高概率跑输市场。

符合以上3个条件的因子至少说明在过去的一段时期内表现出较好的选股能力，可以作为进一步筛选的有效选股因子。

3．有效但冗余因子的剔除

不同的选股因子可能由于内在的驱动因素大致相同等原因，所选出的组合在个股构成和收益等方面具有较高的一致性，因此其中的一些因子需要作为冗余因子剔除，而只保留同类因子中收益最好，区分度最高的一个因子。假设需要选出k个有效因子，样本期共m月，那么具体的冗余因子剔除步骤如下：

（1）先对不同因子下的n个组合进行打分，分值与该组合在整个模型形成期的收益相关，收益越大，分值越高，具体方法：令组合1和n相对基准的超额收益分别为AR1
和ARn
，如果AR1
＜ARn
，则将组合i的分值设为i；反之，AR1
＞ARn
，组合i的分值为n－i＋1，即所有组合的分值取1到n间的连续整数。组合得分确定后，再将其赋给每月该组合内的所有个股。

（2）按月计算个股的不同因子得分间的相关性矩阵，令第t月的个股因子得分相关性矩阵为：（Score_Corrt，u，v
），u，v＝1，2，...，k，u和v为因子序号。

（3）在计算完每月因子得分相关性矩阵后，计算整个样本期内相关性矩阵的平均值，计算公式为：

（4）设定一个得分相关性阈值MinScoreCorr，对得分相关性平均值矩阵中大于该阈值的元素所对应的因子只保留与其他因子相关性较小、有效性更强的因子，而其他因子则作为冗余因子剔除。

4．综合评分模型的建立和选股

综合评分模型选取去除冗余后的有效因子，在模型运行期的每个月初对市场中正常交易的个股计算每个因子的最新得分，并按照一定的权重求得所有因子的平均分。如果有的因子在某些月份可能无法取值（例如，有的个股因缺少分析师预期数据无法计算预期相关因子），那么按剩下的因子分值求加权平均。最后，根据模型所得出的综合平均分对股票进行排序，然后根据需要选择排名靠前的股票。例如，选取得分最高的前20％股票，或者选取得分最高的50～100只股票等。

5．模型的评价及持续改进

一方面，由于量化选股方法是建立在市场无效或弱有效的前提之下，随着使用多因子选股模型的投资者数量的不断增加，有的因子会逐渐失效，而另一些新的因素可能被验证有效而加入到模型中；另一方面，一些因子可能在过去的市场环境下比较有效，而随着市场风格的改变，这些因子可能短期内失效，而另外一些以前无效的因子会在当前市场环境下表现较好。

另外，计算综合评分的过程中，各因子得分的权重设计、交易成本考虑和风险控制等都存在进一步改进的空间。因此在综合评分选股模型的使用过程中，会对选用的因子、模型本身做持续的再评价和不断改进以适应变化的市场环境。

2.1.3　实证案例：多因子选股模型

本案例选取1997—2010年共14年作为样本期，其中1997—2004年作为因子检验筛选期（共8年），2005—2010年作为选股模型的样本外检验期（共6年）。所选股票样本为所有正常交易且上市时间超过一个季度的A股股票，业绩基准为上证指数。

1．候选因子的选取

案例从估值、成长性、资本结构、技术面等角度，选取了30个较为常见的指标作为模型的候选因子，具体的因子选取如表2-1所示。

表2-1　多因子选股模型候选因子 

数据来源：［潘凡　2011］

注： 
再投资率＝［（过去12个月每股收益－每股分红）/期初每股净资产］，反映了公司将盈利留存并进行再投资的情况。

震荡指标＝［（前月最高价－最低价）/（前月月初股价＋月末股价）］，来源于一个简单的市场经验：横有多长，竖有多高。

2．选股因子有效性的检验

首先，在1997年1月到2006年12月间的每个月初，根据表2-1所列的候选因子，分别计算每只个股相应的因子得分，具体步骤如下：

（1）在每个月初计算每支个股的各因子指标，在涉及财务指标的计算上尽量采用最新报表以反应最新的财务信息，例如，EPS的计算采用12个月的EPS。

（2）根据因子指标的计算结果，从小到大对样本股票进行排序并分为5个等份组合，从而在整个样本期内形成不同因子下的5个排序组合。

（3）分别计算不同因子下的5个排序组合的流通市值加权年化复合平均收益、相对于业绩基准的平均年化超额收益、在不同市场环境下第1和第5组合战胜或跑输基准的概率，如表2-2所示。

表2-2　多因子模型候选因子初步检验 

数据来源：［潘凡　2011］

从表2-2中可以看出，表现最好的是盈利收益率这个指标，8年的年化复合平均收益为8.29％，而同期的上证指数年化复合平均收益只有4.12％。

综合考虑了复合收益、超额收益及相关性后，获得如表2-3所示的经过检验过的有效因子。

表2-3　多因子模型中通过检验的有效因子 

数据来源：［潘凡　2011］

3．有效但冗余因子的剔除

对这些初步有效的因子计算相关性矩阵，假定得分相关性阈值取0.5，表2-3中的盈利收益率和PEG相关性为0.89，ROA变动和ROE变动相关性为0.70，盈利收益率和收入净利率相关性为0.59，这些项目的相关性均超过阈值，因此取其中超额收益相对较高的因子，最终剔除的因子为PEG、ROE变动和收入净利率，总共剩下9个选股因子，如表2-4所示。

表2-4　多因子模型中剔除冗余后的因子 

数据来源：［潘凡　2011］

4．综合评分模型的建立和选股

最终的综合评分模型由9个分值相关性较小的有效因子组成。为了评估个股的综合表现，模型在选股日对所有正常交易的股票按9个因子分别评分后再按照一定的权重计算加权平均值，如果有的因子没有取值，那么该因子不参与平均值的计算。在综合打分后，去掉所有的ST、PT股票，将市场所有股票按平均分重新排序，选取其中得分最高的若干股票进入当月组合，即完成了模型选股的完整过程。

5．模型的检验

本案例采用2005年1月到2010年12月共6年的数据验证该模型的有效性。每月初将样本股票按最新的综合评分从大到小排序，分为Q1到Q5共5个股票数量相同的流通市值加权组合，持有到月末，再在下月初用同样的方法重新构建组合，一直到检验期末。假设在2005年初将1000元投资于这5个组合及上证指数，那么在2010年末，Q1到Q5的净值分别为6184.51、4863.20、3562.70、2309.13和2138.92，而投资于上证指数的组合净值仅为2217.20。另外，如果投资于沪深300指数，则期末净值为3128.26；如果投资于中证500小市值公司指数，则期末净值为5002.09。详细的组合收益描述如表2-5所示。

表2-5　多因子模型组合分段收益率 

数据来源：［潘凡　2011］

组合及各指数的净值走势如图2-1所示。得分最高的Q1组合年化复合收益为35.48％，而同期上证指数年化收益为14.19％，超出指数21.29％；信息比率为1.14，大约68.06％的月份跑赢上证指数，其中上证指数上涨的月份中，大概有76.09％的月份跑赢指数，而指数下跌的月份中有53.85％的月份跑赢指数，总体而言，上升市场中的表现要好于下跌市场。

图2-1　多因子模型净值表现

数据来源：［潘凡　2011］

本节小结

总体而言，本案例所建立的多因子选股模型简单易行，有较好的稳健性，样本外的表现也很好，当然，也仍然存在较大的改进空间。

首先，在因子选择上还可以选取更多的指标，例如，可以在候选因子中增加分析师预期因子，如6个月一致预期的改变、未来两年分析师每股收益预测相对前两年的复合增长、基于一致预期的市盈率等，也可以加入一些宏观指标，使得选股模型能包含更多的信息，提高选股能力。

其次，本案例采取静态的因子评分加权平均的方法，而在实际模型构建中，可以根据因子在前期的表现、个股所在行业、市场状况等，动态调整因子评分的比重，使得选股模型能更加贴近市场的现实状况。

最后，组合持有期长短的动态调整、交易成本的优化、模型运行过程中的风险控制等都可以考虑到选股模型中，使得模型具有更大的灵活度和更有操作性。

2.2　风格轮动

◆摘要◆

市场上的投资者是有偏好的，有时候会偏好价值股，有时候偏好成长股，有时候偏好大盘股，有时候偏好小盘股。由于投资者的这种不同的交易行为，形成了市场风格，因此在投资中，利用市场风格的变化，进行轮动投资会比一直持有的效果好很多。

本节研究如何判断市场风格，以及如何利用风格的轮动构建投资策略获取超额收益。

2.2.1　基本概念

投资风格是针对股票市场而言的，是指投资于某类具有共同收益特征或共同价格行为的股票，即某类投资风格很受欢迎，并且在某一个时间段内具有持续性和连续性（譬如，价值投资和成长型投资两种风格，或者大盘股和小盘股这两种风格总是轮流受到市场追捧）。由于投资风格的存在，从而产生一种叫做风格动量的效应，即在过去较短时期内收益率较高的股票，未来的中短期收益也较高；相反，在过去较短时期内收益率较低的股票，在未来的中短期也将会持续其不好的表现。

投资风格的形成主要来源于对股票市场异象的研究成果。在长期市场研究中，研究人员发现存在大量市场异象，主要包括公司属性效应、趋势效应等。市场有效性程度不是一层不变的，会随时间不断变化。也就是说，追逐这些市场失效现象能获取超额投资收益。所以，风格投资从本质上来说是通过执行各种投资决策，从某些特定分割的、异质的市场或从某类错误定价的股票中获得超额收益。

1．风格鉴别方法

国外投资风格鉴别技术一般可分为两种：一种是持股特征基础的投资风格鉴别法（HBS），包括晨星公司的风格箱法和新风格箱法、罗素公司的风格分类系统、富兰克罗素和所罗门兄弟公司开发的风格分类系统等；另一种是收益率基础的投资风格鉴别法，如夏普的鉴别方法等。

1）持股基础判别法

晨星风格箱法是一个3×3矩阵，从大盘和小盘、价值型和成长型来对基金风格进行划分，介于大盘和小盘之间的为中盘，介于价值型和成长型之间的为混合型，共有9类风格，如表2-6所示。

表2-6　晨星市场风格判别法 

数据来源：MorningStar

（1）规模指标：市值。通过比较基金持有股票的市值中值来划分，市值中值小于10亿美元为小盘；大于50亿美元为大盘；10亿～50亿美元为中盘。

（2）估值指标：平均市盈率、平均市净率。基金所持有股票的市盈率、市净率用基金投资于该股票的比例加权求平均，然后把两个加权平均指标和标普500成分股的市盈率、市净率的相对比值相加，对于标普500来说，这个比值和是2。如果最后所得比值和小于1.75，则为价值型；大于2.25为成长型；介于1.75～2.25之间为混合型。

2）夏普收益率基础的投资风格鉴别

夏普将收益率基础的投资风格鉴别将所有股票分为4类：

（1）将标普500指数成分股按净市比（B/P）排序分为两类，分界点是两类股票的总市值大小一样，高B/P的股票为价值股，其余为成长股，更新频率是6个月。

（2）将非标普500指数成分股按市值高低分为两类，从高到底排序后占总市值前80％的股票称为中市值股，剩下的则为小市值股。

收益率基础投资风格鉴别如表2-7所示。

表2-7　夏普收益率基础投资风格鉴别 

2．经济解释

（1）经济周期。宏观经济表现强劲时，小市值公司有一个较好的发展环境，易于成长壮大，甚至还会有高于经济增速的表现，因此，小盘股表现突出的概率高于大盘股。而当经济走弱时，由于信心的匮乏和未来市场的不确定性，投资者可能会倾向于选择大盘股，起到防御作用，即使低通货膨胀、货币走强，也不足以冒险去选择小盘股。

研究发现，经济名义增长率是用来解释规模效应市场周期的有力变量。当名义增长率提高时，小市值组合表现更优，因为小公司对宏观经济变动更为敏感，当工业生产率提高、通货膨胀率上升时，小公司成长更快。

（2）反应过度／不足。Fama and French（1995）认为风格的周期性轮换是由于投资者的趋势追逐特性造成的。当某类风格的股票在某段时间内具有较好走势时，趋势投资者就会增加对该风格资产的投资，风格走势得以延续。但过度反应会使得该种风格的股票积累过多风险，泡沫最终破灭，形成了不同风格的周期性表现。

（3）价值回归。过度反应的最后结局还是泡沫破灭，而反应不足最终也会被市场纠错，这是由价格最终要向价值回归的本质决定的。这也为我们研究风格策略提供了方向。通过研究某一风格的股票价格是否远离其价值、扣除手续费等费用后是否有足够的利润空间，来给出策略建议。

2.2.2　盈利预期生命周期模型

盈利预期生命周期模型，刻画了投资者对盈利预期演化的各个阶段，如图2-2所示。该模型认为几乎所有的股票都会经历上述的部分阶段，不过并非任何股票都要完整经历所有阶段，而且不同股票经历盈利预期生命周期循环的速度不同。此外，在子阶段中也可能存在完整的盈利预期循环。

图2-2　盈利预期生命循环周期模型

数据来源：Bernstein, Richard, "Style Investing: Unique Insight into Equity Management", JohnWiley & Sons, 1995

1．阶段特征

（1）反转：反转策略投资于具有较低盈利预期的股票，多数投资者认为这些股票不具有吸引力或风险过高。

（2）正向收益超预期：具有较低预期的公司开始发布稍微乐观的信息，股票重新获得投资者的注意，对于这些股票的研究覆盖开始增多。

（3）正向收益超预期模型：基于实际盈利和分析师预期有显著正向差异的选股模型。传统的正向收益超预期模型指持有股票直至实际盈利发布，这样就从盈利预期生命周期模型的第3阶段过渡到了第2阶段。

（4）预期修正：随着正向的收益超预期，市场一致预期开始调升盈利水平，部分分析师的滞后调整是因为他们不愿相信这种超预期意味着基本面的改变。

（5）EPS动量：盈利动量策略的投资者基于预期和实际盈利的增长，以及EPS的年度同比增加而买入股票。

（6）成长性：当强劲的盈利动量持续相当长一段时间时，股票被认为具有成长性。这些股票既不是像在第4或第5阶段那样，属于被先知先觉的投资者新挖掘的成长股；也不是使得商业环境改变的真正的成长性公司。不过，大多数投资者认为这些股票具有较优秀的特质，这些股票的盈利预期非常高，因此也是盈利预期生命周期模型中不符合预期的风险最高的阶段。反转策略的投资者认为此时是抛售的最佳时机。

（7）破灭：公司开始达不到盈利预期。盈利预期和股价开始崩塌。

（8）负向收益超预期模型：和第3阶段相对应，不过此时实际盈利和分析师预期有显著负向差异，这些股票是最好的卖出对象。

（9）预期修正：随着负向的收益超预期，市场一致预期开始调低盈利水平。同样，部分分析师的滞后调整是因为他们不愿相信这种低于预期意味着公司基本面的改变。

（10）蹩脚货：当公司实际盈利持续低于盈利预期一段时间后，投资者开始回避这些股票。有关并购、重组或破产的谣言会使得股价发生短期波动，但投资者会尽量回避这些股票。

（11）被忽略的：投资者对这些股票兴趣索然，研究机构认为其毫无覆盖的价值而将其剔除，缺乏相关的研究信息也许意味着一个新周期的开始。

2．投资风格

按照此盈利预期生命周期模型，区分了成长风格和价值风格的投资者。成长风格的投资者一般对投资标的有较高的预期，而与之对应，价值风格的投资者对投资标的的预期较低。因此，成长风格和价值风格的投资者分别处于盈利预期生命周期模型图的上半部分和下半部分。

根据盈利预期生命周期模型，还可以区分基于好公司和坏公司的投资策略，我们也可以理解为基于盈利预期动量和盈利预期反转的投资策略。基于好公司的投资策略寻找那些处于预期上升阶段的公司，而不管盈利预期较好或较坏，只要预期改善即可；而基于坏公司的投资策略则高买低卖，即在预期最乐观的时候卖出，在最悲观的时候买入。因此，基于好公司和坏公司的投资策略，分别处于盈利预期生命周期模型图的左半部分和右半部分。

将以上两种划分结合起来，就可以得到4种风格策略：成长动量、成长反转、价值动量和价值反转。

2.2.3　策略模型

1．传统的风格预测方法

实施风格轮换战略，在不同的风格类别之间进行切换，需要对各类风格的收益特性有较好的把握和对未来风格走势有较准确的判断。风格评估和预测的方法可分为相对价值法和场景预测法两类。

（1）相对价值法的核心是均值回归理论，被低估的股票价格最终将被市场发现而向均值回归，被高估的股票价格也将下跌至均值水平。能获得低估或高估收益的投资者，必然是对某类股票、企业有着长期的追踪研究并具备价值发现能力的投资者。当市场出现价格偏差时，能在第一时间发现并调整组合，及时判断出市场未来走势。

（2）场景预测法的核心：同一风格股票的收益率间存在某种相似属性和因素敏感性，因此当外部环境发生变化时，受某类因素正面影响的风格类型将取得超额收益，反之则会获得低于市场的收益。场景预测法可分为两个步骤：

①对影响股票收益的各个因素建立因素模型。

②设想未来可能出现的不同场景，对未来风险状况进行预测。

2．风格轮动的定量预测

由于市场风格轮动，保持单一的投资风格并不一定是最佳的投资策略，积极的风格转换策略有助于提高投资绩效。风格转换主要涉及两个问题，即在何时进行风格转换，以及风格转换能否弥补交易成本。

风格转换策略模型实际上是在建立了一系列基本预测变量的基础上，寻找一个适用于风格转换的合理模型。从已有文献看，主要有以下3类方法：

（1）将风格相对收益率对相关变量进行回归。但由于建立精确关系较为困难，因此这种方法基本被排除。

（2）Markov Switch模型。该模型主要关注相对收益率的历史表现（按照Levist的变量分类办法，这些指标主要是技术变量），并不关注其他基本经济变量，因此这种方法可能遗漏了很多可用信息。

（3）Logistic概率模型。在任意时点，风格转换的结果无非有两种，即转换或不转换。如果预期下期某类风格占优，则将现有风格转化为占优的风格。

标准Logistic模型如下：

其中，如果构建期后一月份的某风格（如价值股）收益率大于另一风格（如成长股）收益率，则yt＋1
＝1，否则yt＋1
＝0。建立递归预测方法，当构建期往后延伸时，则形成时间序列y1
，y2
，…，YT
。

在建立Logistic预测模型前，需要首先选择n个可能的影响因素（宏观、基本面与技术面等），这可以通过逐步回归、主成分分析等方法选择。然后，利用Y对n个解释变量建立多元Logistic回归模型。可采用Jackknife method等检验方法对多元Logistic模型的稳定性进行检验，并确定模型最佳的判别点。比较按最佳判别点确定的风格转换策略所获得的收益，是否大于任何简单的买入并持有策略，若难以超越，则认为简单的买入持有策略为最佳策略；若超过，则考虑交易成本后的最佳转换风格的交易策略。

2.2.4　实证案例：中信标普风格

案例　风格轮动策略

本案例的实证数据采用了中信标普风格指数进行，选取的数据段为2004年1月至2007年9月的A股数据，如表2-8所示为中信标普风格指数。

表2-8　中信标普风格指数 

资料来源：中信标普指数服务

在中信标普的风格指数中，构建了两类风格指数系列：穷尽型风格指数和纯风格指数系列。穷尽型风格指数系列可以有效地成为指数基金和衍生品的构成基础，使产品能够宽泛且经济地投资于某种特定的风格板块；纯风格指数系列包括风格指数系列中那些具有显著成长或价值特征的股票。

纯成长指数和纯价值指数之间没有任何重合的股票。这些指数没有因使用市值权重而造成规模偏差。相反，股票按其相对的风格吸引力被赋予权重。因此，纯风格指数系列较为适合实证研究，更能体现出指数的不同风格收益差。

本案例所选用的具体数据为：选择6个风格指数，它们分别是大盘价值（100纯价值）、大盘成长（100纯成长）、中盘价值（200纯价值）、中盘成长（200纯成长）、小盘价值（小盘纯成长）、小盘成长（小盘纯价值）。

为了避免牛市／熊市效应，对动量策略和反转策略的检验，采用了多头／空头的配置方法，而不是仅仅考虑多头组合的盈利情况。

1．风格动量策略

（1）构建投资组合的观测期为j个月（j＝1，3，6，12），计算每个指数的收益率。

（2）根据风格组合收益率从大到小进行排序，其中最高的一个（或者两个）风格组合被定义为赢者组合，最低的一个（或者两个）风格组合被定义为输者组合，通过买入赢者组合、卖空输者组合来构建多空头套利组合，并持有k个月。

（3）持有期分别为1个月、3个月、6个月、12个月。

（4）在持有期末，重复步骤（2）和（3）的操作。

2．风格反转策略

风格反转策略除了步骤（2）为构建相反的头寸，即买入输者指数，卖出赢者指数，并持有k个月外，其余步骤均与动量交易策略相同。

结果判定：如果套利组合具有正的月均收益，则认为是风格动量；如果套利组合是负的月均收益，则认为是风格反转。同时，对套利组合的收益进行t检验，如果t值统计显著，则认为存在相应的动量或者反转效应。

3．实证结果

按照上述策略，为了使得实证结果贴近实际投资绩效，所有股票的收益结果都采用了几何平均值。分别按照观测期J＝1，3，6，12和持有期k＝1，3，6，12构建了16个套利组合，并分别测算了赢家组合、输家组合和套利组合的月均收益，如表2-9所示。

表2-9　风格动量策略组合月均收益率 

注：**标记表明t值在1％水平上统计显著，*标记表明t值在5％水平上统计显著

资料来源：［宋曦　2007］

从上面的实证结果可以发现如下一些结论：

（1）风格动量效应不明显：所有套利组合中，仅有3个组合出现了风格动量效应，即观测期j和持有期k分别为（1，1），（1，6），（6，12），这3个组合中其中只有（1，1）统计显著性达到了1％。

（2）风格动量效应时间较短：实证结果表明只有在观测期为1月，买入并持有1个月的组合统计上1％水平上显著，而其余两个具有动量的效应的组合都只在5％水平上显著。

（3）中期风格反转迹象较为明显：在观测期为3个月的4个组合中，其中3个组合具有风格反转效应（套利组合收益为负，且统计显著），即观测风格动量3个月并分别持有前3个月表现最差的组合3个月、6个月和12个月均出现了显著的风格反转效应。

（4）长期风格动量与反转效应均不明显：在观测期为6个月和12个月时，8个投资组合中仅有1个组合出现了较为显著的风格动量，中国市场并未出现长期的风格动量或者反转效应，这与国外已有的实证结果——“中期动量，长期反转”差异较大。

各种实证研究研究结论表明，中国股市风格投资具有如下特点：

（1）积极的风格管理能创造出超额收益。

①如果一个投资者能够准确进行风格选时，就能制造出显著超额的收益。

②进行大盘／小盘风格选时潜在获利能力强于价值／成长。

③对大盘／小盘轮动的选时频率可以频繁进行，一年内可以多次进行，但价值／成长轮动频繁转换的意义不大，适合进行年度或者更长时间周期的选时及轮动。

（2）建立风格选时的量化投资模型，操作难度较大。虽然通过运用支持向量机（SVM）方法进行风格选时的预测，但结果依然差强人意。预测精度与国外同类模型的输出相比，仍然较差。主要原因如下：

①中国股市与宏观经济指标的关联性差。

②数据来源受限，无法得到一些风格指数的成分数据。

（3）风格动量效应不明显，持续时间较短。如果要进行积极的风格动量投资，应当加强对前1个月的受欢迎投资风格进行重点观测，即增强配置前1个月受欢迎风格的股票，降低配置不受欢迎风格类股票能够显著提高组合的投资收益。

（4）中期风格反转效应较明显。3个月的风格效应容易出现反转，即密切观测以3个月为一个周期的风格动量具有比较强的现实意义。对于一个积极风格管理者，不妨以3个月为周期进行风格反转操作，建议持有期在3个月以上。

（5）积极风格管理的适用对象为中短期投资者。由于长期的风格收益差及风格动量并不十分明显，因此，主动风格轮动策略适用于积极的中短期投资者。对于长期投资者来说，构建风格中性的投资组合或许是最佳的选择（风格中性：指投资组合不偏向某一种特定投资风格，平衡配置各种风格的股票）。

2.2.5　实证案例：大小盘风格

案例　大小盘风格轮动策略

大小盘轮动最为投资者所熟知，本案例就A股市场的大小盘风格轮动进行实证研究，通过建立普通的多元回归模型来探寻A股的大／小盘轮动规律。

1．大小盘风格轮动因子

大小盘风格轮动因子如下。

（1）M2同比增速：M2同比增速为货币因素，表征市场流动性的强弱。当流动性趋于宽松时，小盘股相对而言更容易受到资金的追捧。

（2）PPI同比增速：PPI反映生产环节价格水平，是衡量通胀水平的重要指标；且PPI往往被看成CPI的先行指标。

（3）大／小盘年化波动率之比的移动均值：波动率表征股票的波动程度，同时也在一定程度上反映投资者情绪；可以认为大／小盘年化波动率之比能够反映出一段时间内大／小盘风格市场情绪的孰强孰弱，而经过移动平滑处理后的数值则更加稳定。

2．预测模型

基于上面所讲的风格因子建立如下回归模型：

D（Rt
）＝α＋β1
·MGt－1
＋β2
·PGt－3
＋β3
·σt－3
＋εt

其中，

D（Rt
）为当月小／大盘收益率差（对数收益率）；MGt－1
为上月M2同比增速；PGt－3
为3个月前PPI同比增速；σt－3
为3个月前小／大盘年化波动率之比的移动平滑值；εt
为误差项。

本案例采用滚动78个月的历史数据对模型进行回归，得到回归系数后对后一期的D（Rt
）进行预测，由修正预测值的正负来进行大／小盘股的投资决策。数据预测期为2004年6月至2010年11月。

3．实证结果

在78个月的预测期中，准确预测的月数为42个月，准确率约为53.85％，并不十分理想。但值得一提的是，2009年10月至2010年12月，模型的预测效果非常好，准确预测的月数为12个月（仅在2010年6月和10月出现了差错），该段时间的预测准确率达85.71％，结果如表2-10所示。

表2-10　大小盘风格轮动策略月收益率均值 

资料来源：［曹源　2010］

若从2004年6月开始按照轮动策略进行投资，则截至2010年11月底轮动策略的累积收益率为307.16％，同期上证综指的收益率为81.26％，小盘组合的累积收益率为316.97％；轮动策略稍逊于小盘组合，但仍较大幅度地跑赢了市场指数。

如图2-3所示，轮动策略在2007年的大牛市中能够很好地跟随大盘股的节奏，而在2009年以来的结构性行情中又能较好地捕捉小盘股的投资机会。

图2-3　大小盘轮动策略收益率曲线

资料来源：［曹源　2010］

若从2007年初开始采用轮动策略进行投资，则截至2010年11月底累积收益率可达458.65％，大幅超越同期上证综指及大、小盘组合的收益率。

本节小结

本节阐述了有关风格轮动的原理、策略和方法，并且用两个案例来验证该方法的有效性。从实证的结果来看，风格轮动策略比单纯的持有策略具有明显的超额收益，这说明A股市场确实存在风格效应。

2.3　行业轮动

◆摘要◆

与风格轮动类似，行业轮动是另外一种市场短期趋势的表现形式。在一个完整的经济周期中，有些是先行行业，有些是跟随行业。例如，对某个地方基础设施的投资，钢铁、水泥、机械属于先导行业，投资完后会带来房地产、消费、文化行业的发展，这就属于跟随行业。

研究在一个经济周期中的行业轮动顺序，从而在轮动开始前进行配置，在轮动结束后进行调整，则可以获取超额收益。本节研究这种行业轮动的规律和策略。

2.3.1　基本概念

1．行业配置与宏观经济

自上而下的投资分析方法认为，宏观经济决定了资产的收益率，因此对于一个坚持自上而下分析的投资者来说，一般先关注宏观经济运行指标的变动，然后进行资产配置，或者调整投资组合的风格，并且指导股票资产中的行业组合进行积极管理。

从股票投资的方向来看，利用宏观经济指标驱动行业配置的理念和作用在于：

（1）在自上而下的投资分析中，行业层面是最基本的分析，也是由宏观经济来指导的。

（2）在股票收益分解过程中，实证结果表明行业因子是股票收益的重要贡献因子，因此，能够预测到行业未来的变动，选择强于整体市场的行业进行配置，获得超额收益的概率也将较高。

2．宏观经济周期对行业配置的指导

作为自上而下投资策略的重要组成部分，行业配置是投资管理中一个重要的环节，国外许多实证研究表明，在环球资产配置中，行业配置对组合收益的贡献的重要性甚至超过了国家配置，而且认为行业配置的重要性在未来相当长一段时间内也将保持。行业轮动策略的有效性原因是，资产价格受到内在价值的影响，而内在价值则随着宏观经济因素变化而波动。而周期性行业在不同经济周期表现差异较大的原因是，其经济产业链上的位置所决定的现金流量不均衡。

研究表明，板块／行业轮动在机构投资者的交易中最为获利的盈利模式是基于行业层面进行周期性和防御性的轮动配置，这也是机构投资者最普遍采用的策略。此外，周期性股票在扩张性货币政策时期表现较好，而在紧缩环境下则支持非周期性行业。行业收益差在扩张性政策和紧缩性政策下具有显著的差异。

3．货币政策周期的划分标准

国际上的研究者一般根据FED的利率方向性变化采用FED贴现率来划分货币政策的周期，他们认为依赖于FED的贴现率而不是联邦基金利率具有两个好处：一是FED贴现率自FED成立以来就一直存续，比基准利率存在时间长；二是贴现率与联邦基金利率存在相对应的转换点。

由于我国利率并没有实现市场化，而是由政府管制的，因此我国货币政策实际能运用的利率进行调整的范围并不大。如果按照利率政策来看，进行行业轮动期间跨度过长，并不能反映中央银行实际所执行的货币政策及货币周期的变动。

除了按照央行的货币政策对利率和存款准备金率进行调整外，央行实际可以运用的货币政策手段还有公开市场操作、调整再贴现利率及窗口指导等，而这些手段最终可以反映货币供应量的变化。根据货币供应量的变化来判断货币政策周期，而M2正是广义的货币，反映了社会总需求的变化和未来通货膨胀压力。M2同比增速则可以反映流通中的货币供应量变化，即货币政策效果的实际反应。因此，可以用M2来判断货币政策或者货币供应处于扩张还是紧缩的周期。

由于月度M2的波动仍然比较剧烈，需要采用移动平均的方法进行平滑，结果如图2-4所示。

图2-4　国内经过移动平均平滑后的M2同比增速

数据来源：［卜永强　2012］

通过移动平均线平滑后的M2增速，将2007年6月至2011年12月划分成如表2-11所示的几个货币周期。

表2-11　中国货币周期分段（2007—2011年） 

数据来源：［卜永强　2012］

从货币周期来讲，货币周期的一个阶段持续时间最短为一个季度，最长达到了一年半左右，平均持续时间在12个月左右，比较适合作为中期战术性组合管理的依据。

4．行业分类：周期性VS非周期性行业

为了将行业划分为周期性行业和非周期性行业，这里选取沪深300行业指数，并且以沪深300指数作为市场组合，利用CAPM模型计算行业的Beta值和均值方差。

从Beta值来对行业的周期性和非周期性进行区分，周期性行业有能源、材料、工业、和金融；非周期性行业有可选、消费、信息、医药、电信和公用。

从表2-12中可以看出年均收益率最高的行业为医药，其次是金融和公用，收益率最低的行业是可选。

表2-12　沪深300行业指数统计 

数据来源：［卜永强　2012］

2.3.2　M2行业轮动策略

案例　M2行业轮动策略

针对上述对周期性和非周期行业的划分，构建周期性行业和非周期性行业的轮动策略。

数据与轮动策略的建立

（1）信息的同步性：考虑到M2的披露时间及信息的传导时间，所有投资时段都滞后了一个月的时间。

（2）组合的构建策略：在货币政策处于扩张时等权重配置周期性行业，紧缩时等权配置非周期性行业。

首先统计周期性行业和非周期性行业在货币政策处于扩张或者紧缩时期的不同表现，同时计算每个阶段要进行10个行业的等比例投资，具体情况如表2-13所示。

表2-13　不同货币阶段不同行业的收益率 

资料来源：［卜永强　2012］

通过对周期性行业和非周期性行业在不同阶段收益的比较，3个紧缩阶段非周期性行业组合全部战胜了周期性行业组合，胜率为100％。在3个扩张周期中，两次周期性行业战胜非周期性行业的表现，胜率为67％。在两次较大的下跌市场环境中，投资于非周期性行业均规避了较大的市场风险，其防御性特征可见一斑。而在牛市中，周期性行业和非周期性行业的投资收益相差较小。

按照顺周期策略（即策略1）构建投资组合并查看组合的收益及对应的逆向投资（扩张时投资非周期性行业，紧缩时投资周期性行业，初始资金一千万）。

如图2-5所示为周期性行业和非周期性行业按照顺周期策略进行轮动的资产损益变动图。在每个周期开始时都重新调整等比例投资，等权分配所投资行业的权重。

图2-5　顺周期行业轮动策略的收益率图示

资料来源：［卜永强　2012］

从2007年6月至2011年12月的策略收益来看，不考虑交易成本，顺周期行业轮动策略获得最高的累积收益（-19.65％）远胜于行业平均（-40.50％）和逆周期策略（-59.13％），逆周期策略表现最差。

此期间业绩基准为沪深300指数的收益为-37.57％，顺周期的行业轮动策略则战胜沪深300指数达到17.92％，年化超额收益超过3.6％。即便扣除2％的单次换仓成本，行业轮动策略同样远远战胜同期沪深300指数和行业平均投资策略的表现。

该策略具有如下优点：理念容易理解，且符合自上而下的投资理念，适合机构投资者进行行业配置；将行业划分为周期性和非周期性进行投资，这种分类标准与实际投资中对行业属性的认识也非常接近，减少了对行业基本面和公司信息的依赖；在紧缩时由于选择投资于非周期性行业能够避免较大的不确定性，使得整个组合的风险大大降低，抗风险能力得到增强；依据货币供应增速M2进行轮动，使得策略具有较强的可操作性。

从对货币周期的划分，再到按照货币周期的紧缩和扩张进行行业轮动策略的实证来看，货币供应量M2是宏观经济运行中的重要指标，也是货币政策效果的集中体现，用它来指导行业配置确实能够起到增强组合收益、降低组合风险的作用。

从上述实证研究可以看到，在行业配置过程中考虑到了行业周期性和非周期性因素的影响，实际上如同在组合配置过程中进行风格配置一样，是价值股还是成长股，抑或是大盘股和小盘股的风格轮动。

在投资中，风格选时对组合收益的贡献大约为50％，如果对周期性和非周期性行业做出正确的判断而进行适时轮动，则对组合收益的贡献将不低于风格选时，且持续性较强。从难易程度上讲，驱动风格轮动的因子变量仍不明确，一般采用宏观经济模型、基本面模型和风险模型进行综合建模；而周期性行业和非周期性行业基本可以确信为由宏观经济因子，特别是货币因素所驱动，因此，判断难度大大降低，增强了进行周期性和非周期性行业轮动的可操作性。

2.3.3　市场情绪轮动策略

轮动投资策略主要是通过对特定代理变量的观测适时投资强势投资品种，从而获取超额收益。轮动投资策略有主动轮动和被动轮动之分。对于行业轮动来说，主动轮动通过代理变量的预示作用选择未来表现强势的行业进行投资；被动轮动则在轮动趋势确立后进行相关行业的投资，代理变量主要用来刻画轮动趋势。

前一节的基于M2这一代理变量观测货币政策周期进行周期性行业和非周期性行业的轮动策略就属于主动轮动策略，本节探讨一种被动轮动策略：基于市场情绪的行业轮动。

市场情绪指标种类繁多，最常见的是市场技术指标。对于趋势型技术指标，虽然指标值完全基于历史市场信息，但在趋势性市场中这些指标也能刻画出市场趋势动量的强度。基于此，可以认为趋势性市场情绪指标对行业轮动具有一定的指导意义，有可能开发出实用的被动型行业轮动策略。

1．策略模型

基于市场情绪设计行业轮动投资策略主要考虑两点：一是哪些行业处于上扬趋势，即哪些行业从市场情绪来看变得可投资；二是这些可投资的行业中哪些行业更具备比较优势，即哪些行业具有比业绩基准更强的上扬趋势。

市场情绪的刻画手段有很多，例如，种种技术指标都是从某一角度来刻画市场情绪的，但必须选择交易信号指示明确的趋势性市场情绪指标。值得注意的是，一般市场情绪指标由于过度依赖历史信息而在遭遇行情剧烈波动时往往会发生误判，所以基于市场情绪的行业轮动策略中止损策略的考虑必不可少。

本案例主要设计了两种行业轮动策略，如图2-6所示，策略1主要利用市场情绪指标评估行业的绝对趋势强度和相对趋势强度；策略2主要利用市场情绪指标评估业绩基准趋势强度，然后在此基础上评估行业的相对趋势强度。这两个策略的投资标的为沪深300的十大行业。

图2-6　市场情绪行业轮动策略1和策略2

2．实证案例

案例　市场情绪轮动策略

案例中设计的行业轮动策略中，市场情绪指标采用最普遍的MACD市场指标进行刻画，MACD属于趋势类指标，在趋势型市场中比较有效，但在剧烈波动或盘整市场中效率比较低。在本案例的行业轮动策略中，MACD指标的短期均值取历史20周，长期均值取历史40周。

策略观测频率为周，因为周数据可以过滤大量的市场噪音而保留市场主要趋势。策略回溯期为2003年至2009年4月3日，时间跨度6年3个多月，共349周，沪深300指数同期收益率为129.45％。止损水平设定为5％，即当周亏损达到5％时，当期头寸完全退出。业绩基准采用沪深300指数在市场情绪MACD指示下择时投资的累积收益。可投资行业的权重配置策略为平均配置，即每周符合投资条件的行业以平均权重进行配置。

设计的两个市场情绪行业轮动策略的最终收益率如图2-7所示，策略1的收益率为1093.93％，策略2的收益率为965.26％，策略收益远远大于择时性质的业绩基准，当然也远远大于沪深300指数同期收益水平。

图2-7　市场情绪行业轮动收益率曲线

资料来源：［谢江　2010］

逐年来看，除2003年外，其余年份两个轮动策略均跑赢沪深300指数；除2003年、2008年外，其余年份两个轮动策略也均跑赢业绩基准。

策略成功的关键在于市场情绪指标的选取、指标计算参数的选择及适当止损。市场情绪指标必须选择交易信号指示明确的趋势性市场指标；情绪指标计算参数的选择决定了交易机会的触发和中止，主要决定策略的收益率水平；而止损水平则是一把双刃剑，在控制策略的系统性风险的同时有可能损失高波动中的收益机会。

情绪指标计算参数及止损水平的选择对策略收益影响较大，这些经验参数的设置可通过历史回溯获得。从提高策略稳健性的角度出发，可选择多组参数多策略地同时进行轮动投资。

本节小结

行业轮动的原理来自于宏观经济周期，在中国的宏观经济调控中，不同的行业会有不同的受益程度，从而形成了独特的行业轮动现象。本节讨论了行业轮动的基本思想和主要策略，介绍了两个行业轮动的策略。

从宏观经济运行出发，找到M2同比增速来作为测量货币政策环境的一个重要变量。在此基础上，构建了周期性行业和非周期性行业轮动策略，该策略的理念是：周期性行业具有较大的风险和较高的收益，因此在货币环境宽松、宏观经济繁荣时表现更好；而在货币环境处于紧缩时往往意味着经济下滑，而非周期性行业更具有防御性，投资效果会较好。通过实证研究发现，周期性行业能够在货币政策处于扩张阶段远远战胜非周期性行业；而紧缩时期即在市场下跌时，非周期性行业能够起到更好的防御优势。

第二个策略是基于市场情绪指标进行被动型行业和行业龙头股的轮动投资策略。策略的设计有两大要点：一是通过市场情绪择时选择强势行业；二是在此基础上进一步选择更具比较优势的行业进行最终投资。策略成功的关键在于市场情绪指标的选取、指标计算参数的选择及适当止损。市场情绪指标必须选择交易信号指示明确的趋势性市场指标；情绪指标计算参数的选择决定了交易机会的触发和中止，主要决定策略的收益率水平；而止损水平则是把一双刃剑，在控制策略的系统性风险的同时有可能损失高波动中的收益机会。

2.4　资金流

◆摘要◆

在市场中，经常存在交易性机会，这是指股价在短期内可能受到某些消息的影响，或者某些市场内在因素的改变从而产生剧烈波动带来的价差投资机会。其中，一个典型的交易性策略就是资金流模型，该模型使用资金流流向来判断股票在未来一段时间的涨跌情况，如果是资金流入的股票，则股价在未来一段时间将可能会上涨；如果是资金流出的股票，则股价在未来一段时间会可能下跌，那么，根据资金流向就可以构建相应的投资策略。

2.4.1　基本概念

1．MF指标

巴菲特曾经说过：“股市从短期看是投票机，从长期看一定是称重机。”有些投资者对股票基本面进行分析和预测来判断股票的长期价值，有些人则通过技术指标来进行短线投机交易。不管是长期还是短期，投资者必须通过投票机的方式来交易股票，而这种投票行为反映潜在的信息。股市高频数据行情准确地记录了交易者每天数以万亿计的投票数据，我们将这些涓涓细流的委托信息，按照驱动股票方向的委托流汇总成资金流净额，揭示了潜藏在股潮澎湃下的暗流，这些主导了大盘和个股的此起彼伏，就是我们下面要重点研究的资金流模型。

资金流是一种反映股票供求关系的指标。传统的量价无法区分市场微观结构中的流动性和私有信息对股价的影响，而根据委托测算的资金流，能够有效地观察微观市场交易者的真实意图及对股价造成的影响。

资金流定义如下：证券价格在约定的时间段中处于上升状态时产生的成交额是推动指数上涨的力量，这部分成交额被定义为资金流入；证券价格在约定的时间段中下跌时的成交额是推动指数下跌的力量，这部分成交额被定义为资金流出；若证券价格在约定的时间段前后没有发生变化，则这段时间中的成交额不计入资金流量。当天资金流入和流出的差额可以认为是该证券当天买卖两种力量相抵之后，推动价格变化的净作用量，被定义为当天资金净流量。数量化定义如下：

其中，Volume为成交量，Pi
为i时刻收盘价，Pi－1
为上一时刻收盘价。

从资金净流量的定义，可以发现以下问题：

（1）任何证券当日的买入金额总等于卖出金额，因此资金净流量并不表示当日真正新买进证券的资金量，而仅表示当日推升或压低股票价格的买卖力量对比。

（2）若股票在统计时段的首尾价格不发生变化，则不管该时间区段是否曾有过价格波动，区段内发生的所有交易金额将被简单忽略而并不计入资金流量。

（3）由于在计算资金流量时的成交金额为时间区段中的成交汇总，而判定是否变化的价格为时间区段末的瞬时成交价格，因此在时间区段中部存在异常数据扰动，有可能导致统计结果存在重大方向性差异。

（4）统计资金流量的时间区段越短，该指标受到区间内价格扰动的可能性越小。从理论上讲，若资金流量指标的实际使用意义很大，则该指标对高频数据有依赖性。

（5）高频成交数据对资金流量也是一把双刃剑，在超高频数据下资金流量的计算结果呈现显著的钝化，在较低频率下的统计规律可能将不再有效。这是由于当统计资金流量的时间区段由分钟级别提升至秒级时，两次间隔报价相等的情况大幅增加，当日大部分的成交金额可能被视为无方向资金流量而遭废弃。

（6）当资金发生净流入时，股价就会上涨，这是由资金流量的算法决定的，因此大部分时间资金流量仅是股价变化的同步指标。

（7）资金发生净流入与股价上涨尽管呈现极强的正相关性，但两者并不等价。资金净流入与股票交易量加权平均价格（VWAP）涨幅的相关性高于一般直观上看到的时间加权平均价格（TWAP）涨幅。

（8）当股票价格全天在小范围内振动时，资金净流入的计算结果可能失真。当股票成交量较低时，资金净流入占当日总成交金额的比例可能受到盘中异常单笔大单成交的影响。这类异常市况下获取的相应指标往往无法得到既定的统计规律。

（9）在计算资金净流入和横向比较时，不考虑盘口挂单数据、各股票价格高低及流通股本数量等重要参考数据。

2．资金流测算方法

严格意义上讲，每一个买单必须有一个相应的卖单，因此真实的资金流入无法准确计算，只能通过其他替代方法来区分资金的流入和流出，通过高频数据，将每笔交易按照驱动股价上涨和下跌的差异，确定为资金的流入或流出，最终汇聚成一天的资金流净额数据。测算资金流的方法很多，主要差别：一是在时间频率上；二是在参考价格上。

在测算资金流时间频率上的选择非常重要，目前有些采取日数据计算，即当日价格上涨全部计算为流入，否则计算为流出；而有些采取高频数据计算，如每笔数据或者1分钟数据等时间间隔，在选择时间频率上的差异会导致测算的资金流净额存在差异。

在参考价格上，有些采取前收盘价格，有些采取最近成交价或者前一个（或者后一个）报价，参考价的选择不同，也会导致差异较大。通常区分资金流入流出时，按照交易价格与之前的成交价比较，如果大于等于前成交价则为流入，小于等于前期成交价则为流出。当分时数据测算时，使用该方法较好，但是其损失部分相等价格的交易量。也有采取成交价与最近报价进行比较，如果成交价大于等于卖方最优价则为流入，如果成交价小于等于买方最优价则为流出。然而指令驱动市场，报价是实时匹配的，有可能买卖价格同时到达而配对成功，尤其在A股市场报价不是实时广播的，而是间隔3～5s产生成交均价和报单行情，这样就会导致采取该策略，许多成交价位于最优买卖报单之间的交易量未被统计进来。

3．招商资金流指标（CMSMF）

招商证券的研究员开发了CMSMF指标，采用高频数据进行资金流测算，主要出于以下两方面考虑：一是采用高频数据进行测算，可以尽可能反映真实的市场信息；二是采取报价（最近买价、卖价）作为比较基准，成交价大于等于上期最优卖价视为流入，成交价小于等于上期最优买价视为流出。具体计算方法如表2-14所示。

表2-14　招商资金流模型（CMSMF）计算方法 

资料来源：［罗业华　2011］

除此之外，为了得到更多资金流的信息，衍生了资金流信息含量、资金流强度、资金杠杆倍数等更多指标，定义如表2-15所示。

表2-15　招商资金流模型（CMSMF）选股指标定义 

资料来源：［罗业华　2011］

2.4.2　策略模型

1．逆向选择理论

在非强势有效的A股市场，普遍存在信息不对称的问题。机构投资者与散户投资者在对同一信息的评估能力上存在差异。在大部分情况下，散户投资者缺乏专业的投资能力和精力，那么根据“搭便车”理论，希望借助机构投资者对股价的判断进行投资，一旦机构投资者率先对潜在市场信息做出反应，羊群效应的散户投资者则追涨杀跌，往往导致在很多情况下市场对潜在信息反应过度。这样根据逆向选择理论，能够准确评估信息价值的投资者便会对反应过度的股价做出交易，买入低估的、卖出高估的股票，从而纠正这种信息反应过度行为。

根据市场对潜在信息反应过度的结论及市场投资者的行为特征，可以采取逆向选择模型理论来构建选股模型，即卖出前期资金流入、价格上涨的股票，买入前期资金流出、价格下跌的股票。按照这个思路，对一些指标参数进行回测分析，可以得到稳定的选股模型。

2．策略模型

根据资金流各种指标的特点，在选股模型中采用比较简单的方法，即以指标排序打分的方式来筛选股票。首先通过对各个资金流指标进行排序打分，然后将股票对各个指标的得分进行求和，最后以总得分值大小来筛选股票，具体步骤如下：

（1）确定待选股票池。在选择组合构建时，剔除上市不满一个月的股票，剔除调仓期涨跌停及停牌的股票，防止因涨／跌停无法交易。剔除信息含量小于10％的股票，因为这部分股票信号不明显，无法取得有效信息。

（2）构建股票组合。

①指标打分：首先将待选股票池中的股票按照各个指标进行排序（指标即为前面介绍的GSMS和CMSMF系列指标），然后采用百分制整数打分法进行指标打分，即以股票在各个指标中所处位置的百分数作为股票对于该指标的得分，前1％得分为1，依次递减，最后1％得分为100。

②求和排序：将股票相对于各个指标的得分进行求和，将和值从小到大排序，进行分组比较；另外，选择排名靠前的N只股票构建组合。

③股票权重：采用等量权重。

（3）组合定期调整，调整时间从1到3个月不等。持有到期后，利用更新后的指标数据重新确定待选股票池，重复步骤（2）打分求和过程，并将股票按照指标得分从小到达排序，将原来分组中跌出组合的股票剔除，调进新的股票，同时将新组合内样本股的权重调整到相等。

（4）统计检验。分别计算各组合的收益率情况，考察组合的效果。

2.4.3　实证案例：资金流选股策略

本案例的结果来自于D-Alpha量化对冲交易系统的后验平台‘模拟交易所’，主要数据情况如下：

（1）后验开始时间：2007-2-1，后验结束时间：2011-2-18。

（2）股票池范围：沪深300成分股；全市场。

（3）资金规模：现货1亿，3亿，10亿；期货∶现货＝1∶1。

（4）撮合规则：高频数据撮合，与交易所类似。

1．案例结果1：沪深300

该结果的股票池来自于沪深300成分股，结果如表2-16所示。

表2-16　资金流模型策略—沪深300 

数据来源：D-Alpha量化对冲交易系统

从表2-16中可以看出，在资金为3亿、调仓期限为3个月时效果最好，这是因为资金量比较大的时候，对市场的冲击比较大，从而吞噬了部分收益率，收益率曲线如图2-8所示。

图2-8　资金流模型策略收益率曲线（沪深300-3亿-3个月）

数据来源：D-Alpha量化对冲交易系统

2．案例结果2：全市场

该策略结果的股票池来自于全市场，结果如表2-17所示。

表2-17　资金流模型策略——全市场 

数据来源：D-Alpha量化对冲交易系统

从表2-17中可以看出，在资金为3亿、调仓期限为1个月时效果最好，这可能是因为全市场中选择的股票大多数为小盘股，其波动性比较大，适合做一些短期的波段交易，收益率曲线如图2-9所示。

图2-9　资金流模型策略收益率曲线（全市场-3亿-1个月）

数据来源：D-Alpha量化对冲交易系统

本节小结

资金流模型是非常易于理解的一个选股方式，但是传统的资金流模型效果并不明显，这可能是因为市场的有效性越来越强。招商证券在研究员的基于高频数据的基础上，开发了加强版的资金流模型CMSMF，取得了较好的效果。D-Alpha对冲交易系统的高频数据后验平台对资金流模型进行了测试，结果证明该指标具有良好的收益。

2.5　动量反转

◆摘要◆

动量与反转效应是市场上经常出现的一种情况。所谓动量效应就是在前一段时间强势的股票，在未来一段时间继续保持强势；反转效应就是前一段时间弱的股票，未来一段时间会变强。但问题的关键是这个强势和弱势会保持多长时间和多大幅度，这是动量、反转策略需要考虑的关键问题。

动量策略就是寻找前期强势的股票，判断它将继续强势后买入持有；反转策略就是寻找前期弱势的股票，判断它将出现逆转后买入持有。

2.5.1　基本概念

2002年年度诺贝尔经济学奖授予了美国普林斯顿大学的行为金融学家丹尼尔·卡恩曼和美国乔治梅森大学的维农·史密斯，以表彰他们在结合经济学和心理学理论来研究人们的决策行为方面所做出的贡献。从此行为金融学正式登堂入室，近年来发展迅猛，并大有与现代金融理论并驾齐驱之势，行为金融理论也成为当代金融学研究的热点和前沿。认识行为金融学，并利用行为金融学的研究成果指导我们的投资，有较强的理论和现实意义。

1965年，法玛提出了经典的有效市场假说（EMH），夏普、林特纳和莫辛将EMH和马科维茨的资产组合理论结合起来，建立了一个以一般均衡框架中的理性预期为基础的投资者行为模型——资本资产定价模型（CAPM）。CAPM和EMH成为现代金融学的两大基石。

但随着市场的发展也出现了一系列无法用传统金融理论解释的现象，如羊群效应、小公司和规模效应、股权溢价之谜等，给现代金融理论构成了强有力的挑战，行为金融学也随之产生。

现代金融理论和EMH是建立在有效市场竞争的基础上的，能够在市场竞争中幸存下来的只有理性投资者。而相关研究表明，在某些情况下，非理性投资者实际上可以获得比理性交易者更高的收益，非理性投资者仍然可以影响资产价格。

市场上的许多行为从传统的金融学理论上往往无法解释，因为传统金融学严格的假设条件影响了其在实践中的运用，而行为金融学更加接近市场，一些研究结论对证券市场投资也有较大的启发和指导意义。从我国的实践角度来看，行为金融依然具有较强的指导意义，并对证券投资有较大帮助。

1．行为金融学

1）羊群效应

羊群效应是指投资者在交易过程中观察并模仿他人的交易行为，从而导致一段时间内买卖相似的股票。在信息高度不对称的市场环境下，投资者无法直接获得别人的私有信息，却可以通过观察机构投资者的买卖行为来推断其私有信息，此时容易产生个人投资者和机构投资者的羊群行为，出现群体压力等情绪下的非理性行为。

长期以来，我国证券市场上存在较为典型的羊群效应，庄家行为、股评效应等极为显著，寻找庄家建仓等待拉升一度成为市场追捧的投资策略。随着庄股的破灭及价值投资理念的崛起，基金等机构投资者的行为也成为信息弱势群体研究的重点。因此，在借鉴他人优势的同时，投资者也应防止陷入新的羊群效应；在追随潮流的同时，也应保持独立的判断能力。

2）小公司效应

小公司效应是指小盘股比大盘股的收益率高。1981年，Banz发现了股票市值随着公司规模的增大而减少的趋势。随后，Reimganum也发现了公司规模最小的普通股票的平均收益率要比根据CAPM模型预测的理论收益率高，且小公司效应大部分集中在1月份。由于公司的规模和1月份的到来都是市场已知信息，这一现象明显地违反了有效市场假设。

我国证券市场上也一度存在小公司效应。例如，小盘股、小市值的公司往往成为炒作的重点；一些庄家借助于送股、转赠等题材不断炒作，一些公司的股价出现了非理性上扬。小公司效应产生的根源在于其投资价值，处于成长期的小公司往往比成熟的大公司有更高的成长性。

3）反应过度与反应不足

反应过度和反应不足是投资者对信息反应的两种情况。人们进行投资决策时存在两种错误范式：其一是选择性偏差，即投资者过分重视近期数据的变化模式，而对产生这些数据的总体特征重视不够，这种偏差导致股价对收益变化的反应不足；另一种是保守性偏差，投资者不能及时根据已变化的情况修正自己的预测模型，导致股价过度反应。

在证券市场上的表现就是涨过头和跌过头。在我国证券市场上，反应过度与反应不足现象较为突出，如2000年网络股泡沫出现的反应过度，投资者热情的膨胀将股价不断推高。而在市场的下跌趋势中也会对利好表现麻木，市场弥漫悲观氛围时也会对具有投资价值的公司视而不见，市场既有出现非理性上涨的冲动，也会造成非理性的恐慌性抛售。

4）动量效应与反转效应

所谓动量效应是指早期收益率较高的股票在接下来的表现仍会超过早期收益率低的股票；而反转效应就是买进过去表现差的股票而卖出过去表现好的股票来进行套利的投资方法。

1993年，美国学者Je-gadeeshkg与Titman在对资产股票组合的中间收益进行研究时发现，以3～12个月为间隔所构造的股票组合的中间收益呈连续性，即中间价格具有向某一方向连续的动量效应。一些研究显示，如选择低市盈率（PE）的股票，选择股票市值与账面价值比值低、历史收益率低的股票，往往可以得到比预期收益率高很多的收益，而且这种收益是一种长期异常收益。

而在我国市场上，热点的切换及投资者的偏好会经常发生转变，这也使得动量效应和反转效应在一段时间内反复出现。

2．阿尔法动量模型

1）阿尔法动量

一只股票未来回报的预期可以拆成Alpha、Beta及残差3个部分，用公式描述为：

rp
＝α＋βm
＋ε

式中第二项是股票随着市场总体涨落带来的市场回报，最后一项代表的是无法提前预知的股票相对于市场回报的差异。而式中第一项Alpha同样也是偏离市场的回报，但是它与残差不同，Alpha代表了提前预知的偏离。

从量化投资的角度来说，积极型股票投资者的目标可以理解为寻找正的Alpha动量，这个过程通常是通过基本面分析来完成的。而动量模型的目标是通过数量方法寻找到股票持续的正的Alpha。量化投资方法可以观测到通常投资者不容易观测到的股票细微变化，同时也可以观察更多的股票，快速建立投资股票池，帮助投资者选择股票。另一方面，当股指期货推出以后，投资者也可以找出有Alpha的股票进行套利。股指期货非常接近于市场的回报，可以用来消除股票中的Beta，使投资者获得纯粹的Alpha，从而不用在意市场的涨跌而得到绝对回报。

2）阿尔法能持续吗

在正常情况下，股票的Alpha不会长期持续不为0。这是因为一只股票如果估值有偏差，那么在被人发现以后，Alpha就会迅速归零。股票一般不会总是被低估或者高估，它的Alpha有时表现为正，有时表现为负，这也是为什么使用常规的方法在市场中通常难以发现股票具有明显持续的Alpha的原因。

尽管长期而言每只股票的Alpha都应该为0，但是市场中存在部分股票的Alph在一段时间内可能持续大于0或者小于0。股票的Alpha会持续主要有以下两个原因：

（1）如果股价向股票的价值收敛的速度比较慢，知情投资者就更容易从中获利，所以这些交易者会倾向于更缓慢地把价格推向股票的实际价值。

（2）中国股票市场存在一种股票轮动现象，一个行业或部分股票常常会在一段时期内保持强于或弱于市场总体水平。

因此，动量策略的目标是从股票市场上千只股票的大海中筛选出这样的股票，即当它出现正（负）的阿尔法时，之后的阿尔法也会为正（负）。找到以后，便可以使用对应的策略进行投资，因此这种筛选股票的策略称为阿尔法动量策略。

3）阿尔法动量模型

假设股票的阿尔法是一个随机过程。出于简化的目的，假设阿尔法是最简单的AR（1）过程。股票的收益率就能表示为下面的形式：

rpt
＝αt
＋βrmt
＋εt

αt
＝δ
αt－1
＋Vt

在这个模型中，当δ小于0时，αt
会出现反转，这种情况意味着这只股票存在过度反应的现象。当δ介于0到1之间时，随着时间的变化αt
总会向0靠近，决定其减为0速度的关键是δ的大小。一只股票的δ越大，代表它的αt
向0回归的速度越慢。换句话说，如果我们能找到一些股票δ与现在的αt
都比较大，那么这只股票在接下来的时间内αt
大于0的可能性也比较大。

可以使用马尔科夫链蒙特卡罗方法估计该模型的参数，使用模拟结果的均值作为各个参数的估计值。

2.5.2　策略模型

虽然以往的实证研究在不同的市场发现存在动量及反转效应，但从实践的角度来看，要将动量效应及反转效应在A股市场投资实践中应用，有必要对A股市场的动量及反转效应进行测试。

这里选择2000年1月1日至2009年6月1日所有A股股票的复权价格数据作为基础数据。为了避免生存者偏差的影响，对基础数据进行了重构，加回了目前已经退市或者被并购的股票的历史价格数据，以求尽可能还原测试时点的真实情况。

1．动量效应测试

对动量效应进行测试时，分别以P（P＝1，2，…，24）个月为形成期，以Q（Q＝1，2，…，12）个月为持有期，验证P个月内累计收益率最高的一组股票，在接下来Q个月内的表现（下文中将形成期为P、持有期为Q的动量组合记为（P，Q）动量组合）。

由于A股市场目前仍为单边市，不能卖空，这里仅对买入方向进行单边测试。为了增加样本容量及规避时点选择对测试结果的影响，对测试样本进行逐月滚动，即在每个月均对上述所有的（P，Q）动量组合是否存在动量效应进行一次测试。

为了使所有的（P，Q）动量组合具有相同的测试样本数量，分别选择2002年1月至2008年6月的每个月第一个交易日作为组合构建时点，因此对应于每一对（P，Q）动量组合的测试样本共有78个。在每一个测试时点对于每一对（P，Q）动量组合均按下列流程进行测试：

（1）确定待选股票池。选择组合构建时点全部A股股票，剔除连续停牌股票及形成期初未上市的股票后，剩下的股票进入待选股票池。

（2）构建初始股票组合。将待选股票池中的股票分别按照测试时点前P个月的累计收益率从大到小排序，选取排名前1/5的股票等权重构建动量组合，并以待选股票池中全部股票等权重构建基准组合。

（3）收益率计算。持有组合至Q个月后的第一个交易日，计算动量组合及基准组合在Q个月内的累计收益率，分别作为（P，Q）动量组合及基准组合对应于这一测试时点的收益率，以（P，Q）动量组合收益率与基准组合的收益率的差作为（P，Q）动量组合这一样本的超额收益。

在所有的测试时点均测试完成后，分别计算每一对（P，Q）动量组合的所有样本的平均超额收益，作为（P，Q）动量组合的超额收益；同时，计算在所有样本中，超额收益率为正值的样本所占的比例作为（P，Q）动量组合战胜基准的频率。具体测试结果如表2-18所示。

表2-18　动量组合相对基准的平均年化超额收益（部分） 

资料来源：［杨向阳　2009］

从超额收益角度来看，形成期P为4～9个月、持有期Q为6～10个月的动量组合可以取得较高的超额收益（年化后2.5％以上），当形成期或者持有期过短时，动量组合均没有超额收益。

从战胜基准的频率角度来看（出于篇幅原因，数据没有在这里列出），共有8对不同（P，Q）动量组合战胜基准的频率在70％以上，这8对组合的形成期P集中在6～8个月间，持有期Q则集中在9～10个月间。

综合超额收益和战胜基准频率两方面因素可以看出，形成期P为6个月、持有期Q为9个月的组合从整个样本来看效果最佳。

2．反转效应测试

与动量效应的测试相似，在对反转效应进行测试时，分别以P（P＝1，2，…，24）个月为形成期，以Q（Q＝1，2，…，12）个月为持有期，验证P个月内累计收益率最低的一组股票在接下来Q个月内的表现（下文中将形成期为P、持有期为Q的反转组合记为（P，Q）反转组合）。

由于A股市场目前仍为单边市，不能卖空，这里仅对买入方向进行单边测试。为了增加样本容量及规避时点选择对测试结果的影响，对测试样本进行逐月滚动，即在每个月均对上述所有的（P，Q）反转组合是否存在反转效应进行一次测试。

为了使所有的（P，Q）反转组合具有相同的测试样本数量，分别选择2002年1月至2008年6月的每个月第一个交易日作为组合构建时点，因此对应于每一（P，Q）反转组合的测试样本共有78个。在每一个测试时点对于每一对（P，Q）反转组合均按下列流程进行测试：

（1）确定待选股票池。选择组合构建时点全部A股股票，剔除连续停牌股票及形成期初未上市的股票后，剩下的股票进入待选股票池。

（2）构建股票组合。将待选股票池中的股票分别按照测试时点前P个月的累计收益率从小到大排序，选取排名前1/5的股票等权重构建反转组合，并以待选股票池中全部股票等权重构建基准组合。

（3）收益率计算。持有组合至Q个月后的第一个交易日，计算反转组合及基准组合在Q个月内的累计收益率，分别作为（P，Q）反转组合及基准组合对应于这一测试时点的收益率，以反转组合收益与基准组合的收益率的差作为（P，Q）反转组合这一样本的超额收益。

在所有的测试时点均测试完成后，分别计算每一对（P，Q）反转组合的所有样本的平均超额收益，作为（P，Q）反转组合的超额收益；同时，计算在所有样本中超额收益为正值的样本所占的比例，作为（P，Q）反转组合战胜基准的频率。具体测试结果如表2-19所示。

表2-19　反转组合相对基准的平均年化超额收益（部分） 

资料来源：［杨向阳　2009］

从超额收益角度来看，形成期P为1或2个月、持有期Q为1个月时，反转组合可以取得较高的超额收益（年化后9％以上），当形成期P或者持有期Q过长时，反转组合超额收益显著变小或者没有超额收益。

从战胜基准的频率角度来看，测试结果显示（出于篇幅原因，这里没有列出数据）共有3对不同形成期P和持有期Q的组合战胜基准的频率在60％以上，这3对组合均是短期组合，分别为（1，1）反转组合、（2，1）反转组合及（1，2）反转组合。

综合超额收益和战胜基准频率两方面因素可以看出，形成期P为2个月、持有期Q为1个月的反转组合从整个样本来看效果最佳。

2.5.3　实证案例：动量选股策略和反转选股策略

前面的测试结果表明A股市场存在短期的反转效应及中长期的动量效应。但前面的测试并没有考虑交易费用及组合的再平衡问题，当实际中存在这些问题时，这两种策略是否还能有效，值得怀疑。因此，本节对这两种策略进行了历史回测实证。

由于待选股票池前20％包含的股票数量太多，所以在回测时选择股票数量为待选股票池的10％。在构建投资组合时，为了测算简便，仅考虑了单边0.25％的固定交易成本。

1．动量策略

案例　动量选股策略

初始投资组合的构建：以2006年9月7日为初始投资组合构建日，选择待选股票池中2006年9月7日至2011年12月5日间累计涨幅最大的前10％股票，等权重配置作为初始投资组合。

组合的再平衡：持有投资组合15天，以到期后的第一个交易日为再平衡日，将投资组合中的股票调整为再平衡日前15天内累计涨幅最大的前10％的股票，同时将新投资组合内样本股的权重调整至相等。重复上述过程，直至2011年12月5日。收益率曲线如图2-10所示。

图2-10　动量策略组合走势

资料来源：D-Alpha量化对冲交易系统

考虑交易成本以后，在长达5年多的回测过程中，动量策略取得了258％的累计收益，远高于同期沪深300指数取得的89％的累计收益。回测期内的这一动量策略的年化复合增长率为26.07％，同期沪深300指数的年化复合增长率为12.35％。

在回测过程中，动量策略持有股票数量大约为30只。

从不同的市场阶段来看，动量策略在熊市阶段表现出色。在熊市阶段，动量策略相对于沪深300平均每个月可以取得1.18％左右的超额收益，战胜基准的频率在67％以上，但是这一策略在牛市和震荡市中并不能显著战胜基准。动量策略风险收益率分析如表2-20所示。

表2-20　动量策略风险收益率分析 

资料来源：D-Alpha量化对冲交易系统

2．反转策略

案例　反转选股策略

初始投资组合的构建：以2006年3月8日为初始投资组合构建日，选择待选股票池中2006年3月8日前22个交易日内累计涨幅最小的前30只股票进行等权重配置作为初始投资组合。

组合的再平衡：持有投资组合22个交易日，以到期后当月的第一个交易日为再平衡日，将投资组合中的股票调整为再平衡日前22个交易日内累计涨幅最大的前30只股票，同时将新投资组合内样本股的权重调整至相等。重复上述过程，直至2011年12月13日。

考虑双边3‰交易成本以后，在长达5年多的回测过程中，（2，1）反转策略取得了356.16％的累计收益，远高于同期沪深300指数取得的139.96％的累计收益。回测期内的这一反转策略的年化复合增长率为31.77％，年化波动率为1.17％；同期上涨指数的年化复合增长率为17.25％，年化波动率为1.04％。

在回测过程中，（2，1）反转策略持有股票数量大约为30只，每22天换手一次。由于换手率较高，这一策略交易成本对收益的影响很大，平均到每个月大约为30bps。

从不同的市场阶段来看，反转策略在牛市阶段表现出色。牛市阶段反转策略相对于沪深300平均每个月可以取得接近于1.32％的超额收益，战胜指数的频率接近于64％。而在震荡市和熊市阶段，反转策略基本上不能战胜指数。反转策略风险收益率分析如表2-21所示，走势图如图2-11所示。

表2-21　反转策略风险收益率分析 

资料来源：D-Alpha量化对冲交易系统

图2-11　反转策略组合走势

资料来源：D-Alpha量化对冲交易系统

本节小结

根据实证结果，A股市场确实存在动量及反转效应：

（1）A股市场存在动量效应及反转效应，其中形成期为6个月、持有期为9个月的动量组合，以及形成期为1个月、持有期为1个月的反转组合，表现较为出色。

（2）回测期内的这一动量策略的年化复合增长率为26.07％，同期沪深300指数的年化复合增长率为12.35％。

（3）回测期内的这一反转策略的年化复合增长率为31.77％，年化波动率为1.17％；同期上涨指数的年化复合增长率为17.25％，年化波动率为1.04％。

2.6　一致预期

◆摘要◆

一致预期是指市场上对某股票有一致看法，看多或者看空，在众多分析师一致预期下，投资者会产生羊群效应，大量买入或者大量卖出，从而使得某股票持续上涨或者持续下跌，这就是一致预期选股的基本原理。

一致预期选股策略采用分析师的评级数据来构建相应的组合，试图找出最适合的一致预期参数。

2.6.1　基本概念

股票的长期收益并不仅仅依赖于实际的利润增长情况，还取决于实际的利润增长与投资者预期的利润增长之间的差异。持续的成长性可以消弭估值的泡沫，只有超预期的成长性才能带来价值重估的机会，从而才可能获得更高的估值水平，因此带来更多的投资收益。

从历史经验来看，市场热衷于追捧一致预期看好的股票，而摒弃预期不好的股票；同时，市场也会迎合那些未来有高成长预期的股票，并因此提升个股或行业的估值水平。也就是说，市场预期本身很重要，因此我们可以利用市场的一致预期数据去挖掘投资的机会。

这里采用朝阳永续的一致预期数据来分析市场的反应。该数据主要指基于各券商分析师调查的上市公司盈利预期数据平均值，该指标的核心目标是力图权威地反映市场对公司未来盈利的预期水平。在海外，它是投资者在上市公司年报发布前后的重要投资参考依据。

采用沪深300的样本股票做分析，来看一看一致预期数据在投资组合方面的效果。由于数据区间的限制，仅仅考虑其提供的2006年度的一致预期EPS数据，以此作为参考，分析结果如图2-12所示。

图2-12　2006年预期EPS相对于2005年实际EPS的增速

资料来源：［谢江　2008］

1．超预期带来的超额回报

从2006年的一致预期EPS与实际EPS的对比来看，实际EPS大于一致预期EPS（即“超预期”）的股票在年报后1～6个月区间的平均收益好于低于预期（即实际EPS小于一致预期EPS）的股票的表现。

更为细致的观察，可以看到：超预期100％以上的股票在年报后2～6个月的平均收益远远高于超预期低于50％及低于预期的股票的同期平均收益，超预期越多的股票在年报后的走势越好（平均收益）。

2．一致预期代表市场的情绪

从历史来看（业绩公告前一年的股票走势），年报后业绩超预期的股票在过去一年的平均收益水平低于那些低于预期的股票同期的表现，也就是说由于预期与实际情况的不同，超预期股票和低于预期的股票在年报公布前后的表现正好相反。

而从预期增长和预期减速来看，预期增长的股票在一年内的平均涨幅要高于预期减速的股票同期的表现。因此在市场一致预期偏于乐观的情绪下，股票走势也反映出这种情绪；反之，悲观的预期即带来较低的收益。

可以看到，年报后1～3个月，本来预期增长的股票在年报出来后的平均表现不如预期减速的股票同期的表现；年报后半年的表现，才可以看到预期增长的股票的表现好于预期减速的股票的表现。

3．理想与现实

对于一致预期增长（即2006年一致预期EPS高于2005年实际EPS）的股票，可以发现如果实际增长速度（即2006年实际EPS相对于2005年实际EPS的增长速度）加快的话，亦即超于一致预期，那么这些股票在年报后1～6个月有良好的表现。另外，对于那些一致预期增长的股票，发现如果实际增长速度放缓，即低于一致预期增长速度，那么这些股票在年报后1～6个月的表现欠佳；前者好于后者同期的表现，分析结果如图2-13所示。

图2-13　2006年EPS预期增长程度和收益率的关系

资料来源：［谢江　2008］

这充分证明了一个道理，即分析师的判断是有价值的，虽然这个价值不会在发布研究报告的当期立刻体现出来，但是在经过一段时间后，他们的研究会逐步影响市场，从而推动相应的投资组合在未来一段时间的良好表现。这个中间的时间差可能与投资者的决策流程有关，因为大型机构投资者从收到研究报告到转换成相应的市场行为，需要一个较长的时间。

对于那些一致预期减速（即2006年一致预期EPS低于2005年实际EPS）的股票，可以发现，2006年度实际EPS为增长的及实际EPS减速放缓的股票在年报后1～2个月的表现要好于实际减速加快的股票同期的表现。

因此可以得出结论，成长性是产生投资回报的源泉，而市场的情绪也是推动市场前进的不可或缺的力量。市场的一致预期本身就代表着市场对未来的一种看法、一种判断、一种情绪，能够持续成长的股票可以给投资者带来投资回报，但只有能够带来惊喜（超预期）的股票才能持续地给投资收益增添光彩。

2.6.2　策略模型

国外很多数量化投资研究机构都会采用一致预期数据构造选股的模型，以充分把握市场的看法和市场的情绪，从而至少获取可观的阶段性收益。

其中比较有名的是Columbine Capital的预期选股模型（Expectational Model，EM），从该模型的历史表现来看，过去10年此模型选股组合的年超额回报率达到4％。

1．传统EM模型

Columbine Capital的预期选股模型主要利用一致预期数据构造五大指标，即分析师预期的一致性指标、分析师调整预期的信心指标、分析师调整预期的幅度指标、超预期水平及预估的期望回报率等。

EM模型首先按照各个指标对个股进行打分评级，然后通过最优梯度选股策略来决定各个指标间的关系，从而得到最后的评级，以此做出买入或卖出的指令。这5类指标综合性地考虑到市场一致预期的方方面面，从预期一致性的衡量到分析师的信心，从调整幅度到超预期的水平，这些指标都能够充分地衡量市场的看法，把握市场的情绪。对未来预期收益的估计，也反映在模型之中，以此反映市场给予个股估值水平的高低。另外，预期增速处于中等水平的股票在年报后的表现更好、更稳定。

2．修正EM模型

在修正EM模型的建模过程中，将采用综合评估法和多因子模型来替代。在指标选取方面，主要借鉴Columbine Capital预期选股模型（EM）的指标设计体系。然而，国内的一致预期在指标数据的采集上，很难获得一致预期方面更为详细的数据，因此只能设计替代的指标体系。

该修正模型仍然采用朝阳永续所提供的一致预期EPS数据（按照朝阳永续的一致预期算法，对机构影响力和时间影响力进行双重加权），并做进一步的加工、整理和分析。朝阳永续一致预期数据所构造的一系列指标的计算方法和含义如下。

（1）EG：一致预期EPS的增长速度（EPS Growth）。每个月度，提取市场对下一年度的EPS预期的增长数据。EG指标反映市场中卖方分析师对个股下一年度EPS的增长预期，预期越高自然理应获得更好的回报。EG越大，分析师越看好个股的未来成长速度。

（2）RC：卖方分析师在调整预期EPS时的信心（Revision Confidence）。每个月可以看到分析师对下一年度EPS预期的调整状况。设定EPSa为分析师当月对下一年度EPS的预期值，EPSb为分析师上一个月对下一年度EPS的预期值。RC采用以下计算公式：

RC＝（EPSa-EPSb）/上月收盘价

可以看到随着时间的变化，分析师依据当前的股价基础也对未来的预期EPS做出适当的调整，这也反映出分析师对未来EPS预期调整的信心水平。RC越大，说明分析师有可能非常有信心认可个股未来的每股收益水平；反之则信心欠佳。

（3）RA：分析师对个股未来EPS水平的乐观态度。用分析师对下一年度一致预期EPS高过历史上平均EPS的水平来表示。对于未来预期EPS高过历史平均EPS（采用前两年的EPS平均值）的那些股票，分析师对其未来成长持乐观态度；对于未来预期EPS低于历史平均EPS（采用前两年的EPS平均值）的股票，分析师则持悲观态度，即不看好其未来的成长水平。

（4）AN：关注个股的分析师数量。采用log（1＋分析师数量）来给出AN的值。对个股关注的分析师数量越多，那么市场对它的了解程度也越深，市场对它的追捧程度也可能更大。如果分析师的数量越多，那么反映市场的情绪可能更加合理和准确。而关注的分析师数量越少，那么一致预期的数据可信度可能会低一些，当然并不是说这些股票质地不好。仅从分析师数量的多少不可能辨别股票的优劣，但是可以反映出市场追捧的情绪。

（5）ANV：关注个股的分析师数量的变动率。用当月AN值减去上月AN值来表示。若ANV为正，则表示关注这只股票的分析师数量在增加；ANV越大，分析师数量增加得越多，关注度可能越大。若ANV为负，则表示关注这只股票的分析师数量在减少，关注度可能在减弱。

（6）EY：预估的EPS回报率。用当月分析师对下一年度EPS的一致预期值与上月收盘价的比值来计算EY值。这个比率是市场分析师对当前股价水平所能获得未来EPS水平的看法。EY越大，表示分析师更加看好未来的回报率；EY越小，表示分析师可能不太看好这只股票未来EPS的回报率水平。从EY角度来看，可以评价预期未来的EPS水平是否能支撑现在的股价水平。在这里，EY的倒数就是未来预期的市盈率水平。

这六大类指标主要是试图量化地刻画市场卖方分析师对未来预期的一致性看法和情绪，也就是采用量化的指标来衡量分析师在调整未来一致预期数据时的信心、态度、人气度等，这些可以通过观察分析师调高或调低一致预期EPS的幅度大小、预期未来市盈率的倍数等来得到结论。

选股的时候则根据EG、RC、RA、AN、ANV、EY这六大指标进行EM预期选股模型的构造。一种方法是采用综合评估的办法，即分别按照各个指标对个股进行打分，然后给予每个指标一定的权重，进行加和得到个股最终的总分评级排序。另一种方法就是采用多因素模型，考察六大指标与个股未来收益之间的关系，同时以下一期六大指标水平预测个股未来一期的收益率水平，以此对各只股票进行排序。

2.6.3　实证案例：一致预期模型案例

本案例采用以上介绍的EM预期选股模型进行历史的测试，试图找出对收益率最有效果的指标和参数。

1．模型构建

1）数据

（1）一致预期EPS。一致预期EPS的数据来自朝阳永续，每个月采集一次分析师对个股的下一年度一致预期EPS相关的数据及当月股票收盘价格、涨跌幅度等数据。因此，这里的一致预期数据分别是指分析师对2007年度至2012年度EPS的预期。

（2）考察区间。由于朝阳永续提供的一致预期数据最早从2006年开始，所以考察区间也选择这个时间点作为起点，至2011年12月份，以年度作为考察区间，共有6个考察区间。

①第一个考察区间：2006年1月至2006年12月（每个月调整一次股票组合，一致预期数据为2006年度预期EPS）。

②第二个考察区间：2007年1月至2007年12月（每个月调整一次股票组合，一致预期数据为2007年度预期EPS）。

③其余考察区间依此类推。

最后推荐的股票数据采用2011年度一致预期EPS数据。

（3）业绩基准。采用市场上具有代表性的上证综合指数和沪深300指数作为基准。

2）备选股票池

采用初步筛选的方式构造备选股票池。每一年度（5月份左右），根据上市公司前3年的ROE水平均不低于8％这一条件筛选出备选股票池，然后采用EM预期选股模型进行进一步的精选。分别利用2005年、2006年、2007年（包括）这3年的ROE水平来进行初步筛选。

3）指标设置

主要采用EG、RC、RA、AN、ANV、EY六大指标进行EM预期选股模型的构造。在考察区间，每个月采用模型对股票进行排序，然后对前1/5和后1/5的股票均持有一个月。不考虑交易费用（仅供模型测试）。

4）投资组合配置

分别考察根据EM预期选股模型排序的前1/5和后1/5的股票，并采用等比例配置

2．实证效果

1）单个指标的效果

首先观察各个指标筛选股票的效果。在这里，分别采用各个指标从备选股票池中筛选股票和排序，并因此选取排名最前的1/5的股票构成Top组合（等比例配置），选取排名最后的1/5的股票构成Bottom组合（等比例配置）。每月换仓一次，不考虑交易费用。收益率曲线如图2-14所示。

图2-14　不同一致预期指标的收益率曲线

数据来源：［卜永强　2012］

从2007—2011年度的表现来看，多数指标所筛选出的Top组合能够战胜业绩基准（上证指数和沪深300指数）的表现。其中，采用EY指标筛选的Top组合表现最为突出；采用其他指标筛选的Top组合在前期的表现也基本上可以与基准持平，后期有较好的表现。从图2-14中可以看到，各个指标在2009年的筛选效果很显著，其中表现最好的仍然是EY指标。

2）EM模型效果

下面阐述了采用综合评估法和多因素模型进行选股的投资效果，前者可以直观地刻画采用一致预期数据所提炼和构建的指标之间的关系，可恰当地反映投资者的偏好、投资的风格；后者采用计量的办法，可以更加客观地观察指标之间的关系及这些关系之间的敏感性特征。

①综合评估法。综合评估法设定六大指标按照等比例加，也就是说，认为所有指标是同等重要的情况下进行选股的效果，此模型记为Ca。从各年来看，综合评估法（等权）所筛选出的Top股票组合并未超业绩基准，同时未战胜Bottom股票组合的表现。收益率曲线如图2-15所示。

图2-15　综合评估法（Ca）一致预期模型的收益率曲线

数据来源：［卜永强　2012］

从2008—2011年这4年的效果来看，采用等比例权重的综合评估法（Ca）所筛选出的Top股票组合有3年超过业绩基准指数的表现。其中，2009年Top组合的年度平均收益率高达129％，相对于上证指数的年度超额收益也高达50％左右，相对于沪深300的月度超额收益水平稍低一些，如图2-16所示。

图2-16　综合评估法（Ca）一致预期模型投资组合与业绩基准的比较

数据来源：［卜永强　2012］

此外，可以通过观察指标的特征来对基本的综合评估法加以改进和完善，这样就可以加入投资者对市场的理解和看法。这里分别用各个指标进行股票的筛选，然后统计Top股票组合月度收益率大于业绩基准指数（上证指数和沪深300指数）月度收益率的频率。

结论发现，EY指标筛选的Top股票组合月度收益率大于业绩基准月度收益率的频率高达80％，而EG、RC、RA这3种指标的相应频率在60％左右，最低的是AN、ANV指标。同时，所有指标的这种频率均超过50％。综合考虑之前的一些结果，可以认为EY指标具有很强的筛选能力，EG、RC、RA次之。

所以，这里考虑EY、EG、RC、RA、AN、ANV六大指标的比例为2∶1∶1∶1∶0.5∶0.5，即强化EY指标在综合评估法中的作用，记为Cb。

模型Ca与Cb的比较如图2-17所示，可以看到，综合评估法（Cb）模型更为看重EY指标。从筛选股票的效果来看，偏重于显著性指标EY的综合评估法（Cb）模型要好过等比例指标配置的综合评估法（Ca）。这也说明需要观察有效的、显著性的指标，以此增强选股模型的效果，从而达到良好的投资收益。

图2-17　综合评估法中一致预期模型Ca和Cb之间的比较

数据来源：［卜永强　2012］

②多因素模型。多因素模型采用六大指标与股票未来一个月收益率之间的关系进行建模，做截面回归分析。每次采用上一个月计算的指标系数并通过6类指标来计算下一个月各个股票的排序情况，以此进行股票的筛选。从实证分析来看，在2006年和2007年采用多因素模型筛选的Top股票组合均战胜业绩基准指数的表现。

通过比较综合评估法和多因素模型的选股能力可以发现，在2006年，多因素模型（MF）与综合评估法（Ca）的筛选股票能力相当，而与综合评估法（Cb）相比稍逊一筹；在2007年，多因素模型（MF）更是远逊于综合评估法（Ca）和综合评估法（Cb），如图2-18所示。

图2-18　几种一致预期模型的比较（Ca、Cb、MF）

数据来源：［卜永强　2012］

本节小结

从本节的案例可以看出，通过一致预期数据所构造的反映市场情绪的新指标体系确实能够有效地揭示市场的运行特征。这些指标能够把握市场分析师对未来一致预期的看法，投资者就可以根据分析师的看法去做适当的股票筛选；还可以把握分析师对未来一致预期的态度，恰当地刻画分析师在调整未来一致预期EPS时的信心。

通过对市场数据的进一步观察，可以看到案例中新构造的指标确实能够有效地区分和筛选出好的股票。当然，有的指标会有较为显著的区分能力。如EY指标，即预期的EPS回报率，也为预期的市盈率（PE）的倒数，它具有很强的预测和筛选个股的能力。

实际上，EY是代表市场对个股未来收益的一种预期，也是衡量市场对个股信心的重要指标。那么，投资者就可以综合考虑这些指标，并进行相应的股票筛选，给自己的投资带来更好的收益。

2.7　趋势追踪

◆摘要◆

趋势追踪的基本思想是追随大的走势，例如，对于一只股票来说，当向上突破重要的压力位后可能意味着一波大的上涨趋势行情的到来，或者向下突破某重要的阻力位后，可能意味着一波大的下跌行情的到来。

趋势追踪策略就是试图寻找大的趋势波段的到来，并且在突破的时候进行建仓或者平仓操作，以期获得大的波段收益。

2.7.1　基本概念

投资者选股，主要是基于3个方面的信息：基本面、技术面和消息面。这3种方法各有其优点和缺点。

基本面分析的经济逻辑较强，对事件的解释性也较强，比较容易给出一套逻辑来判断某种状态下股价被低估。但是基本面分析也有其弱点，不容易判断被低估价值的股票价格何时或者以怎样的过程恢复到其对应的价值，对短期行情的判断缺乏指导性。

技术面分析是对历史已发生的行情进行统计，得出指标来推断将来的行情。其优点是既可运用于长期的判断，也可以运用于短期的判断，并且依据的信息是已经发生的可靠信息，可操作性最强。但是它也有自身的缺点，由于它利用的主要是已发生的信息，因此总是存在滞后性。

消息面分析认为拥有超额信息才能拥有超额收益，拥有非对称信息可以获得超额收益。但是内幕消息交易是法律上禁止的，且其获得有一定的门槛和成本。并且假消息也充斥于资本市场之上，辨识其真伪有一些难度。所以每种方法都在一个方面和一定程度上对股价的判断具有指导作用，但又各有其弱点，需要其他方法来做有益的补充。

只用来自一个方面的信息选股，难以保证其选股成功率足够高。例如，基于基本面的某方法选择的股票，用大范围的样本进行测试其成功率为60％，那么当前如果买入某只用该种方法选择的股票A，则胜率只会有60％。但是如果从另一角度（比如基于技术面的某方法选股，该方法的大样本统计成功率也为60％）也选出了股票A，那么意味着两个因素都支持股票A的上涨概率为84％。

1．趋势追踪逻辑

中国股市追涨杀跌气氛较浓，容易形成连续的趋势，用趋势追踪的方法判断行情走势它有两个基本的理论逻辑：

1）市场中的投资者并非完全理性

传统的有效市场理论认为，在有效市场的前提下，证券的历史信息充分地反映在股价上，利用历史信息进行分析是无效的。但是有效市场假说有一个前提，就是投资者是理性的，对信息的解读和理解是准确到位的。但是在实际投资中，即使是专业的投资者，也会受知识、情绪和个人投资理念的影响，众多的投资者对信息的解读往往千差万别，所以有效市场和实际市场有所区别。由于绝大多数投资者并不能充分挖掘出历史信息，因此深入地研究历史信息仍然是有意义的。

2）价格以趋势方式演变

趋势概念是趋势追踪技术的核心。这是因为当股价受到某个新信息冲击时，投资者们获取该信息的时间不一致，即使同时获取该信息，进行投资操作的时点也不会完全相同。但是投资者又会依据获取的信息来做出投资的判断，这种对信息不同时的反应，往往让证券价格表现出趋势。实际投资中投资者也会有所感觉，顺应趋势不容易造成大的亏损。

2．利用趋势追踪技术构建组合的方法

利用趋势跟踪的方法构建组合主要分为3步：

（1）探讨指标，找寻出一系列刻画趋势的指标，然后经过细化处理，令其能较好地跟踪各个级别行情的趋势。

（2）选择样本内大样本数据进行建模，然后再选择样本外大样本数据（若干年时间）进行外推测试。需要证明样本内数据建立的模型，在样本外进行外推测试仍然有良好效果，这样模型才有意义。

（3）模型参数稳定后，则每天可以得到当前发出买入和卖出信号的股票，这样可以给每只股票分配一笔资金，买入（或者重配）当日发出买入信号的股票，卖出（或者低配）发出卖出信号的股票，用这种方式来构建股票组合。

以上是完全用技术指标来构建组合，如果和基本面、消息面结合起来选股，则是先给出当日发出买入的股票组合，然后再结合基本面和消息面的信息进行分析，确定最后的投资标的。

2.7.2　策略模型

下面介绍一个由多个指标组合的策略来跟踪股票趋势，其流程图如图2-19所示。

图2-19　个股趋势追踪策略模型

数据来源：［俞文冰　2009］

衡量股票趋势的指标最重要的就是均线系统，因为它是应用最为广泛的趋势追踪指标，所以均线是不可或缺的，把它作为捕捉大盘主趋势的基石。但是纯粹的均线由于噪音等原因，使得经常会出现误操作，需要进行更多的处理机制，包括极点、过滤微小波动、高低点比较策略、高低点突破策略、长波的保护机制、长均线的保护机制等概念和技术细节。

1．均线简化

股票价格的波动会让人感觉价格变化飘忽不定，很难把握。为了便于捕捉趋势，所以需要对价格走势曲线进行简化处理，这样可以借助于均线方法。将a个（a为模型参数）连续的交易日的收盘价取一个均值，形成MA（a），比如a为10，即10个交易日数据取一均值，那么就可以得到股价的10日均线U，完成对价格曲线的第一步简化。

2．记录极点

极点就是局部的高点或者低点，在极点处股价出现了转折，所以它们是记录股价变化的关键点，包含了比较多的信息。如果股价上涨至此，接下来又出现了下跌，那么就形成一个局部的高点；如果股价下跌至此，接下来又出现上涨，那么就形成一个低点。这些叫做极点，往往是股价变化的关键信息点，将它们记录下来，以备进一步制定策略。

3．设置阀门，过滤微小波动

均线策略最大的优势跟踪趋势效果比较好，在形成趋势时能紧跟趋势，但是最大的问题在于碰到盘整行情，均线就摇摆不定，容易频繁地发出交易信号，所以必须对其进行进一步处理。

可以结合记录的极点形成过滤微小波动的方法。当股价形成一个极点M后，接下来股价波动在M点股价的上下B个（B为模型参数）指数点内，就认为股价和M点相比没有变化，这样可以得到过滤了微小波动的均线趋势线W。如图2-20所示为万科A过滤后的均线走势。

图2-20　万科A过滤后的均线情况

数据来源：［俞文冰　2009］

4．高低点比较策略，判断主趋势

过滤了微小波动后的均线趋势线W基本能代表价格变动的主趋势，与最初的价格曲线相比过滤了许多干扰因素，且能刻画出价格变化的主趋势。这样就可以将过滤微小波动后均线W上行情发生转折的点识别出来（即上涨转为下跌处为高点，下跌转为上涨处为低点），然后可以在其上设计策略。

通常人们判断趋势处于上升的理由是，当前低点比前一个低点要高，当前高点也比前一个高点要高。判断趋势处于下跌的理由是，当前低点比前一个低点要低，当前高点也比前一个高点要低，所以就产生了高低点比较判断规则一。

规则一

如果当前低点比前一个低点要高，而且是卖出信号发出后第一次出现低点高于前低点。那么认为目前是一个买入点。如果当前高点比前一个高点要低，而且是买入信号发出后第一次出现高点低于前高点，那么认为目前是一个卖出点。

图2-21显示了万科A在趋势追踪策略下的买点。

图2-21　万科A在趋势追踪策略下的买点

数据来源：［俞文冰　2009］

从图2-21中可以看到，当前低点高于前一个低点时，认为当前低点出发出买入信号。同样，如图2-22所示，如果经历一段上升后，出现当前高点比前一个高点低，那么当前高点为卖出点。

图2-22　万科A在趋势追踪策略下的卖点

数据来源：［俞文冰　2009］

对规则一的补充

如果仅仅以高低点的比较去判断趋势的涨跌，这样的情况发出次数太多，并且有时会出现指数形成了一个新的高点，与前面一个高点相比上涨幅度不大，那么很可能是假突破行情。另一方面，简单的高低点比较策略没有考虑时间的因素，比如，股价经过很短时间就有明显上涨，和股价经过较长时间才上涨同样幅度，这显然是不一样的。

时间短的上涨趋势比时间长的同幅度上涨趋势涨势更强劲，所以设置一个根据时间变动的附加项drift来对原来的策略进行修正，这样形成对规则一的补充。

补充：如果当前低点高于前一个低点再加一个附加的漂移项drift，则认为当前是一个买入点；如果当前高点低于前一个高点再加一个附加的漂移项drift，则认为当前高点是一个卖出点。

这个drift是一个时间的函数，比如和时间成正比，drift＝time*K（K是模型参数，是用高频数据估计出来的）。当然drift也可以是时间time的其他函数。

如图2-23所示，红线表示高点加漂移项的画线。W线当前高点处高于前低点，但是低于前高点＋漂移项的画线（即红线），就认为当前高点处就是一个卖出点。

图2-23　带漂移项的万科A的买卖点

数据来源：［俞文冰　2009］

5．突破高低点策略，对高低点比较策略的补充

高低点比较只是最典型的行情情况之一，还有另一种典型情况。比如，行情有时可能会出现从最高点开始形成一个大幅下跌段，但是却并非具备当前高点比前一个高点要低的条件，如果用高低点比较策略，则无法捕捉到此次卖出机会。为了避免这种极端情况，需要制订高低点突破策略来完善策略系统，见规则二。

规则二

如果过滤了微小波动的均线趋势线W往上突破了前一个高点加上漂移项drift，则认为出现了一个买入点。如果过滤了微小波动的均线趋势线W往下突破了前一个低点加上漂移项drift，则认为出现了一个卖出点。

如图2-24所示，股价从最高点B点开始下跌，虽然不符合高低点比较策略的条件发出卖出信号，但是如果下跌到C点时，突破了前一个低点A加漂移项的位置，则认为发出卖出信号。同样，如果股价从低点上涨，往上突破了前一个高点加漂移项，那么认为发出了买入信号。

图2-24　趋势追踪策略中规则二的买卖点情况

数据来源：［俞文冰　2009］

6．大波段保护机制

如果股价经历了一个比较大的短期涨幅，那么就需要对它建立保护机制。大涨后容易出现较大幅度的下调，所以需要对盈利头寸进行保护，设置从低点加漂移项的延伸线为止损线。

规则三

如果股价经过较大涨幅，比如当前股价已经比上次低点出现后有C（这里C为模型参数）的涨幅，即现股价为上次低点股价的（1＋C）倍，那么就把止损位（前次低点＋漂移项drift）的价格上提D（D为模型参数），即止损位变成当前股价乘以（1-D）。

如图2-25所示，当股价从最低点B上涨，从低点延伸出来的带斜率的延伸线（红线）为止损线，但是股价上涨速度比止损线上升要快，那么我们设置大波段保护机制，即到A点，经历了一个较大涨幅的上涨并超过了某个阈值，此时止损线延伸到了C点处，那么把止损线（红线）从C点处突然上移到高点的位置。若股价突破止损线（红线）则卖出。

图2-25　趋势追踪策略中大波段保护机制的买卖点

数据来源：［俞文冰　2009］

7．长均线的保护机制

当股价处于明显的下降通道中，且股价表现非常弱势时，是不应该贸然买进的，而需要增设长均线的保护机制。当股价位于E日均线之下时，即使其他买入条件成立也不发出入信号。如图2-26所示，在B点以前，股价一直处于E日长均线（E为模型参数）之下，这时发出的买卖信号可以忽略。一直等到B点突破才发出买入信号。

图2-26　趋势追踪策略中长均线保护机制

数据来源：［俞文冰　2009］

2.7.3　实证案例：趋势追踪选股模型

1．个股模型的建立

本案例的思路是首先对个股建立模型，比如选择股票万科A，找到它从上市到2009年的复权行情数据，用它2001年前的数据作为样本内数据建立模型，即用以上的一整套策略流程构建模型，把均线的天数、滤波的阀门宽度等设置成参数。然后进行第二步参数的优化。

2．参数的优化

优化的方法是寻找某组参数，使得其在样本内数据上模型的收益率达到最大。优化的意义在于寻找到最好的适应历史行情的一组参数，虽然未来的行情并非按照历史的模式去演绎，但是经过优化后的参数能保证模型运行的参数至少不会是一组非常极端的参数值。假如它是一项非常极端的参数值，则它不可能是最能适应历史行情的，因为极端事件不可能在历史上是大概率的。

3．组合的构建

选择了沪深300指数的300只成分股2001年至2009年的复权行情数据作为样本外测试数据。在对个股建立了模型和确定了模型参数以后，每只股票从2001年至今，会按策略产生一系列的买点和卖点。假定在2001年初有300万元，平均给每只股票分配一万元，这样每只股票初始资金是一万元，然后按照策略的买卖点对该股进行买卖，这样300只股票各自会在持有股票和持有现金这两种状态之间轮换。

这样等于构建了一个股票投资组合，组合中的股票是当前时点刚发出买入信号的股票，或者是模型发出了买入信号后，尚未发生卖出信号的股票和现金。

该案例中坚持模型策略原则，设定模型参数一直不变。股票每个买卖来回计千分之八的费用（包括印花税、佣金和冲击成本）。观察2001年初到2009年投资组合是否能战胜股票行情。

为了便于观察策略是否能战胜行情，首先需要设定比较基准。这里选取的比较基准是买入并持有策略，假定给每只股票事先都平均分配一万元，每只股票行情的涨跌，会使事先分配给它们的资金值的大小出现变化，到期末也会有组合的资金值。比较按照趋势追踪策略买卖形成的投资组合资产变化轨迹，和按照买入并持有策略形成的投资组合资产变化轨迹。收益率曲线如图2-27和表2-22所示。

图2-27　趋势追踪技术收益率

数据来源：［俞文冰　2009］

表2-22　趋势追踪技术收益率 

数据来源：［俞文冰　2009］

从表2-22中可以看到，从2001年初到2009年，趋势追踪策略期末资金变成13993844元，组合的收益率为366.46％。平均每只股票可以获得相对于对应股票行情74.38％的超额收益率。即从2001年初到2009年，每只个股上的超额收益率的简单平均值为74.38％，按期末资金量为权重的加权平均值为44.41％。比较基准买入并持有投资策略的年化夏普比率为0.53，趋势追踪投资策略的年化夏普比率为1.13。

从案例中可以看出，按照事先设定的策略构建投资组合并坚持原则按策略操作，长期来看是可以战胜买入并持有策略的。

本节小结

趋势追踪技术的关键在于判断大趋势，并且力图避免小的扰动对趋势的影响，这样可以抓住大的波段操作，从而捕获股票的主要收益趋势。从实证结果来看，按照事先设定的策略构建投资组合并坚持原则按策略操作，长期来看是可以战胜基准的。

本节给出的趋势追踪模型对原始均线有多种优化方法，包括均线简化、识别极点、过滤微小波动、高低点识别、高低点比较、高低点突破、大波段保护、长均线保护等。

根据趋势追踪策略的实证案例显示，该策略在样本验证期间，获得74.38％的超额收益，远远超过了买入持有策略。

2.8　筹码选股

◆摘要◆

筹码选股的基本思想是通过判断某只股票的筹码分布情况来判断股票未来的涨跌。根据主力持仓理论，如果主力资金开始收集筹码，则意味着在未来一段时间该股票出现上涨的概率比较大；如果主力资金开始派发筹码，则意味着在未来一段时间该股票出现下跌的概率比较大。

筹码选股策略就是通过筹码分布数据，选择筹码集中度越来越高的股票，以期获得超额收益的方法。

2.8.1　基本概念

在股票投资实务中，不少投资者青睐使用“筹码”作为股票的代名词，在他们看来，股票市场实际上是多空双方进行博弈的场所，而筹码则是博弈的核心。

1．筹码运动与股票投资收益

由于在二级市场上流通股票的份额是相对固定的，股票价格走势的变化必然是市场中资金与筹码之间交替互换的结果。一般地，股票价格走势都会经历“筑底—上升—作顶—下降”4个阶段，相应地，筹码变化的特征则会遵循“由分散到集中，发散度下降—由集中到分散，发散度上升—由分散到集中，发散度下降—由集中到分散，发散度上升”的路径。

因此，筹码分布理论应运而生，筹码分布的学术名为“流通股票持仓成本分布”，它反映的是在不同价位上投资者的持仓数量。

筹码分布理论是通过股票价格和成交量来研究筹码和现金可逆互换的理论。该理论的最主要假设是：将所有影响股票内在价值和供求关系的因素都可以由筹码来还原。依据该理论，股票投资的收益无非是来自于现金在低位转换为筹码（股票），再将筹码在高位兑换为现金的过程。

也就是说，任何一轮行情都将经历由低位换手到高位换手，再由高位换手到低位换手，即筹码的运动过程是实现股票投资收益的过程，因此股价运动的本质等于成交量背后的筹码运动状态，简而言之，是资金与筹码之间的博弈。

筹码分布和股价的变动相关，当某一股票筹码分布较为集中时，表明主力正在收集筹码，股价上涨的概率较大，当某一股票筹码分布较为分散时，表明主力正在抛售，股价下跌的概率较大。

上市公司股东人数的变化与其二级市场走势存在着一定相关性，股东人数越少，表明筹码越集中，股价走势往往具有独立个性，并常常逆大势而动。股东人数越多，表明筹码越分散，股价走势往往较疲软，不具有独立性，跟着随大盘随波逐流。

2．筹码形态与运动

筹码分布的形态主要有密集与分散两种，筹码分布的运动主要有集中与发散两类。

成交密集的区域，形成筹码峰，两峰之间的区域则形成谷，这是筹码分布的视觉形态，筹码的运动伴随筹码的集中与发散。密集也分为高位密集和低位密集。

任何一轮行情都将经历由低位换手到高位换手，再由高位换手到低位换手，即筹码的运动过程是实现利润的过程（当然也可能是割肉亏损的过程）。

低位充分换手是完成吸筹阶段的标志，高位充分换手是派发阶段完成的标志。成本密集是下一个阶段行情的准备过程，成本发散是行情的展开过程。

3．活跃筹码

筹码分布能让投资者看出别人持股成本的分布情况，是做成本分析时很有效的工具。在仔细观察筹码分布的变化情况时，可以发现在股价附近的筹码是最不稳定的，也是最容易参与交易的，因为在股价附近的股票持有者，最经受不住诱惑，盈利的想赶快把浮动盈利换成实际盈利；被套的想趁着亏损得还少赶快卖掉，利用资金买另外的股票，把亏损赶快挣回来。

活跃筹码就是反映股价附近的筹码占所有流通筹码的百分比。它的取值范围是为0～100，数值越大表示股价附近的活跃筹码越多，数值越小表示股价附近的活跃筹码越少。

活跃筹码的多少还可用来描述筹码的密集程度，例如，如果今天的活跃筹码的值是50，则表示在股价附近的筹码呈密集状态；如果今天的活跃筹码的值是10，则表示在股价附近的筹码很少，大多数筹码都在远离股价的地方，获利很多，或者亏损很多。

当活跃筹码的数值很小时是很值得注意的一种情况。比如，一只股票经过漫长的下跌后，活跃筹码的值很小（小于10），大部分筹码都处于被套得较深的状态，这时多数持股者已经不愿意割肉出局了，所以这时候往往能成为一个较好的买入点；又如，一只股票经过一段时间的上涨，活跃筹码很小（小于10），大部分筹码都处于获利较多的状态，如果这时控盘强弱的值较大（大于20），前期有明显的庄股特征，总体涨幅不太大，也能成为一个较好的买入点。所以，在股价运行到不同的阶段时，考虑一下活跃筹码的多少，能起到很好的辅助效果。

4．筹码集中度与预期股票收益率

筹码是股市博弈的核心。在熊市中现金为王，在牛市中筹码为王。在市场中，谁掌握更多的筹码，谁就将在未来的博弈中夺得主动权。

筹码运动的形式表现为筹码的集中与发散。筹码集中度是指人（股东）均所持的股票多少在流通总股本中所占的份额。根据实战经验总结得出，上市公司股东人数的变化与其二级市场的走势存在着一定的相关性，股东人数越少，表明筹码越集中，市场观点越统一，股价走势往往具有独立个性，股价容易攀升。

反之，股东人数越多，表明筹码越分散，反映市场对未来股票的走势分歧越大，股价走势往往较疲软。因此，筹码的集中过程是下一波行情的准备过程，而筹码的发散则是行情的展开过程。

综上所述，每当筹码集中度增加时，则预示着在下一阶段股票将会有较好的预期表现，这就是筹码选股基本思想的由来。

对于筹码集中度选股策略，主要方法如下：

（1）筹码集中度高的股票（10以下）的爆发力强，上涨或下跌的幅度比较大。

（2）筹码集中度低的股票（尤其是20以上）的上涨力度明显减弱。

筹码的集中过程是下一阶段行情的准备过程，而发散过程是行情的展开过程。需要强调：

（1）不是只有集中，股票才会上涨。

（2）达到集中，上涨的幅度增大。

（3）不集中的股票，也会上涨。

筹码集中度衡量指标包括：

（1）户均持股比例。股东平均所持的股票在流通总股本中所占的份额，户均持股比例越大，表明筹码越集中，反之越发散。

（2）上市公司股东人数。股东人数越少，表明筹码越集中，反之越发散。

2.8.2　策略模型

为了考察筹码集中度高的股票是否能带来较高的预期收益，本策略中选取三个有关筹码集中度的指标：股东户数（季度增长率）、户均持股数（季度增长率）、机构持股数（季度增长率），并结合涨跌幅指标对备选股票进行双重筛选，最终精选出符合标准的50只股票构造投资组合，希望在目标投资期内获取超越市场基准的绩效表现。详细的股票筛选方法和投资组合的构建流程如下。

1．样本测试时间

考虑到在股改之前的A股市场并不是全流通状态，则按照定义的筹码集中度指标并不具有实际意义，因此选择2006年5月8日为第一次建仓日。

2．假设

假设1：所有相关指标的原始数据来源是正确无误的。

假设2：我们的投资组合初始构建日定为2006年5月8日，以后每季度再调整日发生在5月8日、9月1日、11月11日。

年报披露的截止日期为每年的4月30日之前。

第一季报披露的截止日期为4月30日之前。

半年报的披露截至日期为8月31日之前。

第三季报的披露截止日为10月31日之前。

假设3：可以用收盘价买到需要购买的股票，不考虑冲击成本和流通成本，交易费用0.15％（双边）。

3．筛选方法

假设：截止到上市公司季报最后发布日，如果季报中3个指标较上一季度有所增加，则表明该股票的筹码集中度增加，预示着市场主力资金在本季度增加了对该股票筹码的收集，预计在下一季度或将来，该股票很有可能会掀起一波行情。循此思路，对股票池进行双重筛选。

首先，在每季度末，从股票池中根据筹码集中度（股东户数（季度增长率）、户均持股数（季度增长率）、机构持股数（季度增长率））对所有股票进行排序，选出其中增长率最高的前100只股票。

其次，再依据涨跌幅指标，对上一轮筛选出的100只备选股票进行由高到低的排序，并淘汰50只涨幅最低的股票，保留另外50只在本季度表现最优的股票。

4．筛选步骤

（1）投资组合初始构建日定为2006年5月8日，在每年的5月8日、9月1日、11月1日在最新的季报完全公布后调仓。

（2）由于ST的股票风险较大，因此剔除当前被ST的股票，剔除筛选指标在考察期内没有记录的股票样本，从而形成初始股票池。

（3）在步骤（2）的基础上，分别根据股东户数（季度增长率）、户均持股数（季度增长率）、流通股中机构持股数（季度增长率）、单个指标及其分层组合和打分组合进行选择。

（4）对最后精选出的n只股票按照等金额构造期初投资组合，以后每季度仍遵循步骤（1）～（3）对组合进行调整。在目标投资期末，将评估该优化选股策略的投资绩效，并与市场基准作对比。

5．业绩评估基准

关于业绩比较的基准，选取上证A股综合指数。

2.8.3　实证案例：筹码选股模型

根据上一节的策略，所获得的投资组合结果如下：

1．单个指标实验结果对比

表2-23是单个指标收益率情况的对比，从表中可以看出，机构持股数（季度增长率）是效果最好的指标，获得年化46％的收益率，而同期上证指数仅获得17％的年化收益率。这可能是因为机构对市场的影响力比较大造成的。

表2-23　筹码选股模型中单个指标的收益率情况对比 

资料来源：D-Alpha量化对冲交易系统

图2-28是单个指标在不同年份的收益率情况，从图中可以看出，机构持股比例（增长率）这个指标在2007年和2009年的牛市中均超越其他指标，这可能是因为在牛市的情况下，机构的力量造成了比较大的趋势，而在熊市中，机构持股不卖，使得其也容易遭到更大的损失。

图2-28　筹码选股模型中单个指标在不同年份的收益率情况

资料来源：D-Alpha量化对冲交易系统

图2-29是单个指标的净值走势图，从图可以看出，基于股东户数（季度增长率）、户均持股数（季度增长率）、机构持股数（季度增长率）的3个方法中，基于机构持股数（季度增长率）的指标效果最好，户均持股数次之。

图2-29　筹码选股模型中单个指标总收益率曲线

资料来源：D-Alpha量化对冲交易系统

2．组合指标实验结果

上面单个指标说明了各自的市场表现，而将这些指标组合起来，可能会获得更好的结果。

组合指标有以下两种方法：

（1）分层排序法。通过将指标进行逐级排序筛选，获得最终的股票组合。

（2）权重打分法。将股票列表根据单个指标分别进行排序，然后将各个指标依据顺序进行排序，获得权重，然后将各个股票在3个指标中对应的权重求和，最后根据权重重新排序，选取权重最大的m个股票。

如图2-30和图2-31所示是这两种组合方法的收益率对比。

图2-30　筹码选股中分层排序和指标组合打分方法净值走势

资料来源：D-Alpha量化对冲交易系统

图2-31　筹码选股中分层排序和指标组合打分方法在不同年份的收益率对比

资料来源：D-Alpha量化对冲交易系统

从图2-30和图2-31中可以看出，在这几个指标中，基于分层排序的方法与基于打分的方法相比，基于分层排序的方法结果较好。

3．动态调仓

前面的投资组合都是基于静态的即固定的时间进行投资组合的调整，这种方法具有简单、方便的优点，但是太过于死板，不够灵活。在这里实证了一种动态调仓的方法，步骤如下：

（1）若季度报告披露截止日之前的某日，从某只股票季度报告中得出筹码集中度指标满足提前入池条件，则该只股提前入股票组合。同时将组合内涨幅最低的上期单只股票剔除。

（2）若该季度报告披露截止日，新进股票组合的股票数未达N只（即上期股票未全部被替换），则在该日计算备选池中将所有剩余股的筹码集中度指标一次性补齐至N只，同时剔除所有未剔除的上期股票。

（3）若该季度报告披露截止日，新进组合的股票数正好等于N只，则股票组合构建完毕。

（4）若该季度报告披露截止日之前，新进组合的股票数已达N只，若后续某日又出现符合条件的股票，则将其放入备选股票池中。

动态调仓方法收益率曲线和静态调仓方法的对比如图2-32所示。

图2-32　筹码选股模型中静态调仓和动态调仓的收益率对比

资料来源：D-Alpha量化对冲交易系统

从图2-32中可以看出，动态调仓和静态调仓策略相比，在2006年、2008年、2009年、2010年收益率都有一定的提高，但是提高的幅度不是很大，并且动态调仓涉及的条件和参数较多，需要深入测试与研究。

本节小结

本节讨论了筹码量化选股策略，从筹码选股的思想来看，本质上是一种跟随主力资金的方法，如果发现了某只股票有主力建仓的迹象，则跟随买入，将有比较大的概率获得超额收益。

从D-Alpha量化对冲交易系统的A股历史数据的实证来看，基于筹码集中度的选股方法可以取得较好的中长期投资收益，基本上可以获得超越市场基准的投资绩效，尤其是在熊末牛现、市场上升前期和牛末熊初、市场下跌盘整的阶段，该策略较大盘表现更胜一筹。

2.9　业绩评价

◆摘要◆

对于一个选股组合的好坏，可以通过一些指标来判别，主要包括收益率指标和风险率指标两大类。对于投资者，特别是机构投资者来说，收益率并不是判断好坏的唯一指标，需要更多地考虑相对市场、相对业绩基准的情况，并且还要考虑收益率的波动情况、是否投资足够稳健等。

2.9.1　收益率指标

1．总收益率

假定初始建仓日期为T1
，建仓时总权益为N1
，平仓日期为T2
，平仓时总权益为N2
，则总收益率可以用下面的公式计算出来：

总收益率＝（N2
－N1
）/N1
－1

2．年化复合收益率

单独看总收益并不能说明一个投资组合的好坏，因为总收益率与投资期限有关系，从常理上说，投资期限越长，获得的收益率应该越高，所以判断一个投资组合的好坏，用年化复合收益率更适合。

其中，（T2
－T1
）表示投资期限，（T2
－T1
）/365表示将投资期限折算成年数。

3．相对收益率

相对收益率是用来查看某个投资组合的收益率相对于基准收益率的好坏程度，用以下公式表示：

相对收益率＝总收益率－业绩基准收益率

业绩基准收益率主要有沪深300指数、上证指数、行业指数等。

4．阿尔法收益率

阿尔法收益率主要是指在利用股指期货对冲掉系统性风险后，某投资组合所能创造的超额收益，与相对收益率不同的是，阿尔法收益率中需要考虑股指期货保证金占用所带来的总投资增加的问题。假定初始建仓股指期货权益为M1
，平仓时权益为M2
，则：

阿尔法收益率＝［（N2
－N1
）＋（M1
－M2
）］/（N1
＋M1
）－1

股票是先买后卖，所以股票部分权益是（N2
－N1
），股指期货是先卖后买，所以股指期货部分权益是（M1
－M2
）。

2.9.2　风险度指标

1．贝塔（β）系数

贝塔系数是统计学上的概念，它所反映的是某一投资对象相对于大盘的表现情况。其绝对值越大，显示其收益变化幅度相对于大盘的变化幅度越大；其绝对值越小，显示其变化幅度相对于大盘越小。如果是负值，则显示其变化的方向与大盘的变化方向相反；大盘涨的时候它跌，大盘跌的时候它涨。

若β大于1，则股票的波动性大于业绩评价基准的波动性。反之亦然。如果β为1，则市场上涨10％，股票上涨10％；市场下滑10％，股票相应下滑10％。如果β为1.1，则市场上涨10％时，股票上涨11％；市场下滑10％时，股票下滑11％。如果β为0.9，则市场上涨10％时，股票上涨9％；市场下滑10％时，股票下滑9％。

这一指标可以作为考察投资策略降低投资波动性风险的能力。在计算贝塔系数时，除了投资策略的表现数据外，还需要有反映大盘表现的指标。其定义式为：

其中，rk
表示某类资产组合K的市场收益率，rm
表示市场组合的收益率，cov（rk
，rm
）表示某类资产组合的收益率与市场收益率的协方差，var（rm
）表示市场收益率的方差。

系数一般有3种估计模型，分别是基于β系数定义、CAPM以及单因素模型的估计。

1）基于定义估计

根据β系数的定义，得到以下估计：

其中rkt
表示第K种证券在第t个单位时间段（如日、周、月、年等）的收益率，
表示第K种证券在某时间段（如T天、T周、T月、T年等）的平均收益率，T表示时间段的长度。rmt
表示证券市场组合在第t个单位时间段的收益率，
表示证券市场组合在某个时间段内的平均收益率。这种做法假设在某个时间段T内的β系数不变，没有衡量时变的β系数。

2）基于CAPM估计

CAPM指出，在市场处于均衡的时候，某种证券或组合的投资收益和风险存在一定的关系，CAPM可表示为：

E（rk
）＝rf
＋βk
（E（rm
）－rf
）

这里，
是资产K的贝塔系数，也是收益率对随机折现系数的敏感度，它表示资产K的系统风险测度，从而可以利用β系数将资产组合的风险区分为系统风险和非系统风险。rm
是最优风险证券组合的收益率，var（rm
）是最优风险证券组合的方差，rk
是某种资产的收益率，cov（rk
，rm
）为资产K与最优风险证券组合之间收益率的方差，rf
为无风险证券收益率。

3）基于单指数模型

与CAPM相比，单指数模型也叫市场模型，是一种基于现实市场中证券资产的价格或收益变动普遍存在的同涨同跌现象，认为这种联动关系是由市场收益这个共同因素影响的。模型不需要太多的假设，可以表示如下：

rk，t
＝αk
＋βk
rm，t
＋εk，t

其中，αk
、βk
是模型的参数。与CAPM中估计的β系数相同，这样得到的β系数也被认为不是时变的，也可以类似CAPM进行时变模型的转化处理，得到：

rk，t
＝αk，t
＋βk，t
rm，t
＋εk，t

2．夏普率

1）夏普比率的计算公式

其中，
是收益率均值，
是无风险利率，σp
为收益率标准差。

它反映了单位风险投资组合净值增长率超过无风险收益率的程度。如果夏普比率为正值，则说明在衡量期内投资组合的平均收益率超过了无风险利率。在以同期银行存款利率作为无风险利率的情况下，说明该投资组合比银行存款要好。夏普比率越大，说明投资组合单位风险所获得的风险回报越高。

以夏普比率的大小对投资组合表现加以排序的理论基础在于，假设投资者可以以无风险利率进行借贷，这样，通过确定适当的融资比例，高夏普比率的投资组合总是能够在同等风险的情况下获得比低夏普比率的投资组合高的投资收益。

例如，假设有两个投资组合A和B，A投资组合的年平均净值增长率为20％，标准差为10％，B投资组合的年平均净值增长率为15％，标准差为5％，年平均无风险利率为5％，那么，投资组合A和投资组合B的夏普比率分别为（20％－5％）/10％＝1.5和（15％－5％）/5％＝2。依据夏普比率，投资组合B的风险调整收益要好于投资组合A。

为了更清楚地对此加以解释，可以以无风险利率的水平，融入等量的资金（融资比例为1∶1），投资于B，那么B的标准差将会扩大1倍，达到与A相同的水平，但这时B的年平均净值增长率为25％（即2*15％-5％），即大于投资组合A。

2）夏普率在运用中应该注意的问题

夏普率在计算上尽管非常简单，但在具体运用中仍需要对夏普比率的适用性加以注意：

（1）用标准差对收益进行风险调整，其隐含的假设就是所考察的组合构成了投资者投资的全部。因此只有当考虑在众多的投资组合中选择投资某一只组合时，夏普比率才能够作为一项重要的依据。

（2）使用标准差作为风险指标也被人们认为不合适。

（3）夏普率的有效性还依赖于可以以相同的无风险利率借贷的假设。

（4）夏普率没有基准点，因此其大小本身没有意义，只有在与其他组合的比较中才有价值。

（5）夏普率是线性的，但在有效前沿上，风险与收益之间的变换并不是线性的。因此，夏普指数在对标准差较大的投资组合的绩效衡量上存在偏差。

（6）夏普率未考虑组合之间的相关性，因此纯粹依据夏普值的大小构建组合存在很大问题。

（7）夏普率与其他很多指标一样，衡量的是投资组合的历史表现，因此并不能简单地依据投资组合的历史表现进行未来操作。

（8）计算上，夏普率同样存在一个稳定性问题：夏普率的计算结果与时间跨度和收益计算的时间间隔的选取有关。

尽管夏普率存在上述诸多限制和问题，但它仍以其计算上的简便性和不需要过多的假设条件而在实践中获得了广泛的运用。

3．最大回撤

最大回撤是投资者，尤其是机构投资者，如基金公司、资产管理公司等管理人需要密切关注的一个指标，因为最大回撤往往代表了投资人所能忍耐亏损的极限。很多基金产品都会有一个止损线，一旦突破该止损线，将被强制清盘。所以纵然管理人对自己的策略多么有信心，认为在未来一段时间肯定会挽回亏损，但是短期的回撤一旦超过止损线，将会强制出局，再也没有挽回的余地。因此从实战角度来说，最大回撤往往比收益率和夏普率更加重要。

另外，最大回撤也决定了产品所能使用杠杆的比例。例如有一个策略，最大回撤是20％，那么理论上可以用20％的自由资金做保底，设计一个结构化产品，该产品亏损20％的时候先从自有资金中扣除，这样的产品就相当于获得了5倍的杠杆，放大了本金，从而获得更大的收益。

最大回撤主要有两种：一种是历史回溯后的最大回撤，一种是对未来的预期最大回撤。历史最大回撤就是在某个时间段上，收益率最低的那个数值；对未来的预期最大回撤，就是在某个置信区间下，未来最大回撤的值是多少。

具体形式化定义如下：给定历史数据区间D1
为起始日，Dn
为终止日，Di
为D1
与Dn
之间的第i日，P1
为起始日的组合市值，Pn
为终止日的组合市值，Pi
为第i日的组合市值，则最大历史回撤Max-Recall为（Pi
－P1
）/P1
中的最小值。计算伪代码如下：

而对未来最大回撤的预计，则可以借鉴VaR的思想。也就是说，在未来的N日中，在M％的置信区间下，最大期望回撤为Max-Recall-R。

这里有两种方法，一是直接根据Max-Recall（i）的数据来做排序，计算出在M％置信区间下的Max-Recall-R；二是根据Max-Recall（i）的值拟合某个分布，然后根据分布来计算。

总而言之，在实战中最大回撤的计算是极为重要的，最大回撤涉及杠杠比例的大小，最终影响收益。

这里我们用M_R和M_Rr分别表示历史最大回撤和期望最大回撤，在后面的章节讨论中还会用到这个符号。

4．信息比率

信息比率（Information Ratio）的定义： 
以马克维茨的均异模型为基础，用来衡量超额风险带来的超额收益，比率高说明超额收益高。它表示单位主动风险所带来的超额收益。

信息比率的公式为： 
IR＝TD/TE（TD表示资产跟踪偏离度的样本均值；TE为资产的跟踪误差）。

合理的投资目标应该是在承担适度风险的情况下，尽量追求高信息比率，而非单纯追求高信息比率。

为什么需要信息指针来衡量基金绩效？投资人皆知道，高报酬伴随着高风险，因此主动操作的基金经理人会提高投资组合风险以期得到较高报酬，但若基金经理人仅靠提高系统风险（Market Risk）所得到的报酬，并不表示具有优越的操作绩效，因为多数投资人也可以做到。因此，若经理人有较好的选股技巧，在相同的非系统风险下，应该得到较高的超额报酬。

进一步分析指标的内涵意义。此指标可视为“技巧”、“宽度”与“效率”3部分的结合。“技巧”指择股技巧，用以衡量经理人投资预测的准确度；“宽度”是指投资决策的数目，亦即衡量经理人在一年内真正将择股技巧用于最终投资决策的次数；“效率”是衡量投资组合建构的质量，也就是在考虑交易成本与投资限制下，经理人择股技巧实际转换成投资组合的成效。因此，本指标所考虑的选股能力确实兼具深度与广度。

另外，主动操作的经理人为让绩效击败指数，通常持有股票或债券的权重会偏离指数，而此指标可衡量经理人善用其所拥有的信息以偏离指数的能力，较高的信息比率表示此基金确实优于被动管理的基金。

在不能卖空的市场中，因为系统性风险无法对冲，投资者无法对一个绝对收益低而IR高的基金通过杠杆放大得到上述效果。

但是信息比率仍然对管理者具有非常重要的意义，因为其奖励的不是绝对业绩，而是奖励业绩持续稳定者，这一点对投资者的吸引力显而易见。

由于主动管理者都是相对某一基准而非现金，因此如果是可以通过卖空而对冲系统风险的话，高IR就是管理者唯一的目标。而在缺乏卖空机制的情况下，管理者应该以此为主要目标。

主要目标的含义是指IR对管理者非常重要，但并非唯一。主要原因是通过理论和实践的证明，在不能卖空的市场中，承担风险的边际效用是递减的，即在承担的风险达到一定程度后，进一步承担风险所带来的收益就比较小。也即随着承担风险的提高，风险调整后收益就越低。

总之，投资人在投资基金时，应以投资人本身资产的投资组合为考虑，因此绩效评估指标即可作为投资人主动管理基金时的参考评估依据之一。

5．特雷诺指数

特雷诺指数用Tp表示，是指每单位风险获得的风险溢价，是投资者判断某一基金管理者在管理基金过程中所冒风险是否有利于投资者的判断指标。特雷诺指数越大，单位风险溢价越高，开放式基金的绩效越好，基金管理者在管理的过程中所冒风险越有利于投资者获利。相反，特雷诺指数越小，单位风险溢价越低，开放式基金的绩效越差，基金管理者在管理的过程中所冒风险不有利于投资者获利。

特雷诺指数是对单位风险的超额收益的一种衡量方法。在该指数中，超额收益被定义为基金的投资收益率与同期的无风险收益率之差，该指数计算公式为：

T＝（Rp－Rf）/βp

其中，T表示特雷诺业绩指数，Rp表示某只基金的投资考察期内的平均收益率，Rf表示考察期内的平均无风险利率，βp表示某只基金的系统风险。

特雷诺指数给出了基金份额系统风险的超额收益率，通俗地讲就是说衡量基金对于每单位系统风险的收益率。特雷诺指数考虑的是系统风险，而不是全部风险，因此，无法衡量基金经理的风险分散程度。系统风险不会因为投资组合的分散而降低，因此，即便基金经理的风险分散做得很好，特雷诺指数可能并不会因此而变大。

总而言之，在构建一个投资策略时，不能仅考虑收益率，而是要更多考虑风险度调整之后的一个值，那样才是更客观、更有价值的。笔者也碰到很多私募的朋友在短期内做出了很棒的业绩，年收益率超过200％的大有人在，但是能持续保持这种收益的几乎没有。因为他们的业绩之所以出色，是因为承担了巨大的风险，有的投资策略的成功率基本上和买彩票差不多。成功的背后是更多的失败，所以笔者一向不赞同这种高风险的策略，经过风险调整后的收益率才真正证明投资经理的价值。

第3章　量化择时

◆摘要◆

择时交易是指利用某种方法来判断大势的走势情况，是上涨还是下跌或者是盘整。如果判断是上涨，则买入持有；如果判断是下跌，则卖出清仓；如果判断是震荡，则进行高抛低吸，这样可以获得远远超越简单买入持有策略的收益率，所以择时交易是收益率最高的一种交易方式。但是由于大盘趋势和宏观经济、微观企业、国家政策，国际形势等密切相关，想要准确判断大盘走势具有相当的难度。

量化择时就是利用数量化的方法，通过对各种宏观微观指标的量化分析，试图找到影响大盘走势的关键信息，并且对未来走势进行预测。本章一共介绍了8种量化择时方法，分别是趋势择时、市场情绪择时、有效资金模型、牛熊线、Hurst指数、SVM分类、SWARCH模型及异常指标模型。

趋势择时的基本思想来自于技术分析，技术分析认为趋势存在延续性，因此只要找到趋势方向，跟随操作即可。趋势择时的主要指标有MA、MACD、DMA等，本章讨论了普通均线和自适应均线的择时策略。

市场情绪择时就是利用投资者的热情程度来判断大势方向，当情绪热烈，积极入市时，大盘可能会继续涨；当投资者情绪低迷、不断撤出市场的时候，大盘可能继续下跌。

有效资金模型和选股模型中的资金流模型类似，其是通过判断推动大盘上涨或者下跌的有效资金来判断走势，因为在顶部和底部时资金效果具有额外的推动力。

牛熊线择时的思想就是将大盘的走势划分为两根线，一根为牛线，一根为熊线。在牛熊线之间时大盘不具备方向性，如果突破牛线，则可以认为是一波大的上涨趋势的到来；如果突破熊线，则可以认为是一波大的下跌趋势到来。

Hurst指数是分形理论在趋势判断中的应用，分形市场理论认为，资本市场是由大量具有不同投资期限的投资者组成的，且信息对不同投资者的交易周期有着不同的影响。利用Hurst指数可以将市场的转折点判断出来，从而实现择时。

SVM是一种分类技术，具有效率高、推广性能好的优点，SVM择时就是利用SVM技术进行大盘趋势的模式识别，将大盘区分为几个明显的模式，从而找出其中的特征，然后利用历史数据学习的模型来预测未来的趋势。

SWARCH模型是海通证券开发的一种利用宏观经济指标来判断大盘的策略，该模型主要刻画了货币供应量M2和大盘走势之间的关系，揭示我国证券市场指数变化与货币供应量之间的相关关系。

异常指标择时主要处理一些特殊情况下的择时，例如，在大盘出现顶点或者低点的时候，有些指标容易出现异常数据，这段介绍了市场噪声、行业集中度和兴登堡凶兆3个策略。

3.1　趋势追踪

3.1.1　基本概念

技术分析是与基本面分析相对应的一种证券交易分析方法，也是实际操作中运用最多的分析方法之一。关于利用技术分析进行市场交易的有效性问题，无论在学术界和实务界历来都争议不断，姑且不论其最终结果如何，但就从实际操作中来看，较好地理解和运用技术分析，对于实现投资收益、减小波动风险都是十分有意义的。

技术分析的理论基础基于3项市场假设：市场行为涵盖一切信息；价格沿趋势移动；历史会重演。从这3个基本假设出发，产生了不同流派的技术分析研究方法和理论体系，其中，包括道氏理论、K线图分析、波浪理论等在内的诸多方法已经广为流传和发展，并在数年的证券交易发展史中产生了巨大影响。

从实际运用的角度来看，不同的技术分析方法，不论其产生的历史背景和基本原理如何，都是在证券交易的价量等历史资料基础上，通过统计分析、数学计算乃至绘制图表等方法的处理，最终用来预测各种证券未来价格走势，从而为投资决策服务。一般来说，可以将技术分析方法分为5类：指标类、切线类、形态类、K线类、波浪类。

技术指标是技术分析中使用最多的一种方法，通过考虑市场行为的多个方面建立一个数学模型，并给出完整的数学计算公式，从而得到一个体现证券市场的某个方面内在实质的数字，即所谓的技术指标值。指标值的具体数值和相互间关系直接反映证券市场所处的状态，为我们的操作行为提供指导方向。

目前证券市场上的各种技术指标数不胜数，如相对强弱指标（RSI）、随机指标（KD）、趋向指标（DMI）、平滑异同移动平均线（MACD）、能量潮（OBV）、心理线（PSY）等。这些都是很著名的技术指标，并在证券市场应用中长盛不衰。而且随着时间的推移，新的技术指标还在不断涌现。根据指标的设计原理和应用法则，可以将技术指标分为“趋势型指标”、“反趋势指标”、“能量指标”、“大盘指标”、“压力支撑指标”等类别。本节中只研究趋势型指标的择时操作。

在技术分析中，大多数技术指标都是选股和择时兼顾，即在合适的情况下选择股票进行交易，也有部分技术指标只用于择时，如大盘指标等。这里只考虑利用技术指标进行市场的择时。本章重点研究趋势型指标、大盘类指标和超买超卖类指标等几种。择时交易的标的资产是大盘指数，比较基准是买入并持有策略，为了与国内证券投资者使用习惯一致，这里采用上证综指作为研究对象。

3.1.2　传统趋势指标

1．趋势型指标的计算

趋势型指标是投资者运用最多，也最容易在市场中获利的方法。市场中最为著名的格言：“让利润充分增长，限制损失”，是趋势型指标的真实反映。趋势型指标通常利用两根线的交叉作为交易信号，并以此作为买卖时点的判断。

常用的趋势型指标包括：移动均线（MA）、振动升降指标（ASI）、佳庆指标（CHAIKIN）、平均差（DMA）、趋向指标（DMI）、区间振荡指标（DPO）、简易波动指标（EMA）、平滑异同移动平均线（MACD）、三重指数平滑平均线（TRIX）、终极指标（UOS）、十字滤线（VHF）、量价曲线（VPT）、威廉变异离散量（WVAD等。这里重点研究其中最常用的MA、MACD、DMA和TRIX这4个指标的择时情况。

1）MA（移动平均）

移动平均分析是利用统计学上移动平均的原理，对每天的股价或成交数据进行平均化处理，以消除偶然变动，减弱季节和循环变动的影响。移动平均线是以道·琼斯的平均成本概念为理论基础，采用移动平均分析的方法，将一段时期内的股票价格平均值连成曲线，用来显示股价的历史波动情况，进而反映股价指数未来发展趋势的技术分析方法。

股价移动平均线是目前股票市场上使用最简单、应用最广泛的技术分析方法之一，由于移动平均线客观精确，适应性强，因而成为绝大多数研究运行趋势的基础。按照计算时间区间的不同，移动平均线可分为短期、长期等类型，一般来说，计算期间在20天以内称为短期，20天以上称为长期。不同计算长度的移动均线可以用来判断不同时段市场的趋势。

移动平均的计算方法有多种，最常用的是算术移动平均，又称为简单移动平均（SMA），其计算公式为：

其中，N为移动平均期间，MAt
为第t天的移动平均数，Pt－1
为第（t－i）天的收盘价或股价指数。此外还有加权移动平均，包括线性加权、指数加权等方法，而在实际运用中主要以简单的算术移动平均为主。

利用移动平均线进行择时交易的方法众多，其中最为著名的是葛南维移动平均线八大法则。其中，四条用来研判买进时机，四条用来研判卖出时机。简单来说，移动平均线在价格之下，而且又呈上升趋势时是买进时机；反之，平均线在价格线之上，又呈下降趋势时则是卖出时机。

利用移动均线择时的另外一种常用方法是交叉择时法则，即当一条短期均线从下向上穿过长期均线时，形成所谓金叉，此时应该做多；而当一长期均线从上向下穿过短期均线时，形成所谓死叉，此时应该做空或空仓。

利用金叉和死叉进行择时不仅在移动均线中运用广泛，而且是趋势型指标的一个通用法则，在后面的MACD、DMA和TRIX择时策略中都将以此为基础。

2）MACD

MACD即指数平滑异同移动平均线，是一种研究判断股票买卖时机、跟踪股价运行趋势的技术分析工具。

MACD指标是根据均线的构造原理，通过分析短期（常用为12日）指数移动平均线与长期（常用为26日）指数移动平均线之间的聚合与分离状况，对买进、卖出时机做出判断的技术指标，是一种典型的趋势型指标。

MACD的计算：

（1）计算短期（S日）指数移动平均线和长期（L日）指数移动平均线EMA1、EMA2。

（2）计算离差值DIFF＝EMA1－EMA2。

（3）计算DIF的N日指数移动平均线，即DEA。

（4）计算MACD＝2*（DIF－DEA）。

在MACD的计算和测试中，需要设定的参数主要包括短期均线和长期均线的计算天数S、L，以及DEA的计算天数M。

MACD的运用：

（1）DIFF、DEA均为正，DIFF向上突破DEA，买入信号。

（2）DIFF、DEA均为负，DIFF向下跌破DEA，卖出信号。

（3）DEA线与K线发生背离，行情反转信号。

（4）分析MACD柱状线，由红变绿（正变负），卖出信号；由绿变红，买入信号。

3）DMA

DMA指标即所谓平均线差指标，是股市分析技术指标中的一种中短期指标，它常用于大盘指数和个股的研究判断，DMA指标也是一种运用较多的趋势型分析指标。

DMA是依据快慢两条移动平均线的差值情况来分析价格趋势的一种技术分析指标。它主要通过计算两条基准周期不同的移动平均线的差值，来判断当前买入卖出的能量的大小和未来价格走势的趋势。

DMA的计算：

（1）计算短期（S日）移动均线和长期（L日）移动均线MA1、MA2。

（2）计算平均线差DMA＝MA1－MA2。

（3）计算DMA的M日移动平均线，即AMA。

在DMA的计算中，需要设定的参数主要是短期均线和长期均线的计算天数S、L，以及AMA的计算天数M。

DMA的运用：

（1）DMA向上交叉其平均线AMA时，买进。

（2）DMA向下交叉其平均线AMA时，卖出。

（3）DMA与股价产生背离时的交叉信号，可信度较高。

4）TRIX

TRIX指标即三重指数平滑移动平均指标，是一种研究股价和市场长期运行趋势的技术分析工具。

TRIX指标是根据移动平均线理论，对一条平均线进行三次平滑处理，再根据这条移动平均线的变动情况来预测股价的长期走势。

TRIX的计算：

（1）计算N日的指数移动平均线EMA。

（2）对上述EMA再进行两次N日指数移动平均后得到TR。

（3）计算TRIX＝（TR－昨日TR）/昨日TR*100。

（4）计算TRIX的M日简单移动平均MATRIX。

在TRIX的计算中，需要设定的参数主要是三次移动平均的天数N，以及MATRIX的计算天数M。

TRIX的运用：

（1）TRIX由下往上交叉其平均线时，为长期买进信号。

（2）TRIX由上往下交叉其平均线时，为长期卖出信号。

2．单指标择时测试与参数选择

案例　传统趋势指标择时

选择MA、MACD、DMA和TRIX这4个指标进行趋势型指标择时模型的构建的原因是：它们都是市场中常用的技术指标，受到投资者数年的实践检验，长盛不衰；它们的运用方法都以交叉法则为主，择时相关性较好，便于后面的叠加。

上述每一种指标都是经过前人长期检验的，其有效性或有用性是有保证的，但就单个证券而言，不同的计算参数将导致不同的择时效果，因此在进行择时模型构建时，首先需要检验单个指标不同参数的测试效果，并选择一个相对较好的参数，然后再将多个指标结合起来，构建一个多指标的择时模型。

在测试区间选择上，考虑到不同的时间阶段和不同的市场行情，参数对择时的情况也会有所不同。因此在本节中，分别测试了不同时间区间的择时情况，然后从中选择一种相对稳定的参数指标。具体来说，将1996年至今的15年划分为3个5年，分别测试各种参数组合在3个区间内的择时表现，然后对其进行打分，选择得分最高的一组参数作为最优参数。3个测试期间为1996.1—2000.12、2001.1—2005.12、2006.1—2010.11。

交易成本是影响择时交易的一个重要因素，在单个指标择时中我们不考虑交易成本，只在综合指标择时中计算1％的双边交易成本。

1）MA

MA指标利用短期移动均线与长期移动均线的交叉来进行择时交易，具体法则如下：

其中，Signal＝1表示买进，Signal＝0表示卖出。

测试参数包括计算短期均线天数S和长期均线天数L。在每个测试期间内，S以2天为间隔，测试范围从2天到20天；L以5天为间隔，测试范围从20到120天。测试中采用遍历的搜索方法，分别计算不同参数匹配下的择时交易情况。

从测试情况来看，MA指标适合长线择时。在不考虑交易成本的情况下，交叉择时交易法则能获得不错的收益表现。综合而言，以4日为短期均线，40日为长期均线进行交叉择时效果相对较好；在3个择时期间内，有两个期间跑赢买入持有策略，只在第一个5年收益欠佳，但从长期的择时收益来看，能大幅跑赢指数收益，如表3-1所示。

表3-1　MA指标择时测试最好的20组参数及其表现 

资料来源：［易海波　2010］

2）MACD、DMA、TRIX择时测试

出于篇幅的限制，下面只给出MACD、DMA、TRIX这3个指标的择时方法和最终结果的比较，不再单独列出每个指标择时的具体效果。

MACD指标的测试中采用DIF和DEA的交叉进行择时交易，按照使用惯例，在买入信号产生中加入DIF和DEA为正，卖出则必须为负的约束。具体操作法则如下：

其中，Signal＝1表示买进，Signal＝0表示卖出。

测试参数包括计算DIF的长期均线天数L、短期均线天数S和DEA的计算天数M。在每个测试期内，S以2天为间隔，测试范围从2天到20天，L以5天为间隔，测试范围从20到120天；M以5天为间隔，测试范围从5到60天。测试中采用遍历的搜索方法，分别计算不同参数匹配下的择时交易情况。

DMA指标的测试也采用DMA与AMA的交叉进行择时交易，具体操作法则如下：

其中，Signal＝1表示买进，Signal＝0表示卖出。

测试参数包括计算DMA的长期均线天数L，短期均线天数S和DEA的计算天数M，在每个测试期间里，S以2天为间隔，测试范围从2天到20天；L以5天为间隔测试范围从20到120天；M以5天为间隔，测试范围从5到60天。测试中采用遍历的搜索方法，分别计算不同参数匹配下的择时交易情况。

TRIX指标的测试采用TRIX及其均线MATRIX交叉进行择时交易，具体操作法则如下：

其中，Signal＝1表示买进，Signal＝0表示卖出。

测试参数包括计算TRIX的天数N，以及计算MATRIX的天数M。在每个测试期间内，N以2天为间隔，测试范围从2天到20天；M以5天为间隔，测试范围从20到120天。测试中采用遍历的搜索方法，分别计算不同参数匹配下的择时交易情况

从4个趋势型指标的独立择时交易情况来看，通过调整指标计算参数，均可获得较好的择时效果。以4个指标的最优参数择时效果来看（如表3-2所示），在相对较长的时期内均能稳定战胜买入并持有策略下的交易收益，并且风险调整收益也更具优越性。其中，MA、MACD和TRIX的择时交易次数要明显低于DMA指标，因此，如果考虑交易费用，DMA的择时效果会打折扣。

表3-2　4个趋势型指标最优参数下的独立择时交易表现比较 

资料来源：［易海波　2010］

3．组合指标择时策略

单个指标的择时效果从某种程度上讲具有较大的偶然性，并且效果优劣和参数的选择有很大关系，为了增强择时的稳定性和鲁棒性，这里考虑将4个趋势型指标的择时策略结合起来，构建一个综合性的趋势型指标择时模型。

在前面的单指标择时测试中，每个具体策略都会产生一个信号序列，即前面的Signal变量，其数值为1或0，这里将4个指标最优参数策略下的Signal变量叠加起来，构成一个新的信号变量，记为Flag，显然Flag的取值范围为｛0，1，2，3，4｝。假如在某个时点Flag为0，则表示4个指标在此刻均发出卖出信号；如果Flag为1，则表示有1个指标发出买入信号，3个指标为卖出信号，依此类推。

根据历史数据测试，考虑1％的双边交易费用，包括费税成本和冲击成本，测试结果显示（如表3-3所示），由于交易过于频繁，后面几种择时策略的收益惨不忍睹。由此可见，只有在择时准确率和择时频率之间进行权衡，才能找到一种最优的择时策略。就上面的趋势型指标综合择时而言，最优的择时策略是3-3组合，即最少3个买入信号和3个卖出信号发出时进行相应的交易是相对最优的。在历史15年的测试中（如图3-1所示），总共进行了17次交易，累计收益达到16.39倍，同期指数收益只有2.8倍。

表3-3　有交易成本情况下不同信号个数下的综合择时策略 

资料来源：［易海波　2010］

图3-1　趋势型指标最优综合择时策略历史表现

资料来源：［易海波　2010］

从实证结果来看，趋势型指标确实具有较好的择时效果，当采用多指标组合后，可以在有效地降低风险的同时提高收益率。趋势型指标简单有效，往往可以抓住大的波段行情，获得超额收益。

3.1.3　自适应均线

上一节介绍的固定均线是最简单的情况，虽然效果很好，但是也有很大的缺点。通常均线总是有一个给定的参数，如10日均线、60日均线，其中10日均线变化快一点，60日均线变化慢一点。这个参数是由人给定的，一旦给定了，在整个画线的过程中不管行情怎么变动都不会变化。比如，在市场反复震荡时短期均线频繁地转向，而在市场快速上升或者下跌时长期均线反应迟钝，这就会造成频繁发出错误开平仓信号。

那么，能不能把均线做成自适应的，这样在行情反复震荡的时候慢一点，在行情快速变化的时候快一点跟上趋势？我们可以期待，因为一个自适应的系统有自动学习和自动调整的功能，应该比一个固定的系统做得更好一点。解决方案是有的，新的工具叫自适应均线，该均线由考夫曼所创造。

1．自适应均线的算法

1）价格轨迹的效率

一般来说，投资者都有这样的经验，就是在震荡多的走势上要使用较慢的均线，在趋势快速展开的走势上需要用更快的均线。

如何用数量化的办法来区分这两种不同的走势？这里需要引入一个价格轨迹效率的概念。

在行情的走势图中，可以大致分为两种走势：一种是一直上攻的走势，被称为高效率的，因为每一天收盘价格的变动都直接贡献于总的涨幅；另一种是反复震荡的走势，被称为低效率的，很多次收盘价格的变化相互抵消。类似于物理学中路程和位移的概念，如果走过的路程很长，但是位移很小，在实现位移的目标考量下，这样的运动可以称为低效率的。

很自然地，可以导出价格轨迹的效率定义：

假定在过去n个收盘价格分别为p1
，p2
，...，pn
，那么这个价格序列的效率为：

即位移和路程之比。

2）动态平均算法

动态平均是一个迭代的定义，比如时间序列yt
是另一个时间序列xt
的动态平均，意味着：

其中，参数a是每一步的加权因子，它可以随着时间的变化而变化，因而可以实现调节平均线的快慢而达到自适应的效果。

价格轨迹的效率E是给定长度的价格历史序列的统计特征，加权因子a应该随着E变化，其变化的法则可以设置成：

其中，c，d，δ都是新的参数，加上计算E必须用到的参数n，这个自适应系统有了4个参数，看起来比之前的固定平均线参数更多，更需要人工设置，但是这4个参数对不同的行情是不太敏感的，一旦设置好，可以适应更多种不同形态的行情。正如一个智能化的机械不可避免地会增加更多部件。

可以发现对于上证指数，最近5年用60日均线的效果很好（因为市场大起大落波段是清晰的），但是回溯到2005年前，市场的波动形态就不这么明显，60日均线就无法适应了。利用自适应均线，虽然参数较多，但在给定一套合适的参数下，可以做到既适合2005年后的市场，也适合之前的市场。

总结起来，自适应均线的算法如下：

（1）计算从当前收盘价起，最新的n个历史收盘价格的效率E。

（2）根据本节公式（3）计算a。

（3）根据公式（2）计算价格序列的动态平均。

2．利用自适应均线择时交易的实证

案例　自适应均线择时模型

根据自适应均线的买卖策略是：

（1）自适应均线自下向上拐头，买进。

（2）自适应均线自上向下拐头，卖出。

拐头与否可以这样定义，自适应均线的每一个周期的增长率如果从正值变为负值，即为下拐头；从负值变为正值，即为上拐头。

为了避免某些时候自适应均线频繁地拐头，可以设置一个很小的安全垫，自适应均线的每一个周期的增长率如果从正值变为负值，且和0的距离大于很小的常数即为下拐头；从负值变为正值，而且和0的距离大于同一个很小的常数，即为上拐头。

在图3-2中，自适应均线非常适合深证成指的周线趋势跟踪，市场的每一次较大的转折都能很快被自适应均线跟踪到，从而能够做出正确的决策。错误的扰动也有，比如2008年初的上拐，但是并不会造成大的损失。

图3-2　深证成指周线图与自适应均线（2007—2009年）

数据来源：D-Alpha量化对冲交易系统

假定买卖的对象是上证指数和深证成指，每一次买入或者卖出的交易成本计为0.3％，买入时满仓买入，卖出时空仓。自适应均线都采用同一套参数，拐头判断时用同一个保护垫大小。从1998年以来，在不同时间段内，一种是依照自适应均线法则买卖，另外一种是一直持有指数，所有收益率的计算都是根据周线收盘价格，然后对两者的收益率进行对比，如表3-4所示。

表3-4　自适应均线择时策略收益率分析 

数据来源：［曹力　2008］

可以清楚地看到，在3种不同的时间段内，考虑到交易成本，依照自适应均线的交易策略在总收益上明显地战胜了指数本身。

图3-3是自适应均线择时策略在深证成指上的收益率曲线图，图中的方波记载了策略仓位的变化，高位代表满仓，低位代表空仓。可以看到这个策略的调仓次数比较多，特别是在市场震荡频繁的时候，会引起该策略的仓位较频繁变化，这是因为自适应均线比较敏感。敏感的好处是能够更快地抓住市场趋势的变化，但弱点也很明显，就是信号过多导致交易过多。如果交易成本和冲击成本较高，则这个策略并不适合平衡市场。因为交易频繁的缺点，利用自适应均线交易的策略更适合于较小资金的调仓策略。

图3-3　自适应均线择时策略在深证成指上的收益率曲线

数据来源：［曹力　2008］

本节小结

趋势型指标择时是最简单，也是最有效的择时指标之一，通过对主要的趋势型指标的实证结果来看，以均线为主的择时策略具有明显的超额收益，可以抓到大的波段（不管是牛市还是熊市），但是在小波段震荡市的时候，由于频繁交易，容易造成连续错误和损失。

因为自适应的特点，自适应均线比固定均线在更多种不同波动形态的市场中能够有效跟踪趋势，即便在考虑交易成本的前提下，能够实现的超额收益也让人印象深刻。

3.2　市场情绪

◆摘要◆

A股市场正处于半强势有效阶段，个人投资者居多，由于缺乏时间、精力及知识能力去分析股票的投资价值，往往会受到周围人的影响，具有羊群效应。大盘上涨的时候，投资者情绪激动，一窝蜂地买入；大盘下跌的时候，投资者情绪低迷，一窝蜂地卖出，从而会造成市场趋势的持续。

市场情绪择时就是利用市场上投资的情绪指标来判断大盘在未来一段时间走势的策略，情绪指标包括投资者信心指数、折溢价率、新股数据、投资者行为等。

3.2.1　基本概念

人们天生是趋利避害、厌恶风险的，当市场上涨时，激发了人们的投资情绪和投资比重，投资者变得贪婪，从而助长了上涨趋势，这种相互正反馈效应使股市节节攀升，形成股市高估。反过来，市场下跌时，投资情绪低落形成恐慌心理而对投资失去信心，纷纷卖出股票也会影响股市，造成股市低估。因此，很多投资大师认为心理情绪造就90％的行情，即T（趋势）＝G（资金）＋P（心理）。

既然市场受情绪影响，那么根据市场情绪的波动将能够对投资进行指导。基于市场情绪的择时策略的思路如下：首先，捕捉市场情绪，即寻找能够反映市场情绪波动的指标，包括投资者信心指数、封闭式基金折溢价率等；其次，量化市场情绪，即采取主成分分析将这些指标合成一个情绪指数，寻找能有效反映市场情绪的主成分；最后，应用情绪指数，根据市场情绪指数的特点来指导投资的择时策略。

市场中反映投资情绪的指标比较多，指标归类后具体如表3-5所示。

表3-5　市场情绪类别 

资料来源：［罗业华　2010］

从数据分析可以发现，单个指数的缺点是无法全面反映真实市场情绪，有时候受到政策因素的影响而出现数据缺失，如新股发行等。另外有些指标可能不是真实的数据，比如基金仓位，都是根据历史数据估算出来的，可能与真实值存在偏差。因此，这里只选取封闭式基折价率、转股溢价率、IPO首日涨跌幅、IPO发行PE、上涨家数百分比、混合型基金平均仓位、股票型基金平均仓位7个指标，以此来反映市场整体的情绪水平及变化，具体如下。

1．直接调查

为了直接获得投资者的情绪状况，国内外许多机构采取直接问卷调查的方式，比如耶鲁大学与北京大学中国经济研究中心在2005年推出了《耶鲁-CCER中国股市投资者信心指数》，基于由耶鲁大学罗伯特·希勒教授首先发起的投资者信心指数调查，针对中国的投资者信心指数调查提供了一个全新的信息来源。

招商证券股份有限公司联合国务院发展研究中心金融研究所也发布了《中国城市居民投资信心及投资意愿指数报告》。该报告调查数据由全球著名的尼尔森市场研究公司执行，在上海、广州、北京、深圳、成都、杭州、武汉、长沙、南宁、昆明、西安、兰州、太原、沈阳、青岛、大连16个城市进行，共收集了2100个样本，收集时间为2008年9月16日至10月5日。每季度发布一次，调查居民未来3个月的整体投资市场信心，其中有关于股票基金市场的投资信心指数。

2．折溢价率指标

折溢价率是反映市场情绪的重要指标，市场情绪较高则折溢价率较高，市场情绪较低时则折溢价较低。权证受市场投机影响价格波动较大，能够反映市场情绪，但是由于品种少、到期期限不同，因此其代表性不是很强。这里选取了转债转股溢价率和封闭型基金的折价率来反映市场情绪。由于转债的市场规模较大，所以转债转股溢价率相对于权证更具有代表性，更能反映机构投资者的投资行为。

3．新股指标

新股是指通过IPO新上市的公司，其上市首日涨跌幅和市场定价一般受市场情绪的影响。如果市场情绪高昂，则涨幅较大，PE也很高；如果市场情绪低迷价较低，则上市有可能跌破发行价，市场参与者较少，公司上市意愿不强，IPO数量减少，同时政策也将会停止新股审批。因此新股一些指标能够有效地反映市场情绪。下面的月度数据都是对当月所有IPO进行算术平均计算出来的。

4．市场指标

市场指标包括很多方面，有资金流量，有创新高、新低股票，有涨停家数等，这里主要取上涨家数百分比指标。

5．投资者行为

投资者行为是指投资者的投资意愿，主要包括新增开户数、基金仓位、卖空比例、保证金交易、资金出入等。目前能够获得的数据主要有基金仓位的变化，该数据是通过回测股票（混合）型基金整体市场的风险（β值）变化来体现基金仓位的变化。

3.2.2　情绪指数

1．情绪指数的构建

单个情绪指标只能针对市场某个细分部分反映投资者的情绪水平，整体来看是过于碎片式的，可能仅反映了不同的投资者情绪或某一方面（比如封闭式基金折价率更多地反映了个体投资者情绪，基金仓位则主要反映机构投资者的情绪等）。

为了综合测量市场整体的情绪水平及变化，这里运用主成分分析法，将7个指标（封闭式基金折价率、转股溢价率、IPO首日涨跌幅、IPO发行PE、上涨家数百分比、混合型基金平均仓位、股票型基金平均仓位）进行分析，并最终构造了度量投资者情绪的复合指数，分别为情绪指数及情绪变化指数，以此来反映市场整体的情绪水平及变化。

（1）市场情绪指数构建如下：

情绪指数＝0.111×封闭式基折价率－0.242×转股溢价率＋0.489×IPO首日涨跌幅＋0.437×IPO发行PE＋0.207×上涨家数百分比＋0.470×混合型基金平均仓位＋0.483×股票型基金平均仓位。

（2）情绪变化指数是将7个指标的月度变化数据进行主成分分析得出的结果，第4个主成分与指数变化相关系数最高（0.62），该指数将能够反映情绪的变化。其公式如下：

情绪变化指数＝-0.281×Δ封闭式基金折价率－0.527×Δ转股溢价率－0.299×ΔIPO首日涨跌幅－0.293×ΔIPO发行PE－0.196×Δ上涨家数百分比－0.654×Δ混合型基金平均仓位－0.041×Δ股票型基金平均仓位。

2．情绪指数当期收益率分析

建立好情绪指数之后，按照1倍标准差（σ＝1.6）将其分为4个区域：σ以上、σ到0、0到-σ、-σ以下，分别标注为1，2，3，4。从2003年6月到2010年7月共计86个月，位于4个区域的月份数占总月份的比重分别为16.28％、31.40％、36.05％、16.28％。然后分别统计位于这4个区域的沪深300指数的月平均收益率。

从表3-6可以看出，位于区域1、2的平均收益率明显比区域3、4的平均收益率要高，同时比总的平均收益也要高。从表中还可以看出，位于区域1、2的正收益月份占比明显比区域3、4高，并且比总的正收益月份占比高，而区域4的正收益月份占比只有28.57％，表现最差。

表3-6　沪深300指数在不同情绪区域的当月收益率比较 

资料来源：［罗业华　2010］

情绪变化指数也按照其标准差（σ＝1.04）分为4个区域，分别为命名为1、2、3、4，位于这4个区域的月份占总月份数的比重分别为12.79％、43.02％、30.23％、13.95％。从表3-7中可以看出，位于区域1、2的平均收益率也明显高于位于区域3、4的平均收益率，也高于总的平均收益。其中位于区域1的正收益月份占比高达90.91％，而区域4则只有33.33％的正收益月份占比。

表3-7　沪深300指数在不同情绪变化区域的当月收益率比较 

资料来源：［罗业华　2010］

从直接调查的信心指数到统计的情绪指数及情绪变化指数可以看出，市场情绪受最近的市场状况影响较大。情绪指数与当月收益率的相关系数为0.48，与下月收益率相关系数为0.12。而情绪变化指数，在高情绪区域1的上涨月份高达90.91％，在低情绪区域4的上涨月份只有33.33％，这些都说明情绪指数变化受单月影响很大。

3.2.3　实证案例：情绪指标择时策略

1．市场情绪对未来的影响

情绪指标受当期市场影响较大，那么其对下期的影响如何，是继续延续原来走势还是出现反转效果呢？按照上面的分类方法对指数下月回报进行了统计。从统计的结果（如表3-8所示）可以看到，区域3的平均收益率最差，区域1的平均收益率最好，区域4的平均收益率比单月明显提高很多。也就是说，在情绪高涨区域，高涨的情绪会得到延续；在情绪低迷区域会继续低迷，但是如果是非常低迷，就有可能反转，因为市场会纠正因情绪带来的过度反应。

表3-8　沪深300指数在不同情绪区域的次月收益率比较 

资料来源：［罗业华　2010］

对情绪变化指数的下月指数回报进行了统计，从统计的结果（如表3-9所示）可以看到，区域4的平均收益率最好，区域2的平均收益率最差，其他区域与总的均值没有明显的差异。也就是说，在情绪高涨乏力时，其下月收益会较差；在当月市场情绪非常低迷时，其下月反弹可能性极大，因为市场会纠正因情绪带来的过度反应。

表3-9　沪深300指数在不同情绪变化区域的次月收益率比较 

资料来源：［罗业华　2010］

2．择时投资策略

案例　情绪指标择时策略

根据情绪指标的特点及对下月收益的影响，可以有两种择时的方法：长期看区域和短期看变化。即在大周期内，情绪指数能够明显地反映股票水平处在历史的阶段，在低风险（情绪低迷）区购买股票，在高风险区（情绪高涨）卖出股票，反情绪周期操作。在短期则看情绪变化，主要是剔除区域3的月份，将能够获得较高的收益。

1）长期看区域

尽管恐慌和贪婪情绪会对市场造成很大的影响，但是无法改变市场的大趋势。从大周期看，情绪低迷时股市被低估，情绪高涨时股市被高估。彼得林奇的鸡尾酒会理论也正是反映这样一个现象。因此根据市场情绪周期来判断股市的周期，在市场情绪处于低迷时购买股票；在市场情绪处于高涨时卖出股票。当然情绪高涨（低迷）的积累是一个长期的过程，因此反转的过程可能非常漫长，这就无法确认精确的高点和低点，只能判断一个顶部或者底部区域。根据长期反转策略进行投资，必须有足够的耐心和意志，坚持长期投资的观念。

从图3-4来看，要预测一个准确的拐点很难，但是通过情绪指数的一倍标准差能够将市场分为几个明显的区域，投资决策就变得简单了。以一倍标准差作为分界线，在“上界”以上区域是高风险区，作为长期投资应该谨慎；在“下界”以下为安全区域，投资者大胆介入将能获得较高的安全边际和收益。

图3-4　情绪指数长期风险区域

资料来源：［罗业华　2010］

2）短期看变化

如表3-10所示，一般情况是在情绪高涨区域会继续表现较好，在情绪低迷区域会继续表现低迷，但是极端低迷时可能会出现反转。贪婪和恐慌情绪会对市场造成短暂影响，使投资者对新信息反应过度或不足，从而造成股票短暂高估或者低估，随着时间推移市场会纠正这种过度反应，主要表现为当市场上涨过度时便会回调，当市场下跌过度时可能会反弹。我们可以根据情绪对市场的短期冲击的特点来进行投资。

表3-10　情绪指数择时收益率统计 

资料来源：［罗业华　2010］

由于情绪指数的短期变化较小，不利于短期择时。而情绪变化指数可以有效地弥补这个缺陷，根据统计发现，位于区域2的月份收益率非常差，因此在择时把最差的月份去掉，选择其他区域的月份，将能够获得较高的超额收益。如图3-5所示为情绪指标择时策略收益率曲线。注：以沪深300指数作为择时指数，时间为2005年1月至2010年10月。

图3-5　情绪择时策略收益率曲线

资料来源：［罗业华　2010］

本节小结

通过量化分析后的情绪指数择时策略：“短期看变化，长期看区域”，确实能够获得较好的超额收益。当月的情绪对下月的影响各不相同，在情绪指数高涨区域会继续表现较好，在情绪低迷区域会继续表现低迷，但是极端低迷时可能会出现反转。贪婪和恐慌情绪会对市场造成短暂影响，使投资者对信息反应过度或不足，从而高估或者低估股票，随着时间推移市场会纠正这种过度反应，主要表现为当市场上涨过度时便会回调，当市场下跌过度时可能会反弹。本策略就是根据情绪指数这一特点来指导投资决策。

3.3　时变夏普率

◆摘要◆

Tsharp值［Time-varying Sharpe Ratio］由Robert F.Whitelaw （1994.1997）首次提出，与夏普比率类似，其表示单位风险的超额收益，不同的是前者的收益率与方差系通过回归方法而得，因此其呈现随时间改变的特性。Tsharp值通常与经济周期反方向运动，简单地说就是当经济运行至高位时夏普比率较小，反之亦然。反映在股市里，Tsharp值则可以作为择时指标指导市场与投资决策。

3.3.1　Tsharp值的估计模型

1．基本概念

Whitelaw（1994）研究表明，股息收益率、BAA-Aaa息差、票据-国库券息差、一年期国债利率对标普指数的收益率均值和收益率的方差有显著的预测作用。将模型设定为：

其中，Rt＋1
表示指数在（t＋1）期的收益率，Rf
表示无风险利率，∈1，t＋1
表示方程（1的残差项，Xf
表示由股息收益率、BAA-Aaa息差、票据-国库券息差、一年期国债利

率组成的解释变量矩阵，β和γ是模型回归系数。

其中，
和
为模型中β和γ的模型参数估计结果，St＋1
为（t＋1）时刻的Tsharp值。

2．Tsharp值与指数的关系

Whitelaw（1994）的研究中选取1953年4月到1995年12月的月数据，利用文中叙述的Tsharp值作为择时指标，获得了比长期持有指数稳定的超额收益。

那么，在国内市场应用Tsharp值择时是否会产生超额收益？考虑到国内市场的特殊情况，可以对模型有哪些改进？由于国内市场的实际情况，如不定期发放股息，商业票据数据期限较短。同时国内学术界也已证明存在对股市有解释作用的变量，如货币供应、储蓄等。在引入上述模型的过程中，本节对模型的解释变量进行调整，删除股息收益率、票据-国库券息差，增加M1、储蓄等。

这里选取的标的指数为上证综合指数，无风险收益率为活期存款利率。数据选取期限从1996年1月到2010年8月的月度数据，共176个样本点。

1）月度Tsharp值

将全样本月度数据按照Tsharp估计模型就可得到样本内每月Tsharp值。

如图3-6所示为1996年1月到2010年8月Tsharp值与上证综指走势图，从图中可以看出，Tsharp值与上证综指相关性较强，走势相反。Tsharp值越大，表示此刻指数处于低位，未来有上涨可能；反之Tsharp值越小，表示指数处于高位，未来有下跌风险。

图3-6　月度Tsharp值与上证综指的关系

数据来源：［程志田　2010］

2）季度Tsharp值

与月度计算Tsharp值类似，把样本数据替换为1996年1月到2010年8月的季度数据，共58个样本点。如图3-7所示为1996年1月到2010年8月季度Tsharp值与上证综指走势图，从图3-7中可以看出，季度Tsharp值与上证综指的走势也相反。

图3-7　季度Tsharp值与上证综指的关系

数据来源：［程志田　2010］

3.3.2　基于Tsharp值的择时策略

从上面的讨论我们知道，在时刻t，可以预测（t＋1）期的Tsharp值，而且Tsharp值与指数有很好的负相关性。下面我们讨论如何利用预测Tsharp值作为择时指标并构建择时策略，这里我们将得到的预测Tsharp值作为择时指标，观察该策略能否得到稳定的收益。

设计策略决策过程如下：

首先计算预测Tsharp值。观察模型我们可以发现，若要预测（t＋1）期的Tsharp值，只需选取一定的预测期n，回归模型需要的数据为Rt
，Rt－1
…，Rt－n＋1
和Xt－1
，Xt－2
…，Xt－n
，其中Xt－1
为（t－1）时刻的解释变量矩阵，Rt
为t时刻指数收益率，利用上述数据回归得到
和γ。利用公式（3）及Xt
就可得到（t＋1）期预测Tsharp值。

其次选取最优阈值。由于Tsharp值越大，表示此刻指数处于低位，未来有上涨可能；Tsharp值越小，表示指数处于高位，未来有下跌风险。所以我们的策略选取为当预测条件夏普比率高于某一阈值a时，把现金全部买入指数；当预测条件夏普比率低于某一阈值b（a＞b）时，把指数全部卖出，换取现金。分别以累计收益和买卖胜率作为优化目标，获得最优的阈值（a，b）。最后，在确定的最优阈值（a，b）的条件下，考查投资收益并与同期上证综指的收益进行对比。

3.3.3　实证案例

1．以月度为频率的Tsharp值策略

由于预测期n不同，对同一时间点的预测可能由于回归误差等原因导致得到的预测夏普比率不同。如图3-8所示为在不同的预测周期下得到的Tsharp值。从图中可以看出，预测期n越大，我们的预测越准确。

图3-8　不同周期下的预测Tsharp值

数据来源：［程志田　2010］

从图3-8中我们发现，每当Tsharp跳跃时，大盘反转的几率非常大，几乎每次Tsharp跳跃，大盘都会做出回应。由此，Tsharp值跳跃将作为我们判断大盘的趋势与反转的重大信号。

下面我们以预测期n＝60为例，选取两种最优投资目标，分别以买卖胜率和累计投资收益作为优化目标，选取最优的阈值结果如表3-11所示。

由表3-11可知，当n＝60时，若选择买入卖出胜率作为优化目标，可以得到最优阈值为（0.1，0.1），样本期内共发出买入信号55次，卖出信号61次。其中，买入信号成功41次，胜率为74.5％；卖出信号成功37次。累计收益615％，同期长期持有指数累计收益145％。若选取累计收益作为优化目标，可以得到最优阈值为（0.54，0.19），样本期内共发出买入信号33次，卖出信号66次。其中，买入信号成功27次，胜率为81.8％；卖出信号成功39次。累计收益697％，同期长期持有指数累计收益145％。

表3-11　月度Tsharp择时模型统计结果 

资料来源：［程志田　2010］

如图3-9和图3-10所示为当预测期n＝60时，两种优化目标下投资收益和同期上证综指的收益对比。可见，无论是哪种优化目标下得到的最优阈值，利用预测夏普比率择时的累计收益都远远高于同期上证综指的收益。

图3-9　月度Tsharp最大买卖胜率夏普比率策略收益曲线

数据来源：［程志田　2010］

图3-10月度Tsharp最大累计收益率夏普比率策略收益曲线

数据来源：［程志田　2010］

我们以得到的预测Tsharp值为解释变量，对上证综指的超额收益进行回归，结果如表3-12所示。可见，月度条件夏普比率对上证综指超额收益回归系数为正。所以当预测夏普比率越大时，对市场的看多程度也就越大；反之亦然。

表3-12　预测Tsharp值（月度）对上证综指的预测作用 

数据来源：［程志田　2010］

综上所述，在对月度进行择时时，建议以最大化累计收益为优化目标，即买入卖出阈值为（0.54，0.19）。而且预测Tsharp值越大，对市场的看多程度也就越大。

2．以季度为频率的Tsharp值策略

考察季度为择时频率时，我们采用的方法和月度类似。

如表3-13所示为预测期n＝24时，两种优化目标下的最优阈值。可见，若选择买入卖出胜率为优化目标，可以设定最优阈值为（0.43，0.43），样本期内共发出买入信号14次，卖出信号20次。其中，买入信号成功11次，胜率为78.6％；卖出信号成功14次。累计收益658％，同期长期持有指数累计收益136％。若选取累计收益为优化目标，可以设定最优阈值为（0.6，0.6），样本期内共发出买入信号12次，卖出信号22次。其中，买入信号成功10次，胜率为83.3％；卖出信号成功15次。累计收益734％，同期长期持有指数累计收益136％。

表3-13　季度Tsharp择时模型统计结果 

资料来源：［程志田　2010］

如图3-11和图3-12所示为当预测期n＝24时，两种优化目标下投资收益和同期上证综指的收益率对比。可见，无论是哪种优化目标下得到的最优阈值，利用预测夏普比率做择时指标的累计收益都远远高于同期上证综指的收益。

图3-11　季度Tsharp最大买卖胜率夏普比率策略收益曲线

数据来源：［程志田　2010］

图3-12　季度Tsharp最大累计收益率夏普比率策略收益曲线

数据来源：［程志田　2010］

和月度分析方法类似，可以将得到的季度预测Tsharp值为解释变量，分别对上证综指的超额收益进行回归，结果如表3-14所示。可见，季度条件夏普比率对上证综指超额收益回归系数为正。所以当预测夏普比率越大时，对市场的看多程度也就越大；反之亦然。

表3-14　预测Tsharp值（季度）对上证综指的预测作用 

数据来源：［程志田　2010］

综上所述，在以季度为择时频率时，建议以累计收益为优化目标，即买入卖出阈值为（0.6，0.6）。而且预测夏普比率越大，对市场的看多程度也就越大。

本节小结

本节对Robert F.Whitelaw（1997）提出的Tsharp值指标（以下简称Tsharp值）进行改良，使之适应A股市场，并针对上证综指进行分析，发现无论以月度或者季度为频率，Tsharp值与上证综指确实存在负相关性，并且其对上证综指的收益有显著的预测作用。

利用夏普比率与上证综指的负相关性，建立策略为设定最优阈值（a，b），其中a＞b，当预测夏普比率大于a时买入指数，当预测夏普比率小于b时卖出指数。以月度为择时频率时，买入卖出阈值为（0.54，0.19）。当预测夏普比率大于0.54时买入指数，当预测夏普比率小于0.19时卖出指数。买入成功率为81.8％，累计收益697％。以季度为择时频率时，买入卖出阈值为（0.6，0.6）。当预测夏普比率大于0.6时买入指数，当预测夏普比率小于0.6时卖出指数。买入成功率为83.3％，累计收益734％。

通过研究还发现，预测Tsharp值越大，对市场的看多程度也就越大；反之亦然。此外还发现，每当Tsharp跳跃时，大盘反转的几率非常大，几乎每次Tsharp跳跃，大盘都会做出回应。由此，Tsharp值跳跃将作为判断大盘的趋势与反转的重大信号。

3.4　牛熊线

◆摘要◆

正常情况下，价格在一定区间内属于一般波动，不具有方向性的特征，而一旦价格突破临界值即可视为方向性诞生，转势开始。因此可以定义两根线：一根牛线，一根熊线。如果股票上突破牛线，则可以认为是一波大牛市开始；如果股票下突破熊线，则可以认为是一波大熊市开始。在牛熊线之间则认为是震荡行情，没有方向性。

牛熊线择时就是基于这样一个原理，定义了牛熊线后，通过参数调整优化，可以获得比较好的择时效果。

3.4.1　基本概念

1．几何布朗运动与股市

1900年，法国数学家巴契里耶完成了自己的博士论文《投机理论》，这篇论文是历史上第一次有人尝试使用严谨的数学工具研究并解释股市的运动，他认为市场价格同时反映过去、现在和将来，但这些事件与价格变动却没有明显的关系。股价就像液体中的花粉受到周围投资者买卖的碰撞而呈现出波动，波动的范围与时间的平方根成正比。

具体到细节上，大致上可以从以下几个方面去理解：

1）交易行为与布朗运动

布朗运动的形式是粒子受到液体分子的撞击而位移，液体分子的运动是随机的、杂乱无章的，对于股市而言，大量的交易者对股票进行买与卖，就好比液体分子撞击粒子那样撞击股票，交易者代表的是人类个体，观点与行为也将杂乱无章。

2）估值与布朗运动

布朗运动的规律是粒子的运动与温度成比例，对于股市而言，估值与市场的温度也直接相关。当市场比较热时，估值一定会处于较高水平，投资者将不得不面对一个估值较高的市场。

3）市值与布朗运动

粒子的质量与其运动的幅度也是成比例的，所以中、小规模市值的股票很可能会获得更高的收益与波动风险。从基本面的角度分析也会有类似的结论，毕竟企业在基数较低时的扩张会更容易。

4）交易量与布朗运动

在温度较高的时候，布朗运动会加剧，粒子受到的撞击次数将大大增加，而股市里，当市场热情高涨时，交易量的急剧攀升（交易次数增加、换手率攀升）。

2．股价布朗运动数学表达式

迄今，普遍的观点仍认为：股票市场是随机波动的，随机波动是股票市场最根本的特性，是股票市场的常态。随机现象的数学定义是：在个别试验中其结果呈现出不确定性；在大量重复试验中其结果又具有统计规律性的现象。

描述股价行为模型之一的布朗运动之维纳过程是马尔科夫随机过程的一种特殊形式，而马尔科夫过程是一种特殊类型的随机过程，股价遵循Geometric Brownian Motion的随机过程：

3．股价布朗运动中方向性

如何寻找与辨别股价布朗运动中的方向性特征？择时的目的就是判断方向，若将股价视为布朗运动，那么该如何从定义为杂乱无章的布朗运动中辨识出方向呢？

不妨考查如下一段布朗运动：

考虑时间长度为T的一段布朗运动，假设在t0
时刻，股价为St0
，则在tT
时刻，股价将满足期望值为
，方差为σ的t分布，如图3-13所示。

图3-13　股价布朗运动示意

资料来源：［程志田　2011］

根据t分布的特性，通常股价将落在期望值附近，而离期望值较远的区域可能性则变小，往上往下皆如此。将期望值上下一定距离的股价位置设定临界值，即SUPlim
与SDownlim
，在SUPlim
tT
以上的区域称为强势区域，在SDownlim
tT
以下的区域称为弱势区域，两者之间的区域为一般区域。

3.4.2　策略模型

正常情况下，价格在一定区间内属于一般波动，不具有方向性特征，而一旦价格突破临界值即可视为方向性诞生，转势开始，定义如下：

BullPriceT
＝SUPlim
tT
＝F（S0
，μ，σ，T，P）

BearPriceT
＝SUPlim
tT
＝G（S0
，μ，σ，T，P）

由上式可见，牛势值与熊势值（BullPriceT
与BearPriceT
）将由S0
，μ，σ，T，P来决定（其中μ，σ，P的估计与设定非常重要，需要通过数学手段根据历史数据逼近获得）。

将各牛势值连接起来，则获得一条曲线，称之为牛线（Bullish Curve），与此类似，熊线（Bearish Curve）也将获得。

按照上述方法，可以做出上证综指的牛线与熊线，如图3-14所示。

图3-14　上证指数牛熊线

资料来源：［程志田　2011］

类似地，中小板指数的牛熊线也被描绘在图3-15中。由两图中的牛熊线与走势可以发现，上涨行情延续的重要特征就是股价始终在牛线之上，而熊线之下则伴随着股价的大幅下挫，股价在牛线与熊线之间时通常表现为盘整状态。

图3-15　中小板指数牛熊线

资料来源：［程志田　2011］

3.4.3　实证案例：牛熊线择时模型

根据牛熊线定义，可以得到具体的择时策略：

（1）若指数（股价）在牛线之上，认定指数（股价）处于强势状态，向上攀升态势形成且持续，系统性机会很可能来临。

（2）若指数（股价）在熊线之下，认定指数（股价）处于弱势状态，向下跌落态势形成且持续，回避系统性风险是非常明智且必要的。

（3）若指数（股价）在牛线与熊线之间，认定指数（股价）处于盘整整理状态，无大行情，也无大的系统性风险。

按照判定规则，回溯上证综指择时的情况，对上证综指在牛线之上给出买入评级，牛线之下回避系统性风险与盘整行情，给出卖出评级，结果表明择时效果非常优异。

（1）自2001年6月8日上证综指跌至牛线之下，卖出评级成立，成功规避了两年半的系统性下跌风险，中间仅出现了一次短暂的噪声交易（噪声交易指盈亏为0且短暂的交易）。

（2）直到2003年12月3日上证综指涨至牛线之上，才给出买入评级，把握了数年中唯一的一次长达4个月的系统性行情，持有至2004年4月6日卖出，然后规避了一年半的下跌行情。

（3）直到2005年12月26日，买入评级成立，除中间出现3次盘整行情，产生3次短暂的卖出买入评级外，成功把握了1156点到5828点的系统性大行情，一直持有至2007年10月18日5828点卖出，然后保持卖出评级，规避了历史上最大的下跌行情（6000点跌至1600附近）。

（4）持续到2009年2月4日才给出买入评级，持有至2009年7月29卖出，再次把握系统性行情。

（5）随后出中间出现一次噪声交易外，一直对上证综指保持卖出评级，直至2010年10月1日，上证综指再次涨至牛线之上，买入成立，且于2010年11月12日卖出，把握了一个月的脉冲行情。

如图3-16所示为在上证指数的牛熊线择时操作，红色箭头代表买入，绿色箭头代表卖出。

图3-16　上证指数牛熊线择时操作明细

资料来源：［程志田　2011］

如图3-17所示为牛熊线择时策略的收益率曲线。

图3-17　上证指数牛熊线择时收益率曲线

资料来源：［程志田　2011］

本节小结

总而言之，成功的择时指标应该具备3个要素：不错过大的系统性机会；能回避较大的系统性风险；能良好地辨别盘整状态。

本节中介绍的两条牛熊线则正是符合上述3个要素的量化择时指标，通过对股价运动的随机过程进行深入分析，可以将股价运动进行区分，即有方向性特征与无方向性特征。理论上，当方向性特征开始出现时，对其进行捕捉能实现较好的择时效果。设定阈值，突破阈值则认定为方向性特征开始出现，该阈值即本文中所述的牛线与熊线。从牛线与熊线的历史回溯分析来看，效果与预期的一致好。

3.5　Husrt指数

◆摘要◆

分形市场理论预示着股市具有分形结构，而这种结构恰能解释收益率分布呈现的尖峰胖尾特性。分形市场是一个既稳定又有活力的市场，整体的有序使得系统稳定，而局部的无序为系统带来活力，但又不影响系统的整体稳定性。所以可以用分形布朗运动来描绘股票分形市场，它是对布朗运动模型的推广。

根据分形理论，定义Hurst指数来判断趋势的拐点，将Hurst指数和大盘指数对比就可以发现，股市大盘走势具有长期记忆性，这成为Hurst指数择时的基本出发点。

3.5.1　基本概念

1．分形简介

分形（Fractal）的概念最早由美国数学家B.B.Mandelbrot于1967年提出，其原意为不规则、支离破碎的物体。数学中的Cantor集、Sierpinski垫、Koch曲线等都是经典的分形。自然界中的雪花、海岸线、树叶等也是分形的例子。简单而言，所谓分形，即指其任意局部与整体以某种形式相似，这种相似可能是近似的自相似或统计意义上的自相似。例如，我们用放大镜去观察雪花，会发现其内部由无数个小雪花组成，体现出自相似的特性。

分形理论是20世纪最伟大的科学理论之一，现已广泛应用于自然科学、社会科学、经济学、思维科学等多种领域。分形理论的出现对人们的自然观、科学观、思维方式等产生了积极、深刻的影响。有关分形理论的具体情况，请参见策略篇的第14章。

2．有效市场理论的困境

在对资本市场行为的研究中，随机游走理论和有效市场理论占有重要地位。随机游走理论认为资本市场价格的变动具有独立性、随机性、不可预测性。有效市场理论则认为，当资本市场价格的变动及时、迅速、准确地反映所有历史、公开及内幕信息时，资本市场是有效的。这两个理论均假设资本市场具有如下统计特征：价格序列相互独立且服从正态分布；价格序列为线性时间序列。

有效市场假说认为市场中每个投资者都是理性的投资人，而且证券价格既反映了标的资产的所有信息，又反映了投资人对证券供求的平衡。有效市场理论虽然形式完美，但其假设过于理想化，与资本市场实际情况出入较大。在现实资本市场中，并非所有的投资者都是理性的，不同投资者有着不同的投资偏好及投资能力，进而导致他们对证券价值及市场走势有着不同的预期，另外，信息对投资者及证券价格的影响并非总是及时、线性的。

因此证券市场本身是一个非线性系统，这就导致形式完美的有效市场理论往往无法解释现实资本市场中出现的种种异常现象，如低市盈率效应及小公司效应等。

3．分形市场理论

分形市场理论强调市场流动性及投资期限对投资者市场行为的影响，分形市场理论认为，资本市场由大量具有不同投资期限的投资者组成，且信息对不同投资者的交易周期有着不同的影响；资产价格的变化并非随机游走，而是具有增强趋势的持久性，今天或未来的资产价格变动与初始状态之间并非相互独立，而是具有持续相关性。

市场的稳定性主要取决于市场的流动性，且证券价格既反映了短期技术面，又反映了长期基本面，分形市场理论更加符合金融市场的实际统计特征，有效市场理论可以认为是分形市场理论的特例。

分形市场理论预示着股市具有分形结构，而这种结构恰能解释收益率分布呈现的尖峰胖尾特性。分形市场是一个既稳定又有活力的市场，整体的有序使得系统稳定，而局部的无序为系统带来活力，但又不影响系统的整体稳定性。

分形布朗运动用来描绘股票分形市场，它是对布朗运动模型的推广，其数学模型如下：

B（t）H为随机过程，若B（t）H满足：

则称BH
（t）为分形布朗运动，其中，0＜H＜1；BH
（0）为常数；B（S）为布朗运动。

可以看到，当H＝1/2时，B（t）H为布朗运动，即随机游走模型；当1/2＜H＜1时，未来增量与过去增量正相关，随机过程具有持久性；而当0＜H＜1/2时，未来增量与过去增量负相关，随机过程具有反持久性。

3.5.2　策略模型

如图3-18所示为上证指数与对应Hurst指数的关系。

图3-18　上证指数与对应Hurst指数关系

资料来源：［高钢杰　2012］

用Hurst指数并不能精确告诉我们具体哪一天市场开始反转，但大致位置和市场的反转时间惊人的吻合，所以完全可以把移动Hurst指数的低位（小于0.55）当做市场酝酿反转的一个重要参照指标。

移动Hurst指数的低位和市场反转期的吻合并不是一个偶然现象，因为中国的股票市场并不能完全达到有效市场假设的要求，在熊市和牛市的更替中，市场表现出了对趋势的长期记忆性，使得市场的运动明显偏离了没有记忆的随机运动。

而Hurst指数正是描述市场长期记忆性强弱的指标，Hurst指数越高，表明市场对趋势的记忆性越强，Hurst指数越低，对趋势的记忆性越弱，当H＝0.5时，时间序列是完全没有记忆的。每一次市场反转时，意味着前期的趋势弱化，被市场忘记，那么对应的Hurst指数应该降下来。所以市场反转期对应的Hurst指数接近0.5是完全合乎逻辑的。

3.5.3　实证案例

1．A股市场的长期记忆长度

首先考察上证综指及深成指的平均循环周期，即长期记忆长度。所谓长期记忆长度，即当1/2＜H≤1时序列呈现出长期记忆性，而该记忆长度是有界的；假设记忆长度为m，则当n＞m时序列的记忆将会减弱直至消失，进而用重标极差法计算得到的Hurst指数处于被低估的状态。在重标极差分析过程中，伴随着n的不断增大，将出现Hurst指数的峰值，此时的n可认为是序列的平均循环周期。

利用上一节中的算法对上证综指及深成指的Hurst指数进行计算，数据样本选择1997年1月3日至2010年6月1日标的指数的日收益率数据（对数收益率）。可以看到，上证综指及深成指的Hurst指数峰值均出现在n＝233的位置（如图3-19所示），对应的Hurst指数均为0.61，表明A股市场具有长期记忆性，因此可以认为沪深两市的平均循环周期为233个交易日。

图3-19　上证和深成指R/S分析——平均循环周期

资料来源：［高钢杰　2012］

2．利用Hurst指数进行市场择时

如图3-20所示为1999年初至2010年5月上证综指的Local Hurst指数，图中E（H）为Hurst指数的期望值。E（H）的算法与H的算法类似，即对ln｛E［（R/S）n
｝及ln（n）应用最小二乘法回归求得。对于E［（R/S）n
］的计算我们采用Peters的方法：

图3-20　上证综指-Local Hurst指数

注： 
黑色实线表示卖出信号；紫色虚线表示买入信号

资料来源：［曹源　2010］

这里设计如下择时投资策略：

（1）发出买入指令时，全仓买入市场指数。

（2）发出卖出指令时，空仓市场指数。

（3）Local Hurst指数连续5个交易日低于E（H），且此时市场指数较233个交易日前表现为上涨；若此时处于满仓状态，则于第6个交易日发出卖出指令；若此时处于空仓状态，则不进行操作。

（4）Local Hurst指数连续5个交易日低于E（H），且此时市场指数较233个交易日前表现为下跌；若此时处于空仓状态，则于第6个交易日发出买入指令；若此时处于满仓状态，则不进行操作。

该策略于1999年1月4日全仓买入市场指数，并根据上述择时策略进行投资。由图3-20可以看到，1999年初至今，上证综指共发出3次卖出信号，2次买入信号；深成指共发出4次卖出信号，3次买入信号。

1999年初至最近一次发出指令日（上证综指为2009年7月29日，深成指为2009年8月6日，皆为“卖出”指令），如图3-21所示。

图3-21　深证成指-Local Hurst指数

注： 
黑色实线表示卖出信号；紫色虚线表示买入信号

资料来源：［曹源　2010］

上证综指的累积收益率为190.14％，利用择时策略买卖上证综指获得的累积收益率为403.44％；深成指的累积收益率为367.30％，利用择时策略买卖深成指获得的累积收益率则达到了异常可观的1820.37％。

本节小结

总而言之，分形市场理论强调市场流动性及投资期限对投资者市场行为的影响，更加贴近实际资本市场。我国A股市场的日收益率并不服从正态分布，而是呈现出尖峰及左偏的统计特征，相对于传统的有效市场理论，分形市场理论更加适合描述现实中的资本市场。

利用Hurst指数择时策略，确实可以大幅度战胜市场，获得超额收益。Local Hurst指数择时策略较适合长期投资者。

3.6　支持向量机

◆摘要◆

支持向量机（SVM）是目前很流行的一个数学方法，主要用于分类与预测。择时本质上是一个预测过程，即利用过去的数据预测未来一段时间大盘是上涨还是下跌。但是市场是非线性的，使得传统的线性预测方法效果不佳。由于SVM独特的机制和效果，对非线性预测有非常好的效果，因此利用SVM技术来建立择时模型，可以有效地避免传统回归模型的精度和扩展性问题。

3.6.1　基本概念

在传统的金融分析和理论中，所采用的决策模型往往都是建立在苛刻的假设条件下的，形式上就是一些简单的数学公式。虽然这些简洁的模型很容易理解和解释，但在精度和解释力度上往往偏离了实际情况，金融数据挖掘技术的运用从某些意义上来讲可以突破这些限制，得到更实用、更贴近现实的预测结果。

单就股票市场而言，其中的金融规律复杂，影响因素较多。就其影响因素总体而言，影响股市的变化趋势主要包括国家的经济趋势、股市中的资金状况、股市的市场信心等。最终导致金融变量的取值可能会和很多因素有关，并且其中的相关关系可能是线性的，也可能是非线性的。具体到量化模型而言，有些关系能够用初等函数来表示，而另一些可能没有办法用数学形式来表示。

金融数据中所包含的规律往往时效性非常强，随着时间的推移和环境的变化，金融序列中所蕴含的规律在不断更迭。例如，在熊市中的某些规律往往到了牛市就不再起作用了，传统模型对于金融序列的动态性就束手无策了，而运用数据挖掘技术可以在不断地获得新数据后动态更新以适应新的环境。

而支持向量机（SVM）作为数据挖掘领域应用于模式识别的新技术，它克服了传统的统计模式识别方法存在的缺点，因此其具备良好的机器识别能力。

传统的统计模式识别方法的缺点如下：

（1）传统的统计模式识别方法，只有在样本趋向无穷大时，其性能才有理论的保证。

（2）传统的统计模式识别方法，包括BP神经网络等，在进行机器学习时，强调经验风险最小化。而单纯的经验风险最小化会产生学习问题，其推广能力较差。

（3）传统的统计模式识别方法存在局部极小值的问题。

而作为支持向量机的理论基础——统计学习理论，则是小样本统计估计和预测学习的最佳理论，它解决了传统方法存在的以上问题。有关SVM的理论知识，在第13章中有详细阐述。

3.6.2　策略模型

支持向量机目前主要用来解决分类问题（如模式识别、判别分析）和回归问题，股市行为预测通常为预测股市数据的走势和预测股市数据的未来数值。

将走势看成两种状态（即涨、跌），问题便转化为分类的问题，一类是涨，一类是跌。而预测股市未来的价格是典型的回归问题，因此有理由相信支持向量机可以对股市进行预测。

1．择时模型设计的总体思路

择时模型必须具备记忆性、自学习性、容错性、快速易用性等特点，具体说明如下。

（1）记忆性：对输入的样本数据具有存储功能，可随时调用、类比、验证。

（2）自学习性：随着外部信息的增加，系统能不断学习新知识，并对其已有知识进行优化。

（3）容错性：在输入样本数据不完备或带有噪声的情况下，系统能得出较为准确的估算结果。

（4）快速易用性：对用户具有友好的界面，能快速给出估算结果，且系统易于移植。

2．模型设计

利用SVM技术对股票价格进行预测主要包括训练数据准备、训练参数输入、学习样本输入、模型训练学习、评估训练结果、训练参数优化等一系列循环的过程，如图3-22所示。

图3-22　基于SVM择时模型流程

（1）在数据准备阶段主要是对预测指标的选定和已有历史数据资料的收集，并确定股票价格影响的输入向量。

（2）训练参数输入阶段的任务主要是确定SVM模型的参数γ和σ（以RBF核函数为例）。如果是初次运行，则可以随意地预定义上述两个参数的值；但如果是重复运行多次，这时训练参数优化的步骤便开始起作用。

（3）学习样本输入阶段的任务是将学习样本进行标准化，处理公式为：

其中，
为xi
分量的平均值，σ为xi
分量的标准差。在完成标准化工作后，将样本集任意地分为训练样本和测试样本，分别用于模型训练和精度检验。

（4）模型训练阶段包括：对输入的训练样本进行训练，得到模型的初始值a和b；然后利用上述算法提取出有效的、相关的数据点重新训练，得到最终的模型。

（5）训练结果评估阶段是对训练得出的模型推广（或称泛化）能力进行验证。所谓推广能力，是指经训练（学习）后的模型对未在训练集中出现的样本（即测试样本集）做出正确反应的能力，通常用平均平方误差（MSE）表示。

如果得出MSE结果较小，则说明该评估模型的推广能力强，或泛化能力强，否则就说明其推广能力较差。另外，也可以用平均绝对百分误差（MAPE）来衡量。当然还有很多其他的衡量指标，如误差绝对值的最大值、误差绝对值的平均值等。

择时问题本质上可以看做是一个分类问题，即将未来的走势分类为“涨”、“跌”两大类。SVM的一大优势就是解决了传统分类方法，如人工神经网络的次优陷阱问题，这使得SVM成为最近10年来最受关注的数学方法。

3.6.3　实证案例：SVM择时模型

在本实证中，采用SVM方法，首先通过对股指期货标的沪深300指数进行预测分析，来对市场短期趋势进行择时判断。

最传统的择时方法是技术指标，考虑市场行为的各个方面，建立一个数学模型，给出数学上的计算公式，得到一个体现股票市场的某个方面内在实质的数字，该值就可以指导实际的投资。指标可以分为“大势型”、“超买超卖型”、“趋势型”、“能量型”、“成交量型”、“均线型”、“图表型”、“选股型”、“路径型”、“停损型”等类别。

研究这些技术指标的特点，可以发现大部分指标是用来描述市场价和量的关系的。如均线系统，比较的是不同周期的均线的关系，KDJ指标比较的是最高价、最低价与当前价格的关系，布林线是比较当前价格与历史价格波动区间的关系。因此不难得到启示，提炼技术指标用于计算的基本要素，然后把这些基本要素作为SVM的输入向量。笔者提炼出的指标如表3-15所示。

表3-15　SVM择时模型的指标 

数据来源：D-Alpha量化对冲系统

SVM解决的是分类问题，而对于股市来说，如何分类也是一个非常复杂的问题。如果简单地把未来的涨跌作为分类的标准，就会把微小的涨幅和微小的跌幅也放入投资的策略中，可能收益都无法覆盖冲击成本和交易成本。以预测未来一周的市场状况为例，一周的市场状况可能是：持续上涨；持续下跌；先涨后跌；先跌后涨；平稳震荡。虽然从图形上看，这些状态可以大概做个分类，但是从图形的数学识别来说，很难定义这些类别。因此分类还需要简化，但又要从实际利于投资的角度来进行分类。笔者把分类定义为上涨和下跌。

综上所述，SVM模型的输入为过去3周表3-11所示的指标，输出为未来一周是涨还是跌，移动滑窗为每日移动。计算的过程是：

（1）计算每日8个输入指标。

（2）当前日期为T日，样本期为T-200到T-1日，找到样本内最优的SVM模型的参数。

（3）利用T日的输入指标预测输出指标。

（4）如果预测分类为1，则在市场行情低于T日收盘价时买入，如果涨幅超过2％则卖出，否则到T＋5日平仓。反之，做空也可以。如表3-16所示是SVM模型的样本外预测的多空方向和真实情况的对比。但是该表并不能代表真正的预测准确率，表3-17才表明在真实情况为多和空的方向上，预测值正确和错误的概率。

表3-16　SVM模型样本外预测多空次数 

资料来源：D-Alpha量化对冲系统

表3-17　SVM模型样本外预测准确率 

资料来源：D-Alpha量化对冲系统

从表3-16和表3-17中看出，SVM模型对多的方向的预测效果好于对空的方向的预测。这与我们日常感觉也是比较一致的。如果根据这个结果得出我们只做多不做空的策略，那就存在过拟合的风险。但是可以通过策略的止损和止盈来保证趋势交易策略有比较稳定的收益率曲线。

如图3-23所示的就是根据SVM模型的预测结果，对沪深300指数进行多空操作的收益率曲线。时间为从2005年11月15日到2011年5月3日，交易周期为一周，采用被动挂单的方式，等待价格到达合适的位置，止盈为2％，止损为浮亏超过2％。如果没有触及止盈和止损线，则以最后时刻平仓。7年的时间净值从1增长到4.77，策略的夏普率也很稳定，具体的评估参数如表3-18所示。

图3-23　SVM模型趋势交易策略收益率曲线

资料来源：D-Alpha量化对冲系统

表3-18　SVM模型趋势交易策略评估 

资料来源：D-Alpha量化对冲系统

从表3-18中可以看出，SVM的择时交易策略能够稳定地获取绝对收益，并且每年的夏普率都保持在较高的水平。下面将2005—2011年的数据区分为上涨市和下跌市，比较在不同的市场下SVM模型的择时策略的效果。

1．上涨市

我们将2005—2011年的数据人为地划分为上涨和下跌两种状态，选取2005年11月10日到2007年10月16日、2008年10月28日到2009年8月4日两个时间段为上涨周期，同样用上面的思路进行策略验证。如图3-24所示是上涨周期中SVM策略的收益率曲线。

图3-24　上涨周期SVM模型趋势交易策略收益率曲线

资料来源：D-Alpha量化对冲系统

在这段市场，SVM模型策略的收益率为指数的142％。从图上看整体，虽然策略远远跑输沪深300指数，但是收益率曲线波动也比较小。

2．下跌市

选取2007年10月17日到2008年10月27日、2009年8月5日到2011年5月3日两个时间段为下跌周期，同样用上面的思路进行策略验证。如图3-25所示是下跌周期中SVM策略的收益率曲线。

图3-25　下跌周期SVM模型趋势交易策略收益率曲线

资料来源：D-Alpha量化对冲系统

在下跌周期中，SVM模型策略的收益率为指数的96％，但是由于模型对下跌周期的预测准确率较高，在单边下跌市场中，该策略存在很长时间不赚钱的情况，也有比较大的回撤。而同期市场下跌惨烈，累积幅度达到80％以上。

本节小结

择时模型从理论上可以看做是一个分类问题，即将未来市场的走势分为“涨”、“跌”两大类，因此传统的各种分类理论和技术均可用于解决该问题，如决策树理论、贝叶斯分析法、关联规则法、神经网络法等。但是分类问题一个最大的问题就是分类模型在样本外的推广，即在样本内数据训练学习出来的分类策略在样本外往往不能获得较好的结果。

SVM作为最近10年很受关注的一个数学理论，在分类问题上得到了广泛的应用，如语音识别、生物特征识别等。当然，最新的研究自然也会用在金融市场，尤其是用于择时分析。

本节给出的案例中显示，SVM在单边市场有着较高的预测精度，在单边上涨和单边下跌市场，其预测精度均在50％以上，对于上涨周期的预测精度达到了70％以上。

利用SVM进行投资，特别要注意当SVM出现较为集中的失误时，需要引起重视，因为这很可能意味着市场的拐点已经到来。本书中仅对市场的短期趋势做了预测，也就是以周为投资周期，SVM模型同样可以适用于高频的行情预测及市场长期趋势预测中。但是对于高频行情数据来说，SVM模型复杂的参数优化过程要求更快的计算速度，而对于长期趋势的预测，一个错判就会导致比较大的损失。因此，笔者认为SVM模型适宜的投资周期为日间的短期趋势。

该模型在牛市中虽然不能跑赢指数，却能够在不同的市场中获得高夏普率的稳定收益率。由于模型是滚动优化参数的，需要每日操作之前对模型参数重新进行优化，才能得到更好的效果。

3.7　SWARCH模型

◆摘要◆

宏观经济与证券市场存在关联性，已经成为被海外研究人员普遍接受的命题。国外关于经济周期与证券市场收益率波动关系的研究主要有两个方面：一是从整体上分析两者之间的长期关联性；二是从每个经济周期内部分析两者的阶段关联性。

本节采用货币供应量为主要指标，构建SWARCH模型来判断该指标与大盘走势之间的关系，从而期望找到判断未来趋势的择时方法。

3.7.1　基本概念

整体上分析宏观经济周期与证券市场收益率关系的研究主要集中于对其协整关系的检验。例如，研究表明：美国和日本的证券价格与国民生产总值的增长率、长期和短期利率、通货膨胀率等国民经济运行状况指标之间存在长期的均衡关系。

证券市场波动的解释最终要以宏观经济分析为基础，经济行为水平的波动是证券收益率波动的关键决定因素，当经济处于衰退期时，将引起股市收益率波动收缩。

与海外学者较为一致的结论不同，国内学者在这方面的研究结论存在较大分歧，主要观点大致可以分为两类：一是认为股票指数与宏观经济发展之间在短期波动模式上具有相关性，同长期水平值之间也具有均衡关系；二是认为中国股市波动与经济运行相关性微弱，甚至呈现背离态势。

证券市场作为国民经济的重要组成部分，在理论界一向被冠以国民经济晴雨表的称号。然而，在实证检验中，海内外结论却存在着巨大的差异，这其中的原因主要有以下几个方面：

（1）相比海外证券市场，无论是中国经济还是中国证券市场都处于发展期，这期间必然存在异常波动，并且样本数也存在很大的局限。

（2）我国已有的实证检验主要采用简单OLS线性回归、ARCH和GARCH模型、Granger因果检验、协整检验及VAR模型法，仅注重对样本区间内整体关联性的检验，而忽视了分析经济增长的不同阶段与证券市场波动的特定关联，因此得出的结论不全面。

（3）宏观经济作为反映一国国民经济发展的总体指标，受诸多因素的交互影响；而证券市场作为高流动资产的代表，波动剧烈，预测收益率非常困难。因此如果希望从具体的数字中去捕捉作为纲领级的宏观经济和交易频繁波动剧烈的证券市场之间的关联性，显然存在较大困难。宏观经济作为证券市场发展的大背景，其周期转换规律必然是证券市场发展不可摆脱和回避的前提，因此从趋势上把握两者的关系才是可行和合理的研究方向。

（4）尽管GDP是刻画了一国经济发展的总量指标，但是在诸多的宏观经济变量中未必是与证券市场关系最密切的指标。

针对上述分析，本节提出以下改进和创新方法对宏观经济与证券市场的相关性进行研究。

（1）在诸多宏观经济变量中，选出与证券市场关系最为密切的指标作为测定经济周期的初始指标。

（2）引入隐性变量对宏观经济状态和证券市场趋势进行合理划分，前者划分为经济扩张期与经济衰减期，后者划分为证券市场上行期与证券市场下行期。

（3）改变单纯依靠具体数据来分析宏观经济与证券市场相关性的不足，依据对经济状态和市场状态的划分，分析状态之间的相互影响。海通证券研究员建立了动态的ARCH模型（向量SWARCH模型），重点衡量经济周期转换与证券市场趋势变迁之间的相关性。

（4）对模型进行进一步扩展，考察宏观周期与证券市场的相关性是否存在滞后效应。从而建立可以依据宏观经济变量对证券市场趋势进行把握的有效方法。

3.7.2　策略模型

在有关的宏观经济指标中，测量了GDP、货币供应量、汇率、利率、CPI、PPI等诸多指标后，结果表明货币供应量与资本市场的关系最为密切，因此下文重点研究货币供应量M2与证券市场在趋势上的相关关系。

1．模型描述

（1）以yt
表示货币供应量m2
的月度增长率，定义货币供应周期为如下形式：

这里
是一个2阶的不可观测的马尔可夫链，用来描述当前t时刻广义货币供应量m2
所处的状态。
表示m2
增速处于收缩状态，
表示m2
增速处于高胀状态。

对于这样的模型，需要考察广义货币供应量m2
的增长率处于收缩和高涨状态的概率分布情况。为了研究的方便，定义模型的状态转移矩阵
如下：

这里
是未知的参数，用来描述m2
的增速在扩张和收缩之间转移的概率分布。上面的方程模型描述了广义货币供应量m2
在宏观经济扩张和收缩状态时的状态转移情况。

（2）令rt
，t＝1，2，…，T，表示指数的月增长率满足如下的状态转移的ARCH模型：

其中，u～t
N（0，1），
是一个2阶的不可观测的马尔可夫链，表示当前时刻证券市场所处的状态。
表示指数的收益率处于下跌的状态，
表示指数的收益率处于上涨的状态。

同样，我们定义证券市场收益率的状态转移矩阵
如下：

这里
是未知的参数，描述证券市场收益率受宏观经济的影响在上涨和下跌之间转移的概率分布情况。

（3）在下面的实证过程中，为了模型参数估计的方便，我们取q＝m＝1，则上面的两个发展模型可以合并写成下面的向量形式：

其中，二维向量
，I为2阶单位方阵，并且

（4）对于上面的向量型Markov机制状态转移的ARCH模型，关键在于确定两组隐Markov过程
与
之间状态转移的分布关系。为了简化模型参数的设定和估计，考虑下面的4个模型假设：m2
增长率的状态转移独立于证券市场收益率的状态转移（模型A）；m2
增长率的状态转移同步于证券市场收益率的状态转移（模型B）；m2
增长率的状态转移领先证券市场收益率的状态转移一期（模型C）；m2
的状态转移领先证券市场的状态转移两期（模型D）。为简便起见，下面只以模型C为例对该隐Markov过程的状态转移矩阵进行详细的推理。

在模型C的假设下（即假设
），式（5）的状态变量简化为：
可以构造如下新的隐马尔可夫过程（st
）：

2．参数估计

这里使用极大似然方法来估计上面的向量SWARCH模型方程（5）中的各参数。

设广义货币供应量m2
的（月）增长率yt
和指数的（月）收益率rt
的联合条件密度满足如下二维正态分布形式：

这里二维向量
给定了联合条件密度和Markov状态转移矩阵P，根据广义货币供应量m2
的增长率yt
和指数收益率rt
的向量时间序列观测值，并且利用Hamilton方法，可以迭代计算出模型观测数据的对数似然函数：

令P（St
＝i|xt
，xt－1
，…，x1
，γ）表示基于所有至时刻t的可观测信息和参数γ对状态变量St
＝i的推断概率，将状态变量各种取值概率构成一列向量记为ξt|t
。同样P（St
＝i|xt－1
，xt－2
，…，x1
，γ）表示基于所有至时刻t－1的可观测信息和参数γ对状态变量St
＝i的推断概率，记为ξt|t－1
，则利用贝叶斯公式和全概率公式容易推导出下面的迭代公式：

其中，符号
表示两个向量之间对应分量的点乘，eN＋1
表示单位阵IN＋1
的第N＋1列。

3.7.3　实证案例：SWARCH模型

1．数据描述

本案例从万德数据库中提取广义货币供应量M2
自1997年12月至2008年11月的月度数据，计算M2
月度增长率；从海通数据库中提取涵盖沪深两市的海通综指自1997年12月至2008年11月的月度数据作为样本，计算指数的相关月度收益率。

分别设定了4种模型检验货币供应周期与证券市场的关联。在模型A的假设下，货币供应周期与证券市场趋势完全没有关系，相互独立。而在模型B、C和D的假设下货币周期均与证券市场存在着一定的关联度。

在不同的模型假设下，参数结果存在较大差异，在模型C的设定下最大对数似然值为-17.44，优于模型A、模型B和模型D的最大对数似然值，这说明货币供应周期变化有领先于证券市场变化的特征，而且最优的领先周期为1期，这为我们利用货币供应量的变化来预测证券市场走势提供了有效依据。

2．历史数据拟合

为了更直观地考察货币政策与证券市场走势的相关性，这里利用模型参数估计的结果计算出任意时期状态转移的相关平滑概率分布情况，比如可以计算任意时期t股市处于下跌状态的概率分布。具体算法如下：

根据前面部分的解释，当t＞τ时，
表示基于前期信息Ψt
对状态变量St
取值概率的向后预测，当t＜τ时，则称
为基于整体信息Ψt
对状态变量St
取值的向前平滑概率推断。简单地说，当t＞τ时，
为统计上的外推预测，当t＜τ时，
为内插预测。根据模型估计的结果对实际可观测变量所处状态的判断和识别需要用到平滑概率推断：

状态变量平滑概率推断的算法计算公式为：

这里符号（÷）表示两个向量之间对应分量的点除法。

从图3-26可以看出，SWARCH模型准确把握了证券市场的趋势。2000年4月至2005年12月，股市下跌的概率一直都非常大，意味着转移模型基本把握住了漫长的5年熊市。2006年至2007年10月，除少数月份外，下跌概率大幅下降，甚至在2006年底和2007年上半年一度下降幅度为零，这意味该模型也准确把握了市场上涨的趋势。2007年10月开始，下跌概率再度升高，并始终维持在1的附近，表明对于此次大幅调整，模型也做出了较为精准的判断。

图3-26　SWARCH模型与指数对比

资料来源：［张峰　2009］

需要指出的是，由于本案例采用的是内插的预测方法，此图只能反映SWARCH模型很好地拟合了历史状态，对货币供应周期和证券市场周期都比较好刻画和判断，但是，并不能代表模型具有较强的预测能力，因此下面将重点检验模型的预测效果。

3．预测结果

为了检验模型的预测效果，这里利用该模型计算预测数据，并将其与实际趋势进行比较来衡量预测效果。

这里用上证综合指数从2002年7月12日至2004年7月9日共100周数据作为模型的初始训练样本，以指数从2004年7月16日到2009年7月17日共252周的数据做样本外的（每一期）滚动预测，预测期的准确率同样达到了65.5％。图3-27中给出了模型对样本外数据的预测结果，如果模型预测结果正确（与真实的涨跌情况比较）记为1，而如果模型预测结果错误则记为-1。

图3-27　SWARCH分析模型的预测结果

资料来源：［张峰　2009］

同样地，可以基于模型的预测结果构建量化交易策略：当模型判断下周指数将上涨时全仓持有标的上证指数，而当模型判断下周指数将下跌时则全仓持有现金。图3-28显示了量化择时策略收益的表现情况。

图3-28　SWARCH模型在上证指数择时收益率曲线

资料来源：［张峰　2009］

从图3-28中可以看出，SWARCH量化择时策略的收益明显地超越了作为比较基准的上证综合指数和［50％标的指数＋50％现金］的基准组合，在不考虑交易费用的情况下策略的期末净值达到了7.23倍，如果考虑千分之五的单边交易费用，则策略的期末净值为3.13倍，而同期上证综合指数的净值为2.23倍，［50％标的指数＋50％现金］的基准组合的期末净值仅为1.58倍。

本节小结

从前面的分析结果中可以看出，SWARCH模型能够比较有效地揭示我国证券市场指数变化与货币供应量之间的相关关系，对指数周涨跌趋势具有较好的预测效果，而且基于该预测模型构建的量化择时交易策略也具有明显的超额收益。

但是不足之处在于该量化择时交易模型频繁交易导致的交易费用比较高。特别是上证指数标的择时模型在不考虑交易费用的情况下期末净值达到了7.23倍，而在扣除了单边千分之五的交易费用之后，择时模型的期末净值仅为3.13倍。这主要是因为在标的指数盘整的时期，模型容易出错而导致频繁换仓，这通常会极大地稀释量化交易策略的收益。

3.8　异常指标

◆摘要◆

市场上有很多异常信息，当大盘在某个特定的情况下它们就会出现，比如在大盘的底部或者顶部的时候，往往会有一些知情交易者提前知道某些信息，他们的交易行为对市场形成了扰动，如果捕获这些异常信息，则可能对大盘的判断具有重要的价值。

本节介绍3种异常指标择时模型，分别为市场噪声、行业集中度和兴登堡凶兆。

3.8.1　市场噪声

1．噪声交易

在学术上，噪声交易被定义为交易者在缺乏正确信息的情况下密集的买卖行为。由于这些交易缺乏信息或者信息有偏误，所以不会真正长期地影响资产价格的基础。

市场中与噪声交易者相对的是知情交易者。他们在掌握了所投资对象信息的情况下进行投资，但是为了使利益最大化，他们也会想方设法隐藏自己的交易行为。特别是具有大量资金的交易者，一定会设法避免在自己完全进入或退出前就开始影响市场的趋势，这一行为造成的结果恰恰更接近噪声交易——大量交易发生了，却没有影响市场的趋势。

当市场在酝酿反弹的时候，总有一部分人由于各种可能的原因先知先觉，抢先行动。他们在成功做到不影响趋势的同时，却令市场中噪声交易增加了。在这种情况下，市场中看似无意义的噪声其实包含了大量关于股票价格的信息——市场在蠢蠢欲动。

2．市场噪声指数

为了更好地跟踪市场的噪声交易规模，联合证券的研究员编制了市场噪声指数。该指数的作用是衡量并记录市场每天噪声交易的规模。

由图3-29可以看出这几年中国股票市场噪声交易规模变动相当剧烈。这里主要研究在几天内突然发生的剧烈变动。

图3-29　市场噪声指数与沪深300走势

数据来源：［罗捷　2009］

3．利用噪声交易指数择时

案例　噪声交易择时模型

由于市场噪声通常是由大量无正确信息的交易者随机地交易造成的，在没有外部冲击的情况下，一般都是比较稳定的，如果市场噪声交易突然扩大，很可能是知情交易者在偷偷进行交易。

利用噪声交易指数可以设计一些交易策略。下面是一个简单交易策略的例子，该策略只考虑大盘的走势及噪声交易规模，不考虑如成交量等其他因素。

（1）进入策略：市场较上周下跌，最近5日平均噪声交易规模比5日之前的连续5日平均噪声交易规模显著增大。

（2）退出策略：市场较上周上涨，最近5日平均噪声交易规模比5日之前的连续5日平均噪声交易规模显著增大。

（3）止盈／止损策略：某交易日收盘价相对于进入后的高点下跌幅度超过一定程度。

利用2004年市场情况优化策略参数，在2005年与2008年进行投资策略的回测。3年均采用指数投资，2004年投资上证综指，2005年与2008年投资沪深300指数。

分别在2004年、2005年、2008年测试这几个策略，结果如表3-19所示。该实证过程没有考虑当没有买入股票时可以进行固定收益投资，而是假设资金都以现金存放。

表3-19　噪声交易在熊市择时的收益率 

数据来源：［罗捷　2009］

总而言之，通过监视中国股票市场的噪声交易规模可以得出结论，噪声交易规模可以作为一个简单而有效的市场择时指标。通过监测该指数短期内是否发生突变，我们可以提前发现2004年、2005年、2008年中几乎每一次主要的反弹。

3.8.2　行业集中度

1．行业相关性集中度

在中国股市上升趋势稳定时，可以观察到各个行业之间上升势态比较一致，鸡犬升天不失为一种夸张而形象的描述。而当上升趋势遇到阻力，即将进入动荡期或者出现转折的时候，行业的相关性往往能够提前出现分化，比如常常有某些行业先于股指达到弱势，从而使得行业之间相关性变得更散乱。如果能够捕捉到行业相关性的变化，就能够预测到股指上升过程中即将来临的动荡或者见顶，从而及时回避风险。

基于这一思路，这里定义一个统计量来描述行业相关性的集中和散乱程度。若市场上有n个行业指数，分别取其交易日的对数收益率序列，将这些序列两两配对计算它们之间的相关系数，这里我们选择普通的线性相关系数。一共会得到
个相关系数。这些相关系数组成一个样本｛ρi，j
|j＞i｝，定义行业相关性集中度为该样本的均值与标准差之比

当行业相关性整体变得更弱时，
变得更小，从而行业相关性集中度cρ
减小；当行业相关性变得更散乱，大小不一致时，意味着标准差s变大，从而cρ
减小。所以cρ
值较小，意味着行业相关性变得散乱不一致，或者相关整体水平比较低，刚好对应了行业走势的分化。而相反cρ
值较高，表示行业之间走势比较一致。

2．行业相关性集中度的应用

为了找到市场局部的变化，可以对每一日收益率加上某一固定长度的历史区间内收益率来计算行业相关系数。逐日重复这样的计算，可以得到每一日的行业移动相关系数，从而得到每一日的移动行业相关性集中度。

对Wind一级行业指数（有关Wind系统的介绍参见17.1节）共10个指数，以移动区间计算每个交易日共45个行业相关系数，从而得到每个交易日的行业相关性集中度，把这些逐日的行业相关性集中度连成曲线（经过了仅依赖历史的移动平均去噪处理）和代表大盘走势的上证指数对照，如图3-30所示。

图3-30　行业相关集中度与上证指数关系

数据来源：［曹力　2009］

图3-30中两条水平直线为行业相关性集中度4.0和5.0，不难发现，当行业相关性集中度降到4.0水平时，可以视为上涨趋势中的风险警报信号，表示行业分化严重，上涨很可能将遇到阻力；当行业集中度回复到5.0水平时，可视为动荡期或者反转期已过，行业分化程度减轻。2003年到2008年共5年间，行业相关性集中度曲线共发出了4次信号，均对应到了上涨趋势中的动荡或者反转，而在熊市中，该指数没有发出任何信号，所以无法利用它来掌握熊市的情况。

不难观察到，在2007年5月30日的所谓“530”大跌，行业相关性集中度曲线没有发出信号。这次动荡主要是由政府大幅提高交易印花税导致的，并不是市场自身运动变化的结果。行业相关性集中度没有大幅下降也完全可以理解，因为行业相关性集中度完全由市场收盘价计算而得，并不能预测政府的重大政策调整。

3.8.3　兴登堡凶兆

1．美股兴登堡凶兆

兴登堡凶兆是股市技术分析上用做预测走势转弱或暴跌的重要方法之一，由失明数学家米耶卡于1995年创造，主要追踪纽约证券交易所上市股票，由多项标准组成，其中一项重要判定标准是创52周新高或新低的股票数目。他认为，正常情况下，当股市行至高点，多数股票应处于高位；股市跌至低位，多数股票应处于低位，这是股市常态。如果股市在高位盘整时，股价创出一年新高与创出一年新低的个股均达到一个较高比例，同时反映市场广度的麦克连指标为负数，则表示市场可能正处于激烈分化之中，分化之后，市场可能出现大幅回落。

当纽交所的股票市场出现以下四大标准的时候，也就标志着兴登堡凶兆的触发。

兴登堡凶兆四大准则如下：

（1）纽交所每日创52周新高和新低的股票数目，均超过大市交易股份数目的2.2％，即达69只或以上（按目前纽交所3126只上市股份的2.2％计算）。

（2）指数的10周移动平均向上，也有人用相对数据来衡量，大盘指数比50天前高即可。

（3）借平滑涨跌家数差值而制成的麦克连指标当天为负数。

（4）52周新高股票数目不可高于52周新低股票数目的2倍（相反则可）。

传统的定义方法需要这些现象出现在同一天，一旦信号发出，在30天内都有效，接下来的信号如果再次触发可以忽略。在这30天内，如果麦克连指标持续为负，则继续有效，如果麦克连指标变正了，则信号取消。

关于这4个标准的理解如下：

标准1：主要体现了市场的分化程度，也就是各个股票间的收益间距拉大，表现好的变得很好，差得更加差，个股受市场指数的影响降到历史新低。

标准2：无论是用10周移动平均线向上的标准，还是用对比50日前的指数相对高低，都表明了大盘前期的上涨趋势。

标准3：麦克连指标的计算如下：

DIF＝上涨家数－下跌家数

MCL＝DIF的19日指数的加权移动平均-DIF的39日指数的加权移动平均

麦克连指标是以0轴为中心的，当MCL为正值时，是短期多头市场；当MCL为负值时，是短期空头市场。

标准4：在单边上升市场中，市场普涨可能会使52周新高股票过多，此时并不能作为触发兴登堡凶兆的条件。

由以上这些理解可以笼统地概括出兴登堡凶兆的触发条件，在一个前期市场上升的市场中，短期多头占优势，并且市场表现不断分化，好的更加好，差的更加差。出现这种情况，市场会有很大的下跌风险。这是因为在一个上涨过程中，初期和中期往往会有一个比较明确且持续的热点，而到中后期则会缺乏这种持续热点，市场观点开始分化，有部分股票开始独立大盘走出自己的行情，一旦这种分化达到一个极值（有部分创新高、部分创新低），短期市场又出现空头情况，则很有可能市场会出现剧烈下跌。

从过去的25年的表现来看，兴登堡凶兆基本都在市场崩盘或者恐慌性出售之前出现。也可以说，只要兴登堡凶兆没有出现，基本可以确定大盘还是比较安全的。

从历史数据来看，如果用下跌超过15％来定义一次股灾，在过去的25年的27次兴登堡凶兆确认信号中，有8次（29.7％）出现股灾。另外，有3次（11.1％）出现恐慌性出售（下跌10％到15％）；有4次（14.8％）出现大幅下跌（下跌8％到10％）；有6次（22.2％）出现明显下跌（下跌5％到8％）；4次（14.8％）出现温和下跌（下跌2％到5％）；有2次（7.4％）失败（下跌小于2％）。

换句话说，只要兴登堡信号得到确认了，有77.8％的概率市场会下跌超过5％，大约在13次兴登堡凶兆的确认信号中，只有一次会失败，每次信号的确认都是在市场大幅下跌前。1987年股灾前几个礼拜凶兆信号确认，1989年10月信号确认后就出现了1990年的经济衰退，2008年市场下跌前一天凶兆信号确认。

2．A股兴登堡凶兆模型

回顾A股历史也能发现，中国股市升则鸡犬升天，跌则泥沙俱下，没有出现过市场高位时有多只个股创一年新低的现象，从表面上看，兴登堡凶兆可能并不适用于中国市场。

但是如果深入分析这一模型背后的逻辑，还是可以得到许多启发的。兴登堡凶兆这一技术模型的核心在于，市场探出大顶之前，往往会出现剧烈的分化，这一分化往往可以视为市场调整的先行指标。既然与成熟市场相比，A股个股与行业／板块联动性相对偏低，但是题材炒作、资金推动的特点非常明显，大盘股、小盘股轮动，风格不断转换的脉络非常清楚。一轮行情的开始往往是小盘股、题材股率先启动，而后延伸到大盘股、蓝筹股，两大板块交替前行，一旦这一进程被打断，大盘股、小盘股走势出现分化或者各种题材股出现分化，可能意味着市场调整的开始。

根据资本资产定价模型，个股风险ri
可以用如下等式来表示：

ri
＝αi
＋βi
rm
＋εi

把个股日收益率作为因变量，市场指数的日收益率作为自变量，用最小平方法求得的回归直线方程Y＝a＋bX，来确定X和Y的具体变动关系。个股相对于市场的联动程度主要是通过个股与市场的相关系数r来衡量的。

个股相关系数能够很好地说明个股相对于大盘指数的关联程度，但是相关系数有可能出现负值的情况，在计算整个市场所有个股平均相对于市场的关联程度的时候，可能不能很好地反映真实情况，正负会相抵消。所以用判定系数r2
能够更好地测定直线回归模型拟合优度，可以防止对相关系数所表示的相关程度做出夸张的解释。

在这里一般用30个交易日作为计算r2
的时间段，每个交易日每只个股回顾前30个交易日收益率，以市场指数收益率作为因变量，个股收益率作为自变量，计算出一个r2
。所以中国A股的兴登堡凶兆中关于描述市场分化指标这里用r2
的平均值即决定系数来替代，对于兴登堡凶兆的第二条指标也就是用指数的50日均线来表述，第三条标准可以用短期均线来代替，第四条标准因为我们用r2
作为市场分化指标，也就没有必要考虑了。所以中国A股的兴登堡凶兆标准可以归纳为以下3个条，至于各条标准的具体临界值将在下面的实验中进行测算。

标准1：所有个股30个交易日的个股收益率相对于市场指数收益率的r2
的平均值
作为衡量市场趋同的指标，数值越低，趋同越低，分化越高。

标准2：用市场指数50日移动平均线是否向上作为一个市场中期是否向好的指标。

标准3：用短期10日均线是否向下来判定短期是否为空头市场。

3．数据实证

将上证综合指数作为市场指数，所以选择的个股也是所有上证指数的成分股。按上述方法计算出简单平均r2
分化指数，将r2
小于0.3作为先期预警信号，然后加上标准2和标准3，其中标准3用10日均线向下作为短期空头信号，标准2用50日均线向上作为长期多头信号。从图3-31中可以看到发出的卖出信号基本是正确的。

图3-31　兴登堡凶兆模型中卖出信号与上证综指r2
平均分化指标

资料来源：［阚先成　2011］

通过进一步对r2
走势的图形进行观察，忽略其绝对的数值量化指标，可以明显地发现每次只要r2
趋同指标探底回升，基本都有一个后期的指数见顶过程，一般这个探底回升都会领先于指数见顶，对投资者来说是有非常好的指导意义。从图3-32中可以看到每次趋同指标小于0.3的探底回升都有一个阶段的调整。而事实上相对短期的震荡，r2
趋同指标的探底回升同样也可以作为短期市场见顶的一个信号。

图3-32　长期上证综指r2
平均趋同指标探底回升统计

资料来源：［阚先成　2011］

4．中国式兴登堡凶兆的市场逻辑

正如前面讨论的那样，只要市场出现极端分化，一般原先的上涨趋势不是停止就是面临大幅下跌的风险，这个背后的逻辑又是什么呢？这里以2008年剧烈下跌之后反转的行情来进行分析。

阶段1：当市场在剧烈下跌的时候，就会出现恐慌性抛售，这时一般趋同指标比较高，个股一般都是随着市场下跌。

阶段2：而当市场已经止跌之后，因为绝大部分投资者还没有从上一轮的下跌中恢复过来，这时个股会随着指数在市场的底部震荡一段时间，这段时间的趋同指标也比较高，因为这个时候市场往往没有太多热点，没有一股主导市场的力量。

阶段3：市场中总会存在一批先知先觉者，他们首先嗅到了市场复苏的气息，开始主动操作股票，于是市场又开始热点频出，随着一轮又一轮的热点炒作，指数节节攀升，市场人气恢复，往往这样的上涨不是个股普涨，而是一个个热点轮流上涨，所以这个过程是一个逐渐分化的过程，同时趋同指数会逐渐变小。

阶段4：直到达到阶段性的极端分化，那批主动操作者感觉到市场有调整的风险则开始主动撤离，一些市场跟随者失去了热点方向，于是趋同指数又开始上升。

阶段5：经过一轮调整，市场主导者又开始大规模介入，介入力度还大于第一次，趋同指标不断减小。

阶段6：直到趋同指标到阶段底部，也就是到极端分化的时候，这批市场主导者开始主动撤离市场，市场跟随者随着市场惯性还会有一轮惯性上涨，但是马上他们发现市场缺乏主导者之后，又开始恐慌性抛售。

当然在一轮大牛市中，类似阶段3和阶段4的过程可能会出现好几次，通过一次一次地调整最终达到牛市顶部。往往这样的牛市顶部所对应的趋同指标数值会更低，分化会更加厉害，分化持续的时间也会更长。

总而言之，兴登堡凶兆在美国市场适用。通过用个股相对于市场指数的相关程度大小来替代美股兴登堡凶兆中市场分化程度指标，可以明显发现中国A股的兴登堡凶兆。A股个股与行业／板块联动性相对偏低，但是题材炒作、资金推动的特点非常明显，大盘股、小盘股轮动，风格不断转换的脉络非常清楚。一轮行情的开始往往是小盘股、题材股率先启动，而后延伸到大盘股、蓝筹股，两大板块交替前行，一旦这一进程被打断，个股收益出现分化，可能意味着市场调整的开始。

思考

1．量化投资和传统的价值投资、技术分析的关系是什么？

自量化投资这个概念提出，很多人就对量化投资有着本能的质疑，认为机器是不可能战胜人的，依靠一个软件来赚钱是天方夜谭。其实持有这种想法的人士对量化投资的理解流于肤浅了。量化投资并不仅仅是一个程序化交易，更不仅仅是一个炒股软件，而是一个完整的分析、交易、风险控制的学科体系。

量化投资和价值投资及技术分析的关系并不是很多人认为的互不相容、互相抵触，恰好相反，量化投资的很多策略思想都是来自于传统的价值投资和技术分析的。但是利用数学和模型的方法，可以对传统的策略进行定量处理，从而提高获胜的概率。

例如，在第2章中的选股模型中，多因子模型、行业轮动就是典型的价值投资的理念在量化分析中的具体应用。利用量化的模型来找到公司的基本面因子，来判断该公司在未来一段时间是否会有超额收益。

趋势追踪模型则是技术分析理论在量化投资中的有效应用，传统的技术分析最大的问题是受到投资者主观影响太大，同样的波浪理论，10个人数有10个不同的数法，用了量化的分析后，就可以判断出大致的概率，从而避免了过分主观带来的错误。

可以说，量化投资的发展是站在巨人的肩膀上的，这个巨人就是价值投资和技术分析。因此，要想成为一名好的宽客，光懂数学和计算机是不够的，还需要对金融分析的理论有深入的了解才行。

2．策略最重要的考虑指标是什么？

在实战交易中，对于策略有很多考量，如收益率、风险度，对于这些考量也有很多指标来衡量，收益率有绝对收益率、相对收益率、年化收益率、阿尔法收益率等，风险度指标也有贝塔系数、夏普率等。

但是从收益的角度看，笔者认为一个实战的策略最重要的考虑是该策略的市场容量。一个好的策略，不仅仅是在小资金的时候能获得高额收益，更重要的是当该策略面对大资金的时候，是否还可以保持收益率的稳定性。

收益＝本金×收益率，所以最终的收益不仅取决于收益率，更取决于本金的大小。一个在10亿资金可以获得10％收益率的策略，显然要比在1亿资金可以获得30％收益率的策略更有价值，因为资金规模的限制决定了该策略可以复利的程度。爱因斯坦说过：“人类第八大奇迹就是复利”，只有可以不断复利的策略，才能获得巨大的收益。

为了考虑资金规模的影响，笔者在夏普指数的基础上，提出了一个新的指标：

D－Ratio＝（Rp－Rf）/（σ*（1＋e－v
））

其中，Rp为收益率均值，Rf为无风险收益率，σ为收益率标准差，v为最大资金规模。v的范围从0～∞。当v＝0的时候，e－v
＝1；当v＝∞的时候e－v
等于0。这说明最大资金规模越大，则D－Ratio的值越大。该指标可以判断大资金策略和小资金策略的区别。

例如有一个策略，1亿资金规模可以做到30％收益率，无风险利率为5％，标准差为10％。另外一个策略，5亿资金规模可以做到15％的收益率，无风险利率为5％，标准差为5％。这两个策略的D－Ratio分别为：

D－Ratio1＝（0.3－0.05）/（0.1*（1＋e－1
））＝1.83

D－Ratio2＝（0.15－0.05）/（0.05*（1＋e－5
））＝1.99

很明显，虽然第二个策略的收益率不如第一个策略，但是考虑了资金规模后，该策略的价值更大。

从D-Ratio的公式定义来看，其实就是在夏普率的基础上考虑了资金规模后的一个分母项（1＋e－v
），当v趋向0的时候，e0
＝1，1＋e－v
＝2；当v趋向无穷的时候，e-v
＝0，1＋e-v
＝1。可以看出，最大资金越小，D-Ratio值越小；最大资金越大，D-Ratio值越大。

那么，这里有另一个问题，怎么定义最大资金容量呢？这里给出一个简单的说法：让收益率趋近无风险收益率的那个资金值，即为最大资金容量。数学上定义如下：

令V_M为最大资金容量，V为策略的资金量，R为策略的收益率，Rp为无风险收益率，则：

第4章　股指期货套利

◆摘要◆

第3章阐述的择时策略是收益率最高的策略，但是风险也极大，研究的难度也很高，因此很多稳健型的资金，更愿意降低收益率以降低风险。股指期货套利就是一种低风险、低收益的投资方式。

股指期货套利是指利用股指期货市场存在的不合理价格，同时参与股指期货与股票现货市场交易，或者同时进行不同期限、不同（但相近）类别股票指数合约交易，以赚取差价的行为。股指期货套利分为期现套利、跨期套利、跨市套利和跨品种套利，本章主要阐述期现套利和跨期套利这两种最主流的方式。

期现套利，即股指期货与股指现货之间的套利，是利用期货合约与其对应的现货指数之间的定价偏差进行的套利交易，属于无风险套利。即在买入（卖出）某个月份的股指期货合约的同时卖出（买入）相同价值的标的指数的现货股票组合，并在未来某个时间对两笔头寸同时进行平仓的一种套利交易方式。

（1）期现套利主要涉及的内容包括定价模型、指数复制、冲击成本、保证金管理这几个部分。跨期套利主要涉及均衡价差判定、套利策略等。

①定价模型主要是计算以现货为基础所对应的股指期货市值大小，在扣除所有的成本之后，如果股指期货和现货之间的差距为正，则意味着存在正向套利空间，反向套利的原理也是一样的。

②指数复制是指利用各种方式来构建一个能够尽可能拟合指数的现货组合，包括完全复制和抽样复制这两种。当复制目标是最小化复制差异时（即跟踪误差最小化），称之为被动复制；当复制目标是最大化信息比率时，称之为增强复制。

③冲击成本的全称是价格冲击成本。国际上通常用它来衡量股市的流动性。它也可称为流动性成本，是指一定数量的委托（订单）迅速成交时对价格的影响，因此是一个包含即时性和合理价格两方面要素的指标。

④期现套利中保证金管理具有很重要的作用。在市场出现剧烈波动的时候，尤其是大幅度上涨的行情中，如果保证金覆盖不足，就可能出现爆仓情况。所以，在建仓初始，就需要进行保证金覆盖的测算，使得初始保证金能够在较大的概率下覆盖整个套利期间内的波动。

（2）跨期套利是指利用两个不同交割月的股指期货合约之间的价差进行的套利交易。一般来说，相同标的指数的股指期货在市场上会有不同交割月的若干合约同时交易。由于同时交易的不同交割月合约均是基于同一标的指数的，所以，在市场预期相对稳定的情况下，不同交割日期合约间的价差应该是稳定的，一旦价差发生了变化，就会产生跨期套利机会。

跨期套利的核心在于计算均衡价差，因为不同合约间价差会收敛并趋向于均衡价差，这就是同一标的指数的不同交割月股指期货合约之间存在着的一种平价关系，即远月合约的价值应该是近月合约价值按照远期利率进行复利后加上一个均衡价差。

跨期套利的主要机会包括程序化跨期套利、事件性跨期套利、新合约上市首日套利、老合约退市前几日套利等。

4.1　基本概念

4.1.1　套利介绍

股指期货套利是指利用股指期货市场存在的不合理价格，同时参与股指期货与股票现货市场交易，或者同时进行不同期限、不同（但相近）类别股票指数合约交易，以赚取差价的行为。股指期货套利分为期现套利、跨期套利、跨市套利和跨品种套利这几种，本章主要讨论最常用的期现套利和跨期套利。

总体上看，股指期货套利和商品套利都是期货套利交易的一种类型，其原理都是在市场价格关系处于不正常状态下进行双边交易以获取低风险差价。

股指期货套利和商品期货套利的主要区别在于期货合约标的的属性不同。商品期货合约的标的是有形商品，有形商品就涉及商品的规格、性能、等级、耐久性，以及仓储、运输和交割等，从而会对套利产生重要影响。股指期货的标的是股票指数，指数只是一个无形的概念，不存在有形商品的相关限制，同时股指期货的交割采用现金交割，因此在交割和套利上都有很大的便利性。此外，股指期货由于成分股分红不规律、融资成本不一及现货指数设计等原因，其理论价格相对商品期货更难准确定价。这些区别是造成股指期货套利和商品期货套利在具体类别上差异化的主要原因。有关商品期货套利的内容将在第5章进行讨论。

股指期货套利模型如图4-1所示。紫色为指数现货价格、红线为指数期货价格，两者的价差：绿线为无套利区间。一旦价差突破了无套利区间，则存在套利机会，只要同时双向建立头寸，持有至合约到期，就可以获得无风险收益。

图4-1　股指期货套利模型

股指期货作为股票指数的一种衍生品，其定价依据通常是无套利定价原理，经典的股指期货定价公式如下：

其中，FP为股票指数期货的理论价格，I0
为期初指数对应的合约价值，r为借款利率，t为期限，N为股票指数中股票数量，DIVi
为第i只股票支付的股息，ti，D
为自第i只股票支付股息至交割日的时间长度。

1．股指期货套利交易特点

（1）低风险：从理论上讲属于无风险套利，与单边投机相比，套利交易可以提供一个更有吸引力的收益／风险比率，规避了市场风险。

（2）流动性高：投资对象为沪深300指数成分股票，市场资金容量大，进出方便，可以作为大资金的现金管理工具。

（3）更适合机构投资者：机构投资者同时具备资金优势和研发优势，而且更倾向于获得稳定性收益，国际期货市场有众多专业套利机构投资者。

（4）收益稳定：理论上每笔交易都是盈利的，资金曲线几乎没有发生回撤。

2．股指期货期现套利注意事项

（1）跟踪误差。在用沪深300指数的替代现货进行套利时，要注意两者在套利期间出现较大偏离的可能，如果套利周期较长且替代现货偏离较大，则可能会导致套利交易面临风险。

（2）冲击成本。需要对交易当日的市场情况做一个评估，要综合考虑当前市场的流动性与套利资金量的大小，要对冲击成本有一个提前的预估。

（3）流动性风险。在买卖现货组合时遇到股票停牌、涨跌停板而无法进行交易时，要考虑现货组合的替代股票及评估当前市场的可操作性。

（4）保证金风险。股指期货保证金不足，面临强行平仓的风险，可能导致套利交易止损出局。

（5）技术支持。选择多样本股票同时买卖时，人工无法做到一揽子股票与股指期货同时下单，需要选择一个比较合适的交易软件。所以必须考虑技术要素，需要配备相应的技术手段。

（6）政策风险。交易所对下单手数和持仓量的限制。

4.1.2　套利策略

1．期现套利的步骤

（1）计算股指期货的理论价格，计算股指期货无套利区间。

（2）确定是否存在套利机会（当期货价格大于现货价格时，称之为正向市场；反之为反向市场）。

（3）确定交易规模，同时进行股指合约与一揽子股票交易。

（4）价差收敛时平仓获利了结；或者持有到期时期现货卖出，期货交割获利。

2．跨期套利的步骤

（1）计算股指期货合约间无套利区间。

（2）买入价格低估合约，卖出价格高估合约。

（3）价差收敛则平仓获利了结。

3．期现套利案例

当某一到期月份的股指期货合约被市场高估或低估时，通过做多现货做空期货，或做空现货做多期货的方式（即融券卖出股票的同时在期货市场构建多头头寸），锁定期货和现货之间的差价，等待期现价差回归时平掉套利头寸或通过交割结束套利。

案例：2010年5月6日，股指期货1005合约高于沪深300指数70.54点，买进一揽子沪深300的股票，同时卖出一手股指期货1005合约。此时距离股指期货1005合约到期交割还有15天，若在此区间内期现基差能够收敛则可以获得套利收益。至5月19日期现基差收窄至1.23点，此时可对套利头寸进行平仓，卖出股票，买入股指期货合约。收益为（70.54－1.23）＝69.31点，扣除各项成本总计15点，则净获利16293元。

期现套利中，若基差持续不收敛，可考虑交割套利；由于交割价参考沪深300指数，期现价差存在强制收敛关系，理论上建仓时基差即为交割收益，但需考虑交易成本和交割日最后两小时沪深300指数波动风险。

股指期货最终交割价取的是沪深300指数交割日最后两小时的算术平均价，可能会和收盘价各形成一定偏离。在建仓时需考虑此部分基差，防止最后交割日价格剧烈波动导致交割价大幅偏离300指数收盘价格。

4．交割套利案例

案例：2010年9月9日，股指期货1009合约高于沪深300指数21.14点，此时进行卖出1009合约并买入300指数成分股的开仓操作。若在9月17日前两者价差一直没有收敛，则可以考虑对1009合约进行交割套利。由于1009在交割日强制收敛其交割价格为沪深300最后两小时的平均价2866.63，与沪指300收盘价有（2866.63－2861.37）＝5.26点的偏离。扣除7点的交易成本，本次套利获得的收益为：（21.14－5.26－7）×300＝2664元。可见，交割套利可以在基差无法如预期收敛时保证套利收益。

交割日沪深300指数大幅变动带来的交割价偏离的风险：

情况一：交割日沪深300指数的交割价低于指数的收盘价，对套利有利。

情况二：交割日沪深300指数的交割价高于指数的收盘价，对套利不利。

5．跨期套利案例

当两个不同到期月份的股指期货合约产生较大价格偏差时，通过做多被低估合约，做空被高估合约的方法，待其价差恢复正常时获利平仓。

案例：2010年5月6日，股指期货1006合约为3018.8点，1005合约为2967.4点，两者价差为51.4点，明显高于合约间正常水平。此时进行卖出1006合约并买入1005合约的开仓操作，持有至2010年5月17日。此时1006合约2722.4点，1005合约2719点，两者价差为3.4点，可进行平仓操作，买入1006合约并卖出1005合约，获取的套利收益为（51.4－3.4）＝48点。同时扣除各项成本（以10点计），到期平仓的收益为（48－10）×300＝11400元。

4.2　期现套利

由于股指期货合约在到期时是按照现货指数的价格来进行现金交割的，即期货合约价格在到期时会强制收敛于现货指数，这就使得在正常交易期间内，期指与现指会维持一定的动态联系。在各种因素影响下，由于股指相对现指对信息的反应速度要快，因此，其波动性会大于现指，经常会与现指产生偏离，当这种偏离超出一定范围时，就会产生套利机会。

期现套利属于无风险套利，只要定价偏差的收益能涵盖掉交易成本，就可以进行期现套利操作，而不用关心市场的未来走势。常用的股指期现套利的决策方法是利用股指期货的理论价格模型，通过对股指期货实际价格和理论价格的比较，判断是否存在套利机会，以及进行何种方式的套利交易。

4.2.1　定价模型

在股指期现套利过程中，股指期货部分发生的项目：期初期货合约价格IFt
、到期期货合约价格IFT
、平仓期交易成本CifT
、期初建立期货头寸交易成本Cift
。现货部分发生的项目：到期现货组合价格PT
、期初现货组合价格Pt
、借款利率r、资金借贷成本率rborrow
、红利收入D、到期卖出或买入现货组合交易成本CpT
、期初买入或卖出现货组合交易成本Cpt
。保证金部分发生的项目：保证金的资金成本CMargin
。

1．正向套利

当股指期货价格被高估，可进行正向套利，那么应该有：

其中，IFT
＝PT

2．反向套利

当股指期货价格被低估，可进行反向套利，那么应该有

3．无套利区间

要使得股指期货价格不存在套利空间，那么股指期货价格的范围如下：

在我国目前的股指期货的期现套利中，由于缺乏现货做空，期现套利主要是买入现货卖出期货的正向套利，套利收益主要来自于期货高估的部分。

从无套利价格区间来看，要想套利成功，必须进行现货头寸的构建、交易成本控制、交易策略设计等多方面的准备，任意一方面准备不充分都会导致套利失败。

4.2.2　现货指数复制

在期现套利中，需要构建现货组合来进行指数复制，在投资中，根据市场条件不同，常用完全复制、抽样复制、衍生产品复制等方法。

使用指数成分股（根据需要可包括少量具有类似性质的非成分股）创建一个与目标可投资指数相比差异尽可能小或信息比率尽可能大的股票组合的过程称为指数复制。当复制目标是最小化复制差异时（即跟踪误差最小化），我们称之为被动复制；当复制目标是最大化信息比率时，我们称之为增强复制。尽管理论上复制可投资指数非常简单，但是实际操作却是一个精细复杂的过程。

1．指数复制中的一些障碍

指数编制中存在一些与实际投资不相符的假设，这些假设对准确地复制指数造成了一定的障碍。

首先，指数编制时假设各种费用不存在，但是建立交易组合需要各式各样的成本。这个成本不仅包括佣金等交易费用，还包括建立、管理指数组合的各方面费用，通常表现为运营费用和管理费用的形式。在指数组合管理中，这部分费用通常体现为显性成本，较难控制。

另外，大多数指数假设的变动都是在某个交易日的收盘时生效，或者说，指数成分增加、减少或者成分股权重的调整都是按照调整日的收盘价进行的。但是在组合不能承受短时间内大规模交易的情况下，交易需要多次在某些极端情况下甚至可能需要近百次才能完成。交易价格变成了成交均价，与假设的收盘价出现差异。通常，这部分差异体现为交易滑价，或冲击成本等隐性成本；指数组合管理人通过交易算法的设计来进行控制。

在国内，指数复制还面临一个比较特殊的障碍——投资组合不能投资可能涉及利益关系的股票，如投资组合的托管行的股票、由股东承销的股票等。由于通常托管行作为上市公司在国内主要可投资指数中权重较大，这种制度约束对于指数复制而言影响十分明显。

2．完全复制

完全复制法是复制指数最自然的方法。这一方法通过购买所有指数成分股，完全按照股票在指数中的权重配置、在指数结构调整时也同步调整的方法来试图实现与指数完全相同的收益率。这种方法简单明了，较易获得较小的跟踪误差，同时也是其他复制方法的出发点。

但是在实际投资过程中，完全复制并不一定易于实现。最明显的障碍是冲击成本。对于流动性较差的股票，复制过程中买卖的冲击成本会对复制效果造成巨大的影响。

3．抽样复制

在理论上，如果能够实现完全复制，那将是最好的复制策略。但是由于操作上的困难，使得完全复制执行起来难度很大，这就使得我们必须考虑其他的方法。

指数成分股之间有很多共同因子，当组合中缺失一些股票时，可以使用具有相同因子（包括行业、市值等）的其他股票来替代。采用具有相同因子的部分指数成分股进行指数复制即抽样复制，被选择用于复制指数的股票称为核心股票。

对于完全复制而言，由于每只股票都按照指数的比例配置，因此所有股票的权重跟指数的变动是同步的。但是对于抽样复制的股票替代部分而言，由于存在与被替代股票的差别，用于替代的各个部分的权重与实际需要改变了复制组合的代表性。因此，就必须经常监测跟踪误差，根据预测的跟踪误差的扩大情况及时更新复制组合，将其降低到可接受的水平。

假设所有股票的收益率服从多元正态分布，在存在指数成分股之间的预期方差协方差矩阵及指数组合权重的情况下，不难推导出预期跟踪误差，可以用如下公式表示：

其中，PTE（Predicted Tracking Error）是估计的预期跟踪误差（投资组合收益率与指数收益率差的方差），V是指数所有成分股的预期方差协方差矩阵，ω是指数本身的权重向量（列向量），ωp
是复制指数所用的组合中各只股票的权重向量（列向量）。

借助预期跟踪误差公式，可以预测随着市场情况的变化及持有股票占整个组合的权重变化，组合的跟踪误差可能发生什么样的变化，并及时调整组合。

抽样复制指数常用的技术包括市值优先、分层抽样、最优化等方法。此外还可以根据需要把这些方法混合，组成混合抽样方法。针对不同的市场状况、方法的表现可能不同，必须按需选择。

1）市值优先抽样

把股票按市值从大到小排列，选择排名在最前面的股票。统计出选出的所有股票的总权重，每只股票配置的比例等于该只股票在总权重中所占的比例，然后通过合适的现金配置策略使整个组合的Beta等于目标指数的Beta，这样的方法称为市值优先抽样方法。

不难发现，这种方法的优点是，在使用相同数量股票进行抽样复制时，其市值占比最高，体现了大市值股票的个别风险。此外，市值最大的股票往往也是流动性最好的股票，更有利于投资者进行买卖。

但是这种方法忽略了股票之间的其他共同点，过于偏向于大市值股票。而恰恰有一些股票间的共同因子与市值大小高度相关，这就会造成选择的组合可能出现明显的风格特征与行业特征，使指数跟踪在特定的时间段与目标指数相比出现系统性的偏差。

2）分层抽样

由于不同股票的表现互相并不是独立的，许多股票之间可能存在一些共同的因子。如果把成分股按照是否有共同因子（除市场因子外）分类，在每一类中选择若干股票，就能依靠少数股票达到提高组合对指数的代表性的目的。这种方法不重视股票的个别影响成分，而是努力寻找共同的因素。

股票最重要的共同因子是股票的行业因子。各个行业中的企业一般都具有不同程度类似的供给需求结构和技术水平，容易受到同样因素的影响，保证各个行业都有一定的代表就能把这些影响因素反映在组合中，更有助于以较少的股票提高指数的跟踪效果。

另外，由于市值差异较大的股票有不同的风险结构和不同的投资者群体，类似市值的股票受这些因素影响的程度类似，这种特点构成了基于市值大小分类的不同投资风格。当指数覆盖市值范围较大时，风格因子也是分层抽样需要采用的分类方法。

3）最优化方法

利用历史数据，通过最优化技术求解使跟踪误差最小的配置方法成为最优化方法。

虽然均属于抽样复制，但与分层抽样不同的是，最优化方法关心的不是指数成分股对因子的代表性，而是历史上各只股票之间的相关关系。这种方法假设股票相关性在一段时间内是相对静态的、可预测的。

通过数学推导得出以下结论：如果能够预测未来指数成分股的方差协方差矩阵，在已知股票权重的情况下，可以采用如下公式计算以最小化TE为目标的核心股票最优权重。

假设组合中选择了n只核心股票，还有其他m只股票需要替代。在公式中，
是核心股票的最优权重（n×1向量），ω1
是核心股票在目标指数中的权重（n×1向量），V1
是核心股票的方差协方差矩阵（n×n矩阵），ω2
是非核心股票在目标指数中的权重（m×1向量），Cov2
是核心股票与非核心股票之间的协方差矩阵（n×m矩阵）。

最优化方法的最大好处是为复制指数提供了一个整体框架，可以把各种不同影响复制的因素放在一起考虑。

下面是一个案例，利用4种不同的方法进行复制指数后的跟踪误差。

这里使用4种不同的方式复制沪深300指数，实证测试这些方式在2010年1～12月的跟踪效果，结果如表4-1所示。由于中证指数公司并不公开自由流通量数据，因此依靠可得的数据，即使使用完全复制也存在一定的误差。

表4-1　各种方法在不同股票数量下的跟踪误差（年化） 

数据来源：D-Alpha量化对冲系统

4.2.3　正向套利案例

正向套利流程如下：

（1）根据市场各套利的参数、沪深300指数值，计算指定套利合约的上下边界。

（2）判断指定套利合约的价格是否处于套利边界之内，如果处于套利边界之内则不进行套利活动。

（3）如果合约价格处于套利边界之外，继续判断套利空间的大小，如果套利空间符合预期收益率目标，则进场套利。

（4）根据合约价格与上下边界的比较结果，确定具体操作是正向套利还是反向套利，然后重复以上流程。

案例　股指期货期现正向套利

2010年5月6日，股票市场上沪深300指数收盘时为2896点。此时，12月19日到期的沪深300指数IF1005合约期价为2967点。假设该日市场无风险利率为4.8％，预计2010年沪深300指数成分股年分红率为2.75％，此时是否存在期现套利机会？

（1）计算IF0812指数期货合约的理论价格。

采用连续复利公式F＝I×e（R－d）（T－t）/365
计算，则目前IF1005期货合约的理论价格应为：

F＝I×e（R－d）（T－t）/365
＝1953.2×e（0.048－0.0275）×30/365
＝2900.8点

（2）计算股指期货合约无套利区间，确定套利成本。

股票买卖的双边手续费为成交金额的0.1％：2896点×0.1％＝2.9点

股票买卖的双边印花税为成交金额的0.1％：2896点×0.1％＝2.9点

股票买入和卖出的冲击成本为成交金额的0.5％：2896点×0.5％＝14.5点

股票组合模拟指数跟踪误差为指数点位的0.2％：2896点×0.2％＝5.8点

借贷利差成本为指数点位的0.3％：2896点×0.3％＝8.7点

期货买卖的双边手续费为0.2个指数点：0.2点

期货买入和卖出的冲击成本为0.2个指数点：0.2点

套利成本合计TC＝2.9＋2.9＋14.5＋5.8＋8.7＋0.2＋0.2＝34.8点

无套利区间的上界为：2896＋34.8＝2930.8点

无套利区间的下界为：2896－34.8＝2861.2点

无套利区间为：［2861.2，2930.8］

而沪深300指数IF1005合约的价格为2967点＞2930.8点，即IF1005期货合约的价格大于无套利区间的上界，市场存在正向基差套利机会。投资者可以在拥有沪深300指数成分股投资组合的同时，在期货市场上通过卖出IF1005合约进行套利。

（3）实施套利操作。

首先，计算卖出一手IF1005时的合约价值为：2967×300×1＝8901000元。假定初始资金为1000万元，按保证金比例的20％计算。

初步计算：1000万／（2967×300）≈11手

在期货市场以2967的价格卖出IF1005合约11手，投入初始保证金2967×300×11×20％＝196万。

同时，收盘前买入事先计划好的沪深300指数成分股的股票组合，其市值为：2896×300×11＝956万元。共投入资金为956万＋196万＝1152万元。

（4）市场追踪。

2010年5月21日，沪深300指数IF1005期货合约到期交割，收盘时沪深300指数价格为2768点，而IF1005收盘价为2750点，期货价格与现货价格收敛基本一致。

（5）结束套利。

2010年5月21日收市前，沪深300指数下跌了2726－2896＝-170点，此时，在股票市场上卖出股票投资组合的全部股票，价值约为：2726×300×11＝899.6万元；收市后，在期货市场上以2750点交割11手IF1005期货合约空头头寸，从而结束全部套利交易。

盈亏统计：

在股票市场上，卖出股票投资组合获利：899.6万－956万＝-56.4万元

在期货市场上，11手IF1005期货合约交割后盈利：（2967－2750）×300×11＝71.6万元

盈亏相抵后，总利润为：71.6－56.4＝15.2万元

盈利率＝15.2万／1152万＝1.32％

从2010年5月6日到5月21日，短短半个月的时间获得1.32％的无风险收益，相当年化31％，已经是相当高的收益率了。

4.2.4　结算日套利

1．结算日套利原理

与商品期货中只有企业法人才能进行交割不同的是，股指期货实行现金交割制度，允许个人投资者进行交割。因此，在股指结算日，仍有大批投资者活跃在期货市场上，这是结算日套利的先天条件。

股指期货结算日套利的基本原理是，当股指期货在结算日的价格相对现货价格升水幅度超过交易成本时，套利者可以卖出股指期货并买进股票现货锁定价差进行套利。本质上，结算日套利是期现套利的一种特殊形式，当期现套利的时间缩短至1天时，期现套利就变成了结算日套利，所以结算日套利的基差风险较小。

但结算日套利有其自身的特点，主要集中在结算日效应方面。在股指结算日，期货市场上不同类型的交易者将了结手中的期货和股票头寸，这样短时间内需要卖出或买进大量股票和期货，势必对市场的流动性产生较大冲击。比如，买入套保者，在结算日会卖掉期货，买入股票平仓；卖出套保者，在结算日会卖掉股票，买入期货平仓。在结算价产生时段，不论均匀买卖策略还是集中买卖策略，对市场流动性的冲击都是非常大的。另外，套机者利用期货和现货价格的大幅震荡，追涨追跌，助长了市场的波动。股指结算日效应在美国市场较为明显，典型的如“三巫聚首日”，即当天股指期货、股指期权、股票期权同时到期，市场成交量明显放大，波动加剧。

在股指结算日，股指期货的理论价格F应该等于股指现货的价格S，即有F＝S。考虑交易成本C，如果F＞S，且进一步有F－S＞C，那么投资者可以买入股指现货，卖出股指期货进行套利；如果F＜S，且进一步有S－F＜C，那么投资者可以卖出股指现货，买入股指期货进行套利。

关于交易成本具体如下：期货市场上的成本包括资金利息、手续费等；股票市场上的成本包括，投资组合的认购费、申购费、赎回费、管理费和托管费等，前三者是投资者在买入和卖出投资组合环节直接从投资组合资产中支付的费用，后两者是投资组合在运作过程中直接从投资组合资产中支付的费用。

2．套利策略

在上述分析中根据股指期货到期日可能出现的期货合约及股票现货各种相对价格表现认为其中存在套利机会，而由于国内股票现货T＋0交割制度及个股卖空机制的缺失，其中的套利机会似乎并不能实现，因为当日买进的股票不能卖出，持有个股之前也无法提前卖出。但是借助ETF的交易机制，股指期货到期日无论是期货升水还是贴水，只要其幅度达到能够覆盖交易成本，都可以实施套利交易。

1）升水情景

根据ETF交易机制，当日买进的ETF份额可以立即或在当日随后的某一时刻直接转换成一揽子股票的组合，且该股票组合可以在当日卖出，因此当股指期货出现较大幅度的升水时，可以实施的套利策略如下：

首先，根据ETF对应一揽子股票与股指期货标的指数之间的相关性，选择合适的ETF构建组合以跟踪标的指数；其次，当期货合约升水幅度足以覆盖交易成本时，买进ETF组合并随即转换成股票现货组合，同时卖出股指期货合约；最后，在股指期货结算价产生的时段内平均卖出股票现货，而股指期货合约持有至收盘结算。

上述的套利策略，能够回避采取一般正向套利因为股票现货T＋0交割制度而无法当日结束套利组合的矛盾。

2）贴水情景

在到期日出现股指期货相对股票现货较大幅度贴水时，可以采取现货卖出套利策略，即已经持有现货的投资者直接卖出股票现货并买进股指期货合约，并且考虑到股票现货的交易制度中允许当日卖出的股票当日可以再买回，因此提出如下的套利策略：首先，从已经持有的股票现货中选取组合跟踪股指期货标的指数；其次，当期货合约贴水幅度足以覆盖交易成本时，卖出所持有且能跟踪股指期货标的指数的现货组合；最后，在期货合约结算价产生的过程中，均匀买进股票现货，期货合约持有至收盘结算。

运用上述套利策略，能够获取股指期货相对股票现货较大幅度的贴水部分的收益。另外，由于当日又买回了股票现货，长期持有现货的计划不受影响，获取的套利收益实际上降低了现货持有成本。

3．结算日套利策略影响因素

从到期日内套利策略的实施过程来看，其中涉及很多因素可能影响套利交易的操作及收益状况，具体来说其中包括如下几方面：

1）ETF交易相关隐性成本

由于ETF本身交易过程中会出现升、贴水状况，对于买入ETF换成股票的到期日内套利交易者来说，买进贴水交易的ETF可以摊低套利成本，而ETF升水就不那么有利了。从ETF交易历史数据来看，其升、贴水状态都曾有过一定的表现，且贴水这种有利的局面并非少数。另外，到期日内套利策略还需要考虑ETF交易的最小赎回申购单位的影响，按照交易所规定，ETF交易的最小赎回申购单位为100万份，而实际套利过程中需要买入的ETF份额未必能够达到100万份。

2）现货交易相关隐性成本

对于到期日内套利策略进行的现货交易主要考虑冲击成本和订单执行时间。现货交易的成交时间也是进行到期日内套利交易必须考虑的问题，因为实行该策略需要在当日内完成建仓和平仓，因此对于成交时间的要求更高，其中现货市场的成交速度更需格外关注。另外，需要提示的是，当股指期货相对股票现货升、贴水出现在期货结算价产生的时段即最后两个小时的交易时间内时，即使相对价差较大也不应考虑套利操作，因为可以认为此时无法将股票现货在完整的结算价产生时段均匀卖出或买进，很容易产生较大的偏差。

由于到期日内套利策略的特殊性，需要考虑的实际套利过程中各种可能的影响因素更多，主要包括显性交易成本、ETF交易冲击成本、ETF升贴水、ETF最小申购赎回单位、股票现货交易冲击成本、股票订单执行速度等。

4.3　跨期套利

4.3.1　跨期套利原理

股指期货的跨期套利，是指利用两个不同交割月份的股指期货合约之间的价差进行的套利交易。一般来说，相同标的指数的股指期货在市场上会有不同交割月的若干合约同时在交易。由于同时交易的不同交割月合约均是基于同一标的指数，所以在市场预期相对稳定的情况下，不同交割日期合约间的价差应该是稳定的，一旦价差发生了变化，则会产生跨期套利机会。

严格来讲，跨期套利不是无风险套利，它实际属于价差套利，投资者需要对不同到期月的期货合约的价差做出预测，具有投机性，但因为交易行为是建立在价差的基础上的，所以风险要远远小于纯粹的投机交易即单方向做多，或单方向做空。跨期套利的操作重点在于判断不同到期月合约的价差将来是扩大还是缩小，而不是整个市场的未来走势。

均衡价差测算

从理论上看，不同合约间价差会收敛并趋向于均衡价差，这就是同一标的指数的不同交割月股指期货合约之间存在着的一种平价关系，即远月合约的价值应该是近月合约价值按照远期利率进行复利后加上一个均衡价差，其理论值可以参考不同合约间的平价计量模型：

其中：

（1）T1
为近期合约到期日，T2
为远期合约到期日。

（2）F（t，T1
）：到期日为T1
的近月合约在t期的价格。

（3）F（t，T2
）：到期日为T2
的次近月合约在t期的价格。

（4）f：T1
到T2
的无风险利率（年利率根据时间期间换算）。

（5）△D：同一标的指数不同交割月合约的均衡价差。

股指期货的同一标的指数的两个不同交割月期货合约之间存在一个均衡价差，跨期套利的成功率和收益率与该均衡价差的确定密切相关，但这一均衡价差并非固定不变的。现实中，它除受到利率影响外，还受到诸多其他市场因素的影响，如股票现货交易的活跃程度、宏观经济政策变化、市场冲击成本及投资者预期和情绪等众多因素。因而即使是同一标的指数的任意两个不同交割月合约的均衡价差也各不相同，甚至同一标的指数的两个交割月合约在不同时期的均衡价差也并不一致。

4.3.2　无套利区间

无套利价差区间是指综合考虑了融资成本、交易成本等方面的因素后，相关期货合约之间价差的合理区间。类似于期现套利模型，跨期套利交易中也需要求得无套利价差区间，由于股指期货合约交易成本（融资成本、交易手续费及冲击成本等）的存在，只有当价差收益大于交易成本时才可以进行跨期套利，当价差在该区间内变动时，不存在套利机会。

显然，一旦价差大于无套利价差区间上边界，就可以采用卖出套利策略；一旦价差小于无套利价差区间下边界，就可以采用买进套利策略，直至合约间价差又回归到无套利区间内，跨期套利合约就可以适时平仓。

1．买进套利

对于买进套利交易而言，无套利价差区间测算公式如下：

若想实现在买入套利交易中获利，必须做到套利收益大于交易成本，在近远月合约价差套利过程中涉及买卖两份合约并到期平仓，交易成本为每份期货合约交易费用的4倍，即4C1
。另外，在实际交易中，成本这部分还应考虑股指期货合约的冲击成本，此处将两合约买卖双边冲击成本之和用C2
表示。在进行买进套利，即执行卖近买远策略时，近月和远月合约的价格应满足下式，否则将会遭受损失：

2．卖出套利

对于卖出套利交易而言，无套利价差区间测算公式如下：

同样，若想实现在卖出套利交易中获利，必须做到套利收益大于交易成本。在进行卖出套利，即执行买近卖远策略时，近月和远月合约的价格应满足如下公式，否则将会遭受损失：

4.3.3　跨期套利触发和终止

触发条件

在分析了跨期套利的无套利价差区间后，可实时计算并监控各近远月合约组合的无套利价差：

一旦近远月合约价差偏离无套利价差区间及达到跨期套利交易触发条件即可开仓。具体而言，触发条件为当任意两个近远月合约组合出现如公式（2）的情况时，即可触发卖出套利，采取买入近月合约、卖出远月合约的策略。

当任意两个近远月合约组合出现公式（3）所表示的情况时，即可触发买进套利，采取买入远月合约、卖出近月合约的策略。

相对地，跨期套利也有其终止条件，且不论采取的是哪种跨期套利策略，如果发现价差落入无套利价差区间内，就需要进行两份近远月合约的同时反向平仓操作，终止套利。即：

相对于均衡价差而言，交易成本因素相对变动较小，对跨期套利交易的影响也相对较小，均衡价差在不同情势下可能会有较大变动，因此均衡价差的确定是跨期套利的关键。现实中的均衡价差由于受综合因素的影响而具有一定的不确定性，在实际测算均衡价差中要根据不同市场的特殊情况对基本方法做适当的调整。

然而，众多因素对均衡价差的影响也有具有一定的规律性，通过分析这类因素可得到均衡价差的大致波动区间或者变化趋势，这显然对股指期货跨期套利的成功很有价值。跨期套利中的交易成本主要包括交易手续费、期货交易税、保证金的机会成本和交易执行中的冲击成本等。

（1）一般而言，交易手续费、期货交易税属于固定成本，而交易手续费则具有一定的灵活性，因此跨期套利的成本有进一步降低的空间。

（2）保证金的机会成本是相对利率的机会成本。进行价差套利时，交易所所要求的保证金比同时买进或者卖出两个合约所需要的保证金少，这降低了因保证金支出所造成的利息成本，也使得在合约期限较短的跨期套利中可以忽略这一部分成本的影响。

（3）执行成本属于变动成本。跨期套利交易中要求投资者迅速且同时完成买进与卖出操作，这样通常会对股指期货市场造成较大的冲击。一次完成巨量交易可能使投资者不得不以较为不利的价格成交，付出较大的冲击成本。而倘若投资者想以较小的冲击成本完成交易，必须以延长交易时间为代价，这使投资者面临无法套利或者随着时间延长价格发生大幅度波动的风险，因此，在制定套利方案时必须考虑冲击成本的影响。

前述研究中的理论价差模型考虑了近月合约的时间复利因素，因而相应的均衡价差也是考虑了复利因素后进行算术测算的结果。即：

考虑时间复利因素后的均衡价差在理论上更有说服力，然而却很不直观，在实际运用中，投资者往往对合约间的简单价差十分敏感。即：

简单价差与考虑复利因素后的价差在数据测算上确实存在一定差别，粗略地看，考虑复利后的均衡价差相当于将简单价差向下水平移动一个量值，对均衡价差与无套利价差区间共同决定的跨期套利机会应该没有影响，在实际操作中运用简单价差替代理论价差是可行的。

按照套利结束时间，可分为如下3种情况。

（1）近期合约到期前平仓。跨期套利机会出现的时间有长有短，有的套利活动是当日开始并当日结束，有的则可能持续几日或一段时间。如果选择在近期合约到期之前平仓，此时近远期的结算价格均为期货当天的结算价格。

（2）近期合约到期时平仓。如果选择在近期合约到期时平仓，那么近期合约的计算价格为当时的现货价格。

（3）近期合约到期后转为现货。如果在近期合约到期时，近远期合约的价差足够大，在弥补现货交易和模拟成本的情况下还有一定的价差收益，就可以进行期转现操作，即将近期合约转成现货头寸，并保留远期合约，近期合约到期后，远期合约顺势成为近期合约，此时，跨期套利转变为期现套利。

4.3.4　实证案例：跨期套利策略

2010年4月30日，股指期货近期合约IF1006与远期合约IF1112二者价差高达160基点，此时大盘正在持续下跌，我们认为两个合约的价差远远超过了理论价差，在未来一段时间很可能回归，因此可以进行做多IF1006，同时做空IF1112的跨期套利交易。

股指期货多头跨期套利过程分析如表4-2所示。

表4-2　股指期货多头跨期套利过程分析 

4.3.5　主要套利机会

1．程序化跨期套利机会

如果跨月价差波动表现相对稳定，而且持续在一定区间范围内波动，这个时候存在很好的程序化跨期套利机会，比如在2011年6月22日至7月1日期间，IF1109和IF1108两者价差基本在10～15点之间波动，如图4-2所示，安全起见，可以上下均让掉0.5个点，即当价差回落至10.5点的时候，进行反向套利操作，买进IF1009卖出IF1008；当两者价差扩大至14.5点时，将套利头寸平掉，粗略估算交易手续费为1个点，那么可以赚取3个点的利润。同时，反手进行正向套利操作，买进IF1008卖出IF1009，等待价差回落至12.5点。如此反复循环，虽然每次利润较少，但机会出现频繁。因此，总的来看，收益还是不错的，不过这种套利机会只适合程序化交易。

图4-2　跨期套利中IF1109与IF1108价差稳定波动区间

资料来源：［杨卫东　2011］

2．事件性跨期套利机会

在红利发放期间，合约间的价差都容易发生较大幅度的变化，而恰恰跨期套利对于由分红引起的价差变动比较敏感，特别对于持有成本模型而言，分红率影响着无套利区间的上下限。沪深300成分股每年的红利集中发放的5、6和7月份，这一时期价差变化幅度也较大，是实施跨期套利的良好机会。根据经验规律，随着分红高峰的到来，远月与近月合约价差重心会走高，反之，价差会走低。因此，可以在红利发放前期考虑进行反向跨期套利，因为随着价差的扩大，反向跨期套利将获利；反之，在

红利发放结束前期可考虑正向跨期套利。例如，2010年7月8日IF1012与IF1008价差为67点，此时成分股分红的高峰期刚过，可以考虑进行买IF1008卖IF1012的正向套利操作，7月19日，价差缩小至40点，8个交易日可以赚取27点价差，如图4-3所示。

图4-3　IF1012与IF1008价差走势（2010/07/08—2010/07/23）

资料来源：［杨卫东　2011］

3．新合约上市首日所潜在的跨期套利机会

一般来说，新合约上市都会受到一定程度的追捧，从合约走势上看，大多呈现平开或者高开高走的态势。新合约容易走高，一方面是市场有炒新的惯性思维，新合约容易吸引人气，这样就容易出现价量齐升的局面；另一方面是新合约的定价上有一定时间价值低估倾向，那么其会低于实际价值，随后就会被市场所纠正，合约会顺势走高。正是基于这样的原因，新合约和当月合约价差扩大的概率较大，因此，新合约上市首日存在较好的跨期套利机会，即在买入新合约的同时卖出当月合约，等价差扩大到一定程度后，双向平仓获利。比如，IF1103合约上市首日，IF1103与IF1008价差开盘时最低，随后价差快速扩大，盈利空间在10个点以上，如图4-4所示。另外，IF1007和IF1008作为新合约上市的首日，也同样存在这种跨期套利机会。

图4-4　IF1103与IF1008合约7月19日价差走势

资料来源：［杨卫东　2011］

4．老合约在退市之前几个交易日潜在的跨期套利机会

这里以IF1009合约与IF1008合约作为研究对象，从2010年8月12日开始，主力逐步开始移仓，IF1009持仓稳步增加，交易量从8月16日开始快速放大，资金移仓明显，受到资金推动效应影响，IF1009合约出现价量齐升局面；反观IF1008合约，由于资金逐步撤出，IF1008对于投资者的吸引力大大降低，资金关注度的弱化也拖累了其走势，两者相比IF1009走势明显强于IF1008走势。从两者价差上看，8月12日两者价差最低不足7点，不过之后随着主力移仓效应的逐渐放大，两者价差持续拉大，8月19日即IF1008合约交割前一交易日，价差达到最大值超过22点，如图4-5所示。

图4-5　IF1009-IF1008价差关系图（2010/8/11—2010/8/19）

资料来源：［杨卫东　2011］

因此，基于主力移仓效应到来的跨期套利机会不容忽视。投资者可以考虑这样一种策略：即临近交割日前7个交易日的时候就可以考虑卖出当月合约，同时买进次月合约的跨期套利操作，临近交割日的前一个交易日选择获利了结，该策略风险相对较低，而收益较为稳定。

4.4　冲击成本

套利交易中所需要支出的成本包括交易成本、资金成本和冲击成本，交易成本主要是指手续费、印花税等，资金成本主要是指资金无风险利率，这两个成本都是固定的，而冲击成本则是影响套利交易最主要的成本。

冲击成本是指在套利交易中需要迅速而且大规模地买进或者卖出证券，未能按照预定价位成交，从而多支付的成本。冲击成本被认为是机构大户难以摆脱的致命伤。

冲击成本全称为价格冲击成本，国际上通常用它来衡量股市的流动性。它也可称为流动性成本，是指一定数量的委托（订单）迅速成交时对价格的影响，因此是一个包含即时性和合理价格两方面要素的指标。

相应的流动性成本指标（价格冲击指数），即一定数量（如10万元）交易对市场价格的冲击程度。

股指期货套利中所有头寸的交易都存在冲击成本，比如现货构建中，会有股票组合冲击成本、ETF组合冲击成本、开放式投资组合冲击成本。股指期货也有股指期货的冲击成本。但是由于期现套利组合的绝大部分冲击成本来自于股票组合的构建，所以在下面的讨论中，将主要研究股票组合的冲击成本。

4.4.1　主要指标

1．冲击成本指数

设B1
、B2
、B3
、B4
、…、Bn
与Bq1
、Bq2
、Bq3
、Bq4
、…、Bqn
分别为t时刻限价订单中价格由高至低排序的各买盘的价格和数量，S1
、S2
、S3
、S4
、…、Sn
与Sq1
、Sq2
Sq3
、Sq4
、…、Sqn
分别为t时刻限价订单中价格由低至高排序的各卖盘的价格和数量，那么买入Q金额的股票的冲击成本指数计算公式为：

其中，
LN为自然对数符号。

卖出Q金额的股票的冲击成本指数计算公式为：

其中，

冲击成本指数即为买入冲击成本指数和卖出冲击成本指数的平均值。

2．流动性指数

设B1
，B2
，B3
，B4
，…，Bn
与Bq1
，Bq2
，Bq3
，Bq4，
…，Bqn
分别为t时刻限价订单中价格由高至低排序的各买盘的价格和数量，S1
，S2
，S3
，S4
，…，Sn
与Sq1
，Sq2
，Sq3
，Sq4
，…，Sqn
分别为t时刻限价订单中价格由低至高排序的各卖盘的价格和数量，那么t时刻使价格下跌1％的流动性指数计算公式为：

其中，

t时刻使价格上涨1％的流动性指数计算公式为：

其中，

3．宽度

绝对买卖价差：Spreadt
＝（St
－Bt
）

相对买卖价差：

其中，St
为最优卖价（卖一价），Bt
为最优买价（买一价）。

绝对有效价差：是订单实际成交的成交量加权平均价格（P）与订单达到最优报价中点（Pm
）之间的差额。

绝对有效价差＝2×|P－PM
|

4．深度

累计披露报价深度＝（累计5个披露买价深度＋累计5个披露卖价深度）/2

4.4.2　实证案例：冲击成本

这里以2009年深交所全部上市股票为计算样本，计算所需的逐笔数据来自深交所中心数据库存储的所有股票全部订单的逐笔订单、成交数据和行情数据。

其中，按照公司规模、机构持股比例和股价对股票进行分类比较，其标准如下：

（1）公司规模分类是根据年末股票流通市值按30％、40％和30％的比例分为3组。

（2）根据2008年机构持股（占流通股）比例值按30％、40％和30％的比例分为3组：低机构持股比例组、中机构持股比例组和高机构持股比例组。

（3）以2008年全年平均股价为标准，将深市A股股票按30％、40％和30％的比例分成低价股、中价股和高价股3组。

1．冲击成本指数和流动性指数

2009年深市A股10万元冲击成本指数为14个基点，1％的流动性指数为300万元，如图4-6和图4-7所示。

图4-6　2009年深市股票冲击成本指数（10万元）

资料来源：深圳证券交易所

图4-7　2009年股票流动性指数（1％）

资料来源：深圳证券交易所

2．宽度

深市A股相对买卖价差为16个基点，相对有效价差为58个基点，如图4-8所示。2009年绝对买卖价差和绝对有效价差分别为2.17和8.72分（剔除新股上市首日后绝对有效价差为5.19分，如图4-9所示）。

图4-8　2009年深市股票相对价差

资料来源：深圳证券交易所

图4-9　2002—2009年深市股票绝对价差

资料来源：深圳证券交易所

4.5　保证金管理

股指期货保证金指股指期货交易中，交易所为了降低交易双方的违约风险而要求交易双方缴纳的一定数额的资金，分为初始保证金和维持保证金，当交易者保证金账户余额低于维持保证金，则需追加至初始保证金，因而对于交易者而言，需要预留部分资金以备在大幅波动市况下追加保证金。

股指期货套利，尤其是期现套利中，保证金管理具有很重要的作用。在市场出现剧烈波动的时候，尤其是大幅度上涨的行情中，如果保证金覆盖不足，则可能出现爆仓情况，从而使得套利组合无法坚持到结算日从而提前终止，出现亏损。因为在建仓初始，就需要进行保证金覆盖的测算，使得初始保证金能够在较大的概率下覆盖整个套利期间内的波动。

4.5.1　VaR方法

VaR（Value at Risk）是一种重要的风险分析与管理工具，其基本的表述是：在市场正常波动条件下，某一金融资产或资产组合在未来特定的时期内和在一定的置信水平下可能发生的最大损失，即VaR为某些前提条件下确定的一个数值，表示为：

P（△W＞VaR）＝1－α

其中，△W表示在市场正常波动条件下，某一金融资产或资产组合在未来特定时期△t内在置信水平为α的情况下的损失。

VaR方法中都要涉及两个主要的参数：持有金融资产的期限和置信水平。所有的VaR方法的使用和计算都要在这两个参数给定的情况下才有意义。

由于投资金融资产的收益或损失与持有金融资产的期限长度呈正相关性，VaR随着持有期限的增加而增加，持有期限通常考虑如下4种因素：

（1）金融市场的流动性：交易头寸流动越迅速高效，则可以选择较短的持有期限，相反，则更长一些的持有期限比较合适。

（2）收益的分布特性：由于采用概率的方法，需要假定资产的收益服从一定的分布，最为简便的方法是假定持有资产的收益呈正态分布。实证表明如果持有期限越短，资产实际收益分布越接近正态分布。

（3）持有头寸的调整：在实际的金融活动中，投资者会根据市场的具体状况对其持有的头寸和组合进行不断的调整，持有期越长，投资者改变组合中的头寸的可能性就越大。而在VaR方法的计算中，通常假定在给定的持有期限内资产或资产组合的头寸保持不变，因此，持有期限越短越容易满足资产或资产组合头寸保持不变的假定。

（4）数据的限制：VaR方法的计算需要持有的金融资产收益有关的历史数据，用以估计其收益率及方差或波动性，如果期限过短，则数据采集量会受到限制。

至于如何选择置信水平，需要考虑多种情况，包括：VaR验证的需要、内部风险资本的需要、外部监管要求以及不同机构之间比较等。数学上对于不同概率分布类型的考虑，也使得选择合理有效地置信水平成为一种需要。置信水平的确定和选择，在一定程度上反映了监管者和投资者对于市场和金融产品风险的态度，实际应用中会依据不同的目的设定不同标准的置信水平。

4.5.2　VaR计算方法

VaR的计算方法通常有三大类：分析法、历史模拟法和蒙特卡罗模拟法，这3种方法从不同角度来分析资产的风险价值。后面的案例中将对股指期货交易中保证金的最大损失值进行计算，即对保证金的VaR值进行估计。

1．分析法

分析法是VaR计算中最为常用的方法，此种方法首先要清楚资产价格服从的分布特征，分析法的不足是假定正态分布的准确性和可信性，其优点是简化VaR繁重的运算负担，为普通投资者和管理者提供了一套强大的统计工具。

VaR分析法的使用，首先通过假定或者实证来确定资产价格服从的分布类型，分布类型的确定和选择是进行VaR方法理论分析和实证研究的关键。如果资产或资产组合的收益率服从正态分布，则该资产或资产组合VaR的计算可以简化，在正态分布条件下，可以根据置信水平α确定相应的分位数，记为Zα
，将资产或资产组合的收益率分布的标准差σ与该分位数Zα
相乘，记为VaR值。

2．历史模拟法

历史模拟法要求投资者收集并利用所持有资产或资产组合在过去一段时期内收益率分布的历史数据，其核心是根据影响资产或资产组合的市场因子的历史样本变化来模拟证券组合的未来损益分布，并利用分位数给出在一定置信水平下的VaR估计。历史模拟法的基础是假定资产收益率历史的变化会重演，从而根据历史数据来确定在持有资产或资产组合期内损失的最大值。

历史模拟法是一种非参数方法，它不需要假定市场因子的统计分布，因此可以较好地处理非正态分布的资产或资产组合的收益率。

历史模拟法主要步骤如下：

（1）映射：分析确定影响资产或资产组合的市场因子，收集每个市场因子适当时期的历史数据，并用市场因子表示出资产或资产组合中各个金融资产的盯市价值。

（2）估计每个市场因子价值波动和未来价格，根据市场因子过去n个日期价格的时间序列，计算每个市场因子在n个时期内价格水平的实际变化，再假定未来的价格波动与过去一致，由市场因子的当前价格水平，可以直接估计出每个市场因子未来一个时期的n种可能的价格水平。

（3）估计组合的未来收益，利用资产价格公式，根据所有市场因子价格未来n种可能值，估计资产或资产组合未来的n种可能价格，并与资产或资产组合的当前价值或期望价值相比较，得到资产或资产组合未来的n个可能损益的分布。

（4）确定VaR值，将损益分布按递增次序排列，按给定的置信度某一分位数，求出资产或资产组合相应的VaR值。

3．蒙特卡罗法

蒙特卡罗法又称随机抽样方法或统计实验方法，其主要思想是：当所要求解的问题是某种事件出现的频率，或者是某个随机变量的期望值时，它们可以通过试验的方法，得到这种事件出现的频率，或者这个随机变数的平均值，并用它们作为问题的解。在VaR的分析和计算中，主要包括以下3个步骤：

（1）估计资产或资产组合收益率的平均数和标准差，并就标准正态分布进行函数抽样，抽样次数为n，得到n个标准正态随机变量Zi
。

（2）将所得到的n个标准正态随机变量Zi
数值代入
得到正态分布条件下的收益率数值。

（3）将上述模拟结果按从小到大的顺序进行排列，取某一分位数，确定可得到在蒙特卡罗模拟下的VaR估计值。

4.5.3　实证案例

本案例采用VaR分析法，根据沪深300指数从2005年4月8日到2010年4月6日共1214个交易日收盘价的收益率，分析和测算了保证金水平从15％至25％、开仓比例从30％至100％等诸多情况下，该保证金水平能够覆盖的市场波动率及相应的概率，如表4-3所示。

表4-3　不同开仓比例下的不同保证金水平能够覆盖的市场波动及其概率 

数据来源：［吴泱　2010］

从表4-3中可知，如果期货公司的股指期货保证金比例为15％，投资者的开仓比例为30％，那么在不考虑强行平仓的情况下，这15％的保证金可以覆盖7.5％的市场波动，而根据沪深300指数的历史数风险管理研究据估算，日行情波动落在7.5％以内的概率为99.56％。

如表4-4所示为在不同股指期货合约持有期限下，所需要的保证金覆盖比例。例如，在99％的置信区间下，持有期间为10天的股指期货合约，在15％保证金比例下，需要初始的保证金为2.215倍。也就是要多准备1.215的保证金数额，以覆盖未来10天的波动。

表4-4　不同仓单持有期下的保证金覆盖比例 

资料来源：［吴泱　2010］

思考

3．策略模型越复杂越好吗？

这恐怕是大部分做量化投资的人的主流想法，也是大部分对量化投资不了解的人的本能想法：一定是越复杂的模型效果越好。但是笔者对此持有不同看法。笔者认为：真正有效的策略是简单的，因为越简单的策略越具有稳定性和可靠性。一个过于复杂的策略模型会存在两个问题：第一是子模型的冲突问题；第二是鲁棒性问题。

在一个复杂的模型中，由于不同策略因子之间的相关性及对数据的要求不一样，会使得这些子模型之间产生冲突，从而发出影响策略效果的交易信号。并且在一个较长的时间范围内，越复杂的模型的稳定性越差，这是系统论已经得出的基本结论。

至于在量化投资策略中是不是需要复杂的数学工具，笔者也是持有谨慎的看法。所谓复杂的数学工具的唯一价值就在于解决预测精度的问题。如果简单的数学工具可以实现交易者需要的预测精度，那就完全没有必要使用复杂的数学工具。虽然本书在理论篇中介绍了数据挖掘、小波分析、SVM等现代复杂的数学工具，但笔者并不认为这些数学工具是必需的，是万能的。

能找到市场的规律，发现市场的缺陷所在，进而开发出交易策略击败市场，获取收益，这才是一个宽客需要努力的关键方向，策略思想才是量化投资的核心所在。

西蒙斯曾经解密过他的一个简单的交易策略：在每天开盘的时候决定交易方向，如果开盘价过高（判断过高，可以根据历史数据的统计检验来计算），则做空，回落后平仓；如果开盘价过低，则做多，反弹后平仓。如果没有如预期走势，则到达止损位后平仓。该策略并没有用到复杂的数学模型，但是在相当长的时间内都是相当有效的。

笔者对该策略在国内市场，尤其是期货市场的检验也表明，该策略具有相当的有效性。尤其是中国的期货市场受到国际市场的影响很大，往往开盘价会一步到位，然后盘中出现反弹或者滑落的走势，给了短线交易者相当多的获利机会。

在股票市场也有类似的简单有效的策略，联合证券的研究员提出过一个“山寨法”来构建股票组合，基本思想就是：在每次的季报发布之后，将过去一段时间收益率最高的几个基金产品的重仓股作为自己的投资组合，并且在每次季报发布后再进行组合的调整。在考虑了交易成本和冲击成本后，如此简单的组合策略的收益率可以排进基金产品的年化收益率前十，并且在相当长的时间内，该策略具有稳定持续的超额收益。

笔者对此策略进行检验后也发现，确实如报告中所说，只需简单地跟随，就完全可以获得超额收益。这个策略的思想和市场上普遍的跟庄策略有异曲同工之妙，将这些优秀业绩的基金看做是公开的庄家就可以了。因为市场上确实有一批这些基金的追随者，他们的羊群效应会引发市场的变动，从而强化了这个策略的有效性。

“大道至简”，深入分析市场，找到市场的缝隙，远比复杂的数学模型更重要。

第5章　商品期货套利

◆摘要◆

与股指期货套利类似，商品期货同样存在套利策略，在买入或卖出某种期货合约的同时，卖出或买入相关的另一种合约，并在某个时间同时将两种合约平仓。在交易形式上它与套期保值有些相似，但套期保值是在现货市场买入（或卖出）实货、同时在期货市场上卖出（或买入）期货合约；而套利却只在期货市场上买卖合约，并不涉及现货交易。

商品期货套利主要有期现套利、跨期套利、跨市场套利和跨品种套利4种。

（1）期现套利，是利用同一种商品在期货市场与现货市场之间的不合理价差进行的套利行为。当期货价格与现货价格之间出现不合理的基差时，套利者通过构建现货与期货的套利资产组合，以期望基差在未来回归合理的价值区间并获取套利利润的投资行为。

（2）跨期套利正是通过观察期货各合约价差的波动，以赚取差价为目的，在同一期货品种的不同合约月份建立数量相等、方向相反的交易部位，并以对冲或交割方式结束交易的一种操作方式。正向市场时，价差为负，表现为远月升水，反向市场时，价差为正，表现为近月升水。一般来说，价差（绝对值）由持有成本（或持仓费）构成，即指为拥有或保留某种仓单或头寸而支付的仓储费、保险费和利息等费用。

（3）跨市场套利是指在不同市场之间进行的套利交易行为。当同一期货商品合约在两个或者更多市场进行交易时，由于区域间的地理差别等因素，各商品合约间存在一定的固有价差关系。但是，由于两个市场的供求影响因素、市场环境及交易规则等方面不完全一致，价格的传导存在滞后甚至失真的情况，因此固有价差水平会出现偏离。跨市场套利正是利用市场失衡时机，在某个市场买入（或卖出）某一交割月份某种商品合约的同时，在另一个市场卖出（或买入）同一交割月份的同种商品合约，以对冲或交割方式结束交易的一种操作方式。这种套利可以在现货市场与期货市场上进行，也可以在异地交易所之间进行，其中也包括国内交易所与国外交易所之间。

（4）跨品种套利是指利用两种不同的，但相互关联的商品之间的合约价格差异进行套利交易，即买入某一交割月份某种商品合约，同时卖出另一相同交割月份相互关联的商品合约，以期在有利时机同时将这两个合约对冲平仓获利。跨品种套利的核心策略是寻找两种或多种不同但具有一定相关性的商品间的相对稳定关系（差值、比值或其他），在其脱离正常轨道时采取相关反向操作以获取利润。根据套利商品之间的关系，跨品种套利可分为相关商品套利和产业链跨品种套利两种类型。

需要说明的是，套利仍是一种投机行为，只要套头没有全部对冲，就存在着风险，这就对套头的正确处理提出了较高的要求。对于套利投机也要像单向投机那样用变化的、动态的眼光去对待，而千万不可用静态的、固定的及僵化的眼光去对待，否则，所谓风险较小的套利也会以损失较大而告终。

5.1　基本概念

商品期货套利指的是在买入或卖出某种商品期货合约的同时，卖出或买入相关的另一种合约，并在某个时间同时将两种合约平仓的交易方式。在交易形式上它与套期保值有些相似，但套期保值是在现货市场买入（或卖出）实货和在期货市场上同时卖出（或买入）期货合约；而套利却只在期货市场上买卖合约，并不涉及现货交易。这一交易方式大大丰富了期货投机交易的内涵。

在进行套利交易时，交易者注意的是合约价格之间的相互变动关系，而不是绝对价格水平。他们买进自认为是便宜的合约，同时卖出那些高价的合约。如果价差的变动方向与当初的预测相一致，交易者即可从两个合约价格间的相互变动中获利。因此，对于交易者来说，理解套利交易原理和掌握一些交易技巧是非常必要的。

套利的潜在利润不是基于商品价格的上涨或下跌，而是基于两个套利合约之间的价差扩大或缩小。因此，套利获得利润的关键就是差价的变动。

5.1.1　套利的条件

完成套利交易，期货合约之间需要具备以下条件。

（1）条件之一：其历史差价变化必须具备一定的规律。大多数情况下，商品期货的差价变化会在一定幅度内波动，极少有差价突破其上下边沿的情况。当差价扩大或缩小到一定程度之后，其后的差价波动会向相反的方向变化。从历史上的变化情况来看，这种差价在一定幅度内的来回波动是一个大概率事件。

（2）商品期货合约之间的价格波动必须具备一定的相关性和联动性。这一点可以从概率统计学角度计算其相关系数，由此来证明其相关性和联动性的大小。

在计算商品期货价格波动的相关性系数时，可以将两个合约每天的收盘价作为一个离散性随机变量。假定某合约的收盘价为变量X，另一个合约的收盘价为变量Y，则：

①X′：变量X的样本均值。

②Y′：变量Y的样本均值。

③Sx
：变量X的样本方差。

④Sy
：变量Y的样本方差。

利用上面的公式，就可以计算出两个合约之间的相关系数，通过数学检验，可以证明这两者间的相关性大小。实践表明，相关系数在0.70～0.95之间的期货品种间套利效果比较好。如果相关性过高，风险固然很小，但套利空间太小，收益率较低；如果相关性过低，套利空间会明显加大，收益率显著提高，但风险也大为增加。

（3）拟套利的期货合约应有足够的流通性和足够的容量。

合约的持仓量在拟套利头寸数量的10倍以上比较理想，否则，进出不便会严重影响操作效果。

套利可能出现的结果有以下几种：①盈利额大于亏损额，结果盈利；②盈利额小于亏损，结果亏损；③盈利额等于亏损，结果持平；④盈利＋盈利，结果盈利；⑤亏损＋亏损，结果亏损。

由此可见，套利也是有风险的，要努力实现①、④两种结果，而尽量避免②、⑤两种结果。

5.1.2　套利基本模式

1．期现套利

期现套利是指某种商品期货合约，当期货市场与现货市场在价格上出现差距，从而利用两个市场的价格差距，低买高卖而获利。理论上，期货价格是商品未来的价格，现货价格是商品目前的价格，按照经济学上的同一价格理论，两者间的差距，即“基差”（基差＝现货价格－期货价格）应该等于该商品的持有成本。一旦基差与持有成本偏离较大，就出现了期现套利的机会。其中，期货价格要高出现货价格，并且超过用于交割的各项成本，如运输成本、质检成本、仓储成本、开具发票所增加的成本等。期现套利主要包括正向买进期现套利和反向买进期现套利两种。

当期货价格大于现货价格时，称为正向市场。当期货价格对现货价格的升水大于持有成本时，套利者可以实施正向期现套利。即在买入（持有）现货的同时卖出同等数量的期货，等待期现价差收敛时平掉套利头寸或通过交割结束套利。

当期货价格小于现货价格时，称为反向市场。反向套利是构建现货空头和期货多头的套利行为（在期现套利中就是做空基差），由于现货市场上不存在做空机制，反向套利的实施会受到极大的限制。

2．跨期套利

跨期套利是指在同一市场（即同一交易所）同时买入、卖出同种商品不同交割月份的期货合约，以期在有利时机同时将这两个交割月份不同的合约对冲平仓获利，这种套利交易形式是套利交易中最普通的一种。

导致不同合约月价格差的主要原因是资金不均衡作用和季节性因素，有时资金主要集中在某一个合约上角逐，使得合约的波动速度要明显快于其他合约，这就意味着套利机会的来临。跨期套利最明显的好处是容易掌握，考虑因素相对比较简单，而且结算在同一交易所进行，不需要划转资金，容易实现账面平衡。例如，大连大豆5月合约与9月合约之间的套利。

相对而言，这是一种最为简单的套利模式，需要注意的是，最简单的东西，操作上有时最不容易把握，这主要是因为套利的时机往往稍纵即逝，没有在合适的时机入市，可能就再也无法入市了。对冲时机的把握也面临同样的问题，不能迅速决断，可能很长时间形成的利差在瞬间就消失了。

另外，还因为交割地位的差别有时会不断地强化某种价差的变化趋势而无法使其逆转，这样，过分拘泥于绝对价差达到某一水平而进行的跨期套利，往往会因为出现新的不可逆极限价差而导致套利失败。

3．跨商品套利

跨商品套利是指利用两种不同的，但相互关联的商品之间的期货合约价格差异进行套利交易，即买入某一交割月份某种商品的期货合约，同时卖出另一相同交割月份、相互关联的商品期货合约，以期在有利时机同时将这两种合约对冲平仓获利。

跨品种套利通常有两种情况：一种是同一市场的不同品种，比如大连豆粕与大豆之间的套利，上海铜与上海铝之间的套利，郑州强麦与硬麦之间的套利等；另一种是不同市场的不同品种，比如大连大豆与郑州小麦之间的套利，大连豆粕与郑州小麦之间的套利等。

对于同一市场的不同品种而言，主要考虑两个合约之间已经出现的价差和后期价差动态，从这个意义上来说，其与跨期套利没有什么两样。另外，那就是两品种只是相关，而不是完全相同，基本面便有一定的差异，特别是在突变事件出现时将会对其中一个合约发生重大影响，而对另一个合约的影响却非常轻微，这就决定了价格之间相对运动的速度差异。如果能够正确把握这种差异则套利就能获得成功，否则就会失败。

至于不同市场不同品种之间的套利，除了要考虑同一市场不同品种之间套利所要考虑的一切因素之外，还要考虑不同市场之间的保证金划转时间、交易时差等因素，相对而言要复杂一些。

4．跨市场套利

跨市场套利是指在某个交易所买入（或卖出）某一交割月份某商品合约的同时，在另一个交易所卖出（或买入）同一交割月份的同种商品合约，以期在有利时机分别在两个交易所对冲在手的合约获利。

在做跨市场套利交易时应注意影响市场间价格差异的几个因素：

（1）运输成本。不同交易所因与商品产地、销地的距离不同，运输成本就不同，同种商品的合约价格自然会有差异。

（2）交割品级的差异。

（3）当地的供求状况。跨市场套利既可在国内的不同交易所之间进行，也可以在不同国家的交易所之间进行。

跨市场套利，虽然套利在相同的品种之间展开，但因市场有别，所需考虑的因素也很多，除了价差水平、价差的相对运动趋势之外，还要考虑涨跌停板的因素、保证金水平、汇率、资金流动顺利与否等。

比如上海铜与伦敦铜之间的套利，上海铜每天的涨跌停板为3％，而伦敦铜的涨跌停板幅则没有规定，所以当伦敦铜出现100美元以上的上涨时，上海的与之联动，即便以3％涨停板报收也很难与伦敦铜的涨幅相当，这便是套利所面临的风险，尤其是单边行情出现的时候。

第二是不同的市场存在交易时差，显然无法使套利建仓和套利对冲做到完全同步，在市场剧然波动的情况下，另一个套头来不及建仓和来不及对冲时带来的风险足以让套利操作功亏一篑。

第三是追加保证金风险。套利在两个市场之间进行，必然会出现一边头寸盈利，而另一边头寸亏损的情况，且盈利的部分不可能像同一个市场套利那样用来冲抵亏损部分，带来账面的大致平衡。按照交易规则，亏损的一边套头，如不能及时追加保证金，就要强行平仓，强平的结果会使套头数量减少，从而使得套利操作无法贯彻下去。有时还会出现一个市场上的头寸盈利，而另一个市场出现爆仓的现象。显然套利被动地演变成了单向投机，其风险有可能是很高的。

最后是外汇风险。外汇风险主要来自两个方面：一是本币和外汇资金出入境是否畅通；二是汇率波动是否有利。本币与外币流动不通畅，会延误建仓时机，汇率波动有时会使得亏损的一边因汇率因素而亏损得更多，而盈利的一边则因货币的贬值而缩水。例如，分别在伦敦和上海做铜买入和卖出套利，伦敦以美元计价的套头盈利时，国内以人民币计价的套头便是亏损了，可是如果遇上美元贬值，伦敦的盈利因美元贬值而变得非常不明显，而国内的套头就更亏了，最后的结果是套利损失，这就是汇率带来的风险。

5.1.3　套利准备工作

1．套利经验模型的建立

对于拟套利的两个合约（或多个合约）之间的价格波动，需要处理较长的历史数据来反映彼此的关系。一般而言，数据年限越长，所显示的套利区间的有效性越好，因为从统计学的角度来看，这样可以将大概率事件全部囊括其中，具有较高的可靠性。

2．套利空间的确立

对于两合约价格的关系，一般会进行相应的数据处理，较为直观的方法就是用价格比来表示。将数据处理到一张图上，就可以得到一张价格比曲线图，考察价格比曲线的长期波动情况，可以找出套利的上限和下限。通俗地讲，即两合约的比价扩大到一定程度时就会不断缩小，而缩小到一定程度时，又会不断扩大，如此循环往复。确定套利空间，就是要找出套利在何种情况下进行建立套利头寸，在何种情况下要对冲离场。

由于套利操作一般不考虑价格波动的方向，而主要考虑价差的扩大与缩小，因此，除了要确知价差的绝对数值外，还要特别注意价差的波动形势。

如图5-1所示，上海期货交易所3月期铜与伦敦金属交易所铜的比价大多数时间在8.0～10.0之间波动，中轴在9.0。从统计学角度来看，上海期货交易所与伦敦金属交易所3月期铜的比价在8.0～10.0之间波动应是一个大概率事件，因此，其套利区间为8.0～10.0。

图5-1　2004—2011年上海3月铜与伦敦3月铜的比价关系

3．套利操作的基本原则

当套利区间被确立，而当前的状态又显示出套利机会时，就可以进行套利操作了。一般而言，要遵循下述基本原则。

（1）买卖方向对应的原则：即在建立买仓的同时建立卖仓，而不能只建买仓，或是只建立卖仓。

（2）买卖数量相等原则：在建立一定数量的买仓同时要建立同等数量的卖仓，否则，多空数量的不相配就会使头寸裸露（即出现净多头或净空头的现象）而面临较大的风险。

（3）同时建仓的原则：一般来说，多空头寸的建立要在同一时间进行。鉴于期货价格波动，交易机会稍纵即逝，如不能在某一时刻同时建仓，其价差有可能变得不利于套利，从而失去套利机会。

（4）同时对冲原则：套利头寸经过一段时间的波动后达到了一定的所期望的利润目标时，需要通过对冲来结算利润，对冲操作也要同时进行。因为如果对冲不及时，很可能使长时间取得的价差利润在顷刻间消失。

（5）合约相关性原则：套利一般要在两个相关性较强的合约间进行，而不是所有的品种（或合约）之间都可以套利。这是因为只有合约的相关性较强，其价差才会出现回归，即价差扩大（或缩小）到一定程度又会恢复到原有的平衡水平，这样，才有套利的基础，否则，在两个没有相关性的合约上进行套利，与分别在两个不同的合约上进行单向投机没有什么两样。

5.1.4　常见套利组合

理论上来说，相关性和联动性能够满足套利要求的主要有如下几组：

1．沪铜—伦铜跨市场套利组合

沪铜和伦铜保持高度的正相关，相关系数在0.95以上，最高时达到0.99。这一组合是迄今为止投资者使用最多的一种组合。其比价波动区间为8.0～10.0，中轴区为9.0。2002年以来的统计数据表明，不管是熊市还是牛市，都能满足这种关系，规律性非常明显。加上交易活跃，持仓量比较大，适合千万元到亿元以上的大资金运作。

其优点是：套利机会多，容易把握；流动性好，易于进出；运行规范，收益率比较稳定，一般能达到10％以上；意外风险较小。缺点是：交易有时差，进场和出场的点位不易把握，特别是价格波动很大的单边行情；资金划拨相对比较困难，当一边套头因亏损而资金吃紧时，难于从另一个市场抽出资金来补亏，不容易做到资金平衡和头寸平衡；汇率风险较大，比价如图5-1所示。

2．大连交易所大豆—豆粕跨品种套利组合

大连大豆和大连豆粕也保持高度的正相关，一般情况下相关系数为0.91，目前已经达到0.97，但有些合约之间的相关系数只有0.78。大豆与豆粕的比价波动范围在1.28～1.36之间（9月合约），中轴为1.32，比价如图5-2所示。

图5-2　大连交易所大豆5月合约与豆粕5月合约比价

其优点是：报价单位统一，交易时间同步，数据处理简单，容易捕捉套利机会；结算在同一家交易所内进行，套头盈亏互补，易于实现资金平衡；因资金在途而引起的风险几乎为零；收益率较高，可以达到30％以上。并且自2010大连交易所成为全球最大的农产品期货交易所以来，大豆、豆粕的交易量和持仓量稳居全球领先地位，这个组合适合于大资金操作。缺点是：套利区间在不同的时间有较大的差异，因此，意外风险较高。

3．大连交易所L-PVC跨品种套利

大连L和大连PVC保持高度的正相关，一般情况下相关系数为0.85，L与PVC的比价波动范围在1.38～1.50之间（5月合约），中轴为1.41，比价如图5-3所示。

图5-3　大连交易所L-PVC比价

其优点是：报价单位统一，交易时间同步，数据处理简单，容易捕捉套利机会；结算在同一家交易所内进行，套头盈亏互补，易于实现资金平衡；因资金在途而引起的风险几乎为零；并且L与PVC交易量和持仓量都比较大，适合于大资金操作。缺点是：毕竟是不同的品种，有各自不同的用户范围和市场，如果基本面发生重大变化，可能会出现意外风险。

4．大连交易所大豆—CBOT大豆组合

大连大豆和CBOT大豆保持高度的正相关，相关系数在0.91以上。其比价波动区间为3.2～3.8，中轴区为3.5，比价如图5-4所示。需要说明的是，当合约月刚刚上市和临近交割时，相关性有普遍减弱的趋势。边界明显，阶段性趋势突出。一般而言，两者互动的规律性强，价格回归性良好。每年收益率在25％以上的套利机会多达5～8次。

图5-4　大连大豆—CBOT大豆比价

其优点是：市场容量大，适合过亿的大资金运作；在极端比价处套利容易成功；比价变动的方向性好，一旦形成趋势，不会轻易反复，套利利润容易巩固；流动性好，易于进出；收入率比较稳定，意外风险较小。缺点是：交易有时差，进场和出场的点位较难把握，好在它们的报价连续，这比期铜的跨市场套利要相对容易地抢到合适的价位；报价单位不统一，计算盈亏较麻烦；资金划拨相对比较困难，在途时间较长；单边行情中容易出现一边套头爆仓，进而影响套利效果；汇率风险较大。

5．郑州白糖跨期组合

郑州交易所白糖合约最近几年的成交量出现爆发式增长，多次占据成交量榜首的位置。并且一般具有多个活跃合约，成为跨期套利的好品种。

白糖两个合约的差价会保持比较稳定的价差关系，一般在300～500之间，中轴为400，如图5-5所示。

图5-5　郑州白糖1109月1201合约的差价关系

其优点是：套利机会多，在同一个交易所，客户容易进行资金管理和头寸管理，套头之间的盈亏容易自动平衡，而不必客户去划拨资金。缺点是：套利空间小，收益率不高，并且在换月结束后，另外一个合约的交易量会大幅度减小，从而不适合大资金操作。

5.2　期现套利

5.2.1　基本原理

期现套利，是利用同一种商品在期货市场与现货市场之间不合理的价差进行的套利行为。当期货价格与现货价格之间出现不合理的基差时，套利者通过构建现货与期货的套利资产组合，以期望基差在未来回归合理的价值区间并获取套利利润的投资行为。

基差，是指某一个特定地点某种商品的现货价格与同种商品的某一特定期货合约价格间的价差。简而言之，基差＝现货价格－期货价格。

为什么期货市场与现货市场会出现价差呢？怎样才能判定两者之间的价差是不合理、有利可图的呢？

仔细观察可以发现，在正向的市场中，未来某月期货价格往往比现在的现货价格高出一定的数值（基差），这高出的价格不是空穴来风的，而是包含了现货的持有成本和风险溢价。

所谓持有成本，是指商品的储藏成本加上为资产融资所需支付的利息再扣掉持有资产带来的收入。比如，我国2010年的小麦现在已经收割入库，某企业需要在3个月后购买小麦1000吨。那么这3个月的时间内，小麦的卖家需要承担1000吨小麦的仓储费用及自然损耗的风险，同时由于小麦无法立刻兑现，卖家失去了这部分资金3个月投资获利的机会。因此，在远月期货交易中，买家需要向卖家支付这部分费用。当然，随着时间的推移，期货越临近现货月，其所包含的费用就越低，价格逐步向现货靠拢。

所谓风险溢价，就是投资者为远月期货合约的不确定性支付一定的费用。因为期货交易的是投资者对未来商品价格的预期，由于商品市场是瞬息万变的，因此未来的商品价格跟现在是有很大不同的，这就需要买家或卖家在期货价格上做出一定的让步，以达到供需平衡。

在正向期现套利中，持有成本可以用来支付企业的现货仓单成本，而风险溢价的高低则直接决定了期现套利的收益率。接下来，我们要介绍一个重要的名词：无套利区间，如图5-6所示。商品期货套利中的无套利区间的概念和第4章股指期货套利中的非常相似，都是在考虑了各种成本后，留下的一个价格区间。

图5-6　商品期货期现套利无套利区间

期现套利要考虑交易成本，在期货价格高出现货价格一定幅度的前提下，才可以进行正向套利，现货价加上这个幅度后的价格称为上边界；反之，期货价必须低于现货价一定幅度时，才可以进行反向套利，将现货价减去这个幅度后的价格称为下边界。当期货价位于上下边界之间时，无法进行期现套利，因而将这个上下边界之间称为无套利区间。在期现套利中，确定了无套利区间，便可以根据此监控期现价差寻找套利机会。

5.2.2　操作流程

1．识别套利机会

首先，应选择与企业经营有关的商品。企业投资者做期现套利，目的就是依靠自身的现货优势，结合期货市场的价格偏差获取超额利润，企业自营的商品可以保证购销渠道的顺畅，同时付出最低的成本，以便于达到最好的套利效果。

其次，判断套利的方向。

（1）正向套利：当期货价格大于现货价格时，称为正向市场。当时期货价格对现货价格的升水大于持有成本时，套利者可以实施正向期现套利。即在买入（持有）现货的同时卖出同等数量的期货，等待期现价差收敛时平掉套利头寸或通过交割结束套利。

一般来说，正向套利比较适合商品的生产厂家和贸易中间商。因为正向套利如果进入现货交割阶段，需要投资者卖出现货，生产厂家和贸易中间商的经营目的就是卖出商品，两者的交易流程是同方向的。

（2）反向套利：当期货价格小于现货价格时，称为反向市场。反向套利是构建现货空头和期货多头的套利行为（在期现套利中就是做空基差）。由于现货市场上不存在做空机制，反向套利的实施会受到极大的限制。

在现实中，通常是拥有现货库存的企业为了降低库存成本才会考虑实施反向期现套利。这是因为在现货市场上卖出现货，企业不仅能够获得短期融资，而且可以省下仓储成本。当期货相对于现货的升水过低甚至是贴水的时候，企业就可以考虑反向套利以降低其库存成本。

从本质上来看，这种反向套利的基础依然是持有成本，该持有成本会因企业实际情况的不同而不同。

2．计算持有成本（无套利区间）

因为是期现套利，所以持有成本以持有现货到期交割为基础，一般会发生交易交割手续费、运输费、交割费、仓租费、增值税及资金利息等费用。每个地方的具体情况不同，各项费用往往各异。

自2009年5月25日PVC期货在大连商品交易所上市以来，成交日趋活跃，非常适合大资金的运作和有流动现金的企业进行套利交易，以赚取稳定的利润。

下面以PVC期货为例，期现套利的无套利区间（上边界），即持有成本的各项费用如下。

（1）交易交割手续费：期货公司收取的手续费存在差异。一般来说，交易手续费1元／吨，交割手续费4元／吨。

（2）运输费用：上海有多个交易所规定的PVC交割仓库，注册仓单较为方便。一般汽车的运输费用为30元／吨。

（3）检验费：注册仓单时，实物必须首先经过检验。检验费由卖方承担，买方无须支付检验费用。入库取样及检验费为3000元／批，每批300吨，折合10元／吨（推荐品牌免此项费用）。

（4）入／出库费：火车、轮船、汽车的出入库费用各异，而不同交割仓库的出入库费用也各不相同。汽车的出入库费用为25元／吨。卖方需支付入库费，买方则承担出库费。

（5）仓租费：交易所规定PVC的仓储费为1.0元／吨·天。

（6）增值税：商品期货进行实物交割卖方还需要缴纳增值税。PVC增值税＝（交割价格－购入PVC的含税价）×17％/（1＋17％）。

（7）资金利息：计算资金利息的关键在于资金量的确定。对于正向套利，除了购买现货的资金外，还需要储备保证金以缴纳交易保证金和应付期货头寸可能出现的亏损。故每吨的资金利息为：

资金利息＝［现货价格＋期货价格×（10％＋10％）］×存款年利率×持仓天数／365。其中，两个10％分别为保证金10％，备用资金10％。

（8）仓单升贴水：交易所还对不同的交割仓库、不同品质的PVC规定了详细的升贴水情况。就上海地区而言，交割仓库的升贴水为0。

综合上文的分析，可以得到正向套利的持有成本计算公式：

正向套利持有成本＝交易手续费＋交割手续费＋运输费＋入库费＋检验费＋仓单升贴水＋仓储费＋增值税＋资金占用费用

接下来投资者就要选择跟踪的合约，并画出跟踪曲线。这里选择了3个月后到期的PVC主力合约进行跟踪，每月15日后更换到下一个合约。3个月的正向套利持有成本约为350元，每天减少约2元。图5-7给出了PVC期货无套利区间跟踪曲线。只要期现价差超过了无套利区间的上边界，投资者便可以考虑进行期现套利了。

图5-7　大连交易所PVC无套利空间跟踪曲线

3．组织现货、注册仓单

1）卖方交割的流程

交割预报——货物入库（交割仓库验收）——交割仓库或指定质检机构检验——交割仓库开具《标准仓单注册申请表》——到交易所办理标准仓单注册——到交易所交仓单——参与交割，获得货款和开具增值税发票。

如在厂库标准仓单注册，则从上述流程中“交割仓库开具《标准仓单注册申请表》”开始交割流程。

需要注意的是：卖方必须在最后交割日闭市以前完成标准仓单注册，并将仓单交到交易所，否则即判定为违约。

在滚动交割时，卖方在交收日结算后拿到80％货款，余款在提交了增值税专用发票后结清。一次性交割时，卖方在最后交割日结算后拿到80％货款，余款在提交了增值税专用发票后结清。

2）货物入库常见问题

首先，客户应提前将客户名称、车船号、数量、到货时间告知仓库，以保证仓库及时组织入库，安排检验。如果客户没有提前告知仓库，仓库可能无法及时安排相应的装卸人手，会影响客户的入库速度。

其次，客户在入库后要进行检验、注册两个环节，才能进行交割，在正常情况下，PVC需10天左右。

3）PVC注册仓单的常见问题

首先，境内生产的PVC标准仓单的申请注册日期距离商品生产日期需小于120个自然日。境外生产的PVC标准仓单的申请注册日期距商品《进口货物报关单》进口日期（或者《进境货物备案清单》进境日期）需小于120个自然日。

其次，PVC交割品要求使用原生产厂家或者其认可的包装，包装袋上应标明商标、产品名称、产品标准号、净质量、生产厂名称及地址，并标识产品型号。

包装材料为内衬塑料薄膜袋的牛皮纸袋、聚丙烯编制袋或牛皮纸与聚丙烯编织物复合袋，应保证产品在正常贮运中包装不破损，产品不被污染，不泄漏。每袋净重25±0.2kg，每吨40袋，无溢短。

此外还需要注意的是：PVC的检验机构有两家：通标标准技术服务有限公司和中国检验认证集团检验有限公司。

5.2.3　增值税风险

对于进行正向套利的投资者，最后进行现货交割时，需要向买方提供增值税发票。因为商品的最终成交价格是按照最后一个月的结算价格计价，是套利方案开始时无法预估的，因此增值税是正向套利持有成本中唯一的一个变量。大多数商品的增值税率为15％～17％，如果套利期间商品价格大幅上涨，将大大提高商品的结算价，使得套利投资者需要支付更多的增值税额，造成利润缩水。

例如，某企业以17300元买进铝现货，17800元卖出下一月的铝期货，进行期现套利。扣掉注册、入库、利息、仓储等固定费用后，有近400元的利润。可是期间铝大幅上涨，最终期货以19200元结算价摘盘，结果增值税暴涨到276元，吃掉了大部分利润，后来只剩下一点利润。如果价格再涨1000元，这单贸易就要出现亏损了。

一般来说，当一年中销项税额大于进项税额，表示公司是赚钱的，所以很少有多余的进项税来弥补期货交割多缴纳的部分。因此投资者要对增值税风险进行适度的规避。

又如，铝的增值税率为17％，占全价约14.5％。投资者在锁定价格的时候只卖出总数量的85％，留下15％放在最后几天甚至最后交易日再卖出，这样就可以基本规避增值税风险了。具体过程如下：

（1）按照计划，100吨铝，假设17300元成本，17800元卖出，预计毛利（17800－17300）×100－（17800－17300）×100×14。其5％，约为42500元。

（2）假如在17800元卖出85吨，最后19200元卖出15吨，那么最后利润是（19200－17300）×15＋（17800－17300）×85－（19200－17300）×100×14.5％，大致也是42500元。

（3）假如价格最后下跌，15吨在16800元卖出，那么最后利润（16800－17300）×15＋（17800－17300）×85－（16800－17300）×100×14.5％，大致也是42500元。

不过这种操作在避开风险的同时，也拒绝了额外利润。因为当最终结算价格下跌，本来可以少缴很多税金，但是作为一个稳妥的交易者，绝对不要以投机的思路去操作。因为如果投资者期望最终价格下跌，100％一次锁定，就带有轻微的投机倾向了。

总而言之，期现套利非常适合稳健性的投资者，以极低的风险获取相对可观的收益。随着交易所交割仓库的增多及相应升贴水制度的完善，仓单注册、实物交割已经越来越容易。投资者应该充分利用这一稳健的投资策略，以获取额外的收益，为企业发展创造更好的途径。

5.3　跨期套利

跨期套利是通过观察期货各合约价差的波动，以赚取差价为目的，在同一期货品种的不同合约月份建立数量相等、方向相反的交易部位，并以对冲或交割方式结束交易的一种操作方式。正向市场时，价差为负，表现为远月升水；反向市场时，价差为正，表现为近月升水。一般来说，价差（绝对值）由持有成本（或持仓费）构成，指为拥有或保留某种仓单或头寸而支付的仓储费、保险费和利息等费用。即：

期货远月合约价格＝期货近月合约价格＋持仓费

其中，持仓费是仓储费用、商品过户费（上海期交所的工业品）、交易手续费、交割手续费、利息、增值税之和。

5.3.1　套利策略

跨期套利可以以对冲（对冲套利）和交割（实盘套利）两种方式平仓，不过，这两种操作方式成本各异，入场时机和操作思路也各不相同。但是，实盘套利是对冲套利的基础，对冲套利的实现正是通过大量实盘套利的操作而获得理想的平仓价位。下面以实盘为基础，重点介绍目前期货市场上应用最广泛的正向市场牛市套利策略。

1．牛市套利

1）正向市场中的牛市套利

（1）实盘套利。正向市场中实盘套利的机会仅出现在价差的绝对值大于持仓成本的情况下，此时，可以在近月合约做多，而在远月建立同等头寸的空头合约。近月接仓单，远月到期时以仓单交割来平仓，即可获得无风险收益。

（2）对冲套利。正向市场中如果供给不足，需求相对旺盛，则会导致近期月份合约价格的上升幅度大于远期月份合约，或者近期月份合约价格的下降幅度小于远期月份合约，这样就可进行在近月合约上做多，而在远月建立同等头寸的空头合约的套利操作。

套利收益＝仓位×［（远期月份卖出价－近期月份买进价）－（远期月份买进价－近期月份卖出价）］＝仓位×（B1－B2）

当B1－B2＞0时，价差＜0，如果价差绝对值缩小，则套利交易获利。此时，反映近期合约对远期合约升水，其升水额取决于近期市场对商品的需求程度及供给的短缺程度，不受其他限制，所以获利潜力巨大。

当B1－B2＜0时，价差＜0，如果价差绝对值扩大时，套利交易亏损。此时，反映远期合约对近期合约升水，投资者要么及时止损，要么在坚持价差判断的情况下迁仓。

2）反向市场中的牛市套利

反向市场情况下的牛市套利现在在实际中也有操作，但这种操作方式应视为投机而非套利，在此不再赘述。

2．熊市套利

与牛市套利不同，熊市套利只能以对冲的形式平仓，在此同样从正向市场和反向市场两方面加以分析。

1）正向市场下的熊市套利

如果市场中供给过剩，需求相对不足，则会导致近期月份合约价格的上升幅度小于远期月份合约，或者近期月份合约价格的下降幅度大于远期月份合约，此时可进行在近月合约做空，而在远月上建立同等头寸的多头合约的套利操作。

套利收益－仓位×｛（远期月份买进价－近期月份卖出价）－（远期月份卖出价－近期月份买进价）｝＝－仓位×（B2－B1）

当B2－B1＜0时，价差＜0，如果价差绝对值扩大，则套利交易获利。此时，反映近期合约对远期合约贴水。

当B2－B1＞0时，价差＜0，如果价差绝对值缩小时，套利交易亏损。此时，反映远期合约对近期合约贴水，投资者或者及时止损，或者在坚持价格走势判断的情况下迁仓。

2）反向市场下的熊市套利

在出现反向市场时，现货、库存供应紧张，此时，做熊市套利往往是基于对反向市场向正向市场转换的判断，风险大，也与反向市场的假设不符。

3．蝶式套利

蝶式套利是跨期套利另一常用的形式，它也是利用不同交割月份的价差进行套期获利，由两个方向相反、共享居中交割月份合约的跨期套利组成。蝶式跨期套利的原理是套利者比较3个相邻的期货合约价格时，认为中间交割月份的期货合约价格与两边交割月份合约价格之间的相关关系出现了差异。

我们下面以正向市场的牛市套利为例，具体阐述跨期套利的过程。

5.3.2　实证案例：PVC跨期套利策略

我们还是以大连交易所的PVC合约为例，说明在正向市场中牛市套利的方法。

1．跨期套利成本计算

套利成本＝仓储费＋资金成本＋交易／交割费用＋增值税

（1）仓储费：1.0元／吨·天。

两个月为1.0×60＝60（元／吨）

三个月为1.0×90＝90（元／吨）

四个月为1.0×120＝120（元／吨）

（2）交易手续费：12元／手，每手5吨，折算为2.4元／吨，交易两次。

（3）交割手续费：2元／吨，交割两次。

（4）入库取样及检验费：按3000元／批，每批300吨，折算为10元／吨，一次入库。

（5）卖方增值税：国家税法规定企业增值税率为17％。由于交易所开票价为合约最后交易日结算价，因此增值税即为两次交割时远近合约最后交易日结算价的税额差。在此以500元差价计算，500×17％＝85（元／吨）。

（6）资金成本：按7000元／吨计算，年贷款利率5.31％。

利息支出：两个月7000×5.31％×2/12＝61.95（元／吨）

三个月为7000×5.31％×3/12＝92.925（元／吨）

四个月为7000×5.31％×4/12＝123.9（元／吨）

两个月之间的套利：套利成本＝60＋（2.4＋2）×2＋10＋85＋61.95＝225.75（元／吨）

三个月之间的套利：套利成本＝90＋（2.4＋2）×2＋10＋85＋92.925＝286.725（元／吨）

四个月之间的套利：套利成本＝120＋（2.4＋2）×2＋10＋85＋123.9＝347.4（元／吨）

2．操作过程

（1）在期货市场同时买进或卖出100手PVC 0909合约，以及卖出或买进100手PVC 0911合约。

（2）可能会出现两种操作情况：

①期现差价按预期缩小，则按跨期套利的方法直接在期货市场中平仓了结，实现目标利润。

②通过两次实物交割完成交易，实现套利利润。

5.4　跨市场套利

5.4.1　套利策略

跨市场套利是在不同市场之间进行的套利交易行为。当同一期货商品合约在两个或者更多市场进行交易时，由于区域间的地理差别等因素，各商品合约间存在一定的固有价差关系。但是，由于两个市场的供求影响因素、市场环境及交易规则等方面不完全一致，价格的传导存在滞后甚至失真的情况，因此固有价差水平会出现偏离。跨市场套利正是利用市场失衡时机，在某个市场买入（或卖出）某一交割月份某种商品合约的同时，在另一个市场卖出（或买入）同一交割月份的同种商品合约，以对冲或交割方式结束交易的一种操作方式。这种套利可以在现货市场与期货市场上进行，也可以在异地交易所之间进行，其中也包括国内交易所与国外交易所之间。

目前国内比较盛行的跨市套利主要有：LME金属（铜、铝、锌）期货与上期所金属期货跨市场套利、上海黄金交易所黄金（T＋D）与上期所黄金期货跨市场套利、CBOT大豆期货与大商所大豆期货跨市场套利等。

由于涉及两个或多个市场，跨市场套利一般对于资金的要求比较高。市场上从事跨市场套利的交易方主要为生产商、消费商、贸易商及一些实力雄厚的民间大资金。在价差合适的时候，这些企业或机构可以利用自身在采购分销渠道及资金上的优势，通过跨市场套利来降低生产成本或获取价差变动收益。值得注意的是，随着市场深度和广度的增加，大量跨市场套利资金的活跃对国内外商品价格的影响力也在增强。

5.4.2　实证案例：伦铜—沪铜跨市场套利

我们以某公司为例进行伦铜和沪铜之间的跨市套利案例进行分析：A公司是一家主要从事有色金属和矿产品进出口及加工的企业，经过多年的发展，公司与国内外众多金属行业的工厂、矿山等建立了良好的业务关系，在进出口流程方面更是驾轻就熟。鉴于金属跨市场套利机会每年都会出现，在日常经营中，该企业充分利用自身在信息及贸易渠道上的优势，在国内外金属价差合适时，通过跨市场套利来获取低风险稳定收益。

2009年2月中旬，受国储收储及国家即将出台有色金属产业振兴规划等好消息的影响，沪铜走势明显强于伦铜，由此导致两市比价持续走高，如图5-8所示。

图5-8　伦铜—沪铜比价

到了2月23日，两市3月合约比价升至8.73，现货进口盈利1700元／吨，均处于近阶段的相对高位。基于以下原因，该公司决定进行跨市场套利操作：

（1）目前，剔除汇率因素影响后的两市3月比值为8.33/6.867＝1.21，处于统计意义上的小概率区间。

（2）目前，原料进口紧张，国内产量受到影响，但预计后期随着进口精铜逐渐集中到货，国内供应紧张的格局有望缓解。

（3）近期LME库存基本不再增加，LME注销仓单量逐渐放大，一定程度上验证了市场上关于国储在海外采购的传言。如果LME注销仓单进一步增加，这种传言的可靠性将会进一步加强，进而对LME铜价形成有力的支撑。

（4）预期国内市场将逐渐转为正向结构，对正向套利可能发生的移仓较为有利。

（5）人民币远期汇率相对稳定，无须对冲外汇风险。

那么该公司则进行如下的跨市套利操作：

该贸易公司用于正向套利的资金共计1000万元，于2月24日分批建仓。从流动性及升贴水角度综合衡量，沪铜方面选择905主力合约进行建仓，伦铜方面选择电子盘合约进行建仓，按1∶1的比例建仓1000吨，即卖出沪铜200手，买入伦铜40手。沪铜平均建仓价为26520元／吨，伦铜平均建仓价为3190美元／吨。按建仓时的汇率折算，总计需保证金约6411500元（SHFE保证金按10％计算，LME保证金按13750美元／手计算）。

企业预计未来一段时间价格振荡上行的可能性更大一点，故国内备用金放置200万元，国外备用金放置20万美元。建仓时期货比价为8.70，如果比价按预期方向运行，则当两市期货比值下降至8.0附近时止盈双边平仓；如果比值较长时间不回归，则考虑向后移仓的同时准备实物资源进口。总体而言，该公司此笔套利实现盈利是可以得到保障的。

此次跨市场正套最终的结果是，3月11日比值达到预期目标，该公司选择双向平仓，沪铜平仓均价为29120元／吨，伦铜平仓均价为3660美元／吨。半个月客户收益（扣除手续费后）约为600元／吨×1000吨＝600000元，整体收益率约6.00％。相对于资金量而言，这个收益已相当可观。

通过上述案例可以看出，对于资金雄厚的投资者或具有现货背景的企业客户而言，国内外期货市场间低风险甚至无风险的跨市场套利无疑为其资金运营或成本控制提供了很好的渠道。

5.5　跨品种套利

跨品种套利是指利用两种不同的，但相互关联的商品之间的合约价格差异进行套利交易，即买入某一交割月份的某种商品合约，同时卖出另一相同交割月份、相互关联的商品合约，以期在有利时机同时将这两个合约对冲平仓获利。

跨品种套利的主导思想是寻找两种或多种不同，但具有一定相关性的商品间的相对稳定关系（差值、比值或其他），在其脱离正常轨道时采取相关反向操作以获取利润。根据套利商品之间的关系，跨品种套利可分为相关商品套利和产业链跨品种套利两种类型。

前者主要是利用具有较高相关性的商品之间走势强弱对比关系差异所进行的套利活动，如螺纹钢和线材套利、豆油和棕榈油套利及小麦和玉米套利等；产业链跨品种套利则是因为处于同一产业链上各品种的价格因受成本和利润约束也具有一定程度的相关性，与替代性跨品种套利相比，这一形式更加稳定，LLDPE和PVC期货间套利就属于此类。

与其他3种套利模式相比，跨品种套利具有3个特点：第一，套利组合中资产品质不同，不能以实物交割的方式平仓；第二，资产间的相关性对套利策略的成功与否更为重要；第三，不存在无风险套利的可能，套利的收益率也无法在策略制定时确定。

一般情况下，投资者需要对两种商品的基本面进行综合分析后才能确定是否具有套利机会，故跨品种套利对投资者个人的素质提出了更高的要求。下面以棕榈油和豆油为例，说明跨品种套利的分析与交易过程。

5.5.1　套利策略

棕榈油与豆油在消费领域具有很强的替代性，两者的价格走势具有很强的关联性，当两者之间相对价格（价格之差或价格之比）发生偏差时将出现跨品种套利机会。

对于豆油与棕榈油来说，豆油的供给主要受南美、美国和国内的影响较大，而棕榈油供给主要受东南亚主产国的影响较大。2009年以来，宏观经济复苏与通货膨胀预期引发了大宗商品市场的大幅反弹，但油脂市场供需基本面供过于求的格局遏制了油脂类期货反弹的幅度。在豆油与棕榈油供需基本面不发生较大变化的情况下，两者的价差在短期内应该保持一致。

由于单张合约连续存续的时间较短，这里选取豆油指数和棕榈油指数作为此次跨品种套利研究对象，其成交量一直保持活跃，时间段选取2009年3月19日到2010年1月26日。价差关系如图5-9所示。

图5-9　棕榈油和豆油价差关系

数据来源：［张昊星　2010］

5.5.2　实证案例

利用协整检验，可以得到价差分布序列Spread，此序列表明了棕榈油合约和豆油合约之间的差距水平，所以利用对价差的分析来构建跨期套利的交易策略。有关协整检验方法，在第6章统计套利中有详细阐述，这里不多做介绍。为了便于序列数据集中化，根据价差序列均值mean的结果将Spread中心化，即令MSspread＝Spread－mean，价差中心化时间序列如图5-10所示。

图5-10　棕榈油—豆油价差中心化时间序列

数据来源：［张昊星　2010］

跨期套利中价差分析最重要的是分析套利出现的时机。首先要确定套利区间，将这样的区间分为3类：

第一类是无套利区间，在该区间内视为不存在套利机会，无须构建套利组合。

第二类是套利区间，在该区间内，投资者应积极行动建立套利组合。

由统计检验的结果显示，价差序列是一个白噪声序列，那么最大受益的交易边界是±0.75σ，σ表示组合收益序列的标准差。那么交易边界可设为±0.75σ。

当MSspread＜-3/4×σ时，在买入1张豆油合约的同时卖出1张棕榈油合约。

当MSspread＞＋3/4×σ时，在卖出1张豆油合约的同时买入1张棕榈油合约。

第三类为止损区间，当建立头寸后，如果MSspread没有如期回归至标准差区间，为此需要设定平仓上下限，一旦价差达到该区间，则应立即对冲套利组合出局。这里取±2σ作为止损区间的上下止损界。即当价差触发±2σ以外的区域时，多头头寸或空头头寸立即平仓止损。该策略是基于止损的交易策略，为了避免过大的波动风险。

需要指出的是，止损边界或交易边界设置得严格或宽松对套利交易的成功率起到至关重要的作用。依照此分析，绘制出跨品质套利时机图，如图5-11所示。

图5-11　棕榈油—豆油跨品种套利交易时机

数据来源：［张昊星　2010］

5.6　非常状态处理

需要说明的是，套利仍是一种投机行为，只要套头没有全部对冲，就存在风险，这就对套头的正确处理提出了较高的要求。

对于套利投机也要像单向投机那样用变化的、动态的眼光去对待，而千万不可用静态的、固定的及僵化的眼光去对待，否则，即便是风险较小的套利也会以损失较大而告终。

为了及时发现风险，并消除风险，务必注意下列问题：

（1）必须对套利头寸实行动态跟踪。有些投资者一旦建仓之后，多数不大注意头寸的盈亏变化，而只是一味地等待盈利时机到来，这是不可取的。对套利头寸，实行动态跟踪，就是要检查套利头寸建立后，市场走势是否按照有利于套利操作而波动，以便及早发现苗头，减少损失。

（2）必须有止损的概念。套利与单向投机一样也会出现万一的情况，一旦超出了一定范围，就应及时检讨套利时机是否成熟，套利操作是否合理，并及时纠正，而不是想当然地等待价差朝好的方向波动。由于多数投资者认为套利风险较小，套利所用资金往往要比单向投机的建仓资金大得多。就这一点来说，其风险不一定比单向投机小，如果在套利不利的情况下不能及时纠正，极有可能造成重大亏损，所以套利同样需要设置止损盘。

（3）要遵循套利原则但不能拘泥于套利原则。套利一般要遵从数量对应、方向相反、同进同退等原则，但在实际操作中也要灵活应用，不可一成不变。比如：套利过程中，一旦出现亏损有扩大的趋势，这时可以将数量对应更改为数量不对应，即适当减少不利的那一部分头寸，以加大有利头寸的权重（即某一方的套头要多于另一方的套头），从而减少亏损，实现盈利。

再如，套利过程中如果有非常明确的波动方向，并且也已认识这种方向，那么就要用延时方式建仓。即先顺着这个方向建立其中一个套头，另一个套头则不必马上建立，而是延后一定的时间建立，以便取得较大的入市价差。这相当于在建仓期间就先胜一筹。同样地，在出现盈利的时候，要首先对冲于势不利的那一边套头，后对冲于势有利的那一边套头，以扩大利润。当然，这要建立在可操控范围内，这就是延时建仓和延时对冲的妙用，有时真正利润的产生，往往取决于延时操作的时机把握。

（4）善于将套利转化为单向投机。按照价格波动性，当价格超买到一定程度时，市场的力量将会改变这种状态，同样，当市场超卖到一定程度时，市场的力量也会改变这种状态，这就向套利者提出了一个课题：及时把握转市的时机，正确对冲一边套头，使套利转为单向投机，有可能取得高于正常套利的单向投机多倍的利润。例如，2003年4月天胶市场出现极度超买时，对06/07合约的买／卖套利，采取对冲06合约的多头头寸，变为07合约空头单向投机，结果07合约连连暴跌5000余点，使入市资金的回报高达700％。这便是套利向单向投机转化的成功的范例。

第6章　统计套利

◆摘要◆

统计套利定义为一种基于模型的投资过程，在不依赖于经济含义的情况下，运用数量手段构建资产组合，根据证券价格与数量模型所预测的理论价值进行对比，构建证券投资组合的多头和空头，从而对市场风险进行规避，获取一个稳定的Alpha。

有别于无风险套利，统计套利是利用证券价格的历史统计规律进行套利的，是一种风险套利，其风险在于这种历史统计规律在未来一段时间内是否继续存在。

统计套利的主要思路是先找出相关性最好的若干对投资品种（股票或者期货等），再找出每一对投资品种的长期均衡关系（协整关系），当某一对品种的价差（协整方程的残差）偏离到一定程度时开始建仓——买进被相对低估的品种、卖空被相对高估的品种，等到价差回归均衡时获利了结即可。

统计套利的主要内容包括股票配对交易、股指对冲、融券对冲和外汇对冲交易。

股票配对交易在方法上可以分为两类，一类是利用股票的收益率序列建模，目标是在组合的β值等于零的前提下实现Alpha收益，称为β中性策略；另一类是利用股票的价格序列的协整关系建模，称为协整策略。

股指对冲交易是指利用不同的国家、地区、行业的指数相关性，同时买入、卖出一对指数期货的交易方式。在经济全球化时代，国家、地区、行业经济的联系越来越紧密，而代表这些国家、地区、行业的公司之间的关联程度也越来越大，这就使得系统性的风险会造成一荣俱荣，一损俱损的局面。因此进行指数间的对冲交易是一种低风险、高收益的投资方式。

融券对冲就是利用融券进行做空交易的同时，买入现货做多，从而规避系统性风险的一种交易方式，主要包括股票—融券对冲、可转债—融券对冲、股指期货—融券对冲和封闭式投资组合—融券对冲这几种方式。

外汇对冲是指在外汇市场上，同时做多做空两个货币对的交易方式，由于主要经济体时间的经济关联性很强，使得一些货币之间出现同涨同跌现象，给对冲交易提供了可能。其主要包括利差套利和货币对冲两种。

6.1　基本概念

6.1.1　统计套利定义

1．统计套利的含义

Morgan Stanley将统计套利定义为一种基于模型的投资过程，在不依赖于经济含义的情况下，运用数量手段构建资产组合，根据证券价格与数量模型所预测的理论价值进行对比，构建证券投资组合的多头和空头，从而对市场风险进行规避，获取一个稳定的Alpha。

统计套利是指利用证券价格的历史统计规律进行套利，是一种风险套利，其风险在于这种历史统计规律在未来一段时间内是否继续存在。例如，是与股指期货有关的期现套利和跨期套利，由于期货的价格在到期时必须收敛于现货价格，价差必然归零，期现套利可看做是无风险套利。尽管不同月份的期货合约价格也存在着均衡关系，但是它们的价格在近月合约到期时并不一定收敛，因此，跨期套利实际上是一种风险套利或者统计套利。

S. Hogan, R. Jarrow和M. Warachka等（2004）对统计套利进行了精确的数学定义，他们强调统计套利是具有零初始成本、自融资的交易策略。用V（t）表示在t时刻的累计收益，以无风险利率折现的现值为v（t），v（t）应满足如下条件：

（1）V（0）＝0，表示初始成本为零。

（2）
组合收益均值的极限值大于零。

（3）
组合亏损的概率收敛于零。

（4）若
则
表示在有限的时间内，如果损失的概率为正，那么收益的方差相对于时间收敛于零。

2．统计套利的方法

统计套利的主要思路是先找出相关性最好的若干对股票，再找出每一对股票的长期均衡关系（协整关系），当某一对股票的价差（协整方程的残差）偏离到一定程度时开始建仓：买进被相对低估的股票，卖空被相对高估的股票，等到价差回归均衡时获利了结即可。

当残差序列是平稳的，并且服从正态分布时，统计套利就会变得很容易——投资者只需在价差出现在分布的尾部时建仓，在价差出现在零附近时平仓即可。事实上，残差序列往往不是服从正态分布的，因此可以采用混合正态分布或直接用非参数的方法来拟合其收益率的分布。当然，残差中可能还存在自相关性或异方差性，这就需要考虑用ARMA模型或ARCH模型来刻画这些特性。另外，还可以采用Kalman滤波来排除噪声干扰，并利用最新的信息来估计残差的可预测部分，当实际残差与预测值发生较大偏离时入场套利。

此外，主成分法也可以应用于统计套利，其原理是先找出一些股票的共同驱动因素——主成分，然后根据主成分的系数向量构建主成分组合（类似于市场基准），并将每一只股票的收益率表示为这些主成分组合的线性函数，当残差出现一定的偏离时，做空该成分股并做多主成分组合（或相反），以实现在β中性的前提下获取一定的Alpha收益。

6.1.2　配对交易

配对交易（Pairs Trading）的理念最早来源于20世纪20年代华尔街传奇交易员Jesse Livermore的姐妹股票对交易策略。他首先在同一行业内选取业务相似、股价具备一定均衡关系的上市公司股票，然后做空近期的相对强势股，同时做多相对弱势股，等两者股价又恢复均衡时，平掉所有仓位了结交易。该策略与传统股票交易最大的不同之处在于，它的投资标的是两只股票的价差，是一种相对价值而非绝对价值。同时又由于它在股票多头和空头方同时建仓，对冲掉了绝大部分市场风险，因而它又是一种市场中性策略，策略收益和大盘走势的相关性很低。

1985年，Morgan Stanley公司成立了一支由Dr. Tartaglia领导的量化团队，专门开展配对交易的研究，并于1987年投入实战，当年实现盈利5000万美元。不过该策略在之后两年连续亏损，研究团队被迫解散，小组成员散落到各家对冲基金，策略的思想也随之广为市场知晓。经过多年学术机构的研究和市场机构的实战，配对交易的理论框架和配套交易系统日臻完善。

1．实例演示

配对交易的第一步是要选取适合配对的两只股票，以北京银行和华夏银行两家银行业上市公司为例，根据公司公布的2011年年报，北京银行总股本为62.3亿股，华夏银行总股本为68.5亿股。两家公司2011年全年的股价走势如图6-1所示，蓝色线代表华夏银行，红色线代表北京银行。

图6-1　北京银行、华夏银行股价走势比较（2011.01.01—2011.12.31）

资料来源：［金志宏　2012］

可以看到两家公司的股价走势基本保持一致，相对强弱指数围绕着均值上下波动。如果我们把两只银行股股价做一定的数学处理，单独放大来看（如图6-2所示），两者价差围绕均值上下波动的趋势更加明显。造成这种现象的原因主要是两家公司的主营业务相近，受到的宏观、行业影响因素相似，虽然市场消息面和大宗交易的冲击可能造成股价短期的偏离，但在公司基本面无显著变化的情况下，股价的偏离不会太大，待前期的冲击效应逐渐被市场消化，两者的价差有回归均衡状态的趋势。

图6-2　北京银行、华夏银行股价比（2011.01.01—2011.12.31）

资料来源：［金志宏　2012］

利用两只股票的价比向均值回归的特性，可以设计如下交易策略：2011年6月1日，两者价比达到0.85，说明近期华夏银行走势明显强于北京银行，价差向上回归均值的可能性较大，因此可以在这个时点融券卖出100万元华夏银行，同时买入85万元北京银行（做多和做空的资金比例通过回归分析计算得到）。等到6月10日，价差回到均值0.9附近，同时平掉持有的两只股票的仓位，交易的收益为：

类似地，7月27日，两者价比为0.95，有向下回归均值的趋势，投资者可以买入100万元华夏银行，同时融券卖出95万元北京银行，待8月4日价比回到均值附近，同时平掉两只股票仓位，交易的收益为：

由上面的例子可知，配对交易的收益与建仓时价差偏离均值的幅度有关，偏离的幅度越大，价差回归均值后配对交易的收益也就越高，在上面的例子中设定的建仓阈值为0.05。需要注意的是，建仓阈值设置得越高，建仓机会也就越少。另外，配对交易的收益还与价差回归均值所需的时间有关，上例中的两次交易获取的相对收益相同，时间上也只有10个自然日。

2．A股市场的运用

配对交易的特性之一是它的市场中性（和大盘走势的相关度较低），在整个市场无明显趋势性机会时，可以通过配对交易避免股市系统风险的影响，获取Alpha绝对收益。配对交易需要股票市场做空机制的支持，目前国内大型券商都在积极开展融资融券业务。截至2011年6月3日，沪深两市融资余额达到259.04亿元，日均融资买入额为8.59亿元；融券余额1.61亿元，日均融券卖出额为0.64亿元。市场交易仍以融资买入为主，融券业务受到券商持券品种与数量的限制，量相对较小。配对交易策略当前只适合一些小资金操作，不过随着参与者的增多及后续转融通业务的启动，市场容量将会逐步扩大。

基金公司、保险等机构投资者目前尚未批准参与融资融券业务，但是可以利用配对交易的原理，将手头持有的股票和市场上适合与之配对的股票进行阶段性替换，以实现组合收益的加强，该方法尤其适合指数加强型产品。

6.2　配对交易策略

6.2.1　协整策略

统计套利在方法上可以分为两类，一类是利用股票的收益率序列建模，目标是在组合的β值等于零的前提下实现Alpha收益，称为β中性策略；另一类是利用股票的价格序列的协整关系建模，称为协整策略。

前者是基于日收益率对均衡关系的偏离，后者是基于累计收益率对均衡关系的偏离。基于日收益率建模的β中性策略是一种超短线策略，只要日偏离在短期内不修复，策略就会失效。并且，如果日偏离是缓慢修复的，这种策略很难搜索到合适的平仓时机。实证分析也表明，β中性策略经常会发出错误的交易信号。而协整策略直接利用了原始变量——股价进行建模，当累计收益率偏离到一定程度时建仓，在偏离修复到一定程度或反向时平仓。

1．协整策略的前提

根据CAPM模型，同一市场中的任何一只股票都与市场基准指数存在一定的相关性，那么任意两只股票之间也将存在着一定的相关性。在众多的股票组合中，有些股票的相关性一般，或者是短期的，而有些股票的相关性较强。如果两只（或多只股票的股价存在长期稳定的线性关系，则认为它们之间存在协整关系。当股价在短期内偏离这个均衡关系时，则存在校正机制使得偏离回归到合理范围。两只股票股价的协整关系可以表示为：

Pa，t
＝α＋βPb，t
＋εt

其中，εt
是平稳的。股价存在协整关系的内在原因是这些股票可能属于同一行业，股价受相同的因素驱动。由于噪音交易，会使它们的股票在短期内偏离这个均衡关系，但是在中长期内股价回到均衡关系的概率较大，除非某只股票发生重组等重大事项，股价面临重估。

两只股票的股价存在协整关系一般需要两个条件：一是它们的历史股价序列都是一阶单整向量，即股价序列是非平稳的（有明显趋势），但一阶差分后的序列（即收益率）是平稳的；二是这两个序列的某种线性组合是平稳的，即以两个序列构建的线性方程的残差是平稳的。也就是说，在建立线性关系之前，需要对这两个序列进行协整检验。

沪深300指数是一个重要的指数，300只股票的相对关系有44850对。对这4万多对都进行协整检验显然是相当烦琐的，也没有必要。一种最简单可行的方法是计算任意两只股票的相关系数，找出相关系数较高的股票组合。

这里采用的样本期为2011年1月1日至2011年12月30日。在样本期内，剔除了长期停牌的股票之后，挑选相关系数最高的股票，其相关系数均在0.85以上。表6-1给出了这些组合的相关系数及各股票的行业属性。可以看出，这些相关性较好的个股绝大多数属于同一行业。

表6-1　2011年沪深300股票同一行业走势高度相关的组合（部分） 

数据来源：［邱小平　2010］

2．残差的性质

首先，需要检验残差的平稳性，因为只有残差通过了平稳性检验，股价之间才会有协整关系。如表6-2所示对上述50对股价线性方程的残差检验的结果表明，绝大多数方程的残差都是平稳的，股价的协整关系成立。

表6-2　残差的平稳性、自相关等检验

注： 
中括号内的数值为检验的P值

数据来源：［邱小平　2010］

对残差进行自相关、异方差检验的结果表明，所有残差序列都存在自相关性和异方差性。这意味着针对残差，可能需要采用ARMA或ARCH模型进行滤波。正态性检验的结果表明，50个残差序列中有21个序列不能通过正态性检验。这意味着常用的正态分布假定可能存在问题，需要考虑非参数的方法来捕捉交易信号。下面通过一个案例来讨论协整策略的配对交易策略。

3．样本内配对交易

案例　基于协整策略的配对交易

针对残差的异动，可以设计如下的交易策略。

（1）将残差划分为可预测的部分和不可预测的部分：

通常情况下，假定残差的可预测部分（
）为0，这样就只利用残差的分布特征进行交易。当然，投资者如果采用ARMA模型等来预测残差，就需要利用残差中不可预测的部分（spreadt
）的特征制定交易策略。

（2）当不可预测的残差（以下简称“残差偏离”）达到一定程度时，入场套利。具体来说，当spreadt
＞δ1
σt
时，表明股票A相对高估，股票B相对低估，投资者应当卖空股票A，买入β倍的股票B；反之亦然。

（3）当残差偏离回归正常或反向（spreadt
＞δ2
σt
）时，平仓获利了结。若残差偏离继续扩大，当spreadt
＞δ3
σt
时，投资者应止损出局。

值得一提的是，由于这里讨论的是配对交易，当股价偏离原有的均衡关系时，并不一定会回归，投资者在进行统计套利时务必设置止损点。因为影响股价的因素众多，股价可能会由于市场热点轮换、投资者预期、重组等因素长期偏离原有的均衡关系，而非暂时的偏离。

一般来说，δ1
越大，潜在的套利空间就越大，但套利的次数会减少；反之，δ1
越小，潜在的套利空间也越小，但套利的次数会增加。平仓阈值δ2
的设置也一样。总之，对于不同的建仓阈值δ1
、平仓阈值δ2
，套利空间和套利次数是成反比的，因此，必然存在最优的阈值（或阈值区间）使得套利收益达到最大。

先从最简单的假定开始做配对交易，第一个模型，假定εt＝～iidN（0，σ）（独立且服从同一正态分布）。在配对交易时，投资者可根据历史经验或自身的风险偏好，以标准正态分布某一分位数乘以标准差作为建仓点或平仓点。例如，某投资者比较保守，希望在偏差比较大的时候建仓，就可以标准化正态分布95％的分位数1.645作为阈值进行建仓，这样在95％的概率下可以保证组合在下一交易日不亏损。

如表6-3所示为采用上述50对股票在不同的阈值下建仓、平仓所能获得的平均收益（套利成本为每次0.5％，不考虑融券费用）。可以看出，当δ1
在1.1～1.3之间（对应标准正态分布86％～90％的分位数）、δ2
在-1～-0.7（对应标准正态分布16％～24％的分位数）之间时，套利收益达到最大，半年收益可以达到52％～55％。值得一提的是，止损阈值δ3
的设置在样本内统计套利策略的检验中并不重要，因为我们所选的每一对股票的相关系数在样本内都是最高的，一般不会触发止损条款。

表6-3　在不同的阈值下建仓、平仓所能获得的平均收益 

数据来源：［邱小平　2010］

第二个模型，假定残差满足均值回复过程：

其中，m为残差的均值，dW（t）为标准的维纳过程，残差的均值和标准差可用下面的一阶滞后模型的回归系数来估计：

当残差ε3
偏离均值m较大时，即εt
－m＞δ1
σeq
时，入场套利；当εt
－m＞δ2
σeq时，平仓。实证的结果表明，最优阈值δ1
在1～1.2之间、δ2
在-1～-0.6之间，套利收益达到最大，半年收益可以达到53％～57％。

第三、四个模型分别是AR（1）模型和GARCH（1，1）模型。不过，实证分析的结果表明，以这两种模型进行统计套利所获取的收益一般。

除了上述模型之外，还在估计残差时分为有常数项和无常数项两种情形进行实证分析，分析的结果如表6-4所示。可以看出，假定无常数项时，套利收益明显降低。这表明估计残差时，常数项不能忽略。也就是说，针对每一对股票，做多和做空的市值并不相等，组合并非完全市场中性。

表6-4　采用不同的模型在样本内获取的收益率及最优阈值 

数据来源：［邱小平　2010］

从表6-4中可以看出，在样本期内，均值回复模型（模型Ⅱ）表现最好，其次是模型Ⅰ和模型Ⅲ，表现最差的是模型Ⅳ，可能的原因是GARCH模型对残差方差的反应过于灵敏，不宜捕捉到较佳的投资机会或平仓机会。另外，从最优阈值来看，建仓的最优阈值一般在1～1.3之间，平仓的最优阈值一般在-1～-0.7之间。

4．样本外配对交易

在上文的实证分析中，上述统计套利模型在样本内都能获取较高的收益，尤其是前3个模型，可在一年内获取40％～50％的收益。不过，我们更加关注这些模型在样本外是否能继续获取稳定的收益。接下来讨论用3种移动时间窗口的方法来检验这些模型的外推效果。

第一种外推方法是建立协整方程的时间窗口不变，残差偏离的标准差σt
在外推时也保持不变，但是残差是以最新的价格信息按照原有的协整方差估算出来的。显然，这种方法假定股价之间的协整关系在样本内外始终维持不变。如果协整参数在样本外发生变化，或协整关系不存在，则以这种方法套利会面临较大的风险。

第二种外推方法是外推时时间窗口的长度不变，每天平移一次，协整方程、残差偏离及其标准差都是根据最新的时间窗口中的数据估算出来的。这种方法可捕捉协整参数随时间推移产生的细微变化，刻画股价之间最新的协整关系。

第三种外推方法是外推时时间窗口的长度不断增加，以保证协整参数、残差偏离及其标准差的连续性。如果协整关系在样本外发生较大变化，这种方法估算的协整参数等可能会比较滞后，因为所采用的时间窗口包含了许多过于陈旧的样本。

按照上述3种方法，采用模型Ⅰ～Ⅲ在不同阈值下获取的最高收益和平均收益如表6-5所示。可以看出，与样本内相比，样本外的收益大幅下降；有常数项的模型仍然明显好于无常数项的模型，表明协整方程中的常数项不能忽略。

表6-5　采用不同的模型、不同的外推方法在样本外获取的收益率（％） 

注：表中数据为在不同阈值下的最高收益，中括号内的数据为平均收益，下同

数据来源：［邱小平　2010］

3个模型中，模型Ⅰ～Ⅲ所取得的投资收益有逐渐递减的趋势。3种外推方法中，第二种外推方法明显较好。最佳的样本外模型是以第二种方法外推的模型Ⅰ，该模型在半年内可取得的最大收益为9.95％，平均收益为7.31％。从各个模型的阈值来看，建仓的最优阈值δ1
一般在1～1.4之间，平仓的最优阈值δ2
一般在-1～-0.7之间，止损的最优阈值δ3
一般在2～3之间。

至于模型Ⅳ，由于其在样本内表现较差，且该模型的计算量较大，没有估算其在各个阈值下所能获取的投资收益。在前3个模型的最优阈值区间中，随机抽取了一些阈值应用于模型Ⅳ，结果表明取得收益较低。因此，在使用协整方法进行统计套利时，针对其残差应当慎用GARCH模型。

6.2.2　主成分策略

1．主成分套利策略简介

主成分套利的主要思想是，从成分股股价的历史信息中提取主成分，以捕捉所有成分股的主要趋势，当某一成分股和主要趋势产生较大偏离时，入场套利。Marco Avellaneda & Jeong-Hyun Lee（2008）利用了成分股的收益率来提取主成分，并以此构建主成分组合来替代市场基准，再将单只成分股的收益率表达为主成分组合的线性方程，再根据此方程残差的偏离进行统计套利。

正如前文所述，基于日收益率建模所进行的统计套利是一种超短线投资行为，这种套利模式可能会经常发出错误的建仓、平仓信号。而基于股价进行建模可以把握累计收益率的偏离，更加符合投资者的主观感受。因此采用主成分套利时，也采用了成分股的股价这一原始信息。

具体来说，先将成分股的股价矩阵PT×n
进行标准化处理，标准化后的矩阵记为PT×n
，再求出股价的相关系数矩阵Pn×n
，并计算出Rn×n
的特征根（λ1
，λ1
，…，λn
）和特征向量（V1
，V1
，…，Vn
），则根据主成分分析的原理，第i个主成分可表示为：

fi
＝PT×n
Vi

由于特征向量矩阵是正交的，标准化的股价矩阵也可以用主成分来表示。第j只股票标准化后的股价序列可表示为：

其中，Vij
是Vi
的第j个元素。如果采用原始股价信息（非标准化后的），则可进一步表示为：

一般情况下，只需要前k个主成分就可以代表市场的整体波动。这样，上式可以表示为：

其中，
为主成分组合的权重向量，Vij
则表示第j只成分股在第i个主成分上的载荷。

2．主成分配对交易

案例　主成分配对交易策略

从6.2.1节的分析中可以得知，模型Ⅰ、Ⅱ的表现相对较好。在主成分套利策略中，针对残差也采用模型Ⅰ、Ⅱ。为了增加两种策略的可比性，选择上述50对股票中的股票作为样本，这些股票的相关性较强，可以用来提取主成分。

表6-6展示了在不同情形下，以主成分套利策略所能获取的收益和最优阈值。可以看出，主成分套利策略的样本内收益远高于协整策略。当采用两个主成分时（累计贡献率≥90％），套利收益明显高于仅采用一个主成分。从最优阈值上来看，建仓的最优阈值δ1
仍在1～1.3之间，但平仓的最优阈值区域并不稳定，不过大多数情况下-0.9％～-0.6％仍为较佳的平仓区域。

表6-6　主成分配对交易在样本内取得的收益率及最优阈值 

数据来源：［邱小平　2010］

主成分套利在样本内能获取丰厚的收益，那么它在样本外是否也有较好的表现呢？仍然采用6.2.1节提到的3种外推方法对主成分套利策略进行外推，所取得的样本外收益如表6-7所示。可以看出，主成分套利所取得的收益明显高于协整策略。可以认为，主要的原因是协整策略是基于一只股票对另一只股票均衡关系的偏离，一旦均衡关系在样本外被破坏，投资者将面临亏损；而主成分套利策略是基于一只股票对股票组合均衡关系的偏离，显然这种均衡关系更加可靠。

表6-7　主成分配对交易在样本外的效果 

数据来源：［邱小平　2010］

表6-7中还显示，模型Ⅰ的表现略好于模型Ⅱ。在其他情况相同的条件下，累计贡献率取≥80％时效果更好，这与样本内主成分套利策略刚好相反，表明在样本外进行主成分套利时，应当抓大放小（抓住主要波动即可）。在3种外推方法中，第三种外推方法表现最好，其次是第一种外推方法。不过，采用第一种外推方法的模型Ⅰ（累计贡献率取≥80％）表现最为稳健——在不同的建仓、平仓阈值下，所取得的最低收益也有8.07％。从最优阈值来看，建仓的最优阈值δ1
一般在1～1.2或1.5～1.9之间，而平仓的最优阈值δ2
仍在-1～-0.7之间。

6.2.3　行业（股票）轮动套利策略

在一轮上涨行情中，板块之间是轮流上涨的，如何有效利用板块轮动进行套利，从而获得更多的套利机会，是本节要讨论的问题。

1．基本原理（正弦波和余弦波叠加原理）

如图6-3所示为行业（股票）轮动套利策略基本原理。

图6-3　行业（股票）轮动套利策略基本原理

资料来源：［金志宏　2012］

其中，蓝色的是正弦波，红色的是余弦波，黄色的是两者相加的合成波。股票市场中，利用行业股票的负相关性来进行高抛低吸，能够获取比单一持有某个行业股票获得更高的收益率。

2．行业（股票）轮动套利策略概述

一般的行业轮动研究主要着眼于行业的基本面研究，即如何在经济周期下对行业景气股票进行选择，属于长期的宏观基本面行业轮动研究，侧重于股票行业宏观基本面分析；而风格轮动的研究集中于成长股和价值股的研究，也属于长期的轮动研究，主要集中于公司财务指标的分析。

本节中所指的行业及风格轮动分析主要站在量化的角度，从股价趋势的角度把握同一市场环境条件下不同行业及不同股票之间波动的不同步性，从而找到基于市场中性的行业轮动Alpha策略。

中国股市行业股票轮动的结构性特征十分明显。行业轮动策略是指在一轮上涨过程中，通过对行业股票轮动规律的研究和实践，实现总体收益率比投资单一行业或股票高的策略。2011年股市呈趋势性下跌，没有明显的行业轮动上涨机会。以2011年1月4日为基准，可以看到上证指数和各行业指数均成震荡下跌走势。

但是即使在股市单边下跌的2011年，我们依然看到了行业轮动给我们带来的行业股票轮动套利机会。以农林和制造两大板块为例，如图6-4所示是上证指数与部分行业指数走势对比图，如图6-5所示是农林／制造业指数波动图的比值。

图6-4　2011年上证指数及部分行业指数走势图

资料来源：［金志宏　2012］

图6-5　2011年农林／制造行业指数波动图

资料来源：［金志宏　2012］

我们把2011年1月4日的农林指数和制造指数归一化，然后把农林指数与制造指数的相对比值为考察对象，可以发现，农林／制造指数在4月触底0.9后，开始了一波上涨，目前指数比在1.1左右。根据以上分析，设计一套行业轮动指数套利策略：

（1）当农林／制造指数跌到0.9左右，卖空制造业股票，买入农林类股票。

（2）当指数回归到1附近，平仓。

（3）当指数上涨到1.1左右，卖空农林类股票，买入制造业股票。

（4）指数回归到1附近，平仓。

行业轮动策略最终还要落实到具体股票的买卖操作策略上来。下面就从沪深300股票池中各挑选一只农林和制造业股票作为例子，来说明行业轮动策略。农业股中选择的是600598北大荒，制造业中选择的是000425徐工机械。以2011年1月4日的收盘价为基准，受大盘系统性风险所累，两只股票的股价呈逐级回落之势，总体来看，机械板块的徐工机械的跌幅更深些。北大荒全年的走势强于徐工机械，符合指数轮动分析中看到的农林指数与机械指数的相对强弱关系。由于股票的波动性要显著于指数的波动性，因此，具体到股票相对值上，波动性更大些。从后验关系上来看，北大荒和徐工机械之间的套利区间在1.1～1.4之间。利用两者之间的强弱关系进行套利，收益率和沪深300指数之间的关系如图6-6所示。

图6-6　北大荒／徐工机械轮动套利收益率与沪深300走势对比

资料来源：［金志宏　2012］

在通常情况下，作为一种市场中性策略，统计套利策略的收益应当与基准指数的收益是不相关的。从本例中可以看出，2011年的沪深300呈逐级回落之势，但是两只不同行业股票的轮动策略带来的收益率却与市场走势明显背离，呈逐级上涨趋势，与市场走势呈现一定的负相关性。

6.2.4　配对策略改进

配对交易模型需要解决两个问题：一是如何选取股票对；二是如何交易，即何时建仓、平仓。

1．股票对筛选模型

我们把研究的范围限定在沪深300指数成分股，股票对选取方法如下：

（1）行业划分。为了保证选出的股票对在主营业务上相近，对沪深300指数成分股进行行业划分，在同一行业内筛选股票对。需要注意的是，行业划分得越细，同行业内公司的相似度越高，但相应的行业内个股数目会减少，能筛选出的股票对数目也就越少，因此行业划分需要把握一定的尺度。

（2）收益率相关性。配对的股票在股价走势上应具备一定的正相关性，我们要求配对的股票历史收益率的相关系数大于一定的阈值。

（3）价差形态过滤。对于满足协整关系的两只股票，我们进一步要求价差回到均值的速度要足够快，两只股票最好是交替相对走强，这样会有更多的交易机会。

2．配对交易策略改进

本节依然以北京银行和华夏银行在2011年的股价走势作为比较配对交易策略的基础。

1）标准配对交易策略

标准交易模型在设置一个建仓阈值时建仓，然后等价差回到均值0处时再平仓，针对价差可能发生突变的情形，加入了一个止损策略：判断价差的绝对值是否大于3。因为从统计上讲，如果配对的两只股票保持协整关系，那么它们的价差绝对值大于3的概率小于0.3％。一旦出现价差绝对值大于3的情况，即可认为股票对原有的协整关系被破坏，应立即止损。

2）改进策略1：延后开仓策略

针对标准配对交易策略的不足，可以采用如下改进方式：等价差突破阈值后，反向回归穿越阈值时再建仓，称这种策略为延后开仓策略。延后开仓的好处在于一方面可以更加准确地判断出价差向均值回归的趋势；另一方面当价差出现单边走强的情形时，延后开仓策略不会发出建仓信号，从而可以避免一部分损失，提升配对交易的收益。

3）改进策略2：延后开仓＋提前平仓策略

标准配对交易策略和改进策略1都是等价差回归到均值附近时再平仓，而实际交易中经常会发现价差虽然在向均值的方向回归，但没有回归到均值，而是在离均值一定距离处又掉头远离均值。为捕捉前期价差回归阶段的收益，可以采取提前平仓的策略，和延后开仓策略一起构成改进策略2，如图6-7所示。这里设置了两个阈值δ1
和δ2
，分别为建仓阈值和平仓阈值，配对交易在δ2
而非均值处平仓。

图6-7　配对交易：延后开仓＋提前平仓策略

资料来源：［金志宏　2012］

4）3个策略模拟结果

我们使用以上基本配对交易及其两个改进策略，对北京银行和华夏银行2011年年度股价波动情况进行了回溯交易模拟。从图6-7中可以看出，2011年的大部分时间，北京银行和华夏银行的股价比围绕着以0.9为轴，正负5个百分点的波动区间运动。设定区间建仓阈值δ1
为0.5，平仓阈值δ2
为0.1，分别采用以上3种策略的收益率情况如表6-8所示。

表6-8　标准策略、延后开仓、提前平仓策略实证结果 

资料来源：［金志宏　2012］

通过该交易模型的模拟结果可以发现，延后开仓策略在股价比波动不是特别剧烈的情况下，尤其是只在一个阈值范围内反复波动的情况下，并不能有效增加收益。但是模拟结果只是后验结论，在真实股票波动套利过程中，阈值是预先设定的，股价走势图是后验结果，该策略在波动区间大于两个阈值的情况下能够有效增加套利收益。

提前平仓策略对于把握短期波动是有效的，但是实证和理论均表明，提前平仓策略对收益率增加的影响是负面的，尤其是当δ1
/δ2
＞5时，人为增加了套利者判断的因素，对于模型执行的稳定性影响效果负面。

另一个影响收益率的重要因素是阈值δ1
的选取。阈值δ1
越小，触发交易的频率越高，在不考虑头寸因素的前提下，理论收益率越高。但是考虑到头寸因素，并非阈值δ1
越小，总的资金收益率越高，因为要把总头寸分成若干等分头寸，在提高交易频率的同时，降低了总头寸的绝对收益。因此，总收益率与阈值δ1
之间存在一个最优化问题。

6.3　股指套利

在经济全球化的今天，不同的国家、地区、行业经济的联系越来越紧密，而代表这些国家、地区、行业的公司之间的关联程度也越来越大，这就使得系统性的风险会造成一荣俱荣、一损俱损的局面。表现在资本市场上，就是这些国家、地区、行业的指数具有很强的相关性，这就使得进行指数间的对冲交易成为一种低风险、高收益的投资方式。

6.3.1　行业指数套利

在中国的经济发展中，很多行业具有很强的相关性，比如工业和材料之间。中国的工业发展离不开材料，当工业增速加快的时候，对材料的需求也会很大，所以这两个行业之间具有很强的相关性。其他类似的行业还有金融—地产、医药—消费等。

图6-8显示了300工业指数和300材料指数的比价关系。从图中可以看出，这两个指数长期的比价处于0.8～1.05之间，因此当比价超过1.05时，则可以做空工业指数并做多材料指数的交易策略，当比价恢复到0.8以后则平仓，并进行反向操作，从而规避系统性风险，并且赚到其中的波动差。

图6-8　300工业指数—300材料指数比价

案例　行业指数套利

2006年7月10日，工业指数和材料指数的比价为1.08，超过了1.05的区间，我们认为这个比价在未来一段时间会修复，则我们可以做空工业指数，同时做多材料指数的组合。

2006年7月10日，工业指数点位为1382，材料指数点位为1286。假定在两个指数上分别投资50万元，保证金比例为10％。这里为了计算方便，不考虑每个点位对应的份数，认为每次就根据当前指数点位买入对应的份数。

则建仓时：

工业指数空头仓位为：（50万／10％）/1382＝3618（份）

材料指数多头仓位为：（50万／10％）/1286>＝3888（份）

到了2007年9月13日，两个指数的比价已经恢复到了0.82，可以认为已经到达了历史上比价的下限区间，则进行平仓操作。此时工业指数点位为4791，材料指数点位为5815。

工业指数空头盈亏＝（1382－4791）×3618＝-12333762

材料指数多头盈亏＝（5815－1286）×3888＝17608752

总盈亏＝17608752－12333762＝5274990

盈利率＝5274990/100万＝527％

当然，在实际的交易中，考虑到追加保证金等因素，不可能将资金全部用满，因此实际的利润率达不到案例中的理想情况，但是依然可以获得丰厚的收益。

6.3.2　国家指数套利

一个国家可能有多个交易市场，例如，中国有上海证券交易所、深圳证券交易所、香港交易所。国内很多中资股在香港上市，占据了香港大盘指数很大的份额，因此这些中资股指数和恒生指数之间具有比较强的相关性。从图6-9中可以看出，恒生指数和中资指数的比价总的来说在4～8之间震荡。如果上突破8，则可以做空恒生指数并做多中资指数；如果下突破4，则可以以做多恒生指数并做空中资指数的方式进行对冲交易。

图6-9　恒生指数—中资指数比价

案例　国家指数套利

在2005年1月5日，恒生指数—中资指数的比价突破区间上界8，达到9.2，我们认为这个比价在未来一段时间可能会修复，则可以做空恒生指数，同时做多中资指数的组合。

2005年1月5日，恒生指数点位为13764，中资指数点位为1567。假定投资在两个指数上分别投资50万元，保证金比例为10％。这里为了计算方便，不考虑每个点位对应的份数，认为每次就根据当前指数点位买入对应的份数。

则建仓时：

恒生指数空头仓位为：（50万／10％）/13764＝363（份）

中资指数多头仓位为：（50万／10％）/1567＝3190（份）

到了2008年2月1日，两个指数的比价已经恢复到了4，我们认为已经到达了历史上比价的下限区间，则进行平仓操作。此时恒生指数点位为24123，中资指数点位为5063。

恒生指数空头盈亏＝（13764－24123）×363＝-3760317

中资指数多头盈亏＝（5063－1567）×3190＝11152240

总盈亏＝11152240－3760317＝7391923

盈利率＝7391923/100万＝739％

6.3.3　洲域指数套利

目前世界经济区域合作比较多，互相的经贸交流也很频繁，所以使得在一个大洲内部的很多国家、地区之间的经济体具有很强的相关性，比如中国香港和中国台湾，在经济结构、发展阶段、外贸情况等各方面都比较相像，因此在恒生指数和台湾加权指数之间，具有明显的相关性，是可以进行对冲交易的品种。

从图6-10中可以看出，恒生指数和中资指数的比价总的来说在1.0～3.0之间震荡。如果上突破3.0，则可以做空恒生指数，做多台湾加权指数；如果下突破1.0，则可以做多恒生指数、做空台湾加权指数的方式进行对冲交易。

图6-10　恒生指数—台湾加权指数比价

案例　洲域指数套利

在1997年8月1日，恒生指数—台湾加权指数的比价突破区间上界3.0，达到3.3，我们认为这个比价在未来一段时间可能会修复，则可以做空恒生指数，同时做多台湾加权指数的组合。

在1997年8月1日，恒生指数点位为16379，台湾加权指数点位为5013。假定投资在两个指数上分别投资50万元，保证金比例为10％。这里为了计算方便，不考虑每个点位对应的份数，认为每次就根据当前指数点位买入对应的份数

则建仓时：

恒生指数空头仓位为：（50万／10％）/16379＝305（份）

台湾加权指数多头仓位为：（50万／10％）/5013＝997（份）

到了1998年8月13日，两个指数的比价已经恢复到了1.0，我们认为已经到达了历史上比价的下限区间，则进行平仓操作。此时恒生指数点位为6660，台湾加权指数点位为6802。

恒生指数空头盈亏＝（16739－6660）×305＝3074095

中资指数多头盈亏＝（6802－5013）×997＝1783633

总盈亏＝1783633＋3074095＝4857728

盈利率＝4857728/100万＝485％

6.3.4　全球指数套利

在经济全球化的今天，各大经济体之间的合作与交流越来越密切，这就使得很多国家之间的经济具有很强的关联，特别是西方发达经济体之间、新兴经济体之间等股票指数的相关性很强，从而成为对冲交易的好品种，比如德国法兰克福DAX指数和伦敦金融时报100指数。

从图6-11中可以看出，德国法兰克福DAX指数和英国金融时报100指数的比价总的来说在0.7～1.2之间震荡。如果上突破1.2，则可以做空德国法兰克福DAX指数，做多英国金融时报100指数；如果下突破0.7，则可以以做多德国法兰克福DAX指数、做空英国金融时报100指数的方式进行对冲交易。

图6-11　德国法兰克福DAX指数—伦敦金融时报100指数比价

案例　全球指数套利

2000年3月20日，德国法兰克福DAX指数和英国金融时报100指数的比价突破区间上界1.2，达到1.25，我们认为这个比价在未来一段时间可能会修复，则可以做空德国法兰克福DAX指数，同时做多英国金融时报100指数的组合。

2000年3月20日，德国法兰克福DAX指数点位为7872，英国金融时报100指数点位为6086。假定投资在两个指数上分别投资50万元，保证金比例为10％。这里为了计算方便，不考虑每个点位对应的份数，认为每次就根据当前指数点位买入对应的份数。

则建仓时：

德国法兰克福DAX指数空头仓位为：（50万／10％）/7872＝635（份）

英国金融时报100指数多头仓位为：（50万／10％）/6086＝821（份）

到了2001年9月15日，两个指数的比价已经恢复到了0.7，我们认为已经到达了历史上比价的下限区间，则进行平仓操作。此时德国法兰克福DAX指数点位为4115，英国金融时报100指数点位为5408。

德国法兰克福DAX指数空头盈亏＝（7872－4115）×635＝2385695

英国金融时报100指数多头盈亏＝（5408－6086）×821＝-556638

总盈亏＝2385695－556638＝1829057

盈利率＝1829057/100万＝183％

6.4　融券套利

融券，也称为出借证券，是证券公司将自有股票或客户投资账户中的股票借给做空投资者进行抛售的一种交易行为。证券公司出借证券给客户出售，客户到期返还相同种类和数量的证券并支付利息，客户向证券公司融券卖出称为卖空。融券对冲就是利用融券进行做空交易的同时，买入现货做多，从而规避系统性风险的一种交易方式，主要包括：股票—融券套利、可转债—融券套利、股指期货—融券套利和封闭式投资组合—融券套利这几种方式。

6.4.1　股票—融券套利

相对于融资做多而言，融券做空的收益并不低。与此同时，做空机制的出现，也使得此前一些难以操作的无风险套利机会浮出水面。通过融券做空和购买负溢价认股权证进行无风险套利就是一个典型的思路。

由于可以融券卖空，使得投资者可以借助市场上存在的负溢价权证进行无风险套利，通过买入权证、卖空标的股票来锁定权证的负溢价为确定收益。这种套利在理论上是没有风险的，权证的负溢价随着到期日的临近肯定将收敛于0，关键在于负溢价的多少、到期日的长短及融券的利率，这几个因素将决定交易的收益大小。

案例　股票—融券套利

2010年4月9日，江铜权证行权价格报收于4.437元，其最新行权价格为15.40元，按照其4∶1的行权比例来计算，行权成本为33.148元，而该日江西铜业收盘价为37.30元，江铜权证负溢价为（37.3－33.148）/33.148＝12.52％。

在这种情况下，买入江铜权证到期行权将获得12.52％的安全垫，只要江西铜业到期跌幅不超过该安全垫，行权都获利。但是未来股价走势难定，若能对冲正股下跌风险，套利机制可形成。因此投资者在买入江铜权证的同时要做空正股江西铜业对冲其下跌风险。卖出正股、买入权证行权相抵后的总损益为当前的内在价值与价格之差，即为套利利润，并且是无风险的，交易完成之时即被锁定。

例如，投资者从券商融券买入江西铜业，按市场2倍的杠杆来计算，以18.65元的价格向券商融券一份江西铜业股票，然后再以市价卖出，将获得37.30元资金，再用这部分资金购入4份权证，将花去17.748元，剩余的19.552元用做融券的保证金，等到权证期时再通过15.40元的行权价行权归还所借用的股票，这样对冲模型也就建立起来了，将从中获得4.152元。

而投资者投入的初始成本仅为18.65元，也就是说半年时间将获得22.44％的收益回报。当然投资者在融券过程中要产生9.8％的融券利息，扣除融券半年时间应付的利息37.3×9.86％×0.5＝1.84元，也就是说获利为2.312元，收益回报也超过12.39％。

由于券商对融券的保证金有一定限制，一般在70％以上投资者需追加保证金以及行权时资金保证等，再去除交易印花税行权时产生的费用等，收入也将超过10％，这相比银行半年期贷款利率4.86％而言已高出近一倍，而且这种是完全的无风险收益。

6.4.2　可转债—融券套利

可转债与融券组合套利策略也是一种受益于融券交易的策略。当可转债的市场价格低于转股价值时，即转股溢价为负，则存在着套利机会，投资者可以买入可转债并及时将可转债转换成股票并卖出，获取转股价格高于市场价格的差额。

在可转债套利的实际操作中，存在着一些交易和转股的规则限制。例如，投资者买入的可转债存在锁定期，在此期间不能转股；可转债转换的股票在转股后的下一个交易日才能够卖出。融资融券推出前，这些规则使得套利策略存在障碍，隐藏较大风险，导致套利收益难以顺利实现，但融券交易使得这些问题迎刃而解。

套利机会出现时，投资者在买入可转债的同时融券卖出相应数量的标的股票，构建可转债多头与股票空头的组合，等到可转债进入转股期后进行转股，将转股获得的标的股票归还融券负债；或者在可转债市场价格再次高于转股价值，套利空间消失时，买券归还融券负债，同时卖出可转债，提前实现套利。

案例　可转债—融券套利

2010年12月31日，铜陵转债收盘价为201.49元，转股价格为15.68元，转股比例为6.3776，标的股票铜陵有色收盘价为35.05元，转股起始日2011年1月17日。假设融券年费率为10.35％（不考虑其他费用），此时，经计算得到铜陵转债转股价值为35.05×6.3776＝223.53元，比转债收盘价高22.04元，存在着套利空间。投资者以收盘价买入铜陵转债，假设为1万张，投入资金201.49万元，同时融券卖出铜陵有色6.37万股，获得资金223.27万元，产生6.37万股铜陵有色股票的融券负债。

2011年1月17日，铜陵转债进入转股期，投资者将1万张铜陵转债转成铜陵有色股票6.3776万股，于下一个交易日归还6.37万股的融券负债，并卖出剩余股份，在扣除融券费用1.16万元后，套利组合至少可以获得的套利收益为（223.27－201.49－1.16）＝20.62万元，12个交易日的收益率达到20.62/201.49＝10.23％。

其间，铜陵转债的转股溢价于2011年1月14日变为正值。以当日收盘价计算，铜陵转债价格为180元，铜陵有色价格为28.2元，转股价值为179.85元，低于转债价格。此时投资者可以选择提前实现套利收益，买入铜陵有色6.37万股归还融券负债，同时卖出所有的铜陵转债。该投资者在铜陵转债的交易中亏损（180－201.49）×10000＝21.49万元，而在融券交易中获得收益（35.05－28.2）×63700＝43.63万元，在扣除融券费用0.9万元后，套利组合可以获得21.24万元的收益，10个交易日的收益率达到10.54％。

不过，标的股票出现增发、配售和分红等情况时，可转债的转股比例会调整，影响组合的配置，同时会触发融券交易提前还券的条款，导致套利失败。对此，需要在套利前对出现上述股票权益事项的可能性进行评估。

6.4.3　股指期货—融券套利

在融券交易中，券商如果用自营的股票作为融券标的，借给融券者卖出后，如果未来证券价格下跌，投资者买券还券后的收益即为券商的损失。如果这个损失不能覆盖融券利息，则券商就会出现净损失，这对于券商提供融券的积极性是一个重大打击。由于股指期货的出现，则券商可以利用股指期货对冲系统风险，从而实现低风险套利交易。

具体的做法是，当券商向投资者融券后，通过做空股指期货来规避所融出证券股价下行的风险，即如果所融出证券股价下跌，由此产生的损失可以通过做空股指期货的获利得到一定的弥补，进而锁定相对稳定的融券利息收益。通过股指期货的套期保值交易，能够有效对冲融券交易带来的风险，并同时激活两种金融创新业务。

案例　股指期货—融券套利

假定2010年4月19日股指期货开通的当天，有一客户向券商融券卖出贵州茅台10万股，总价值为1480万（4月19日的开盘价148×10万股），约定3个月后（2010年7月19）归还，融券利息3％。

如果在这3个月中，贵州茅台的跌幅超过3％，则该融券的利息不足以覆盖股票损失，券商的这笔交易则会出现亏损。为了降低系统性风险，券商可以于2010日4月19日当天以开盘价（沪深300指数当天的开盘价为3388点，这里为了计算简便，就用沪深300的现货指数来代替股指期货）做空相应市值的股指期货14手（股指期货手数＝1480万／（3388×300））。

到了2010年7月19日，大盘果然出现下跌，沪深300指数从2010年4月19日的3388点跌到了2682点，贵州茅台的价格也从2010年4月19日的148元跌到135元。

贵州茅台收益＝（135－148）×10万＝-120万，亏损120万

股指期货收益＝（3388－2682）×300×14＝296万，盈利296万

融券利息收益＝1480万×3％＝44.4万，盈利44.4万

总收益＝296＋44.4－120＝220.4万

总投入＝贵州茅台市值＋股指期货保证金＝1480万＋1480万×20％＝1776万（20％为股指期货的保证金比例）

收益率＝220.4万／1776万＝12.4％

如果没有利用股指期货对冲的话，这笔交易的收益＝44.4万－120万＝-75.6万

收益率＝-75.6/1480万＝-5.1％

从上面的案例中可以看出，利用股指期货来对冲系统性风险，这样确保了融券可以获得正收益。不过，在实际的操作过程中，券商通过期指对冲融券风险，存在至少三方面实施难点：一是公司对融资融券交易的定位，有些券商在试点初期将信用交易部门定位为职能部门，如此虽有利于谨慎试点，却缺乏融券套保等业务开拓的动力；二是券商内部各业务部门间的配合，融券业务涉及信用交易、自营、研发等多个部门，部门之间的沟通、协调与利益分配机制等也决定其套保融券的具体实施与控制；三是需要对研究部门进行相应投入，因为套保融券效果涉及个股评级、股指期货、套保量测算等多方面研究，跨越多个研究领域，具有一定的综合性与高端性。

6.4.4　封闭式基金—融券套利

封闭式基金是指经核准的投资组合份额总额在投资组合合同期限内固定不变，投资组合份额可以在依法设立的证券交易场所交易，但投资组合份额持有人不得申请赎回的投资组合。

由于封闭式基金不能申请赎回，只能在二级市场上进行买卖，因此，封闭式基金的价格一般会以低于其单位净值进行交易，即折价交易。通过买入折价的封闭式基金，同时构建一个与封闭式投资组合完全一样的股票组合，执行融券卖出，可实现以折价率为收益的套利。

案例　封闭式基金—融券套利

假设9月1日封闭式投资组合的单位净值为1元，其折价率为30％，每份价格0.7元。封闭式到期为2010年12月1日。

步骤1：9月1日，买入封闭式基金10万份，即7万元；同时融券卖出与封闭式投资组合一致、价值却为10万元的股票。

步骤2：12月1日，封闭式基金到期，价格和净值回归一致，也就是说，买入的10万份封闭式投资组合价格与融券卖出的一揽子股票净值达到一致。此时，分别对封闭式投资组合与融券交易进行平仓，不管封闭式投资组合净值如何变化，套利锁定折价率30％的收益，盈利3万元。

情形一：假设到期封闭式基金净值为1.5。

（1）封闭式基金平仓：卖出封闭式基金15万－7万＝8万，即盈利8万元。

（2）融券平仓：买入一揽子股票归还融券，10万－15万＝-5万元，即亏损5万元

（3）总盈亏：8万元－5万元＝3万元。

情形二：假设到期封闭式基金净值为0.8。

（1）封闭式基金平仓：8万－7万＝1万，即盈利1万元。

（2）融券平仓：买入一揽子股票归还融券，10万－8万＝2万元，即盈利2万元。

（3）总盈亏：1万元＋2万元＝3万元。

情形二：假设到期封闭式基金净值为0.5。

（1）封闭式基金平仓：5万－7万＝-2万，即亏损2万元。

（2）融券平仓：买入一揽子股票归还融券，10万－5万＝5万元。

（3）总盈亏：－2万元＋5万元＝3万元。

从市场现状来看，这些融券的套利策略的实现存在着以下一些局限：标的证券及其关联权益证券数量少，融资融券交易期限短，套利技术要求较高。不过，随着融资融券业务的不断拓展，未来标的证券范围的扩大，以及转融通业务的适时推出，必将扫清套利道路上的障碍，促使融资融券套利交易成为投资者保值增值的一种重要投资方式。

6.5　外汇套利

FOREX（外汇交易）市场——银行同业市场，建立于1971年，当时国际贸易从固定汇率转向浮动汇率。从此，一种货币相对于另一种货币的汇率通常以显式的方式来表示：双方都同意的交换关系。该市场的交易量超过了其他所有的投资市场。比如，每天全球有价证券市场的交易量大约为3000亿美元，而每天外汇交易量为1～3万亿美元。不过，FOREX并不是传统意义上的市场，它并没有像股票和期货那样有具体的交易场地，外汇交易是通过电话和电脑终端，在全球几百家银行间同时进行的。

在外汇交易市场，货币成对进行交易，货币对的两个组成币种相互关联、不可分割，货币对的两个组成币种在交易中互相兑换。它们的交换价格称为汇率，汇率受货币的供求关系影响。

市场中交易最为常见的货币被称为主要货币，大部分货币的买卖相对于美元（USD）进行，美元（USD）是交易次数最多的货币。另外5种频繁交易的货币是：欧元（EUR）、日元（JPY）、英镑（GDP）、瑞士法郎（CHF）和澳大利亚元（AUD）。这6种主要货币的交易占据全球外汇交易市场90％的交易量，其中最常见的货币对是欧元／美元（EUR/USD）。

在外汇交易市场，主要的货币对价格用汇率表示，市场的供求决定了货币的价值，外汇市场上一种货币的价值由另一种货币表示。在一个货币对中，第一种货币叫做基准货币，第二种货币叫做计价货币或相对货币。

当投资者进行货币交易时，买入基准货币，卖出计价货币。汇率告诉买家买入一单位基准货币要花费多少计价货币。货币对的顺序通常不变，这是行业的普遍做法。例如，货币对USD/JPY（USD是基准货币，JPY是计价货币）。投资者所见的货币对顺序不会发生改变，所以投资者是买还是卖取决于交易方向，例如，对于USD/JPY而言，投资者可以用USD买入JPY，或者是用JPY买入USD。

例如，EUR/USD 1.2500意味着投资者需用1.25美元来买入1欧元，也可以说成是，若投资者卖出1欧元就会得到1.25美元。所有的交易都同时涉及买入一种货币和卖出另一种货币。如果在第二天，欧元对美元升值，汇率变为1.26，那么投资者当初买入的每一欧元都将带来1美分的收益。如果进行反方向交易，那么投资者当初卖出的（在1.25卖出）每一欧元都将带来1美分的损失（因为此时的1欧元需要投资者拿1.26美元来回购）。

在外汇市场中，交易商通过买卖货币获利。货币有两个价格：买价叫做“出价”，卖价称为“叫价”。叫价和出价之间的差额就是价差，它代表着做市商从交易商处买入卖出的不同。

例如，EUR/USD的买价／卖价是1.2100/1.2200。市场做市商用1.21美元从交易商手中买入1欧元，但以1.22美元的价格把这1欧元卖给交易商。如果交易商在汇率无变化的情况下快速买卖，他们将遭受损失，这是由价差造成的。因为交易商的买入价要高于他们的卖出价。事实上，价差是市场做市商的主要收入来源，和其他市场一样，商家的卖价要比买价高。

由于不同的货币之间存在相关性，以及不同的货币的利息等不同，因此存在套利交易及对冲交易的可能性。

6.5.1　利差套利

我们知道，去银行存款和贷款的时候会产生利息，而每个国家的存贷款利率是不同的，称为利差，比如日本的利率几乎为零，而澳大利亚的利率在5％左右，如果在日本有日元存款，那就不如把它换成澳元存款，以获得更高的利息，甚至可以大量向银行贷入日元并变成澳元存款，获取更高的收入。但存在一个问题，那就是汇率的波动，比如，如果这一年澳元贬值了很多，已经远远超过了澳元存款利息的收入，这样就不划算了，所以要用对冲的方法以规避汇率的波动造成的影响。

套利方法简介：用一个没有隔夜利息的外汇交易平台和一个有隔夜利息的外汇交易平台进行对冲，使汇率的波动不会造成盈亏，然后从有隔夜利息的平台赚取利息。由于外汇交易中可以使用保证金制度，因此利用杠杆可以赚取数倍的利息。

案例　外汇利差套利

首先要选择一个无隔夜利息的外汇交易平台，有些外汇公司遵从伊斯兰里巴（Riba）禁令，因此无隔夜利息。比如，Marketiva公司就是这样的一个交易平台，杠杆100倍。有隔夜利息的外汇交易平台到处都是，这里选用FXDD，杠杆100倍。

假设选用2008年1月20日的英镑／日元（GBP/JPY，简称GJ，当天的汇率英镑美元为1.9553）作为套利的货币对。GJ在FXDD平台的买入持仓隔夜利息为25.62美元（1标准手所产生的利息，1标准手为10万货币单位，十万单位的GJ根据当时的汇率相当于195530美元），换算成百分比为0.0131％。假设我们现在有2万美元，分成两份，在两个平台各使用1万美元。

在FXDD平台买入GJ，仓位十分之一，由于使用的是100倍杠杆，因此相当于是持有10万美元的仓位。在Marketiva平台卖出GJ，使用同样的仓位，以便与前一平台对冲，使GJ价格的波动不会对我们的资金造成盈亏。

十分之一的仓位大概可以承受一个月的波动而不会爆仓，两个平台的资金可以有充足的时间流转，根据波动情况将盈利账户的钱转到亏损的账户，使两边的账户一直保持充足的保证金，保证持仓不会被爆仓。

为了防止因为短期波动过大使账户爆仓而造成的可能损失，我们将设置止盈单，使当一个账户爆仓的时候，另外一个账户刚好止盈。这样即使有一个账户被爆仓，汇率波动造成的盈亏仍为0。

由于Marketiva平台没有隔夜利息，因此我们在此平台卖出GJ不需要付出利息，而在FXDD平台可以收取利息，那么一年里我们收取的利息为：持仓金额×隔夜利率×一年天数＝100000×0.0131％×365＝4781.5（美元）。

手续费损失：

（1）点差，外汇的买入价和卖出价有一个差额，GJ的为8个基点，大约相当于0.0383％，这个损失将在两个账户（持仓各10万美元）同时存在，理想条件下这种损失只会出现一次，因此等于（100000＋100000）×0.0383％＝76.6（美元）。

（2）资金在两个账户流转时产生的手续费，如果使用电汇，取钱与入金的费用各为14美元，假设半个月需转一次账，则一年需转24次，费用为14×2×24＝672（美元）（这个数值可能会有些出入，各个交易平台的存取款手续费不同，这里使用的Marketiva的手续费作为参照）。

因此最终收益为：4781.5－76.6－672＝4032.9（美元），由于我们投入的金额为2万美元，因此年收益约为20％。

虽然这种套利方法不存在理论上的风险，但实际上也还是有风险，比如，人为造成的操作失误、外汇公司的倒闭、利率的变化等。

6.5.2　货币对套利

在经济全球化的今天，由于很多国家的货币之间存在相关性，因此利用货币对进行对冲交易，可以在降低系统性风险的同时获得相对稳健的收益。目前世界外汇市场都以美元做计算单位，所有外币的升跌都以美元作为相对的汇价。美元强，即外币弱；外币强，则美元弱。美元的升跌影响所有外币的升跌，所以，若看好一种货币，但要减低风险，就需要同时沽出一种看淡的货币。买入强势货币，沽出弱势货币，如果估计正确，美元弱，所买入的强势货币就会上升；即使估计错误，美元强，买入的货币也不会跌太多。沽空了的弱势货币却跌得重，做成亏少赚多，整体来说仍可获利。

案例　货币对套利

下面以英镑／欧元为例，说明该货币对进行对冲交易的方法。由于欧洲经济一体化的加速，英国和欧元区经济具有非常强的关联性，因此欧元和英镑这两个货币的相关性也非常强。从图6-12中可以看出，英镑和欧元的比价总的来说在1.08～1.18之间震荡。如果上突破1.18，则可以做多欧元，做空英镑；如果下突破1.08，则可以以做空欧元，做多英镑的方式进行对冲交易。。

图6-12　英镑—欧元比价

在2009年3月15日，英镑—欧元的比价突破区间下界1.08，达到1.06，我们认为这个比价在未来一段时间可能会修复，则可以做多英镑，同时做多欧元的组合。

2009年3月15日，英镑／美元点数为1.4512，欧元／美元点数为1.3672。假定投在货币上分别投资5000美元，保证金比例为1％。

则建仓时：

英镑／美元多头仓位为：（5000/1％）/1.4512＝344542（份）

欧元／美元空头仓位为：（5000/1％）/1.3672＝365710（份）

到了2009年6月15日，两个货币的比价已经恢复到了1.184，我们认为已经到达了历史上比价的上限区间，则进行平仓操作。此时英镑／美元点数为1.6315，欧元／美元点数为1.3835。

英镑／美元多头盈亏＝（1.6315－1.4512）×344542＝62121

欧元／美元空头盈亏＝（1.3835－1.3672）×365710＝5961

总盈亏＝62121＋5961＝68082

盈利率＝（68082/10000）－1＝581％

第7章　期权套利

◆摘要◆

期权（Option）又称选择权，是在期货的基础上产生的一种衍生性金融工具。从其本质上讲，期权实质上是在金融领域将权利和义务分开进行定价，使得权利的受让人在规定时间内对于是否进行交易行使其权利，而义务方必须履行。在期权的交易时，购买期权的一方称为买方，而出售期权的一方则称为卖方；买方即权利的受让人，而卖方则是必须履行买方行使权利的义务人。

期权的优点在于收益无限的同时风险损失有限，因此在很多时候，利用期权来取代期货进行做空、套利交易，会比单纯利用期货套利具有更小的风险和更高的收益率。

利用期权的各种组合，有多种套利方法，包括股票：期权套利、转换套利、跨式套利、宽跨式套利、蝶式套利和飞鹰式套利等。

（1）股票和期权的套利组合有两种：一种是做多股票的同时买入认沽权证；另外一种是做空股票的同时买入认购权证，分别用多头套利和空头套利来表示。

（2）转换套利是指在买入看跌期权、卖出看涨期权的同时，买入相关期货合约的交易。其中看涨期权和看跌期权的执行价格和到期日是相同的，相关期货合约的交割月份与期权合约的到期月份也是相同的。

（3）跨式套利，也叫马鞍式期权、骑墙组合、等量同价对敲期权、双向期权、底部跨式期权，是指以相同的执行价格同时买进或卖出不同种类的期权。跨式套利包括买入跨式套利和卖出跨式套利两种。

（4）宽跨式套利也叫做异价对敲或勒束式期权组合，是投资者同时买进或卖出相同标的物、相同到期日，但不同执行价格的看涨期权和看跌期权。根据投资者买卖方向的不同，宽跨式套利可以分为买入宽跨式套利与卖出宽跨式套利。

（5）蝶式套利是利用同时买进和卖出同一商品、同一到期月份，但不同敲定价格的看涨或看跌期权合约进行套利。蝶式套利由两个买卖方向相反，共有一个相同并居中的执行价格的套利交易所组成。

（6）飞鹰式套利，也叫秃鹰式套利，是指分别卖出（买进）两种不同执行价格的期权，同时分别买进（卖出）较低与较高执行价格的期权。所有的期权都有相同的类型、标的合约与到期日，执行价格的间距相等。

7.1　基本概念

7.1.1　期权介绍

◆摘要◆

期权主要可分为买方期权和卖方期权，前者也称为看涨期权或认购期权，后者也称为看空期权或认沽期权。期权交易事实上是这种权利的交易，买方有执行的权利也有不执行的权利，完全可以灵活选择。每一期权合约都包括4个特别的项目：标的资产、期权行使价、数量和行使时限。

（1）标的资产：每一期权合约都有一标的资产，标的资产可以是众多的金融产品中的任何一种，如普通股票、股价指数、期货合约、债券、外汇等。通常，把标的资产为股票的期权称为股票期权，以此类推。所以，期权有股票期权、股票指数期权、外汇期权、利率期权、期货期权等。

（2）期权行使价：在行使期权时，用以买卖标的资产的价格。在大部分交易的期权中，标的资产价格接近期权的行使价，行使价格在期权合约中都有明确的规定，通常是由交易所按一定标准以减增的形式给出的。

（3）数量：期权合约明确规定合约持有人有权买入或卖出标的资产数量。

（4）行使时限：每一期权合约具有有效的行使期限，如果超过这一期限，期权合约即失效。

按执行时间的不同，期权主要可分为两种：欧式期权和美式期权。欧式期权，是指只有在合约到期日才被允许执行的期权，它在大部分场外交易中被采用。美式期权，是指可以在成交后有效期内任何一天被执行的期权，多为场内交易所采用。

与期货相比，期权最大的优势是损失有限，无论市场是涨还是跌，最大的损失就是权利金，而不像期货那样，会损失数倍于保证金的资金，这个优势使得利用期权进行套利交易成为一种比较好的交易策略。

7.1.2　期权交易

期权交易的了结方式与期货类似，包括对冲平仓和履约平仓两种方式：

（1）对冲平仓。看涨期权的卖方想对冲了结在手的合约部位，再卖出同样内容、同样效果的看涨期权合约即可。对于看跌期权的卖方来说，为对冲合约部位，则必须通过卖出内容数量相同的看跌期权合约给予平仓。反之，对于期货期权的卖方也是如此，如果期货期权卖方通过对冲了结其在手的合约部位，就必须以相同的执行价格和到期日买入数量内容相同的期权合约。在期权合约有效期内的任何交易时间内，买方和卖方均可将在手的未平仓期权部位予以对冲。

（2）履约平仓。期货期权也可以通过履约平仓。但是在期货期权交易中，只有期权买方有权在期权合约规定时间内要求履行合约，并在期权合约规定的执行价格水平上获得一个期货交易部位。买方可以在期权合约有效期内的任何一个交易日包括最后交易日（美式期权）要求履行期权合约，即按照预先确定的执行价格买入或卖出一定数量的相关期货合约，而卖方必须做好履行合约的准备。在履约方面，买方只有权利没有义务，卖方只有义务没有权利。

期权交易的结算方法如下：

（1）卖方保证金。期权结算是期权交易环节中不可缺少的一环。由于买方的最大风险是成交时所交的权利金，因此对于买方没有每日结算风险。但卖方的风险与期货一样依然存在，因此，交易所要对卖方进行每日结算。

传统的期权保证金制度以纽约商品交易所为代表，每一张卖空期权保证金为下面两者中的较大者：权利金＋期货合约保证金－虚值期权价值的一半；权利金＋期货合约保证金的一半。

（2）买方权利金结算。买方不进行每日结算。买方一旦成交，其权利金从其结算准备金账户上划出，这是买方可能面临的最大风险，一旦平仓，则按照权利金平仓价全部划入其结算准备金账户

（3）履约结算。对于美式期权来说，每天都可能有履约情况发生。如果买方提出执行权力，则交易所按照配对原则找出相应的卖方。配对后，当日各自将期权持仓自动消失，结算部门收取卖方的交易保证金也于当日自动划入卖方结算准备金账户。至于买方，因为成交当日的权利金已经划出，不进行每日结算，所以执行权力后也没有权利金的划转问题。至于二者转换的期货部位可视为新建立了期货部位，按照期货结算方法进行每日结算。

（4）权利放弃时的结算。最后交易日闭市后，虚值、平值期权及提出不执行的实值期权将自动失效，其持仓在最后交易日后随着合约的到期也自然消失。

权利放弃时，买方不用结算。卖方所支付的交易保证金全部划入其结算准备金账户。

（5）实值期权自动结算。是指在到期日闭市后，所有没有提出权利执行的实值期权将由结算部门自动结算。

7.1.3　牛熊证

牛熊证的发展历史不到十年，在海外市场主要集中在德国、瑞士、英国和澳大利亚。其中欧洲和澳大利亚的牛熊证市场是增长最快的市场之一，德国法兰克福和斯图加特两个交易所上市的牛熊证超过了5500种，每月平均成交达到80亿港元。中国香港从2006年6月正式上市交易这个产品，立刻得到了迅猛发展。总体上看，牛熊证是一种十分成功的产品，无论是初次发行还是二手市场都很活跃。

1．产品的定义

牛熊证全称为可收回牛熊证（简称CBBC），是追踪标的资产表现的一种结构性产品，允许持有人在一定期限内，以某个指定的价格，向发行人购入（或出售）一定数量的证券、商品、外汇或金融其他产品，但如果前标的资产在到期前到达某一指定水平（称为收回价），发行商将立即收回牛熊证（称为强制收回机制）并终止其交易。

牛熊证多数是以股票或股票指数作为标的资产，但也有不少其他资产，如货币和商品等。牛熊证的期限一般为3个月至5年。

按与标的资产的价格关系区分，与认购权证和认沽权证相对应，牛熊证可分为牛证和熊证，看好标的资产后市的投资者可选择牛证，相反则选择熊证。

这里先简单介绍强制收回机制，因为这是牛熊证与权证相区别的重要特征。牛熊证具有收回价，其具体价格由发行商在发行前即设定，一旦标的资产价格在交易期间内触及收回价，则触发强制收回机制。牛熊证提早到期，由发行商收回，其买卖也会即时终止，整个过程称为强制收回事件。

2．产品的特点

牛熊证的运作方式和衍生权证极为相似，牛熊证兼具现货产品和衍生产品的双重特点：在市场上，牛熊证是作为现货产品出现的，它有确定的流通数量，而其买卖与股票没有差别，并非如期权、期货一样的保证金交易；另一方面，它具有衍生产品的杠杆效应，所以具备高风险和高利润的特征，其利润理论上无上限，而最高损失可达100％。

牛熊证价格一般紧贴标的资产的价格，两者价格走势十分接近，在通常情况下价格变动比例为1∶1；其价格一般不受引伸波幅的影响，而且不随时间值耗损。基于牛熊证是以一个基准价和标的资产的价格变动来计算价值的，所以其价值的确定相当直接和明了。

对于买卖双方而言，他们的收益和成本都相当清楚，就定价成交来说，价格即使受一些供求关系的影响，但由于其价值的透明度很高，牛熊证的价格仍能比较线性地随标的资产的涨跌而涨跌。而且关键是牛熊证的价格都为价内定价，这是牛熊证的强制收回机制决定的：就牛证来说，若行使价高于现价，则对于大于或等于行使价的收回价来说，此牛证还未被发行就可强制收回了，这样是没有意义的，熊证也是类似的原理。

从这一点来看，能够价内、价外、价平的衍生权证更能反映出市场的预期，即能对引伸波幅做出更准确的估计，所以，相比之下，衍生权证存在更多的投机套利，使其能大涨大跌。而牛熊证因为定价机制简单，所以能大幅降低引伸波幅的影响。另外，牛熊证的价值不像权证或期权和期货，并不随时间值耗损。

3．产品的内在风险

牛熊证本身具有以下内在风险。

（1）强制收回机制：无论对于N类还是R类牛熊证，一旦被强制收回，其损失额都将占总投资额的巨大比例，N类即100％损失，而R类在最坏的情况下也能达到100％。而强制收回发生后，即使标的资产在之后可能反弹，但牛熊证不再生效，所以投资者也不能从反弹中获取任何利益。一般来说，收回价和标的资产现价之间的差价越大，则牛熊证被强制收回的可能性越小。同时差价越大，则杠杆效应越小，因为它增加了合约的发行价（即增加了成本）。

（2）杠杆作用：牛熊证价格变动的基数是牛熊证初始的发行价格，它只相当于标的资产价格的很少部分，所以根据其与标的价格变动1∶1的比例，牛熊证变动的百分比要比标的资产变动的百分比高很多。因此，一旦标的资产价格向投资者期望的相反方向移动，投资者必将受到比直接购买标的资产更大的损失。

（3）有效期限：牛熊证的有效期限最短为3个月，最长为5年，在交易期间还有被强制收回的可能。而且在海外牛熊证市场，投资者买入牛熊证后，往往也只持有很短的时间，一般只打算通过标的资产的上升或下跌来赚取短线利润，因此，牛熊证并不适宜作为长线投资产品。

（4）对冲值（DELTA△）：虽然牛熊证价格的变动是直接受标的资产价格变动影响的（变动比例1∶1即对冲值△＝1），但其本身还受到其他因素的影响，包括供求、财务费用和有效期，所以对冲值在牛熊证有效期内未必总是接近于1。特别是在标的资产价格临近收回价的时候，由于其被强制收回的风险增加，其流通性会降低，所以牛熊证在此时的价格并不能实时和有效地反映标的资产的涨跌。

（5）流通性：虽然存在牛熊证的流通性提供者，但并不代表投资者一定能够按自己的需求价格买入或卖出牛熊证。而且若在成交量不高的情况下，就存在流通性风险，这也将影响到标的资产的价格能否得到合理的反映。

4．产品的优点

相对于其他衍生产品，牛熊证具有如下优点。

（1）透明度高：牛熊证与标的资产1∶1的价格比例简单易明，而且计价透明，没有引伸波幅导致的与股价背到道而驰的现象。

（2）选择范围广：可追踪的相关资产选择广，以欧洲的市场经验为例，其范围可包括流通量高的股份、外币、贵金属（如金、白金、银）、商品（如石油），甚至美国国库债券。

（3）杠杆效应：牛熊证是杠杆式投资，其所需投资金额通常比直接投资标的要少。因此，作为短线投资者而言，如果预期标的资产在极短时间内将做出一个较大幅度的变动，牛熊证则是一个绝佳的选择，其低价值所对应的是高杠杆比率，看准时的回报会相当可观。就因为这个特点，牛熊证很受散户投资者欢迎。

（4）风险有上限，而回报并无上限：投资牛熊证的风险以已支付的投资金额为上限，这是强制收回机制止损所决定的。而从回报来说，牛熊证并无上限。当然，如果标的资产的市场上是限制涨跌幅度的，那么另当别论。

7.2　股票／期权套利

股票和期权的套利组合有两种，一种是做多股票的同时买入认沽权证；另外一种是做空股票的同时买入认购权证。分别用多头套利和空头套利来表示，股票—期权套利综合分析如表7-1所示。

表7-1　多头股票—期权套利综合分析表 

7.2.1　股票—股票期权套利

案例　多头股票—股票期权套利组合

在2月份，有如下5月到期的某股票的认沽权证：

某投资者在2月份买入1万股该股票，投入资金45×10000＝45万，同时买入这10万股股票的认沽权证，支付资金＝100000×0.5＝5万元。总投资为50万，假定到了5月31日，分别以股票小于45元、等于50元、大于50元为例，说明该套利组合的结果。

如表7-2所示，股票认沽权证的组合，最大的作用就是锁定了下行风险。如果股票出现下跌，则不会有任何损失；如果股票上涨超过行权价，则可以获得超额收益。这种方式类似于股指期货套保，但是与股指期货套保不同的是：股指期货套保无法获得超额收益。

表7-2　多头股票—股票期权套利案例损益分析表 

7.2.2　股票—指数期权套利

案例　股票—指数期权套利

在2月份，有如下5月到期的恒生指数的认沽权证，当前恒生指数为13500点。同时有某股票，当前价格为13元，投资者认为在未来3个月该股票会跑赢恒生指数，但是由于无法确定恒生指数的涨跌，故而可以构建股票—指数认沽权证的对冲组合。

该投资者买入股票1万股，投入资金13×1万＝130000，同时买入10万股的恒生指数的认沽权证，投入资金0.05×10万＝5000，总资金为13.5万。

假定到了5月31日，分别以恒生指数上涨20％、10％、0、-10％，股票跑赢恒生指数10％，即分别为30％、20％、10％、0为例，说明该对冲组合的效果，损失分析如表7-3所示。

从表7-3中可以看出，股票—指数认沽权证的组合，如果在确认股票在未来一段时间可以超越指数的情况下，该组合可以获得稳健的阿尔法收益。

表7-3　多头股票—指数期权套利案例损益分析表 

如果在该认沽权证出现市场折价的时候，则可以买入恒生指数的成分股和该认沽权证的组合，构建一个完全无风险套利组合。

7.3　转换套利与反向转换套利

7.3.1　转换套利

转换套利是指在买入看跌期权、卖出看涨期权的同时，买入相关期货合约的交易。其中，看涨期权和看跌期权的执行价格和到期日是相同的，相关期货合约的交割月份与期权合约的到期月份也是相同的。在期货合约到期前，当期货价格高于执行价格的时候，交易者的空头看涨期权将被履约，并自动与交易者的多头期货部位相对冲，多头看跌期权则任其作废。如果在期货合约到期前，期货价格低于执行价格，交易者的多头看跌期权将被履约，并自动与交易者的多头期货部位相对冲，空头看涨期权则任其到期取消。

转换套利所获利润的一般计算公式如下：

转换套利利润＝（看涨期权权利金－看跌期权权利金）－（期货价格－期权执行价格）

案例　转换套利

某投资者在5月份以3美元／盎司的权利金买进1张执行价格为400美元／盎司的6月份黄金看跌期权，又以3.5美元／盎司的权利金卖出1张执行价格为400美元／盎司的6月份黄金看涨期权，再以市场价格399.5美元／盎司买进1张6月份黄金期货合约。其套利分析过程如表7-4所示，盈亏损益如图7-1所示。

表7-4　转换套利分析过程 

由图7-1可以看出，将买进看跌期权、卖出看涨期权和买入期货合约的盈亏曲线合在一起构成了转换套利的盈亏曲线，该曲线恒定为一条水平线，截距为1，这说明无论6月份期货市场价格如何变动，套利者都可以获得1.0美元／盎司的恒定收益。根据转换套利计算公式：转换套利收益＝（看涨期权权利金－看跌期权权利金）－（期货价格－期权执行价格），可以算出恒定收益为：（3.5－3）－（399.5－400）＝1（美元／盎司）。

图7-1　转换套利盈损益

7.3.2　反向转换套利

反向转换套利与转换套利的操作相反，是指在买入看涨期权、卖出看跌期权的同时，卖出相关期货合约的交易。其中，看涨期权与看跌期权的执行价格和到期日都相同，相关期货合约的交割月份与期权到期月份也相同，并且在执行价格上尽可能接近期货价格。在这种操作下，如果相关期货价格在到期时高于期权的执行价格，多头看涨期权将被履约，并自动与交易者的空头期货部位相对冲，空头看跌期权则被放弃。如果期货价格在到期时低于期权执行价格，空头看跌期权将被履约，并自动与交易者的空头期货部位相对冲，多头看涨期权被放弃。

反向转换套利的利润有一个一般性计算公式：

反向转换套利的利润＝（看跌期权权利金－看涨期权权利金）－（期权执行价格－期货价格）

案例　反向转换套利

某投资者在5月份以3美元／盎司的权利金买进1张执行价格为400美元／盎司的6月份黄金看涨期权，又以4美元／盎司的权利金卖出1张执行价格为400美元／盎司的6月黄金看跌期权。再以市场价格400.80美元／盎司卖出1张6月份黄金期货合约。套利盈亏曲线如图7-2所示。

图7-2　反向转换套利损益

由图7-2可知，无论6月份期货市场价格如何变化，套利者都可以获得1.8美元／盎司的恒定收益。根据上述公式，反向转换套利收益＝（4－3）－（400－400.8）＝1.8美元／盎司。

7.4　跨式套利

跨式套利（Straddle），也叫马鞍式期权、骑墙组合、等量同价对敲期权、双向期权（Double Options）、底部跨式期权（Bottom Straddle），是指以相同的执行价格同时买进或卖出不同种类的期权。跨式对冲包括买入跨式套利和卖出跨式套利两种。

7.4.1　买入跨式套利

买入跨式套利的综合分析如表7-5所示。

表7-5　买入跨式套利综合分析表 

案例　买入跨式套利

在2月份，有如下5月到期的恒生指数认购权证和认沽权证：

某投资者在2月份买入1张执行价格为13000点的5月恒指认购权证，支付权利金500元（0.5×1000＝500），同时，他又以买入l张执行价格为13000点的5月恒指认沽权证，支付权利金300元（0.3×1000＝300），该买入跨式期权的交易细节如表7-6所示。

表7-6　买入跨式套利交易细节 

高平衡点＝13000＋500＋300＝13800点

低平衡点＝13000－（500＋300）＝12200点

下面来看，5月31日恒生指数（P）分别在行权价上下的情况。由图7-3可以看出，该买入跨式期权的最大亏损为800个点（即所支付的权利金），P1（12200点）和P2（13800点）为盈亏平衡点。当恒指跌破l2200点或上涨超过13800点时就盈利了。

图7-3　买入跨式套利损益

7.4.2　卖出跨式套利

卖出跨式套利的综合分析如表7-7所示。

表7-7　卖出跨式套利综合分析表 

案例　卖出跨式套利

在2月份，有如下5月到期的恒生指数认购权证和认沽权证：

某投资者在2月卖出1张执行价格为13000点的5月恒指认购权证，获得权利金500元（0.5×1000＝500），同时，他又卖出1张执行价格为l3000点的5月恒指认沽权证，获得权利金300元（0.3×1000＝300），则该买入跨式期权的交易细节如表7-8所示。

表7-8　卖出跨式套利交易细节 

高平衡点＝13000＋500＋300＝13800点

低平衡点＝13000－（500＋300）＝12200点

下面来看5月31日恒生指数（P）分别在行权价上下的情况，如图7-4所示。与前面买入跨式对冲不同的是，卖出跨式对冲中，投资者首先获得权利金，然后根据不同的情况支付给对手价值，中间的差价就是盈利。

图7-4　卖出跨式套利损益

由图7-4可以看出，该卖出跨式期权的最大盈利为800点（即所收取的权利金），P1（12200点）和P2（13800点）为盈亏平衡点。当恒指跌破l2200或上涨超过13800点时就亏损了。

7.5　宽跨式套利

宽跨式套利又称异价对敲或勒束式期权组合，是投资者同时买进或卖出相同标的物、相同到期日，但不同执行价格的看涨期权和看跌期权。根据投资者买卖方向的不同，宽跨式套利可以分为买入宽跨式套利与卖出宽跨式套利。

7.5.1　买入宽跨式套利

买入宽跨式套利的综合分析如表7-9所示。

表7-9　买入宽跨式套利综合分析表 

多头宽跨式套利的权利金比较少，包括虚值期权，因为若市场发展为单边市，宽跨式套利的杠杆作用比较大。

案例　买入宽跨式套利

某投资者在2月份以300点的权利金买入1张5月份到期、执行价格为10500点的恒指看涨期权，同时，他又以200点的权利金买入1张5月份到期、执行价格为10000点的恒指看跌期权，买入宽跨式套利的盈亏状况如图7-5所示。

图7-5　买入宽跨式套利损益

由图7-5中可以看出，该买入宽跨式套利的最大亏损为500点（即支付的权利金），P1（9500点）、P2（11100点）为盈亏平衡点。当恒指跌破9500点或者上涨超过11000点的时候就盈利了。利润大小取决于两个执行价格的接近程度。距离越远，潜在损失越小，但是要想获得利润，标的物价格变动需要更大一些。

7.5.2　卖出宽跨式套利

卖出宽跨式套利的综合分析如表7-10所示。

表7-10　卖出宽跨式套利综合分析表 

案例　卖出宽跨式套利

某投资者在2月份以300点的权利金卖出1张5月份到期、执行价格为10500点的恒指看涨期权，同时，他又以200点的权利金卖出1张5月份到期、执行价格为10000点的恒指看跌期权。该卖出宽跨式套利的盈亏状况如图7-6所示。

图7-6　卖出宽跨式套利损益

由图7-6可以看出，该卖出宽跨式套利盈利最大为500点（即支付的权利金），P1（9500点）和P2（11100点）为盈亏平衡点。当恒指跌破9500或者涨过11100点的时候就亏损了。由此可见，进行宽跨式套利，只有价格波动幅度在一定范围之内才可能盈利，超过这一范围则会亏损。

7.6　蝶式套利

蝶式套利的原理和垂直套利相似，都是利用同时买进和卖出同一商品、同一到期月份，但不同敲定价格的看涨或看跌期权合约进行套利。但不同的是，蝶式套利由两个买卖方向相反，共有一个相同并居中的执行价格的垂直套利交易所组成。具体的方式是：买入（或卖出）低执行价格的看涨（或看跌）期权，卖出（或买入）居中执行价格的看涨（或看跌）期权，同时买入（或卖出）高执行价格的看涨（或看跌）期权。其中，居中执行价格的期权的交易数量是低执行价格和高执行价格期权交易量之和，这相当于两个垂直套利的组合。低执行价格和高执行价格的期权分居于居中执行价格的两边，形同蝴蝶的两个翅膀，所以称为蝶式套利。根据买卖方向的不同，蝶式套利分为买入蝶式套利和卖出蝶式套利两种。

7.6.1　买入蝶式套利

买入蝶式套利的操作特点是卖出居中执行价格的看涨（看跌）期权的同时，买入两边低执行价格和高执行价格的看涨（看跌）期权，分析如表7-11所示。

表7-11　买入蝶式套利综合分析表 

案例　买入蝶式套利

某投资者以260美分／蒲式耳的执行价格买入10手5月份看涨小麦期权，权利金为16美分／蒲式耳，与此同时卖出20手执行价格为270美分／蒲式耳的5月份小麦看涨期权，权利金为9美分／蒲式耳，再买入10手执行价格为280美分／蒲式耳的5月份小麦看涨期权，权利金为4美分／蒲式耳。该策略是一种买入蝶式套利的操作，它需要支付一个初始净权利金为2美分／蒲式耳（16＋4－9×2）。

该操作的损益图如图7-7所示。

图7-7　买入蝶式套利损益

从图7-7中可以看出，这种买入蝶式套利的最大可能收益为8美分／蒲式耳（270－260－2＝8），最大可能亏损为2美分／蒲式耳（等于支付的权利金）。当期货价格小于260美分／蒲式耳或者大于280美分／蒲式耳时，交易者面临一个恒定的亏损值2美分／蒲式耳，而当期货价格在260～280美分／蒲式耳之间波动时，投资者的收益在-2～8美分／蒲式耳之间，其中低损益平衡点（P1）为262美分／蒲式耳（270－8＝262），高损益平衡点（P2）为278美分／蒲式耳（270＋8＝278），当期货价格在270美分／蒲式耳时，收益达到最大，即8美分／蒲式耳。由此可见，这种操作适合期货出现小幅度波动的情况，即使判断错误，损失也极为有限。

同理，也可以在看跌期权上进行买入蝶式套利，其面临的盈亏状况和在看涨期权上的操作非常类似。

7.6.2　卖出蝶式套利

卖出蝶式套利的操作特点是在买入居中执行价格的看涨（看跌期权）的同时，卖出两边低执行价格和高执行价格的看涨（看跌期权），对卖出蝶式套利的具体分析如表7-12所示。

表7-12　卖出蝶式套利综合分析表 

案例　卖出蝶式套利

某交易者以260美分／蒲式耳的执行价格卖出10手5月份小麦看涨期权，权利金为16美分／蒲式耳，与此同时，买入20手执行价格为270美分／蒲式耳的5月份小麦看涨期权，权利金为9美分／蒲式耳，再卖出10手执行价格为280美分／蒲式耳的5月份小麦看涨期权，权利金为4美分／蒲式耳。该策略是一个卖出蝶式套利（看涨期权）的操作，它可以获得一个初始净权利金收入2美分／蒲式耳（16＋4－9×2＝2），该操作的盈亏情况如图7-8所示。

图7-8　卖出蝶式套利损益

从图7-8中可以看出，卖出蝶式套利的盈亏状况与买入蝶式套利恰恰相反。这种卖出套利最大可能亏损为8美分／蒲式耳（270－260－2＝8），最大可能收益为2美分／蒲式耳（等于获得净权利金）。当期货价格小于260美分／蒲式耳或大于280美分／蒲式耳时，交易者面临一个恒定的收益2美分／蒲式耳。当期货价格在260～280美分／蒲式耳之间时，交易者的收益在-8～2美分／蒲式耳之间，其中低损益平衡点（P1）为262美分／蒲式耳（270－8＝262），高损益平衡点（P2）为278美分／蒲式耳（270＋8＝278），当期货价格为270美分时，亏损达到最大，即-8美分／蒲式耳。由此可见，这种操作适合于期货价格出现大幅度波动的情况，即使判断错误，所承担的损失也是有限的。

同理，也可以在看跌期权上进行卖出蝶式套利，其面临的盈亏状况和在看涨期权上的操作是非常相似的。

7.7　飞鹰式套利

飞鹰式套利，也叫秃鹰式套利，是指分别卖出（买进）两种不同执行价格的期权，同时分别买进（卖出）较低与较高执行价格的期权。所有的期权都有相同的类型、标的合约与到期日，执行价格的间距相等。

7.7.1　买入飞鹰式套利

买入飞鹰式套利的综合分析如表7-13所示。

表7-13　买入飞鹰套利综合分析表 

案例　买入飞鹰套利

某交易者分别买入、卖出、卖出和买入执行价格为260、270、280和290美分／蒲式耳的5月份小麦看涨期权，权利金分别为16、9、4和2美分，该策略为看涨期权上的买入飞鹰式套利，这种操作需要支付初始的净权利金为5美分（16－9－4＋2）。该策略的盈亏状况分析如图7-9所示。

图7-9　买入飞鹰套利损益

从图7-9可以看出，在看涨期权上买入飞鹰式套利的最大可能的盈利为5美分／蒲式耳（270－260－5＝5），最大可能的亏损为5美分／蒲式耳（等于净权利金）。当期货价格小于260美分／蒲式耳或大于290美分／蒲式耳时，恒定的亏损为5美分／蒲式耳。当期货价格在260～270美分／蒲式耳之间或在280～290美分／蒲式耳之间时，套利的收益在-5美分／蒲式耳至5美分／蒲式耳之间，其中265美分／蒲式耳为低损益平衡点（P1＝270－5＝265），285美分／蒲式耳为高损益平衡点（P2＝280＋5＝285）。当期货价格在270～280美分／蒲式耳之间时，恒定的收益为5美分／蒲式耳。由此可以看出，当对期货价格未来走势不明，且预计期货价格在中低执行价格和中高执行价格之间的可能性较大时，可以使用这种策略，即使判断错误，面临的亏损也是有限的。

7.7.2　卖出飞鹰式套利

卖出飞鹰式套利的综合分析如表7-14所示。

表7-14　卖出飞鹰式套利综合分析表 

案例　卖出飞鹰式套利

某交易者分别卖出、买入、买入和卖出执行价格为260、270、280和290美分／蒲式耳的5月份小麦看涨期权，权利金分别为16、9、4和2美分，该策略为看涨期权上的卖出飞鹰式套利，这种操作可以获得初始的净权利金为5美分。该策略的盈亏状况分析如图7-10所示。

图7-10　卖出飞鹰式套利损益

从图7-10中可以看出，在看涨期权上的卖出飞鹰式套利的盈亏状况与买入飞鹰式套利恰恰相反。其最大可能的亏损为5美分／蒲式耳（270－260－5＝5），最大可能的盈利为5美分／蒲式耳（等于净权利金）。当期货价格小于260美分／蒲式耳或大于290美分／蒲式耳时，恒定的收益为5美分／蒲式耳。当期货价格在260～270美分／蒲式耳之间或在280～290美分／蒲式耳之间时，套利的收益在-5～5美分／蒲式耳之间，其中，265美分／蒲式耳为低损益平衡点（P1＝270－5＝265），285美分／蒲式耳为高损益平衡点（P2＝280＋5＝285）。当期货价格在270～280美分／蒲式耳之间时，恒定的亏损为5美分／蒲式耳。由此可以看出，当对期货价格未来走势不明，且预计期货价格在低执行价格和高执行价格之外的可能性较大时，可以使用这种策略，即使判断错误，面临的亏损也是有限的。

第8章　算法交易

◆摘要◆

算法交易又称自动交易、黑盒交易或者机器交易，它指的是通过使用计算机程序来发出交易指令的方法。在交易中，程序可以决定的范围包括交易时间的选择、交易的价格，甚至包括最后需要成交的证券数量。

根据各个算法交易中算法的主动程度不同，可以把算法交易分为被动型算法交易、主动型算法交易、综合型算法交易三大类。

（1）被动型算法交易除利用历史数据估计交易模型的关键参数外，不会根据市场的状况主动选择交易的时机与交易的数量，而是按照一个既定的交易方针进行交易。该策略的核心是减少滑价（目标价与实际成交均价的差）。被动型算法交易最成熟，使用也最为广泛，如在国际市场上使用最多的成交量加权平均价格（VWAP）、时间加权平均价格（TWAP）等都属于被动型算法交易。

（2）主动型算法交易也叫机会型算法交易。这类交易算法根据市场的状况做出实时的决策，判断是否交易、交易的数量、交易的价格等。主动型交易算法除了努力减少滑价以外，把关注的重点逐渐转向了价格趋势预测上。如判断市场价格在向有不利于交易员的方向运动时，就推迟交易的进行，反之加快交易的速度。当市场价格存在较强的均值回归现象时，必须迅速抓住每一次有利于自己的偏移。

（3）综合型算法交易是前两者的结合。即包含既定的交易目标，具体实施交易的过程中也会对是否交易进行一定的判断。这类算法常见的方式是先把交易指令拆开，分布到若干个时间段内，每个时间段内具体如何交易由主动型交易算法进行判断。两者结合可以达到单独一种算法所无法达到的效果。

VWAP策略是最常用的交易策略之一，具有简单易操作等特点，基本思想就是让自己的交易量提交比例与市场成交量比例尽可能匹配，在减少对市场冲击的同时，获得市场成交均价的交易价格。

标准的VWAP策略是一种静态策略，即在交易开始之前，利用已有信息确定提交策略，交易开始之后按照此策略进行交易，而不考虑交易期间的信息。

改进型的VWAP策略的基本原理是：在市场价格高于市场均价的时候，根据市场价格的走势，不同程度地减少提交量，在保证高价位的低提交量的同时，能够防止出现价格的持续上涨而提交量过度向后聚集；在市场价格低于市场均价的时候，根据市场价格的走势，不同程度地增加提交量，在保证低价位的高提交量的同时，能够防止价格的持续走低而提交量过度提前完成。

8.1　基本概念

8.1.1　算法交易定义

算法交易又称自动交易、黑盒交易或者机器交易，它指的是通过使用计算机程序来发出交易指令的方法。在交易中，程序可以决定的范围包括交易时间的选择、交易的价格，甚至包括最后需要成交的证券数量。

算法交易最初诞生是为了将大单拆分成大量较小的交易减少对市场的冲击、降低机会成本和风险。随着相关技术的发展完善，算法交易因其优势开始被应用在更多方面的用途上。如对冲投资组合使用它来在电子新闻信息到达时实现迅速交易，而其他交易员甚至还不知道信息的存在。

1．更有效的交易

大型交易者当然希望自己买或卖的行为不被市场发现，在不会影响市场的情况下迅速成交，否则交易对象的价格将在交易完成前迅速往自己所不期望的方向变动。一次大额的交易可能导致目标证券价格数个百分点的变动，而在机构的业绩表现中，每一个百分点的差异都可能非常重要。合理地使用算法交易，可以令交易的冲击大大减小。

此外，市场上每一个大型的交易者都不会一次性把自己所有的交易指令暴露出来，因此，实际的交易机会远远多于投资者能看到公开的交易机会。算法交易投资者可以通过科学的方法发现这些交易机会，准确地完成大额交易，提高交易的效率。

2．Alpha的来源

使用算法交易的终极目标就是获得Alpha，即在与其他机构投资者机会均等的情况下，通过减少冲击成本、选择合适的交易方式，获得相对于竞争对手略高的收益率。

最初，这一Alpha基本上完全是通过削减冲击成本达到的。随着算法交易研究的深入，交易者开始尝试寻找更合适的交易时机，在某些情况下，还可以通过短时间内的高卖低买减少持有的成本。

在算法交易追求Alpha能力的进一步增强以后，甚至出现了很多对冲基金纯粹只使用算法交易，直接通过使用这种技术来获取绝对回报。

8.1.2　算法交易分类

根据各个算法交易中算法的主动程度不同，可以把不同算法交易分为被动型算法交易、主动型算法交易、综合型算法交易三大类。

1．被动型算法交易

被动型算法交易也叫结构型算法交易或者时间表型算法交易。这类交易算法除利用历史数据估计交易模型的关键参数外，不会根据市场的状况主动选择交易的时机与交易的数量，而是按照一个既定的交易方针进行交易。该策略的核心是减少滑价（目标价与实际成交均价的差）。

被动型算法交易最成熟，使用也最为广泛，如在国际市场上使用最多的成交量加权平均价格（VWAP）、时间加权平均价格（TWAP）等都属于被动型算法交易。

2．主动型算法交易

主动型算法交易也叫机会型算法交易。这类交易算法根据市场的状况做出实时的决策，判断是否交易、交易的数量、交易的价格等。由于很多交易指令是根据市场的即时状况下达，因此有可能无法完成交易员希望的全部交易。

主动型交易算法除了努力减少滑价以外，还把关注的重点逐渐转向了价格趋势预测上。如判断市场价格在向有不利于交易员的方向运动时，就推迟交易的进行，反之加快交易的速度。当市场价格存在较强的均值回归现象时，必须迅速抓住每一次有利于自己的偏移。

此外，当算法交易被广泛应用时，证券的市场价格行为就会表现出一定的规律。这样，就出现了一类特殊的算法交易，如瑞士信贷的Sniper算法，它们的目标是发现市场上与自己交易方向相反的大型交易对手，通过合适的交易安排与该对手完成交易，避免市场受到冲击。

3．综合型算法交易

综合型算法交易是前两者的结合。即包含有既定的交易目标，具体实施交易的过程中也会对是否交易进行一定的判断。

这类算法常见的方式是先把交易指令拆开，分布到若干个时间段内，每个时间段内具体如何交易由主动型交易算法进行判断。两者结合可以达到单独一种算法所无法达到的效果。

4．算法交易的选择

市场上不同机构开发了大量不同形式的算法交易，各种算法交易都有各自的特点，并不存在一种最优算法交易，算法交易的选择重点是投资者的需求。如果一个投资者希望在尽量短的时间内进行交易，则需要使用偏主动型的算法交易；如果希望交易必须全部完成，则需要使用偏被动型的算法交易。如果交易对象的流动性较差、波动性较大，则需要使用主动型算法交易，反之则适合使用被动型算法交易。

不同的投资者有不同的交易风格，例如，有些投资者希望买入的数量相当于某只股票数天的成交量等；也有各自不同的交易成本标杆，例如，指数投资组合可能希望购买的价格尽量接近收盘价；不同投资者的风险偏好也不同。此外，当在交易的过程中，如果股票的价格或者成交量发生了变化，投资者的投资意愿也可能会随之改变。这些都是影响算法交易选择的因素。

5．组合的算法交易

当投资者的交易对象是股票组合时，使用的交易方法需要做些调整。除了根据各个股票具体的情况适当安排合适的交易策略以外，还必须考虑到股票之间的相关性。

组合内部股票的相关性主要可能有两种影响：当相关性高的证券交易方向相同时（同时买入或卖出），相关性会导致时间风险增加；当相关性高的证券交易方向相反时，如果两者能够同步交易，则可以抵消相当一大部分的时间风险。

8.1.3　算法交易设计

算法交易的第一步核心工作是建立一个冲击成本模型。该模型是几乎所有交易算法的基础，比较知名的冲击成本模型如JP摩根全球交易服务部的I-Star模型等。

当使用算法交易做交易决策时，最大的风险就是时间风险，即交易不立即执行可能带来的价格风险。这是在建立算法交易模型时需要考虑的第二个非常重要的因素，通常在算法交易中，时间风险和冲击成本是不能兼得的。

被动型交易算法设计主要依赖冲击成本模型。在具有这个模型的情况下，算法的构造过程便成为了一个实现最小冲击成本与时间风险的最优化过程。最优化的目标函数可以是冲击成本与时间风险的一个线形组合，权重由投资者的偏好决定，也可以是投资者的效用函数。

如果能够加入对证券短期价格趋势的判断，则可以进一步改善算法交易的效率。趋势判断需要我们在冲击成本模型的基础上建立一个短期价格预测模型。短期价格预测的方法很多，如传统的技术分析方法、模式识别（遗传算法、神经网络等）、随机过程（隐马尔科夫模型等）等。

1．绩效标杆

判断一个交易算法是否合适，首先必须选择一个合适的业绩标杆作为比较的基准。算法交易常用的业绩标杆包括开盘价格、收盘价格、成交量加权平均价格（VWAP）、时间加权平均价格（TWAP）、实现差价（即纸面交易与实际成交均价之间的差）、到达价格等。标杆的选择一般由投资者的投资目标及投资风格决定。

2．回测与最优参数的选择

在确定比较基准以后，就可以测试不同参数的效果，选择合适的参数。

（1）先在整个历史时期各个阶段以不同的参数测试策略，判断不同参数效果的稳定性，以及结果对参数的敏感度。重点关注稳定性和敏感度随时间变化的情况，如果变动过于频繁，则不适合投入实际应用。

（2）这时就可以选择某一个特定的市场状况较为稳定的历史时期，使用同样的方法用各种不同的参数进行测试，检验不同参数的稳定性及策略效果对参数的敏感性。选择最优参数，判断的标准可以是夏普比率等。估计参数所使用的市场时间段主要根据经验判断，可以是最近的市场数据，也可以是以前出现过未来很可能出现的市场数据。

（3）根据特定市场的状况选择最优参数，进行样本外测试，确定算法交易的效果是否满意。在合乎标准的情况下，即可确定策略及最优参数。

3．证券交易仿真系统

之所以要使用算法交易，就是因为交易会对市场造成冲击。但是如果使用历史数据回测，就会面临一个难以解决的问题：我们不知道策略是否会改变市场本身，那么实际上算法交易一个核心的目的就无法达到。算法交易最合理的测试方式是实盘测试，但是这意味着巨大的资金投入及风险，一般作为初级测试并不可行。

近年来有一种的方法逐渐开始走向成熟：通过与市场仿真系统进行交易来测试系统。市场仿真系统是指通过使用计算机模拟交易者的交易行为，让模拟交易者在一个虚拟的市场中进行交易的系统。这方面最早进行研究的是美国圣塔菲研究所，他们首先创立了美国圣塔菲研究所人工股票市场（The Santa Fe Institute Artificial Stock Market, SFI-ASM），此外，中国台湾政治大学人工智能与经济研究中心的人工股票市场AIE-ASM也比较有影响力。

这些仿真市场一般可以作为一个基础平台，在此基础上，可以进一步建立符合自己要求的仿真交易市场。通过与市场方针系统进行交易，可以测试算法交易会引起市场参与者什么样的反应，从而检验算法交易的效果。在国内已经有银行及私募投资组合进行这方面的尝试，并取得了较好的效果。笔者团队开发了一个基于高频数据回测的后验平台，用于D-Alpha系统的历史回测，获得了很好的验证效果，有关该平台的说明，将在第18章中进行阐述。

8.2　被动交易算法

被动型算法交易策略假设市场是有效的。在这一假设下，无须关心市场均衡价格如何形成，也不需要尝试判断交易者的行为或试图主动影响市场，使得算法交易的设计与评价过程被大大简化了。

一般投资者都希望交易不要对市场产生太大的冲击，同时也不希望交易拖太久导致市场价格向不利的方向变动。但市场冲击是交易速度的增函数；等待风险则是交易速度的减函数。当交易执行速度较快时，等待风险很小，冲击成本很大；当交易执行慢时，冲击成本很小，等待风险很大。

算法交易的核心问题是在冲击成本与等待风险之间进行平衡。

假设需要交易的总量为X，分为n步进行，那么可以用｛xi
，1≤i≤n，Σxi
＝X｝来描述交易策略，其中，xi
代表第i步交易的数量。下文中以｛xi
｝来刻画交易策略。

算法交易的决策分为宏观和微观两个层次：宏观层次包括交易的时间、交易的风格、交易的规则等；微观层次包括限价／市价指令的选择、交易时机的决定、保证宏观决策完成的方法等。

8.2.1　冲击成本

交易形成的冲击成本可以分为两个部分：永久性冲击成本和暂时性冲击成本。其中，永久性冲击成本是由于交易造成的永久性的不利偏移，可以理解为交易者在交易过程中造成的信息泄露；暂时性冲击成本指由于市场流动性不足造成的市场价格暂时性偏离，在流动性恢复以后价格会回到原来的位置。交易冲击成本的建模也必须针对这两个部分分别进行。

1．冲击与价格变动

假设交易过程中的股票价格变动满足下面的式子：

其中，P0
是期初价格，Pj
为j时刻的价格，ΔPj
是j时刻不受我们影响的价格变动（即客观价格变动，剔除了交易者参与市场对价格的冲击）；k（xi
，i）是临时冲击成本函数，xi
为交易数量，i为交易的时间。d（i，j）是i时刻交易发生的临时冲击成本在j时刻剩下的比例。g（xi
，i）是i时刻交易xi的永久性冲击成本，这一冲击一旦形成，将长期保持下去。

可以看到，在对股票价格进行描述的等式中，剔除期初价格与客观价格变动后剩余的部分即冲击成本。在这一框架下，只要确定了k（·，·）、d（·，·）、g（·，·）这3个函数，就能够计算出冲击成本。

2．成交量预测

交易指令对市场冲击的大小最重要的未知因素是市场的流动性。市场的流动性越好，越容易消化掉发出的交易指令，使交易者对市场交易价格的影响较小。

描述市场流动性的指标很多，与交易指令直接相关的是市场的成交量。市场本身的成交量越高，交易造成的冲击就越容易被市场吸收而不会对成交价造成太大的影响。在被动型算法交易过程中，由于交易时机和交易量大小预先设定，因此如何安排交易指令将在很大程度上依赖交易期内成交量的预测。

成交量的变化有很强的自相关性，可以利用加权平均历史成交量来简单预测未来的成交量。在美国市场通常使用30日移动平均成交量作为下一交易日成交量的估计，实证显示更长时间的成交量数据对提高预测效果没有作用。日内每个时间段成交量可以通过使用过去若干交易日同一时段成交量占那一交易日总成交量比例的平均数估计。

其中，
是下一天的预期成交量比率，vij
是之前第j天同一时刻的成交量，Vj
是之前第j天的日成交量。

3．模型的实例——I-Star模型的冲击成本

市场上存在着一些经典的冲击成本模型，I-Star模型是其中影响较大的一个，I-Sta模型假设市场上发生交易的瞬时冲击成本满足：

其中，I*
表示瞬间冲击，X表示要交易的股票总数，ADV是平均日成交量，σ是年化波动率，P0
是当前价格，a1
、a2
、a3
是模型参数。这一模型类似于柯布-道格拉斯生产函数。模型参数a1
、a2
、a3
取决于股票的本身的特性及主要交易参与者的属性等。

接下来，如果假设有交易策略｛xi
｝，那么I-Star模型认为，该策略对市场产生的总冲击成本为：

其中，xj
为第j期交易的股票数，vj
是第j期除投资者外其他交易者的总交易量，b1
是临时冲击占总冲击成本的比例。不难看出，在I-Star模型中，临时冲击成本与投资者提交的成交量成正比，与市场的总交易量成反比。

8.2.2　等待风险

在进行被动型算法交易过程中，等待交易的时间风险是另一个重要影响因素。决定时间风险的因子包括：价格的波动率即价格的不确定性、流动性风险即成交量的不确定性、市场冲击成本估计的误差等，此外，它还与尚未完成交易的股票数正相关。

价格的不确定性即价格的波动率。关于股票价格波动率的预测，市场上已经有很成熟的方法，通常使用GARCH类模型进行估计。

当投资者决定推迟部分交易的时候，是因为希望后期的流动性能够吸收掉所提交的交易指令。但是未来的成交量只能预测，而预测的结果可能与估计的成交量不符，成交量的波动率同样可以使用GARCH类模型进行预测，时间风险可以用公式表示为：

其中，ri
为第i期剩余的股数，Vari
是第i期股票价格的不确定性（方差）。Vari
中包括股票价格变动的不确定性，以及冲击成本受成交量误差等不确定性影响的不确定性。

算法交易的目标就是在冲击成本与时间风险之间进行平衡，通过把两者作为目标进行最优化得到的结果就是最优策略。

1．业绩基准

当投资者投资目标不同时，选择的业绩基准也就不一样，得到的策略也就不同。例如，某些投资者希望尽可能接近以开始交易时的价格成交，而某些投资者却可能希望以尽量接近收盘价的价格成交。

如果以交易开始时的价格为策略的业绩基准，那么对应的交易成本表示为：

如果以全部指令完成后（如收盘时）的价格为业绩基准，这时不用考虑长期冲击成本而只考虑暂时性冲击成本，那么交易成本变为：

根据交易的不同需要及交易者的不同偏好，可以选择必要的业绩基准来计算成本函数。

2．交易策略的最优化目标

对交易策略进行最优化时，最直观的方法是有约束条件的最优化，在限定风险上限的情况下最小化冲击成本，优化目标为：

Min Cost,s.t.Risk≤R

或者在限定冲击成本上限的情况下最小化风险，优化目标为：

Min Risk,s.t.Cost≤C

理论上最合理的方法是把效用函数作为最大化的目标。这种方法难度在于选择什么样的效用函数，并且在使用效用函数的情况下将使最优化的过程变得较为复杂。一个具有可操作性的策略是给风险和冲击成本分别赋予一定的权重后相加，使其结果最小化。

Min Cost＋λRisk

价格改善目标是另一个比较常用的算法交易目标。该方法假设一个成本边界C*
，希望冲击成本小于目标成本的概率最大，该目标的目标函数可化简为：

通过对设定的目标函数进行最优化，就能得到对应的最优交易策略。不过交易方式的最优化过程一般比较复杂，使用的常规规划方法需要对模型进行大量的简化。一般目标函数可以用来检验根据经验设计的交易方法，此外，也可以用一些非常规的方法寻找最优交易策略，如遗传算法。

3．遗传算法

遗传算法是一种随机化的最优化方法，使用这种方法寻找最优策略的大致思路是：

（1）随机生成或人工设定一组策略，作为寻找最优策略的起点。

（2）把选择部分策略，将其两两进行组合（如两种不同策略的线性组合），作为遗传得到的新策略。

（3）选择一部分老的策略及新生成的策略，随机改变这些策略的一些成分，作为变异得到的新策略。

（4）把所有策略的结果排序，选择最好的策略构成新的策略组合。

（5）在新策略组合的基础上开始重复第（2）步，直到满足某些条件。

这一方法不一定能得到最优解，但是能够在时间与效果之间取得很好的平衡。有关遗传算法的详细描述参见10.1.6节。

8.2.3　常用被动型交易策略

市场上比较常见的被动型交易策略主要有VWAP、TWAP、PEG算法等，下面进行简单介绍。

1．交易量加权平均价格（VWAP）

交易量加权平均价格（VWAP）是使用最广泛的算法交易策略。根据英国信息服务商THE TRADE统计，2005年国际证券市场使用算法交易完成的成交量中，27％使用的是VWAP算法交易，在此之外还有24％使用的是为客户特制的VWAP算法交易变种，也就是说市场上超过一半的算法交易是使用VWAP及其衍生算法交易完成的。

VWAP算法交易的原则是每一段时间完成交易的总量占这段时间内市场总交易的比例恒定，理想的情况下，这一算法交易实现的成交价格等于一段时间内的市场成交均价。

VWAP算法交易的目的是最小化冲击成本，并不寻求最小化所有成本。理论上，在没有额外的信息，也没有针对股票价格趋势预测的情况下，VWAP是最优的算法交易策略。

VWAP微观上最好的下单策略是市价单与限价单的组合。通常VWAP交易可分为4个步骤：

（1）把一个交易日分为若干时间片，按预测每个时间片交易量占整个计划交易期总预测交易量的比例分配交易指令给每个时间片。

（2）在每个时间片的期初下达一个指定数量的限价单。

（3）如果在一段时间内交易没有被执行而且成交价远离我们的限价指令的计划价格，则调整价格重下限价单。

（4）时间片到期仍未未完成交易的，使用市价交易指令完成全部交易。

为了提高算法的效率及隐藏交易行为的效果，VWAP可以适当加入一些交易机会的判断，以及加入随机决定下单时间和数量的成分。

2．时间加权平均价格（TWAP）

时间加权平均价格（TWAP）策略与VWAP策略非常类似，不同的是，这一方法并不预测交易期内成交量的分布。TWAP算法交易把交易期划分为若干时间片以后，按每个时间片的长度权重分配该时间段内需完成的交易量，该策略其他交易程序与VWAP相同。

3．盯住盘口策略（PEG）

盯住盘口策略（PEG）每时每刻都根据市场盘口的现状下达交易指令并只下限价单，一般按照以下的步骤进行：

（1）买入时按照当前最高的买价、卖出时按照当前最低的卖价发出一定数量的限价交易指令，并等待结果。

（2）如果交易指令未完成且市场成交价格逐渐远离我们下达的指令，则撤销指令重新按现有市场情况执行第一步。

（3）如果所有限价交易指令交易完成，重复步骤（1）直至所有计划交易完成或到达交易执行的最后期限。

当指令执行的需求比较迫切时，可以不在现有的盘口，而是选择市场的买卖中间价下达交易指令，以使我们的指令能够尽早执行。

4．IS策略

对于规模较大的证券交易，如果一次性全部按市价下单，则该交易会造成巨大的市场冲击；如果分成几笔，在不同时间段内成交，投资者又面临市场价格和流动性发生不利变动的时间风险。IS策略，即是要按投资者的个人偏好，权衡优化一笔交易的市场冲击与事件风险，尽量减小最终实际成交价格与目标价之间的差距。这里目标价可以是开盘价、收盘价，或者是到达价格，即交易指令下达时的市场价格。一般来说，该类策略都允许交易人员设置买入（出）时的最高（低）容忍价格，并按照交易速度的要求选择激进、中性和保守的策略风格。

5．SOR策略

SOR，即下单路径优选策略，该策略跟欧美市场的证券交易制度的多样化有关，投资者除了可以从做市商处买卖证券外，还可以通过直接渠道在交易所交易，部分投资者也可以参与到交易所外的暗池交易，不同交易途径获得的报价和交易量都有所不同，SOR即是要通过对不同渠道实时交易数据的分析，在保证成交量的前提下寻求最优价格。

上面是算法交易上使用最为频繁的5种策略，此外还有一些机构为客户量身定制的策略，如隐身（Stealth）、游击队（Guerrilla）、狙击手（Sniper）、嗅探器（Sniffer）等。随着算法交易服务商队伍的扩张，规模较大的投资银行、经纪商每年都会投入不菲的研究经费用于开发更为迅速、满足客户个性化需求的算法，拉开与同业竞争对手的差距，而那些小机构则很难承担巨额的研发费用，转而向大机构购买算法。当前市场领先的算法交易服务提供商包括瑞士信贷的AES、TMG、盈透证券等。

8.3　VWAP算法

VWAP策略是最常用的交易策略之一，具有简单易操作等特点，基本思想就是让自己的交易量提交比例与市场成交量比例尽可能匹配，在减少对市场的冲击的同时，获得市场成交均价的交易价格。因此，VWAP策略一般不直接对交易的冲击成本建模，而是注重日内交易量分布的预测。但值得注意的是，如果订单的量很大，VWAP策略的冲击成本仍是不可忽略的。本节首先介绍标准的VWAP算法，然后在此基础上讨论一个改进后的VWAP算法。

8.3.1　标准VWAP算法

这一部分介绍标准的VWAP交易策略。一个交易策略涉及几个要素，如交易期限、交易证券（组合）、交易目标等，详情可参见前面的内容。简单起见，本节仅考虑在一个完整的交易日买入一定数量的某单一股票的VWAP策略。首先介绍日内交易量分布的概念及预测模型。

1．日内交易量分布及预测模型

日内交易量有两个非常重要的属性，第一个是总交易量，第二个是交易量的分布，其中第二个属性是VWAP算法交易策略所着重考虑的。交易量的分布是指某指定时间区间内的交易量占全天交易量的比例。影响交易量分布的因素有很多，包括市场参与者组成、宏观经济因素、投资者信心等。经验研究表明，日内交易量一般会呈现U形态，即开盘和收盘时刻交易量要明显高于交易期间的交易量。

假设交易量分布具有一定的记忆性，即每日的交易量分布之间存在一定的类似性，交易量所具有的这种记忆性是让我们利用历史数据对交易量分布进行预测的基础。

2．简单移动加权平均预测模型

该模型的基本思想就是利用交易量分布的记忆性，将每个交易日固定时间段的交易量占全天交易量的比例按照加权平均的方法前推，得到一个新的交易量分布。

首先将交易日等分为固定数量的N个区间。区间的长度不能太长也不能太短，太长的区间会使模型显得比较粗糙，而且区间操作的不确定性也会增加；太短的区间又因为噪音等因素而使得预测模型不可靠。基于上述考虑，本节的讨论中取N＝48，每个区间的长度为5分钟。

假设利用前L个交易日的历史数据来预测接下来一天的交易量分布。需要预测交易量分布的日期记为L，历史交易日按由远及近的原则分别记为t1
，…，tL
。对于日期T＝ti
，日内交易量分布为
其中uik
表示ti
天的第k个区间内的交易量占全天交易量的比例。

采用如下移动加权平均方法来预测新的交易量分布：

其中，f（i）表示对应于ti
的加权系数。

不同的加权系数体现了对历史数据的不同看法。简单移动加权平均平等对待所有的历史数据，而线性加权平均则将更多的权重放在最近的历史数据上。

如图8-1所示是利用20个交易日历史数据，线性加权平均得到的2010年1月11日的武钢股份（SH600005）的交易量分布与实际交易量分布的对比。

图8-1　移动平均预测交易量与实际交易量对比

数据来源：［曹力　2010］

计算可得二者的线性相关系数为0.52，意味着预测结果和实际结果之间具有较强的相关性，即预测有一定的作用。对其他数据进行分析可以得到类似的结果，但是相关性波动较大。这是由于影响日内交易量分布的因素太多，突然的大宗成交等无规律的行为导致了分布的异常，而这也将直接影响到标准VWAP策略的执行效果。

3．标准VWAP策略原理

标准的VWAP策略是一种静态策略，即在交易开始之前，利用已有信息确定提交策略，交易开始之后按照此策略进行交易，而不考虑交易期间的信息。

需要买入的股票数量记为V，区间的划分与预测交易量分布时一样，并假设已经通过预测技术获得了当天的交易量分布预测值
以1分钟为单位，按照预测的成交比例分配每个区间内的交易量，在区间内再平均分配。

设
为各分钟的成交价格，市场最终的成交量分布为
则执行差额定义为决策者的交易均价与市场成交均价的差，可得：

由上式可以看出，VWAP策略的好坏直接受交易量分布预测质量的影响。预测越准确，比较误差越小。但正如已经看到的那样，交易量分布预测很难做到十分精确，从而普通的VWAP策略的执行效果将很难保证。

如图8-2所示是上海机场2010年1月12日的标准VWAP策略执行效果图。从图上可以看出，标准VWAP策略基本上跟随了市场交易量加权均价，但明显比市场均价要差。

图8-2　上海机场VWAP交易算法对比

数据来源：［曹力　2010］

标准VWAP策略是一种非常简单的静态策略。它涉及的变量较少，执行比较容易，在正常情况下能够较好地跟随市场成交价格。

标准的VWAP策略虽然简单易行，但是有两个很明显的缺点：第一是它完全依赖于日内交易量分布预测，如果预测不准确，VWAP策略的执行效果将非常不确定；第二是它是一种完全静态的策略，也就是说在交易开始之前就完成了决策，在交易时间内执行策略即可，没有将市场的最新信息如价格变化、交易量变化等考虑进去，使得它不能更好地适应市场的变化，从而无法获得更好的交易价格。

8.3.2　改进型VWAP算法

这一部分将基于标准的VWAP交易策略发展一种新的交易策略，综合考虑历史数据、实时市场行情等，从而尽可能地获取等于或优于市场VWAP的成交均价。

1．策略原理

此改进策略的基本原理是：在市场价格高于市场均价的时候，根据市场价格的走势不同程度地减少提交量，在保证高价位的低提交量的同时，能够防止出现价格的持续上涨而提交量过度地向后聚集；在市场价格低于市场均价的时候，根据市场价格走势不同程度地增加提交量，在保证低价位的高提交量的同时，能够防止价格的持续走低而提交量过度地提前完成。

2．策略流程

整个策略的流程如图8-3所示。

图8-3　改进型VWAP算法

数据来源：［曹力　2010］

3．提交量处理

在说明如何进行提交量处理之前，先引入几个概念。

首先是偏差调整比例函数f（β），表示市场价格和市场均价的偏差β导致的调整比例。为了更加全面地描述不同决策者对待这种偏差的态度及相应的决策，我们提出了容忍系数ρ的概念。具体而言，设定了5个ρ值：1、2、3、4、5，每个值对应一个不同的偏差调整比例函数f（β）。

4．执行效果

现在来看上述策略的执行效果，如图8-4所示。默认的参数设置为（容忍系数ρ＝3，激进系数λ＝3和调整阈值σ＝0.002）。

图8-4　首创股份改进型VWAP算法效果

数据来源：［曹力　2010］

选择2009年12月31日的股票来测试改进型VWAP策略。由图8-4可以看出，该策略能稍微地战胜市场均价（胜出0.001278元）。

5．参数分析

容忍系数、激进系数和调整阈值对策略的效果有很大的影响。如果决策者对市场有一定的看法，并根据看法对策略参数做一定的调整，该策略将能够取得更好的结果。

从策略的设计上可以看出各个参数的大致影响。容忍系数越大，对小幅价格偏差的反应越小，交易量也越偏向交易时间的尾部；激进系数越大，在发生因价格的调整时候的反应程度越大，黄色峰值越高，而交易量也越偏向交易时间的头部；调整阈值越大，因价格涨跌幅所导致的调整次数越少，从而黄色峰值的个数也越少。

值得注意的是，如果将调整阈值设置到足够大，则从策略的设计可以看出此时的改进策略等同于标准的VWAP策略。这从侧面说明了改进型的VWAP策略比标准的VWAP策略拥有更大的灵活性，因此也能够处理更多类型的市场行情。

第9章　另类套利策略

◆摘要◆

本章介绍了4种另类套利策略，分别为封闭式基金套利、ETF套利、LOF套利和高频交易。

封闭式基金套利的根源在于折价交易。封闭式基金的长期折价是国际上普遍存在的现象，一般认为这是对投资组合代理问题、流动性问题和信息浑浊问题所要求的补偿。封闭式基金套利的基本原理是根据折价率，买入高折价基金，同时卖出低折价基金，从而实现稳健的阿尔法收益。

ETF套利是指利用ETF在一级市场和二级市场的价格差来进行套利的交易。由于ETF同时在两个市场上交易，它具有实际交易价格和资产净值双重属性。在实际交易过程中，由于供求关系等因素，两者可能会出现较大偏差，投资者可以买入便宜的一方，等待两者的靠拢，赚取中间的差价，实现ETF套利。

LOF采用交易所交易和场外代销机构申购、赎回同时进行的交易机制，这种交易机制为投资者带来了全新的套利模式——跨市场套利：当二级市场价格高于投资组合净资产的幅度超过手续费时，投资者就可以从投资组合公司申购LOF投资组合份额，再在二级市场上卖出；当二级市场价格低于投资组合净资产时，投资者就可以先在二级市场买入投资组合份额，再到投资组合公司办理赎回业务完成套利过程。

所谓高频交易，是投资银行、对冲基金和专业交易公司利用高速计算机进行程序化证券交易的投资策略的总称。高频交易主要包括流动性回扣交易、猎物算法交易、自动做市商和程序化交易等策略。

9.1　封闭式基金套利

9.1.1　基本概念

封闭式基金的根源在于折价交易，我国封闭式投资组合一度高达50％以上的折价率，使得投资组合被严重低估，这既有多年熊市的原因，也与投资者的认识误区有关。因此，在封转开的刺激下，2006年的封闭式投资组合表现抢眼。

然而随着股指期货的推出及几年牛市的推涨，50％这样的高折价率在A股市场变得遥不可及，但是封闭式基金仍然有很大的优势。由于封闭式基金的基金经理无须面对申赎压力，所以操作基金可以更加灵活，历史上业绩也比开放式基金整体表现好。图9-1是把封闭式基金等权重投资作为组合，与沪深300比较，基本上都是能够跑赢指数的，因此可以用沪深300股指期货作为对冲工具，赚取封闭式基金的Alpha收益。

图9-1　等权重封闭式基金组合净值与沪深300指数比较

9.1.2　模型策略

历史上封闭式基金的折价率一直在不断变化中。折价率＝（价格－净值）/净值，此处为了计算方便，直接用价格／净值作为折价率的度量。图9-2是封闭式基金整体折价率（每个封闭式基金折价率的简单算术平均）与沪深300指数的关系。

图9-2　封闭式基金折价率与沪深300指数的关系

折价率可以看做是情绪指标，也可以看成是对封闭式基金的估值。投资者会买入被低估的基金，卖出被高估的。用该方法简单地对历史数据进行统计，可以得到图9-3。从图9-3中可以看出，长期来看，封闭式基金Alpha策略跑赢了封闭式基金整体的净值增长。

图9-3　封闭式基金Alpha策略统计结果

9.1.3　实证案例

根据折价率高低进行投资的策略参数利用样本内数据进行优化，样本内数据为2007—2009年，把2010—2011年的数据划分为样本外。如图9-4所示是2007—2009年样本内封闭式基金投资策略的结果。根据样本内数据得到的参数用于2010年和2011年的样本外数据，如图9-5所示，得到样本外数据的收益率为11％，收益率均用沪深300指数作为对冲。

图9-4　封闭式基金Alpha策略样本内收益率

数据来源：D-Alpha量化对冲系统

图9-5　封闭式基金Alpha策略样本外收益率

数据来源：D-Alpha量化对冲系统

从图9-4和图9-5中可以看出，封闭式基金Alpha策略样本内和样本外都能获取较高收益率，由于把基金市值都用沪深300股指期货对冲，系统风险已经排除在策略之外，所以该策略的波动也比较小。Alpha策略收益来源于两个方面，一方面是封闭式基金整体的业绩是否能够跑赢沪深300指数，另一个方面是根据折价率进行投资创造的收益率。

9.2　ETF套利

9.2.1　基本概念

1．ETF套利介绍

1）什么是ETF

ETF是指交易型开放式指数基金。ETF是一种跟踪标的指数变化且在证券交易所上市交易的基金。投资人可以像买卖股票那么简单地去买卖跟踪标的指数的ETF，并使其可以获得与该指数基本相同的报酬率。ETF通常由基金管理公司管理，基金资产为一揽子股票组合，组合中的股票种类与某一特定指数（如上证50指数）包含的成分股票相同，股票数量比例与该指数的成分股构成比例一致。

ETF具有以下3种基金的优势：封闭式基金交易灵活提高流动性；开放式基金申购／赎回消除折溢价；指数基金收益稳定和操作透明性。ETF申购和赎回可以分为“现金申购／赎回”和“实物申购／赎回”两种。

2）什么是ETF套利

由于ETF同时在两个市场上交易，它具有实际交易价格和资产净值双重属性。这两者按道理来说应该是相等的，但在实际交易过程中，由于供求关系等因素，两者有可能会出现较大偏差，投资者可以买入便宜的一方，等待两者的靠拢，赚取中间的差价，实现ETF的套利。

3）一级、二级市场

一级市场是指一揽子股票与ETF申购／赎回的市场；二级市场是指直接买卖ETF或者股票。

4）ETF的净值和市价

ETF都对应于一个指数样本股所组成的一揽子股票组合。以上证50ETF为例，上证50ETF根据上证50指数的构成所建立的投资组合，套利所规定的最低买卖计量单位为100万50ETF，分别对应多少股中国联通、多少股中国石化等50只股票。申购就是用这一个揽子股票组合向基金公司交换得到100万份ETF，赎回就是拿100万份ETF向基金公司交换得到一揽子股票组合。由一揽子股票组合得到的实时市值，除以100万就得到50ETF的实时净值；而上证50ETF作为一个交易所交易的品种，最新成交价即为实时市值。

2．ETF套利原理

1）套利本质是利用ETF市价与净值的差异来套利

ETF套利原理来源于一价原则，即同一个金融产品，虽然在两个不同的市场进行交易，但其价格应该相等。ETF既可以在一级市场进行申购和赎回，又可以在二级市场进行买卖交易，这样同一个物质具有两种价格：一是一级市场上的申购／赎回价格（ETF净值）；二是二级市场上的市场价格（ETF市值）。根据一价原则，ETF这一个产品在两个市场中的价格应该相等。但在实际交易中，ETF的净资产值与其二级市场价格往往并不一致，ETF市价会高于或者低于其净资产值（溢、折价），这就给ETF投资者在一、二级市场套利提供了机会。

若ETF出现正溢价情形，我们可以通过买入ETF成分股，申购ETF，再在二级市场卖出ETF，即可获利；若ETF出现折价情形，我们可以通过在二级市场买入ETF，再赎回成一揽子股票，然后卖出这一揽子股票，以此获利。

2）ETF市价与净值差异产生的原因

ETF市价与净值差异产生的根本原因在于ETF交易市场的供求关系与一揽子股票的供求关系不对等，也就是投资者在50指数成分股和ETF之间的取舍偏好不同。从50只股票组合来说，这就是一揽子股票，对投资人来说内容直观，直接买卖股票，不存在理解困难的问题，但管理成本较高。从ETF来说，它整合了一揽子股票，市场流动性好，交易便利。当市场明显看好ETF时，买卖双方固然还是参照标的指数报价，但是买方的数量超过了卖方的数量，买方必须相互竞争才能确保成交，因此不得不报出稍高于标的指数的价格。在这种情况下，ETF的价格可能明显高于50指数，带来套利机会。

尤其是套利交易的存在，套利者在套利的过程中，由于要收集100万份的ETF份额，导致对ETF的需求增加，进一步加剧了市价与净值之间的差异。

另外，有成分股重大事件停牌等因素的影响，也会导致其市价与净值产生较大偏差。由于成分股停牌，资产净值还是以停牌前的价格计算，但由于有重大事件，复牌后的预期价格肯定有较大变化，因此会在正在交易的ETF产品中有所体现，导致了市价与净值之间的较大差异。

9.2.2　无风险套利

1．套利模式

在套利机制成立的前提下，最重要的是考虑交易成本，因为这是决定套利区间的关键因素。ETF套利交易成本包括申购赎回费、投资组合交易费用、证券交易费用（即股票佣金，因为ETF申购和赎回的对象都是一揽子股票组合，因此套利过程还涉及股票交易）。按照公开披露的信息，申购赎回费不超过0.5％，投资组合交易费用不超过0.25％，证券交易费用不超过0.4％，总的交易成本不超过1.05％。具体的套利过程分两种情况。

1）溢价套利：ETF市值＞ETF净值

假设投资者有资金Y元，选择在场内买入投资组合份额＝Y／［场内价格×（1＋0.25％）］，再将买入的投资组合份额赎回，并将一揽子股票卖出变现。赎回的一揽子股票并变现后的价值＝Y×场外价格×（1－0.5％）×（1－0.4％）/（场内价格×（1＋0.25％））。如果这次套利交易有盈利，那么套利后的价值和原始资金的比值应该大于1。根据上述两个计算式，得到：场外价格／场内价格×（1＋0.25％）/［（1－0.5％）×（1－0.4％）］＝1.0116。也就是说，如果差别超过1.16％，理论上可以进行套利。

实际上在套利活动中共涉及3个价格，即场内交易价格、场外价格（投资组合份额净值）和实际股票组合价格。投资组合的招募说明书上写明，投资组合份额净值追踪50指数，其误差范围控制在0.001。因此，在刚才的计算中，把实际股票组合价格近似为投资组合份额净值。但在实际操作中，由于股票交易的多变性，不可能做到完全按净值变现，所以还要增加变现溢价，估计在0.3％（变现溢价会随着Y的增大而增加）。因此，价格差异超过1.5％进行套利交易的风险较低。

2）折价套利：ETF市值＜ETF净值

投资策略是先买入一揽子股票，在场外申购投资组合份额，然后在场内卖出投资组合份额。计算如下：买入股票后申购的投资组合份额＝Y/（1＋0.4％）×场外价格×（1＋0.5％）；卖出投资组合份额后的资金＝Y×场内价格×（1－0.25％）/（1＋0.4％）×场外价格×（1＋0.5％）。得出：场内价格／场外价格（1＋0.4％）（1＋0.5％）/（1－0.25％）＝1.0116。同样要考虑实际股票组合价格与投资组合份额净值间的差异，也要增加溢价，估计在0.3％（溢价会随着Y的增大而增加）。因此价格差异超过1.5％，进行套利交易的风险较低。

从以上两种情况分析，一般的套利区间为（-1.5％，1.5％）。但不同的机构有不同的交易成本，只要价格差别超过机构的成本，就能进行套利。但对于资金大的机构而言，大额的股票交易带来的股票价格变动是要考虑的重要因素。

2．套利方法

对套利交易而言，短期暴利是不可能的，关键是要在长期中累积小幅盈利，从而获得稳定的高回报。ETF套利有两种方法：瞬间套利和延时套利。瞬间套利是一旦发现套利机会，立马平仓。而延时套利是发现了套利机会，建好仓后并不立马平仓获利，而是等待趋势进一步扩大之后再进行平仓，基于对走势的判断，赚取更多利润，但这也存在走势判断失误的风险。

1）瞬间套利

瞬间套利操作几乎没有风险，而且由于瞬间套利的资金使用效率非常高，机会一旦出现，收益率会非常惊人。瞬间套利目标是同时或尽可能同时买卖ETF和揽子股票；上市首日机会密集，时常有套利机会，但盈利空间有限，市场大涨大跌时更容易出现套利机会。

案例　50ETF首日套利交易

2005年2月23日，50ETF上市首日，存在很多的套利机会，如图9-6所示，操作流程如下：

图9-6　50ETF上市首日套利机会

（1）买入100万份ETF花费87.2万元，包含交易费用和冲击成本因素。

（2）立即赎回，并以立即成交的价格卖出成分股，扣除所有费用后得到87.63万元现金。

（3）一笔套利赚4300元，花费时间在10～20s。

2）延时套利

ETF套利还有一个重要的盈利模式是延时套利，通过一揽子股票申购ETF，随后延时卖出ETF，以取得T＋0的效果。这也是目前唯一可实现T＋0交易的股票类工具。

延时套利的原理是：当ETF市值大于净值时，买入ETF，赎回成分股；但在赎回一揽子股票后不立即抛出，等待股价涨到一定高点的时候再抛出股票，这样就可以实现T＋0的操作。延时套利是对T＋0高手的考验，在震荡市中或熊市反弹的时候，采用延时套利的策略收益会比较丰厚。

与瞬间套利相比，延时套利机会较多，即使在价差较小的情况下也可以操作。延时套利讲究的是策略性地非同步买卖ETF和揽子股票，对买卖时机的把握是扩大套利收益及控制套利风险最为关键的因素。如能对指数的低点判断比较准确，则可利用此策略赚钱。这种策略在市场当日波动越大，机会越多。一般来说，大盘向上波动0.5％就有操作机会，收益的高低取决于入市时机选择。关键是要严格执行交易纪律，避免T＋1操作。折溢价都可以进行T＋0操作，但是要根据折溢价情况考虑操作方向。如图9-7所示是延时套利的案例。

图9-7　ETF延时套利流程

3）事件套利

事件套利主要是指由于ETF成分股因公告、股改、配股、增发等事项而停牌，利用该成分股在此停牌期间，预估它的价格在开盘会有暴涨暴跌的可能性，从而可以进行溢价或者折价套利操作，获取套利的收益。2006年很多投资者利用这种策略赚钱，在股改基本完成后，这种套利机会越来越少了。但是当有成分股停牌期间出现重大利好或利空消息时，依然可以沿用这种套利模式，如长江电力、中国联通等。

如果一只股票属于大的利好，但是在停牌期间如何得到？通过ETF就可以将它实现。先在二级市场买入ETF，然后在一级市场赎回，把其余成分股卖掉，留下那只就可以了。在T＋0制度下还可以反复操作，想要多少成分股都可以赎回。涨停股也是这样，如果有一只股票反复涨停，想买买不到的时候就可以通过ETF实现。

如果预估成分股在停牌期间出现了重大的利空消息，那么可以进行溢价套利操作，利用ETF放空停牌的股票。具体的操作方法是：在二级市场上买入其他成分股组合和利用“允许现金替代”的标志，用现金来替代停牌的股票，然后在基金公司申购成ETF份额，之后在二级市场上卖出相应的ETF份额。

案例　ETF折价看涨套利

例如，2005年6月8日，大盘暴涨，但是中原高速出现停牌，预计在复牌后，中原高速将会出现补涨行情，这时候我们就可以通过ETF买入中原高速。

操作决策流程如下：

（1）2005年6月8日，大盘暴涨而中原高速停牌。

（2）核实中原高速公司停牌原因无重大利空。

（3）选择6月8日50ETF存在平价（或折价）时点。

（4）预期利润高于交易成本。

（5）启动50ETF折价／赎回套利，除中原高速外其他股票以T＋0卖出。

（6）中原高速复牌后补涨获利。

结果如下：

（1）当日做一笔折价套利，相当于以7.15元买入2400股中原高速。

（2）次日该股以7.85元跳空高开，上涨9.8％（开盘卖出即获利）。

（3）本策略适用于补涨概念股的操作。

9.2.3　其他套利

除此之外，还有一些其他的套利模式，主要如下。

1．与股指期货共同套利

股指期货和ETF的共同套利又称指数期货合约与现货指数之间的套利。一般来说，现货指数和指数期货合约之间存在一定的差价，而这个价差在某一个区间内是合理的，无法从中套利。但期货市场受各种因素的影响，经常造成指数期货合约偏离其合理的定价区间，这样就为套利提供了机会。当某个月份的指数期货合约超过其套利的上限或者低于其套利的下限时，就存在套利的空间。

具体来说，当指数期货合约超过套利的上限时，操作策略是：卖出指数期货合约，同时买入现货指数也就是该指数期货合约对应的ETF，等到指数期货合约和模拟现货趋于收敛时平仓，从而获得套利的收益。理论上也可以反向操作，投资者可以买入指数期货合约，同时通过融券卖出现货指数相应的ETF，待到二者趋于收敛时平仓，获取套利的收益。但是目前市场上的融券业务尚未成熟，投资者还不能从券商融券ETF卖出。

更重要的是，我国的股指期货标的指数是沪深300，但目前市场上还没有沪深300ETF，投资者若要通过此种方式套利，一种方法是通过同时买入上证180ETF和深证100ETF来部分拟合沪深300指数。这样做的问题在于无法精确拟合沪深300指数，从而使套利出现偏差，最终很有可能影响套利所得甚至出现亏损；另一种是直接在二级市场按一定的配比买入一揽子沪深300股票，这样做的问题在于成本太高，同样大大压缩了利润空间。

2．套利避税

若投资者手中原先持有的股票是某只ETF的成分股，就可以通过ETF避税。操作策略是：通过二级市场买入除投资者手中的原有持股以外的其他ETF成分股，再通过一级市场将这些从二级市场上买入的一揽子股票和投资者手中的原有持股一起兑换成ETF份额卖掉，这样反复操作，就可以实现原有持股的避税。一般情况下，通过ETF来兑出投资者手中的原始股所产生的交易成本和冲击成本远小于税收，所以此类套利模式是所有ETF套利模式中可行性最大、风险最小的。

9.3　LOF套利

9.3.1　基本概念

自2009年以来，上市开放式基金（LOF）得到迅速扩容，成为规模最大的场内基金类型。

目前，LOF的资产净值超过3000亿元，在投资策略上涵盖了指数型、股票型、混合型及投资境外市场的QDII等多种类型。其中，主动投资股票型基金和指数基金数量最多。

LOF投资组合称为“上市型开放式投资组合”，也就是上市型开放式投资组合发行结束后，投资者既可以在指定网点申购与赎回投资组合份额，也可以在交易所买卖该投资组合。不过投资者如果是在指定网点申购的投资组合份额，想要上网抛出，则需办理一定的转托管手续；同样，如果是在交易所网上买进的投资组合份额，想要在指定网点赎回，也要办理一定的转托管手续。

LOF采用交易所交易和场外代销机构申购、赎回同时进行的交易机制，这种交易机制为投资者带来了全新的套利模式——跨市场套利。

（1）当二级市场价格高于投资组合净资产的幅度超过手续费时，投资者就可以从投资组合公司申购LOF投资组合份额，然后在二级市场上卖出。

（2）如果二级市场价格低于投资组合净资产，投资者就可以先在二级市场买入投资组合份额，再到投资组合公司办理赎回业务完成套利过程。

需要注意的是，由于套利过程中进行跨系统转登记手续的时间较长，加上手续费的存在，当一、二级市场的价格差异并不明显时，套利行为可能并不能获利。

LOF与ETF的相同之处是同时具备了场外和场内的交易方式，二者同时为投资者提供了套利的可能。此外，LOF与目前的ETF不同之处在于，它增加了场内交易带来的交易灵活性。

（1）ETF本质上是指数型的开放式投资组合，是被动管理型投资组合；而LOF则是普通的开放式投资组合，增加了交易所的交易方式，它可能是指数型投资组合，也可能是主动管理型投资组合。

（2）在申购和赎回时，ETF与投资者交换的是投资组合份额和一揽子股票；而LOF则是与投资者交换现金。

（3）在一级市场上，即申购／赎回时，ETF的投资者一般是较大型的投资者，如机构投资者和规模较大的个人投资者；而LOF则没有限定。

（4）在二级市场的净值报价上，ETF每15s提供一个投资组合净值报价；而LOF则是一天提供一个投资组合净值报价。

9.3.2　模型策略

LOF投资组合套利操作给投资者提供了两种套利机会。

1．正向套利

LOF投资组合有二级市场交易价格和投资组合净值两种价格。LOF投资组合二级市场交易价格和股票二级市场交易价格一样，是投资者之间互相买卖所产生的价格。而LOF投资组合净值是投资组合管理公司利用募集资金购买股票、债券和其他金融工具后所形成的实际价值。二级市场交易价格在一天的交易时间中是连续波动的；而投资组合净值是在每天收市后，由投资组合管理公司根据当天股票和债券的收盘价计算出来的净值（一天只有一个）。

当LOF投资组合二级市场交易价格超过投资组合净值，并且这样的差价足够大过其中的交易费用时（一般申购费1.5％＋二级市场0.3％交易费用），那么正向套利机会就出现了。

正向套利的过程如下：

（1）进入资金账户，选择股票交易项目下的“场内投资组合申赎”，输入LOF投资组合代码，然后单击“申购”按钮和购买金额后，完成投资组合申购。

（2）T＋2交易日，投资组合份额将到达客户账户。也就是说，星期一申购的LOF投资组合，如中间无休息日，份额将星期三到达投资者账户。

（3）从申购（也包括认购）份额到达投资者账户的这一天开始，任何一天，只要市场价格大于净值的幅度超过套利交易费用（一般情况下，该费用＝1.5％申购费＋0.15％交易费用＝1.65％），无风险套利机会就出现了。例如，投资者以1元净值申购，二级市场价格在1.0165元以上时，如价格在1.04元，那么投资者以1.04元卖出。扣除交易费用0.0165元，投资者将获益1.04－1.0165＝0.0235元，收益率达2.35％。

2．反向套利

当LOF投资组合二级市场交易价格低于投资组合净值时（这种情况常常出现于熊市或下跌市），称为反向套利。

当LOF投资组合二级市场交易价格低于投资组合净值，并且这样的差价足够大过其中的交易费用（一般情况下，该费用＝二级市场0.15％交易费用＋赎回费用0.5％＝0.65％）时，那么反向套利机会就出现了。

反向套利的过程如下：

（1）进入资金账户，选择股票交易，像正常股票买卖交易一样，输入投资组合代码（注意：此处不进入“场内投资组合申赎”）买入即可，这个过程被称为LOF投资组合二级市场买入，和买卖封闭式投资组合一样。

（2）投资者在二级市场买入的LOF投资组合份额，在第二天（T＋1日）到达投资者账户。从这一天开始，任何一天，当LOF投资组合二级市场交易价格低于投资组合净值，并且这样的差价足够大过其中的交易费用（一般情况下为0.65％）时，那么投资者就可以在股票交易项目下的“场内投资组合申赎”赎回了。

例如，投资者第一天以1.0元在二级市场买入LOF投资组合，第二天投资者就可以赎回了，并且投资者赎回时，当天投资组合净值是1.04元，那么扣除0.0065元交易费后，投资者获益0.047元，收益率达3.35％。

9.3.3　实证案例：LOF套利

本案例以跟踪沪深300指数的嘉实沪深300和鹏华沪深300近一年来的情况为例，来说明套利过程及相关收益分析（部分LOF如嘉实300会通过行情系统发布基金管理人提供的定时计算的基金份额参考净值，即IOPV，但并不是所有的LOF都有IOPV）。

通常情况下，指数型、大规模的LOF交易相对更活跃。目前，规模最大的LOF是嘉实沪深300，资产净值超过300亿元，近半年来的日均交易额约4400万元。鹏华沪深300成立于2009年4月，当前资产净值约21亿元。从净值与价格走势来看，两只基金的价格与净值保持同步震荡。

从过去一年243个交易日的情况来看（如图9-8所示），两只LOF的折溢价率大部分时间都分布在-1％～1％之间，折价交易多于溢价交易，少数时间的折价率或溢价率大于1％。其中，嘉实300的折溢价率较小，最大溢价率为1.114％，最大折价率为-1.195％，平均折价率为-0.289％，反向套利机会较多，没有出现正向套利机会。鹏华300折溢价率比嘉实300略大，最大溢价率为1.665％，最大折价率为-1.359％，平均折价率为-0.465％，反向套利机会较多，正向套利机会出现两次。

图9-8　嘉实沪深300和鹏华沪深300LOF折价图（2009/12—2010/12）

数据来源：［贾戎莉　2010］

两只基金申购费结构略有不同，假设套利资金规模在50～100万之间，以上两只基金申购费率为1.2％，赎回费率为0.5％，场内交易佣金以单边0.1％来计算，正向套利的交易成本约为1.2％＋0.1％＝1.3％；反向套利的交易成本约为0.5％＋0.1％＝0.6％。

从折溢价率的分布来看，鹏华300的套利机会更多，这里以鹏华300为例说明LOF套利的过程。表9-1展示了两次正向套利的情况。

表9-1　鹏华300 LOF两次正向套利的情况 

数据来源：［贾戎莉　2010］

2010－5－6（T日）申购基金份额，2010－5－10（T＋2日）以收盘价卖出，套利收益-1.37％，扣除交易成本后的净收益为-2.67％。受价格下跌影响，最后的套利收益虽然为负值，但相对于同期价格跌幅和价格短线操作收益率而言，仍然挽回了一些损失。

2010－5－17（T日）申购基金份额，2010－5－19（T＋2日）以收盘价卖出，套利收益1.98％，扣除交易成本后的净收益为0.68％。这次套利扣除成本后取得了正的净收益，且大于同期价格净收益，是理想的套利结果。

两次套利效果差异的原因有两点：一是源于折溢价率的大小及变动；二是T＋2期间市场波动差异较大，从而使基金价格产生了不同的变化。

表9-2展示了4次反向套利的细节。在这4次反向套利中，扣除成本后有两次（2010－9－13和2010－10－13）取得了正的净收益，一次（2010－11－8）的理论收益为正、扣除成本后净收益为负，一次（2010－12－17）的理论收益和净收益为负。4次套利净收益都大于同期价格净收益，也是较为理想的套利结果。

表9-2　鹏华300 LOF两次反向套利的情况 

数据来源：［贾戎莉　2010］

其中，第4次反向套利受价格净值同步下跌的影响，最后的套利收益为-0.87％但相对于同期价格跌幅-0.90％和价格短线操作收益率-1.10％而言，仍然挽回了一些损失，起到了积极的作用。

套利的相关风险

由于存在T＋1或T＋2的时滞、净值波动等风险，因此，LOF的套利并不是严格意义上的无风险套利，实际上更接近于套利与短线操作相结合的模式。

由于流动性不足的问题，场内交易需要充分考虑冲击成本，选择流动性较好、规模较大的LOF作为交易对象。如果市场下跌导致套利失败，也可以转为长期持有，等待获利。

本着降低风险的原则，在同等条件下，套利策略的投资者更适宜选择被动投资的LOF基金作为套利品种，以规避非系统性风险。股指期货的推出提供了有效的系统风险对冲工具，使LOF套利的风险得以降低。

此外还需注意，LOF分红时权益登记日的溢价率是虚高的。仍以鹏华沪深300为例，2009年7月30日是分红权益登记日，当日溢价率4.784％需要考虑分红除权因素。根据基金公告，2009－7－30是场外除息日，次日（2009－7－31）才是场内除息日。所以2009－7－30的价格是含权的，而净值不含权，导致了溢价率虚高的表象。若以除权价格来计算，则溢价率就仅为0.078％了。

9.4　高频交易

所谓高频交易（High-Frequency Trading），是投资银行、对冲基金和专业交易公司利用高速计算机进行程序化证券交易的投资策略的总称，数据显示，华尔街的主要投行和对冲基金大都参与高频交易。目前，影响最大的高频交易商包括知名的Goldman Sachs、Citadel Investment Group和Renaissance Technologies。另外，一些专门从事高频交易的机构虽然市场知名度尚低，但发展迅速，目前也处于重要的地位。

综合而言，高频交易主要包括下面几种策略：流动性回扣交易（Liquidity Rebate Trading）、猎物算法交易（Predatory Algorithmic Trading）、自动做市商策略（Automated Market Makers Trading）和程序化交易（Program Trading）。

为了清晰地阐明上述高频交易策略，这里构建一个和实际交易非常吻合的案例：①一个买方机构投资者决定以30美元左右的价格购买10000股公司XYZ股票；②像共同基金、养老基金等大多数买方机构投资者一样，该买单首先被输入到其算法交易系统。而为了减小对市场价格的冲击影响，投资者的算法交易系统一般对该大额买单进行两阶段处理：首先将其分解为几十个甚至几百个小买单（一个小买单通常在100～500股之间），然后将这些小买单按某种设定的顺序投放到市场。

9.4.1　流动性回扣交易

为了争取更多的交易订单，美国所有的证券交易所都为那些创造流动性的券商提供一定的交易费用回扣，通常为0.25美分／股。不论买单还是卖单，只要交易成功，交易所即向该流动性的原始提供券商支付回扣，同时向利用该流动性进行交易的券商征收更高的费用。随着这种激励机制的日益普及，越来越多的以专门获取交易回扣为赢利目的的交易策略便应运而生了。

在本案例中，假设机构投资者的心理成交价格在30～30.05美元之间。如果交易系统中的第一个买单（如100股）配对成功，以30美元价格成交，这样，交易系统中的第二个买单（如500股）便跳显出来。再假设该买单也配对成功，以30美元价格成交。根据上述交易信息，专门从事流动性回扣策略的高频交易者的计算机系统即可能察觉到机构投资者其他后续30美元买单的存在，于是，回扣交易商计算机采取行动，报出价格为30.01美元的买单100股。毫无疑问，那些曾以30美元出售股票XYZ的券商更愿意以30.01美元的价格出售给该回扣交易商。

在交易成功之后，回扣交易商立刻调整交易方向，将刚刚以30.01美元购得的100股股票以相同价格，即30.01美元挂单卖出。由于30美元股价已不复存在，故该卖单很可能被机构投资者接受。

这样一来，尽管回扣交易商在整个交易过程中没有赢利，但由于第二个主动卖单给市场提供了流动性，从而获得了交易所提供的每股0.25美分的回扣佣金。不言而喻，回扣交易商所获得的每股0.25美分的赢利是以机构投资者多付出的1.0美分为代价的。

9.4.2　猎物算法交易

在美国，超过一半的机构投资者的算法报单遵循SEC国家最佳竞价原则（National Best Bid or Offer, NBBO）。所谓NBBO，即当客户买入证券时，券商必须保证给予市场现有的最佳卖价；同样，当客户卖出证券时，券商必须保证给予市场现有的最佳买价。根据该原则，当一个报单由于价格更为优先从而在排序上超过另一个报单时，为了能够成交第二个报单，常常调整股价并与前者保持一致。事实上，一只股票的算法报单价格常常以极快的速度相互攀比追逐，从而使该股票价格呈现出由高到低、由低到高的阶段性变动趋势。这也正是在实际交易中经常看到数量有限的100股或500股小额交易常常将股价推高或拉低十美分甚至几十美分的原因。

猎物算法交易策略即在对上述股价变动历史规律进行研究的基础上而设计的。一般而言，该策略通过制造人为的价格来诱使机构投资者提高买入价格或降低卖出价格，从而锁定交易利润。

在本案例中，假设机构投资者遵循NBBO并且心理成交价格在30～30.05美元之间。像上例中流动性回扣交易商一样，猎物算法交易商用非常相似的程序和技术来寻找其他投资者潜在的连续算法订单。在计算机确认价格为30美元的算法报单的存在后，猎物算法交易程序即发起攻击：报出价格为30.01美元的买单，从而迫使机构投资者迅速将后续买单价格调高至30.01美元；然后猎物算法交易商进一步将价格推高至30.02美元，诱使机构投资者继续追逐。

依此类推，猎物算法交易商在瞬间将价格推至机构投资者所能接受的价格上限30.05美元，并在此价格将股票卖给该机构投资者。猎物算法交易商知道30.05美元的人为价格一般难以维持，从而在价格降低时进行补仓，赚取利润。

9.4.3　自动做市商策略

众所周知，做市商的主要功能即为交易中心提供交易流动性。与普通做市商一样，自动做市商高频交易者通过向市场提供买卖订单来提高流动性。不同的是，他们通常与投资者进行反向操作。自动做市商高频交易者的高速计算机系统具有通过发出超级快速订单来发现其他投资者投资意向的能力。例如，在以极快速度发出一个买单或卖单后，如果没有被迅速成交，该订单将被马上取消；然而如果成交，系统即捕捉到大量潜在、隐藏订单存在的信息。

在本案例中，假设机构投资者向其算法交易系统发出价格在30.01～30.03美元之间的系列买单，外界无人知道。为了发现潜在订单的存在，自动做市商高频交易者的高速计算机系统开始以30.05美元的价格发出一个100股的卖单。由于价格高于投资者价格上限，因此没能引起任何反应，于是该卖单被迅速撤销。计算机又以30.04美元的价格再次探试，结果还是没能引起任何反应，于是该卖单也被迅速撤销。计算机再以30.03美元的价格继续探试，结果交易成功。基于此，计算机系统即意识到一定数量价格上限为30.03美元的隐藏买单的存在。于是，运算功能强大的该计算机系统随即发出30.01美元的买单，并利用其技术优势赶在机构投资者之前进行成交，然后再以30.03美元的价格反卖给机构投资者。

9.4.4　高频交易的发展

高频数据规模巨大，一些低频数据所不适用的统计方法在高频数据分析中也能得到很好的发挥，如分析尾部数据。在高频数据分析中，分析师可以轻易地从海量的高频数据中分析出低频小概率事件。相对于基于基本面投资研究方法，高频投资分析更偏重对市场数据信息本体的分析，以数量模型为基础，将客观的模型信号作为投资分析对象。基于高频数据的模型能充分利用市场发布的信息，为投资者描述出全息的市场状况。

高频交易的分析方法和传统低频交易有很大的区别，高频交易更关注市场微观结构的研究，探索市场价格形成的原因和达到市场价格的交易撮合过程，挖掘稀薄的利润空间。在国际市场中，参与高频交易的交易者一般包括做市商、统计套利交易者、新闻事件冲击交易者等投资人。因为高频数据的分析方法和低频数据的分析方法有很多的不同点，所以高频交易的成交速度和冲击成本都是需要格外关注的。高频交易投资者需要找到手续费低廉、流动性活跃、交易对手合适的交易品种，降低下单时的市场冲击，扩大自身的利润。在高频交易中，如果需要大资金量的投资，都需要把大单拆成小单分批入市。最初始的高频交易算法是基于时间权重（TWAP）和交易量或持仓量权重（VWAP）开发。基于时间权重开发的程序通常下单之前定义好已经拆分的小单，按照等间距时间的顺序投入市场。基于成交量开发的交易策略通常根据历史成交量形成的规律来测算交易目标在短期内的价格变动。

随着高频交易的发展，以及计算机运算速度的加快，研发重点放在了当前获取的市场价格和下单到达交易系统时价格的变化计算。交易策略把冲击影响放到了更为重要的考虑地位。为了对抗冲击，算法预定义的执行计划基于历史数据分析，并且把下的交易单切分得对市场冲击越小越好。和上面TWAP、VWAP两种交易相比，这种方法的交易单更散，并且整个下单的时间更长。当对高频交易的研究越来越精细化的时候，基于历史数据的预设下单方案渐渐被跟随市场条件自动重算下单量和下单时间计划的方法所取代。

更进一步的高频交易开始捕捉市场以外的数据。新闻量化交易开始进入高频市场，在刚刚发布最新新闻的时刻，立刻下单入市，获取新闻或其他消息对市场影响导致波动的利润。新闻量化交易非常复杂，新闻发布时往往除了有数据信息外，还有文字信息，需要快速侦听新闻或搜索新闻，计算机快速地进行自然语言理解和数据分析，根据事先建立的数据库，比对并分析出新发新闻对市场的影响方向和影响幅度，然后形成下单指令。

高频交易的方法不拘一格，甚至各种设计思路完全背离的方法都可以在高频市场上有所斩获。因为高频交易仅仅是一个时间尺度上对交易策略的分类度量，而不是交易策略本身的定义。研发新的高频交易应该从研发策略的角度入手，当新的策略交易需要在高频的条件下达到更好的赢利点的时候，就自然成为高频交易策略，所以高频交易是策略被成功研发的结果，既不是策略研发的起点也不是策略研发的终极目标，而是一个成功策略水到渠成的外在表现形式。但是高频交易策略有一些自身的特性，投资者可以围绕这些特性开发。有一些投资者利用基于Alpha的微观价格作为自己策略的买入卖出的价格参照。这些Alpha可以从趋势跟踪、均值回复、配对交易或其他预测策略里面推导出来，作为自己进入市场交易的参照。

交易速度是高频交易争夺的重要领域。进入高频交易领域的投资者需要格外地小心，犹如一条鲨鱼进入已经充满鲨鱼的池子，新进的投资者想在这池子里猎食，但也许正成为已经在池子里的鲨鱼的猎物，速度优势可以逃脱追杀者，速度优势可以帮助捕捉猎物。一个有效的高频交易策略具有活力的生命周期和高频交易的持仓一样短暂。失去活力的策略会变成衰老的鲨鱼，被其他年轻的对手绞杀。高频交易的策略竞争如此激烈，虽然有ORC、RTS、Actant之类可以帮助实现交易，但是更多的进入这个领域的投资者都是自己开发的系统。在高频交易系统的开发中，计算机算法的速度、网络速度、本机或托管服务器和交易所之间的实地距离都是考虑的范围之列。

当前中国的3个商品期货交易所和1个金融期货交易所都提供市场行情数据直接获取。以上海期货交易所为例，某期货公司上海本地提供的专线到达交易所机房前置的时间约为25～35ms。上海期货交易所的交易机房设置在期货交易所大厦和张江机房，如果租用期货公司在张江机房的托管服务器，网络延时可以进一步缩短。提供交易所接入的前置最主要的服务商包括上期技术、恒生和金仕达。从交易所报单前置到交易所撮合交易系统时间极短，并且不为投资者所控制，在活跃合约报单到达报单前置，经过交易所撮合成交，返回成交信息到报单前置一般延时在60～90ms。交易所每500ms发布一次市场价格信息。

高性能的数据库在量化交易中起到中心作用。从市场数据获取到下单完成，高性能的数据库提供了数据仓库、数据挖掘的应用、事件驱动分析等工作的保障。存储时间序列的数据库和常规的关系数据库并不完全一致，更期望使用列存储的内存数据库。无论是历史数据还是实时数据，在速度上都有很大的提升。

思考

4．风险和收益真成正比吗？

“风险越大、收益越大”这是大家耳熟能详的话，但是笔者认为这句话值得商榷。确切地说是“风险越大，收益率越大”，而收益率和收益是两个不同的概念。收益＝本金×收益率，对于最终的收益而言，本金这个变量的影响是巨大的，远远超过了收益率的影响。做过期货的读者都有经验，一般而言，期货是很难进行满仓操作的，因为一旦反向波动，就意味着出现穿仓现象，期货公司会强制平仓。出于稳健考虑，很多时候就只能使用30％、40％的仓位进行交易，这样本金的利用率大大降低了，纵然收益率很高，但是最终的绝对收益并没有想象的那么大。

下面就这个问题进行深入探讨。假定有一个策略，可以实现R的期望收益率（年），期望最大回撤为M_Rr（有关期望最大回撤的定义和计算方法见2.9节）。令P1
表示无杠杠的收益，V1
表示本金，则可以轻易得出：

就到此为止了吗？显然不是，可以以V1
作为保证金，构建一个保底的结构化产品，业绩提成为K（年），则该结构化产品的理论最大杠杆倍数为1/M_Rr。也就是说，V1
为本金，客户资金为V2
＝（1/M_Rr－1）×V1
，总资金规模为V1
＋（1/M_Rr－1）×V1
＝V1
×（1/M_Rr）。

（1）那么当策略出现最大回撤M_R的时候，该结构化产品亏损为V1
×（1/M_R）×M_R＝V1
，即刚好亏完本金，客户实现保本。

（2）当实现了R的期望收益率后，该策略的最终收益是多少呢？

令P2
为客户资金的收益，则P2
＝V2
×R＝（1/M_Rr－1）×V1
×R

业绩提成p3
＝P2
×K＝（1/M_Rr－1）×V1
×R×K

从（3）可以看出，该公式第一部分就是本金的收益率，第二部分是杠杆后的收益率。考虑杠杆后的总收益与期望最大回撤M_Rr具有负相关的关系，即期望最大回撤越小，理论上可以放大的杠杆越大，使得最终的总收益率还是放大的。

例如，有两个策略A和B，A的期望收益率是15％，最大回撤5％；B的期望收益率30％，最大回撤20％，业绩提成为20％，则可以计算出策略A和B的理论最大杠杆收益分别为：

G_R_A＝0.15＋0.15×（1/0.05－1）×0.2＝72％

G_R_B＝0.3＋0.3×（1/0.2－1）×0.2＝54％

可以看出，策略A由于最大回撤小，获得了更大的杠杆倍数，从而获得了更高的理论杠杆收益率。所以最大回撤越小，杠杆收益率越大，再一次证明了策略稳定性的重要。
理论篇

量化投资离不开理论的支持，好的理论才会有好的策略。支持量化投资的主要理论包括：人工智能、数据挖掘、小波分析、支持向量机、分形理论、随机过程及IT技术这几个方面。

人工智能是计算机科学的一个分支，它企图了解智能的实质，并生产出一种新的、能以人类智能相似的方式做出反应的智能机器，该领域的研究包括机器学习、自动推理、专家系统、模式识别、人工神经网络、遗传算法等。人工智能技术用于量化投资的主要有模式识别择时策略、数据挖掘股价预测、遗传算法新股预测等。

数据挖掘主要是研究如何从海量的数据中寻找到内在的规律性，并用该规律性指导未来的应用。数据挖掘主要有分类模型、关联规则、顺序模型、聚类模型等。数据挖掘在量化投资中的应用主要有股票聚类分析、基于关联规则的板块轮动等。

小波变换作为能随频率的变化自动调整分析窗大小的分析工具，在信号处理、计算机视觉、图像处理、语音分析与合成等众多的领域得到应用。小波变化主要内容包括连续小波变换、小波变化的离散化、多分辨分析与Mallat算法。小波分析在量化投资中的应用主要有K线小波去噪、金融时序数据预测等。

支持向量机（SVM）算法是一种学习机制，根据有限的样本信息在模型的复杂性和学习能力之间寻求最佳折中，以期获得最好的泛化能力。SVM在形式上类似于多层前向网络，但是在效率和推广性能方面优于神经网络。SVM在量化投资中的应用主要有复杂金融时序数列预测、趋势拐点预测等。

分形理论主要是研究总体与局部关系的一门学科，在生物学、地球物理学、物理学、经济学等领域都有广泛的应用。几种典型的分形包括三分康托集、Koch曲线、Julia集等。分形理论在量化投资中的应用主要有大趋势预测、汇率预测等。

随机过程是一连串随机事件动态关系的定量描述，常见的随机过程包括独立增量过程、Poison过程、维纳过程、正态过程、马尔科夫（Markov）过程等。随机过程在量化投资中的应用主要是利用马尔科夫链来对股市进行预测。

量化投资的分析和交易离不开IT技术，最相关的是数据仓库技术和编程语言。其中，编程语言使用最多的是VBA语言和C#语言。除此之外，还有很多的数据工具，主要有wind中国金融数据库、文华财经、交易开拓者等。

第10章　人工智能

◆摘要◆

人工智能（Artificial Intelligence, AI），是研究、开发用于模拟、延伸和扩展人的智能的理论、方法、技术及应用系统的一门新的技术科学。人工智能是计算机科学的一个分支，它企图了解智能的实质，并生产出一种新的、能以人类智能相似的方式做出反应的智能机器，该领域的研究包括机器学习、自动推理、专家系统、模式识别、人工神经网络、遗传算法等。

（1）机器学习是研究计算机怎样模拟或实现人类的学习行为，以获取新的知识或技能，重新组织已有的知识结构，使之不断改善自身的性能。它是人工智能的核心，是使计算机具有智能的根本途径，其应用遍及人工智能的各个领域，它主要应用于归纳、综合，而不是演绎。

（2）自动推理是按某种策略由已知判断推出另一判断的思维过程，其中已知判断是指包括已掌握的、与求解问题有关的知识及关于问题的已知事实；推理的结论是指由已知判断推出新判断；推理由程序实现，称为推理机。

（3）专家系统是一个具有大量的专门知识与经验的程序系统，它应用人工智能技术和计算机技术，根据某领域一个或多个专家提供的知识和经验，进行推理和判断，模拟人类专家的决策过程，以便解决那些需要人类专家处理的复杂问题。

（4）模式识别是指对表征事物或现象的各种形式的（数值的、文字的和逻辑关系的）信息进行处理和分析，以对事物或现象进行描述、辨认、分类和解释的过程，是信息科学和人工智能的重要组成部分。模式识别又常称为模式分类，从处理问题的性质和解决问题的方法等角度，可将模式识别分为有监督的分类和无监督的分类两种。

（5）人工神经网络又称神经网络或连接模型，它是一种模范动物神经网络行为特征，进行分布式并行信息处理的算法数学模型。这种网络依靠系统的复杂程度，通过调整内部大量节点之间相互连接的关系，从而达到处理信息的目的。

（6）遗传算法：一组随机产生的初始解，称为群体，群体中的每个个体是问题的一个解，称为染色体，这些染色体在后续迭代中不断进化，称为遗传。遗传算法主要通过交叉、变异、选择运算实现，交叉或变异运算生成下一代染色体，称为后代。染色体的好坏用适应度来衡量，根据适应度的大小从上一代和后代中选择一定数量的个体，作为下一代群体，再继续进化，这样经过若干代之后，算法收敛于最好的染色体，它很可能就是问题的最优解或次优解。

本章将介绍3类人工智能在量化投资中的应用，即模式识别短线择时、RBF人工神经网络股价预测和基于遗传算法的新股预测。

10.1　主要内容

10.1.1　机器学习

机器学习（Machine Learning）是研究计算机怎样模拟或实现人类的学习行为，以获取新的知识或技能，重新组织已有的知识结构，使之不断改善自身的性能。它是人工智能的核心，是使计算机具有智能的根本途径，其应用遍及人工智能的各个领域，它主要应用于归纳、综合，而不是演绎。

1．简介

学习能力是智能行为的一个非常重要的特征，但至今对学习的机理尚不清楚。人们曾对机器学习给出各种定义。H.A.Simon认为，学习是系统所做的适应性变化，使得系统在下一次完成同样或类似的任务时更为有效。R.s.Michalski认为，学习是构造或修改对于所经历事物的表示。从事专家系统研制的人们则认为学习是知识的获取。这些观点各有侧重，第一种观点强调学习的外部行为效果，第二种则强调学习的内部过程，而第三种主要是从知识工程的实用性角度出发的。

机器学习在人工智能的研究中处于十分重要的地位。一个不具有学习能力的智能系统难以称得上是一个真正的智能系统，但是以往的智能系统都普遍缺少学习的能力。例如，它们遇到错误时不能自我校正；不会通过经验改善自身的性能；不会自动获取和发现所需要的知识。它们的推理仅限于演绎而缺少归纳，因此至多只能够证明已存在事实、定理，而不能发现新的定理、定律和规则等，随着人工智能的深入发展，这些局限性表现得愈加突出。

正是在这种情形下，机器学习逐渐成为人工智能研究的核心之一，它的应用已遍及人工智能的各个分支，如专家系统、自动推理、自然语言理解、模式识别、计算机视觉、智能机器人等领域。其中，尤其典型的是专家系统中的知识获取瓶颈问题，人们一直在努力试图采用机器学习的方法加以克服。

机器学习的研究是根据生理学、认知科学等对人类学习机理的了解，建立人类学习过程的计算模型或认识模型，发展各种学习理论和学习方法，研究通用的学习算法并进行理论上的分析，建立面向任务的具有特定应用的学习系统。

2．机器学习系统的基本结构

外在环境向机器系统的学习部分提供某些信息，系统利用这些信息修改知识库，以增进系统执行部分完成任务的效能，执行部分根据知识库完成任务，同时把获得的信息反馈给学习部分。在具体的应用中，环境、知识库和执行部分决定了具体的工作内容，学习部分所需要解决的问题完全由上述3部分确定。

影响学习系统设计的最重要的因素是环境向系统提供的信息，或者更具体地说是信息的质量。知识库中存放的是指导执行部分动作的一般原则，但环境向学习系统提供的信息却是各种各样的。如果信息的质量比较高，与一般原则的差别比较小，则学习部分比较容易处理。如果向学习系统提供的是杂乱无章的、指导执行动作的具体信息，则学习系统需要在获得足够数据之后，删除不必要的细节，进行总结推广，形成指导动作的一般原则，放入知识库。这样学习部分的任务就比较繁重，设计起来也较为困难。

因为学习系统获得的信息往往是不完全的，所以学习系统所进行的推理并不完全是可靠的，它总结出来的规则可能正确，也可能不正确。这要通过执行效果加以检验。正确的规则能使系统的效能提高，应予保留；不正确的规则应予修改或从数据库中删除。

知识库是影响学习系统设计的第二个因素。知识的表示有多种形式，如特征向量、一阶逻辑语句、产生式规则、语义网络和框架等。这些表示方式各有其特点，在选择表示方式时要兼顾以下4个方面：表达能力强、易于推理、容易修改知识库、知识表示易于扩展。

学习系统不能在全然没有任何知识的情况下凭空获取知识，每一个学习系统都要求具有某些知识理解环境提供的信息，分析比较，做出假设，检验并修改这些假设。因此，更确切地说，学习系统是对现有知识的扩展和改进。

执行部分是整个学习系统的核心，因为执行部分的动作就是学习部分力求改进的动作。同执行部分有关的问题有：复杂性、反馈和透明性。

3．学习策略分类

学习策略是指学习过程中系统所采用的推理策略，一个学习系统总是由学习和环境两部分组成。由环境（如书本或教师）提供信息，学习部分则实现信息转换，用能够理解的形式记忆下来，并从中获取有用的信息。在学习过程中，学生（学习部分）使用的推理越少，他们对教师（环境）的依赖就越大，教师的负担也就越重。学习策略的分类标准就是根据学生实现信息转换所需的推理多少和难易程度来分类的，依从简单到复杂，从少到多的次序分为以下6种基本类型：

1）机械学习

学习者无须任何推理或其他的知识转换，直接吸取环境所提供的信息，如塞缪尔的跳棋程序，纽厄尔和西蒙的LT系统。这类学习系统主要考虑的是如何索引存储的知识并加以利用。系统的学习方法是直接通过事先编好、构造好的程序来学习，学习者不做任何工作，或者是通过直接接收既定的事实和数据进行学习，对输入信息不做任何推理。

2）示教学习

学生从环境（教师或其他信息源如教科书等）获取信息，把知识转换成内部可使用的表示形式，并将新的知识和原有知识有机地结合为一体。所以要求学生有一定程度的推理能力，但环境仍要做大量的工作。教师以某种形式提出和组织知识，以使学生拥有的知识可以不断增加。这种学习方法和人类社会的学校教学方式相似，学习的任务就是建立一个系统，使它能接受教导和建议，并有效地存储和应用学到的知识。目前，不少专家系统在建立知识库时使用这种方法去实现知识获取。

3）演绎学习

学生所用的推理形式为演绎推理。推理从公理出发，经过逻辑变换推导出结论。这种推理是保真变换和特化的过程，使学生在推理过程中可以获取有用的知识。这种学习方法包含宏操作学习、知识编辑和组块技术，演绎推理的逆过程是归纳推理。

4）类比学习

利用两个不同领域（源域、目标域）中的知识相似性，可以通过类比，从源域的知识（包括相似的特征和其他性质）推导出目标域的相应知识，从而实现学习。类比学习系统可以使一个已有的计算机应用系统转变为适应于新的领域，来完成原先没有设计的相类似的功能。

类比学习需要比上述3种学习方式更多的推理。它一般要求先从知识源（源域中检索出可用的知识，再将其转换成新的形式，用到新的状况（目标域）中去。类比学习在人类科学技术发展史上起着重要作用，许多科学发现就是通过类比得到的。例如，著名的卢瑟福类比就是通过将原子结构（目标域）同太阳系（源域）做类比，揭示了原子结构的奥秘。

5）基于解释的学习

学生根据教师提供的目标概念、该概念的一个例子、领域理论及可操作准则，首先构造一个解释来说明为什么该例子满足目标概念，然后将解释推广为目标概念的一个满足可操作准则的充分条件。著名的基于解释的学习系统有迪乔恩（G.DeJong）的GENESIS，米切尔（T.Mitchell）的LEXII和LEAP，以及明顿（S.Minton）等的PRODIGY。

6）归纳学习

归纳学习是由教师或环境提供某概念的一些实例或反例，让学生通过归纳推理得出该概念的一般描述。这种学习的推理工作量远多于示教学习和演绎学习，因为环境并不提供一般性概念描述（如公理）。从某种程度上说，归纳学习的推理量也比类比学习大，因为没有一个类似的概念可以作为源概念加以取用。归纳学习是最基本的，发展也较为成熟的学习方法，在人工智能领域中已经得到广泛的研究和应用。

10.1.2　自动推理

推理就是按某种策略由已知判断推出另一判断的思维过程，其中，已知判断是指包括已掌握的与求解问题有关的知识及关于问题的已知事实。推理的结论是指由已知判断推出新判断，推理由程序实现，称为推理机。

1．自动推理的分类

按判断推出的途径来划分，可分为演绎推理和归纳推理。

1）演绎推理

演绎推理是从全称判断推导出特称判断或单称判断的过程。演绎推理有多种形式，经常用的是三段论式，三段论式包括：

（1）大前提：已知的一般性知识或假设。

（2）小前提：关于所研究的具体情况或个别事实的判断。

（3）结论：由大前提推出的适合于小前提所示情况的新判断。

在任何情况下，由演绎推导出的结论都蕴涵在大前提的一般性知识中，只要大前提和小前提是正确的，则由它们推出的结论必然是正确的。

2）归纳推理

归纳推理是从足够多的事例中归纳出一般性结论的推理过程，是一种从个别到一般的推理。归纳推理包括完全归纳推理、不完全归纳推理。

完全归纳推理是指在进行归纳时需要考察相应事物的全部对象，并根据这些对象是否都具有某种属性，从而推出这个事物是否具有这个属性。

不完全归纳推理是指只考察了相应事物的部分对象就得出了结论，包括枚举归纳推理：若已知某类事物的有限个具体事物都具有某种属性，则可推出该类事物都具有此属性；类比推理：在两个或两类事物有许多属性都相同或相似的基础上，推出它们在其他属性上也相同或相似的一种推理。

2．自然演绎推理

自然演绎推理是指从一组已知的事实出发，直接运用命题逻辑或谓词逻辑中的推理规则推出结论的过程。

推理规则如下。

（1）P规则：在推理的任何步骤上都可引入前提，继续进行推理。

（2）T规则：推理时，如果前面步骤中有一个或多个公式永真蕴涵公式S，则可把S引入推理过程中。

①反证法：P→Q，当且仅当
即Q为P的逻辑结论，当且仅当
是不可满足的。

②假言推理：P，P→Q⇒Q，表示：由P→Q及P为真，可推出Q为真。

③拒取式推理：P→Q，﹁Q⇒﹁P，表示：由P→Q为真及Q为假，可推出P为假。

自然演绎推理优点是：定理证明过程自然，容易理解，而且它拥有丰富的推理规则，推理过程灵活，便于在它的推理规则中嵌入领域启发式知识。

其缺点是：容易产生组合爆炸，推理过程中得到的中间结论一般呈指数形式递增。

3．谓词逻辑表示法

1）谓词公式

谓词公式的一般形式：

P（x1
，x2
，…，xn
）

其中：

P——谓词符号（简称谓词）。

Xi
（i＝1，2，…，n）——参数项（简称项），项可以是常量、变量或函数。

P（x1
，x2
，…，xn
）——n元谓词公式。

谓词公式的基本组成：谓词符号、常量符号、变量符号、函数符号；这些组成之间用括号和逗号隔开，表示论域内的关系。谓词公式是谓词逻辑的基本单元，也称为原子公式。

2）连词和量词

通过引入连词和量词，可以把谓词公式（原子公式）组合为复合谓词公式。

复合谓词公式也称为逻辑语句。

①连词。自动推理中的连词系统如表10-1所示。

表10-1　自动推理中连词系统 

②量词。

●　全称量词
：符号
表示对于某个论域中的所有（任意一个）个体x，都有P（x）真值为T。

●　存在量词
：符号
表示某个论域中至少存在一个个体x，使P（x）真值为T。

若限定不允许对谓词和函数名进行量化处理，且参数项不能是谓词公式，则这样的谓词逻辑是一阶的。需要注意的是，谓词、函数名的出现位置不允许使用变量，参数项不能是谓词公式。

10.1.3　专家系统

专家系统是一个具有大量的专门知识与经验的程序系统，它应用人工智能技术和计算机技术，根据某领域一个或多个专家提供的知识和经验进行推理和判断，模拟人类专家的决策过程，以便解决那些需要人类专家处理的复杂问题。简而言之，专家系统是一种模拟人类专家解决领域问题的计算机程序系统。

专家系统是人工智能中最重要的也是最活跃的一个应用领域，它实现了人工智能从理论研究走向实际应用、从一般推理策略探讨转向运用专门知识的重大突破。20世纪60年代初，出现了运用逻辑学和模拟心理活动的一些通用问题求解程序，它们可以证明定理和进行逻辑推理。但是这些通用方法无法解决大的实际问题，很难把实际问题改造成适合于计算机解决的形式，并且对于解题所需的巨大的搜索空间也难于处理。1965年，f.a.费根鲍姆等人在总结通用问题求解系统的成功与失败经验的基础上，结合化学领域的专门知识，研制了世界上第一个专家系统Dendral，可以推断化学分子结构。

专家系统可以解决的问题一般包括解释、预测、设计、规划、监视、修理、指导和控制等。目前，专家系统已经广泛地应用于医疗诊断、语音识别、图像处理、金融决策、地质勘探、石油化工、教学、军事、计算机设计等领域。

对专家系统可以按不同的方法分类。通常，可以按应用领域、知识表示方法、控制策略、任务类型等分类。如按任务类型来划分，常见的有解释型、预测型、诊断型、调试型、维护型、规划型、设计型、监督型、控制型、教育型等。

专家系统与传统的计算机程序系统有着完全不同的体系结构，通常它由知识库、推理机、综合数据库、知识获取机制、解释机制和人机接口等几个基本的、独立的部分所组成，其中以知识库与推理机相互分离而别具特色。专家系统的体系结构随专家系统的类型、功能和规模的不同，而有所差异。如图10-1所示为专家系统的总体架构。

图10-1　专家系统结构

1．知识库

知识库包含3类知识：

（1）基于专家经验的判断性规则。

（2）用于推理、问题求解的控制性规则。

（3）用于说明问题的状态、事实和概念，以及当前条件和常识等的数据。

知识库包含多种功能模块，主要有知识查询、检索、增删、修改和扩充等。知识库通过人机接口与领域专家相沟通，实现知识的获取。

2．推理机

推理机是用于对知识库中的知识进行推理来得到结论的思维机构。推理机包括如下3种推理方式。

（1）正向推理：从原始数据和已知条件得到结论。

（2）反向推理：先提出假设的结论，然后寻找支持的证据，若证据存在，则假设成立。

（3）双向推理：运用正向推理提出假设的结论，运用反向推理来证实假设。

3．知识的表示

常用的知识表示方法为：产生式规则、框架、语义网络、过程。其中，产生式规则是专家系统最流行的表达方法。由产生式规则表示的专家系统又称为基于规则的系统或产生式系统。

产生式规则的表达方式为：

其中，E表示规则的前提条件，即证据，它可以是单独命题，也可以是复合命题；H表示规则的结论部分，即假设，也是命题；CF为规则的强度，反映如果前提为真时，规则对结论的影响程度。

4．专家系统建立步骤

1）知识库的设计

（1）确定知识类型：叙述性知识、过程性知识、控制性知识。

（2）确定知识表达方法。

（3）知识库管理系统的设计：实现规则的保存、编辑、删除、增加、搜索等功能。

2）推理机的设计

（1）选择推理方式。

（2）选择推理算法：选择各种搜索算法，如深度优先搜索、广度优先搜索、启发式优先搜索等。

3）人—机接口的设计

（1）设计“用户—专家系统接口”：用于咨询理解和结论解释。

（2）设计“专家—专家系统接口”：用于知识库扩充及系统维护。

早期的专家系统采用通用的程序设计语言（如Fortran、Pascal、Basic等）和人工智能语言（如Lisp、Prolog、Smalltalk等），通过人工智能专家与领域专家的合作，直接编程来实现的。其研制周期长、难度大，但灵活实用，至今尚为人工智能专家所使用。大部分专家系统研制工作已采用专家系统开发环境或专家系统开发工具来实现，领域专家可以选用合适的工具开发自己的专家系统，大大缩短了专家系统的研制周期，从而为专家系统在各领域的广泛应用提供条件。

10.1.4　模式识别

模式识别（Pattern Recognition）是指对表征事物或现象的各种形式的（数值的、文字的和逻辑关系的）信息进行处理和分析，以对事物或现象进行描述、辨认、分类和解释的过程，是信息科学和人工智能的重要组成部分。

模式识别又称为模式分类，从处理问题的性质和解决问题的方法等角度可将模式识别分为有监督的分类和无监督的分类两种。二者的主要差别在于，各实验样本所属的类别是否预先已知。一般来说，有监督的分类往往需要提供大量已知类别的样本，但在实际问题中，这是存在一定困难的，因此研究无监督的分类就变得十分有必要了。

模式识别研究主要集中在两方面：一是研究生物体（包括人）是如何感知对象的，属于认识科学的范畴；二是在给定的任务下，如何用计算机实现模式识别的理论和方法。前者是生理学家、心理学家、生物学家和神经生理学家的研究内容；后者通过数学家、信息学专家和计算机科学工作者近几十年来的努力，已经取得了系统的研究成果。

应用计算机对一组事件或过程进行辨识和分类，所识别的事件或过程可以是文字、声音、图像等具体对象，也可以是状态、程度等抽象对象，这些对象与数字形式的信息相区别，称为模式信息。

模式识别所分类的类别数目由特定的识别问题决定，有时在开始时无法得知实际的类别数，需要识别系统反复观测被识别对象以后确定。

模式识别与统计学、心理学、语言学、计算机科学、生物学、控制论等都有关系。它与人工智能、图像处理的研究有交叉关系。例如，自适应或自组织的模式识别系统包含了人工智能的学习机制；人工智能研究的景物理解、自然语言理解也包含模式识别问题。又如，模式识别中的预处理和特征抽取环节应用图像处理的技术；图像处理中的图像分析也应用模式识别的技术。

1．模式识别方法

1）决策理论方法

决策理论方法又称为统计方法，是发展较早也比较成熟的一种方法。被识别对象首先数字化，变换为适于计算机处理的数字信息。一个模式常常要用很大的信息量来表示。许多模式识别系统在数字化环节之后还进行预处理，用于除去混入的干扰信息并减少某些变形和失真。随后是进行特征抽取，即从数字化后或预处理后的输入模式中抽取一组特征。

所谓特征是选定的一种度量，它对于一般的变形和失真保持不变或几乎不变，并且只含尽可能少的冗余信息。特征抽取过程将输入模式从对象空间映射到特征空间，这时，模式可用特征空间中的一个点或一个特征矢量表示。这种映射不仅压缩了信息量，而且易于分类。在决策理论方法中，特征抽取占有重要的地位，但尚无通用的理论指导，只能通过分析具体识别对象决定选取何种特征。特征抽取后可进行分类，即从特征空间再映射到决策空间，为此而引入鉴别函数，由特征矢量计算出相应的各类别的鉴别函数值，通过鉴别函数值的比较实行分类。

2）句法方法

句法方法又称结构方法或语言学方法。其基本思想是把一个模式描述为较简单的子模式的组合，子模式又可描述为更简单的子模式的组合，最终得到一个树形的结构描述，在底层的最简单的子模式称为模式基元。

在句法方法中选取基元的问题相当于在决策理论方法中选取特征的问题。通常要求所选的基元能对模式提供一个紧凑的反映其结构关系的描述，又要易于用非句法方法加以抽取，显然，基元本身不应该含有重要的结构信息。模式以一组基元和它们的组合关系来描述，称为模式描述语句，这相当于在语言中，句子和短语用词组合，词用字符组合一样。基元组合成模式的规则，由所谓语法来指定。一旦基元被鉴别，识别过程可通过句法分析进行，即分析给定的模式语句是否符合指定的语法，满足某类语法的即被分入该类。

模式识别方法的选择取决于问题的性质。如果被识别的对象极为复杂，而且包含丰富的结构信息，一般采用句法方法；被识别对象不是很复杂或不含明显的结构信息，一般采用决策理论方法。这两种方法不能截然分开，在句法方法中，基元本身就是用决策理论方法抽取的。在应用中，将这两种方法结合起来分别施加于不同的层次，常能收到较好的效果。

2．统计模式识别

统计模式识别的基本原理是：有相似性的样本在模式空间中互相接近，并形成“集团”，即物以类聚。其分析方法是根据模式所测得的特征向量Xi
＝（xi1
，xi2
，…，xid
），T＝（i＝1，2，…，N），将一个给定的模式归入C个类ω1
，ω2
，…，ωc
中，然后根据模式之间的距离函数来判别分类。其中，T表示转置；N为样本点数；d为样本特征数。

统计模式识别的主要方法有判别函数法、近邻分类法、非线性映射法、特征分析法、主因子分析法等。

在统计模式识别中，贝叶斯决策规则从理论上解决了最优分类器的设计问题，但其实施却必须首先解决更困难的概率密度估计问题。BP神经网络直接从训练样本学习，是简便有效的方法，因而获得了广泛的应用，但它是一种启发式技术，缺乏指定工程实践的坚实理论基础。统计推断理论研究所取得的突破性成果导致现代统计学习理论——VC理论的建立，该理论不仅在严格的数学基础上圆满地回答了人工神经网络中出现的理论问题，而且导出了一种新的学习方法——支持向量机（SVM）。有关SVM的内容将在第13章中阐述。

模式识别从20世纪20年代发展至今，人们的一种普遍看法是不存在对所有模式识别问题都适用的单一模型和解决识别问题的单一技术，我们现在拥有的只是一个工具袋，所要做的是结合具体问题把统计和句法的识别结合起来，把统计模式识别或句法模式识别与人工智能中的启发式搜索结合起来，把统计模式识别或句法模式识别与支持向量机的机器学习结合起来，把人工神经元网络与各种已有技术，以及人工智能中的专家系统、不确定推理方法结合起来，深入掌握各种工具的效能和应有的可能性，互相取长补短，实事求是地解决问题。

10.1.5　人工神经网络

人工神经网络（Artificial Neural Networks, ANNs），也简称为神经网络（NNs）或称为连接模型（Connectionist Model），它是一种模仿动物神经网络行为特征，进行分布式并行信息处理的算法数学模型。这种网络依靠系统的复杂程度，通过调整内部大量节点之间相互连接的关系，从而达到处理信息的目的。人工神经网络具有自学习和自适应的能力，可以通过预先提供的一批相互对应的输入／输出数据，分析掌握两者之间潜在的规律，最终根据这些规律，用新的输入数据来推算输出结果，这种学习分析的过程被称为训练。

人工神经网络中，神经元处理单元可表示不同的对象，如特征、字母、概念，或者一些有意义的抽象模式。网络中处理单元的类型分为3类：输入单元、输出单元和隐单元。输入单元接受外部世界的信号与数据；输出单元实现系统处理结果的输出；隐单元是处在输入和输出单元之间，不能由系统外部观察的单元。神经元间的连接权值反映了单元间的连接强度，信息的表示和处理体现在网络处理单元的连接关系中。

1．神经网络结构

神经网络结构如图10-2所示。

图10-2　人工神经网络结构

人工神经网络是一种非程序化、适应性、大脑风格的信息处理，其本质是通过网络的变换和动力学行为得到一种并行分布式的信息处理功能，并在不同程度和层次上模仿人脑神经系统的信息处理功能。它是涉及神经科学、思维科学、人工智能、计算机科学等多个领域的交叉学科。

人工神经网络特点：

（1）知识以分布方式存储在整个系统。

（2）具有很强的容错能力。

（3）可以逼近任意复杂的非线性系统。

（4）具有良好的自适应、联想等智能，能适应系统复杂多变的动态特性。

正是以上特点，使其在变形监测数据处理与分析上有着独特的优越性。

2．激活函数分类

激活函数主要包括阈值型、线性型和S型。

（1）阈值型激活函数。这个函数特性比较硬，表达式是非线性的。它的输入／输出关系如下：

（2）S型激活函数。它的特性比较软，输出状态取值范围为［-1，1］或［0，1］。它的输入／输出关系如下：

或者：

（3）线性型激活函数。它的输入／输出关系如下：

f（net）＝net

在神经网络中，激活函数实现处理单元的输出功能。在BP网络结构中，最常采用的是S型激活函数。

根据神经元之间连接的拓扑结构的不同，可将神经元分为分层网络和相互连接型网络。所谓分层网络，就是一个网络模型中的所有神经元按功能分层，一般分为输入层、中间层（隐含层）、输出层，各层按顺序连接。分层网络可细分为简单前向网络、反馈前向网络和层内互相连接的网络。BP网络就是一个典型的前向网络。相互连接型网络是指网络任意两个单元之间都是互相连接的。

3．人工神经元BP网络

BP网络的原理就是误差传播校正方法，即利用实际输出与期望输出之差对网络的各层连接权由后向前逐层进行校正的一种计算方法，如图10-3所示。

图10-3　BP网络结构

4．BP网络学习步骤

设网络输入为X＝（x1
，x2
，…，xn
），目标输出为D＝（d1
，d2
，…，dm
），实际输出Y＝（y1，
y2
，…，ym
）

（1）用均匀分布随机数将各权值设定一个小的随机数，作为节点间的连接权和阈值。

（2）计算网络实际输出Y。

①对于输入层节点，其输出
与输入数据xi
的关系：即

②对于隐含层节点，其输入为：

输出为：

③对于输出层节点，其输入为：

输出为：

（3）输出节点j的误差：

ej
＝dj
－yj

计算出所有节点的误差平方和：

如果E小于规定值，跳转到步骤（5），否则继续步骤（4）。

（4）调整权值。

①对于输出层与隐含层节点的权
调整为：

式中，η为训练速率，一般，η为0.01～1。

②对于隐含层与输入层节点的权
调整为：

（5）进行下一个训练样本直至每一个训练样本都满足目标输出，完成网络学习。

BP算法尚存在不足之处：

（1）网络隐含层节点个数的选取尚无理论依据，所以在应用中都是在一个范围内试验确定。

（2）学习算法收敛速度慢。

（3）由于采用梯度搜索法，难免是网络陷入局部最小，从而得不到全优解。

10.1.6　遗传算法

遗传算法（Genetic Algorithm, GA）是近年来迅速发展起来的一种全新的随机搜索与优化算法，其基本思想是基于达尔文（Darwin）的进化论和Mendel的遗传学说。

近年来，遗传算法已被成功地应用于工业设计、经济管理、交通运输等不同领域，解决了许多问题，如可靠性优化、流水车间调度、作业车间调度、机器调度、设备布局设计、图像处理及数据挖掘等。

1．基本原理

与传统搜索算法不同，遗传算法主要通过交叉、变异、选择运算实现。交叉或变异运算生成下一代染色体，称为后代。染色体的好坏用适应度来衡量，根据适应度的大小从上一代和后代中选择一定数量的个体，作为下一代群体，再继续进化，这样经过若干代之后，算法收敛于最好的染色体，它很可能就是问题的最优解或次优解，遗传算法中使用适应度这个概念来度量群体中的各个个体在优化计算中有可能到达最优解的程度。度量个体适应度的函数称为适应度函数，适应度函数的定义一般与具体求解问题有关。

2．理论与技术

1）编码问题

编码是遗传算法要解决的首要问题，常用的编码方法有二进制编码、格雷码编码、实数编码、符号编码等，针对不同的问题要采用不同的编码方法。下面介绍几种常用编码方法。

（1）二进制编码：它是遗传算法中最常用的一种编码方法。它具有下列一些优点：①编码、解码操作简单易行；②交叉、变异操作便于实现：③符合最小字符集编码原则；④便于利用模式定理对算法进行理论分析。

（2）格雷码编码：格雷码编码方法是二进制编码方法的一种变形，它是这样的一种编码方法：其连续的两个整数所对应的编码值之间只有一个码位是不相同的，其余码位都完全相同。格雷码除了具有二进制编码的优点外，还能提高遗传算法的局部搜索能力。

（3）实数编码：为了克服二进制编码在一些多维、高精度要求的连续函数优化问题上的缺点，人们提出实数编码方法，即个体的每个基因值用实数表示。实数编码方法具有提高遗传算法的精度要求和运算效率、改善遗传算法的计算复杂性等优点。

2）群体设定

遗传操作是对众多个体同时进行的，这众多个体组成了群体。在遗传算法处理流程中，继编码设计后的任务是初始群体的设定，并以此为起点一代代进化直到按某种进化停止准则终止进化过程，由此得到最后一代。关键问题是，群体规模：即群体中包括的个体数目如何确定。其中有两个需要考虑的因素：初始群体的设定；进化过程中各代的规模如何维持。作为遗传算法的控制参数之一，它对遗传算法效能的发挥有一定的影响。

（1）初始群体设定。遗传算法中初始群体中的个体是随机产生的，一般来说，初始群体的设定可采用如下的策略：①根据问题固有知识，设法把握最优解所占空间在整个问题空间的分布范围，然后在此分布范围内设定初始群体；②先随机生成一定数目的个体，然后从中挑出最好的个体加到初始群体中。这种过程不断迭代，直到初始群体中的个体数达到了预先确定的规模。

（2）群体多样性。群体规模的确定受遗传操作中选择操作的影响很大。一般而言，群体规模越大，群体中个体的多样性越高，算法陷入局部解的危险就越小。所以，从考虑群体多样性出发，群体规模应较大。但是群体规模太大会带来若干弊病：一是从计算效率着眼，群体越大，其适应值评估次数增加，所以计算量也增加，从而影响算法效能；二是群体中个体生存下来概率与其适应值成正比例，当群体中个体非常多时，少量适应值很高的个体会被选择而生存下来，但大多数个体却被淘汰，这会影响配对库的形成，从而影响交叉操作。另外，群体规模太小，会使遗传算法的搜索空间中分布范围有限，因而搜索有可能停止在未成熟阶段，引起未成熟收敛现象。显然，要避免未成熟收敛现象，必须保持群体的多样性，即群体规模不能太小。

3）适应度函数

遗传算法在进化搜索中基本上不用外部信息，仅用目标函数即适应度函数为依据。遗传算法的目标函数不受约束且定义域可以为任意集合，对目标函数的唯一要求是：针对输入值，可计算出能加以比较的非负结果。这一特点使得遗传算法应用范围很广，在具体应用中，适应度函数的设计要结合求解问题本身的要求而定，适应度函数的评估是选择操作的依据，适应度函数的设计直接影响到遗传算法的性能。

（1）原始适应度函数。它是问题求解目标的直接表示，通常采用问题的目标函数作为个体的适应值度量。而对于很多非数值优化问题，也可以将其转化为求某个目标函数的极值问题，如设计和训练神经网络时，我们可以将网络的实际输出与期望输出之差的平方和作为问题的目标函数，则原问题成为寻找一个网络使该目标函数达到最小。对于一个问题，定义原始适应度函数的方法可能不止一种，选择时要尽量反映问题本身整体的特性，而不能只追求片面的目标。

（2）标准适应度函数。它反映问题的最初求解目标，因此会出现两种情形：一是极小化情形，即原始适应值越小个体性能越好；另一种是极大化情形即原始适应度值越大个体性能越好。但遗传算法中的某些选择策略则要求适应度函数是非负的，而适应度值越大表明个体的性能越好，这时就需要将原始适应度函数做一个适当的变换以转化成标准的度量方式，即转化为极大化情形，并且适应值非负。

4）遗传操作

遗传操作是模拟生物基因遗传的操作。在遗传算法中，遗传操作的任务就是对群体的个体按照它们对环境适应的程度施加一定的操作，从而实现优胜劣汰的进化过程。遗传操作包括以下3个基本遗传算子：交叉、变异、选择，这3个遗传算子有如下特点：①这3个遗传算子的操作都是随机化操作，因此，个体向最优解的迁移也是随机的；②遗传操作的效果和上述3个遗传算子所取的操作概率、编码方法、群体大小、初始群体，以及适应度函数的设定密切相关；③3个基本遗传算子的操作方法或操作策略和个体的编码方式直接有关。

（1）交叉运算。是指对两个相互配对的染色体按某种方式相互交换其部分基因，从而形成两个新的个体。交叉运算是遗传算法区别于其他进化算法的重要特征，它决定了遗传算法的全局搜索能力，是产生新个体的主要方法。下面介绍几种常用的交叉算法。

①单点交叉：又称为简单交叉，它是指在个体编码串中随机设置一个交叉点，然后在该点相互交换两个配对个体的部分基因。

②双点交叉：它的具体操作过程是：a.在相互配对的两个个体编码串中随机设置两个交叉点；b.交换两个交叉点之间的部分基因。

（2）变异运算。是指将个体编码串中的某些基因值用其他基因值来替换，从而形成一个新的个体。遗传算法中的变异运算是产生新个体的辅助方法，但必不可少，因为它决定了遗传算法的局部搜索能力，下面介绍几种常用的变异运算方法。

①基本位变异：它是指对个体编码串以变异概率P随机指定某一位或某几位基因做变异运算。

②均匀变异：它是指分别用符合某一范围内均匀分布的随机数，以某一较小的概率来替换个体中每个基因。

③二元变异：它的操作需要两条染色体参与，两条染色体通过二元变异操作后生成两条新个体。新个体中的各个基因分别取原染色体对应基因值的同或／异或。例如：

（3）选择运算。或称复制运算，就是对群体中的个体进行优胜劣汰操作：适应度高的个体被遗传到下一代群体中的概率大，适应度低的个体被遗传到下一代群体中的概率小，它的任务就是按某种方法从父代群体中选取一些个体，遗传到下一代群体。

下面介绍几种选择方法。

①睹盘选择：又称比例选择方法，其基本思想是，各个个体被选中的概率与其适应度大小成正比。

②排序选择：该方法的主要思想是，对群体中的所有个体按其适应度大小进行排序，基于这个排序来分配各个个体被选中的概率。

③随机联赛选择：其操作思想是，从群体中任意选择一定数目的个体（称为联模），其中适应值最高的个体保存到下一代，这一过程反复执行，直到保存到下一代的个体数达到预先设定的数目为止。

根据遗传算法的基本原理，可以给出如图10-4所示的简单遗传算法的框图。

图10-4　遗传算法流程

10.2　人工智能在量化投资中的应用

10.2.1　模式识别短线择时

一般而言，对于股票较长时间的趋势判断难度很大，但对于短期趋势，投资者收集信息的方式及反映信息的方式有助于判断趋势。投资者的预期通过市场的交易价格进行体现，在非有效的市场中部分知情交易者可以提前对未来行情进行研判，依此获取超额收益。

知情交易者基于其信息优势很可能在当日的最后交易时段对第二日提前布局，所以最后交易时段价格的波动比其余时段包含了更多预期因素，更有可能预示第二日的行情演绎。挖掘这些信息我们可以进行短线择时判断，这些择时判断可开发成短线交易策略。

1．从价格波动中分解出投资者预期

最后交易时段价格的波动中蕴含了充分的投资者预期，那么，如何从最后交易时段的价格波动中分解投资者的预期呢？

这里提供两种方法：一是提取特征点，二是价格序列相似性聚类。

1）提取特征点

尽管半小时内交易数据的量比较大，通过观察不难发现，实际上这一时间段内的股票／指数价格是由少量的趋势及转折构成的。如果可以提取出几个趋势的转折点，就可以以少量的数据描述这段时间的价格行为模式。

提取的过程按照下面的步骤进行：

（1）决定需要提取的特征点数量，把开盘后一分钟的价格及开盘后半小时的价格作为初始特征点。

（2）把所有找到的特征点按顺序连接起来，构成一个简化的走势图。

（3）把简化后的走势图与原走势图比较，寻找两者之间差异最大的点，作为新的特征点。

（4）如果达到预设的特征点数量，即停止，否则从步骤（2）开始重复。

通过以上的步骤，可以只用少量的点来描述开盘半小时内的股票价格走势。下一步就是把需要判断的那一天的价格走势与之前的价格走势放在一起做模式匹配，如果发现若干天的开盘模式与我们需要判断的相同，那么再看匹配的这几个交易日的涨跌情况，把涨跌出现的频率作为今日涨跌概率的估计。

2）股价序列相似性模式识别

受相似程度预期驱动的价格序列，其波动的相似性将比较强，第二日的涨跌状态也应该比较相似。历史上N个时间序列可以根据相似性进行分类，每个类别与该类别下第二日涨跌分布可以建立关联，那些第二日行情表现为大概率上涨的类别值得关注。

对于最后交易时段，主要利用最后半小时的交易数据，数据频率为1分钟，第二日的市场表现第二日开盘后涨跌幅（收盘价／开盘价-1）来度量。

如何度量价格波动的相似性呢？

对于时间序列的相似性度量，我们在两个维度进行衡量，分别是水平偏移和相似性分量。

（1）水平偏移相似性分量：

（2）幅度相似性分量

这里主要采用价格序列相似性模式识别进行短线择时交易策略的开发，以分析这周模式识别交易的特性和未来改进的着眼点。

股价序列相似性模式识别流程如图10-5所示。

图10-5　股价序列相似性模式识别流程

2．交易策略

1）寻找适合做多的类别

股票价格序列通过相似性聚类可以区分为若干个类别，哪个类别适合做多可通过对应的第二日收益率分布进行判断。

每个类别可通过4个属性刻画，分别为平均单次损益、累积损益、类别发生概率和第二日上涨概率，其中第二日上涨概率和单次损益属性非常重要，适合做多的类别一定是大概率上涨且单次损益足于抵消交易成本的概率。

2）考虑有效类别的时效性：T－N1→T＋N2

A股市场瞬息万变，投资者预期对第二日市场的影响具有时效性，也就是说发掘的适合做多的类别不可能长久地适应市场，所以有必要与时俱进地根据最近的历史数据开发适合做多的类别，而且必须定期更新。

案例　模式识别短线择时模型

例如，用过往30个交易日的最后半小时价格序列进行聚类以发掘适合做多的类别，这些适合做多的类别在未来30个交易日内适用，30日之后必须根据最新的30个交易日时间窗重新发掘适合做多的类别。

利用沪深300指数2009年5月18日至6月30日间30个交易日的历史数据生成10个类别，每个类别下的业绩表现及胜率如表10-2所示，表中数据按支持度×胜率进行排序。

表10-2　模式识别短线择时样本数据分类 

数据来源：［曹力　2009］

在单边上扬市场中，大部分类别的业绩表现都不错，只有第3、7、10类别值得警惕，不过在单边上扬市场中，第二日的市场涨跌有可能受趋势延续的市场交易行为影响，并不一定是利好信息的体现。

第7、3、10类判空，其他类别判多，利用在2009年7月1日至2009年7月24日的数据进行判断，共18个交易日，判对13次，胜率为72.2％。

3．利用模式识别进行沪深300指数隔日择时

以2005年7月11日～2009年7月17日间的数据为基础，采用模式识别策略进行沪深300指数的隔日择时判断，以前30日生成适合做多的类别，后30个交易日研判是否适合做多，如果第二日收盘价高于9∶30的价格则表明研判做多成功，结果如图10-6所示。

图10-6　沪深300指数模式识别逐年的胜率

数据来源：［曹力　2009］

在此期间，模式识别交易的胜率为54.34％，2007年的胜率相对较高，2008年的胜率相对较低，从胜率超过50％可以看出最后半小时交易价格还是包含了一些信息的提前反映，要提高胜率还需要从其他变量（诸如货币供应量等）获取更为丰富的信息。

总的来说，主要利用股票价格序列的模式识别进行短线择时判断，从研究结论看其具有一定的短线实用价值，该模式识别主要是从价格形态相似性的角度来挖掘交易行为中所蕴含的预期，进而从中发现有利的交易机会。

知情交易者基于其信息优势很可能在当日的最后交易时段对第二日提前布局，所以最后交易时段价格的波动比其余时段包含了更多预期因素，更有可能预示第二日的行情演绎。

10.2.2　RBF神经网络股价预测

股票市场是一个复杂的非线性动态系统，而神经网络不仅具有强大的非线性映射能力，可以实现任何复杂的因果关系，而且还具有许多优良品质，如自学习、自适应和容错等特性，能够从大量的历史数据中进行聚类和学习，进而找到某些行为变化的规律。

这里的案例基于RBF网络进行股市预测的原理，利用三层神经网络对股市建立预测模型，包括网络的拓扑结构、隐节点的确定原则、样本数据的选取和预处理、初始参数的确定等问题。另外，针对股价变化极其复杂，并随着时间的推移，其内在的规律不断去旧换新的特点，在传统的RBF网络的基础上，提出了专门针对股价这一特点的自适应在线学习、在线预测算法。

1．RBF网络的结构

RBF神经网络是由Moody和Darken提出的一种神经网络模型。它模拟了人脑

中局部调整、相互覆盖接受域的神经网络结构，具有很强的生物背景和逼近任意非线性函数的能力。RBF网络是一种三层结构的前馈网络，其拓扑结构如图10-7所示。根据图中箭头所示从左到右分别为输入层、隐含层和输出层。

图10-7　RBF神经网络结构

其中，输入层节点只传递输入信号到隐含层，隐含层的基函数为非线性的，它对输入信号产生一个局部化的响应，即每一个隐含层节点有一个参数矢量称之为中心。该中心用来与网络输入矢量相比较以产生径向对称响应，仅当输入落在一个很小的指定区域中时，隐含层节点才做出有意义的非零响应，响应值在0到1之间，输入层节点。与基函数中心的距离越近，隐含层节点响应越大；输出单元是线性的，即输出单元对隐含层节点输出进行线性加权组合。

2．RBF网络学习算法

RBF网络的学习过程分为两个阶段。第一阶段，根据所有的输入样本决定隐含层各节点的径向基函数的中心值Cj
和径向基函数的宽度σj
。第二阶段，在决定好隐层j的参数后，根据样本，利用最小二乘原则求出输出层的权值wi
。有时在完成第二阶段的学习后，再根据样本信号，同时校正隐层和输出层的参数以进一步提高网络的精度

由此可见，根据给定的训练样本，快速有效地确定径向基函数的中心Cj
和输出层权值wi
是训练RBF神经网络的关键任务。事实上一旦确定了径向基函数的中心Cj
，则对于所有的训练样本而言
j
和预期输出yk
是已知的，输出权值wi
可以由最小二乘法等方法求出。因此，建立RBF神经网络的关键问题是根据给定的训练样本确定径向基函数的中心。

3．基于RBF网络的股价预测模型

案例　基于RBF网络的股价预测模型

1）数据预处理

数据预处理是模型建立首先要解决的一个问题。可以将股市看做确定性非线性动力系统，即内部的动力机制是确定的，股价的历史数据和其他信息蕴涵着可用于预测未来股价的信息。从数学上说，即存在一个函数：

P（t＋1）＝f（Pt－k
，…，Pt－k
，Xt－1
，…，Yt－m
，…，Yt
…）

其中，P表示股价，X、Y是外部变量。若只考虑股价序列的内部关系，则f可表示为如下公式：

P（t＋1）＝f（Pt－k
，…，Pt
）

预测的关键在于由样本数据构造或用适当的方法逼近这一函数。

这里通过采用以上公式的形式，对股价预测建立一个n维输入、1维输出的RBF网络模型。该模型通过历史n天的股价，预测下一天的股价，即针对已知的n＋1天股价（Pt－k
，…，Pt
，Pt=1
），将X＝（Pt－k
，…，Pt
）T
作为该RBF网络模型的输入，将S＝（Pt+1
）作为RBF网络在输入为X的情况下的期望输出。

现实数据中的股价是一个由每天的股价（可以是开盘价、收盘价或最高价等）组成的时序序列，设该时序序列为：

P＝（P1
，P2
，P3
，P4
，…，Pk
，…）

那么可以这样将其处理成本文建立的RBF模型的训练样本集：

＝｛［X1
，S1
］，［X2
，S2
］［X3
，S3
］，…｝

［Xi
，St
］＝［（pi
，pi＋1
，…，pi＋n＋1
）T
，pi＋n
］

2）动态自适应学习算法

传统的RBF网络中心的学习算法只适用于静态模式的离线学习算法，即常规算法有效的基础是事先必须获得所有可能的样本数据，不能用于动态输入模式的在线学习算法。且在学习前输入数据的中心个数（即RBF网络隐含层单元个数）要人为确定。

股价系统内部结构复杂，市场上各股票的差异大。同时，外部因素的多变性决定了股市的时变性很强，很难根据经验为常规算法确定隐含层单元个数等参数。针对上述选取RBF基函数中心方法存在的问题，这里在常规算法的基础上，提出了一种用于确定RBF网络径向基函数的动态自适应聚类算法。该算法是一种在线自适应聚类学习算法，它无须事先确定聚类数，并且完成聚类所得到的RBF网络是最优的。

其算法步骤如下：

（1）初始化聚类中心的个数h＝1，初始化聚类中心C1
，通常将其初始化为第一个训练样本。

（2）将所有样本X按最近的聚类中心分类，即如果：

其中，1≤p≤P，P为样本总数，则将样本XP
划归为类Si
。

（3）计算各类的样本均值，修改聚类中心：

式中，Nj
是样本类Sj
中的样本个数。

（4）重复步骤（2）、（3）步直到所有聚类中心满足以下公式：

式中
为第t次执行步骤（2）、（3）后第j个聚类中心的值，ε为某个预定的阈值，表示当聚类中心Xj
的变化在小于这个阈值时我们认为Xj
不再变化。

（5）计算各样本类Sj
中离中心Cj
最远的样本
和最远距离
令
如果
（λ为某个预定的阈值，值越小，该算法最后得到的中心个数越多）则增加中心个数h＝h＋1，并用样本
初始化这个新增加的中心，然后转到步骤（2），否则进入步骤（6）。

（6）将各个聚类中心赋给各RBF单元，作为RBF网络的中心。该动态学习算法，可以确保同一类中的样本的相似度在预定的程度内（两样本的距离不大于2λ），并且在满足这样条件下，中心个数最少。在实际应用中，为了减小计算次数，通常可以根据经验初始化聚类中心的个数h为某个大于1的自然数。在算法的实现中，步骤（5）的
可以在执行步骤（2）时得到并保存下来，不用再重新计算。为了使网络结构更优，还可以在执行完输出层权值的学习后，执行步骤（7）。

（7）若输出层权值wj
等于0或非常小，则删除对应的RBF网络中心Cj
。

4．模型与实证

根据以上分析设计和说明，就可以按以下步骤构造出一个用于股价预测的模型。即RBF网络股价预测模型的四大步骤：

（1）对样本数据进行预处理。

（2）用聚类算法确定RBF网络的中心。

（3）用梯度下降法对每一个训练样本多次迭代训练RBF网络的输出层权值。

（4）对股价进行实时学习式预测。

时间序列x＝｛xi
|xi
∈R，i＝1，2，…，L｝，该模型通过序列的前m个时刻的值，预测出后p个时刻的值。对数据做一种划分，以将每个样本的前m个值作为RBF神经网络的输入，后P个值作为目标输出。

本案例选取中国银行（601988）作为应用实例，以2006年7月5日至2008年8月18日共519个股票交易日的收盘价作为学习样本，预测2008年8月19日至2008年9月1日14个交易日的股票收盘价价格，

m＝5，p＝1，即某天的股票收盘价格与前5天的股市收盘价相关。为了计算方便及防止部分神经元达到过饱和状态，首先对这些样本数据归一化处理到区间［0，1］之间，采用下列公式：
经过网络训练和仿真后，网络输出Yi
再用公式：yi
＝（max（x）－min（x））Yi
＋min（x），反归一化过程还原股票价格，结果如表10-3所示。

表10-3　RBF神经网络股价预测结果 

总而言之，由于股票市场不确定因素太多，政策、庄家操控、投资者的盲目任意性等，股票价格预测的难度很大。利用径向基函数神经网络进行股票价格预测，从仿真的结果来看，对股票价格的短期预测能够取得较好的效果。

10.2.3　基于遗传算法新股预测

新股上市价格预测方法的研究具有重要的理论和实践意义。鉴于此，这里讨论一种基于遗传算法和神经网络的新股上市价格预测方法。

1．影响新股上市价格形成的要素

股票上市的定价不仅涉及自身的财务因素和流通股本占总股本的比率问题，而且与整个股票市场近期、中期和长期的投资环境息息相关。因此，本案例从上市公司情况及投资环境两个方面来构建影响新股上市价格形成的指标体系。

为了反映新股上市前上市公司的相关状况，这里提出以下6个指标：上市日总股本（万），发行股数（万）、上市流通比率、上市前一年度净资产收益率（Earning Per Share, EPS；单位：美分）、上市前一年度净资产收益率增长和当前年度净资产收益率。同时，这里采用中国大陆同类股票上市时纳斯达克综合指数在前1个月、4个月和1年这3个阶段的涨跌幅度作为金融市场短期、中期和长期投资氛围的表现。

2．神经网络模型

本案例预测新股上市价格的神经网络模型如图10-8所示。

图10-8　神经网络预测上市新股价格模型

3．采用遗传算法确定神经网络模型参数

1）种群初始化

（1）根据经验公式m＝fix「log2
n」＋1来确定神经网络隐含层的神经元个数，这里m表示隐含层的神经元个数；n表示学习样本数目；fix（x）表示取整操作。

（2）将神经网络的参数空间［L，U］分割成B个子空间，公式如下：

这里的
和
分别表示个自变量（神经网络的参数的下边界和上边界；B为设计参数；1k
表示第kth
位为1，其他位为0的n维列向量；Li
和Ui
分别表示类似于L和U的维列向量；经过本操作，最终将神经网络的参数空间［L，U］分割成［L1
，U1
］［L2
，U2
］，…，［LB
，UB
］这样B个子空间。

（3）将每个子空间进行离散化。假设自变量xi
的定义域为［li
，ui
］，根据设计参数Q1
（Q1
是奇数），将自变量量化成Q1
个水平ai1
，ai2
，…，aiQ
，具体的aij
计算公式如下：

（4）从每个子空间中挑选出M1
个染色体。首先构造正交表
此处N为神经网络参数空间的维数，M1
=
，J1
是满足条件
的最小正整数；然后从这
个组合中选取M1
个组合；最后应用这M1
个组合生成M1
个染色体。

（5）根据适应度值的优劣，从上面已产生的M1
B个潜在的染色体中，选择其中最优的个染色体为初始种群，这里的G是初始种群的大小。

2）适应度评价

对于当前种群中单个个体，也就是神经网络的一组参数，采用该神经网络的误差来度量这个个体的适应度值，本案例的适应度评价函数如下：

其中，pop表示当前种群中的单个个体（神经网络的一组参数）；YL
表示学习样本的给定输出值；
表示采用给定神经网络计算得到的学习样本的计算输出值；n表示学习样本的个数，k表示给定仿真优化问题绩效指标的个数，ωj
表示第个绩效指标的权重，YL
（i，j）表示第j个学习样本的第i个绩效指标的给定值，
表示采用给定神经网络计算得到的第i个学习样本的第j个绩效指标的计算值。

3）交叉操作

（1）按照交叉概率选择进行交叉操作的两个父代染色体。假设要进行交叉操作的两个父代个体为：

则定义它们的求解空间［lparent
，uparent
］为：

（2）将要进行交叉操作的两个父代个体的求解空间离散化。将要进行交叉操作的两个父代个体的求解空间［lparent
，uparent
］离散化成Q2
份（这里的Q2
为设计参数）。

（3）将所有自变量进行分组。为了避免在选择过程中进行大规模的种群点评估，每对父代尽可能不要产生太多的潜在子代点。鉴于此，将变量x1
，x2
，…，xN
分成F组，每一组变量将会被看成一个因素，这里的F是一个很小的设计参数。这样，相应正交表的组合数目将会减少，同时也就产生一个规模比较小的初始种群。这里，随机地生成F－1个整数k1
，k2
，…，kF－1
，假定1＜k1
＜k2
＜…＜kF－1
＜N，对于每个染色体x＝x1
，x2
，…，xN
产生以下F个因素：

（4）应用正交表从父代求解空间中选择潜在子代点。首先生成正交表
此处的Q2
是一个奇数，
J2
满足条件
的最小正整数，然后从这
个组合中选取M2
个组合，最后应用这M2
个组合生成M2
个潜在子代。

（5）从这M2
Q2
个潜在子代个体和两个父代个体中选择适应度值最好的两个个体，作为本次交叉操作的结果。

（6）如果当前已进行的交叉操作次数已达到预设值，则停止交叉操作；否则，转至步骤（1）。

4）变异操作

（1）按照变异概率随机选择一个需要进行变异操作的父代染色体。

（2）随机选择需要进行变异操作的某个基因位（自变量）。

（3）按照微摄动方法，得到变异后的子代染色体；这里的微摄动方法是指，将父代染色体中的已选基因分别微调为原来的1－2σ、1－σ、1＋σ和1＋2σ，这样就得到变异后的4个子代染色体。这里的σ为一个设计参数。

（4）从父代染色体和子代染色体中选择一个最优个体作为此次变异的结果。

（5）如果当前已进行的变异操作次数达到预设值，则停止变异操作；否则，转至步骤（1）。

4．数据实证

1）遗传算法中的参数设置

本案例中遗传算法中的具体参数设置如表10-4所示。

表10-4　遗传算法新股预测参数设置 

2）学习样本

本案例以200种纳斯达克新股上市价格的历史数据作为训练样本，来确定本文预测方法中的相关参数。

3）预测结果分析

预测结果如表10-5所示。

表10-5　遗传算法新股预测结果 

由表10-5可知，预测误差都在5％以内，平均预测误差为2.15％。从预测误差来看，本案例方法的预测结果是非常理想的。

第11章　数据挖掘

◆摘要◆

数据挖掘，习惯上又称为数据库中知识发现（KDD），也有人把数据挖掘：视为数据库中知识发现过程的一个基本步骤。知识发现过程由以下3个阶段组成：数据准备、数据挖掘、结果表达和解释。数据挖掘可以与用户或知识库交互。

数据挖掘主要有分类模型、关联模型、顺序模型、聚类模型等。

（1）分类模型的主要功能是根据金融数据的属性将数据分派到不同的组中。在实际应用过程中，分类模型可以分析分组中数据的各种属性，并找出数据的属性模型，确定哪些数据模型属于哪些组，这样我们就可以利用该模型来分析已有数据，并预测新数据将属于哪一个组。

（2）关联模型主要是描述了一组数据项目的密切度或关系。关系或规则总是用一些最小置信度级别来描述的，置信度级别度量了关联规则的强度。

（3）顺序模型主要用于分析数据中的某类与时间相关的数据，并发现某一时间段内数据的相关处理模型。

（4）聚类模型即按照某种相近程度度量方法将用户数据分成互不相同的一些分组。聚类即一系列相近数据组成的分组的集合，每一个分组中的数据相近，不同分组之间的数据相差较大。

数据挖掘的主要方法有：神经网络、决策树、联机分析处理、数据可视化等。

数据挖掘在量化投资中主要有利用聚类技术进行股市规律挖掘，以及基于关联规则的板块轮动等。

把通过对具体的个别事物进行观测所得到的具有时间和空间分布的信息称为模式，把模式所属的类别或同一类中模式的总体称为模式类。利用聚类技术进行股市规律研究，就是将股市走势分成不同的模式，从而可以进行相应的交易策略。

在股价波动的过程中，整个市场并不是经常性地普涨普跌，而是呈现出板块轮动、涨跌不一的状况。利用关联规则技术，发现股票板块的运动规律及其相互的联动关系，就可以在轮动点上进行相应的调仓，从而获得超额收益。

11.1　基本概念

近年来，数据挖掘引起了信息产业界的极大关注，其主要原因是存在大量数据，可以广泛使用，并且迫切需要将这些数据转换成有用的信息和知识。获取的信息和知识可以广泛用于各种领域，包括商务管理、生产控制、市场分析、工程设计和科学探索等。

数据挖掘利用了来自如下一些领域的思想：①来自统计学的抽样、估计和假设检验；②人工智能、模式识别和机器学习的搜索算法、建模技术和学习理论。数据挖掘也迅速地接纳了来自其他领域的思想，包括最优化、进化计算、信息论、信号处理、可视化和信息检索。与此同时，一些其他领域也起到重要的支撑作用，特别是需要数据库系统提供有效的存储、索引和查询处理支持。源于高性能（并行）计算的技术在处理海量数据集方面是很重要的。分布式技术也能帮助处理海量数据，并且当数据不能集中到一起处理时更是至关重要。

11.1.1　主要模型

1．分类模型

分类模型的主要功能是根据数据的属性将数据分派到不同的组中。在实际应用过程中，分类模型可以分析分组中数据的各种属性，并找出数据的属性模型，确定哪些数据模型属于哪些组。这样我们就可以利用该模型来分析已有数据，并预测新数据将属于哪一个组。

分类模型在量化投资中应用的实例很多，例如，我们可以将上市公司的资产质量分为好、一般和较差3种类型，并以此分析这3种类型上市公司的各种属性，特别是行业地位、盈利能力、负债情况等属性，找出决定它们分类的关键属性及相互关系，然后就可以根据这些关键属性对每一个预期的上市公司进行分析，以便决定预期该上市公司属于哪一种类型。

2．关联模型

关联模型主要描述一组数据项目的密切度或关系，关系或规则是用一些最小置信度级别来描述的，置信度级别度量了关联规则的强度。关联模型在量化投资中的一个典型例子是行业轮动分析，即通过挖掘数据派生关联规则，利用此规则可以了解投资者在股市投资的轮动行为。例如，当石油化工板块出现上涨的时候，可能会同时拉动煤炭板块上涨，因为这两个板块同属能源行业，如果石油价格上涨，则会使得煤炭的价格跟随上涨，因此会出现这两个行业具有很强的关联度，同涨同跌的现象。这样在投资活动中，如果发现石油化工板块开始上涨，则根据关联模型，可以买入煤炭板块的股票，等待该板块的股票补涨。

3．顺序模型

顺序模型主要用于分析数据中的某类与时间相关的数据，并发现某一时间段内数据的相关处理模型。例如，通过数据分析发现，某个股票的筹码在某段时间内持续集中的态势，也就是说，股东人数在不断减少，意味着股份有向大投资者集中的趋势，则在未来一段时间，可能该股票出现上涨，或者有超越大盘的表现，那么，就可以监控并跟踪这种类型的股票，并进行相应的投资交易，以在未来一段时间获得绝对收益或者超额收益。顺序模型可以看成是一种特定的关联模型，它在关联模型中增加了时间属性。

4．聚类模型

当要分析的数据缺乏描述信息，或者是无法组织成任何分类模式时，可以采用聚类模型。聚类模型是按照某种相近程度度量方法将用户数据分成互不相同的一些分组。聚类即由一系列相近数据组成的分组的集合，每一个分组中的数据相近，不同分组之间的数据相差较大。聚类模型是一种很强大的技术，其核心就是将某些明显的相近程度测量方法转换成定量测试方法。

采用聚类模型，系统可以根据部分数据发现规律，找出对全体数据的描述。例如，我们可以采用聚类模型对股票的市场表现进行分析。比如发现有一类曾经出现大幅上涨的股票，当回调30％以后，会再次出现上涨，并且这种概率非常大，那么这种聚类模型就可以用来指导实际的投资交易。

11.1.2　典型方法

针对上述应用类型，数据挖掘领域提出了多种实现方式与算法，并推出了相应的商业化软件及工具，这里仅讨论几种常见的、典型的实现方法。

1．神经网络

神经网络建立在可以自学习的数学模型的基础之上。它可以对大量复杂的数据进行分析，并可以完成对人脑或其他计算机来说极为复杂的模式抽取及趋势分析。神经网络系统由一系列类似于人脑神经元一样的处理单元组成，称之为节点。这些节点通过网络彼此互连，如果有数据输入，它们便可以进行确定数据模式的工作。

神经网络系统也存在着如下问题：首先，神经网络虽然对分类模型比较适合，但是神经网络的隐含层可以说是一个黑盒子，得出结论的因素并不十分明显。同时其输出结果也没有任何解释，这将影响结果的可信度及可接受程度。其次，神经网络需要较长的学习时间，因此当数据量很大时，性能可能会出现问题。

2．决策树

决策树是通过一系列规则对数据进行分类的过程。采用决策树，可以将数据规则可视化，其输出结果也容易理解。决策树方法精确度比较高，不像神经网络那样不易理解，同时系统也不需要长时间的构造过程，因此比较常用。然而，采用决策树方法也有其缺点，决策树方法很难基于多个变量组合发现规则，不同决策树分支之间的分裂也不平滑。

3．联机分析处理

联机分析处理（OLAP）主要通过多维的方式来对数据进行分析、查询和报表。它不同于传统的联机事物处理（OLTP）应用。OLTP应用主要用来完成用户的事务处理，如民航订票系统、银行储蓄系统等，通常要进行大量的更新操作，同时对响应时间要求比较高。而OLAP应用主要是对用户当前及历史数据进行分析，辅助领导决策。其典型的应用有对上市公司财务风险的分析与预测、公司市场营销策略的制定等，主要是进行大量的查询操作，对时间的要求不太严格。

目前常见的OLAP主要有基于多维数据库的MOLAP及基于关系数据库的ROLAP。在数据仓库应用中，OLAP应用一般是数据仓库应用的前端工具，同时OLAP工具还可以同数据挖掘工具、统计分析工具配合使用，增强决策分析功能。

4．数据可视化

数据仓库中包含大量的数据，并且充实着各种数据模型，若将如此大量的数据可视化则需要复杂的数据可视化工具。数据挖掘和数据可视化可以很好地协作。就数据可视化系统本身而言，由于数据仓库中的数据量很大，很容易使分析人员变得不知所措，数据挖掘工具可以设定通过富有成效的探索的起点并按恰当的隐喻来表示数据，为数据分析人员提供很好的帮助。

在目前量化投资领域，使用得最多的方法主要是分类模型、关联规则和聚类分析这3种，下面分别进行详细讨论。

11.2　主要内容

11.2.1　分类与预测

分类技术在量化投资的很多领域都有应用，例如，可以通过上市公司分类构造一个分类模型来对上市公司的资产质量进行风险评估，将上市公司分成不同的类别，如优质蓝筹股、成长型股、题材股等。利用数据挖掘技术，对这些不同股票的市场表现建立模型，寻找出这些不同种类上市公司的特征，这样的分类模型可以让投资者了解不同行为类别上市公司的分布特征，从而进行相应的投资操作。下面对分类流程进行简要描述：

分类技术主要分为两个过程：训练过程和分类过程。

训练：训练集→特征选取→训练→分类器。

分类：新样本→特征选取→分类→判决。

训练过程可以看做是一个学习的过程，利用一批历史数据进行训练，从而得出一个模式，保存在分类器中。分类过程可以看做是一个应用过程，用该分类器对新的数据进行分类判定，从而得出新知识，图11-1就说明了这种分类预测的流程。

图11-1　分类算法流程

1．主要方法

主要的分类方法包括：决策树、KNN法、SVM法、VSM法、Bayes法，下面对这几种方法进行简单的介绍。

1）决策树

决策树是一种典型的分类方法，首先对数据进行处理，利用归纳算法生成可读的规则和决策树，然后使用决策对新数据进行分析。本质上决策树是通过一系列规则对数据进行分类的过程。

决策树技术发现数据模式和规则的核心是归纳算法。归纳是从特殊到一般的过程，归纳推理从若干个事实中表现出的特征、特性和属性中，通过比较、总结、概括而得出一个规律性的结论。

归纳推理试图从对象的一部分或整体的特定观察中获得一个完备且正确的描述，即从特殊事实到普遍性规律的结论。归纳对于认识的发展和完善具有重要意义，人类知识的增长主要来源于归纳学习。

决策树的特点在于：①推理过程容易理解，决策推理过程可以表示成If Then形式；②推理过程完全依赖于属性变量的取值特点；③可自动忽略目标变量没有贡献的属性变量，也为判断属性变量的重要性，减少变量的数目提供参考。

2）KNN法

KNN法即K最近邻法，该方法的思路非常简单直观：如果一个样本在特征空间中的K个最相似（即特征空间中最邻近）样本中的大多数属于某一个类别，则该样本也属于这个类别。该方法在定类决策上只依据最邻近的一个或者几个样本的类别来决定待分样本所属的类别。

KNN方法虽然从原理上也依赖于极限定理，但在类别决策时，只与极少量的相邻样本有关。因此，采用这种方法可以较好地避免样本的不平衡问题。另外，由于KNN方法主要靠周围有限的邻近的样本，而不是靠判别类域的方法来确定所属类别的，因此对于类域的交叉或重叠较多的待分样本集来说，KNN方法较其他方法更为适合。

该方法的不足之处是计算量较大，因为对每一个待分类的文本都要计算它到全体已知样本的距离，才能求得它的K个最近邻点。目前常用的解决方法是事先对已知样本点进行剪辑，事先去除对分类作用不大的样本。另外还有一种Reverse KNN法，能降低KNN算法的计算复杂度，提高分类的效率。

该算法适用于样本容量比较大的类域的自动分类，而那些样本容量较小的类域采用这种算法容易产生误分。

3）SVM法

SVM法即支持向量机法，具有相对优良的性能指标，该方法是建立在统计学习理论基础上的机器学习方法。通过学习算法，SVM可以自动寻找出那些对分类有较好区分能力的支持向量，由此构造出的分类器可以最大化类与类的间隔，因而有较好的适应能力和较高的分准率，该方法只需要由各类域的边界样本的类别来决定最后的分类结果。

支持向量机算法的目的在于寻找一个超平面H（d），该超平面可以将训练集中的数据分开，且与类域边界的沿垂直于该超平面方向的距离最大，故SVM法也被称为最大边缘算法。待分样本集中的大部分样本不是支持向量，移去或者减少这些样本对分类结果没有影响，SVM法对小样本情况下的自动分类有着较好的分类结果。有关SVM的原理和方法在第13章会有详细阐述。

4）VSM法

VSM法即向量空间模型法，这是最早也是最著名的信息检索方面的数学模型。其基本思想是将文档表示为加权的特征向量：D＝D（T1
，W1
；T2
，W2
；...；Tn
，Wn
），然后通过计算文本相似度的方法来确定待分样本的类别。当文本被表示为空间向量模型的时候，文本的相似度就可以借助特征向量之间的内积来表示。

在实际应用中，VSM法一般事先依据语料库中的训练样本和分类体系建立类别向量空间。当需要对一篇待分样本进行分类时，只需要计算待分样本和每一个类别向量的相似度即内积，然后选取相似度最大的类别作为该待分样本所对应的类别。

由于VSM法中需要事先计算类别的空间向量，而该空间向量的建立又很大程度地依赖于该类别向量中所包含的特征项。根据研究发现，类别中所包含的非零特征项越多，其包含的每个特征项对于类别的表达能力越弱。因此，VSM法相对其他分类方法而言，更适合于专业文献的分类。

5）Bayes法

Bayes法是一种在已知先验概率与类条件概率的情况下的模式分类方法，待分样本的分类结果取决于各类域中样本的全体。

设训练样本集分为M类，记为C＝｛c1
，…，ci
，…，cM
｝，每类的先验概率为P（ci
），i＝1，2，…，M。当样本集非常大时，可以认为P（ci
）＝ci
类样本数／总样本数。对于一个待分样本X，其归于cj
类的类条件概率是P（X/ci
），则根据Bayes定理，可得到cj
类的后验概率P（ci
/X）：

式（2）是最大后验概率判决准则，将式（1）代入式（2），则有：

若P（x/ci
）P（ci
）＝Maxj［P（x/cj
）P（cj
）］，i＝1，2，…，M，j＝1，2，…，M，则x∈ci

这就是常用到的Bayes分类判决准则。经过长期的研究，Bayes分类方法在理论上论证得比较充分，在应用上也是非常广泛的。

Bayes方法的薄弱环节在于，实际情况下类别总体的概率分布和各类样本的概率分布函数（或密度函数）常常是不知道的，为了获得它们，就要求样本足够大。另外，Bayes法要求表达文本的主题词相互独立，这样的条件在实际文本中一般很难满足，因此该方法往往在效果上难以达到理论上的最大值。

2．决策树模型

1）原始数据表

我们来看一个数据表（如表11-1所示），假定根据历史数据，经过处理后生成了这样的数据表。其中市盈率的高中低的标准为：低（＜10），中（10～30），高（＞30）；股价的高中低标准为：低（＜20元），中（20～50元），高（＞50元）；是否小盘股的判断标准为：小盘股（流通市值＜10亿），数据的计算基准日假定为T日，归类的计算日为（T＋30）日。

表11-1　决策树数据表 

下面来看第一条记录（低，高，否，中性，不涨），其意思是：有某个股票，在T日时的数据是：市盈率为低，股价为高，非小盘股，分析师评级为中性，该股票在30天后没有出现上涨。

我们的问题是：根据该表中的数据，能够构建一个模型，将那些“上涨”股票的特征提取出来，并且对于一个新的股票记录，能否判断该股票在未来30天是否上涨？

2）决策树

如图11-2所示为通过某种算法得出的决策树。决策树的基本组成部分有：决策节点、分支和叶子。

图11-2　决策树示例

决策树中最上面的节点称为根节点，是整个决策树的开始。每个分支是一个新的决策节点，或者是树的叶子。每个决策节点代表一个问题或者决策，通常对应待分类对象的属性。每个叶节点代表一种可能的分类结果。

在沿着决策树从上到下的遍历过程中，在每个节点都有一个测试。对每个节点上问题的不同测试输出导致不同的分支，最后会达到一个叶子节点。这一过程就是利用决策树进行分类的过程，利用若干个变量来判断属性的类别。

例如，在该决策树中，最左边的路径为市盈率：低；小盘股：是；涨。这么一条路径表达的意思是：如果有一个股票，它的市盈率为低，并且是小盘股，则该股票在未来30天后会出现上涨。

生成这样的一棵决策树的算法很多，如最著名的ID3算法、CLS算法等。出于篇幅的原因，本书不进行算法的深入研究，这里只是简单介绍一下算法过程，感兴趣的读者可以去查阅相关的数据挖掘的算法书。

3）生成算法

CLS算法是早期的决策树学习算法，它是许多决策树学习算法的基础。

CLS基本思想：从一棵空决策树开始，选择某一属性（分类属性）作为测试属性。该测试属性对应决策树中的决策节点，根据该属性的值的不同，可将训练样本分成相应的子集，如果该子集为空，或该子集中的样本属于同一个类，则该子集为叶节点，否则该子集对应于决策树的内部节点，即测试节点，需要选择一个新的分类属性对该子集进行划分，直到所有的子集都为空或者属于同一类。

算法过程如下：

（1）生成一棵空决策树和一张训练样本属性集。

（2）若训练样本集T中所有的样本都属于同一类，跳转到步骤（3）则生成节点T，并终止学习算法；否则跳转到步骤（3）。

（3）根据某种策略从训练样本属性表中选择属性A作为测试属性，生成测试节点A。

（4）若A的取值为v1
，v2
，…，vm
，则根据A的取值的不同，将T划分成m个子集T1
，T2
，…，Tm
。

（5）从训练样本属性表中删除属性A。

（6）跳转到步骤（2），对每个子集递归调用CLS。

在步骤（3）中，根据某种策略从训练样本属性表中选择属性A作为测试属性，并没有规定采用何种测试属性。实践表明，测试属性集的组成及测试属性的先后对决策树的学习有着举足轻重的影响。

11.2.2　关联规则

关联规则是形如X→Y的蕴涵式，其中，X和Y分别称为关联规则的先导和后继。

1．基本概念

1）什么是关联规则

在描述有关关联规则的一些细节之前，先来看一个有趣的故事：“尿布与啤酒”。在一家超市里，有一个有趣的现象：尿布和啤酒赫然摆在一起出售。但是这个奇怪的举措却使尿布和啤酒的销量双双增加了。这不是一个笑话，而是发生在美国沃尔玛连锁店超市的真实案例，并一直为商家所津津乐道。

沃尔玛拥有世界上最大的数据仓库系统，为了能够准确了解顾客在其门店的购买习惯，沃尔玛对其顾客的购物行为进行了购物篮分析，想知道顾客经常一起购买的商品有哪些。沃尔玛数据仓库里集中了其各门店的详细原始交易数据，在这些原始交易数据的基础上，沃尔玛利用数据挖掘方法对这些数据了进行分析和挖掘。

一个意外的发现是：“跟尿布一起购买最多的商品竟是啤酒”。经过大量实际调查和分析，揭示了隐藏在“尿布与啤酒”背后的美国人的一种行为模式：在美国，一些年轻的父亲下班后经常要到超市去买婴儿尿布，而他们中有30％～40％的人同时也为自己买一些啤酒。产生这一现象的原因是：美国的太太们常叮嘱她们的丈夫下班后为小孩买尿布，而丈夫们在买尿布后又随手带回了他们喜欢的啤酒。

按常规思维，尿布与啤酒风马牛不相及，若不是借助数据挖掘技术对海量交易数据进行挖掘和分析，沃尔玛是不可能发现数据内在这一有价值的规律的。

从这个例子可以看出，利用关联规则技术，可以找出一些隐含的规律，因此这种方法在量化投资中同样存在广泛的应用。

2）关联规则例子

用一个简单的例子说明。表11-2是在过去一段时间，不同板块的涨跌关系，其中“1”表示上涨，“0”表示下跌。在该市场行情数据库中，事务总数为D，在本例子中，包含6个事务，则D为6。项集I＝｛煤炭板块，原油板块，公用板块，地产板块｝。考虑关联规则（频繁二项集）：煤炭板块与原油板块，上涨记录1、2、3、4、6中包含煤炭板块，记为X，X的数量为5；上涨记录1、2、5、6中包含原油板块，记为Y，Y的值为4。

表11-2　关联规则案例数据表 

上涨记录1、2、6同时包含煤炭板块和原油板块，数量为3，即X^Y，那么：

支持度（X^Y）/D＝3/6＝0.5，

置信度（X^Y）/X＝0.6。

若给定最小支持度α＝0.5，最小置信度β＝0.6，认为煤炭板块上涨和原油板块上涨之间存在关联规则如下：

煤炭板块上涨→原油板块上涨（0.5，0.6）

该关联规则的含义是：数据库中有50％的数据支持表明，煤炭板块的上涨可能带动原油板块上涨，该规则可信程度达到60％。

2．数学定义

关联规则定义为：假设I是项的集合。给定一个交易数据库，其中每个事务t是I的非空子集，即，每一个交易都与一个唯一的标识符TID对应。记D为事务的集合（事务数据库），关联规则在D中的支持度是D中事务同时包含项X和项Y的百分比，即概率。置信度是包含X的事务中同时又包含Y的百分比，即条件概率。关联规则是有效的，如果满足最小支持度阈值和最小置信度阈值，这些阈值是根据挖掘需要人为设定的。

下面是有关关联规则数学上的形式化定义：

设I＝｛i1
，i2
，...，im
｝是项的集合。记D为事务的集合（事务数据库），事务T是项的集合，并且T
I。设A是I中一个项集，如果A
T，那么称事务T包含A。

定义1：关联规则是形如A→B的蕴涵式，这里A
I，B
I，并且A∩B＝
。

定义2：规则的支持度。规则A→B在数据库D中具有支持度S，表示S是D中事务同时包含AB的百分比，它是概率P（AB），即：

其中，|D|表示事务数据库D的个数，表示A、B两个项集同时发生的事务个数。

定义3：规则的可信度。

规则A→B具有可信度C，表示C是包含A项集的同时也包含B项集，相对于包含A项集的百分比，这是条件概率P（B|A），即：

其中，|A|表示数据库中包含项集A的事务个数。

定义4：阈值。

在事务数据库中找出有用的关联规则，需要由用户确定两个阈值：最小支持度（min_sup）和最小可信度（min_conf）。

定义5：项的集合称为项集，包含k个项的项集称之为k-项集。如果项集满足最小支持度，则称之为频繁项集。

定义6：关联规则。

同时满足最小支持度（min_sup）和最小可信度（min_conf）的规则称之为关联规则。即：

S（A→B）＞min_sup且C（A→B）＞min_conf

成立时，规则称之为关联规则，也可以称为强关联规则。

定义7：兴趣度。

公式反映了项集A与项集B的相关程度。

若I（A→B）＝1，即P（AB）＝P（A）P（B），表示项集A出现和项集B出现是相互独立的。

若I（A→B）＜1，表示A出现和B出现是负相关的。

若I（A→B），表示A出现和B出现是正相关的，意味着A的出现蕴含B的出现。

一条规则的兴趣度越大于1，说明我们对这条规则越感兴趣（即其实际利用价值越大）。

一条规则的兴趣度越小于1，说明我们对这条规则的反面规则越感兴趣（即其反面规则的实际利用价值越大）。

根据定义7可知，兴趣度I不小于0。

3．挖掘过程

1）挖掘过程

关联规则的挖掘过程主要包含两个阶段：第一阶段必须先从资料集合中找出所有的高频项目组；第二阶段再由这些高频项目组中产生关联规则。

关联规则挖掘的第一阶段是从原始资料集合中找出所有高频项目组。高频的意思是指某一项目组出现的频率相对于所有记录而言必须达到某一水平。一项目组出现的频率称为支持度，以一个包含A与B两个项目的2-itemset为例，我们可以由定义2求得包含｛A，B｝项目组的支持度，若支持度大于等于所设定的最小支持度门槛值时，则｛A，B｝称为高频项目组。一个满足最小支持度的k-itemset，则称为高频k-项目组，一般表示为Frequent k。算法从Large k的项目组中再产生Large k＋1，直到无法再找到更长的高频项目组为止。

关联规则挖掘的第二阶段是要产生关联规则。从高频项目组产生关联规则，是利用前一步骤的高频k-项目组来产生规则，在最小信赖度的条件门槛下，若一规则所求得的信赖度满足最小信赖度，称此规则为关联规则。例如，经高频k-项目组｛A，B｝所产生的规则AB，其信赖度可经由定义3求得，若信赖度大于等于最小信赖度，则称AB为关联规则。

2）关联规则分类

按照不同情况，关联规则可以进行如下分类：

（1）基于规则中处理的变量的类别，关联规则可以分为布尔型和数值型。

布尔型关联规则处理的值都是离散的、种类化的，它显示了这些变量之间的关系。而数值型关联规则可以和多维关联或多层关联规则结合起来，对数值型字段进行处理，将其进行动态的分割，或者直接对原始的数据进行处理，当然数值型关联规则中也可以包含种类变量。例如：

类别＝“大蓝筹”→涨幅＝“弱于大势”，是布尔型关联规则。

类别＝“大蓝筹”→avg（阿尔法）＝-10％，涉及的收入是数值类型，是一个数值型关联规则。

（2）基于规则中数据的抽象层次，可以分为单层关联规则和多层关联规则。

在单层的关联规则中，所有的变量都没有考虑到现实的数据是具有多个不同层次的。而在多层的关联规则中，对数据的多层性已经进行了充分的考虑。例如，央企→分红率高，是一个细节数据上的单层关联规则；国企→分红率高，是一个较高层次和细节层次之间的多层关联规则。

（3）基于规则中涉及的数据的维数，关联规则可以分为单维的和多维的。

在单维的关联规则中，我们只涉及数据的一个维，如投资者购买的股票，而在多维的关联规则中，要处理的数据将会涉及多个维。换句话说，单维关联规则是处理单个属性中的一些关系；多维关联规则是处理各个属性之间的某些关系。例如，大蓝筹涨→小盘股跌，这条规则只涉及投资者购买的股票类别；类别＝“大蓝筹”→涨幅＝“弱于大势”，这条规则就涉及两个字段的信息，是两个维上的一条关联规则。

4．相关算法

1）Apriori算法

Apriori算法是一种最有影响的挖掘布尔关联规则频繁项集的算法，其核心是基于两阶段频集思想的递推算法。该关联规则在分类上属于单维、单层、布尔关联规则，在这里，所有支持度大于最小支持度的项集称为频繁项集，简称频集。

该算法的基本思想是：首先找出所有的频集，这些项集出现的频繁性至少和预定义的最小支持度一样。然后由频集产生强关联规则，这些规则必须满足最小支持度和最小可信度。然后使用第一步找到的频集产生期望的规则，产生只包含集合的项的所有规则，其中每一条规则的右部只有一项，这里采用的是中规则的定义。一旦这些规则被生成，那么只有那些大于用户给定的最小可信度的规则才被留下来。为了生成所有频集，使用了递推的方法。

Apriori算法的缺点是：可能产生大量的候选集及可能需要重复扫描数据库。

2）基于划分的算法

这个算法先把数据库从逻辑上分成几个互不相交的块，每次单独考虑一个分块并对它生成所有的频集，然后把产生的频集合并，用来生成所有可能的频集，最后计算这些项集的支持度。这里分块的大小选择要使得每个分块可以被放入主存，每个阶段只需被扫描一次。

而算法的正确性是由每一个可能的频集（至少在某一个分块中是频集）保证的，该算法是可以高度并行的，可以把每一分块分别分配给某一个处理器生成频集。产生频集的每一个循环结束后，处理器之间进行通信来产生全局的候选k-项集。通常这里的通信过程是算法执行时间的主要瓶颈，而每个独立的处理器生成频集的时间也是一个瓶颈。

3）FP-树频集算法

FP-树频集算法采用分而治之的策略，在经过第一遍扫描之后，把数据库中的频集压缩进一棵频繁模式树（FP-tree），同时依然保留其中的关联信息，随后再将FP-tree分化成一些条件库，每个库和一个长度为1的频集相关，然后再对这些条件库分别进行挖掘。当原始数据量很大的时候，也可以结合划分的方法，使得一个FP-tree可以放入主存中。实验表明，FP-树频集算法对不同长度的规则都有很好的适应性，同时在效率上较之Apriori算法有巨大的提高。

11.2.3　聚类分析

1．基本概念

聚类（簇）是指数据对象的集合。聚类有如下两个特征：在同一个聚类（簇）中的对象彼此相似、不同簇中的对象则相异。

聚类分析是指将物理或抽象对象的集合分组成为由类似的对象组成的多个类的过程。聚类是一种无指导的学习：没有预定义的类编号。

聚类分析的数据挖掘功能既可以作为一个独立的工具来获得数据分布的情况，也可以作为其他算法（如特征和分类）的预处理步骤。

聚类分析的典型应用包括：

（1）模式识别。

（2）空间数据分析：在GIS系统中，对相似区域进行聚类，产生主题地图；检测空间聚类，并给出它们在空间数据挖掘中的解释；图像处理等。

（3）经济学与金融学，如客户行为分类、发现股票模式等。

（4）万维网：对Web上的文档进行分类；对Web日志的数据进行聚类，以发现相同的用户访问模式。

一个好的聚类分析方法会产生高质量的聚类，该聚类具有两个特征：高类内相似度和低类间相似度。一个高质量的聚类分析结果，将取决于所使用的聚类方法。

2．聚类分析中的数据类型

许多基于内存的聚类算法采用以下两种数据结构：

（1）数据矩阵（Data Matrix，或称对象—变量结构）：用p个变量来表示n个对象，例如使用年龄、身高、性别、体重等属性变量来表示对象人，也叫二模矩阵，行与列代表不同实体：

（2）相异度矩阵（Dissimilarity Matrix，又称为对象—对象结构）：存储所有成对的n个对象两两之间的近似性（邻近度），也叫单模矩阵，行和列代表相同的实体。其中d（i，j）是对象i和对象j之间的测量差或相异度。d（i，j）是一个非负的数值，d（i，j）越大，两个对象越不同；d（i，j）越接近于0，则两者之间越相似（相近）。

许多聚类算法都是以相异度矩阵为基础的，如果数据是用数据矩阵形式表示，则往往要将其先转化为相异度矩阵。

相异度d（i，j）的具体计算会因所使用的数据类型不同而不同，常用的数据类型包括：区间标度变量，二元变量，标称型、序数型和比例标度型变量，混合类型的变量。

3．主要聚类方法

主要聚类方法有：划分方法、层次的方法、基于密度的方法、基于网格的方法和基于模型的方法。

1）划分方法

划分方法的思想：给定一个n个对象或元组的数据库，一个划分方法构建数据的k个划分，每个划分表示一个簇，并且k≤n；每个对象属于且仅属于一个组，每个组至少包含一个对象。

划分准则：同一个聚类中的对象尽可能地接近或相关，不同聚类中的对象尽可能地远离或不同。

典型的划分方法有k-平均算法、k中心点方法和它们的变种。

2）层次的方法

对给定数据对象集合进行层次分解，包括自底向上和自顶向下方法。

（1）自底向上方法（凝聚）：开始将每个对象作为单独的一个组，然后相继地合并相近的对象或组，直到所有的组合并为一个，或者达到一个终止条件。

（2）自顶向下方法（分裂）：开始将所有的对象置于一个簇中，在迭代的每一步，一个簇被分裂为多个更小的簇，直到最终每个对象在一个单独的簇中，或达到一个终止条件。

缺点：合并或分裂的步骤不能被撤销。

使用距离矩阵作为聚类准则，层次方法不必输入初始的k作为簇的个数，但需要一个终止条件（例如簇的数目）。

3）基于密度的方法

基于密度的据类：只要临近区域的密度（对象或数据点的数目）超过某个临界值，就继续聚类。

优点：可以过滤掉噪声和孤立点，发现任意形状的簇。

4）基于网格的方法

把对象空间量化为有限数目的单元，形成一个网格结构。所有的聚类都在这个网格结构上进行。

优点：处理速度快（因为处理时间独立于数据对象数目，只与量化空间中每一维的单元数目有关）。

5）基于模型的方法

为每个簇假定一个模型，寻找数据对给定模型的最佳拟合。

4．孤立点挖掘

孤立点是指一个数据集与其他数据有着显著区别的数据对象的集合。例如运动员：乔丹、舒马赫、布勃卡。

孤立点挖掘的过程是：给定一个n个数据对象的集合，以及预期的孤立点数目k，发现与剩余的数据有着显著差异的k个数据对象。

孤立点挖掘的主要应用在：信用卡欺诈检测、移动电话欺诈检测、客户划分、医疗分析（异常）。

1）基于距离的孤立点检测

为了解决统计学方法带来的一些限制，引入了基于距离的孤立点检测，在不知道数据分布的情况下对数据进行多维分析。

基于距离的孤立点是指：数据集合S中的基于距离的孤立点o的集合可以表示为DB（p，d），即数据集合S中的对象至少有p部分与对象o的距离大于d（说明该对象o没有足够的邻居）。

挖掘基于距离的孤立点的高效算法有：基于索引的算法、嵌套－循环算法、基于单元的算法等。

2）基于偏离的孤立点检测

通过检查一组对象的主要特征来确立孤立点，即与主要特征的描述相偏离的对象被认为是孤立点。

基于偏离的孤立点的探测技术有如下两种：

（1）序列异常技术：模仿人类从一系列被假定为类似的对象中识别异常对象的方式。

（2）OLAP数据立方体技术：在大规模的多维数据中采用数据立方体来确定异常区域。如果一个立方体的单元值显著地不同于根据统计模型得到的期望值，则该单元值被认为是一个异常，并用可视化技术表示。

11.3　数据挖掘在量化投资中的应用

11.3.1　基于SOM网络的股票聚类分析方法

无监督的自组织映射（Self-Organizing Map, SOM）网络具有高度并行处理机制、高度容错能力，是解决聚类问题的强有力工具，在解决聚类问题方面表现出很好的优越性。与其他聚类方法相比，SOM网络的优点在于：可以实现自学习，网络具有自稳定性，无须外界给出评价函数，能够识别向量空间中最有意义的特征，抗噪音能力强等，因此该模型在模式识别、机器控制、语音识别、图像压缩、向量量化及组合优化等方面具有广泛的应用。

本案例在具有智能背景的SOM神经网络的基础上，利用改进的SOM模型对股票进行分析。

1．SOM神经网络简介

SOM神经网络的拓扑结构由两层节点构成：输入层和输出层（竞争层），其结构如图11-3所示。图中上层为输出层，输出层中的节点是以二维形式排成的一个节点矩阵，它们中的每个节点是一个输入向量的代表。输入层处于下方，若输入节点为个，则输入向量为维，输入层节点与输出层中的所有节点通过权值实现全互连。

图11-3　SOM网络结构

输出层节点之间实行侧抑制连接，它与节点之间的权值分布有关，在获胜节点邻域区域内的节点相互激励，邻域区域可以是正方形，也可以是六角形。它是关于时间的函数，随着时间的增加，邻域的面积成比例缩小。区域以外的节点相互抑制，而更远的又有较弱的激励作用，通常用Bubble（墨西哥帽）函数来表示神经元之间的这种侧反馈作用。

应用这种侧反馈原理，使每个获胜神经元附近形成一个聚类区。由于聚类区内的各神经元的权重向量保持与输入向量逼近的趋势，从而使具有相近特征的输入向量聚集在一起。

Kohonen分别定义了SOM神经网络的邻域函数a（t）、学习速率因子函数n（t），如公式（1）、公式（2）所示。

式中：t为迭代次数，T为预设的最大迭代次数。a（0）、n（0）为初始时刻的邻域半径和学习速率因子，a（0）在学习的初始时刻覆盖范围较大，随着时间的增加，a（0）逐渐减小，n（t）值的选取范围通常为［0，1］。

另外，Kohonen还定义了获胜节点及其邻域内节点的连接权修正公式，如公式（3）、（4）所示。

式中：Wij
（t＋1）为t＋1时刻输入节点i与输出节点j之间的连接权，N*j（t）为t时刻以获胜节点为中心的邻域范围。

对于Kohonen提出的SOM模型，每次进行连接权修正后，各输出神经元对应于输入模式空间的最邻近区域都在不断地变化，不同的输入模式对应着不同的变化，因此使网络最终的收敛结果与输入顺序有关。但如果选取一个较小的学习速率因子，并且学习速率因子和邻域半径都在一个合适的函数关系范围内变化，则对于输入顺序的敏感性将会得到改善或避免。鉴于上述因素，本案例在SOM的基础上，改进了网络中的邻域函数如公式（5）所示，学习速率因子函数如公式（6）所示。

2．SOM在股票分析中的应用

1）数据处理

为了更好地说明问题而不受个别变量单位的影响，在聚类分析计算之前需要对原始数据进行标准化处理。数据标准化公式如下：

式中，i为股票上市公司的数量，j为上市公司综合盈利能力指标；xij
为标准化后的数据，
为某指标的均值，Sj
为某指标的均方差。

2）实验结果

本案例所选取的数据来自于2005年80家上市公司的年报信息，分析中选取上市公司的每股收益、每股净资产、净资产收益率、每股经营性现金流量及净利润5项反映上市公司综合盈利能力的指标作为主要研究对象。应用SOM模型进行模拟聚类实验，通过聚类的方法分析股票。在实验过程中，网络的输入层节点的个数均选为5，输出层节点的个数选为10000。通过实验反复筛选选取参数：n（0）＝0.1，a（0）＝5，τ＝0.5，迭代次数Gap＝14。

利用SOM所得聚类结果的9类上市公司的净利润大小如表11-3所示，其中5类指标均为各项指标的平均值。在第9类上市公司中反映上市公司财务状况的4项指标：每股收益、每股净资产、每股经营性现金流量、净资产收益率均为正值。由于每股收益、每股净资产、净资产收益率这3个指标是投资者最为关注的指标，因此它们是衡量公司获利能力和成长性最好的指标。上述结果说明该类上市公司在经营规模、经营实力、技术水平等方面具有一定优势，竞争能力较强，经营业绩优良，综合财务状况较佳，颇具发展潜力和长期投资价值。

表11-3　SOM股票聚类分析结果 

第2类上市公司净利润的平均值最低。在该类上市公司中，反映上市公司综合盈利能力的指标多为负值，表现出这类公司既没有显著的规模效益，也没有在主营业务上的业绩突出，在投资效益上表现为亏损。该类股票的表现为劣质股的特征，因此投资者应谨慎介入，可多加观望。

上述实验结果说明，利用SOM网络进行股票分析所得结果基本与公司的实际情况相符，为股票的分析和选择提供了较好的依据。

11.3.2　基于关联规则的板块轮动

股票市场交易规律显示：在股价波动的过程中，整个市场并不是经常性地普涨普跌，而是呈现出板块轮动、涨跌不一的状况。其实金融风险并不可怕，如果能够发现股票板块的运动规律及其相互的联动关系，那么金融风险在一定程度上可以通过风险流动得以规避。

1．数据与模型构建

案例　基于关联规则的板块轮动策略

本案例使用的数据，来自2007年1月4日至2008年3月31日A股市场的21个板块指数的日收盘值，取得295条日收盘数据记录共6195个观察值进行分析。这21个板块指数分别为采掘指数、地产指数、食品指数、金属指数、批零指数、石化指数、运输指数、制造指数、机械设备指数、服务指数、金融指数、水电指数、医药指数、建筑指数、造纸指数、IT指数、农林牧渔指数、纺织指数、传播指数、电子指数及木材指数，它们基本涵盖了现有证券交易系统中所有板块的历史交易信息，为数据挖掘建模提供了较为完整的数据样本。

在进行关联规则挖掘之前，必须对所收集的数据进行预处理，根据每种股票板块指数在当天交易的涨跌情况将其对应的日收盘数据转化为二项数值，“1”代表上涨，“0”代表下跌。如表11-4所示为经过数据预处理后得到的包含295条记录的布尔关系表数据片断。

表11-4　21种股票板块指数布尔关系表数据片断 

2．数据实证结果

数据预处理后，根据股票板块指数“涨”、“跌”情况，采用二值型关联规则算法进行挖掘，这里采用Apriori算法来实施关联分析。设定当支持度阈值为0.5，置信度阈值为0.95时，可以从模型中找到许多有意义的强关联规则，例如：

金属、机械设备、石化3种指数上涨、制造指数上涨，则置信度＝100％。

即当金属、机械设备、石化3种指数上涨时，100％的情况下，制造指数也在上涨。而且该规则作用度为1.62、支持度为51.18％，说明制造指数变动受金属、机械设备、石化3种指数的影响较大，该规则具有较高的应用价值。各个板块之间的关联如图11-4所示。

图11-4　主要股票板块指数的Web节点

综合置信度、支持度与作用度3个因素进行分析，可以看到，模型的主体由制造、石化、运输、机械设备、医药、电子、纺织及水电8种指数间的关联规则构成；采掘、服务、金属、建筑、造纸、IT及农林牧渔7种指数也有着强关联规则；而批零、木材两种指数均只与石化指数表现出紧密的联动关系。此外，模型中未发现地产、食品、金融及传播4种指数的关联规则，说明它们在板块联动中的作用较弱。

从连线数量角度来看，它以石化与制造两种指数为核心，向外辐射连接其他股票指数；电子、机械设备、纺织、运输及医药5种指数散开的连线也较多；而金属、IT、建筑3种指数在图中只有单根连线。此外，木材、服务、批零、农林牧渔、采掘、造纸及水电7种指数由于关联频数低，均没有连线，而是作为孤点在图中显示。从所有连线的关联程度强弱来看，石化、机械设备两种指数与制造指数的关联程度是最强的，而医药、纺织两种指数与制造指数的关联程度最弱，其他连线关联程度居中。

可以得出以下的结论：

（1）制造、石化指数作为关联规则的核心，与其他板块指数（除金融、地产、食品与传播4种指数之外）之间有着紧密的关系。通过它们之间的强关联规则进行板块组合分析，往往可以在某一板块出现明显涨跌状况的情形下，预测出相关联的板块运动趋势，然后进行风险管理，以此达到规避风险或追求利润的目的。

（2）模型结果显示，金融、地产、食品与传播4种指数与其他板块指数不存在强关联规则。也就是说，在板块联动过程中，它们的联动效应是不显著的，这4个板块的涨跌主要考虑国际市场、国内宏观经济、行业状况及其他因素。所以，在证券交易过程中，它们不是通过板块轮动避险的最佳选择对象。

第12章　小波分析

◆摘要◆

把函数分解成一系列简单基函数的表示，无论是在理论上，还是实际应用中：都有重要意义。小波变换作为能随频率的变化自动调整分析窗大小的分析工具，自20世纪80年代中期以来得到了迅猛的发展，并在信号处理、计算机视觉、图像处理、语音分析与合成等众多的领域得到应用。

小波变化的主要内容包括：连续小波变换、小波变化的离散化、多分辨分析与Mallat算法。

连续小波变换的性质有：线性、平移不变性、伸缩共变性和冗余性。

由于连续小波变换存在冗余，因而有必要搞清楚，为了重构信号，需针对变换域的变量进行离散化，以消除变换中的冗余。

Mallat使用多分辨分析的概念统一了各种具体小波基的构造方法，并由此提出了现今广泛使用的Mallat快速小波分解和重构算法，它在小波分析中的地位与快速傅里叶变换在傅里叶分析中的地位相当。

二维小波分解与重构算法，利用其可分离特性，在算法实现时分别由对行进行一维小波变换，然后对按行变换后的数据按列进行一维小波变换来完成。

小波变换在量化投资中的案例主要有小波去噪和金融时序数据预测。

但是金融时间序列本身具有非平稳、非线性和信噪比高的特点，采用传统的去噪处理方法往往存在诸多缺陷。而小波理论是根据时频局部化的要求而发展起来的，具有自适应和数学显微镜性质，特别适合非平稳、非线性信号的处理。

采用小波进行金融时序数据预测的原理如下：首先使用Mallat算法对数据进行分解，对分解后的数据进行平滑处理；然后进行重构，而重构之后的数据就成为近似意义的平稳时间序列，这样就得到了原始数据的近似信号；最后利用预测模型进行时间序列预测，例如常用的有AR、MA、ARMA等。

12.1　基本概念

1822年法国数学家傅里叶发表的有关热传导理论的研究文章中，提出并证明了将周期函数展开为正弦级数的原理，奠定了傅里叶级数理论的基础。傅里叶级数理论研究的是把函数在三角函数系下展开，使得对信号和系统的研究归结为对简单的三角函数的研究，傅里叶级数与傅里叶变换共同组成了平常所说的傅里叶分析。傅里叶级数用于分析周期性的函数或分布，理论分析时经常假定周期是2π，定义如式：

其中

小波变换作为能随频率的变化自动调整分析窗大小的分析工具，自20世纪80年代中期以来得到了迅猛的发展，并在信号处理、计算机视觉、图像处理、语音分析与合成等众多的领域得到了应用。

小波分析方法的出现可以追溯到1910年Haar提出Haar规范正交基，以及1938年Littlewood-Paley对傅里叶级数建立的L-P理论。为克服传统傅里叶分析的不足，在20世纪80年代初，便有科学家使用小波的概念来进行数据处理，比较著名的是1984年法国地球物理学家Morlet引入小波的概念对石油勘探中的地震信号进行存储和表示。在数学方面所做的探索主要是R. Coifman和G. Weiss创立的原子和分子学说，这些原子和分子构成了不同函数空间的基的组成部分。直到

L.Carleron使用非常像小波的函数构造了Stein和Weiss的空间H1
的无条件基。直到1986年，法国数学家Meyer成功地构造出了具有一定衰减性的光滑函数Ψ，它的二进伸缩与平移
构成L2
（R）的规范正交基。此前，人们普遍认为这是不可能的，如Daubechies, Grossman和Meyer都退而研究函数系
构成L2
（R）的框架。

Lemarie和Battle继Meyer之后也分别独立地给出了具有指数衰减的小波函数。1987年，Mallat利用多分辨分析的概念，统一了之前的各种具体小波的构造，并提出了现今广泛应用的Mallat快速小波分解和重构算法。1988年Daubechies构造了具有紧支集的正交小波基，1989年Coifman、Meyer等人引入了小波包的概念，1990年崔锦泰和王建忠构造了基于样条函数的单正交小波基。1992年A. Cohen、I. Daubechhies等人构造出了紧支撑双正交小波基，同一时期，有关小波变换与滤波器组之间的关系也得到了深入研究。小波分析的理论基础就这样基本建立起来了。

12.2　小波变换主要内容

12.2.1　连续小波变换

f（t）的连续小波变换（有时也称为积分小波变换）定义为：

或用内积形式：

式中，

要使逆变换存在，Ψ（t）要满足允许性条件：

式中，
（ω）是Ψ（t）的傅里叶变换。

这时，逆变换为：

CΨ
这个常数限制了能作为基小波（或母小波）的属于L2
（R）的函数Ψ的类，尤其是若还要求Ψ是一个窗函数，那么Ψ还必须属于L1
（R），即：

故
是R中的一个连续函数，可得
在原点必定为零，即：

连续小波变换具有如下性质：

性质1（线性）：设f（t）＝αg（t）＋βh（t），则：

性质2（平移不变性）：若f（t）
WTf
（a，b），则f（t－τ）
WTf
（a，b－τ）。平移不变性是一个很能好的性质，在实际应用中，尽管离散小波变换要用得广泛一些，但在需要有平移不变性的情况下，离散小波变换是不能直接使用的。

性质3（伸缩共变性）：若f（t）
WTf
（a，b），则
其中c＞0。

性质4（冗余性）：连续小波变换中存在信息表述的冗余度。其表现是由连续小波变换恢复原信号的重构公式不是唯一的，小波变换的核函数Ψa，b
（t）存在许多可能的选择。尽管冗余的存在可以提高信号重建时计算的稳定性，但增加了分析和解释小波变换结果的困难。

12.2.2　连续小波变换的离散化

由于连续小波变换存在冗余，因此有必要弄清楚，为了重构信号，需针对变换域的变量a、b进行何种离散化，以消除变换中的冗余。在实际中，常取

这时：

常简写为：Ψj，k
（t）。

变换形式为：

为了能重构信号f（t），要求｛Ψj，k
｝j，k∈Z
是L2
（R）的Riesz基。

定义1：一个函数Ψ∈L2
（R）称为一个R函数，如果｛Ψj，k
｝j，k∈Z
在下述意义上是一个Risez基：Ψj，k
，j，k∈Z的线性张成在L2
（R）中是稠密的，并且存在正常数A与B，0＜A≤B＜∞，使：

对所有二重双无限平方可和序列｛cj，k
｝成立，即对于
的
成立。

假定Ψ是一个R函数，那么存在L2
（R）的一个唯一的Riesz基｛Ψj，k
｝j，k∈Z
，它在意义
上与｛Ψj，k
｝对偶。这时，每个f（t）∈L2
（R）有唯一的级数表示：

特别地，若｛Ψj，k
｝j，k∈Z
构成L2
（R）的规范正交基时，有Ψj，k
＝Ψj，k
。

重构公式为：

12.2.3　多分辨分析与Mallat算法

1．多分辨分析

Mallat使用多分辨分析的概念统一了各种具体小波基的构造方法，并由此提出了现今广泛使用的Mallat快速小波分解和重构算法，它在小波分析中的地位与快速傅里叶变换在傅里叶分析中的地位相当。

定义2：空间L2
（R）的多分辨分析是指构造该空间内一个子空间列｛Vj
｝j∈Z
，使其具有以下性质：

（1）单调性（包容性）：…
V2

V1

V0

V－1

V－2

…。

（2）逼近性：

（3）伸缩性：
（t）∈Vj

（2t）∈Vj－1
。

（4）平移不变性：
（t）∈Vj

（t－2j－1
k）∈Vj
，
k∈Z。

（5）Riesz基存在性：存在
（t）∈V0
，使得｛
（2－j
t－k）｝k∈Z
构成Vj
的Riesz基。

在定义2中，Vj
对应于2－j
分辨率，在有些文献中，Vj
对应于2j
分辨率，这时，性质（1）、（3）中子空间的下标要做相应的变化。

2．一维Mallat算法

Mallat在用于图像分解的金字塔算法的启发下，结合多分辨分析，提出了信号的塔式多分辨分解与综合算法，常简称为Mallat算法。

设f（t）∈L2
（R），并假定已得到f（t）在2－j
分辨率下的粗糙象
构成L2
（R）的多分辨分析，从而有Vj
＝Vj＋1

Wj＋1
，即Aj
f＝Aj＋1
f＋Dj＋1
f。

式中
于是

由尺度函数的双尺度方程可得

利用尺度函数的正交性，有

同理由小波函数的双尺度方程可得

由上面几式可得：

引入无穷矩阵

，其中Hm,k
＝h*
（k－2m），Gm,k
＝g*
（k－2m），则可分别表示为：

和：

其中，H*
、G*
分别是H和G的共轭转置矩阵。公式（1）为Mallat一维分解算法，公式（2）为Mallat一维重构算法。

利用Mallat分解与重构算法进行信号处理时，不必知道具体的小波函数是什么样的。此外，在对数字信号进行处理时，通常假定相应的连续函数属于V0
，但即使如此，该函数在V0
空间投影的系数与由采样得到的离散序列一般不一样，但实际上都是直接把由采样得到的信号作为最高分辨率的信号来处理，这时更多的是把小波变换当做滤波器组来看待。

在实际应用Mallat算法时，由于实际信号都是有限长的，存在如何处理边界的问题。比较常用的方法是周期扩展和反射扩展。主要目的是要降低边界不连续性所产生的在边界上变换系数衰减慢的问题。

3．二维Mallat算法

在进行图像处理时要用到二维小波变换，目前研究中主要以可分离小波为主，下面的定理给出了构造二维可分离正交小波基的方法。的二维尺度函数，Ψ（x）是与尺度函数对应的一维标准正交小波。若定义3个二维小波：

定理：令
）是L2
（R2
）的可分离多分辨分析，并令
（x，y）＝
（x）
（y）是相应

则：

分别是L2
（R2
）内的标准正交基。

设
为待分析的图像信号，其二维逼近图像为：

式中：

利用尺度函数和小波函数的正交性，由公式（4）、（5）和（6）可得：

以及：

引入矩阵算子，令Hr
和Hc
分别代表用尺度滤波器系数对阵列
的行和列作用的算子，Gr
和Gc
分别表示用小波滤波器系数对行和列作用的算子，二维Mallat分解算法为：

二维Mallat重构算法为：

二维小波分解与重构算法，利用其可分离特性，在算法实现时分别由对行进行一维小波变换，然后再对按行变换后的数据按列进行一维小波变换来完成。与一维的情形类似，在实际应用中，由于图像信号总是有限区域的，也存在如何处理边界的问题。典型的处理方法是周期扩展和反射扩展，在用小波变换进行图像压缩时，由于边界的不连续性，会使在边界处的小波变换系数的衰减变慢，从而影响图像的压缩比。因而在图像压缩应用中，若使用的是具有对称性质的双正交小波滤波器，则一般对边界采用反射扩展的方式，使边界保持连续，以提高压缩性能。

12.3　小波分析在量化投资中的应用

12.3.1　K线小波去噪

由于金融市场中各种偶然因素的影响，使得金融数据，特别是金融时间序列数据中存在许多噪声。这些噪声严重影响了进一步的分析和处理，因此必须预先去噪。但是金融时间序列本身具有非平稳、非线性和信噪比高的特点，采用传统的去噪处理方法往往存在诸多缺陷。而小波理论是根据时频局部化的要求而发展起来的，具有自适应和数学显微镜性质，特别适合非平稳、非线性信号的处理。

1．传统去噪方法的缺陷

对金融时间序列去噪的传统方法主要有移动平均法、传统滤波方法、卡尔曼滤波方法和维纳滤波方法。

（1）移动平均法就是将序列从第一项开始，逐项移动重叠求出每移动一次的序时平均数，从而构成新的时间序列。在新序列中短期的偶然因素引起的变动被削弱，从而达到去噪目的。作为一种简单的数据平滑技术，该方法非常粗略，在去噪声的同时，把许多有用信息也一并去掉了，因而它只适用于对数据的简单处理，不适合对数据的深层分析。

（2）传统滤波方法的一个典型例子是采用傅立叶变换，将时域信号变换到频域，一般地认为低频信号是有用信号，而高频信号一般看做噪声。将高于某个阈值频率的傅里叶系数全部设为0后，再通过傅里叶逆变换恢复到时域，从而实现去噪。它要求有用信号和噪声的频谱相互分开，但对金融时间序列来说，比如股价时间序列和收益率序列其波动性都比较大，频谱比较宽，因而有用信号和噪声谱重叠比较严重，采用传统方法难以实现信噪的有效分离。

（3）卡尔曼滤波是以最小均方差为估计的最佳准则来寻求一套递推估计的算法，它利用前一时刻的状态估计值和当前时刻的观测值来共同确定当前状态的估计值，它需要知道系统的运动规律以建立准确的状态方程。但金融时间序列是一个非平稳、非线性的时间序列，很难用一个确定的方程来描述其状态和行为，因此采用这种方法来对金融时间序列去噪也存在固有的难度。

（4）维纳滤波法是现代滤波理论中的典型代表，其基本思想是：寻找线性滤波器的最佳冲击响应或传递函数，使得滤波器的输出波形作为输入波形的最佳估计。但其只适应平稳过程，不适于非平稳过程，并且维纳滤波需要噪声和有用信号的先验知识，如它们的自相关函数、功率谱密度等。由于实际中这些先验知识很难得到或者过于简化，因而往往使理论上最优的维纳滤波达不到要求。

2．小波去噪的基本原理

小波有两个显著特点：一是在时域中都具有紧支集或近似紧支集；二是正负交替的波动性。小波分析是将信号分解成一系列小波函数的叠加，而这些小波函数都是由一个母小波通过平移和尺度伸缩得来的。

小波分析理论的一个重要特色是可以进行多分辨率分析。信号可通过多层分解为反映高频信息的细节部分和反映低频信息的概貌部分，通过这种多分辨率分解，信号和噪声通常会有不同的表现，从而达到信噪分离的目的。金融时间序列去噪处理采用更广泛的方法：非线性阈值处理方法。

非线性阈值处理方法又称小波收缩法，该方法的基本原理是基于小波变换的集中能力。即通过小波变换后有用信号的能量集中于少数小波系数上，而白噪声在小波变换域上仍然分散在大量小波系数之上。因而相对来说，有用信号的小波系数值必然大于那些能量分散且幅值较小的噪声的小波系数值。因此，从谱的幅度上（不是谱的位置）看，有用信号和噪声可以实现分离。该方法可分为以下3个步骤：

（1）选择合适的正交小波基和分解层数J，对含噪信号进行小波变换分解到J层。

（2）对分解得到的小波系数进行阈值处理，可以使用两种处理方法：硬阈值和软阈值法。硬阈值法保留较大的小波系数并将较小的小波系数置零，即：

（3）软阈值法将较小的小波系数置零，而对较大的小波系数向零进行收缩，即：

学者证明了用软阈值法能使估计信号实现最大均方误差最小化，即去噪后的估计信号是原始信号的近似最优估计。该方法具有广泛的适用性，是应用最为广泛的一种小波去噪方法，其计算速度也很快。

3．金融时间序列小波去噪方法分析

尽管非线性阈值法相对简单，然而还是存在几个重要参数的确定问题，即：小波函数的选取、阈值和分解层次的确定，下面针对金融时间序列的特性分析如何确定相应参数。

1）金融时间序列的特点与一般去噪要求

股票市场数据是金融数据的典型代表，常见的有股票价格数据和由股价计算出的收益率数据。这两类序列都表现为很不平稳的特性，数据的起伏波动比较大，信号中的奇异点比较多。其中收益率数据波动性更大，奇异点数更加密集，信号中的高频成分较多，很难将其与噪声区别开来。

除了大幅波动之外，数据中还有很频繁的小幅波动，随机性很强，几乎贯穿整个时间。一般来说，信号的大幅波动蕴含着比较重要的信息，因而我们一般将其作为有用信号，在消噪时要保留。而大量的小幅波动一般将其作为噪声，因为即使在金融市场非常平稳，没有什么重大新闻、政策出台或暗箱操作，它也会由于股票市场的流动性而表现这种小幅波动性，不具有分析和预测价值，反而具有干扰作用。由于去噪只是进一步进行数据分析的预处理，一般地，我们只要求去掉这种小的波动性，而尽可能地保留有用信息，防止信号的失真。

2）小波函数的选取

目前有几十种小波函数，它们性质各异，适合不同的应用场合，不同的小波函数有不同的去噪效果，因而选取合适的小波函数是很重要的。分析以下一些与去噪关系紧密的小波函数特性：

（1）正交性。具有正交性的小波函数一方面消除了冗余，保持小波系数间的不相关性，因而可提高除噪性能；另一方面正交性或双正交性是可实现快速离散小波变换的条件。由于除噪过程需将原信号在多个层次分解，显然这个特性是必须首先考虑的。

（2）紧支撑性。如果描述尺度函数的低通滤波器组h（n）可表征为FIR滤波器，那么尺度函数和小波函数只在有限区间非零，此时称小波函数具有紧支撑性。支撑宽度越小，小波的局部分辨能力越好，除噪更精细。

（3）消失矩。若∫Ψ（t）tm
dt＝0，（m＝0，1，…，M－1），则称小波具有M阶消失矩。消失矩特性使小波展开时消去信号的高阶平滑部分，即函数展开为多项式时的前M－1项对应函数的光滑部分，小波系数将非常小，因而小波变换只反映函数的高阶变换部分，从而反映信号奇异性的能力强。针对金融时间序列具有突变性的特点，一定的消失矩是需要的。但需要注意的是，太高的消失矩，若信号中奇异点比较多时，在对小波系数进行阈值处理后，重构失真度可能增大，因此像收益率这样的序列，消失矩不能太高，否则会丢掉很多信息，而股价数据可适当高一点。

（4）对称性。越对称的小波，在经过小波变换后，其偏差越可能小，因而有利于除噪后信号的恢复和重建。但该特性相对上述其他特性来说对除噪效果影响要小，因为特性之间往往会相互牵制，找到一个上述各方面特性都最优的小波是不可能的。

根据上述分析，从综合情况来看，dbN（即Daubechies系列小波）、symN（Symlets系列小波）、coifN（Coiflet系列小波）都比较合适，并且对于股价序列等相对比较平缓的序列可选择消失矩阶数稍高一点，即对应小波序列N取4～8都是可以的。但对收益率数据，因其奇异点密度非常大，消失矩不能太高，建议不要超过4，即db2～db4比较恰当。

3）阈值的确定

由前述阈值法消噪的原理可知阈值是区分信号和噪声的分水岭，显然它对除噪性能有至关重要的影响。阈值太高，会引起信号失真，太低则又去噪不完全。一般来说，阈值的确定主要基于以下几项准则：

（1）无偏风险估计准则（rigrsure）：即一种基于Stein的无偏似然估计原理的自适应阈值选择方法。对每个阈值求出对应的风险值，风险最小的即为所选，其具体算法为：

①把用来估计阈值的小波系数向量取绝对值（设其长度为n），由小到大排序，然后将各元素平方，得到新的待估计向量NV。

②对NV的每个元素下标k，按下式计算风险向量：

③求出风险向量Risk的最小点所对应的下标k值，从而得到阈值Tr为：

（2）固定阈值准则（sqtwolog）：设n为小波系数向量长度，则对应的阈值为：

（3）混合准则（heursure）：它是rigrsure和sqtwolog准则的混合，当信噪比很低时，rigrsure准则估计有很大噪声，这时采用固定阈值。其阈值计算方法为：首先判断两个变量Eta和Crit的大小，它们的表达式分别为：

其中n是待估计小波系数向量的长度，若Eta＜Crit，则选取固定阈值，否则选取rigrsure准则和sqtwolog准则的较小者作为本准则阈值。

（4）极小极大准则（minimaxi）：也是一种固定阈值选择形式。

该原理是在统计学中为设计估计量而采用的。由于去噪信号可假设为未知回归函数的估计量，则极小极大估计量是实现在最坏条件下最小均方误差最小的量。其阈值计算公式为：

以上阈值是针对标准差（小波域）为1的高斯白噪声而言的，因此实际阈值应取为Tr·σ，其中σ为噪声的标准差，一般认为最小尺度上的小波系数大部分由噪声引起，因而用其估计σ的值。估计方法为：若Mx
为含噪信号最小尺度上的小波系数绝对值向量的中位数，则：

上述准则中混合准则和极小极大准则相对比较保守（仅将部分系数置零），因此在信号的高频信息中有很少一部分在噪声范围内时，这两种阈值比较适合。而另外两种阈值选取规则，特别是固定阈值方法，能消除更多的噪声，但也有可能将有用信号的高频部分去掉。

考虑到针对金融数据去噪的目的只是为方便后续分析，并不要求完全去掉噪声。对股票价格等数据而言，其信号频率较少地与噪声重叠，因此可以选用sqtwolog和heursure准则，使去噪效果更明显。但对收益率这样的高频数据，尽量采用保守的rigrsure或minimaxi准则来确定阈值，以保留较多的信号。

4）分解层次确定

根据多分辨率分析理论，高层分解的小波系数对应的是低频部分，而低频部分主要由信号构成。因此分解层次越高，去掉的低频成分越多，去噪效果越明显，但失真度也相应增大。为保守起见，分解层次不宜太高，最大不超过5层。对于那些本身波动性强的序列，比如收益率序列，由于其信号本身高频成分较多，更是不能取太高的层次，一般不超过3层。

4．A股案例实证

案例　K线小波去噪

本案例对2008年5月至2010年5月共500个交易日的沪深300收盘价信号进行去噪实验：

（1）选择小波Daubechies小波系（db4）并确定分解层次为4层，得到4层高半频和4层低半频序列。

（2）阈值处理选择sqtwolog阈值估计准则。

（3）最后根据小波分解的第4层低频系数和经过量化处理后的1～4层高频系数进行小波重构，达到消除噪音的目的。

如图12-1所示为利用小波去噪后的结果，从图中可以看出大部分的小幅波动被去除，而指数走势的主要特征均被保留，得到一组消噪的时间序列。由于小幅干扰的噪音已被消除，用其他模型对其进行建模预测走势时，准确率将提升，因为消噪后的时间序列更能反映序列的主要特征。

图12-1　小波去噪结果（沪深300）

资料来源：D-Alpha对冲交易系统

总而言之，小波方法可有效消除金融时间序列中的噪声，并能充分保留原信号的特征，为进一步的分析创造条件。但是，在具体应用时，相关的一些去噪参数的选取是非常重要的，必须根据序列的一些特征灵活选取。

12.3.2　金融时序数据预测

股票市场是一个相当复杂的系统，股票价格的变化受到经济、有关行业、政治及投资者心理等多种因素的影响，各因素的影响程度、时间范围和方式也不尽相同；且股市各因素间相互关系错综复杂，主次关系变化不定，数量关系难以提取及定量分析，因此我们需要寻找一种好的方法来避免或减弱这些因素的影响。

1．金融时序时间小波预测原理

现在常用的时间序列分析法主要是建立自回归模型（AR）、移动平均模型（MA）、自回归—移动平均模型（ARMA）和齐次非平稳模型（ARIMA），其中ARIMA模型是较成熟的模型，常被用来对股价（最高价、最低价、开盘价、收盘价）及综合指数进行预测，通过选择模型的参数和辨识模型的系数实现对时间序列的拟合，进而用拟合好的模型对未来进行预测。然而以上这些预测方法对于平稳时间序列均有较好的作用，对于非平稳时间序列则表现得不尽如人意。

小波函数具有自适应性和变焦特性，能有效地处理非平稳信号，可以将信号分解到不同的频率通道上。由于分解后的信号在频率成分上比原始信号单一，并且小波分解后对信号做平滑处理，然后重构分解信号，这样非平稳时间序列经过处理后，成为近似意义上的平稳时间序列，就能用一些传统的预测方法对分解重构后的时间序列进行预测了。

采用小波进行金融时序数据预测的原理如下：使用Mallat算法对数据进行分解，对分解后的数据进行平滑处理，然后再进行重构，而重构之后的数据就成为近似意义的平稳时间序列，这样就得到了原始数据的近似信号，再应用AIC准则定阶法判定AR［p］模型的阶数。用最小二乘法估计参数at的自相关系数p是否趋近于零。若趋近于零，模型适用，然后用AR［p］模型对重构后的数据进行预测，将预测结果与实际值进行比较.，再与直接利用AR［p］模型对数据进行预测得到的预测误差均方根值进行比较，得出结论如图12-2所示。

图12-2　金融时序数据预测中小波方法和传统方法的区别

2．信号的小波分解与重构

1）信号的分解

通常小波分解与重构可以通过Mallat算法来实现，设｛vt
｝是L2
（R）中的一个多尺度分析，
为尺度函数，｛ψf
，n｝f，n
为小波基，则通过Mallat算法有分解式：

可以简记为：

上式中，H和G分别为低通滤波器和高通滤波器。将c0
定义为原始信号X，于是可以将X分解为d1
，d2
，…，dj
和cj
（j为最大分解层数），cj
和dj
分别称为原始信号在分辨率2－j
下的逼近信号和细节信号。各层细节信号和逼近信号是原始信号X在相邻的不同频率段上的成分。

采用Mallat算法进行小波分解，每一次分解后得到的细节信号和逼近信号比分解前的信号点数减少一倍，经平滑处理后，用Mallat算法将分解后的信号进行重构。

2）信号的重构

重构算法描述如下：

Cj
＝H*
Cj＋1
＋G*
Dj＋1
，j＝J－1，J－2，…，0

其中，H*
和G*
分别是H和G的对偶算子，采用重构算法对小波分解后的信号进行重构可以增加信号的点数。对d1
，d2
，…，dJ
和CJ
分别进行重构后，得到D1
，D2
，…，DJ
和Cj
，且D1
＝｛d11
，d12
，…，d1n
｝，…，DJ
＝｛dJ1
，dJ2
，…，dJn
｝，Cj＝｛CJ1
，CJ2
，…，CJn
｝，它们和原始信号X的点数一样，并且有：

X＝D1
＋D2
＋…＋DJ
＋|CJ

式中D1
，D2
，…，DJ
分别为第一层、第二层、…、第J层细节信号的重构结果，XJ
∶｛XJ1
，XJ2
，…，XJN
｝为第J层逼近信号的重构结果，因此：

Xji
＝D1，i
＋D2，i
＋…＋DJ，i
＋|CJ，i

3．AR［p］模型预测方法

1）自回归模型AR［p］

时间序列｛xt
｝|t＝1，2，…，N｝的AR［p］模型表示为：

xt
＝
1
xs，t－1
＋
2
xs，t－2
＋…＋
M
xs，t－M
＋at

称为p阶自回归模型，方差为
的独立正态分布，其中实数
1
，
2
，…，
n
称为模型参数，也称自回归参数，p称为模型的阶数，at
表示残差，且满足如下条件：

（1）满足均值为零：E（at）＝0。

（2）相互独立，且方差为

（3）服从正态分布：

（4）at
与前一时刻的Xt-k
（k＞0）互不相关，即：

E（at
Xt-k
）＝0）（k＞0）

（5）通常称at
为白噪声，由于
所以at
的谱密度存在，即：

可见谱密度是常数，表示在各频率上有相同分量，正如白色光等量地包含了各种有色光的光谱分量一样，因此称为白噪声，普遍存在于各种波动或干扰现象中。显然，白噪声是理想的随机序列。在实际过程中，序列的前后时刻往往都存在相关性和记忆性。这种人为的相互独立或无记忆序列，能够为构造更复杂的数学模型提供方便条件，也称为新信息序列，在时间序列分析的预报理论中具有重要应用。

2）AR［p］模型预测方法

首先要应用AIC准则定阶法对AR［p］模型进行阶数的判定。已知时间序列｛xt
|t＝0，±1，±2，…，｝，设定一个拟合模型的最高阶数L，则AR［k］模型AIC定阶步骤如下：

（1）计算自相关系数x和偏相关系数X，x＝R/R0
，其中R为自协方差函数，偏相关系数X则通过求解Yule-Walker（Y-W）方程得到，Y-W方程：

（2）令：

式中，U是AR（k）模型残差方差，记AIC（k）＝log（U（k））＋2k/N。

（3）在1≤k≤1范围内，如果当k＝p时，AIC（k）＝min，则适用的模型为AR［p］。图12-3给出了AIC准则定阶法的流程框图。

图12-3　AIC准则定界法流程

然后对给定的｛xt
｝建立AR［p］模型进行适应性检验，其中最根本的是检验at
是否为白噪声。对AR［p］模型进行参数估计和适应性检验后，就可以用所建立的AR［p］模型对时间序列｛vt
｝进行预测了。

我们假设已知｛ti
|i≤M｝时刻的xt
值，要预测k步以后的状态值，即求xm＋k
的值。

那么对每个Ds
＝｛ds，1
，ds，2
，…ds，m
｝，1≤s≤J及Cf
＝｛Cf，1
，Cf，2
，…Cf，m
｝分别建立AR模型，共计J个AR模型，即令：

并用已知的
分别对这J个AR［p］模型进行参数估计和模型检验。

定义3：
为在t时刻对未来k步的预测值，et
（k）为预测误差，即：

et
（k）＝xt＋k
－xt
（k）

并称预测误差et（k）的方差为最小时的
值为最佳预测。对于AR［p］模型，其最佳预测值的计算式为：

在上述经过检验合适后的J个AR［p］模型中使用这个最佳预测公式，分别对每个ds，M＋k
（S＝1，…，J）和CJ，M＋k
进行预测，得预测值
和
这样则可得到XM＋k
的预测值：

4．A股实证

案例　基于小波分析的金融时序数据预测

1）实验步骤

利用Mtlab软件，对金融数据的预测可以按以下步骤进行。

（1）对原始数据进行分解，本案例采用Mallat算法对数据进行分解，然后对信号进行平滑处理，用低通函数与原始信号卷积实现平滑处理，然后对经过平滑处理的信号进行重构。

（2）检验处理后的数据是否符合AR［p］建模要求，计算自相关系数x，x＝R/R0
，其中R0
为自协方差函数。

（3）通过求解Y-W方程，求得偏相关函数X。

（4）计算10阶以内的模型残差方差U和AIC值，应用AIC准则为模型定阶，AIC准则：

AIC（k）＝nlog（U（k））＋2k/N

（5）检验｛at｝是否为白噪声，求｛at｝的自相关系数p，看其是否趋近于零，若趋近于零，模型适用；否则，模型不适用。

（6）本案例中判定模型阶数为7，利用AR［7］模型的方程对重构后的数据进行预测，AR［7］模型方程为：

X（t）＝W（1）×X（t－1）－W（2）×X（t－2）－W（3）×X（t－3）－W（4）×X（t－4）－W（5）×X（t－5）－W（6）×X（t－6）－W（7）×X（t－7）＋a

2）实证结果

本案例取深发展A股股票2005年1月4日到2005年12月30日的每交易日的收盘价格（共有227个交易日）作为已知时刻的值，用上述小波变换的方法来预测2006年1月1日到2006年1月7日的6个交易日的股票收盘价的值，并与实际值相比较。

首先给出原始数据图，如图12-4所示，对上述数据用小波进行分解，并对分解后的数据做平滑处理，然后重构得到原数据的近似信号，这时数据走势如图12-5所示。

图12-4　深发展A股票收盘价2005年227个交易日的股价走势

图12-5　深发展A小波重构

通过比较可以看出，进行小波变换后，时间序列趋于平稳，我们将其看做原始数据的近似信号，利用AR［7］模型对原始数据的近似信号进行逼近，时间区间为2006/1/1—2006/1/7，共有6个交易日的原始数据，结果如表12-1所示。从表中可以看到，预测的总体趋势和实际股票价格的走势一致，预测的效果很好。

表12-1　深发展A日收盘价小波分析方法预测值与实际值比较 

在小波分析预测方法中，还存在分解层数的问题。小波越往下分解，信号频段划分得越细，细节信号和近似信号的平稳性就越好，这样预测值会比较精确。但实际上，由于分解过程中本身存在计算的误差，层数越多，误差就会越大，这样这种误差就会影响预测值。因此在选择层数时不宜过多，也不宜过少。表12-2给出了采用小波分析方法进行预测时，分解层数分别为1～6层时的预测误差均方根值。

表12-2　不同分解层数的误差均方根值 

通过以上案例实证，可以看到小波预测方法在预测处理金融数据这类非平稳的时间序列时，预测的结果与实际值很接近，效果较好。虽然所预测的结果仍会出现个别偏大或者偏小的值，但是可以看出小波方法预测的效果同传统的预测方法相比较，其具有一定的可靠性，用于预测股价的短期（六、七天）走势，效果比较好。同时也可以发现，一般当分解层数在2～3层时，预测效果比较好。

第13章　支持向量机

◆摘要◆

SVM算法是一种学习机制，是由Vapnik提出的旨在改善传统神经网络学习：方法的理论弱点，最先从最优分类面问题提出了支持向量机网络。SVM学习算法根据有限的样本信息在模型的复杂性和学习能力之间寻求最佳折中，以期获得最好的泛化能力。SVM在形式上类似于多层前向网络，而且已被应用于模式识别、回归分析、数据挖掘等方面。

支持向量机这些特点是其他学习算法（如人工神经网络）所不及的。对于分类问题，单层前向网络可解决线性分类问题，多层前向网络可解决非线性分类问题。但这些网络仅仅能够解决问题，并不能保证得到的分类器是最优的；而基于统计学习理论的支持向量机方法能够从理论上实现对不同类别间的最优分类，通过寻找最坏的向量，即支持向量，达到最好的泛化能力。

SVM总的来说可以分为线性SVM和非线性SVM两类。线性SVM是以样本间的欧氏距离大小为依据来决定划分的结构的。非线性的SVM中以卷积核函数代替内积后，相当于定义了一种广义的距离，以这种广义距离作为划分依据。

模糊支持向量机有两种理解：一种是针对多定义样本或漏分样本进行模糊后处理；另一种是在训练过程中引入模糊因子作用。

SVM在量化投资中的应用主要是进行金融时序数列的预测。根据基于支持向量机的时间序列预测模型，先由训练样本对模型进行训练和完备，然后将时间序列数据进行预测并输出预测结果。

本章介绍的第一个案例是一种基于最小二乘法的支持向量机的复杂金融数据时间序列预测方法，大大提高了求解问题的速度和收敛精度。相比于神经网络预测方法，该方法在大批量金融数据时间序列预测的训练时间、训练次数和预测误差上都有了明显提高，对复杂金融时间序列具有较好的预测效果。

第二个案例是利用SVM进行大盘拐点判断，由于使用单一技术指标对股价反转点进行预测存在较大的误差，所以使用多个技术指标组合进行相互验证就显得特别必要。SVM由于采用了结构风险最小化原则，能够较好地解决小样本非线性和高维数问题，因此通过构造一个包含多个技术指标组合的反转点判断向量，并使用SVM对技术指标组合向量进行数据挖掘，可以得到更加准确的股价反转点预测模型。

13.1　基本概念

SVM算法是一种学习机制，是由Vapnik提出的旨在改善传统神经网络学习方法的理论弱点，最先从最优分类面问题提出了支持向量机网络。

SVM学习算法根据有限的样本信息在模型的复杂性和学习能力之间寻求最佳折中，以期获得最好的泛化能力。SVM在形式上类似于多层前向网络，而且已被应用于模式识别、回归分析、数据挖掘等方面。支持向量机方法能够克服多层前向网络的固有缺陷，它有以下几个优点：

（1）它是针对有限样本情况的。根据结构风险最小化原则，尽量提高学习机的泛化能力，即由有限的训练样本得到小的误差，能够保证对独立的测试集仍保持小的误差，其目标是得到现有信息下的最优解，而不仅仅是样本数趋于无穷大时的最优值。

（2）算法最终将转化成一个二次型寻优问题，从理论上说，得到的将是全局最优点。

（3）算法将实际问题通过非线性变换转换到高维的特征空间，在高维空间中构造线性判别函数来实现原空间中的非线性判别函数，这一特殊的性质能保证机器有较好的泛化能力，同时它巧妙地解决了维数灾难问题，使得其算法复杂度与样本维数无关。

13.1.1　线性SVM

1．线性可分SVM数学模型

设给定的训练集为｛（x1
，y1
），（x2
，y2
），…，（xl
，yl
）｝，其中x∈Rn
，y∈｛－1，1｝。再假设该训练集可被一个超平面线性划分，该超平面记为（w·x）＋b＝0。

如果训练集中的所有向量均能被超平面正确划分，并且距超平面最近的异类向量之间的距离最大（即边缘最大化），则该超平面为最优超平面。

其中距离超平面最近的异类向量被称为支持向量，一组支持向量可以唯一地确定一个超平面，两类支持向量间的距离叫分类间隔。

离超平面最近的样本点（支持向量）满足：

（w·xi
）＋b＝1，若y＝1

（w·xi
）＋b＝－1，若y＝-1

支持向量到超平面的距离为：|（w·xi
）－b|/‖w‖＝1/‖w‖，支持向量之间的距离为2/‖w‖，即为分类间隔，因此构造最优超平面使分类间隔最大化的问题就转化为如下的最优化问题：

目标函数是严格上凹的二次型，约束函数是下凹的，这是一个严格凸规划。按照最优化理论中凸二次规划的解法，可以把它转化为Wolfe对偶问题来求解。

构造Lagrange函数：

式中，αi
是Lagrange乘子，它应满足条件
（Kuhn-Tucker），即
和

将这两式代回Lagrange函数中，消去w和b，经运算得到最优化问题的Wolfe对偶问题，即：

其解是最优化问题的整体最优解。解出α后利用
确定最优超平面，应该注意只有支持向量所对应的Lagrange乘子αi
才不是0。

基于最优超平面的分类规则就是下面的判别函数：

式中，b作为偏移值，取值如下：

式中，x*
（1）表示属于第一类的某个（任一个）支持向量：x*
（－1）表示属于第二类的某个支持向量。

利用Wolfe对偶问题，不但使问题更好处理，而且使样本在新问题中仅以向量点积的形式出现，正是这一重要特点，使支持向量方法能推广到非线性情况。由于Wolfe对偶问题带来了这样好的副产品，现在对SVM所做的研究一般都从Wolfe对偶问题开始，而不将其最初的数学提法作为优化目标。

2．线性不可分情况的处理

为了使SVM算法能应用于不可分情况，Cortes和Vapnik在1995年引入了软边缘最优超平面的概念，引入非负变量ξi
，将约束条件放松为：

yi
（w·xi
＋b）－1≥1－ξ，i＝1，2，…，l

同时对目标函数引入惩罚项：

求解这个二次规划问题，最终推导所得的Wolfe对偶问题与线性可分的情况如下：

唯一的区别在于对αi
加了一个上限限制。

13.1.2　非线性SVM

上一节的算法针对的是输入空间存在线性判别面的情况。对分类面是非线性函数的情况，理论上应将输入空间通过某种非线性映射，映射到一个高维特征空间，在这个空间中存在线性的分类规则，可以构造线性的最优分类超平面。但是这种方法带来了两个问题；一是概念上的问题，怎样在如此高维的空间中找到一个推广性好的分类超平面；二是技术上的问题，如何处理高维空间中的计算问题。

前面我们把寻找最优超平面最终归结为其Wolfe对偶问题，一个很重要的副产品就是找到了一个克服维数灾难、解决技术上问题的绝好方法。如果数学上可以找到一个函数K∶（Rn
，Rn
）→R，使得K（xi
，xj
）就等于xi
、xj
在高维特征空间中的映射的点积，那么用K（xi
，xj
）代替Wolfe对偶问题中xi
和xj
的点积即可，计算量将会大大减少。事实上确实存在这样的函数，Vapnik称之为卷积核函数，于是我们只需在输入空间中计算卷积核函数，而不必知道非线性映射的形式，也不必在高维特征空间中进行计算。

通过上一节已经看到，线性SVM是以样本间的欧氏距离大小为依据来决定划分的结构的。非线性SVM中以卷积核函数代替内积后，相当于定义了一种广义的距离，以这种广义距离作为划分依据。也许并不一定所有的学习机器都要以样本间距离作为划分依据，但是对于面临的很多问题来说，把距离近的样本划分在一起确实是理所当然的。

我们自然会提出这样的问题：怎样选择核函数？核函数的性质会对学习机器的推广能力起决定作用吗？幸运的是，实验表明，采用不同种类核函数的学习机器表现出了大致相同的性能，它们找到的支持向量大致相同。多项式分类器、径向基函数、两层神经网络等都是常用的SVM的核函数。

首先将输入向量x通过映射Ψ：Rn
→H映射到高维Hilbert空间H中。设核函数K满足：K（xi
，xj
）＝Ψ（xi
）·Ψ（xj
）

则二次规划问题的目标函数变为：

与线性情况有所不同的是：尽管在高维特征空间中线性判别面的法向量w仍可表示成这个空间中支持向量的线性组合，但由于将输入空间映射为高维空间的是非线性映射，这种线性组合关系在输入空间中不再表现为线性组合，我们又不可能把工作样本映射到高维空间再做判别，所以就需要重新考虑工作样本的决策问题。在训练完成之后，只需计算下列函数的符号即可：

式中，b作为偏移值，取值如下：

式中，x*
（1）表示属于第一类的某个（任一个）支持向量：x*
（－1）表示属于第二类的某个支持向量。

如果支持向量很多，则决策阶段的计算量也会较大。所以在实际应用中，如果训练集比较大而且得到的支持向量很多，在牺牲一点分类精度的情况下可以按一定规则舍弃一些支持向量来增加分类速度，这对时间有要求的实时系统是很有必要的。

通常，不需显式地知道Ψ和H，只需选择合适的核函数K就可以确定支持向量机。Mercer定理给出了核函数K满足上式的充要条件：

对任意满足∫g（x）2
dx＜∞的函数g（x），式∫∫K（x，y）g（x）g（y）dxdy≥0成立。

选择不同形式的核函数K就可以生成不同的支持向量机，常用的有以下几种：

（1）多项式SVM（d＝1）时候为线性核：K（x，y）＝［（x·y）＋1］d
。

（2）径向基函数SVM：

（3）Sigmoid函数SVM：K（x，y）＝tanh（k（x·y）＋δ）。

概括地说，支持向量机就是首先通过用内积函数定义的非线性变换将输入空间变换到一个高维空间，然后求（广义）最优分类面。SVM分类函数形式上类似于一个神经网络，输出的是若干中间层节点的线性组合，而每个中间层节点对应于输入样本与一个支持向量的内积，如图13-1所示。

图13-1　支持向量机结构

其中输入层用于存储输入数据，并不做任何加工运算；中间层是通过对样本集的学习，选择K（x，xi
），i＝1，2，3，…，L；最后一层就是构造分类函数：

整个过程等价于在特征空间中构造一个最优超平面。

支持向量机的作用之一就是分类，根据分类的任务，可以划分为一分类、二分类及多分类。对于多类分类问题，可以用若干种手法将其分解为若干个二分类问题叠加。

13.1.3　SVM分类器参数选择

与传统的神经网络方法相比，支持向量机具有更出色的性能，它采用结构风险最小化原则，能在经验风险与模型复杂度之间做适当的折中，从而获得更好的推广能力。但是，支持向量机在实际应用中，关于参数选择的问题仍然没有得到很好的解决，如多项式学习机器的阶数问题、径向基机器中的函数宽度，以及Sigmoid机器中函数的宽度和偏移等。统计学习理论目前对这些问题给出了一些建议和解释，但还没有给出实际可行的方案，目前也只有通过实验方法来确定最佳参数。因此，在使用支持向量机进行分类和预测时，如何选择适当的参数就成了一个非常重要的问题。

由SVM基本算法可以看出，支持向量机判决函数的依据是支持向量机和偏移值，而支持向量是由训练集中的一部分组成的，不同的训练集中训练出来的支持向量和偏移是不一样的，所以SVM分类器性能对训练集数据选取很敏感。为了提高支持向量机的分类性能，通常需要不断调整训练集，并对其进行多次反复的训练，对一个具体分类器找到最佳训练集，即找到分类中用于判别的支持向量，这就是系统的再学习过程。为了选择一个SVM分类器较优的参数，前提是要确定一个好的训练集。比较常用的方法是先用训练集一部分样本训练，通过实验得到SVM对这个训练集的最佳参数，找出对这个训练集中分类错误的样本，这时把这些分类错误的样本再加到训练集中，重新使用新的样本集训练测试SVM，一直到最佳参数。若分类结果不满意再重复上述过程。

对于确定的训练样本集，研究表明支持向量机RBF核具有较为优越的性能，所以实验中通常选择RBF核函数。RBF核函数实验中需要调试的参数是惩罚系数C和径向基宽度σ，关于这两个参数的选择，使用交叉选择的方法可以快速达到最优解。一般来说，C的取值一般为29
＞C＞21
，σ的取值一般小于28
＞σ＞21
，所以可以先把C的值确定为9个，即（21
，22
，…29
，），同样σ的值确定为8个，这样再根据经验选择以上组合，可以快速达到较优的结果。可以先确定其中一个值，然后微调另一个值，得到分类结果，调好一个参数后再固定它，微调另一个参数，直到达到最佳。

13.1.4　SVM分类器从二类到多类的推广

最初提出SVM方法是针对二类分类问题的，但是它可以很方便地扩展到多类问题的划分中。一般多类支持向量机分类有如下两种方法：①通过某种方式构造一系列的二类分类器并将它们组合在一起来实现多分类；②将多个分类面的参数求解合并到一个最优化问题中，通过求解该最优化问题一次性实现多类分类。

第二种方法看起来简洁，但是它在多类中要解决更大规模的二次优化问题，在求解精度和分类时间上相比于第一种方法都不占优势。实际常用的SVM多类别分类是第一种方法，其中二类别的分类器组合有一对一、一对多和多对多3种组合方法。

（1）一对一方法需构造所有可能的二类分类器，如针对N类问题需构造N（N－1）/2个分类器。待分类样本通过所有的分类器分类，最后通过投票表决决定样本的归属。该方法的特点是分类器数量多，计算量比较大，且存在混分样本（即产生多义性的样本，一个样本被分成多类）问题。

（2）一对多方法是用一类和剩下其他所有类判别分类，针对N类分类问题只需构造N个二类分类器，如第i个分类器将第i个类中的训练样本作为正的训练样本，而将其他的训练样本作为负的训练样本，待分类样本通过所有的分类器分类，找出属于正类的一个，就是分类结果。这种方法相对分类器数目少，结构比较简单且达到同样多类别分类效果，缺点就是存在混分和漏分样本问题。

（3）多对多分类主要有决策树算法。先把多类划为两大类，再在两类中继续往下划分，直到最后的一对一类判别。这种方法虽然未出现混分或漏分样本，N类别分类只需要构造N－1个分类器，分类效率也高，但是不同的决策树导致分类结果也不同，不具有很好的推广性。

13.2　模糊支持向量机

目前学术界对模糊支持向量机定义有两种理解：一种是针对多定义样本或漏分样本进行模糊后处理；另一种是在训练过程中引入模糊因子作用。下面分别进行介绍。

13.2.1　增加模糊后处理的SVM

支持向量机的提出是针对二类分类，当推广到多类分类时会存在一些混分和漏分样本。要提高分类精度，就需要对这些漏分和混分样本进行再处理，采用模糊隶属度再分类的方法，称之为增加模糊后处理的支持向量机。下面简要介绍一下模糊后处理过程。以一对多SVM多类分类器为例，假设将类别i和其他类区分的判决函数为：

超平面Di
（x）＝0形成最优分类面，那些属于第i类的支持向量则满足Di
（x）＝1，而属于其他类的支持向量则满足Di
（x）＝－1。实际应用时，对于输入向量x，若：

Di
（x）＞0

只有一个i类判决函数满足，则x被划分为类别i；但当x满足多个i类判别函数时，则产生混分；或当x没有满足一个类判别函数，则x不可分。

为了处理这样的情况，对数据点在得到相同分类结果的情况下引入模糊隶属度函数。具体来说，对类别i在垂直于最优分类面Dj
（x）＝0的方向上定义一个一维的隶属度函数mi，j
（x）：

当i＝j时：

当i≠j时：

既然当Di
（x）≥1时只有第i类的训练样本数据，那么可以假设此时i的隶属度为1，否则就是Di
（x）。这是因为数据点相对于分类方向的关系，允许负隶属度的存在。在i≠j的情况下，第i类的样本处于相对类面Dj
（x）＝0为负值的那一半区域，在这种情况下，假设Dj
（x）＜-1时类别i的隶属度为1，其他情况下则为-Dj
（x）。

通过对mi，j
（x）（j＝1，…，n）求最小值来定义类别i的隶属度函数

于是可以将向量x归入类别
满足：

且有mi
（x）＞0和mi
（x）≤0（j≠i，j＝1，…，n），那么就将向量x归入到类别i。这等价于只满足一个i值的情况。假设式满足i1
，…，il
（l＞1），那么mk
（x）给定义如下：

（1）

（2）

这样就可以在mk
（x）（k＝i1
，…，il
）中取隶属度的最大值，即在k∈｛i1
，…，il
｝时Dk
（x）是最大的，设任何类别都不满足，即：Di
（x）＜0，j＝1，…，n。

在实现模糊再分类时，其分类步骤如下：

（1）对向量x，如果只有一类满足Di
（x）＞0，则将x归属该类，否则跳转到步骤（2）。

（2）如果Di
（x）＞0满足两个及两个以上的类别i（i＝i1
，…il
，l＞1），则将输入x归入最大Di
（x）（i∈｛i1
…il
｝）所在类别i，否则跳转到步骤（3）。

（3）如果对所有的类别都有Di
（x）≤1，则将输入x归入绝对值最小的Di
（x）（i∈｛i1
，…，il
｝）所在的类别i。

13.2.2　引入模糊因子的SVM训练算法

SVM算法中存在一个问题，那就是对孤立样本或噪声样本比较敏感，算法对那些两类线性可分的情况没什么问题，但是在线性不可分的情况下，如何设定惩罚系数C就比较关键了。从分析SVM算法的训练过程可以看出，C越大就意味着对错误的惩罚越大，也就减少了分类错误，但分类间隔小了，会导致推广性不好。相反地，C的值小会增加一些错误，但是得到了更大的分类间隔，也将得到更好的推广性。

不管C的值是大是小，在训练过程中一旦确定了就是固定的，也就是说对每个样本被等同对待，即对每个样本的额惩罚是一致的。这就导致了训练过程对那些少量的特殊样本（如噪声样本和孤立样本）过分敏感。为此我们在训练过程中引入模糊因子，针对不同样本给予不同的隶属度，以强调重要样本对分类的贡献，称之为引入模糊因子的模糊支持向量机。

设有一个n个数据的训练集｛xi
，yi
｝，（i＝1，…，n），其中xi
为训练数据集，yi
为训练目标，xi
∈Rn
，y∈｛－1，1｝，常规支持向量机训练算法通常没有考虑训练样本对分类的贡献，引入一个模糊因子si
，表示训练样本对类中心的隶属程度，定义为：

式中，
表示某类聚类中心：σ2
为常数，按实际需求取值。由公式可以看出：0＜Si
≤1，当xi
偏离聚类中心x越远时，si
越小，即xi
隶属于该类的可能性越小。

该方法就是为训练数据集增加一个属性si
，即（xi
，yi
，si
）。将线性可分与线性不可分归并到一个情况考虑，引入松弛因子ξi
，如果分类超平面为ω*
xi
＋b＝0，满足约束：

其中ξi
＝0表示线性可分，其他表示线性不可分。

最后该模糊支持向量机方法可由如下二次规划过程实现：

与普通的SVM训练算法不同的是，该类模糊支持向量机在训练二次规划过程的约束条件中加入可变的si
（0≤Si
≤1）数，强调样本对分类的不同贡献，从而得到模糊训练的目标。

13.3　SVM在量化投资中的应用

13.3.1　复杂金融时序数据预测

本节介绍一种基于最小二乘法的支持向量机（Least Square Support Vector Machine, LS-SVM）的复杂金融数据时间序列预测方法，大大提高了求解问题的速度和收敛精度。相比于神经网络预测方法，该方法在大批量金融数据时间序列预测的训练时间、训练次数和预测误差上都有了明显提高，对复杂金融时间序列具有较好的预测效果。

1．时间序列预测模型

金融时间序列数据种类繁多而且存在很多噪声，需对采集到的数据进行预处理，对输入的时间序列分为训练模型的样本和待预测的时间序列数据样本。根据基于支持向量机的时间序列预测模型，先由训练样本对模型进行训练和完备，然后将时间序列数据进行预测并输出预测结果。整个金融数据的预测过程主要涉及以下几个主要的问题。

1）数据预处理

为了提高模型预测的精度，先将数据进行零化处理和归一化处理，得到新的时间序列l，Y＝｛x1
，x2
，...，xn
｝，假设原始的时间序列Y（t）由正常趋势Z（t）和噪音信号N（t）组成，即Y（t）＝Z（t）＋N（t）。数据预处理的目的是希望通过噪音过滤产生一个反映一般趋势的信号Z（t）。

2）SVM时间序列预测模型的训练并预测

运用标准SVM预测海量金融时间序列数据，有时会出现训练速度慢、内存开销大等问题。这里采用最小二乘支持向量机对金融时间序列进行预测研究。假设训练样本集T＝｛xk
，yk
）｛k＝1，2，...，n｝，xk
∈Rn
，yk
∈R，xk
是输入数据，yk
是输出数据。在原始空间（ω空间）的优化问题可以描述为：

约束条件yk
＝ωT

（xk
）＋b＋ek
，k＝1，2，…，N。其中，
（·）∶Rn
→Rm
是核空间映射函数，权向量ω∈Rn
，误差变量ek
∈R，b是偏差量，损失函数J是误差和规则化量之和，γ是可调常数。核空间映射函数的目的是从原始空间中抽取特征，将原始空间中的一个样本映射为高维空间中的一个向量，解决原始空间中线性不可分的问题。根据公式（1），定义Lagrange函数为：

其中Lagrange乘子ak
∈R。对公式（2）进行优化得：

其中，k＝1，2，3，…，N。

矩阵方程为：

式中，y＝（y1
，y2
...yn
）;lv
＝（1，2....t），α＝（a1
，a2
....an
），ΩM
＝
（xk
）T

（xt
）k，＝1，2...，N。根据Mercer条件，存在映射函数
和核函数，K（·，·），使得：

LS-SVM最小二乘向量机的函数估计为：

其中a、b由公式（4）求解出，应用Gausss径向基核：

2．时间序列预测算法

利用SVM技术对股票价格进行预测的主要过程可以包括训练数据准备、训练参数输入、学习样本输入、模型训练学习、评估训练结果、训练参数优化等一系列循环的过程，如图13-2所示。

图13-2　利用SVM进行金融时序数据预测的流程

最小二乘支持向量机是支持向量机的一种改进，它将传统的支持向量机中的不等式约束改为等式约束，且将误差平方和的损失函数作为训练集的经验函数，这样就把二次规划问题转化为求解线性方程组的问题，提高求解问题的速度和收敛精度。采用最小二乘支持向量机对金融时间序列数据进行预测，预测的算法简单描述如下：

（1）输入：金融时间序列数据（训练样本和待预测时间序列数据）：

Y＝｛x1
，x2
，x3
，…，xt
｝，1≤t≤n

（2）输出：时间序列数据预测结果：

①获取金融时间序列。对输入的时间序列数据Y＝｛x1
，x2
，x3
，…，xn
｝进行零化处理和归一化处理，得到时间序列Y（t）＝Z（t）＋N（t）。

②数据预处理。对原始时间序列Y（t）进行离散Fourier变换得到频域Y（z），滤去噪音数据，然后进行Fourier反变换得到新的时间序列

③选择合适的训练样本，设定误差变量ek，偏差量b和可调常数γ。

④选取径向基（RBF）核函数：

依据训练样本，采用最小二乘支持向量机进行模型训练，得到估计函数
完成模型训练。

⑤输入待预测的时间序列数据，进行基于LS-SVM的时间序列预测：

⑥用
和
对得到的预测结果进行评估，评价预测效果，如不满足要求则跳到步骤④重新训练模型。

这里采用的数据是2006年9月8日到2007年1月8日的沪深300全收益指数的198个数据点，通过某天前一段时间的收盘价预测本日的收盘价，前184天的数据用于建立预测模型，后15天的数据用于模型预测效果检验。

3．实证结果

案例　基于SVM的复杂金融时序数列预测

通过对预测模型的多次训练，分别选择不同的训练样本，产生比较合适的训练模型，然后对后若干天的数据进行预测。实验中对后15天的沪深300指数进行预测，效果如表13-1所示，其中，MAPE为平均相对误差，RMSE为均方根误差。

表13-1　SVM沪深300指数预测误差情况 

从预测结果中可以看出，基于LS-SVM的时间序列预测效果能够比较真实地逼近实际指数，取得了满意的预测效果，预测的误差也比较小。但也由于证券的实际指数受很多复杂因素的影响，所以在某些点上预测的效果与实际指数还是有很大的偏差。但总的来说，基于LS-SVM的时间序列预测模型训练速度比较快，训练次数也相对较少，比传统的时间序列预测方法在效率和精度上都有了进一步提高。

在实证中，同基于神经网络的时间序列预测方法进行了对比。其中神经网络预测模型采用了RBF神经网络进行训练，得到如表13-2所示的实验结果。可以看出，基于LS-SVM的时间序列预测算法比基于神经网络的预测方法具有更好的预测效果，而且训练速度比较快。

表13-2　SVM指数预测和神经网络预测的比较 

总而言之，这里介绍的是最小二乘法向量机的金融时间序列预测模型和预测算法，并和基于网络神经的时间序列预测算法进行了对比实验。结果表明，预测精度和各项误差都有了一定的改进。LS-SVM具有神经网络的优势，且有效克服了神经网络的缺点，显示出训练速度快、运行效率较高等特点。

13.3.2　趋势拐点预测

股票市场瞬息万变，投资者都希望能够预测股市未来的行情走势以获得更多的收益。而为了达到这个目的，寻找股价反转点就成为了一个关键点。如果能够较早判断股价的反转点，做到高抛低吸，投资者就能够获得丰厚的投资回报。

目前较为常用的3种反转点预测分析方法分别是：形态分析、趋势分析和技术分析。

（1）形态分析的基本原理是对于股价走势图形的挖掘，发现股价走势图若呈现某种形态时，预告未来价格走势的发展。使用形态分析方法判断反转点，其优点是简单易懂，缺点是判断时容易加入个人主观判断、准确率低等。

（2）趋势分析主要包括道氏理论和波浪理论。趋势分析认为，价格走势存在着某种趋势，并且在没有证据来确认趋势改变之前，应假定趋势未改变。趋势周而复始，重复发生，趋势分析也存在着因为主观判断的差异而导致判断结果迥异的情况。

（3）技术分析是通过总结股市历史变化规律，把股市的各种变化数值化，使其容易被投资者接受。使用技术指标判断反转点时，通常会根据技术指标数值判断当前状态是否为超买或超卖，以此判断股价是否已经到了反转临界点。

由于使用单一技术指标对股价反转点进行预测存在较大的误差，所以使用多个技术指标组合进行相互验证就显得特别必要。这里通过对这些技术组合进行数据挖掘，获得一个更佳的反转点预测模型。

SVM由于采用了结构风险最小化原则，能够较好地解决小样本非线性和高维数问题，因而具有较好的泛化能力。因此通过构造一个包含多个技术指标组合的反转点判断向量，并使用SVM对技术指标组合向量进行数据挖掘，可能得到更加准确的股价反转点预测模型。

1．系统架构

在进行反转点预测前，首先需要获取某只股票的历史交易数据，这些数据包括每天的开盘价、收盘价、最高价、最低价等。然后对这些数据进行预处理，并在预处理后的数据上进行反转点定义。最后抽取符合要求的技术指标组合向量，并使用SVM进行训练和预测。各部分的具体流程和方法如图13-3所示。

图13-3　SVM进行趋势拐点预测的流程

1）数据预处理

股票价格历史数据只包含了股票交易的最基本信息，要在这些历史数据上进行数据挖掘从而揭示股价反转的特征，首先需要对历史交易数据进行预处理。系统中数据预处理主要包括两方面：技术指标的计算和股票收盘价的平滑。

本案例采用了3个趋势技术指标，分别为MACD、KDJ和RSI。

（1）MACD的计算公式如下：

其中EMA（J，T）表示数值J的T日指数移动平均值，Cx
表示第x天的收盘价，S表示快速指数移动平均线的天数，L表示慢速指数移动平均线的天数，通常S取值为12，L取值为26，N取值为9。

（2）KDJ的计算公式如下：

其中，Cx
表示第x天的收盘价，CHx
表示x天内的最高价，RLx
表示x天内的最低价，通常x取值为9。

（3）RSI的计算公式如下：

其中MEANUP（C，x）表示x天内上涨收盘价的平均值，MEANDOWN（C，x）表示x天内下跌收盘价的平均值，通常x取值为12。

（4）收盘价平滑。股票每日收盘价连线最能表现股价走势，但是由于股票市场的特殊性，股票收盘价会在趋势方向上存在着一定的波动。为了消除收盘价波动对反转点定义的影响，本案例对股票收盘价进行平滑。收盘价平滑公式如下：

其中，y（n）是指第n天股票的收盘价，y′（n）是平滑后第n天股票的收盘价。同时，如果收盘价在趋势方向上的波动范围小于某一个足够小的给定值r′（r′＞0），则忽略该小波动，具体处理方式为：假设在时间序列上有4个点t1
、t2
、t3
、t4
，它们对应的股价分别是
则其变化率分别是：

如果

且
则将变化率r2
置为0。

2）反转点定义

存在着两类反转点：技术指标反转点和股价真实反转点。技术指标反转点通过对技术指标（包括MACD、KDJ、RSI）的解读定义反转点，而股价真实反转点则直接从经过平滑的股票历史收盘价得到。这两类反转点的具体定义如下：

（1）技术反转点。技术反转点的定义和图形如表13-3所示。

表13-3　技术反转点定义与图型 

（2）真实反转点。对于经过平滑处理的股票收盘价序列，假设在时间序列上有3个点t1
、t2
、t3
，它们对应的股价分别是
若
且
则称t2
点为反转向上的反转点；反之，若
且
则称t2
点为反转向下的反转点。

2．SVM反转点预测模型

在对股价真实反转点定义和技术指标反转点定义以后，抽取出真实反转点和技术指标反转点判断向量，使用SVM进行训练和测试。使用SVM进行训练和测试前的准备工作主要包括选择合适的核函数和得到适合样本的最优核函数参数。

1）核函数选择

在支持向量机中，需要选择核函数K（·，·），即一个映射
（g），把x所在的输入空间X映射到另外一个空间H，该映射只要是满足Mercer条件的正定函数即可。核函数主要有以下3种类型：

（1）多项式核：K（x，y）＝x·y；

（2）RBF核：K（x，y）＝exp（－γ||x－y||）。

（3）Fourier核：

由于RBF核函数具有良好的性态，在实际应用中表现出了良好的性能，所以这里使用RBF核函数。

2）交叉验证选择核函数参数

这里使用的RBF核函数有两个参数：C和γ，使用V-折交叉验证的方法，对训练集上的数据进行训练，从而找到最佳的参数对。

V-折交叉验证的思想是：把n个训练样本随机地分成v个互补相交的子集，即S1
，S2
，…，Sv
，每折的大小相同，然后进行v次训练预测试，即对Si
进行v次迭代。第i次迭代的具体做法是：选择Si
为测试集，其余v－1个集合的并为训练集，对这两个部分的样本集进行训练和测试，得到预测准确率。经过v次迭代，就能够得到v次迭代的平均准确率。

而对于不同的（C，γ）参数对，这里使用网格搜索的方法寻找具有最佳交叉验证平均正确率的参数对。在进行网格搜索时，可选的C和γ参数值是一个指数倍增长的序列，例如C＝2－5
，2－3
，…，215
，γ＝2－15
，2－13
，…23
。使用每个（C，γ）参数对在训练集上进行交叉验证后，可以得到一个最高平均准确率的参数对（C′，γ′），再使用这个参数对在测试集上进行测试。

3．实证结果

案例　基于SVM趋势拐点预测模型

本实证数据以上证指数为实验对象，选择1999年1月27日至2009年10月14日共2581个交易日的历史数据进行实验。对这些数据进行预处理和反转点定义，对于第i天的交易数据，可以得到如下向量：xi
∶xi1
，xi2
，xi3
。xt
∶xt1
，xt2
，xt3
分别表示该天是否为真实反转点、是否被MACD指标判断为反转点、是否被KDJ指标判断为反转点、是否被RSI指标判断为反转点。如果是反转点，则对应向量值为1，否则为0。

如果某一天的向量为xf
∶xf1
，xf2
，xf3
，若xf1
＋xf2
＋xf3
＞0，则至少有一个技术指标表示该天为反转点。将所有具有该性质的向量抽取出来以供SVM训练和预测，共提取出284条向量。

将这284条向量中的212条作为训练集，72条作为测试集，使用Libsvm进行训练和测试。在对训练集进行交叉验证和网格搜索后，得到最佳的（C，γ）参数对为（2－1
，2－1
），并使用该参数对在测试集上测试，得到SVM预测值。

可以很容易地算得使用单一技术指标（MACD、KDJ、RSI），以及用SVM对这3个技术指标组合向量进行反转点预测实验的召回率（Recall Rate）、准确率（Precision Rate）和F-Measure，这3个衡量指标的计算公式如下：

其中，a表示该天是真实反转点，且被指标判断为反转点的样本天数总和；b表示该天被指标判断为反转点，但不是真实反转点的样本天数总和；c表示该天是真实反转点，但是没有被指标判断为反转点的样本天数总和。实验结果如表13-4所示。

表13-4　SVM趋势拐点预测结果 

从实验结果可以看到，使用SVM进行反转点预测，较单一使用MACD、KDJ、RSI技术指标，召回率分别提高了35.42％、43.75％、22.91％；准确率分别提高了3.79％、5.91％、8.39％；F-Measure分别提高了20.82％、27.57％、15.22％。这说明使用SVM进行反转点预测较单一指标能够识别更多的反转点，并会对这些反转点给出较高的判断结论，以便于投资者进行投资决策。

第14章　分形理论

◆摘要◆

分形几何的诞生接近30年，但它对多种学科的影响是极其巨大的。分形理论在生物学、地球物理学、物理学和化学、天文学、材料科学、计算机图形学、语言学与情报学、信息科学、经济学等领域都有广泛的应用。

几种典型的分形包括：三分康托集、Koch曲线、Julia集等。分形的维数是重要概念，主要有拓扑维数、Hausdorff维数、容量维数和相似维数。

分形有很多不同的实现算法，但是具体哪种算法更有效、更实用则要针对不同的情况。分形的描述常用的方法有L系统和IFS系统两种，从它们所绘制出的分形来说，L系统要比IFS系统简单。L系统只是简单的字符串的迭代，而IFS系统在这方面要复杂得多，如Julia集等。

分形理论在量化投资应用中，主要是利用分形分布来预测走势的规律。研究表明，股市走势满足下面两个法则：①每个单位时间内的股票价格变动分布，服从特性指数D≈1.7的对称稳定分布；②单位时间不论取多大或多小，其分布也是相似的。也就是说，适当地改变尺度，就可成为同样的分布。

多重分形理论通过一个标度范围来描述复杂系统的局部特征，能够得到许多被简单分形方法所忽略的信息，被认为是迄今为止最为全面的描述价格波动特征的模型。

多重分形理论一个重要的应用就是Hurst指数，Hurst指数和相应的时间序列分为3种类型：当H＝0.5时，时间序列是随机游走的，序列中不同时间的值是随机的和不相关的，即现在不会影响将来；当0≤H≤0.5时，这是一种反持久性的时间序列，常被称为“均值回复”。如果一个序列在前个一时期是向上走的，那么它在下一个时期多半是向下走，反之亦然。这种反持久性的强度依赖于H离零有多近，越接近于零，这种时间序列就具有比随机序列更强的突变性或易变性；当0.5≤H≤1时，表明序列具有持续性，存在长期记忆性的特征。即前一个时期序列是向上（下）走的，那下一个时期将多半继续是向上（下）走的，趋势增强行为的强度或持久性随H接近于1而增加。

14.1　基本概念

14.1.1　分形定义

分形理论是当今世界十分风靡和活跃的新理论、新学科。分形的概念是美籍数学家曼德布罗特首先提出的，1967年他在美国权威的《科学》杂志上发表了题为《英国的海岸线有多长？》的著名论文。海岸线作为曲线，其特征是极不规则、极不光滑的，呈现极其蜿蜒复杂的变化。我们不能从形状和结构上区分这部分海岸与那部分海岸有什么本质的不同，这种几乎同样程度的不规则性和复杂性，说明海岸线在形貌上是自相似的，也就是局部形态和整体形态的相似。

在没有建筑物或其他东西作为参照物时，在空中拍摄的100千米长的海岸线与放大了的10千米的海岸线的两张照片，看上去会十分相似。事实上，具有自相似性的形态广泛存在于自然界中，如连绵的山川、飘浮的云朵、岩石的断裂口、布朗粒子运动的轨迹、树冠、花菜、大脑皮层等，曼德布罗特把这些部分与整体以某种方式相似的形体称为分形（Fractal）。1975年，他创立了分形几何学，并在此基础上形成了研究分形性质及其应用的科学，称为分形理论。有关分形的定义如下：

定义1：如果一个集合在欧氏空间中的Hausdorff维数DH
恒大于其拓扑维数DT
即：DH
＞DT
，则称该集合为分形集，简称为分形。

定义2：组成部分以某种方式与整体相似的形体叫分形。

对于定义1的理解需要一定的数学基础，不仅要知道什么是Hausdorff维数，而且要知道什么是拓扑维数，看起来很抽象，也不容易推广。定义2比较笼统地说明了自然界中的物质只要局部和局部或者局部和整体之间存在自相似性，那么这个物质就是分形。这一比较模糊的概念被人们普遍接受，同时也促进了分形的发展。

自相似原则

自相似原则和迭代生成原则是分形理论的重要原则。其表征分形在通常的几何变换下具有不变性，即标度无关性。由于自相似性是从不同尺度的对称出发，也就意味着递归。分形形体中的自相似性可以是完全相同，也可以是统计意义上的相似。

标准的自相似分形是数学上的抽象，迭代生成无限精细的结构，如Koch雪花曲线、谢尔宾斯基（Sierpinski）地毯曲线等。这种有规分形只是少数，绝大部分分形是统计意义上的无规分形。

根据自相似性的程度，分形可以分为有规分形和无规分形。有规分形是指具体又严格的自相似性，即可以通过简单的数学模型来描述其相似性的分形，如三分康托集、Koch曲线等。无规分形是指具有统计学意义上的自相似性的分形，如曲折连绵的海岸线、飘浮的云朵等。

14.1.2　几种典型的分形

1．三分康托集

1883年，德国数学家康托（G.Cantor）提出了如今广为人知的三分康托集。三分康托集是很容易构造的，然而它却显示出许多最典型的分形特征。它是从单位区间出发，再由这个区间不断地去掉部分子区间的过程构造出来的，如图14-1所示。

图14-1　三分康托集

其详细构造过程如下：

（1）把闭区间［0，1］平均分为3段，去掉中间的1/3部分段，则只剩下两个闭区间［0，1/3］和［2/3，1］。

（2）再将剩下的两个闭区间各自平均分为3段，同样去掉中间的区间段，这时剩下4段闭区间：［0，1/9］，［2/9，1/3］，［2/3，7/9］和［8/9，1］。

（3）重复删除每个小区间中间的1/3段。如此不断地分割下去，最后剩下的各个小区间段就构成了三分康托集。三分康托集的Hausdorff维数是0.6309。

2．Koch曲线

1904年，瑞典数学家柯赫构造了Koch曲线几何图形。Koch曲线大于一维，具有无限的长度，但是又小于二维，并且生成的图形的面积为零。它和三分康托集一样，是一个典型的分形。根据分形的次数不同，生成的Koch曲线也有很多种，如三次Koch曲线、四次Koch曲线等。

三次Koch曲线的构造过程主要分为三大步骤：

（1）给定一个初始图形——一条线段。

（2）将这条线段中间的1/3处向外折起。

（3）按照第（2）步的方法不断地把各段线段中间的1/3处向外折起。这样无限地进行下去，最终即可构造出Koch曲线。其图例构造过程如图14-2所示。

图14-2　Koch曲线

3．Julia集

Julia集是由法国数学家Gaston Julia和Pierre Faton在发展了复变函数迭代的基础理论后获得的。Julia集也是一个典型的分形，只是在表达上相当复杂，难以用古典的数学方法描述。

Julia集由一个复变函数：f（z）＝z2
＋c（c为常数）生成，尽管这个复变函数看起来很简单，然而它却能够生成很复杂的分形图形。如图14-3所示为Julia集生成的图形，由于c可以是任意值，所以当c取不同的值时，生成的Julia集的图形也不相同。

图14-3　Julia集生成的曲线

14.1.3　分形理论的应用

分形理论的诞生接近30年，它对多种学科的影响是极其巨大的。分形理论在生物学、地球物理学、物理学和化学、天文学、材料科学、计算机图形学、语言学与情报学、信息科学、经济学等领域都有广泛的应用。

在量化投资中，分形也具有重要的价值，例如，一般来说，股票价格变动图完全是随机的，因此使人感到几乎无规律可循。但若从统计学观点解析这一变动，就会发现有很好的规律，Mandelbrot发现下面两个法则：

（1）每个单位时间内的股票价格变动分布，服从特性指数D≈1.7的对称稳定分布。

（2）单位时间不论取多大或多小，其分布也是相似的，也就是说，适当地改变尺度，就可成为同样的分布。

关于稳态分布，只讨论与分形有关的一些性质。若把单位时间T之间的股票价格变动x的分布密度记为P（x），则下述关系成立：

此关系式表示股票价格变动的大小分布为分形。例如，一天的股票价格变动在x元以上，比2x元以上的变动次数多21.7
≈3.2倍。

法则（2）表示股票价格变动在时间上也是分形的。一天的股票价格变动图形与一年的股票价格变动图形相比，不同的只是股票价格的尺度，而对变动情况则很难加以区别。

14.2　主要内容

14.2.1　分形维数

欧氏几何学有着几千年的历史，它研究的是一些规整的图形，如直线、圆、椭圆、菱形、正方形、立方体、长方体、球体等。这些不同类型的曲线和形状都有一个共同的基础——欧氏几何，即它们可以被定义为代数方程（例如，Ax＋By＋Cz＝D）或微分方程的解集。从欧氏几何测量中，可以看出点、直线、平面图形、空间图形的维数分别是0、1、2和3，而且都是整数。

维数是几何对象的重要特征量，维数包含了集合的几何性质的许多信息。一个图形维数的大小，表示它占有空间的大小。尤其是在分形中，它对如何准确地描述图形起到了很大的作用。分形维数是判断两个分形是否一致的度量标准之一。

1．拓扑维数

在经典几何学中，维数是形体的一个重要特征量，即为了确定几何形体的每一个点在空间中的位置所需要的独立坐标的数目。在平直的欧氏空间内，形体的维数是显然的：点是零维的；线是一维的；面是二维的；体是三维的。对点、线、面、体这样的几何形体在连续拉伸、压缩、扭曲等形变下，其对应的维数是不变的，是正整数，我们称此维数为拓扑维数。

2．Hausdorff维数

测量一个几何形体大小所得到的数值N与形体维数（拓扑维数）和测量的标度（长度单位）l有密切关系。例如：

若l足够小，则上式与l无关。这对任何大小和形状的几何体都成立。对通常的几何体而言，d是整数。1919年，德国数学家豪斯多夫（F.Hausdorff）认为，可以把上式推广到维数，则d不一定取整数。人们便将此定义的维数d称为豪斯多夫维数，并记为dH
，即：

3．容量维数

豪斯多夫维数的式子是以被测几何体的容量大小来进行分析计算的，因此通常叫做容量维数，可记为do，又称盒维数，记为db。

4．相似维数

设几何体的体积压缩比为k，线度压缩比为λ，几何体的维数为d，则它们之间的关系是：k＝λd
。

将这一概念推广应用于分形，由于分形的自相似性，线度变小（缩小）仍将得到与原分形体相似的子集。

设此分形体是由k个与之相似的不相交子集所组成的，于是推广上式可得：

k＝λd
或者kλ－d
＝1

d是与此分形体的结构有关并有维数特征的特征量，称为相似维数。

除了以上维数外，还有标度关系、多重分形等关于分形结构的描述。

14.2.2　L系统

就分形的计算机实现来说，有很多不同的算法，但是具体哪种算法更有效、更实用则要针对不同的情况。分形的描述常用的方法有L系统和IFS系统两种。从它们所绘制出的分形来说，L系统要比IFS系统简单。L系统只是简单的字符串的迭代，而IFS系统在这方面要复杂得多，如Julia集等。

林氏系统（通常称L系统）是林德梅叶1968年为模拟生物形态而设计的，后来史密斯于1984年、普鲁辛凯维奇于1986年，分别将它应用于计算机图形学，引起生物学界和计算机界人士极大兴趣，一时发表了许多论文和专著。

1．L系统基本原理

L系统实际上是字符串重写系统，L系统的工作原理非常简单。如果把一个字符看做是一种操作，而且每种不同的字符解释成不同的操作。基于这种思想，那么就可以利用字符串生成各种不同的分形图形，于是只要能生成字符串，也就等于生成了图形。

L系统中生成图形的字符串可以是由任意的可识别的字符组成的，如“F”、“-”、“＋”。在程序设计中，“F”表示从当前位置向前一个单位长度，同时画线；“-”表示从当前方向顺时针旋转一个给定的角度；“＋”表示从当前方向逆时针旋转一个给定的角度。在生成字符串的过程中，先从一个称为公理的起始字符开始，再将该公理字符替换成规则中的子字符串，这是第一次迭代。然后，把子字符串作为母串，将母串中的字符用规则中的子串替代，依次类推，就可以完成L系统的迭代，其字符串的长度由迭代次数控制。

2．随机L系统

自然界中的物质形态不是固定不变的，而是随机的，尽管它们有一定的规律可寻。世界上没有完全按相同方式生长的两棵植物，即使是同一种植物，其形态也存在很大差别，如茎的高矮、开花的位置、种子的形状等，尤其是由环境的影响带来的形态变异。

例如，作物由于肥料充足而粒大穗多。基于此，从模拟植物的效果来说，用上述方法得到的图形显然有些呆板，不那么形象了。如果在保留某种植物主要特征的情况下，为了产生细节上的不同变化，以求生成的植物图形更加生动逼真，那么可以引入随机性，它的好处就是模拟出来的植物更加接近真实的事物形态。随机的L系统是有序的四元素集，其表达式为：

G＝＜V，ω，P，π＞

其中V，ω的意义和三元式相同，然而这里的P却是随机的生成规则集，π为函数，且有

3．L系统的算法

L系统侧重于植物拓扑结构的表达，它试图用抽象出来的规则描述植物的形态及生长规律，该系统具有定义简洁、结构化程度高、易于实现等优点。通常计算机生成分形图形的算法大多是所谓的迭代，在程序中的实现形式是递归调用。众所周知，递归程序与非递归程序的区别在于：递归程序很难用通常的方法来控制它的流程。虽然这一点是一个问题，但是这也是它的优点之所在，因为它的算法非常简单。正是基于递归算法的这一优点，在编制L系统程序的时候就是采用这种算法。

14.2.3　IFS系统

迭代函数系统（IFS）方法是美国佐治亚理工学院的巴恩斯利等人首先应用一组收缩仿射变换生成分形图像，即通过对原始图形（生成元）的收缩、旋转、平移等变换形成的极限图形而具有自相似的分形结构，并将该仿射变换集称为IFS。它与复平面上f（z）＝z2
＋c（z，c为复数）迭代产生的分形存在着内在的联系，只是f（z）属于非线形变换，而IFS属于线形变换。

IFS系统的理论与方法是分形自然景观模拟及分形图像压缩的理论基础，其基本思想是认为物体的全局和局部在仿射变换的意义下具有自相似结构，这就形成了著名的拼接定理。IFS方法的魅力在于它是分形迭代生成的反问题，根据拼接定理，对于一个给定的图形（比如一幅图片），求得几个生成规则，就可以大幅度压缩信息。

1．IFS系统生成图形的基本原理

二维空间R2
上的线形变换ω具有如下形式：

对于
若存在压缩因子s满足0＜s＜1，使得下式：

成立，则称ω为收缩仿射变换。该变换又可表示为：

迭代函数系统由一组收缩仿射变换｛ω1
，ω2
，ω3
，…，ωn
｝组成，二维IFS可以表示为

生成图形时，调用各变换的概率：

通过公式（1）可以生成许多构成分形图形的点，公式（2）主要是由规则的概率控制生成图形的形态。

2．IFS系统主要算法

对于IFS系统生成分形图像来说，随机迭代算法是一种高效的算法。鉴于此，在程序的实现过程中，采用了随机迭代算法。随机迭代算法是产生许多的点来构成整个的图像，这些点是循环不断地、随机地生成的。因此，在程序的编制中，可以采用线程的方法来控制点的产生速度，以及控制点什么时候产生和什么时候结束。当然，运用线程会大量消耗CPU的时间。值得一提的是，CPU的速度决定点生成的快慢。

迭代函数系统是分形图案的生成方法之一，它在分形重构方面取得的进展引起了图像压缩技术的革新，达到了用常规压缩方法无法达到的高压缩比。其主要的思想在于存储生成图像的IFS系统，而不存储生成的图像，恢复时根据IFS系统用专门的硬件生成图像。作为产生分形的方法之一，迭代函数系统在自然景物模拟及图像压缩方面具有独到之处，是一个可行的、有价值的研究领域。

14.3　分形理论在量化投资中的应用

14.3.1　大趋势预测

在资本市场中，对股票价格规律的刻画一直是各国学者广泛关注的重大研究课题。股价的大幅波动通常伴随着高风险和高收益，因此，寻求一种能够定量地解释或描述大幅股价波动的某些特征的方法，对防范和控制金融风险十分必要。

许多实证研究已经证实股票市场是一个复杂的分形客体，多重分形理论是定量描述复杂体系内部的非线性运行规律的有效手段之一，在资本市场的复杂性方面具有有效的应用。

1．多重分形模型

1）模型

将多重分形理论应用于金融分析中，则求解多重分形分布的步骤如下：

（1）将股指时间序列pi
进行归一化处理，用pi表示：Pi
＝Pi
/
Pi
，并将归一化后的时间序列分成时间长度为T的不重叠的时间窗。

（2）求出每个时间窗内（或盒子内）的价位概率Pj
（T），该价位概率等于每个时间窗内所有归一化后的时间序列的和。

（3）选取适当的q值，通过Pj
（T）计算q的配分函数：

式中：n是时间长度为T的时间窗总数，q是-∞到＋∞上的实数。对于多重分形分布，配分函数随时间长度服从如下的标度关系：

（4）根据公式（2）做出相应的lnMq
（T）－lnT曲线，如果lnMq
（T）随lnT的变化有较好的线性关系，说明此分布属于多重分形分布。lnMq
（T）－lnT曲线的斜率就是τ（q），从τ（q）中可以计算出多重分形谱f（α），其计算公式如下：

2）模型中参数的意义

α描述了时间序列中各个区间不同的奇异程度，分形谱的宽度△α＝αmax
－αmin
为最大、最小概率间的差别，它说明了整个分形结构上的归一化价格分布的均匀程度将其应用在股价指数时间序列中，则α反映了股价指数的大小，α越小，指数值越高；α越大，指数值越低。αmin
表示的是指数的最高值，αmax
表示的是指数的最低值。△α反映了指数的涨落程度。△α越大，表示股价指数波动越剧烈；△α＝0，则对应完全均匀分布的情况。

f（α）反映了所对应的指数值出现的次数。f（α）越大，则出现的次数越多。f（αmin
）和f（αmax
）是对应αmin
与αmax
子集的分形维数。f（αmin
）表示归一化价格高的股价指数出现的次数；f（αmax
）表示归一化价格低的指数出现的次数。△f＝f（αmin
）－f（αmax
）反映了最高、最低价位出现频率的变化。△f＞0，表示在每组数据中股价指数达到最高点的次数多于达到最低点的次数；△f＜0，表示在每组数据中股价指数达到最高点的次数少于达到最低点的次数。

f（α）的最大值即为多重分形谱的峰值，对应于该峰值的α记为α0
；而特征参数△α可分解为△αL
＝α0
－αmin
和△αR
＝αmax
－α0
，它们分别代表多重分形谱左右两侧的α值范围，其比值反映了左偏、右偏的程度，即多重分形谱的偏斜系数R＝△αL
/△αR
。当R＞1时，谱的顶点右偏，且值越大，向右偏斜程度越高；当R＜1时，谱的顶点左偏，且值越小，其向左偏斜程度越高；当R＝1时，谱的形状对称。

2．大趋势多重分形案例实证

案例　基于分形理论的大趋势预测

本案例对上证指数日收盘指数发生大幅波动前后的多重分形特征进行实证研究及比较。首先选择两个比较有代表性的时段，即2005/5/20—2005/6/23（大涨前后）和2005/9/5—2005/10/14（大跌前后），每一区间共包含25个交易日，被划分为5个间隔相等的时段。两次指数大幅波动时间段每日收盘指数随时间变化的趋势如图14-4所示。其中，A、E时段为远离大幅震荡的正常阶段；B时段为临近大幅震荡阶段；C时段为大幅震荡阶段；D时段为大幅震荡过后，还留有一部分震荡余波阶段。

图14-4　大幅波动前后每日收盘价随时间变化的趋势

1）持续大涨前后分形主要参数值情况分析

根据多重分形谱模型，选取适当的参数q和T对股指高频数据进行多重分形计算，持续大涨前后各时段多重分形谱主要参数值如表14-1所示。

表14-1　持续大涨前后分形各主要参数值 

通过表14-1可以发现：

（1）持续大幅上涨前，远离大幅震荡的正常时段（A组）。多重分形谱的顶部较尖，开口较狭窄（△α＝0.0113），曲线集中在坐标系中很小的范围，说明此时段指数波动较平稳，指数大小分布较均匀。

（2）持续大幅上涨前，大幅震荡临近时段（B组）。与A组相比，多重分形谱开口由窄变宽（△α＝0.0142），α0
增加，△α变大，说明指数波动的奇异性增强，该时段指数最大值和指数最小值的差距更加显著。此外，αmin
值变大（αmin
＝0.9951）说明指数最大值下降，αmax
值变大（αmax
＝1.0093）说明指数最小值继续变小，但是αmin
值增大的幅度小于αmax
值增大的幅度，说明指数有大幅波动的趋势。f（αmin
）值增加，说明高价格指数出现的次数较以前有所增加，f（αmax
）值减少，低价格指数出现的次数较以前有所减少，这说明未来指数有大幅上涨的趋势。

（3）持续大幅上涨时段（C组）。此时段多重分形谱开口变至最大（△α＝0.0523），曲线集中在坐标系中较大的范围，说明此时段指数波动极不平稳，指数大小分布很不均匀，这是指数大幅度波动的典型性特征。f（αmin
）值变至最小（0.969），说明指数最大值继续变大至最大，f（αmax
）（1.0213）值变至最大说明指数最小值继续变低至最低。两者同时变化说明指数有大幅变动的趋势，此时段指数上涨显著。f（αmin
）值变至最小，f（αmax
）值变至最大，△α值变至最大及α0变至最大都说明了该时段指数变化剧烈程度增加。

（4）持续大幅上涨后，部分震荡余波阶段（D组）。持续大涨刚结束时，谱的开口由宽变窄（△α＝0.0147），α0
变小。△α值急剧变小，表明指数大幅上涨的趋势有所缓和。f（αmin
）值变大，表明此时段指数最大值低于持续大涨时指数的最高值；f（αmax
）值变小，说明此时段指数最低值高于持续大涨时指数达到的最低值，即指数的波动范围变小。

（5）持续大幅上涨后，远离大幅震荡的正常时段（E组）。多重分形谱开口变狭窄（△α＝0.0049），α0
变至更小。曲线集中在坐标系中很小范围，说明此时段指数波动较平稳，指数大小分布较均匀。

2）持续大跌前后分形主要参数值

根据多重分形谱模型，选取适当的参数q和T对股指高频数据进行多重分形计算。持续大跌前后各时段多重分形谱主要参数值如表14-2所示。

表14-2　持续大跌前后分形各主要参数值 

（1）持续大幅下跌前，远离大幅震荡的正常时段（A组）。多重分形谱的顶部较尖，开口较狭窄（△α＝0.0022），曲线集中在坐标系中很小的范围，说明此时段指数波动较平稳，指数大小分布较均匀。

（2）持续大幅下跌之前，大幅震荡临近时段（B组）。与A组相比，多重分形谱的开口由窄变宽（△α＝0.0085），△α变大说明指数波动的奇异性增强，该时段指数最大值和指数最小值的差距更加显著。αmin
值变小（0.9962）说明指数最大值增加，αmax
值变大（1.0047）说明指数最小值继续变小；两者同时变化，说明指数有大幅波动的趋势。αmax
值变大的幅度大于αmin
值变小的幅度，说明指数有呈跌势的趋势。f（αmin
）值（0.816）减少，说明价格较高指数出现的次数较以前有所减少；f（αmax
）值减少（0.7457）；说明价格较低的指数出现的次数较以前有所减少；但是，f（αmin
）值减少的幅度小于f（αmax
）值减少的幅度，这说明未来指数有大幅下跌的趋势，但在跌势中可能伴有局部的震荡上扬。

（3）持续大幅下跌时段（C组）。此时段多重分形谱的开口变至最大（△α＝0.0231），曲线集中在坐标系中较大的范围，说明此时段指数波动极不平稳，指数大小分布很不均匀，这是指数大幅度波动的典型性特征。αmin
值变至最小（0.9888），说明指数最大值继续变大至最大；αmax
值变至最大（1.0119），说明指数最小值继续变低至最低，两者同时变化说明指数有大幅变动的趋势，说明此时段指数下跌显著。αmin
值变至最小，αmax
值变至最大，△α值变至最大及α0
变至最大都说明了该时段指数变化的剧烈程度增加。

（4）持续大幅下跌后，部分震荡余波阶段（D组）。持续大跌刚结束时，谱的开口由宽变窄（△α＝0.0031），△α值急剧变小表明指数大幅波动的趋势有所缓和。αmin
值变大（0.9986）表明此时段指数最大值低于持续大涨时指数的最大值；αmax
值变小（1.0019）说明此时段指数最小值高于持续大涨时指数达到的最小值，这同样说明指数波动幅度变小。

（5）持续大幅下跌后，远离大幅震荡的正常时段（E组）。多重分形谱的开口较狭窄（△α＝0.0029），曲线集中在坐标系中很小的范围，说明此时段指数波动较平稳，指数大小分布较均匀。

上述实证研究结果表明，股指发生大幅波动前后的主要时段，其多重分形谱的形状及其多重分形谱的参数变化有一定的规律可循。

总而言之，多重分形理论通过一个标度范围来描述复杂系统的局部特征，能够得到许多被简单分形方法所忽略的信息，被认为是迄今为止最为全面地描述价格波动特征的模型。本案例运用该理论对股价波动的多重分形特征进行了统计研究，发现了多重分形谱参数与股指波动之间较强的关联性，即在股价指数发生大幅波动的情况下，多重分形谱参数△α、α0
、αmin
、αmax
等均具有较明显的变化特征，这为进一步描述股票市场的复杂性规律提供了依据。

14.3.2　汇率预测

随着全球金融一体化的发展及国际间的资本流动加快的影响，国际金融市场变得越来越复杂，竞争日趋激烈，而反映它变化的汇率越来越被人们所重视，因此对它所进行的研究也成为近几年十分热门的话题。

最新的研究成果指出，汇率变化是一个具有非线性特征的变化过程，而分形理论又是非线性理论中比较常用的理论之一。同时，分形理论中的思维角度和计算方法都给金融问题提供了十分有效的解决方案，而对于汇率的研究也是这一领域中的一个重要分支，可见用分形理论来研究汇率问题是十分恰当的。

1．R/S分析方法简述

R/S分析（The Rescaled Range Analysis，重标极差分析）最初是由水纹专家H.E.Hurst在1951年提出来的，是最著名的分形分析方法之一。该方法主要通过R/S计算出该序列的H值，并根据H值来判断该序列的性质。

1）计算重标极差（R/S）

设一个时间序列Pt
，观测次数为m，将其转换为长度为M＝m－1的常用对数比率时间序列：Xt
＝lnPt
－lnPt－1
。将这个长度为M的时间序列｛Xt
｝分成A个长度为N（2≤N≤L，L表示最长子区间的长度）的相邻子区间，使得A×N＝M。用Ia
代表每个子区间，其中a＝1，2，…，A；将每个Ia
上的Xt
记为Xk，a
，其中k＝1，2，…，N。设Ia
上的｛Xt
｝的均值为Xa
，则有如下计算公式：

式（1）～（4）中：

N——子区间Ia
的长度。

Dk，a
——子区间Ia
的累积离差。

RI，a
——子区间Ia
的极差。

SI，a
——第个子区间Ia
的标准差。

（R/S）N
——重标极差。

2）估计平均循环长度

所谓平均循环长度，指的就是时间序列具有“长期记忆”特性的长度。根据Peters（1994）的研究，可以借助V统计量来估计序列的平均循环长度，其计算公式为：

3）计算Hurst指数

因为（R/S）N
＝C×NH
，所以将此式两边取对数得：

然后就将平均循环长度内的值及其相应的N值代入上式，用OLS求解H值。

4）计算R/S期望值

彼得斯（Peters）给出了高斯型序列的R/ S期望值的计算公式：

将E（R/S）N
和log N代入式（8），用OLS可得高斯型序列的H指数期望值E（H）：

5）通过H值判断序列走势

Hurst指数和相应的时间序列分为3种类型：

（1）当H＝0.5时，时间序列是随机游走的。序列中不同时间的值是随机的和不相关的，即现在不会影响将来。

（2）当0≤H≤0.5时，这是一种反持久性的时间序列，常被称为均值回复。如果一个序列在前一时期是向上走的，那么它在下一个时期多半是向下走的，反之亦然。这种反持久性的强度依赖于H离零有多近，越接近于零，这种时间序列就具有比随机序列更强的突变性或易变性。

（3）当0.5≤H≤1时，表明序列具有持续性，存在长期记忆性的特征。即前一个时期序列是向上（下）走的，那下一个时期将多半继续是向上（下）走的。趋势增强行为的强度或持久性随H接近于1而增加。

6）根据V（R/S）与V（E（R/S））统计量图

选出统计量的走势由上升转为下降或是保持不变的点，而这个点正是序列的长期记忆过程消失的临界点，这个点对应的N就是序列的平均循环长度。但如果图像中这样的临界点不是唯一的时候，可根据假设检验来选择出真正的临界点，具体计算如下：

其中，
则

其中，T为样本中所有的观测数目。在实际应用中，R2
要达到多大才算模型通过了检验，没有绝对的标准，而是要根据实际情况而定，它只是说明所得到的一元线性回归方程的拟合程度。T检验是判断x变量是否是显著的，如果结果判断出x是不显著的，则可在已建立好的模型中去除这个变量；如果判断出x是显著的，那么在模型中就应保留该变量。对于多元线性回归模型，方程的总体线性关系是显著的，并不能说明每个解释变量对被解释变量的影响都是显著的，必须对每个解释变量进行显著性检验，以决定是否作为解释变量被保留在模型中。

由于Hurst指数遵循正态分布，因此需要将它转化为标准正态分布（即S统计量），然后选择一个置信度，通过假设检验来判断序列是否遵循随机游走。如果S统计量在拒绝域中，表明序列遵循随机游走，R/S分析结果是显著的，该点即真正的转折点；若不在拒绝域中，则表明序列并未显著偏离随机游走，R/S分析结果不显著。

2．R/S分析方法在预测汇率中的案例实证

案例　基于分形理论的汇率预测

本案例从2003年11月25日到2006年11月24日，选取有关美／日汇率每天的比值共784个进行分析。

1）R/S分析计算

R/S分析的各项指标如表14-3所示，出于简化考虑，这里只给出了一部分。

表14-3　外汇R/S分析的各项指标 

2）转折点的选择

如图14-5所示，可以看到V（R/S）曲线在N＝32、52、60、87、156时出现了转折点。为判定序列长期记忆消失的临界点，根据这5个转折点进行5次回归，并做显著性检验，回归分析结果如表14-4所示。从表14-4中可以发现，通过S统计量的计算，得到在置信度a＝95％（临界值为1196）时，只有第一组回归的S统计量大于1196，因此判定N＝32是序列的转折点。因此，美／日汇率的平均循环长度为32天。

图14-5　美／日汇率的V统计量

表14-4　V（R/S）曲线回归检验 

用最小二乘法（OLS）求得该时间序列的H值为0.59935，E（H）值为0.67615。依照上述计算方法得出：美／欧的分形维H为0.54330，E（H）为0.63218，循环周期为78天；欧／日的分形维H为0.54049，E（H）为0.6219，循环周期为112天。

通过上面分析研究，可以得出如下结论：

（1）可以看出，拟合优度R2
的值都较大，十分接近于1，这说明一元线性回归的拟合程度很好；在T检验中，即使是在99.95％的极高的显著水平下，解释变量通过了变量显著性检验，即解释变量是显著的。

（2）通过计算得出的美／日汇率的日收益率的Hurst指数介于0.15和1之间，但H值比较小，这表明该序列具有持久性特征和分形结构，美／日汇率的变化不是一个随机游走的过程，而是一个有偏的随机过程。美元和日元之间不是相互独立的，而是存在着内在的联系，具有持久性的特征，即前期是向上（下）的，下一个时期多半也是向上（下）的。同时，H值越接近0.5，它的噪声越大，变动的趋势越不稳定，因此所对应的投资风险就越大。

（3）外汇市场中美／日的平均循环长度大约为32天。值得注意的是，这里的循环周期不是严格意义下的周期，而是指长期记忆消失的时间，即在这个32天内美／日汇率将会对下一个32天内的美／日汇率产生影响，而32天后的美／日汇率与现在的美／日汇率是相互独立的。

第15章　随机过程

◆摘要◆

随机过程（Stochastic Process）是一连串随机事件动态关系的定量描述。随机过程论与其他数学分支如位势论、微分方程、力学及复变函数论等有密切的联系，是自然科学、工程科学及社会科学各领域研究随机现象的重要工具。随机过程论目前已得到广泛应用，在诸如天气预报、统计物理、天体物理、运筹决策、经济数学、安全科学、人口理论、可靠性及计算机科学等很多领域都要经常用到随机过程的理论来建立数学模型。

常见的随机过程包括：独立增量过程、泊松过程、维纳过程、正态过程、马尔可夫（Markov）过程等。

在量化投资中，主要采用马尔可夫过程来对股市大盘进行预测，马尔可夫链理论预测的对象是一个随机变化的动态系统，其预测是根据状态之间的转移概率来推测系统未来的发展，转移概率反映了各种随机因素的影响程度，因而马尔可夫链比较适合随机波动性较大的预测问题，但是马尔可夫链要求状态无后效性，且要具有平稳过程等特点。如果灰色GM（1，1）模型对数据进行拟合，找出其变化趋势，则可以弥补马尔可夫预测的局限性，而在灰色预测基础上进行马尔可夫预测，又可弥补灰色预测对随机波动性较大的数据序列准确度低的不足，因此将二者结合起来将大大提高对股市的预测精度。

15.1　基本概念

随机过程（Stochastic Process）是一连串随机事件动态关系的定量描述。随机过程论与其他数学分支如位势论、微分方程、力学及复变函数论等有密切的联系，是在自然科学、工程科学及社会科学各领域研究随机现象的重要工具。随机过程论目前已得到广泛应用，在诸如天气预报、统计物理、天体物理、运筹决策、经济数学、安全科学、人口理论、可靠性及计算机科学等很多领域都要经常用到随机过程的理论来建立数学模型。

1．随机过程定义

一般来说，把一组随机变量定义为随机过程。在研究随机过程时人们透过表面的偶然性描述出必然的内在规律并以概率的形式来描述这些规律，从偶然中悟出必然正是这一学科的魅力所在。随机过程整个学科的理论基础是由柯尔莫哥洛夫和杜布奠定的。这一学科最早源于对随机过程物理学的研究，如吉布斯、玻尔兹曼、庞加莱等人对统计力学的研究，以及后来爱因斯坦、维纳、莱维等人对布朗运动的开创性工作。1907年前后，马尔可夫研究了一系列有特定相依性的随机变量，后人称之为马尔可夫链。1923年维纳给出布朗运动的数学定义，直到今天这一过程仍是重要的研究课题。随机过程一般理论的研究通常认为开始于20世纪30年代。1931年，柯尔莫哥洛夫发表了《概率论的解析方法》，1934年A·辛饮发表了《平稳过程的相关理论》，这两篇著作奠定了马尔可夫过程与平稳过程的理论基础。1953年，杜布出版了名著《随机过程论》，系统且严格地叙述了随机过程基本理论。

2．研究方法

研究随机过程的方法多种多样，主要可以分为两大类：一类是概率方法，其中用到轨道性质、随机微分方程等；另一类是分析的方法，其中用到测度论、微分方程、半群理论、函数堆和希尔伯特空间等，实际研究中常常两种方法并用。另外，组合方法和代数方法在某些特殊随机过程的研究中也有一定作用。研究的主要内容有：多指标随机过程、无穷质点与马尔可夫过程、概率随机过程与位势及各种特殊过程的专题讨论等。中国学者在平稳过程、马尔可夫过程、鞅论、极限定理、随机微分方程等方面做出了较好的成绩。

一个实际的随机过程是任意一个受概率支配的过程，例如，①看做是受孟德尔遗传学支配的群体的发展；②受分子碰撞影响的微观质点的布朗运动，或者是宏观空间的星体运动；③赌场中一系列的赌博；④公路一指定点汽车的通行。

在每一种情形，一个随机系统在演化，这就是说它的状态随着时间而改变，于是，在时间t的状态具有偶然性，它是一个随机变量x（t），参数t的集通常是一个区间（连续参数的随机过程）或一个整数集合（离散参数的随机过程）。

如果系统的状态用一个数来表示，x（t）就是数值的，在其他情形，x（t）可以是向量值或者更为复杂。当状态变化时，它的值确定一个时间的函数：样本函数，支配过程的概率规律确定赋予样本函数的各种可能性质的概率。

数学上的随机过程是由实际随机过程概念引起的一种数学结构，人们研究这种过程，是因为它是实际随机过程的数学模型，或者是因为它的内在数学意义及它在概率论领域之外的应用。

数学上的随机过程可以简单地定义为一组随机变量，即指定一参数集，对于其中每一参数点t指定一个随机变量x（t）。如果回忆起随机变量自身就是一个函数，以ω表示随机变量x（t）的定义域中的一点，并以x（t，ω）表示随机变量在ω的值，则随机过程就由刚才定义的x（t，ω）的函数及概率的分布完全确定。如果固定t，这个二元函数就定义一个ω的函数，即以x（t）表示的随机变量。如果固定ω，这个二元函数就定义一个t的函数，这是过程的样本函数。

一个随机过程的概率分配通常是由指定它的随机变量的联合分布来给定的，这些联合分布及由它们诱导出来的概率可以解释为样本函数的性质的概率。例如，如果t0
是一个参数值，样本函数在t0
取正值的概率是随机变量x（t0
）有正值的概率。在这个水平上的基本定理：任意指定的自身相容的联合概率分布对应一随机过程。

3．特殊随机过程

对过程的概率结构做各种假设，便得到各类特殊的随机过程。除正态过程、二阶过程外，重要的还有独立增量过程、马尔可夫过程、平稳过程、鞅点过程和分支过程等。贯穿这些过程类的有两个最重要、最基本的过程——布朗运动和泊松过程，它们的结构比较简单，便于研究且应用广泛。从它们出发，可以构造出许多其他过程。这两种过程的轨道性质不同，前者连续而后者则是上升的阶梯函数。

正如从普通函数发展到广义函数一样，随机过程也可发展到广义过程。设D为R上全体无穷次可微且支集有界的实值函数
的集，定义在D上的连续线性泛函称为广义函数，全体广义函数的集记为Dx
。考虑D×Ω上的二元函数x（
，ω），如果对固定的ω，x（·，ω）∈Dx
是广义函数，而对固定的
，x（
，·）是随机变量，则称｛x（
，ω）∶
∈D｝为定义在（Ω，F，p）上的广义过程。

据有穷维分布族的性质，也可以定义特殊的广义过程类，如广义平稳过程、广义正态过程等。例如，若对D中任意有限个线性独立函数
1
，
2
，…，
n
，有限维分布都是正态分布，则称x＝｛x（
，ω）｝为广义正态过程。

15.2　主要内容

15.2.1　随机过程的分布函数

定义1：给定随机过程X（t），t∈T，对于每一个固定的t∈T，X（t）是一个随机变量的分布函数，一般与t有关，记为Ft
（x）＝P（X（t）≤x），称为随机过程的一维分布函数。

若存在非负函数Ft
（x），使
则称函数ft
（x）为随机过程X（t）的一维密度函数。

定义2：给定随机过程X（t），t∈T，对于任意两个时刻t1
，t2
∈T，二维随机变量X（t1
）、X（t2
）的分布函数一般与t1
、t2
有关，记为：

称为随机过程的二维分布函数。

定义3：若存在非负函数
使
成立，则称
为随机过程的二维密度函数。

定义4：给定随机过程X（t），t∈T，当时间t取t1
，t2
，…，tn
∈T，n维随机变量（X（t1
），X（t2
），…，X（tn
））的分布函数记为：

称使

成立的
为随机过程X（t）的n维密度函数。

n维分布函数的全体
称为随机过程X（t）的有限维分布函数族，同理定义有限维密度函数族。

15.2.2　随机过程的数字特征

定义5：给定随机过程｛X（t），t∈T｝，固定t，X（t）是一个随机变量，它的均值或数学期望一般与t有关，记为μX
（t）＝E［X（t）］，我们称μX
（t）为随机过程X（t）的均值函数。

显然，若f（x，t）是X（t）的一维密度函数，则

定义6：我们把随机变量X（t）的二阶原点矩
称为随机过程｛X（t）｝的均方值函数。

定义7：我们把随机变量X（t）的方差
称为随机过程｛X（t）｝的方差函数。

定义8：设X（t1
）和X（t2
）是随机过程在任意两个时刻t1
和t2
时的状态，称X（t1
）和X（t2
）的二阶混合原点矩RX
（t1
，t2
）＝E［X（t1
）X（t2
）］为随机过程｛X（t）｝的自相关函数，简称相关函数。

定义9：称X（t1
）和X（t2
）的二阶混合中心矩
为随机过程｛X（t）｝的自协方差函数，简称协方差函数。

随机过程的5种数字特征：均值函数、均方值函数、方差函数、相关函数、协方差函数之间的关系如下：

15.2.3　几种常见的随机过程

1．独立增量过程

（1）定义10：若随机过程｛X（t），t∈T｝，T＝［0，＋∞）任意n个状态X（t1
），X（t2
），…，X（tn
），满足：X（t2
）－X（t1
），X（t3
）－X（t2
），…，X（tn
）－X（tn-1
）相互独立，则称X（t），t∈T为独立增量过程。

（2）若对任意的非负实数s，t，h，且s＜t，X（t＋h）－X（t＋h）与X（t）－X（s）具有相同的分布，则称增量具有平稳性。当增量具有平稳性时，称相应的独立增量过程是齐次的。

2．泊松（poison）过程

定义11：若独立增量过程的增量服从泊松（poison）分布，即
0≤t1
＜t2
，X（t1
）－X（t2
）～P（λ（t2
－t1
）），则称给定随机过程｛X（t），t∈T｝为强度为λ的泊松（poison）过程。

3．维纳过程

定义12：设随机过程｛W（t），t≥0｝的均方值函数存在，若它满足：

①具有平稳的独立增量；

②对任意的t＞s≥0，W（t）－W（s）服从正态分布N（0，σ2
（t－s））；

③W（0）＝0，

则称此过程为维纳过程或布朗运动，其中σ2
称为维纳过程的参数。

4．正态过程

定义13：若随机过程｛X（t），t∈T｝的每一个有限维分布都是正态分布，则｛X（t），t∈T｝称为正态过程（高斯过程）。

定理1：维纳过程是正态过程。

证：
n
，t1
＜t2
＜...＜tn
∈T　及
k1
，k2
，…，kn
∈R

令：

式中ai
满足t0
＝0，a0
＝－k1
ai－1
－ai
＝ki
，由于
是独立的正态随机变量。X（t1
）－X（0），X（t2
）－X（t1
），…，X（tn
）－X（tn－1
）的线性组合仍然服从正态分布。

5．马尔可夫（Markov）过程

定义14：设随机过程X（t），t∈T的状态空间为I，若任意，t1
＜t2
＜…＜tn
，ti
∈T，P｛X（tn
）≤xn
|X（t1
）＝x1
，…，X（tn-1
）＝xn-1
｝＝
P｛X（tn
）≤xn
|X（tn－1
）＝xn－1
｝，则称过程X（t），t∈T具有马尔可夫性或称此过程为马尔可夫（Markov）过程，简称马氏过程。

马尔可夫过程的特点是：当过程在时刻t0
所处的状态为已知的条件，过程在时刻t（t＞t0
）所处的状态与过程在t0
时刻之前的状态无关，这个特性就是无后效性。

若独立增量过程｛X（t），t≥0｝，若X（0）＝0，则必为马氏过程。

定义15：若马氏过程的状态I＝｛a1
，a2
，…｝，ai
∈R，i＝1，2，…是离散的，则称条件概率
为马氏过程X（t）在时刻t处于状态ai
的条件下，在时刻t＋I处转移到状态aj
的转移概率。

转移概率的性质有：

定义16：参数与状态都离散的马尔可夫过程称为马尔可夫链，简称马氏链。设马氏链的参数集为T＝｛t1
，t2
，…｝，t1
＜t2
＜…，状态集为I＝｛a1
，a2
，…｝，记Xi
＝X（ti
），i＝1，2，...，显然有P｛Xn
＝ain
|X1
＝ai1
，…，Xn－1
＝ain－1
｝＝P｛Xn
＝xn
|Xn－1
＝ain－1
｝

定义17：若在Xn－1
＝ai
的条件下，Xn
＝aj
发生的概率与n无关，则称马氏链X（t），t∈T为齐次的，称马氏链X（t），t∈T为齐次马氏链。

定义18：在马氏链是齐次的情况下，称：
为马氏链的n步转移概率，称（pij
（n）），n＝1，2，…为马氏链的n步转移概率矩阵，记为P（n）。

一步转移概率矩阵记为P。可证：P（n）＝Pn
。

15.2.4　平稳随机过程

1．严平稳随机过程

定义19：若随机过程X（t），t∈T对于任意时刻t1
，t2
，…，tn
∈T和任意τ∈R（X（t1
），X（t2
），…，X（tn
））与（X（t1
＋τ），X（t2
＋τ），…，X（tn
＋τ））具有相同的分布函数，则称随机过程X（t）为严平稳过程。

定理20：若严平稳过程的均方值函数存在，则均值函数为：
均方值函数为：
方差函数为：σ2
X＝σ2
X（t）；相关函数：RX
（τ）＝RXX
（t，t＋τ）。

2．宽平稳随机过程

定义20：若随机过程｛X（t），t∈T｝对每一个t∈T，二阶矩E［X2
（t）］都存在，则它为二阶矩过程。

定义21：给定二阶矩过程｛X（t），t∈T｝若对任意t，t＋τ∈T，μX
（t）＝μX
（常数），RXX
（t，t＋τ）＝RX
（τ）（仅仅是时间差函数），则称X（t）是一个宽平稳过程或广义平稳过程，简称平稳过程。

定义22：关于平稳过程X（t）的相关函数有下列性质

ti
∈T，i＝1，2，…，n和任意实值函数g（.）都有：

15.3　灰色马尔可夫链股市预测

在股票市场中，股票价格是一个基本特征量，但是它总受政治、经济等各方面的影响，具体的影响因素的程度和信息是不完全的，所以我们可以把股市当成一个灰色系统来处理。

灰色系统是指既含有已知信息又含有未知或未确知信息的系统。灰色理论在处理信息不完全系统时，其要点在于不把系统中的随机性作为一个随机信号而是看做一个灰数，从而将灰色过程当做在一定区间、一定时区上变化的随机过程，主要用于时间短、数据资料少、波动性不大的预测问题。而且灰色预测不是采用原始的数据序列而是采用生成的数据序列，对于序列较短且有规律性的数据来说，这种预测精度较高。但由于灰色GM（1，1）预测模型的预测曲线是一条较平滑的单调曲线，对波动性较大的股票市场中的数据列拟合较差，预测度较低。

马尔可夫链理论预测的对象是一个随机变化的动态系统，其预测是根据状态之间的转移概率来推测系统未来的发展，转移概率反映了各种随机因素的影响程度，因而马尔可夫链比较适合随机波动性较大的预测问题，但是马尔可夫链要求状态无后效性，且要具有平稳过程等特点。如果灰色GM（1，1）模型对数据进行拟合，找出其变化趋势，则可以弥补马尔可夫预测的局限性，而在灰色预测基础上进行马尔可夫预测，又可弥补灰色预测对随机波动性较大的数据序列准确度低的不足，因此将二者结合起来将大大提高预测精度。

1．灰色模型GM（1，1）

灰色模型构建步骤如下：

（1）给定原始数据列，记为x（0）
＝（x（0）
（1），x（0）
（2），…，x（0）
（n））。

（2）对原始数据进行一次累加，生成新的数据序列：

x（1）
＝（x（1）
（1），x（2）
（2），…，x（1）
（n）），其中

（3）构造矩阵B和常数矩阵Y，令

其中
并建立相应的模型

（4）用最小二乘法求解a、b得

（5）该模型的时间响应方程为：
再经累减还原：
得到

2．马尔可夫链预测模型

1）状态划分

（1）根据GM（1，1）模型求出原始数据序列的拟合值
；

（2）求出残差

（3）残差的相对值为

（4）为了使每一状态的数据相差不多，将ε（k）的值从小到大排列，根据用户的需要和数据的多少，将状态分为自己想要的数。

2）转移概率的计算

（1）根据前面的状态划分，将残差的相对值分为若干状态，记为E1
，E2
，…，En
，残差相对值序列由状态Ei
经k步转移到状态Ej
的概率称为n步转移概率，记为：

式中mij
（k）为状态Ei
经k步转移到状态Ej
的次数，Mi
为状态Ei
出现的次数，由于数据序列的最后状态的转向不明确，故计算Mi
时要去掉数据序列中最末的k个数据。

（2）当k＝1时，即为一步转移概率pij
，其矩阵形式可记为：

其中，

（3）可知p（1）＝p（0）p1
，考察P（1）中的n个值，若
则可以认为下一时刻系统最有可能由状态Ek
转向状态El
，即下一时刻最有可能处于状态El
。

（4）可知p（2）＝p（1）p1
，…，p（n）＝p（n－1）p1
，同理上一步可知n时刻后系统最有可能所处的状态。

3．案例实证：灰色马尔可夫链股市预测

由于收盘价是影响股票价格的最主要的因素，本案例选取从2005年1月到2006年8月共20个月末深证成指的收盘数据，其中时间序列的单位以月计。

步骤一：求出模型GM（1，1）中的a，b，即a＝-0.02783，b＝232.1352，则

步骤二：由残差相对值公式
求得残差相对值序列ε（t）的范围为（－18％，26％）。

步骤三：根据实际情况将残差相对值ε（t）平均分为3个状态E1
、E2
、E3
，其中E1
＝［－18％，－6％］，E2
＝（-6％，0］，E3
＝（0，26％］。

步骤四：计算一步转移概率
预测对象2006年8月处于状态3，那么下个月的绝对分布为
所以下个月预测对象最有可能处于状态3，即ε（t）∈E3
=（0，26％］，又由
得
所以x（0）
（21）∈（413.649.558.985），要预测的2006年9月的月末收盘指数为438.9，在此预测区间内。

步骤五：再进行预测可以依照上面的步骤得到下面月份的预测区间。

表15-1是用灰色马尔可夫链预测深证成指在样本内的结果，表15-2是用于样本外的预测结论，从表中可以看出，实际的深证成指的数据基本上处于灰色马尔可夫链的预测的指数区间。当然，从数据也可以看出，区间范围略大，因此在实际交易中，可以用区间的中位数来代表预测区间。如果区间中位数大于当前的指数点位，则可以做多；如果区间中位数小于当前的指数点位，则可以做空。

表15-1　灰色马尔可夫链预测深证成指样本内（2005/1—2006/8） 

表15-2　灰色马尔可夫链预测深证成指样本外（2006/9—2006/12） 

总而言之，灰色马尔可夫链预测模型是根据灰色模型和马尔可夫链模型思想建立的，同时建立在历史数据的统计分析基础上。该模型不仅考虑了数据序列中的演变规律，而且通过状态转移概率矩阵的变换提取数据中的随机响应，因而它将灰色模型和马尔可夫链模型的优点结合起来，克服各自的缺点，提高预测精度。另外，该模型的原理浅显易懂，计算过程不复杂，适用性比较强。

该模型存在许多值得探讨的问题，它的预测精度与状态的划分有很大的关系，目前状态的划分没有统一的标准，所以还需要进一步研究。另外，该模型对波动性较大且有一定上升趋势的数据来说，可以取得比较好的预测效果，不是对任何数据都能适用。总之，灰色马尔可夫链预测模型有其应用价值，为投资者提供了理论方便。

第16章　IT技术

◆摘要◆

量化投资离不开IT技术，无论是基础的数据库和数据仓库，还是在策略分析及后验中，都需要IT系统的支持，在程序化交易中也是利用软件代码进行自动化交易，所以本章给出了一些有关IT技术的概要介绍，主要是与量化投资直接相关的一些技术，包括数据仓库、编程语言等。

16.1　数据仓库技术

数据仓库是近年来兴起的一种新的数据库应用，各大数据库厂商纷纷宣布产品支持数据仓库并提出一整套用以建立和使用数据仓库的产品，如INFORMIXGONGSIDE公司的数据仓库解决方案、Oracle公司的数据仓库解决方案和Sybase公司的交互式数据仓库解决方案等。

国际上许多重要的学术会议，如超大型数据库国际会议（VLDB）、数据工程国际会议（Data Engineering）等，都出现了专门研究数据仓库（Data Warehousing, DW）、联机分析处理（On-Line Analytical Processing, OLAP）、数据挖掘（Data Mining, DM）的论文。

对我国许多企业而言，在建立或发展自己的信息系统时常常被这样的问题困扰：为什么要在原有的数据库上建立数据仓库，数据仓库能否代替传统的数据库，怎样建立数据仓库，等等。本节将简要介绍数据仓库的技术背景和主要技术方法。

16.1.1　从数据库到数据仓库

传统的数据库技术是以单一的数据资源即数据库为中心，进行事务处理、批处理、决策分析等各种数据处理工作，主要划分为两大类：操作型处理和分析型处理（或信息型处理）。操作型处理也叫事务处理，是指对数据库联机的日常操作，通常是对一个或一组记录的查询和修改，主要为企业的特定应用服务，注重响应时间、数据的安全性和完整性；分析型处理则用于管理人员的决策分析，经常要访问大量的历史数据。而传统数据库系统优于企业的日常事务处理工作，而难于实现对数据分析处理的要求，已经无法满足数据处理多样化的要求，操作型处理和分析型处理的分离成为必然。

近年来，随着数据库技术的应用和发展，人们尝试对DB中的数据进行再加工，形成一个综合的、面向分析的环境，以更好地支持决策分析，从而形成了数据仓库技术（Data Warehousing, DW）。作为决策支持系统（Decision-making Support System, DSS），数据仓库系统包括：

（1）数据仓库技术。

（2）联机分析处理技术（On-Line Analytical Processing, OLAP）。

（3）数据挖掘技术（Data Mining, DM）。

数据仓库弥补了原有的数据库的缺点，将原来的以单一数据库为中心的数据环境发展为一种新环境：体系化环境。

1．什么是数据仓库

业界公认的数据仓库概念创始人W.H.Inmon在《建立数据仓库》一书中对数据仓库的定义是：数据仓库就是面向主题的、集成的、不可更新的稳定性、随时间不断变化的数据集合，用以支持经营管理中的决策制定过程。

数据仓库中的数据面向主题，与传统数据库面向应用相对应。主题是一个在较高层次上将数据归类的标准，每一个主题对应一个宏观的分析领域。数据仓库的集成特性是指在数据进入数据仓库之前，必须经过数据加工和集成，这是建立数据仓库的关键步骤。数据仓库的稳定性是指数据仓库反映的是历史数据的内容，而不是日常事务处理产生的数据，数据经加工和集成进入数据仓库后是极少或根本不修改的；数据仓库是不同时间的数据集合，它要求数据仓库中的数据保存时限能满足进行决策分析的需要，而且数据仓库中的数据都要标明该数据的历史时期。

数据仓库最根本的特点是逻辑地存放数据，而且这些数据并不是最新的、专有的，而是来源于其他数据库。数据仓库的建立并不是要取代数据库，而是要在一个较全面和完善的信息应用的基础上，用于支持高层决策分析；而事务处理数据库在企业的信息环境中承担的是日常操作性的任务。数据仓库是数据库技术的一种新的应用，而且到目前为止，数据仓库还是用关系数据库管理系统来管理其中的数据。

2．数据仓库的产生

20世纪80年代初到90年代初，联机事务处理一直是数据库应用的主流。然而当联机事务处理系统应用到一定阶段后，用户便发现单靠拥有联机事务处理已经不足以获得市场竞争的优势，他们需要对其自身业务的运作及整个市场相关行业的情况进行分析，从而做出有利的决策。这种决策需要对大量的业务数据包括历史业务数据进行分析才能得到。在如今这样激烈的市场竞争环境下，这种基于业务数据的决策分析，我们把它称为联机分析处理，比以往任何时候都显得重要。如果说传统联机事务处理强调的是更新数据库——向数据库中添加信息，那么联机分析处理就是从数据库中获取信息、利用信息。

事实上，将大量的业务数据应用于分析和统计原本是一个非常简单和自然的想法，但在实际的操作中，人们却发现要获得有用的信息并非想象的那么容易，这主要表现在以下几点：

（1）所有联机事务处理强调的是密集的数据更新处理性能和系统的可靠性，并不关心数据查询的方便与快捷。联机分析和事务处理对系统的要求不同，同一个数据库在理论上都难以做到两全。

（2）业务数据往往存放于分散的异构环境中，不易统一查询访问，而且还有大量的历史数据处于脱机状态，形同虚设。

（3）业务数据的模式针对事务处理系统而设计，数据的格式和描述方式并不适合非计算机专业人员进行业务上的分析和查询。

针对这一问题，人们设想专门为业务的统计分析建立一个数据中心，它的数据来自于联机的事务处理系统、异构的外部数据源、脱机的历史业务数据。这个数据中心是一个联机的系统，它专门为分析统计和决策支持应用服务，通过它可以满足决策支持和联机分析应用所要求的一切，这个数据中心就叫做数据仓库。

数据仓库的概念一经出现，就首先被用于金融、电信、保险等主要传统数据处理密集型行业。国外许多大型的数据仓库在1996—1997年建立。那么，什么样的行业最需要和可能建立数据仓库呢？有两个基本条件：第一，该行业有较为成熟的联机事务处理系统，它为数据仓库提供客观条件；第二，该行业面临市场竞争的压力，它为数据仓库的建立提供外在的动力。

量化投资系统由于需要海量数据的分析与运算，使得数据仓库几乎成为量化投资必备的基础数据系统。

16.1.2　数据仓库中的数据组织

1．数据仓库的数据组织结构

数据仓库中的数据分为4个级别：早期细节级、当前细节级、轻度综合级、高度综合级。源数据经过综合后，首先进入当前细节级，并根据具体需要进行进一步的综合，从而进入轻度综合级乃至高度综合级，老化的数据将进入早期细节级。由此可见，数据仓库中存在着不同的综合级别，一般称之为“粒度”。粒度越大，表示细节程度越低，综合程度越高。

数据仓库中还有一项重要的数据：元数据（Metadata）。元数据是“关于数据的数据”，如在传统数据库中的数据字典就是一种元数据。在数据仓库环境下，主要有两种元数据：一类是管理元数据（Administrative Metadata），它是对源数据及其内容、数据仓库主题、数据转换及各种操作信息的描述；另一类是用户元数据（User Metadata），它帮助用户查询信息、理解结果、了解数据仓库中的数据和组织。当然，还有一些元数据既对管理有用又对用户有用。

2．粒度与分割

1）粒度

粒度是数据仓库的重要概念。粒度可以分为两种形式。第一种粒度是对数据仓库中的数据的综合程度高低的一个度量，它既影响数据仓库中的数据量的多少，也影响数据仓库所能回答询问的种类。在数据仓库中，多维粒度是必不可少的。由于数据仓库的主要作用是DSS分析，因而绝大多数查询都基于一定程度的综合数据之上，只有极少数查询涉及细节。所以应该将大粒度数据存储在快速设备如磁盘上，小粒度数据存储在低速设备如磁带上。

第二种粒度是样本数据库。它根据给定的采样率从细节数据库中抽取出一个子集，这样样本数据库中的粒度就不是根据综合程度的不同来划分，而是由采样率的高低来划分，采样粒度不同的样本数据库可以具有相同的数据综合程度。

2）分割

分割是数据仓库中的另一个重要概念，它的目的同样在于提高效率。它是将数据分散到各自的物理单元中去，以便能分别独立处理。有许多数据分割的标准可供参考，如日期、地域、业务领域等，也可以是其组合。一般而言，分割标准总应包括日期项，因为它十分自然而且分割均匀。

3．数据仓库的数据组织形式

（1）简单堆积文件：它将每日由数据库中提取并加工的数据逐天积累并存储起来。

（2）轮转综合文件：数据存储单位被分为日、周、月、年等几个级别。在一个星期的7天中，数据被逐一记录在每日数据集中，然后7天的数据被综合并记录在周数据集中，接下去的一个星期，日数据集被重新使用，以记录新数据。同理，周数据集达到5个后，数据再一次被综合并记入月数据集，依此类推。轮转综合结构十分简捷，数据量较简单，堆积结构大大减少。当然，它是以损失数据细节为代价的，越久远的数据，细节损失越多。

（3）简化直接文件：它类似于简单堆积文件，但它是间隔一定时间的数据库快照，如每隔一星期或一个月做一次。

（4）连续文件：通过两个连续的简化直接文件，可以生成另一种连续文件，它是通过比较两个简单直接文件的不同而生成的。当然，连续文件同新的简单直接文件也可生成新的连续文件。

对于各种文件结构的最终实现，在关系数据库中仍然要依靠“表”这种最基本的结构。

4．数据仓库的数据追加

如何定期向数据仓库追加数据也是一个十分重要的技术。数据仓库的数据来自OLTP的数据库中，问题是如何知道究竟哪些数据是在上一次追加过程之后新生成的。常用的技术和方法如下。

（1）时标方法：如果数据含有时标，对新插入或更新的数据记录，在记录中添加更新时的时标，那么只需根据时标判断即可。但并非所有的数据库中的数据都含有时标。

（2）DELTA文件：它是由应用生成的，记录了应用改变的所有内容。利用DELTA文件效率很高，它避免了扫描整个数据库，但同样的问题是生成DELTA文件的应用并不普遍。此外，还有更改应用代码的方法，使得应用在生成新数据时可以自动将其记录下来。但应用成千上万，且修改代码十分烦琐，这种方法很难实现。

（3）前后映像文件的方法：在抽取数据前后对数据库各做一次快照，然后比较两幅快照的不同从而确定新数据。这种方法占用大量资源，对性能影响极大，因此并无多大实际意义。

（4）日志文件：最可取的技术大概就是利用日志文件了，因为它是DB的固有机制，不会影响OLTP的性能。同时，它还具有DELTA文件的优越性质，提取数据只要局限日志文件即可，不用扫描整个数据库。当然，原来日志文件的格式是依据DB系统的要求而确定的，它包含的数据对于数据仓库而言可能有许多冗余。例如，对一个记录的多次更新，日志文件将全部变化过程都记录下来；而对于数据仓库，只需要最终结果。但比较而言，日志文件仍然是最可行的一种选择。

16.1.3　数据仓库的关键技术

与关系数据库不同，数据仓库并没有严格的数学理论基础，它更偏向于工程。由于数据仓库的这种工程性，因而在技术上可以根据它的工作过程分为：数据的抽取、存储和管理、数据的表现及数据仓库设计的技术咨询4个方面。下面将分别讨论每一个环节。

1．数据抽取

数据的抽取是数据进入仓库的入口。由于数据仓库是一个独立的数据环境，它需要通过抽取过程将数据从联机事务处理系统、外部数据源、脱机的数据存储介质中导入到数据仓库。数据抽取在技术上主要涉及互连、复制、增量、转换、调度和监控等几个方面。数据仓库的数据并不要求与联机事务处理系统保持实时的同步，因此数据抽取可以定时进行，但多个抽取操作执行的时间、相互的顺序、成败对数据仓库中信息的有效性至关重要。

在技术发展上，数据抽取所涉及的单个技术环节都已相对成熟，其中有一些是躲不开编程的，但整体的集成度还很不够。目前市场上所提供的大多是数据抽取工具，这些工具通过用户选定源数据和目标数据的对应关系，会自动生成数据抽取的代码。但数据抽取工具支持的数据种类是有限的；同时数据抽取过程涉及数据的转换，它是一个与实际应用密切相关的部分，其复杂性使得不可嵌入用户编程的抽取工具往往不能满足要求。

因此，实际的数据仓库实施过程中往往不一定使用抽取工具，整个抽取过程能否因工具的使用而纳入有效的管理、调度和维护则更为重要。从市场发展来看，以数据抽取、异构互连产品为主项的数据仓库厂商一般都很有可能被其他拥有数据库产品的公司吞并。在数据仓库的世界里，它们只能成为辅助的角色。

2．数据存储和管理

数据仓库的真正关键是数据的存储和管理。数据仓库的组织管理方式决定了它有别于传统数据库的特性，同时也决定了其对外部数据表现形式要采用什么产品和技术来建立数据仓库核心，则需要从数据仓库的技术特点着手分析。

数据仓库遇到的第一个问题是对大量数据的存储和管理。这里所涉及的数据量比传统事务处理大得多，且随时间的推移而累积，从现有技术和产品来看，只有关系数据库系统能够担当此任。关系数据库经过近30年的发展，在数据存储和管理方面已经非常成熟，非其他数据管理系统可比。目前不少关系数据库系统已支持数据分割技术，能够将一个大的数据库表分散在多个物理存储设备中，进一步增强了系统管理大数据量的扩展能力。采用关系数据库管理数百个GB甚至TB的数据已是一件平常的事情，一些厂商还专门考虑大数据量的系统备份问题，好在数据仓库对联机备份的要求并不高。

数据仓库要解决的第二个问题是并行处理。在传统联机事务处理应用中，用户访问系统的特点是短小而密集。对于一个多处理机系统来说，能够将用户的请求进行均衡分担是关键，这便是并发操作。而在数据仓库系统中，用户访问系统的特点是庞大而稀疏，每一个查询和统计都很复杂，但访问的频率并不是很高。此时系统需要有能力将所有的处理机调动起来为这一个复杂的查询请求服务，将该请求并行处理。因此，并行处理技术在数据仓库中比以往更加重要。

数据仓库要解决的第三个问题是针对决策支持查询的优化。这个问题主要针对关系数据库而言，因为其他数据管理环境连基本的通用查询能力都还不完善。在技术上，针对决策支持的优化涉及数据库系统的索引机制、查询优化器、连接策略、数据排序和采样等诸多部分。普通关系数据库采用B树类的索引，对于性别、年龄、地区等具有大量重复值的字段几乎没有效果。而扩充的关系数据库则引入了位图索引机制，以二进制位表示字段的状态，将查询过程变为筛选过程，单个计算机的基本操作便可筛选多条记录。由于数据仓库中各数据表的数据量往往极不均匀，普通查询优化器所得出的最佳查询路径可能不是最优的。因此，面向决策支持的关系数据库在查询优化器上也做了改进，同时根据索引的使用特性增加了多重索引扫描的能力。

以关系数据库建立的数据仓库在应用时会遇到大量的表间连接操作，而连接操作对于关系数据库来说是一个耗时的操作。扩充的关系数据库中对连接操作可以做预先的定义，我们称之为连接索引，它使得数据库在执行查询时可直接获取数据而不必实施具体的连接操作。数据仓库的查询常常只需要数据库中的部分记录，如最大的前50家客户等。普通关系数据库没有提供这样的查询能力，只好将整个表的记录进行排序，从而耗费了大量的时间。

16.2　编程语言

16.2.1　GPU算法交易

电子交易带来了彻底的技术革命。以量化算法为基础的交易策略和以计算机代码运行时间为单位的交易延时，给交易带来了本质的变化。随着这个趋势的发展，电子交易的算法越来越复杂。同时，以交易延时小、算法处理快为竞争力的高频交易、算法交易方兴未艾，CPU由于其线性执行命令的运行方式，程序运行速度较慢，延时较长，已经无法满足算法交易的需要。所以，知名投行的算法交易一般都有可并行计算的硬件加速器支持。

1．硬件加速的分类

1）FPGA

FPGA（可编程逻辑阵列）是一种可编程集成电路。FPGA内部包括可配置逻辑模块CLB（Configurable Logic Block）、输出输入模块IOB（Input Output Block）和内部连线（Interconnect）3个部分。用户可对FPGA内部的逻辑模块和I/O模块重新配置，以实现用户的逻辑。它还具有静态可重复编程和动态系统重构的特性，使得硬件的功能可以像软件一样通过编程来修改。FPGA作为一种数字集成电路，其执行命令的延时为纳秒级，最新FPGA的逻辑门数可达430k，具有强大的逻辑处理能力。

2）GPU

GPU（计算机图形处理器）在普适并行计算领域已经得到较高的认可。GPU的通用计算是并行计算的一个分支。根据体系架构和实现方式的不同，GPU的并行结构可分为几个层次，最微观的层面是单个核心上的指令级并行，依靠处理器内不同的运算器微观来并行执行多条指令；其次是多核并行，即在单芯片上集成多个处理器核心，在这些处理器核心上同时运行多个进程或线程，实现线程级／进程级并行；再次是多处理器并行，在一块印制电路板上安插多个处理器，实现多处理器级线程或进程并行；最后是将多个独立的计算机用网络连接起来，实现独立计算机级的集群分布式并行。并行结构使得数据处理算法在GPU上的运算速度比CPU更快。

FPGA与GPU都是主要的硬件加速器，两者各有所长。一般而言，追求低交易延时的方案可采用FPGA，追求高速复杂数据处理的方案使用GPU。在本书中重点介绍GPU的开发流程。

2．GPU技术的发展和演进

GPU（图形处理器）在1999年由Nvidia在其跨时代的产品——Nvidia geforce 256中提出，最初被用来处理着色、渲染、平面绘图、3D绘图等功能。到了Nvidia GeForce 6800这一代GPU，其并行计算能力大大提高。其后的产品G80在基于DX10统一渲染架构下，抛弃以前的渲染管线而采用统一的流处理器来做图像渲染。除了用做图像渲染外，流处理器自身有着强大的运算能力。在G80产品中有128个ALU，其并行计算能力远超CPU。CPU和GPU的运算能力差距如图16-1所示。

图16-1　GPU和CPU的计算能力对比

CUDA（Compute Unified Device Architecture，统一计算架构）是Nvidia所推出的一种集成技术，是该公司对于新一代GPU，也就是GPGPU的正式名称。通过这个技术，用户可利用Nvidia的GeForce 8以后的GPU和较新的Quadro GPU进行计算。CUDA也用来指GPU编程中C-编译器的开发环境。Nvidia营销的时候，往往将编译器与架构混合推广，造成混乱。实际上，CUDA架构可以兼容OpenCL或者自家的C-编译器。

实际上，CUDA是在2006年11月与G80这款产品一同诞生的，在2007年2月Nvidia首次发布了CUDA的公测版，而在2007年6月，CUDA 1.0版与Tesla系列显卡正式登场，到了2007年底，CUDA 1.1测试版放出。任意一台拥有GeForce 8以上的显卡都能够支持CUDA，最新的版本是GeForce GTX 200系列产品发布时同步推出的CUDA 2.0版本。在CUDA 2.0版本中，增加了如下内容：支持双精度运算（仅支持GT200系列产品）、支持Windows VISTA操作系统（包括32bit和64bit）、支持MacOS X操作系统、分析调试器、3D纹理支持及优化数据传输等。

3．GPU的架构和编程原理

在CUDA的架构下，一个程序分为两个部分：Host端和Device端。Host端是指在CPU上执行的部分，而Device端则是在显示芯片上执行的部分。Device端的程序又称为“Kernel”。通常Host端程序会将数据准备好后，复制到显卡的内存中，再由显示芯片执行Device端程序，完成后再由Host端程序将结果从显卡的内存中取回。

在CUDA架构下，显示芯片执行时的最小单位是线程（Thread）。数个线程可以组成一个块（Block）。一个块中的线程能存取同一块共享的内存，而且可以快速进行同步的动作。

每一个Block所能包含的Thread数目是有限的。不过，执行相同程序的Block，可以组成网格（Grid）。不同Block中的Thread无法存取同一个共享的内存，因此无法直接互通或进行同步。因此，不同Block中的Thread能合作的程度是比较低的。不过，利用这个模式，可以让程序不用担心显示芯片实际上能同时执行的Thread数目限制。例如，一个具有很少量执行单元的显示芯片，可能会把各个Block中的Thread顺序执行，而非同时执行。不同的Grid则可以执行不同的程序（即Kernel）。

每个Thread都有自己的一份寄存器（Register）和本地存储（Local Memory）的空间。同一个Block中的每个thread则有共享的一份共享存储（Share Memory）。此外，所有的Thread（包括不同Block的Thread）都共享一份Global Memory、静态存储（Constant Memory）和纹理存储（Texture Memory）。不同的Grid则有各自的Global Memory、Constant Memory和Texture Memory。

在编写程序时，通过cuda编译器来指定处理器进行并行运算，能够最大限度地增加并行数，进而提高处理能力。Grid、Block和Thread的关系如图16-2所示。

图16-2　CUDA的资源组织形式

4．应用举例：VaR估计

VaR是指在正常的市场条件和给定的置信度内，用于评估和计量任何一种金融资产或证券组合在既定时期内所面临的市场风险大小和可能遭受的潜在最大价值损失。VaR有两种使用模型：一种是金融机构用来度量风险控制能力；另一种是交易中评估投资组合的风险和收益。VaR程序计算复杂度非常高，特别是Basel II市场风险管理规则对VaR的要求更严格。显然在集成了VaR的算法交易系统中，VaR的运算速度非常重要，因为在投资组合开始计算VaR到计算结果输出的时间内，投资组合是暴露在风险中的。所以，衍生品交易者和高杠杆交易者必须加速对市场风险（VaR）估计算法以避免投资损失。

现有的投资组合估计方法有两种：一种是考查单个资产在时间区间的损失，然后将它们合并起来决定资产组合的风险。这个合并的过程要用到蒙特卡罗（Monto Carlo, MC）方法，因为合并是投资组合中各种资产联合分布函数的非线性叠加；第二种是基于投资组合的方法则只使用MC方法估计投资组合损失的分布。

伯克利大学的学者就采用CPU和GPU的VaR算法进行了比较。在其研究中，使用了MC方法而非分析计算方法，其原因是MC方法在期权或隐含期权的投资组合分析中，分析法的损失函数分布的“尖峰厚尾”性质较难以得出，此时MC算法更准确。同时因为交易是非线性过程，这个非线性过程最终聚集的分布可以认为是资产收益率的分布。

使用GPU来做MC-VaR，其步骤为：第一步，问题的重新表述，其目的是将数学算法转化成适于计算的浮点运算；第二步，模型选择，产生可快速收敛的伪随机序列；第三步，基于GPU的优化，主要是优化内存的读取。

该算法在CPU和CUDA上运行的结果近些年做了比较。其CPU平台为Intel Core 9300 Quadcore CPU，有着3MB L2缓存，2.5GB时钟频率。GPU时钟平台为NVIDIA GeForce GTX280，有1GB内存，30个1.3GB的CPU。每个有8条运算单元。经过问题重构和并行化处理，得到如表16-1所示的结果。

表16-1　VaR算法GPU和CPU时间对比 

由此可见，通过使用GPU，学者得到了超过CPU 495倍的运算速度。由此可以看出，金融算法在并行化之后采用GPU运算，其实时性会大大增强，进而降低了风险，增加了交易速度。在量化交易中，GPU编程可以解决运算速度瓶颈。随着显卡性能的不断提升，其应用有着巨大的潜力和前景。

16.2.2　MATLAB语言

20世纪70年代，美国新墨西哥大学计算机科学系主任Cleve Moler为了减轻学生编程的负担，用FORTRAN语言编写了最早的MATLAB。1984年由Little、Moler、Steve Bangert合作成立了的MathWorks公司，正式把MATLAB推向市场。到20世纪90年代，MATLAB已成为国际控制界的标准计算软件。

1．MATLAB是什么

MATLAB的全称是Matrix Laboratory（矩阵实验室），是美国MathWorks公司出品的商业数学软件，用于算法开发、数据可视化、数据分析及数值计算的高级技术计算语言和交互式环境，主要包括MATLAB和Simulink两大部分。在金融领域，使用MATLAB可以加速产品研究，减少开发时间，提高模型的仿真速度和控制项目成本；利用MATLAB及相关产品，可以进行分析数据、评估风险、开发并优化策略等一系列金融建模工作。

2．MATLAB工具箱

MATLAB拥有数百个内部函数的主工具箱和三十几种工具箱。工具箱又可以分为功能性工具箱和学科性工具箱。功能性工具箱用来扩充MATLAB的符号计算、可视化建模仿真、文字处理及实时控制等功能。学科性工具箱是专业性较强的工具箱，其中金融领域相关的工具箱主要有如下几种。

（1）Datafeed Toolbox：金融数据工具箱。

（2）Econometrics Toolbox：计量经济学工具箱。

（3）Financial Derivatives Toolbox：金融衍生品工具箱。

（4）Fixed-Income Toolbox：固定收益工具箱。

（5）Optimization Toolbox：优化工具箱。

（6）Statistics Toolbox：统计工具箱。

通过这些工具箱，用户可以利用MATLAB进行交易策略实现和回测、投资组合优化和分析、资产分配、金融时序分析、期权价格和敏感度分析、现金流分析、风险管理、预测和模拟、利率曲线拟合和期限结构建模、蒙特卡罗模拟、基于GARCH的波动性分析等。

3．MATLAB开发交易策略范例：一个简单的均线交易系统

交易策略：5日均线上穿20日均线做多（即买入，若有空头仓位先平掉空头再建多头），5日均线下破20日均线做空（即卖出，若有多头仓位先平掉多头再建空头）。上穿定义如下：

MA5t
＞MA5t－1
& MA5t
＞MA20t
& MA5t－1
＞MA20t－1
& MA5t－2
≤MA20t－2

其中，MA5表示5日均线，MA20表示20日均线，MA5t
＞MA5t－1
表示5日均线在拉升，MA5t
＞MA20t
& MA5t－1
＞MA20t－1
表示5日均线已经位于20日均线之上并且得到确认，MA5t－2
＞MA20t－2
表示5日上穿20日均线是一个动作，5日均线由20日均线下面拉升到20日均线上面。类似可以得到下破定义如下：

MA5t
＜MA5t－1
& MA5t
＜MA20t
& MA5t－1
＜MA20t－1
& MA5t－2
≥MA20t－2

该策略暂不考虑交易成本、冲击成本等影响。

测试数据：股指期货IF连续行情数据（数据名：IF888）2011年全年日收盘数据。

MATLAB代码（MatlabTradingDemo.m）：

测试结果如图16-3和图16-4所示。

图16-3　交易策略回测过程

资料来源：［李洋　2010］

图16-4　收益曲线和最大回撤

资料来源：［李洋　2010］

16.2.3　C#语言

C Sharp（简称“C#”）是微软公司在2000年6月发布的一种新的编程语言，并定于在微软职业开发者论坛上登台亮相。C#看起来与Java有着惊人的相似，它包括了诸如单一继承、与Java几乎同样的语法和编译成中间代码再运行的过程。但是C#与Java有着明显的不同，它借鉴了Delphi的一个特点，与COM（组件对象模型）是直接集成的，而且它是微软公司.NET Windows网络框架的主角。

1．定义

微软C#语言定义主要是从C和C++继承而来的，而且语言中的许多元素也反映了这一点。C#在设计者从C++继承的可选选项方面比Java要广泛一些（如Structs），它还增加了自己新的特点（如源代码版本定义）。

C#更像Java一些，虽然微软在这个问题上保持沉默，这也是意料中的事情，因为Java近来很成功，使用Java的公司都报告说它们在生产效率上比C++获得了提高。

2．C#从Java继承而来的特点

（1）类：在C#中类的申明与Java很相似，这是合理的，因为经验告诉我们Java模型工作得很好。C#的关键字import已经被替换成using，它起到了同样的作用。一个类开始执行的起点是静态Main（）方法，下面的Hello World程序展示了程序的基本结构：

在这个例子中，System这个名字指向一个包括了基本C#实用类集合的命名空间。这个命名空间包括了Console类，它在这个例子中被用来输出一个字符串。类可以是抽象的和不可继承的：一个被声明成abstract的类不能被实例化，它只能被用做一个基类。C#关键字lock就像Java关键字final，它声明一个类不是抽象的，但是它也不能被用做另一个类的基类。

（2）界面：就像在Java中一样，一个界面是一组方法集合的抽象定义，当一个类或结构体实现一个界面的时候，它必须实现这个界面中定义的所有方法。一个单一的类可以实现几个界面，也许以后会出现一些微妙的差别，但是这个特点看起来与Java相比没有变化。

（3）布尔运算：条件表达式的结果是布尔数据类型，布尔数据类型是这种语言中独立的一种数据类型。从布尔类型到其他类型没有直接的转换过程，布尔常量true和false是C#中的关键字。

（4）错误处理：如Java中那样，通过抛出和捕捉异常对象来管理错误处理过程。

（5）内存管理：由底层.NET框架进行自动内存垃圾回收。

3．C#从C和C++继承的特点

（1）编译：程序直接编译成标准的二进制可执行形式，如果前面的Hello World程序被保存成一个文本文件并被命名为Hello.cs，它将被编译成名为Hello.exe的可执行程序。

（2）结构体：一个C#的结构体与C++的结构体是相似的，因为它能够包含数据声明和方法。但是，C#结构体与类是不同的，而且不支持继承。

（3）预编译：C#中存在预编译指令支持条件编译、警告、错误报告和编译行控制，可用的预编译指令有：#define、#undef、#if、#elif、#else、#endif、#warning、#error、#line［］。

没有了#include伪指令，无法再用#define语句对符号赋值，所以就不存在源代码替换的概念——这些符号只能用在#if和#elif伪指令中。在#line伪指令中的数字（和可选的名字）能够修改行号及#warning和#error输出结果的文件名。

4．操作符重载

有些操作符能够被重载，而另一些则不能。特别的是，没有一个赋值运算符能够被重载。

能够被重载的单目操作符是：+、-、!、～、++、--、true、false。

能够被重载的二元运算符是：+、-、*、/、％、 & 、|、^、＜＜、＞＞、==、!=、＞、＜、=。

5．C#独有的特点

C#最引人入胜的地方是它和Java的不同，而不是相似的地方。

1）动态查阅

C# 4.0新增dynamic关键字，提供动态编程（Dynamic programming），把既有的静态对象标记为动态对象，类似JavaScript、Python或Ruby。

具名参数与可选参数：

调用OpenFile时，顺序可以完全颠倒。

2）中间代码

微软在用户选择何时MSIL应该编译成机器码时留了很大的余地，微软公司很小心地声称MSIL不是解释性的，而是被编译成了机器码。这种实现方式决定了基于MSIL的程序（指的是用C#、Visual Basic、Managed C++等语言编写的程序）将在性能上超过解释性的Java代码。

3）命名空间中的声明

创建一个程序，也就是在一个命名空间中创建了一个或多个类。同在这个命名空间中（在类的外面）开发者还有可能声明界面、枚举类型和结构体，这就是必须使用using关键字来引用其他命名空间的内容。

4）基本的数据类型

C#拥有比C、C++或者Java更广泛的数据类型，这些类型包括bool、byte、ubyte、short、ushort、int、uint、long、ulong、float、double和decimal。像Java一样，这些类型都有一个固定的大小；像C和C++一样，每个数据类型都有有符号和无符号两种类型。与Java相同的是，一个字符变量包含的是一个16位的Unicode字符。C#新的数据类型是decimal数据类型，对于货币数据，它能存放28位十进制数字。

5）两个基本类

一个名叫Object的类是所有其他类的基类，一个名叫String的类也像Object一样是这个语言的一部分。作为语言的一部分存在，意味着编译器有可能使用它：无论何时你在程序中写入一句带引号的字符串，编译器都会创建一个String对象来保存它。

6）参数传递

默认的参数传递方法是对基本数据类型进行值传递。ref关键字可以用来强迫一个变量通过引用传递，使得一个变量可以接受一个返回值。ut关键字也能声明引用传递过程，但与ref不同的是，指明这个参数并不需要初始值。

7）与COM的集成

C#对Windows程序最大的卖点可能就是它与COM的无缝集成，COM就是微软的Win32组件技术，因此最终有可能在任何.NET语言里编写COM客户和服务器端。C#编写的类可以子类化一个已存在的COM组件，生成的类也能作为一个COM组件使用。例如，JScript语言子类化它从而得到第三个COM组件，这种现象的结果是导致了一个运行环境的产生，在这个环境中的组件是网络服务，可用任何.NET语言子类化。

8）索引下标

一个索引除了不使用属性名来引用类成员而是用一个方括号中的数字来匿名引用（就像用数组下标一样）以外，它和属性是相似的。

可以用一个循环器来匿名引用字符串内部数组成员，如下：

9）代理和反馈

一个代理对象包括了访问一个特定对象的特定方法所需的信息，只要把它当成一个聪明的方法指针就行了。代理对象可以被移动到另一个地方，然后通过访问它来对已存在的方法进行类型安全的调用。

第17章　主要数据与工具

◆摘要◆

本章概要介绍与量化投资有关的主要数据与工具，这里以国内的应用环境为主，侧重介绍能在国内资本市场（包括证券、期货）进行交易的主要第三方数据与应用商提供的数据与平台。

17.1　名策数据：多因子分析平台

多因子模型建立的基础就是相似的产品应该有相似的定价。表现在股票上，就是长期来看，除去噪声，相似的股票应该有相似的回报。对于股票而言，相似特质体现在可量化的公共因子上，如市场信息（价格、成交量、动量）、基本面（市盈率、市净率、市值）和其他因素（利率变化、流通性、所属行业）。

多元因子模型的最核心的贡献就是精确地确定和量化这些公共因子，并且定量地描述公共因子和个股或组合收益之间的关系。名策多因子模型的建立流程如图17-1所示。

图17-1　名策多因子模型流程

1．原始数据的采集

在采集数据时，尤其要注意在所选取的数据期间公司发生的股利发放、资本重组等重大事件，要合理处理以保持数据的前后一致性和可比性。

2．描述性变量的选择和检验

描述性变量产生的渠道很多，需要兼顾市场行情数据和基本面数据，结合统计的方法检验显著性，进行筛选。

3．风险指数的形成

标准化描述性变量之后，用资产的回报与行业因子和单个描述性变量做回归，并检验显著性。只有通过显著性检验的描述性变量才可以纳入风险指数。

4．公共风险因子

首先得到包括25个行业因子和32个风格因子在内的57个描述性变量，采用先聚类分析再主成分分析的方法进行降维处理，进而得到风险模型所用的公共风险因子。

5．关于多因子模型中协方差矩阵的建立及修正算法

在多因子模型中，因子回报的方差-协方差矩阵占有核心地位，整个模型的风险预测等功能均基于高精度的方差-协方差矩阵而实现。名策数据提供两种修正因子回报方差-协方差矩阵的算法，其基本思路是利用全市场回报修正。

6．特殊风险

对于资产i而言，其特殊风险定义为其特殊回报的标准差，最简单的计算方法是利用其历史特殊回报值计算其方差，但是这个结果通常要求其历史特殊回报方差是稳定的。利用基本面数据修正的特殊风险模型通常由所需时刻的股票的特殊因子、调节因子及预测回报绝对值的预测相对水平决定。

7．实例研究：多因子模型应用于组合的绩效分析

分析组合银河99，时间区间为2011-09-14到2011-12-14，基准组合为沪深300，绩效分析如图17-2所示。

图17-2　基于名策多因子模型的银河99组合绩效分析

从图17-2中可以看出，总收益率为-4.49％，主动性收益率为2.14％，基准组合沪深300的同期收益率为-6.64％，投资收益主要来源于主动投资管理，其中风险因子0.74％，行业因子-0.12％，个股选择2.66％，全市场因子-1.13％。个股选择贡献了主要的主动性收益。

如表17-1所示为基于名策多因子模型的银河99组合绩效分析统计表。

表17-1　基于名策多因子模型的银河99组合绩效分析统计表 

从表17-1中可以看出，投资强项为成长因子（t统计值为32.0132）、beta因子（t统计值为15.1693）、交易量波动率因子（t统计值为9.5264）、价值因子（t统计值为9.5264），投资弱项为价格波动率因子（t统计值为-37.8224）、动量因子（t统计值为-8.3392）、加速因子（t统计值为-7.6384）。

17.2　Multicharts：程序化交易平台

Multicharts是由TS Support公司所开发，主要用来对金融市场进行分析及交易的技术分析软件。其策略开发语言为PowerLanguage，提供强大的分析并撰写交易策略的能力，并完全兼容著名的系统化行业标准的TradeStation EasyLanguage，可以对EasyLanguage编写的策略进行定制、优化和回测，以便于真正地运用在市场上。这里向读者介绍一下它的关键功能。

1．Tick数据回测、回放和优化功能

相对于其他平台的普遍基于数据bar的回测方式，Multicharts提供了tick级数据回测的功能，并且测试速度相对较快，让投资者的策略不必等到实盘交易时间，就可获得接近实盘交易的测试效果，如图17-3所示。从笔者的使用感受来看，如果交易语句使用得当，tick数据测试与实盘交易的结果非常接近。

图17-3　Multicharts平台tick级数据回测

Multicharts平台同时提供了tick级数据回放的功能，并能调解回放的速度，让投资者对策略的实盘表现能随时有一个直观的感受，如图17-4所示。

图17-4　Multicharts平台tick级数据回放

Multicharts平台的优化功能也非常强大，除了普通的穷举优化法，还提供了遗传算法和移动取样算法等，并能通过3D图等观察不同参数组的赢利能力，如图17-5所示。

图17-5　Multicharts平台遗传算法优化设定和参数组表现3D图

2．实战实例

应用Multicharts平台可以方便地使用EasyLanguage语言进行策略开发，本案例是一个实战的趋势交易策略。

如图17-6所示为Multicharts平台策略开发编辑器界面，左侧方框中编写策略及相关指令，编写完毕后单击“编译”按钮，编译通过代表策略开发完毕。右侧方框中可以看到已经完成了的策略和系统自带的策略及指标。随后使用历史测试功能进行测试。

图17-6　Multicharts平台策略开发编辑器界面

Multicharts平台提供的测试报告经过若干年的改进，已经基本涵盖了交易中所有重要的指标，内容非常丰富，为投资者对自己的策略进行全方位的评估提供了依据，并且回测绩效报告可以生成Excel格式文本保存，如图17-7所示。

图17-7　趋势策略后验结果

资料来源：［刘建章　2012］

17.3　交易开拓者：期货自动交易平台

交易开拓者（TradeBlazer）是一款为中国期货市场专业投资用户开发的金融投资软件，它集中了实时行情、技术分析、快捷交易及程式化交易的功能。通过使用交易开拓者，用户可以简单、快速地将自己的交易思想转化为计算机代码，让计算机帮助用户实现价值。

1．TradeBlazer公式

TradeBlazer公式是一种专为分析金融数据、时间序列而设计的高级语言，它提供框架将交易思想转化为用户函数、用户字段、技术分析、交易指令等计算机能够识别的代码。

交易开拓者能够读取投资者开发的TradeBlazer公式，在历史价格数据基础上进行评估，并能自动执行特定的交易动作，将投资者的交易思想转化为实际的交易操作。

通过TradeBlazer公式，投资者能够创建自己的交易指令、技术指标、K线型态、特征走势、用户函数及用户字段，同时也可以复制、修改并使用系统内置的几百个函数、字段、技术分析和交易指令。

通过调用TradeBlazer公式，投资者可以在交易开拓者中进行技术分析、交易策略优化测试、公式报警、自动交易等操作。

2．交易策略

通常单个交易指令只完成建仓或平仓的单个动作，而一个完整的交易策略应该至少包含建仓、平仓交易指令，并且根据需要加上止损、获利等锁定风险和收益的交易指令。多个交易指令的组合才能更加有效地帮助投资者完整地进行交易。

1）交易策略测试引擎

为了真实准确地模拟交易策略在过去时段的表现，并能在实时数据更新时使交易策略沿着预定的方向发展，TradeBlazer公式提供了一个强大的交易策略测试引擎，该处理引擎收集交易策略在历史过程中产生的所有委托单，将其应用在对应的图表中，并能根据交易设置创建交易策略性能测试报表供客户参考。

2）交易策略参数优化

交易策略参数优化模块可对多个交易指令组合的所有参数进行优化，投资者可以通过参数设置界面对需要优化的参数进行设置。

在各项参数设置完成之后，单击“确定”按钮，将会进行参数优化的计算，参数优化计算过程中会显示优化的进程、时间、当前参数、最优参数及优化目标等信息，投资者可以通过单击“取消”按钮终止计算。

参数优化计算完成之后，将会显示出最优的记录。

3）交易策略性能测试

在超级图表中插入一个或一个以上交易指令后，菜单和工具栏中的交易策略测试报表选项将会有效。

账户分析按照8个方面对账户进行分析，包括交易汇总、交易分析、交易记录、平仓分析、阶段总结、资产变化、图表分析和系统设置。

3．TradeBlazer公式范例：一个简单顺势交易系统

该交易系统的建仓条件为：

（1）前两个Bar收阳，并呈上涨趋势。

（2）当前价格为最近前两个Bar最高价的回落，而且回落幅度大于0.382（回落幅度是相对于最低价到最高价的范围）。

该交易系统的平仓条件为：当前价格的获利价格点数大于建仓时最低价到最高价的范围。

该交易系统的止损条件为：当前价格从建仓时的最高价格的回落大于最低价到最高价的范围的0.5。

具体代码如下：

17.4　大连交易所套利指令

很多时候套利交易的机会转瞬即逝，特别是跨期套利，往往看到了机会，等投资者下单后，机会就已经消失了。并且在实际的交易中，由于需要下双向单子，不能同时成交而造成风险敞口暴露，会对套利交易带来极大的风险。因此，一个速度快、功能强的套利交易系统在实际的交易中就显得非常必要。大连交易所开发的套利指令，可以在交易所内部直接撮合，所以比一般的交易软件中的指令，无论是在机会把握还是成交速度上都要强大，主要包括跨期套利指令和跨品种套利指令两类。

1．跨期套利指令使用说明

1）适用跨期套利交易指令的合约

可使用跨期套利交易指令的合约由交易所指定，投资者不能自定义跨期套利交易合约。

2）跨期套利交易代码

大连交易所交易系统用“SP”表示跨期套利交易，后缀一个近月合约和一个远月合约，表示跨期套利交易指令适用的合约。

例如，SP c0707 & c0709，表示玉米c0707合约和c0709合约可使用套利交易指令进行跨期套利交易。

3）跨期套利交易含义

跨期套利交易是指买入（卖出）近月合约，同时卖出（买入）同品种相等数量的远月合约。

例如，投资者申报SP c0707 & c0709买委托，表示买入c0707合约，同时卖出相等数量的c0709合约；若投资者申报SP c0707 & c0709卖委托，表示卖出c0707合约，同时买入相等数量的c0709合约。

4）跨期套利交易最小变动价位

跨期套利交易最小变动价位与其合约规定最小变动价位一致。豆一、豆粕和玉米跨期套利交易最小变动价位为1元／吨，豆油、棕榈油跨期套利交易最小变动价位为2元／吨，线型低密度聚乙烯跨期套利交易最小变动价位为5元／吨。

5）跨期套利交易指令有效报价范围

跨期套利交易指令有效报价下限：近月合约跌停板价－同品种远月合约涨停板价。

跨期套利交易指令有效报价上限：近月合约涨停板价－同品种远月合约跌停板价。

例如，c0707合约涨停板价和跌停板价分别为1664元／吨和1536元／吨，c0709合约涨停板价和跌停板价分别为1716元／吨和1584元／吨，则SP c0707 & c0709买卖委托有效报价范围为：－180元／吨～80元／吨，即c0707合约跌停板价1536元／吨－c0709合约涨停板价1716元／吨，c0707合约涨停板价1664元／吨－c0709合约跌停板价1584元／吨。

6）跨期套利交易指令每笔有效委托数量

跨期套利交易指令每笔有效委托数量与其合约规定的每笔有效委托数量相同。豆一、豆粕、豆油、棕榈油、玉米、线型低密度聚乙烯跨期套利交易指令每笔有效委托数量为1手的整数倍数。豆一、豆粕、豆油、棕榈油、线型低密度聚乙烯跨期套利交易指令每笔有效委托数量最大不可超过1000手，玉米跨期套利交易指令每笔有效委托数量最大不可超过2000手。

7）跨期套利交易指令报入形式

（1）跨期套利交易指令必须以价差形式报入交易所系统，不必对跨期套利交易指令各成分合约单独进行委托报价。

例如，某投资者认为c0707合约与c0709合约价差将会超过-100元／吨，则可申报SP c0707 & c0709买委托，价格为-100元／吨，不必单独给出c0707合约申买价和c0709合约申卖价。

（2）跨期套利交易指令既可用于开仓，也可用于平仓。若投资者在任一成分合约无持仓，则不能申报跨期套利交易平仓指令。

8）跨期套利交易指令成交形式

（1）跨期套利交易指令各成分合约按规定比例同时成交。

（2）各成分合约成交价之差不劣于报入的价差。

（3）成交结果计入各成分合约持仓量和成交量。

例如，某投资者以-100元／吨的价格报入8手SP c0707 & c0709买委托，成交3手。根据交易系统定价原则，c0707合约以1588元／吨建立3手买持仓，同时c0709合约以1688元／吨建立3手卖持仓。

9）跨期套利交易指令有效委托时间

跨期套利交易指令只能在连续交易期间申报，开盘集合竞价阶段不能申报跨期套利交易指令。

2．跨品种套利交易指令使用说明

1）适用跨品种套利交易指令的合约

可使用跨品种套利交易指令的合约由交易所指定，成分合约比例关系为1∶1，投资者不能自定义跨品种套利交易合约。

2）跨品种套利交易代码

大连交易所交易系统用“SPC”表示跨品种套利交易，后缀一个品种指定合约和另一品种指定合约，表示跨品种套利交易指令适用的合约。

例如，SPC a0709 & m0709，表示黄大豆1号a0709合约和m0709合约可使用跨品种套利交易指令进行跨品种套利交易。

3）跨品种套利交易含义

跨品种套利交易是指买入（卖出）某品种指定合约，同时卖出（买入）另一品种相等数量的指定合约。

例如，投资者申报SPC a0709 & m0709买委托，表示买入a0709合约，同时卖出相等数量的m0709合约；若投资者申报SPC a0709 & m0709卖委托，表示卖出a0709合约，同时买入相等数量的m0709合约。

4）跨品种套利交易最小变动价位

跨品种套利交易最小变动价位与最小变动价位较小的成分合约一致。豆一与豆粕之间的跨品种套利交易最小变动价位为1元／吨，豆油与棕榈油之间的跨品种套利交易最小变动价位为2元／吨。

5）跨品种套利交易指令有效报价范围

跨品种套利交易指令有效报价下限：“SPC”后缀的第一个品种合约跌停板价－第二个品种合约涨停板价。

跨品种套利交易指令有效报价上限：“SPC”后缀的第一个品种合约涨停板价－第二个品种合约跌停板价。

例如，a0709合约涨停板价和跌停板价分别为3252元／吨和3002元／吨，m0709合约涨停板价和跌停板价分别为2579元／吨和2381元／吨。SPC a0709 & m0709买卖委托有效报价范围为：423元／吨～871元／吨，即a0709合约跌停板价3002元／吨－m0709合约涨停板价2579元／吨，a0709合约涨停板价3252元／吨－m0709合约跌停板价2381元／吨。

6）跨品种套利交易指令每笔有效委托数量

跨品种套利交易指令每笔有效委托数量与每笔最大有效委托数量较小的成分合约相同。

豆一与豆粕、豆油与棕榈油跨品种套利交易指令每笔有效委托数量为1手的整数倍数，最大不可超过1000手。

7）跨品种套利交易指令报入形式

（1）跨品种套利交易指令必须以价差形式报入交易所系统，不必对跨品种套利交易指令各成分合约单独进行委托报价。

价差计算方式为：“SPC”后缀的第一个品种合约的价格－第二个品种合约的价格。

例如，某投资者认为a0709合约与m0709合约价差将会超过600元／吨，则可申报SPC a0709 & m0709买委托，价格为600元／吨，不必单独给出a0709合约申买价和m0709合约申卖价。

（2）跨品种套利交易指令既可用于开仓，也可用于平仓。若投资者在任一成分合约无持仓，则不能申报跨品种套利交易平仓指令。

8）跨品种套利交易指令成交形式

（1）跨品种套利交易指令各成分合约按规定比例同时成交。

（2）各成分合约成交价之差不劣于报入的价差。

（3）成交结果计入各成分合约持仓量和成交量。

例如，某投资者以600元／吨的价格报入8手SPC a0709 & m0709买委托，成交3手。根据交易系统定价原则，a0709合约以3118元／吨建立3手买持仓，同时m0709合约以2518元／吨建立3手卖持仓。

9）跨品种套利交易指令有效委托时间

跨品种套利交易指令只能在连续交易期间申报，开盘集合竞价阶段不能申报跨品种套利交易指令。

17.5　MT5：外汇自动交易平台

MT5是目前主流功能超级强大的外汇交易软件，提供各种优于炒股软件的功能。基本的包括挂单、锁单、自动止损止赢，以及强大的智能交易系统，该平台通过互联网为经纪公司提供全方位的服务，包括后台支持等。

与许多技术指标和曲线研究相同的是，交易策略程序中使用了内置语言Multibank Quotes Language 4。使用这种语言，投资者可以创建自动交易、客户指标和脚本。自动交易可以分析市场情况、制定决策、挂出订单、以在线模式开设头寸。与技术指标一样，客户指标可分析市场情况并发出各种信号，脚本可单独执行某些特殊操作。

MetaQuotes 4语言用来编写自定义智能交易系统软件，以便使交易程序管理自动化及执行交易商自己的交易策略。MetaQuotes 4语言包括变量、控制当前和前期报价的算术和逻辑运算、内置指标，以及用来开启和控制头寸的命令等。

下面所给的例子中，交易通过对单一的部位进行开仓和控制。

1．交易原则

（1）多头进场：MACD指标在零点之下，向上走，或由下行信号线穿过。

（2）空头进场：MACD指标在零点以上，向下走，或由上行信号线穿过。

（3）多头出场：通过执行获利限额，移动止损或当MACD指标穿过信号线（MACD指标在零点以上，向下走，或由上行信号线穿过）。

（4）空头出场：通过执行获利限额，移动止损或当MACD指标穿过信号线（MACD指标在零点以下，向上走，或由下行信号线穿过）。

2．创建程序的主结构

（1）原始数据检查：

检查图表、图表上的条形数。

核查外部变量值：单位、Lots、S/L、T/P、T/S。

（2）设定快速数据存取内部变量。

（3）检查交易终端是否可用？若可用，那么：

检查账户资金的可用性等。

是否可能来做多头买卖（买单）？

开仓（买）并离开。

是否能做空仓（卖出）？

空仓（卖）并离开。

退出智能交易系统。

（4）控制循环周期中前期的开仓部位：

如果是做多头。

是否应该出仓？

是否应该设置追踪止损单？

如果是做多头。

是否应该出仓？

是否应该设置追踪止损单？

3．代码案例

该策略的主要代码如下所示。

第18章　对冲交易系统：D-Alpha

◆摘要◆

本书前面介绍的各种投资策略和理论算法，属于单兵技术，在真实的交易中，则需要将这些单兵技术整合成为兵团战斗力，这样才能发挥各种策略的优势，提高收益率的同时降低风险。

在本书的最后一章，给读者介绍一个量化对冲交易系统：D-Alpha，该系统是笔者历时3年研发而成，采用了多种选股、择时、套利、程序化交易等策略，整合而成的实用性交易平台。

18.1　系统架构

如图18-1所示是该系统的架构图，它主要由如下几部分构成。

图18-1　D-Alpha系统架构

1．数据库与数据仓库

本系统的底层为数据与数据仓库层，包括与量化投资交易有关的基础数据，主要有：历史高频交易数据，历史分析数据，实时行情数据，实时分析数据四大块。

1）历史高频交易数据

历史高频数据回溯了A股市场历史上每一次的交易细节，包括：买一到买五价格，挂单量，成交量；卖一到卖五价格、挂单量，成交量。

2）历史分析数据

历史分析数据有两块，国内的来自于万德历史数据库，国外的来自于Bloomberg历史数据库。

万德历史数据库包括：宏观经济数据、微观经济数据、上市公司数据、分析师数据等。

Bloomberg历史数据库包括：全球宏观经济数据、全球微观经济数据、全球资本市场数据（股票，债券，商品，期权），全球分析师数据等。

3）实时行情数据

实时行情数据直接来自于交易所，用于对市场实时监控。

4）实时分析数据

实时分析数据来自于各大第三方数据提供商，用于策略实时分析。

2．数据引擎

数据引擎的作用就是将底层的各种数据库整合起来，采用统一的接口供上层的策略分析和机会监控两大模块进行调用。由于底层的数据来自不同的数据提供商，他们的数据结构，接口都不尽相同，因此需要数据引擎进行预处理，剔除不合理的数据，格式统一和接口统一的工作。

3．策略分析

策略分析是本量化投资系统的核心模块，基于数据引擎提供的数据，通过对历史数据的分析，得出有效的投资策略，并将该策略的主要参数传递给监控模块，对市场机会进行监控。

4．机会监控

机会监控有自动和人工两种。自动监控通过一个程序化的DLL实现，该DLL实时监控市场情况，当在机会出现的时候，将交易参数传递给程序化交易模块，进行下单操作。

人工监控则是在机会出现的时候，在用户界面上弹出对话框，让交易员进行人工判断后利用程序化交易系统下单。

提供人工监控的目的在于，在市场出现大幅波动，或者策略出现明显不合理的情况的时候，可以让交易员对投资策略进行人工干预，以免由于程序的错误，带来重大损失。

5．程序化交易

一旦市场出现机会后，不管是开仓还是平仓交易，如果通过人工下单的方式，都是效率很低的，尤其是针对套利这种瞬间即逝的机会，只有程序化交易模块才能捕捉。

如果是自动监控的机会，则将交易指令直接发送到程序化交易模块，如果是人工监控的，则由交易员启动程序化交易模块。

程序化交易模块的输出是一系列指令集，传送到交易所（证券交易所，期货交易所）进行撮合回报。

18.2　策略分析流程

在D-Alpha系统中，一个有效的策略从开始到最后实际交易，需要经过四个步骤：历史数据统计后验、历史高频数据后验、实时高频数据模拟交易和实盘交易，具体流程如图18-2所示。

图18-2　D-Alpha系统策略分析流程

1．历史数据统计后验

历史数据统计一般以收盘价或者日均价作为买入卖出的交易价格，交易成本的考虑一般是事先设定一个固定的数值，比如0.3％。然后根据设定的交易价格计算出在某一段时间内的收益率、超额收益、夏普率等结果。

历史数据统计后验的优势是效率高、简单方便，一般10年左右的数据后验，几十分钟就可以程序跑完。缺点是不够精确，尤其不能考虑资金量对市场的影响。因为有的策略和市场容量之间有很大的关系，例如高频交易策略，在资金量大的情况下，很多有效的策略就会失效，因为其冲击成本会吃掉所有的收益率。

因此历史数据统计后验只能作为筛选策略的初步方法，更加精细的方法需要历史高频数据后验实现

2．历史高频交易数据后验

历史高频交易数据后验的核心在于根据历史高交易频数据进行模拟撮合，撮合算法主要是判断在某个时段的成交量的成交比例。例如某个股票在历史上5.0～5.1价位之间成交了10000股，其中的挂单量为50000股。那么在后验的时候，可以设定成交股的A％和挂单量的B％中最小值，为模拟撮合的成交量。

如果想严格一些，将A和B的值设得小一些即可，如果宽松一些，将A和B的值设大一些。在D-Alpha量化对冲系统中，A和B的值一般取为10％和30％。

3．高频数据实时模拟

策略后验可以解决一个策略在样本内的效果问题，但是无法检验其在样本外的效果。解决这个问题的方法是进行高频数据的实时模拟交易。

实时模拟交易也有全自动化和手工两种方式，全自动化是将策略写成一个DLL，放在模拟平台上自动运行，手工就是利用机会监控的消息提示，进行人工交易。

高频数据实时模拟和实盘交易已经非常接近，对冲击成本的考虑，市场容量的考虑基本上和实盘已经一致，唯一不能解决的就是对市场的影响，因为模拟交易不能影响市场价格，这个就只有在实盘交易中实现。

4．实盘实时交易

前面3个步骤的目的都是为了最后进行实盘交易，实盘交易对市场的影响会体现出来，只有通过了实盘实时交易，一个策略才能被证明是有效的。

18.3　核心算法

D-Alpha量化对冲系统的核心算法包括如下几个部分。

1．选股策略

选股策略采用多因子模型、资金流模型、筹码选股模型和动量反转模型的组合。

系统中采用两类多因子，分别是基本面因子和技术面因子，资金流模型采用GSMS的定义算法。筹码选股模型采用股东户数（季度增长率）、户均持股数（季度增长率）和机构持股数（季度增长率）这几个指标。动量反转模型的关键在于选择动量指标和动量持续时间，这里的动量指标采用收盘价，持续时间采用3个月作为动量轮动的指标。

2．择时策略

择时策略主要分为大盘择时和个股择时两种。在D-Alpha量化对冲系统中，将择时策略用于个股择时中，也就是说，利用选股策略选出一批股票的候选集，然后利用择时策略得出它们的买点和卖点。

如果一个股票的买点和卖点出现，则将其放置如股票池，由算法交易策略进行相应的交易。出现买点的进行买入操作，出现卖点的进行卖出操作。D-Alpha量化对冲系统中的择时策略采用两个：趋势模型和Hurst指数模型

3．策略整合

策略的整合有两种方法：分层法和交集法。

1）分层法

分层法就是由一个策略开始，选出候选集A1，然后再利用第二个策略再次筛选得出候选集A2，如此下去，直到所有的策略筛选完毕。

2）交集法

交集法就是每个策略都选择一个候选集，然后做交集计算，取所有策略中的交集为股票池的股票。

D-Alpha量化对冲系统选股子系统采用分层法，选股与择时系统的整合采用交集法。

4．股指期货对冲策略

对冲策略解决的是如何利用股指期货对现货头寸进行对冲交易，包括在建仓、调仓、平仓过程中，如何及时调整股指期货的仓位，以尽可能降低敞口，避免系统性风险。

对冲策略主要包括：建仓算法、移仓算法和拆借算法。

1）建仓算法

对冲流程如图18-3所示。

图18-3　D-Alpha系统中股指期货对冲算法

在建仓算法中，最主要的是要求风险敞口比例尽可能小，可以用股指期货合约市值与现货市值比来计算。

2）移仓算法

股指期货是有期限的，所以在合约到期前，需要将相应的合约移仓到新合约上。移仓算法主要是判断当前主力合约，只要通过交易量判断即可。因为一般主力合约存续期间，交易量远远大于其他的合约，只有在换月的时候，才会出现交易量的急剧变化。

3）拆借算法

股指期货采用的是保证金交易，如果市场出现大幅度上涨，可能会出现爆仓情况，从而导致不得不平仓的结果。在出现这种情况的时候，需要到市场上拆借资金，弥补保证金。

5．算法交易策略

策略中的各种算法最终要转变为算法交易，发送到交易所进行撮合交易。

本系统的算法交易主要采用被动交易算法，其中每次挂单手数K利用V-WAP算法来确定

18.4　验证结果

我们采用两种方法来验证本对冲交易系统的效果，对于A股，我们采用高频数据进行模拟撮合；对于全球市场，采用Bloomberg的API进行统计后验。

全球市场后验结果如表18-1所示。

表18-1　D-Alpha系统在全球市场收益率分析 

从表18-1中可以看出，本系统在新兴市场，如印度、巴西等国家的表现比较好，在发达国家，如日本、英国的表现相对差一些，这和市场本身的情况是一致的。

总而言之，D-Alpha量化对冲交易系统在全球市场的验证结果来看，都是具有明显效果的。
参考文献

［Andrew Pole 2010］Andrew Pole，陈雄兵．“统计套利”，机械工业出版社，2010

［卜永强 2012］卜永强，王旭，丁鹏，“行业轮动模型策略在A股的应用”，2012

［卜永强 2012］卜永强，王旭，丁鹏，“基于一致预期模型的选股策略”，2012

［曹传琪 2009］曹传琪．“海外策略指数的发展与本土化”．2009

［曹力 2008］曹力．“自适应均线的择时应用”．2008

［曹力 2008］曹力，刘湘宁．“利用移动Hurst指数把握股指反转”．2008

［曹力 2009］曹力．“择时调仓的利器：行业相关性集中度”．2009

［曹力 2009］曹力，徐彪．“可交易组合的均线模式识别和择时交易”．2009

［曹力 2010］曹力，曹传琪，邵立夫．“改进型VWAP策略及实证”．2010

［陈四新 2003］陈四新，“上海期货交易所铜套利方法”．华东经济管理，2003

［曹源 2010］曹源．“Hurst指数在A股市场中的应用”．2010

［曹源 2010］曹源，“A股风格轮动策略探寻”，2010

［程启月 2002］程启月．“股票市场状态的动力学过程分析”．北京航空航天大学学报，2002

［程志田 2010］程志田，“新量化择时指标之二TSharp：时变夏普比率把握长中短趋势”，2010

［程志田 2011］程志田．“新量化择时指标之三BBCurve—牛熊线实现完美择时”．2011

［杜建卫 2008］杜建卫．王超峰．“小波分析方法在金融股票数据预测中的应用”．数学的实践与认识，2008

［戴军 2008］戴军，葛新元．“数量化投资技术综述”．2008

［邓凯旭 2006］邓凯旭，宋宝瑞．“小波变换在金融数据分析中的应用”，数理统计与管理，2006

［冯平 2001］冯平，宣慧玉．“遗传算法在股票投资技术分析中的应用”．预测，2001

［郭存芝 2000］郭存芝．“股市走势预测的随机分析方法研究”．南开经济学报，2000

［高钢杰 2012］高钢杰，丁鹏．“Hurst指数在中国市场的应用”，2012

［胡立峰 2009］胡立峰．“LOF基金交易”．2009

［胡倩 2009］胡倩，张峰．“宏观经济周期与证券市场的趋势相关性研究”．2009

［华仁海 2003］华仁海，“中国期货市场价格波动特征及运行效率研究”，博士学位论文，2003

［金融创新实验室 2009］金融创新实验室，“深圳证券交易所市场绩效报告，2009”，2009

［金志宏 2012］金志宏，易芝羚，丁鹏“配对交易在A股市场的应用”，2012

［贾戎莉 2010］贾戎莉，王丹妮．“LOF基金：类型丰富 策略多样”．2010

［江弋 2007］江弋，林永鹏．“RBF神经网络在股价预测中的应用”．心智与计算，2007

［蒋瑛琨 2008］蒋瑛琨，杨喆．吴天宇，张权．“海外机构数量化投资的发展”．2008

［蒋瑛琨 2008］蒋瑛琨等，“风格投资Ⅰ：风格区分与收益”，2008

［阚先成 2011］阚先成，楼华锋．“市场面临较大调整压力——A股‘兴登堡凶兆’研究系列之”．2011

［李宇龙 2009］李宇龙，陈炎玮．“闪电交易、高频交易与交易所竞争”．2009

［李彩云 2008］李彩云，王军．“随即过程理论在股票及期权研究中的应用”．理论概述，2008

［李洋 2010］李洋，王小川，郁磊，史峰．“MATLAB神经网络30个案例分析”．北京航空航天大学出版社，2010．

［罗捷 2009］罗捷，王红兵．“市场噪声指数与熊市中的择时策略”．2009

［罗捷 2009］罗捷，曹传琪．“被动型算法交易”．2009

［罗捷 2009］罗捷，曹力．“追求效率与Alpha的算法交易”．2009

［刘斌 2009］刘斌．“分形市场理论在我国股票市场的应用”．中国科技论文在线，2009

［刘建章 2012］刘建章，丁鹏，“利用MulitCharts平台进行策略后验”，2012

［乐励华 2008］乐励华，温荣生，朱辉．“基于RBF神经网络的股市预测及MATLAB实现”．科技情报与开发，2008

［兰秋军 2004］兰秋军，马超群，文凤华．“金融时间序列去噪的小波变换方法”．科技管理研究，2004

［罗业华 2010］罗业华，曾敏．“短期看变化，长期看区域——量化择时之市场情绪．”，2010

［罗业华 2011］罗业华，杨向阳，陈军华，“逆向选择，驾驭暗流—资金流指标选股策略”，2011

［路冠平 2012］路冠平，丁鹏，“GPU在量化交易中的应用及VaR快速算法”，2012

［梁冠群 2012］梁冠群，丁鹏，“高频交易最新发展”，2012

［李健 2009］李健．“基于数据挖掘的上市公司财务风险预警研究”．硕士学位论文，2009

［孟毅 2008］孟毅，吕渭济．“基于BP神经网络的数据挖掘及在股价预测中的应用”．实践与经验，2008

［孟力 2008］孟力，王月，赵晶．“基于分形理论下的外汇市场的预测”．沈阳工业大学学报，2008

［潘凡 2011］潘凡．“基于有效因子的多因子选股模型”，2011

［潘晓明 2007］潘晓明，吴建生．“基于遗传算法神经网络集成股票市场预测研究”广西师范学院学报，2007

［秦国文 2010］秦国文．“基于小波分析和支持向量机的指数预测模型”．2010

［邱小平 2010］邱小平．“融资融券与统计套利”．浙商证券，2010

［宋曦 2007］宋曦，“风格投资的动量与反转”，2007

［宋曦 2009］宋曦，何天翔，“货币周期与行业轮动策略”．2009

［隋学深 2008］隋学深，齐中英．“基于多尺度特征和支持向量机的股市趋势预测”哈尔滨工业大学学报，2008

［沈晓栋 2009］沈晓栋．“分形理论在中国证券市场的应用研究”．硕士论文，2009

［施燕杰 2005］施燕杰．“基于支持向量机（SVM）的股市预测方法”．统计与决策，2005

［施燕杰 2008］施燕杰．“基于支持向量机（SVM）的股市预测方法”．知识丛林，2008

［孙红军 2004］孙红军．王治宝，“基于Agent的股市随即过程方法预测”．计算机应用，2004

［台文志 2008］台文志．“利用马尔可夫链模型预测股票市场的近期走势”．西南民族大学学报，2008

［王红兵 2009］王红兵，谢江，“基于市场情绪的行业轮动策略”，2009

［王红兵 2009］王红兵，罗捷．“利用模式识别进行短线择时”．2009

［王焕然 2010］王焕然．“解析高频交易”．2010

［王礼霞 2010］王礼霞．“灰色—马尔可夫链模型在股市预测中的应用”．中国科技论文在线，2010

［吴先兴 2011］吴先兴．“统计套利之股票配对交易策略”，2011

［吴泱 2010］吴泱．“股指期货保证金水平及包容风险测算”．2010

［吴志涵 2007］吴志涵．“股票价格的随机序列及正态分布分析”．理论探讨，2007

［杨向阳 2009］杨向阳，罗业华，易海波，曾敏，“牛市看反转，熊市找动量-量化投资之动量反转策略”，2009

［谢江 2008］谢江，“基于一致预期挖掘的EM选股策略”，2008

［谢江 2009］谢江，曹传琪．“数量化投资的解读及其本土化”．2009

［俞文冰 2009］俞文冰，“构建超越指数的股票组合——利用趋势追踪技术”，2009

［叶银龙 2008］叶银龙．“基于关联规则挖掘的股票板块指数联动分析”．统计教育，2008

［徐志超 2008］徐志超，梁艳春，时小虎．“基于SOM网络的股票聚类分析方法”，计算机工程与设计，2008

［徐玉莲 2005］徐玉莲．“基于统计套利的中国资本市场实证研究”，硕士学位论文，2005

［徐忠 2005］徐忠．“遗传算法的研究”．商丘师范学院学报，2005

［辛治运 2008］辛治运，顾明．“基于最小二乘支持向量机的复杂金融时问序列预测”．清华大学学报，2008

［肖红艳 2007］肖红艳，张凤．“上证综合指数的随机过程方法预测”．重庆科技学院学报，2007

［易海波 2010］易海波，基于趋势型指标的择时策略——量化择时之技术指标（一）．2010

［易海波 2010］易海波．“基于均线型指标的择时策略”．2010

［杨喆 2010］杨喆，蒋瑛琨，杨振建．“基于支持向量机的股票市场择时”．2010

［杨向阳 2009］杨向阳，罗业华，易海波，曾敏，“牛市看翻转，熊市看动量-量化投资指动量翻转策略”，2009

［杨卫东 2010］杨卫东．“探究四种期指跨期套利机会”．2010

［杨希 2008］杨希．“基于数据挖掘的股票预测研究”．硕士学位论文，2008

［苑莹 2008］苑莹，庄新田．“多重分形理论在股市大幅波动中的应用”．系统管理学报，2008

［苑莹 2008］苑莹，庄新田．“股票市场多重分形性的统计描述”．金融管理，2008

［张峰 2009］张峰，胡倩．“择时＋指数化投资——基于海通SWARCH模型的量化周择时策略研究”．2009

［张昊星 2010］张昊星，“基于统计套利模型的豆油棕榈油跨品种套利研究”．2010

［张楠 2008］张楠，孙德山．“基于支持向量回归的股市波动性预测”．金融视线，2008

［张丕一 2006］张丕一．“股票价格模型中的三个指标概率计算”．青岛理工大学学报，2006

［中国期货行业协会 2010］中国期货行业协会．“期货市场教程”，中国财政经济出版社，2010

［周世昊 2007］周世昊，林苍祥，倪衍森．“基于遗传算法和神经网络的新股上市价格预测法”．计算机工程，2007

［邹庆 2009］邹庆．“基于聚类分析的中小板IPO定价实证研究”．Times Finance，2009

［张杨 2006］张杨，宋恒．“基于聚类技术的股市基本趋势规律挖掘”．数理统计与管理，2006

［赵耀军 2008］赵耀军，陈俊杰．“浅谈数据挖掘在证券投资上的应用”．山西科技，2008

［朱品品 2008］朱品品，严定琪，沈红梅．“分形理论及其在中国股票市场中的应用”．中国科技论文在线，2008
